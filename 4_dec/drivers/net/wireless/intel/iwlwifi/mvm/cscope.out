cscope 15 /home/bharathi/Downloads/kernel_692/linux-6.9.2/drivers/net/wireless/intel/iwlwifi/mvm               0001584917
	@binding.c

7 
	~<√t/mac80211.h
>

8 
	~"fw-≠i.h
"

9 
	~"mvm.h
"

11 
	siwl_mvm_iÁ˚_ôî©‹_d©a
 {

12 
õì80211_vif
 *
	mign‹e_vif
;

13 
	midx
;

15 
iwl_mvm_phy_˘xt
 *
	mphy˘xt
;

17 
u16
 
	mids
[
MAX_MACS_IN_BINDING
];

18 
u16
 
	mcﬁ‹s
[
MAX_MACS_IN_BINDING
];

21 
	$iwl_mvm_bödög_cmd
(
iwl_mvm
 *
mvm
, 
u32
 
a˘i⁄
,

22 
iwl_mvm_iÁ˚_ôî©‹_d©a
 *
d©a
)

24 
iwl_bödög_cmd
 
cmd
;

25 
iwl_mvm_phy_˘xt
 *
phy˘xt
 = 
d©a
->phyctxt;

26 
i
, 
ªt
;

27 
u32
 
°©us
;

28 
size
;

30 
	`mem£t
(&
cmd
, 0, (cmd));

32 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

33 
IWL_UCODE_TLV_CAPA_BINDING_CDB_SUPPORT
)) {

34 
size
 = (
cmd
);

35 
cmd
.
lmac_id
 = 
	`˝u_to_À32
(
	`iwl_mvm_gë_lmac_id
(
mvm
,

36 
phy˘xt
->
ch™√l
->
b™d
));

38 
size
 = 
IWL_BINDING_CMD_SIZE_V1
;

41 
cmd
.
id_™d_cﬁ‹
 = 
	`˝u_to_À32
(
	`FW_CMD_ID_AND_COLOR
(
phy˘xt
->
id
,

42 
phy˘xt
->
cﬁ‹
));

43 
cmd
.
a˘i⁄
 = 
	`˝u_to_À32
(action);

44 
cmd
.
phy
 = 
	`˝u_to_À32
(
	`FW_CMD_ID_AND_COLOR
(
phy˘xt
->
id
,

45 
phy˘xt
->
cﬁ‹
));

47 
i
 = 0; i < 
MAX_MACS_IN_BINDING
; i++)

48 
cmd
.
macs
[
i
] = 
	`˝u_to_À32
(
FW_CTXT_INVALID
);

49 
i
 = 0; i < 
d©a
->
idx
; i++)

50 
cmd
.
macs
[
i
] = 
	`˝u_to_À32
(
	`FW_CMD_ID_AND_COLOR
(
d©a
->
ids
[i],

51 
d©a
->
cﬁ‹s
[
i
]));

53 
°©us
 = 0;

54 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu_°©us
(
mvm
, 
BINDING_CONTEXT_CMD
,

55 
size
, &
cmd
, &
°©us
);

56 i‡(
ªt
) {

57 
	`IWL_ERR
(
mvm
, "FailedÅo send binding (action:%d): %d\n",

58 
a˘i⁄
, 
ªt
);

59  
ªt
;

62 i‡(
°©us
) {

63 
	`IWL_ERR
(
mvm
, "Bödög comm™d faûed: %u\n", 
°©us
);

64 
ªt
 = -
EIO
;

67  
ªt
;

68 
	}
}

70 
	$iwl_mvm_iÁ˚_ôî©‹
(*
_d©a
, 
u8
 *
mac
,

71 
õì80211_vif
 *
vif
)

73 
iwl_mvm_iÁ˚_ôî©‹_d©a
 *
d©a
 = 
_d©a
;

74 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

76 i‡(
vif
 =
d©a
->
ign‹e_vif
)

79 i‡(
mvmvif
->
deÊök
.
phy_˘xt
 !
d©a
->
phy˘xt
)

82 i‡(
	`WARN_ON_ONCE
(
d©a
->
idx
 >
MAX_MACS_IN_BINDING
))

85 
d©a
->
ids
[d©a->
idx
] = 
mvmvif
->
id
;

86 
d©a
->
cﬁ‹s
[d©a->
idx
] = 
mvmvif
->
cﬁ‹
;

87 
d©a
->
idx
++;

88 
	}
}

90 
	$iwl_mvm_bödög_upd©e
(
iwl_mvm
 *
mvm
,

91 
õì80211_vif
 *
vif
,

92 
iwl_mvm_phy_˘xt
 *
phy˘xt
,

93 
boﬁ
 
add
)

95 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

96 
iwl_mvm_iÁ˚_ôî©‹_d©a
 
d©a
 = {

97 .
ign‹e_vif
 = 
vif
,

98 .
phy˘xt
 =Öhyctxt,

100 
u32
 
a˘i⁄
 = 
FW_CTXT_ACTION_MODIFY
;

102 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

104 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s_©omic
(
mvm
->
hw
,

105 
IEEE80211_IFACE_ITER_NORMAL
,

106 
iwl_mvm_iÁ˚_ôî©‹
,

107 &
d©a
);

113 i‡(
d©a
.
idx
 == 0) {

114 i‡(
add
)

115 
a˘i⁄
 = 
FW_CTXT_ACTION_ADD
;

117 
a˘i⁄
 = 
FW_CTXT_ACTION_REMOVE
;

120 i‡(
add
) {

121 i‡(
	`WARN_ON_ONCE
(
d©a
.
idx
 >
MAX_MACS_IN_BINDING
))

122  -
EINVAL
;

124 
d©a
.
ids
[d©a.
idx
] = 
mvmvif
->
id
;

125 
d©a
.
cﬁ‹s
[d©a.
idx
] = 
mvmvif
->
cﬁ‹
;

126 
d©a
.
idx
++;

129  
	`iwl_mvm_bödög_cmd
(
mvm
, 
a˘i⁄
, &
d©a
);

130 
	}
}

132 
	$iwl_mvm_bödög_add_vif
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

134 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

136 i‡(
	`WARN_ON_ONCE
(!
mvmvif
->
deÊök
.
phy_˘xt
))

137  -
EINVAL
;

143 i‡(
	`iwl_mvm_sf_upd©e
(
mvm
, 
vif
, 
Ál£
))

144  -
EINVAL
;

146  
	`iwl_mvm_bödög_upd©e
(
mvm
, 
vif
, 
mvmvif
->
deÊök
.
phy_˘xt
,

147 
åue
);

148 
	}
}

150 
	$iwl_mvm_bödög_ªmove_vif
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

152 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

153 
ªt
;

155 i‡(
	`WARN_ON_ONCE
(!
mvmvif
->
deÊök
.
phy_˘xt
))

156  -
EINVAL
;

158 
ªt
 = 
	`iwl_mvm_bödög_upd©e
(
mvm
, 
vif
, 
mvmvif
->
deÊök
.
phy_˘xt
,

159 
Ál£
);

161 i‡(!
ªt
)

162 i‡(
	`iwl_mvm_sf_upd©e
(
mvm
, 
vif
, 
åue
))

163 
	`IWL_ERR
(
mvm
, "FailedÅo update SF state\n");

165  
ªt
;

166 
	}
}

168 
u32
 
	$iwl_mvm_gë_lmac_id
(
iwl_mvm
 *
mvm
, 
∆80211_b™d
 
b™d
)

170 i‡(!
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_CAPA_CDB_SUPPORT
) ||

171 
b™d
 =
NL80211_BAND_2GHZ
)

172  
IWL_LMAC_24G_INDEX
;

173  
IWL_LMAC_5G_INDEX
;

174 
	}
}

	@coex.c

6 
	~<löux/õì80211.h
>

7 
	~<löux/ëhîdevi˚.h
>

8 
	~<√t/mac80211.h
>

10 
	~"fw/≠i/c€x.h
"

11 
	~"iwl-mod∑øms.h
"

12 
	~"mvm.h
"

13 
	~"iwl-debug.h
"

16 c⁄° 
__À64
 
	giwl_ci_mask
[][3] = {

18 {
˝u_to_À64
(0), cpu_to_le64(0), cpu_to_le64(0)},

20 
˝u_to_À64
(0x0000001FFFULL),

21 
˝u_to_À64
(0x0ULL),

22 
˝u_to_À64
(0x00007FFFFFULL),

25 
˝u_to_À64
(0x000000FFFFULL),

26 
˝u_to_À64
(0x0ULL),

27 
˝u_to_À64
(0x0003FFFFFFULL),

30 
˝u_to_À64
(0x000003FFFCULL),

31 
˝u_to_À64
(0x0ULL),

32 
˝u_to_À64
(0x000FFFFFFCULL),

35 
˝u_to_À64
(0x00001FFFE0ULL),

36 
˝u_to_À64
(0x0ULL),

37 
˝u_to_À64
(0x007FFFFFE0ULL),

40 
˝u_to_À64
(0x00007FFF80ULL),

41 
˝u_to_À64
(0x00007FFFFFULL),

42 
˝u_to_À64
(0x01FFFFFF80ULL),

45 
˝u_to_À64
(0x0003FFFC00ULL),

46 
˝u_to_À64
(0x0003FFFFFFULL),

47 
˝u_to_À64
(0x0FFFFFFC00ULL),

50 
˝u_to_À64
(0x000FFFF000ULL),

51 
˝u_to_À64
(0x000FFFFFFCULL),

52 
˝u_to_À64
(0x3FFFFFF000ULL),

55 
˝u_to_À64
(0x007FFF8000ULL),

56 
˝u_to_À64
(0x007FFFFFE0ULL),

57 
˝u_to_À64
(0xFFFFFF8000ULL),

60 
˝u_to_À64
(0x01FFFE0000ULL),

61 
˝u_to_À64
(0x01FFFFFF80ULL),

62 
˝u_to_À64
(0xFFFFFE0000ULL),

65 
˝u_to_À64
(0x0FFFF00000ULL),

66 
˝u_to_À64
(0x0FFFFFFC00ULL),

67 
˝u_to_À64
(0x0ULL),

70 
˝u_to_À64
(0x3FFFC00000ULL),

71 
˝u_to_À64
(0x3FFFFFF000ULL),

72 
˝u_to_À64
(0x0)

75 
˝u_to_À64
(0xFFFE000000ULL),

76 
˝u_to_À64
(0xFFFFFF8000ULL),

77 
˝u_to_À64
(0x0)

80 
˝u_to_À64
(0xFFF8000000ULL),

81 
˝u_to_À64
(0xFFFFFE0000ULL),

82 
˝u_to_À64
(0x0)

85 
˝u_to_À64
(0xFE00000000ULL),

86 
˝u_to_À64
(0x0ULL),

87 
˝u_to_À64
(0x0ULL)

91 
iwl_bt_c€x_lut_ty≥


92 
	$iwl_gë_c€x_ty≥
(
iwl_mvm
 *
mvm
, c⁄° 
õì80211_vif
 *
vif
)

94 
õì80211_ch™˘x_c⁄f
 *
ch™˘x_c⁄f
;

95 
iwl_bt_c€x_lut_ty≥
 
ªt
;

96 
u16
 
phy_˘x_id
;

97 
u32
 
¥im¨y_ch_phy_id
, 
£c⁄d¨y_ch_phy_id
;

107 
	`rcu_ªad_lock
();

109 
ch™˘x_c⁄f
 = 
	`rcu_dîe„ªn˚
(
vif
->
bss_c⁄f
.chanctx_conf);

111 i‡(!
ch™˘x_c⁄f
 ||

112 
ch™˘x_c⁄f
->
def
.
ch™
->
b™d
 !
NL80211_BAND_2GHZ
) {

113 
	`rcu_ªad_u∆ock
();

114  
BT_COEX_INVALID_LUT
;

117 
ªt
 = 
BT_COEX_TX_DIS_LUT
;

119 
phy_˘x_id
 = *((
u16
 *)
ch™˘x_c⁄f
->
drv_¥iv
);

120 
¥im¨y_ch_phy_id
 = 
	`À32_to_˝u
(
mvm
->
œ°_bt_ci_cmd
.primary_ch_phy_id);

121 
£c⁄d¨y_ch_phy_id
 =

122 
	`À32_to_˝u
(
mvm
->
œ°_bt_ci_cmd
.
£c⁄d¨y_ch_phy_id
);

124 i‡(
¥im¨y_ch_phy_id
 =
phy_˘x_id
)

125 
ªt
 = 
	`À32_to_˝u
(
mvm
->
œ°_bt_nŸif
.
¥im¨y_ch_lut
);

126 i‡(
£c⁄d¨y_ch_phy_id
 =
phy_˘x_id
)

127 
ªt
 = 
	`À32_to_˝u
(
mvm
->
œ°_bt_nŸif
.
£c⁄d¨y_ch_lut
);

130 
	`rcu_ªad_u∆ock
();

132  
ªt
;

133 
	}
}

135 
	$iwl_mvm_£nd_bt_öô_c⁄f
(
iwl_mvm
 *
mvm
)

137 
iwl_bt_c€x_cmd
 
bt_cmd
 = {};

138 
u32
 
mode
;

140 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

142 i‡(
	`u∆ikñy
(
mvm
->
bt_f‹˚_™t_mode
 !
BT_FORCE_ANT_DIS
)) {

143 
mvm
->
bt_f‹˚_™t_mode
) {

144 
BT_FORCE_ANT_BT
:

145 
mode
 = 
BT_COEX_BT
;

147 
BT_FORCE_ANT_WIFI
:

148 
mode
 = 
BT_COEX_WIFI
;

151 
	`WARN_ON
(1);

152 
mode
 = 0;

155 
bt_cmd
.
mode
 = 
	`˝u_to_À32
(mode);

156 
£nd_cmd
;

159 
bt_cmd
.
mode
 = 
	`˝u_to_À32
(
BT_COEX_NW
);

161 i‡(
IWL_MVM_BT_COEX_SYNC2SCO
)

162 
bt_cmd
.
íabÀd_moduÀs
 |=

163 
	`˝u_to_À32
(
BT_COEX_SYNC2SCO_ENABLED
);

165 i‡(
	`iwl_mvm_is_m∂ut_suµ‹ãd
(
mvm
))

166 
bt_cmd
.
íabÀd_moduÀs
 |
	`˝u_to_À32
(
BT_COEX_MPLUT_ENABLED
);

168 
bt_cmd
.
íabÀd_moduÀs
 |
	`˝u_to_À32
(
BT_COEX_HIGH_BAND_RET
);

170 
£nd_cmd
:

171 
	`mem£t
(&
mvm
->
œ°_bt_nŸif
, 0, (mvm->last_bt_notif));

172 
	`mem£t
(&
mvm
->
œ°_bt_ci_cmd
, 0, (mvm->last_bt_ci_cmd));

174  
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
BT_CONFIG
, 0, (
bt_cmd
), &bt_cmd);

175 
	}
}

177 
	$iwl_mvm_bt_c€x_ªdu˚d_txp
(
iwl_mvm
 *
mvm
, 
u8
 
°a_id
,

178 
boﬁ
 
íabÀ
)

180 
iwl_bt_c€x_ªdu˚d_txp_upd©e_cmd
 
cmd
 = {};

181 
iwl_mvm_°a
 *
mvm°a
;

182 
u32
 
vÆue
;

184 i‡(
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 >
IWL_DEVICE_FAMILY_AX210
)

187 
mvm°a
 = 
	`iwl_mvm_°a_‰om_°aid_¥Ÿe˘ed
(
mvm
, 
°a_id
);

188 i‡(!
mvm°a
)

192 i‡(
mvm°a
->
bt_ªdu˚d_txpowî
 =
íabÀ
)

195 
vÆue
 = 
mvm°a
->
deÊök
.
°a_id
;

197 i‡(
íabÀ
)

198 
vÆue
 |
BT_REDUCED_TX_POWER_BIT
;

200 
	`IWL_DEBUG_COEX
(
mvm
, "%sableÑeduced Tx Power for sta %d\n",

201 
íabÀ
 ? "í" : "dis", 
°a_id
);

203 
cmd
.
ªdu˚d_txp
 = 
	`˝u_to_À32
(
vÆue
);

204 
mvm°a
->
bt_ªdu˚d_txpowî
 = 
íabÀ
;

206  
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
BT_COEX_UPDATE_REDUCED_TXP
,

207 
CMD_ASYNC
, (
cmd
), &cmd);

208 
	}
}

210 
	siwl_bt_ôî©‹_d©a
 {

211 
iwl_bt_c€x_¥ofûe_nŸif
 *
	mnŸif
;

212 
iwl_mvm
 *
	mmvm
;

213 
õì80211_ch™˘x_c⁄f
 *
	m¥im¨y
;

214 
õì80211_ch™˘x_c⁄f
 *
	m£c⁄d¨y
;

215 
boﬁ
 
	m¥im¨y_Œ
;

216 
u8
 
	m¥im¨y_lﬂd
;

217 
u8
 
	m£c⁄d¨y_lﬂd
;

220 
ölöe


221 
	$iwl_mvm_bt_c€x_íabÀ_rssi_evít
(
iwl_mvm
 *
mvm
,

222 
õì80211_vif
 *
vif
,

223 
boﬁ
 
íabÀ
, 
rssi
)

225 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

227 
mvmvif
->
bf_d©a
.
œ°_bt_c€x_evít
 = 
rssi
;

228 
mvmvif
->
bf_d©a
.
bt_c€x_max_thﬁd
 =

229 
íabÀ
 ? -
IWL_MVM_BT_COEX_EN_RED_TXP_THRESH
 : 0;

230 
mvmvif
->
bf_d©a
.
bt_c€x_mö_thﬁd
 =

231 
íabÀ
 ? -
IWL_MVM_BT_COEX_DIS_RED_TXP_THRESH
 : 0;

232 
	}
}

234 
	#MVM_COEX_TCM_PERIOD
 (
HZ
 * 10)

	)

236 
	$iwl_mvm_bt_c€x_tcm_ba£d_ci
(
iwl_mvm
 *
mvm
,

237 
iwl_bt_ôî©‹_d©a
 *
d©a
)

239 
now
 = 
jiffõs
;

241 i‡(!
	`time_a·î
(
now
, 
mvm
->
bt_c€x_œ°_tcm_ts
 + 
MVM_COEX_TCM_PERIOD
))

244 
mvm
->
bt_c€x_œ°_tcm_ts
 = 
now
;

249 i‡(
d©a
->
¥im¨y_Œ
)

252 i‡(
d©a
->
¥im¨y_lﬂd
 >d©a->
£c⁄d¨y_lﬂd
)

255 
	`sw≠
(
d©a
->
¥im¨y
, d©a->
£c⁄d¨y
);

256 
	}
}

258 
	$iwl_mvm_bt_c€x_íabÀ_e§
(
iwl_mvm
 *
mvm
,

259 
õì80211_vif
 *
vif
, 
boﬁ
 
íabÀ
)

261 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

262 
lök_id
;

264 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

266 i‡(!
vif
->
cfg
.
assoc
 || !
	`õì80211_vif_is_mld
(vif))

270 i‡(
mvmvif
->
bt_c€x_e§_dißbÀd
 =!
íabÀ
)

273 
mvmvif
->
bt_c€x_e§_dißbÀd
 = !
íabÀ
;

276 i‡(
mvmvif
->
e§_a˘ive
 =
íabÀ
)

279 i‡(
íabÀ
) {

281 
	`iwl_mvm_mld_£À˘_löks
(
mvm
, 
vif
, 
Ál£
);

289 
lök_id
 = 
	`iwl_mvm_mld_gë_¥im¨y_lök
(
mvm
, 
vif
, vif->
a˘ive_löks
);

290 
	`WARN_ON
(
lök_id
 < 0);

292 
	`õì80211_£t_a˘ive_löks_async
(
vif
,

293 
vif
->
a˘ive_löks
 & 
	`BIT
(
lök_id
));

294 
	}
}

300 
boﬁ


301 
	$iwl_mvm_bt_c€x_ˇlcuœã_e§_mode
(
iwl_mvm
 *
mvm
,

302 
õì80211_vif
 *
vif
,

303 
lök_id
, 
¥im¨y_lök
)

305 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

306 
iwl_mvm_vif_lök_öfo
 *
lök_öfo
 = 
mvmvif
->
lök
[
lök_id
];

307 
boﬁ
 
have_wifi_loss_øã
 =

308 
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
LEGACY_GROUP
,

309 
BT_PROFILE_NOTIFICATION
, 0) > 4;

310 
s8
 
lök_rssi
 = 0;

311 
u8
 
wifi_loss_øã
;

313 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

315 i‡(
mvm
->
œ°_bt_nŸif
.
wifi_loss_low_rssi
 =
BT_OFF
)

316  
åue
;

319 i‡(
lök_id
 =
¥im¨y_lök
)

320  
Ál£
;

323 i‡(!
have_wifi_loss_øã
)

324  
åue
;

330 i‡(
lök_öfo
)

331 
lök_rssi
 = (
s8
)
lök_öfo
->
bóc⁄_°©s
.
avg_sig«l
;

338 i‡(!
lök_rssi
)

339 
wifi_loss_øã
 = 
mvm
->
œ°_bt_nŸif
.
wifi_loss_mid_high_rssi
;

341 i‡(!
mvmvif
->
bt_c€x_e§_dißbÀd
)

343 
wifi_loss_øã
 =

344 
lök_rssi
 <-
IWL_MVM_BT_COEX_DISABLE_ESR_THRESH
 ?

345 
mvm
->
œ°_bt_nŸif
.
wifi_loss_low_rssi
 :

346 
mvm
->
œ°_bt_nŸif
.
wifi_loss_mid_high_rssi
;

349 
wifi_loss_øã
 =

350 
lök_rssi
 <-
IWL_MVM_BT_COEX_ENABLE_ESR_THRESH
 ?

351 
mvm
->
œ°_bt_nŸif
.
wifi_loss_low_rssi
 :

352 
mvm
->
œ°_bt_nŸif
.
wifi_loss_mid_high_rssi
;

354  
wifi_loss_øã
 <
IWL_MVM_BT_COEX_WIFI_LOSS_THRESH
;

355 
	}
}

357 
	$iwl_mvm_bt_c€x_upd©e_vif_e§
(
iwl_mvm
 *
mvm
,

358 
õì80211_vif
 *
vif
,

359 
lök_id
)

361 
ußbÀ_löks
 = 
	`õì80211_vif_ußbÀ_löks
(
vif
);

362 
¥im¨y_lök
 = 
	`iwl_mvm_mld_gë_¥im¨y_lök
(
mvm
, 
vif
,

363 
ußbÀ_löks
);

364 
boﬁ
 
íabÀ
;

367 i‡(
¥im¨y_lök
 < 0)

370 
íabÀ
 = 
	`iwl_mvm_bt_c€x_ˇlcuœã_e§_mode
(
mvm
, 
vif
, 
lök_id
,

371 
¥im¨y_lök
);

373 
	`iwl_mvm_bt_c€x_íabÀ_e§
(
mvm
, 
vif
, 
íabÀ
);

374 
	}
}

376 
	$iwl_mvm_bt_nŸif_≥r_lök
(
iwl_mvm
 *
mvm
,

377 
õì80211_vif
 *
vif
,

378 
iwl_bt_ôî©‹_d©a
 *
d©a
,

379 
lök_id
)

382 
õì80211_smps_mode
 
smps_mode
 = 
IEEE80211_SMPS_AUTOMATIC
;

383 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

384 
u32
 
bt_a˘ivôy_gødög
, 
mö_ag_f‹_°©ic_smps
;

385 
õì80211_ch™˘x_c⁄f
 *
ch™˘x_c⁄f
;

386 
iwl_mvm_vif_lök_öfo
 *
lök_öfo
;

387 
õì80211_bss_c⁄f
 *
lök_c⁄f
;

388 
ave_rssi
;

390 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

392 
lök_öfo
 = 
mvmvif
->
lök
[
lök_id
];

393 i‡(!
lök_öfo
)

396 
lök_c⁄f
 = 
	`rcu_dîe„ªn˚
(
vif
->lök_c⁄f[
lök_id
]);

401 i‡(!
lök_c⁄f
)

404 
ch™˘x_c⁄f
 = 
	`rcu_dîe„ªn˚
(
lök_c⁄f
->chanctx_conf);

407 i‡((!
ch™˘x_c⁄f
 ||

408 
ch™˘x_c⁄f
->
def
.
ch™
->
b™d
 !
NL80211_BAND_2GHZ
)) {

409 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
) {

411 
	`iwl_mvm_upd©e_smps
(
mvm
, 
vif
, 
IWL_MVM_SMPS_REQ_BT_COEX
,

412 
smps_mode
, 
lök_id
);

413 
	`iwl_mvm_bt_c€x_ªdu˚d_txp
(
mvm
, 
lök_öfo
->
≠_°a_id
,

414 
Ál£
);

416 
	`iwl_mvm_bt_c€x_íabÀ_rssi_evít
(
mvm
, 
vif
, 
Ál£
, 0);

421 
	`iwl_mvm_bt_c€x_upd©e_vif_e§
(
mvm
, 
vif
, 
lök_id
);

423 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_CAPA_COEX_SCHEMA_2
))

424 
mö_ag_f‹_°©ic_smps
 = 
BT_VERY_HIGH_TRAFFIC
;

426 
mö_ag_f‹_°©ic_smps
 = 
BT_HIGH_TRAFFIC
;

428 
bt_a˘ivôy_gødög
 = 
	`À32_to_˝u
(
d©a
->
nŸif
->bt_activity_grading);

429 i‡(
bt_a˘ivôy_gødög
 >
mö_ag_f‹_°©ic_smps
)

430 
smps_mode
 = 
IEEE80211_SMPS_STATIC
;

431 i‡(
bt_a˘ivôy_gødög
 >
BT_LOW_TRAFFIC
)

432 
smps_mode
 = 
IEEE80211_SMPS_DYNAMIC
;

435 i‡(!
vif
->
cfg
.
assoc
)

436 
smps_mode
 = 
IEEE80211_SMPS_AUTOMATIC
;

438 i‡(
lök_öfo
->
phy_˘xt
 &&

439 (
mvm
->
œ°_bt_nŸif
.
ºc_°©us
 & 
	`BIT
(
lök_öfo
->
phy_˘xt
->
id
)))

440 
smps_mode
 = 
IEEE80211_SMPS_AUTOMATIC
;

442 
	`IWL_DEBUG_COEX
(
d©a
->
mvm
,

444 
mvmvif
->
id
, 
lök_öfo
->
fw_lök_id
,

445 
bt_a˘ivôy_gødög
, 
smps_mode
);

447 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
)

448 
	`iwl_mvm_upd©e_smps
(
mvm
, 
vif
, 
IWL_MVM_SMPS_REQ_BT_COEX
,

449 
smps_mode
, 
lök_id
);

452 i‡(
	`iwl_mvm_vif_low_œãncy
(
mvmvif
)) {

453 
d©a
->
¥im¨y_Œ
 = 
åue
;

455 
d©a
->
£c⁄d¨y
 = d©a->
¥im¨y
;

456 
d©a
->
¥im¨y
 = 
ch™˘x_c⁄f
;

459 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
) {

460 i‡(!
mvmvif
->
≠_ibss_a˘ive
)

463 i‡(
ch™˘x_c⁄f
 =
d©a
->
¥im¨y
)

466 i‡(!
d©a
->
¥im¨y_Œ
) {

471 
d©a
->
£c⁄d¨y
 = d©a->
¥im¨y
;

472 
d©a
->
¥im¨y
 = 
ch™˘x_c⁄f
;

475 
d©a
->
£c⁄d¨y
 = 
ch™˘x_c⁄f
;

479 i‡(
d©a
->
¥im¨y
 =
ch™˘x_c⁄f
)

480 
d©a
->
¥im¨y_lﬂd
 = 
mvm
->
tcm
.
ªsu…
.
lﬂd
[
mvmvif
->
id
];

481 i‡(
d©a
->
£c⁄d¨y
 =
ch™˘x_c⁄f
)

482 
d©a
->
£c⁄d¨y_lﬂd
 = 
mvm
->
tcm
.
ªsu…
.
lﬂd
[
mvmvif
->
id
];

490 i‡(!
d©a
->
¥im¨y
 || d©a->¥im¨y =
ch™˘x_c⁄f
)

491 
d©a
->
¥im¨y
 = 
ch™˘x_c⁄f
;

492 i‡(!
d©a
->
£c⁄d¨y
)

494 
d©a
->
£c⁄d¨y
 = 
ch™˘x_c⁄f
;

497 i‡(
d©a
->
¥im¨y
 =
ch™˘x_c⁄f
)

498 
d©a
->
¥im¨y_lﬂd
 = 
mvm
->
tcm
.
ªsu…
.
lﬂd
[
mvmvif
->
id
];

499 i‡(
d©a
->
£c⁄d¨y
 =
ch™˘x_c⁄f
)

500 
d©a
->
£c⁄d¨y_lﬂd
 = 
mvm
->
tcm
.
ªsu…
.
lﬂd
[
mvmvif
->
id
];

507 i‡(
	`iwl_gë_c€x_ty≥
(
mvm
, 
vif
Ë=
BT_COEX_LOOSE_LUT
 ||

508 
	`À32_to_˝u
(
mvm
->
œ°_bt_nŸif
.
bt_a˘ivôy_gødög
Ë=
BT_OFF
 ||

509 !
vif
->
cfg
.
assoc
) {

510 
	`iwl_mvm_bt_c€x_ªdu˚d_txp
(
mvm
, 
lök_öfo
->
≠_°a_id
, 
Ál£
);

512 
	`iwl_mvm_bt_c€x_íabÀ_rssi_evít
(
mvm
, 
vif
, 
Ál£
, 0);

517 
ave_rssi
 = 
mvmvif
->
bf_d©a
.
ave_bóc⁄_sig«l
;

520 i‡(!
ave_rssi
)

521 
ave_rssi
 = -100;

522 i‡(
ave_rssi
 > -
IWL_MVM_BT_COEX_EN_RED_TXP_THRESH
) {

523 i‡(
	`iwl_mvm_bt_c€x_ªdu˚d_txp
(
mvm
, 
lök_öfo
->
≠_°a_id
,

524 
åue
))

525 
	`IWL_ERR
(
mvm
, "Couldn't send BT_CONFIG cmd\n");

526 } i‡(
ave_rssi
 < -
IWL_MVM_BT_COEX_DIS_RED_TXP_THRESH
) {

527 i‡(
	`iwl_mvm_bt_c€x_ªdu˚d_txp
(
mvm
, 
lök_öfo
->
≠_°a_id
,

528 
Ál£
))

529 
	`IWL_ERR
(
mvm
, "Couldn't send BT_CONFIG cmd\n");

533 
	`iwl_mvm_bt_c€x_íabÀ_rssi_evít
(
mvm
, 
vif
, 
åue
, 
ave_rssi
);

534 
	}
}

537 
	$iwl_mvm_bt_nŸif_ôî©‹
(*
_d©a
, 
u8
 *
mac
,

538 
õì80211_vif
 *
vif
)

540 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

541 
iwl_bt_ôî©‹_d©a
 *
d©a
 = 
_d©a
;

542 
iwl_mvm
 *
mvm
 = 
d©a
->mvm;

543 
lök_id
;

545 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

547 
vif
->
ty≥
) {

548 
NL80211_IFTYPE_STATION
:

550 
NL80211_IFTYPE_AP
:

551 i‡(!
mvmvif
->
≠_ibss_a˘ive
)

559 i‡(
d©a
->
nŸif
->
wifi_loss_low_rssi
 =
BT_OFF
)

560 
	`iwl_mvm_bt_c€x_íabÀ_e§
(
mvm
, 
vif
, 
åue
);

562 
lök_id
 = 0;Üök_id < 
IEEE80211_MLD_MAX_NUM_LINKS
;Üink_id++)

563 
	`iwl_mvm_bt_nŸif_≥r_lök
(
mvm
, 
vif
, 
d©a
, 
lök_id
);

564 
	}
}

566 
	$iwl_mvm_bt_c€x_nŸif_h™dÀ
(
iwl_mvm
 *
mvm
)

568 
iwl_bt_ôî©‹_d©a
 
d©a
 = {

569 .
mvm
 = mvm,

570 .
nŸif
 = &
mvm
->
œ°_bt_nŸif
,

572 
iwl_bt_c€x_ci_cmd
 
cmd
 = {};

573 
u8
 
ci_bw_idx
;

576 i‡(
	`u∆ikñy
(
mvm
->
bt_f‹˚_™t_mode
 !
BT_FORCE_ANT_DIS
))

579 
	`rcu_ªad_lock
();

580 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s_©omic
(

581 
mvm
->
hw
, 
IEEE80211_IFACE_ITER_NORMAL
,

582 
iwl_mvm_bt_nŸif_ôî©‹
, &
d©a
);

584 i‡(
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 >
IWL_DEVICE_FAMILY_AX210
) {

585 
	`rcu_ªad_u∆ock
();

589 
	`iwl_mvm_bt_c€x_tcm_ba£d_ci
(
mvm
, &
d©a
);

591 i‡(
d©a
.
¥im¨y
) {

592 
õì80211_ch™˘x_c⁄f
 *
ch™
 = 
d©a
.
¥im¨y
;

593 i‡(
	`WARN_ON
(!
ch™
->
def
.chan)) {

594 
	`rcu_ªad_u∆ock
();

598 i‡(
ch™
->
def
.
width
 < 
NL80211_CHAN_WIDTH_40
) {

599 
ci_bw_idx
 = 0;

601 i‡(
ch™
->
def
.
˚¡î_‰eq1
 >

602 
ch™
->
def
.ch™->
˚¡î_‰eq
)

603 
ci_bw_idx
 = 2;

605 
ci_bw_idx
 = 1;

608 
cmd
.
bt_¥im¨y_ci
 =

609 
iwl_ci_mask
[
ch™
->
def
.ch™->
hw_vÆue
][
ci_bw_idx
];

610 
cmd
.
¥im¨y_ch_phy_id
 =

611 
	`˝u_to_À32
(*((
u16
 *)
d©a
.
¥im¨y
->
drv_¥iv
));

614 i‡(
d©a
.
£c⁄d¨y
) {

615 
õì80211_ch™˘x_c⁄f
 *
ch™
 = 
d©a
.
£c⁄d¨y
;

616 i‡(
	`WARN_ON
(!
d©a
.
£c⁄d¨y
->
def
.
ch™
)) {

617 
	`rcu_ªad_u∆ock
();

621 i‡(
ch™
->
def
.
width
 < 
NL80211_CHAN_WIDTH_40
) {

622 
ci_bw_idx
 = 0;

624 i‡(
ch™
->
def
.
˚¡î_‰eq1
 >

625 
ch™
->
def
.ch™->
˚¡î_‰eq
)

626 
ci_bw_idx
 = 2;

628 
ci_bw_idx
 = 1;

631 
cmd
.
bt_£c⁄d¨y_ci
 =

632 
iwl_ci_mask
[
ch™
->
def
.ch™->
hw_vÆue
][
ci_bw_idx
];

633 
cmd
.
£c⁄d¨y_ch_phy_id
 =

634 
	`˝u_to_À32
(*((
u16
 *)
d©a
.
£c⁄d¨y
->
drv_¥iv
));

637 
	`rcu_ªad_u∆ock
();

640 i‡(
	`memcmp
(&
cmd
, &
mvm
->
œ°_bt_ci_cmd
, (cmd))) {

641 i‡(
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
BT_COEX_CI
, 0,

642 (
cmd
), &cmd))

643 
	`IWL_ERR
(
mvm
, "FailedÅo send BT_CI cmd\n");

644 
	`mem˝y
(&
mvm
->
œ°_bt_ci_cmd
, &
cmd
, (cmd));

646 
	}
}

648 
	$iwl_mvm_rx_bt_c€x_nŸif
(
iwl_mvm
 *
mvm
,

649 
iwl_rx_cmd_buf„r
 *
rxb
)

651 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

652 
iwl_bt_c€x_¥ofûe_nŸif
 *
nŸif
 = (*)
pkt
->
d©a
;

654 
	`IWL_DEBUG_COEX
(
mvm
, "BT Coex NotificationÑeceived\n");

655 
	`IWL_DEBUG_COEX
(
mvm
, "\tBT còcom∂ün˚ %d\n", 
nŸif
->
bt_ci_com∂ün˚
);

656 
	`IWL_DEBUG_COEX
(
mvm
, "\tBTÖrimary_ch_lut %d\n",

657 
	`À32_to_˝u
(
nŸif
->
¥im¨y_ch_lut
));

658 
	`IWL_DEBUG_COEX
(
mvm
, "\tBT secondary_ch_lut %d\n",

659 
	`À32_to_˝u
(
nŸif
->
£c⁄d¨y_ch_lut
));

660 
	`IWL_DEBUG_COEX
(
mvm
, "\tBTáctivity grading %d\n",

661 
	`À32_to_˝u
(
nŸif
->
bt_a˘ivôy_gødög
));

664 
	`mem˝y
(&
mvm
->
œ°_bt_nŸif
, 
nŸif
, (mvm->last_bt_notif));

666 
	`iwl_mvm_bt_c€x_nŸif_h™dÀ
(
mvm
);

667 
	}
}

669 
	$iwl_mvm_bt_rssi_evít
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

670 
õì80211_rssi_evít_d©a
 
rssi_evít
)

672 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

673 
ªt
;

675 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

678 i‡(
	`u∆ikñy
(
mvm
->
bt_f‹˚_™t_mode
 !
BT_FORCE_ANT_DIS
))

685 i‡(
mvmvif
->
deÊök
.
≠_°a_id
 =
IWL_MVM_INVALID_STA
)

689 i‡(
	`À32_to_˝u
(
mvm
->
œ°_bt_nŸif
.
bt_a˘ivôy_gødög
Ë=
BT_OFF
)

692 
	`IWL_DEBUG_COEX
(
mvm
, "RSSI f‹ %pM i†now %s\n", 
vif
->
bss_c⁄f
.
bssid
,

693 
rssi_evít
 =
RSSI_EVENT_HIGH
 ? "HIGH" : "LOW");

699 i‡(
rssi_evít
 =
RSSI_EVENT_LOW
 ||

700 
	`iwl_gë_c€x_ty≥
(
mvm
, 
vif
Ë=
BT_COEX_LOOSE_LUT
)

701 
ªt
 = 
	`iwl_mvm_bt_c€x_ªdu˚d_txp
(
mvm
,

702 
mvmvif
->
deÊök
.
≠_°a_id
,

703 
Ál£
);

705 
ªt
 = 
	`iwl_mvm_bt_c€x_ªdu˚d_txp
(
mvm
,

706 
mvmvif
->
deÊök
.
≠_°a_id
,

707 
åue
);

709 i‡(
ªt
)

710 
	`IWL_ERR
(
mvm
, "couldn't send BT_CONFIG HCMD upon RSSIÉvent\n");

711 
	}
}

713 
	#LINK_QUAL_AGG_TIME_LIMIT_DEF
 (4000)

	)

714 
	#LINK_QUAL_AGG_TIME_LIMIT_BT_ACT
 (1200)

	)

716 
u16
 
	$iwl_mvm_c€x_agg_time_limô
(
iwl_mvm
 *
mvm
,

717 
õì80211_°a
 *
°a
)

719 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

720 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
mvm°a
->
vif
);

721 
iwl_mvm_phy_˘xt
 *
phy_˘xt
 = 
mvmvif
->
deÊök
.phy_ctxt;

722 
iwl_bt_c€x_lut_ty≥
 
lut_ty≥
;

724 i‡(
mvm
->
œ°_bt_nŸif
.
âc_°©us
 & 
	`BIT
(
phy_˘xt
->
id
))

725  
LINK_QUAL_AGG_TIME_LIMIT_DEF
;

727 i‡(
	`À32_to_˝u
(
mvm
->
œ°_bt_nŸif
.
bt_a˘ivôy_gødög
) <

728 
BT_HIGH_TRAFFIC
)

729  
LINK_QUAL_AGG_TIME_LIMIT_DEF
;

731 
lut_ty≥
 = 
	`iwl_gë_c€x_ty≥
(
mvm
, 
mvm°a
->
vif
);

733 i‡(
lut_ty≥
 =
BT_COEX_LOOSE_LUT
 ||Üut_ty≥ =
BT_COEX_INVALID_LUT
)

734  
LINK_QUAL_AGG_TIME_LIMIT_DEF
;

737  
LINK_QUAL_AGG_TIME_LIMIT_BT_ACT
;

738 
	}
}

740 
boﬁ
 
	$iwl_mvm_bt_c€x_is_mimo_Ælowed
(
iwl_mvm
 *
mvm
,

741 
õì80211_°a
 *
°a
)

743 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

744 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
mvm°a
->
vif
);

745 
iwl_mvm_phy_˘xt
 *
phy_˘xt
 = 
mvmvif
->
deÊök
.phy_ctxt;

746 
iwl_bt_c€x_lut_ty≥
 
lut_ty≥
;

748 i‡(
mvm
->
œ°_bt_nŸif
.
âc_°©us
 & 
	`BIT
(
phy_˘xt
->
id
))

749  
åue
;

751 i‡(
	`À32_to_˝u
(
mvm
->
œ°_bt_nŸif
.
bt_a˘ivôy_gødög
) <

752 
BT_HIGH_TRAFFIC
)

753  
åue
;

762 
lut_ty≥
 = 
	`iwl_gë_c€x_ty≥
(
mvm
, 
mvm°a
->
vif
);

763  
lut_ty≥
 !
BT_COEX_LOOSE_LUT
;

764 
	}
}

766 
boﬁ
 
	$iwl_mvm_bt_c€x_is_™t_avaû
(
iwl_mvm
 *
mvm
, 
u8
 
™t
)

768 i‡(
™t
 & 
mvm
->
cfg
->
n⁄_sh¨ed_™t
)

769  
åue
;

771  
	`À32_to_˝u
(
mvm
->
œ°_bt_nŸif
.
bt_a˘ivôy_gødög
) <

772 
BT_HIGH_TRAFFIC
;

773 
	}
}

775 
boﬁ
 
	$iwl_mvm_bt_c€x_is_sh¨ed_™t_avaû
(
iwl_mvm
 *
mvm
)

777  
	`À32_to_˝u
(
mvm
->
œ°_bt_nŸif
.
bt_a˘ivôy_gødög
Ë< 
BT_HIGH_TRAFFIC
;

778 
	}
}

780 
boﬁ
 
	$iwl_mvm_bt_c€x_is_çc_Ælowed
(
iwl_mvm
 *
mvm
,

781 
∆80211_b™d
 
b™d
)

783 
u32
 
bt_a˘ivôy
 = 
	`À32_to_˝u
(
mvm
->
œ°_bt_nŸif
.
bt_a˘ivôy_gødög
);

785 i‡(
b™d
 !
NL80211_BAND_2GHZ
)

786  
Ál£
;

788  
bt_a˘ivôy
 >
BT_LOW_TRAFFIC
;

789 
	}
}

791 
u8
 
	$iwl_mvm_bt_c€x_gë_sögÀ_™t_msk
(
iwl_mvm
 *
mvm
, 
u8
 
íabÀd_™ts
)

793 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_CAPA_COEX_SCHEMA_2
) &&

794 (
mvm
->
cfg
->
n⁄_sh¨ed_™t
 & 
íabÀd_™ts
))

795  
mvm
->
cfg
->
n⁄_sh¨ed_™t
;

797  
	`fú°_™ã¬a
(
íabÀd_™ts
);

798 
	}
}

800 
u8
 
	$iwl_mvm_bt_c€x_tx_¥io
(
iwl_mvm
 *
mvm
, 
õì80211_hdr
 *
hdr
,

801 
õì80211_tx_öfo
 *
öfo
, 
u8
 
ac
)

803 
__À16
 
fc
 = 
hdr
->
‰ame_c⁄åﬁ
;

804 
boﬁ
 
m∂ut_íabÀd
 = 
	`iwl_mvm_is_m∂ut_suµ‹ãd
(
mvm
);

806 i‡(
öfo
->
b™d
 !
NL80211_BAND_2GHZ
)

809 i‡(
	`u∆ikñy
(
mvm
->
bt_tx_¥io
))

810  
mvm
->
bt_tx_¥io
 - 1;

812 i‡(
	`likñy
(
	`õì80211_is_d©a
(
fc
))) {

813 i‡(
	`likñy
(
	`õì80211_is_d©a_qos
(
fc
))) {

814 
ac
) {

815 
IEEE80211_AC_BE
:

816  
m∂ut_íabÀd
 ? 1 : 0;

817 
IEEE80211_AC_VI
:

818  
m∂ut_íabÀd
 ? 2 : 3;

819 
IEEE80211_AC_VO
:

824 } i‡(
	`is_mu…iˇ°_ëhî_addr
(
hdr
->
addr1
)) {

828 } i‡(
	`õì80211_is_mgmt
(
fc
)) {

829  
	`õì80211_is_dißssoc
(
fc
) ? 0 : 3;

830 } i‡(
	`õì80211_is_˘l
(
fc
)) {

836 
	}
}

838 
	$iwl_mvm_bt_c€x_vif_ch™ge
(
iwl_mvm
 *
mvm
)

840 
	`iwl_mvm_bt_c€x_nŸif_h™dÀ
(
mvm
);

841 
	}
}

	@constants.h

7 #i‚de‡
__MVM_CONSTANTS_H


8 
	#__MVM_CONSTANTS_H


	)

10 
	~<löux/õì80211.h
>

11 
	~"fw-≠i.h
"

13 
	#IWL_MVM_UAPSD_NOAGG_BSSIDS_NUM
 20

	)

14 
	#IWL_MVM_BT_COEX_DISABLE_ESR_THRESH
 69

	)

15 
	#IWL_MVM_BT_COEX_ENABLE_ESR_THRESH
 63

	)

16 
	#IWL_MVM_BT_COEX_WIFI_LOSS_THRESH
 0

	)

18 
	#IWL_MVM_DEFAULT_PS_TX_DATA_TIMEOUT
 (100 * 
USEC_PER_MSEC
)

	)

19 
	#IWL_MVM_DEFAULT_PS_RX_DATA_TIMEOUT
 (100 * 
USEC_PER_MSEC
)

	)

20 
	#IWL_MVM_WOWLAN_PS_TX_DATA_TIMEOUT
 (10 * 
USEC_PER_MSEC
)

	)

21 
	#IWL_MVM_WOWLAN_PS_RX_DATA_TIMEOUT
 (10 * 
USEC_PER_MSEC
)

	)

22 
	#IWL_MVM_SHORT_PS_TX_DATA_TIMEOUT
 (2 * 1024Ë

	)

23 
	#IWL_MVM_SHORT_PS_RX_DATA_TIMEOUT
 (40 * 1024Ë

	)

24 
	#IWL_MVM_P2P_LOWLATENCY_PS_ENABLE
 0

	)

25 
	#IWL_MVM_UAPSD_RX_DATA_TIMEOUT
 (50 * 
USEC_PER_MSEC
)

	)

26 
	#IWL_MVM_UAPSD_TX_DATA_TIMEOUT
 (50 * 
USEC_PER_MSEC
)

	)

27 
	#IWL_MVM_UAPSD_QUEUES
 (
IEEE80211_WMM_IE_STA_QOSINFO_AC_VO
 |\

28 
IEEE80211_WMM_IE_STA_QOSINFO_AC_VI
 |\

29 
IEEE80211_WMM_IE_STA_QOSINFO_AC_BK
 |\

30 
IEEE80211_WMM_IE_STA_QOSINFO_AC_BE
)

	)

31 
	#IWL_MVM_PS_HEAVY_TX_THLD_PACKETS
 20

	)

32 
	#IWL_MVM_PS_HEAVY_RX_THLD_PACKETS
 8

	)

33 
	#IWL_MVM_PS_SNOOZE_HEAVY_TX_THLD_PACKETS
 30

	)

34 
	#IWL_MVM_PS_SNOOZE_HEAVY_RX_THLD_PACKETS
 20

	)

35 
	#IWL_MVM_PS_HEAVY_TX_THLD_PERCENT
 50

	)

36 
	#IWL_MVM_PS_HEAVY_RX_THLD_PERCENT
 50

	)

37 
	#IWL_MVM_PS_SNOOZE_INTERVAL
 25

	)

38 
	#IWL_MVM_PS_SNOOZE_WINDOW
 50

	)

39 
	#IWL_MVM_WOWLAN_PS_SNOOZE_WINDOW
 25

	)

40 
	#IWL_MVM_LOWLAT_QUOTA_MIN_PERCENT
 64

	)

41 
	#IWL_MVM_BT_COEX_EN_RED_TXP_THRESH
 62

	)

42 
	#IWL_MVM_BT_COEX_DIS_RED_TXP_THRESH
 65

	)

43 
	#IWL_MVM_BT_COEX_SYNC2SCO
 1

	)

44 
	#IWL_MVM_BT_COEX_MPLUT
 1

	)

45 
	#IWL_MVM_BT_COEX_RRC
 1

	)

46 
	#IWL_MVM_BT_COEX_TTC
 1

	)

47 
	#IWL_MVM_BT_COEX_MPLUT_REG0
 0x22002200

	)

48 
	#IWL_MVM_BT_COEX_MPLUT_REG1
 0x11118451

	)

49 
	#IWL_MVM_BT_COEX_ANTENNA_COUPLING_THRS
 30

	)

50 
	#IWL_MVM_FW_MCAST_FILTER_PASS_ALL
 0

	)

51 
	#IWL_MVM_FW_BCAST_FILTER_PASS_ALL
 0

	)

52 
	#IWL_MVM_QUOTA_THRESHOLD
 4

	)

53 
	#IWL_MVM_RS_RSSI_BASED_INIT_RATE
 0

	)

54 
	#IWL_MVM_RS_80_20_FAR_RANGE_TWEAK
 1

	)

55 
	#IWL_MVM_TOF_IS_RESPONDER
 0

	)

56 
	#IWL_MVM_HW_CSUM_DISABLE
 0

	)

57 
	#IWL_MVM_PARSE_NVM
 0

	)

58 
	#IWL_MVM_ADWELL_ENABLE
 1

	)

59 
	#IWL_MVM_ADWELL_MAX_BUDGET
 0

	)

60 
	#IWL_MVM_TCM_LOAD_MEDIUM_THRESH
 10

	)

61 
	#IWL_MVM_TCM_LOAD_HIGH_THRESH
 50

	)

62 
	#IWL_MVM_TCM_LOWLAT_ENABLE_THRESH
 100

	)

63 
	#IWL_MVM_UAPSD_NONAGG_PERIOD
 5000

	)

64 
	#IWL_MVM_UAPSD_NOAGG_LIST_LEN
 
IWL_MVM_UAPSD_NOAGG_BSSIDS_NUM


	)

65 
	#IWL_MVM_NON_TRANSMITTING_AP
 0

	)

66 
	#IWL_MVM_CONN_LISTEN_INTERVAL
 10

	)

67 
	#IWL_MVM_RS_NUM_TRY_BEFORE_ANT_TOGGLE
 1

	)

68 
	#IWL_MVM_RS_HT_VHT_RETRIES_PER_RATE
 2

	)

69 
	#IWL_MVM_RS_HT_VHT_RETRIES_PER_RATE_TW
 1

	)

70 
	#IWL_MVM_RS_INITIAL_MIMO_NUM_RATES
 3

	)

71 
	#IWL_MVM_RS_INITIAL_SISO_NUM_RATES
 3

	)

72 
	#IWL_MVM_RS_INITIAL_LEGACY_NUM_RATES
 2

	)

73 
	#IWL_MVM_RS_INITIAL_LEGACY_RETRIES
 2

	)

74 
	#IWL_MVM_RS_SECONDARY_LEGACY_RETRIES
 1

	)

75 
	#IWL_MVM_RS_SECONDARY_LEGACY_NUM_RATES
 16

	)

76 
	#IWL_MVM_RS_SECONDARY_SISO_NUM_RATES
 3

	)

77 
	#IWL_MVM_RS_SECONDARY_SISO_RETRIES
 1

	)

78 
	#IWL_MVM_RS_RATE_MIN_FAILURE_TH
 3

	)

79 
	#IWL_MVM_RS_RATE_MIN_SUCCESS_TH
 8

	)

80 
	#IWL_MVM_RS_STAY_IN_COLUMN_TIMEOUT
 5

	)

81 
	#IWL_MVM_RS_IDLE_TIMEOUT
 5

	)

82 
	#IWL_MVM_RS_MISSED_RATE_MAX
 15

	)

83 
	#IWL_MVM_RS_LEGACY_FAILURE_LIMIT
 160

	)

84 
	#IWL_MVM_RS_LEGACY_SUCCESS_LIMIT
 480

	)

85 
	#IWL_MVM_RS_LEGACY_TABLE_COUNT
 160

	)

86 
	#IWL_MVM_RS_NON_LEGACY_FAILURE_LIMIT
 400

	)

87 
	#IWL_MVM_RS_NON_LEGACY_SUCCESS_LIMIT
 4500

	)

88 
	#IWL_MVM_RS_NON_LEGACY_TABLE_COUNT
 1500

	)

89 
	#IWL_MVM_RS_SR_FORCE_DECREASE
 15

	)

90 
	#IWL_MVM_RS_SR_NO_DECREASE
 85

	)

91 
	#IWL_MVM_RS_AGG_TIME_LIMIT
 4000

	)

92 
	#IWL_MVM_RS_AGG_DISABLE_START
 3

	)

93 
	#IWL_MVM_RS_AGG_START_THRESHOLD
 10

	)

94 
	#IWL_MVM_RS_TPC_SR_FORCE_INCREASE
 75

	)

95 
	#IWL_MVM_RS_TPC_SR_NO_INCREASE
 85

	)

96 
	#IWL_MVM_RS_TPC_TX_POWER_STEP
 3

	)

97 
	#IWL_MVM_ENABLE_EBS
 1

	)

98 
	#IWL_MVM_FTM_INITIATOR_ALGO
 
IWL_TOF_ALGO_TYPE_MAX_LIKE


	)

99 
	#IWL_MVM_FTM_INITIATOR_DYNACK
 
åue


	)

100 
	#IWL_MVM_FTM_LMR_FEEDBACK_TERMINATE
 
Ál£


	)

101 
	#IWL_MVM_FTM_R2I_MAX_REP
 7

	)

102 
	#IWL_MVM_FTM_I2R_MAX_REP
 7

	)

103 
	#IWL_MVM_FTM_R2I_MAX_STS
 1

	)

104 
	#IWL_MVM_FTM_I2R_MAX_STS
 1

	)

105 
	#IWL_MVM_FTM_R2I_MAX_TOTAL_LTF
 3

	)

106 
	#IWL_MVM_FTM_I2R_MAX_TOTAL_LTF
 3

	)

107 
	#IWL_MVM_FTM_INITIATOR_SECURE_LTF
 
Ál£


	)

108 
	#IWL_MVM_FTM_RESP_NDP_SUPPORT
 
åue


	)

109 
	#IWL_MVM_FTM_RESP_LMR_FEEDBACK_SUPPORT
 
åue


	)

110 
	#IWL_MVM_FTM_NON_TB_MIN_TIME_BETWEEN_MSR
 5

	)

111 
	#IWL_MVM_FTM_NON_TB_MAX_TIME_BETWEEN_MSR
 1000

	)

112 
	#IWL_MVM_D3_DEBUG
 
Ál£


	)

113 
	#IWL_MVM_USE_TWT
 
åue


	)

114 
	#IWL_MVM_AMPDU_CONSEC_DROPS_DELBA
 20

	)

115 
	#IWL_MVM_USE_NSSN_SYNC
 0

	)

116 
	#IWL_MVM_FTM_INITIATOR_ENABLE_SMOOTH
 
Ál£


	)

117 
	#IWL_MVM_FTM_INITIATOR_SMOOTH_ALPHA
 40

	)

119 
	#IWL_MVM_FTM_INITIATOR_SMOOTH_UNDERSHOOT
 20016

	)

120 
	#IWL_MVM_FTM_INITIATOR_SMOOTH_OVERSHOOT
 20016

	)

121 
	#IWL_MVM_FTM_INITIATOR_SMOOTH_AGE_SEC
 2

	)

122 
	#IWL_MVM_DISABLE_AP_FILS
 
Ál£


	)

123 
	#IWL_MVM_6GHZ_PASSIVE_SCAN_TIMEOUT
 3000

	)

124 
	#IWL_MVM_6GHZ_PASSIVE_SCAN_ASSOC_TIMEOUT
 60

	)

125 
	#IWL_MVM_AUTO_EML_ENABLE
 
åue


	)

	@d3.c

7 
	~<löux/ëhîdevi˚.h
>

8 
	~<löux/ù.h
>

9 
	~<löux/fs.h
>

10 
	~<√t/cfg80211.h
>

11 
	~<√t/ùv6.h
>

12 
	~<√t/t˝.h
>

13 
	~<√t/addrc⁄f.h
>

14 
	~"iwl-mod∑øms.h
"

15 
	~"fw-≠i.h
"

16 
	~"mvm.h
"

17 
	~"fw/img.h
"

19 
	$iwl_mvm_£t_ªkey_d©a
(
õì80211_hw
 *
hw
,

20 
õì80211_vif
 *
vif
,

21 
cfg80211_gtk_ªkey_d©a
 *
d©a
)

23 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

24 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

26 
	`muãx_lock
(&
mvm
->
muãx
);

28 
mvmvif
->
ªkey_d©a
.
kek_Àn
 = 
d©a
->kek_len;

29 
mvmvif
->
ªkey_d©a
.
kck_Àn
 = 
d©a
->kck_len;

30 
	`mem˝y
(
mvmvif
->
ªkey_d©a
.
kek
, 
d©a
->kek, d©a->
kek_Àn
);

31 
	`mem˝y
(
mvmvif
->
ªkey_d©a
.
kck
, 
d©a
->kck, d©a->
kck_Àn
);

32 
mvmvif
->
ªkey_d©a
.
akm
 = 
d©a
->akm & 0xFF;

33 
mvmvif
->
ªkey_d©a
.
ª∂ay_˘r
 =

34 
	`˝u_to_À64
(
	`be64_to_˝up
((c⁄° 
__be64
 *)
d©a
->
ª∂ay_˘r
));

35 
mvmvif
->
ªkey_d©a
.
vÆid
 = 
åue
;

37 
	`muãx_u∆ock
(&
mvm
->
muãx
);

38 
	}
}

40 #i‡
IS_ENABLED
(
CONFIG_IPV6
)

41 
	$iwl_mvm_ùv6_addr_ch™ge
(
õì80211_hw
 *
hw
,

42 
õì80211_vif
 *
vif
,

43 
öë6_dev
 *
idev
)

45 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

46 
öë6_iÁddr
 *
iÁ
;

47 
idx
 = 0;

49 
	`mem£t
(
mvmvif
->
ã¡©ive_addrs
, 0, (mvmvif->tentative_addrs));

51 
	`ªad_lock_bh
(&
idev
->
lock
);

52 
	`li°_f‹_óch_íåy
(
iÁ
, &
idev
->
addr_li°
, 
if_li°
) {

53 
mvmvif
->
èrgë_ùv6_addrs
[
idx
] = 
iÁ
->
addr
;

54 i‡(
iÁ
->
Êags
 & 
IFA_F_TENTATIVE
)

55 
	`__£t_bô
(
idx
, 
mvmvif
->
ã¡©ive_addrs
);

56 
idx
++;

57 i‡(
idx
 >
IWL_PROTO_OFFLOAD_NUM_IPV6_ADDRS_MAX
)

60 
	`ªad_u∆ock_bh
(&
idev
->
lock
);

62 
mvmvif
->
num_èrgë_ùv6_addrs
 = 
idx
;

63 
	}
}

66 
	$iwl_mvm_£t_deÁu…_uniˇ°_key
(
õì80211_hw
 *
hw
,

67 
õì80211_vif
 *
vif
, 
idx
)

69 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

71 
mvmvif
->
tx_key_idx
 = 
idx
;

72 
	}
}

74 
	$iwl_mvm_c⁄vît_p1k
(
u16
 *
p1k
, 
__À16
 *
out
)

76 
i
;

78 
i
 = 0; i < 
IWL_P1K_SIZE
; i++)

79 
out
[
i
] = 
	`˝u_to_À16
(
p1k
[i]);

80 
	}
}

82 c⁄° 
u8
 *
	$iwl_mvm_föd_max_≤
(
õì80211_key_c⁄f
 *
key
,

83 
iwl_mvm_key_≤
 *
±k_≤
,

84 
õì80211_key_£q
 *
£q
,

85 
tid
, 
queues
)

87 c⁄° 
u8
 *
ªt
 = 
£q
->
ccmp
.
≤
;

88 
i
;

91 
	`õì80211_gë_key_rx_£q
(
key
, 
tid
, 
£q
);

94 
i
 = 1; i < 
queues
; i++) {

95 c⁄° 
u8
 *
tmp
 = 
±k_≤
->
q
[
i
].
≤
[
tid
];

97 i‡(
	`memcmp
(
ªt
, 
tmp
, 
IEEE80211_CCMP_PN_LEN
) <= 0)

98 
ªt
 = 
tmp
;

101  
ªt
;

102 
	}
}

104 
	swowœn_key_ª¥ogøm_d©a
 {

105 
boﬁ
 
	mîr‹
;

106 
	mwï_key_idx
;

109 
	$iwl_mvm_wowœn_¥ogøm_keys
(
õì80211_hw
 *
hw
,

110 
õì80211_vif
 *
vif
,

111 
õì80211_°a
 *
°a
,

112 
õì80211_key_c⁄f
 *
key
,

113 *
_d©a
)

115 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

116 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

117 
wowœn_key_ª¥ogøm_d©a
 *
d©a
 = 
_d©a
;

118 
ªt
;

120 
key
->
cùhî
) {

121 
WLAN_CIPHER_SUITE_WEP40
:

122 
WLAN_CIPHER_SUITE_WEP104
: {

124 
iwl_mvm_wï_key_cmd
 
wï_key_cmd
;

125 
iwl_mvm_wï_key
 
wï_key
;

126 } 
__∑cked
 
wkc
 = {

127 .
wï_key_cmd
.
mac_id_n_cﬁ‹
 =

128 
	`˝u_to_À32
(
	`FW_CMD_ID_AND_COLOR
(
mvmvif
->
id
,

129 
mvmvif
->
cﬁ‹
)),

130 .
wï_key_cmd
.
num_keys
 = 1,

132 .
wï_key_cmd
.
de¸y±i⁄_ty≥
 = 
STA_KEY_FLG_WEP
,

133 .
wï_key
.
key_ödex
 = 
key
->
keyidx
,

134 .
wï_key
.
key_size
 = 
key
->
keyÀn
,

142 i‡(
key
->
Êags
 & 
IEEE80211_KEY_FLAG_PAIRWISE
)

145 
	`mem˝y
(&
wkc
.
wï_key
.
key
[3], key->key, key->
keyÀn
);

146 i‡(
key
->
keyidx
 =
mvmvif
->
tx_key_idx
) {

148 
wkc
.
wï_key
.
key_off£t
 = 0;

151 
d©a
->
wï_key_idx
++;

152 
wkc
.
wï_key
.
key_off£t
 = 
d©a
->
wï_key_idx
;

155 
	`muãx_lock
(&
mvm
->
muãx
);

156 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
WEP_KEY
, 0, (
wkc
), &wkc);

157 
d©a
->
îr‹
 = 
ªt
 != 0;

159 
mvm
->
±k_ivÀn
 = 
key
->
iv_Àn
;

160 
mvm
->
±k_icvÀn
 = 
key
->
icv_Àn
;

161 
mvm
->
gtk_ivÀn
 = 
key
->
iv_Àn
;

162 
mvm
->
gtk_icvÀn
 = 
key
->
icv_Àn
;

163 
	`muãx_u∆ock
(&
mvm
->
muãx
);

169 
d©a
->
îr‹
 = 
åue
;

171 
WLAN_CIPHER_SUITE_BIP_GMAC_256
:

172 
WLAN_CIPHER_SUITE_BIP_GMAC_128
:

174 
WLAN_CIPHER_SUITE_AES_CMAC
:

183 
WLAN_CIPHER_SUITE_TKIP
:

184 
WLAN_CIPHER_SUITE_CCMP
:

185 
WLAN_CIPHER_SUITE_GCMP
:

186 
WLAN_CIPHER_SUITE_GCMP_256
:

190 
	`muãx_lock
(&
mvm
->
muãx
);

195 i‡(
key
->
Êags
 & 
IEEE80211_KEY_FLAG_PAIRWISE
) {

196 
mvm
->
±k_ivÀn
 = 
key
->
iv_Àn
;

197 
mvm
->
±k_icvÀn
 = 
key
->
icv_Àn
;

198 
ªt
 = 
	`iwl_mvm_£t_°a_key
(
mvm
, 
vif
, 
°a
, 
key
, 0);

206 
mvm
->
gtk_ivÀn
 = 
key
->
iv_Àn
;

207 
mvm
->
gtk_icvÀn
 = 
key
->
icv_Àn
;

208 
ªt
 = 
	`iwl_mvm_£t_°a_key
(
mvm
, 
vif
, 
°a
, 
key
, 1);

210 
	`muãx_u∆ock
(&
mvm
->
muãx
);

211 
d©a
->
îr‹
 = 
ªt
 != 0;

212 
	}
}

214 
	swowœn_key_rsc_tsc_d©a
 {

215 
iwl_wowœn_rsc_tsc_∑øms_cmd_v4
 *
	mrsc_tsc
;

216 
boﬁ
 
	mhave_rsc_tsc
;

219 
	$iwl_mvm_wowœn_gë_rsc_tsc_d©a
(
õì80211_hw
 *
hw
,

220 
õì80211_vif
 *
vif
,

221 
õì80211_°a
 *
°a
,

222 
õì80211_key_c⁄f
 *
key
,

223 *
_d©a
)

225 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

226 
wowœn_key_rsc_tsc_d©a
 *
d©a
 = 
_d©a
;

227 
´s_sc
 *aes_sc;

228 
tkù_sc
 *tkù_sc, *
tkù_tx_sc
 = 
NULL
;

229 
õì80211_key_£q
 
£q
;

230 
i
;

232 
key
->
cùhî
) {

235 
WLAN_CIPHER_SUITE_TKIP
:

236 i‡(
°a
) {

237 
u64
 
≤64
;

239 
tkù_sc
 =

240 
d©a
->
rsc_tsc
->
∑øms
.
Æl_tsc_rsc
.
tkù
.
uniˇ°_rsc
;

241 
tkù_tx_sc
 =

242 &
d©a
->
rsc_tsc
->
∑øms
.
Æl_tsc_rsc
.
tkù
.
tsc
;

244 
≤64
 = 
	`©omic64_ªad
(&
key
->
tx_≤
);

245 
tkù_tx_sc
->
iv16
 = 
	`˝u_to_À16
(
	`TKIP_PN_TO_IV16
(
≤64
));

246 
tkù_tx_sc
->
iv32
 = 
	`˝u_to_À32
(
	`TKIP_PN_TO_IV32
(
≤64
));

248 
tkù_sc
 =

249 
d©a
->
rsc_tsc
->
∑øms
.
Æl_tsc_rsc
.
tkù
.
mu…iˇ°_rsc
;

257 
i
 = 0; i < 
IWL_NUM_RSC
; i++) {

258 
	`õì80211_gë_key_rx_£q
(
key
, 
i
, &
£q
);

259 
tkù_sc
[
i
].
iv16
 = 
	`˝u_to_À16
(
£q
.
tkù
.iv16);

260 
tkù_sc
[
i
].
iv32
 = 
	`˝u_to_À32
(
£q
.
tkù
.iv32);

263 
d©a
->
have_rsc_tsc
 = 
åue
;

265 
WLAN_CIPHER_SUITE_CCMP
:

266 
WLAN_CIPHER_SUITE_GCMP
:

267 
WLAN_CIPHER_SUITE_GCMP_256
:

268 i‡(
°a
) {

269 
´s_sc
 *
´s_tx_sc
;

270 
u64
 
≤64
;

272 
´s_sc
 =

273 
d©a
->
rsc_tsc
->
∑øms
.
Æl_tsc_rsc
.
´s
.
uniˇ°_rsc
;

274 
´s_tx_sc
 =

275 &
d©a
->
rsc_tsc
->
∑øms
.
Æl_tsc_rsc
.
´s
.
tsc
;

277 
≤64
 = 
	`©omic64_ªad
(&
key
->
tx_≤
);

278 
´s_tx_sc
->
≤
 = 
	`˝u_to_À64
(
≤64
);

280 
´s_sc
 =

281 
d©a
->
rsc_tsc
->
∑øms
.
Æl_tsc_rsc
.
´s
.
mu…iˇ°_rsc
;

288 i‡(
°a
 && 
	`iwl_mvm_has_√w_rx_≠i
(
mvm
)) {

289 
iwl_mvm_°a
 *
mvm°a
;

290 
iwl_mvm_key_≤
 *
±k_≤
;

291 c⁄° 
u8
 *
≤
;

293 
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

294 
	`rcu_ªad_lock
();

295 
±k_≤
 = 
	`rcu_dîe„ªn˚
(
mvm°a
->±k_≤[
key
->
keyidx
]);

296 i‡(
	`WARN_ON
(!
±k_≤
)) {

297 
	`rcu_ªad_u∆ock
();

301 
i
 = 0; i < 
IWL_MAX_TID_COUNT
; i++) {

302 
≤
 = 
	`iwl_mvm_föd_max_≤
(
key
, 
±k_≤
, &
£q
, 
i
,

303 
mvm
->
å™s
->
num_rx_queues
);

304 
´s_sc
[
i
].
≤
 = 
	`˝u_to_À64
((
u64
)pn[5] |

305 ((
u64
)
≤
[4] << 8) |

306 ((
u64
)
≤
[3] << 16) |

307 ((
u64
)
≤
[2] << 24) |

308 ((
u64
)
≤
[1] << 32) |

309 ((
u64
)
≤
[0] << 40));

312 
	`rcu_ªad_u∆ock
();

314 
i
 = 0; i < 
IWL_NUM_RSC
; i++) {

315 
u8
 *
≤
 = 
£q
.
ccmp
.pn;

317 
	`õì80211_gë_key_rx_£q
(
key
, 
i
, &
£q
);

318 
´s_sc
[
i
].
≤
 = 
	`˝u_to_À64
((
u64
)pn[5] |

319 ((
u64
)
≤
[4] << 8) |

320 ((
u64
)
≤
[3] << 16) |

321 ((
u64
)
≤
[2] << 24) |

322 ((
u64
)
≤
[1] << 32) |

323 ((
u64
)
≤
[0] << 40));

326 
d©a
->
have_rsc_tsc
 = 
åue
;

329 
	}
}

331 
	swowœn_key_rsc_v5_d©a
 {

332 
iwl_wowœn_rsc_tsc_∑øms_cmd
 *
	mrsc
;

333 
boﬁ
 
	mhave_rsc
;

334 
	mgtks
;

335 
	mgtk_ids
[4];

338 
	$iwl_mvm_wowœn_gë_rsc_v5_d©a
(
õì80211_hw
 *
hw
,

339 
õì80211_vif
 *
vif
,

340 
õì80211_°a
 *
°a
,

341 
õì80211_key_c⁄f
 *
key
,

342 *
_d©a
)

344 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

345 
wowœn_key_rsc_v5_d©a
 *
d©a
 = 
_d©a
;

346 
õì80211_key_£q
 
£q
;

347 
__À64
 *
rsc
;

348 
i
;

351 
key
->
cùhî
) {

354 
WLAN_CIPHER_SUITE_TKIP
:

355 
WLAN_CIPHER_SUITE_CCMP
:

356 
WLAN_CIPHER_SUITE_GCMP
:

357 
WLAN_CIPHER_SUITE_GCMP_256
:

361 i‡(
°a
) {

362 
rsc
 = 
d©a
->rsc->
uˇ°_rsc
;

364 i‡(
	`WARN_ON
(
d©a
->
gtks
 >
	`ARRAY_SIZE
(d©a->
gtk_ids
)))

366 
d©a
->
gtk_ids
[d©a->
gtks
] = 
key
->
keyidx
;

367 
rsc
 = 
d©a
->rsc->
mˇ°_rsc
[d©a->
gtks
 % 2];

368 i‡(
	`WARN_ON
(
key
->
keyidx
 >=

369 
	`ARRAY_SIZE
(
d©a
->
rsc
->
mˇ°_key_id_m≠
)))

371 
d©a
->
rsc
->
mˇ°_key_id_m≠
[
key
->
keyidx
] = d©a->
gtks
 % 2;

372 i‡(
d©a
->
gtks
 >= 2) {

373 
¥ev
 = 
d©a
->
gtks
 - 2;

374 
¥ev_idx
 = 
d©a
->
gtk_ids
[
¥ev
];

376 
d©a
->
rsc
->
mˇ°_key_id_m≠
[
¥ev_idx
] =

377 
IWL_MCAST_KEY_MAP_INVALID
;

379 
d©a
->
gtks
++;

382 
key
->
cùhî
) {

384 
	`WARN_ON
(1);

386 
WLAN_CIPHER_SUITE_TKIP
:

393 
i
 = 0; i < 
IWL_MAX_TID_COUNT
; i++) {

394 
	`õì80211_gë_key_rx_£q
(
key
, 
i
, &
£q
);

396 
rsc
[
i
] = 
	`˝u_to_À64
(((
u64
)
£q
.
tkù
.
iv32
 << 16) |

397 
£q
.
tkù
.
iv16
);

400 
d©a
->
have_rsc
 = 
åue
;

402 
WLAN_CIPHER_SUITE_CCMP
:

403 
WLAN_CIPHER_SUITE_GCMP
:

404 
WLAN_CIPHER_SUITE_GCMP_256
:

409 i‡(
°a
) {

410 
iwl_mvm_°a
 *
mvm°a
;

411 
iwl_mvm_key_≤
 *
±k_≤
;

412 c⁄° 
u8
 *
≤
;

414 
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

415 
	`rcu_ªad_lock
();

416 
±k_≤
 = 
	`rcu_dîe„ªn˚
(
mvm°a
->±k_≤[
key
->
keyidx
]);

417 i‡(
	`WARN_ON
(!
±k_≤
)) {

418 
	`rcu_ªad_u∆ock
();

422 
i
 = 0; i < 
IWL_MAX_TID_COUNT
; i++) {

423 
≤
 = 
	`iwl_mvm_föd_max_≤
(
key
, 
±k_≤
, &
£q
, 
i
,

424 
mvm
->
å™s
->
num_rx_queues
);

425 
rsc
[
i
] = 
	`˝u_to_À64
((
u64
)
≤
[5] |

426 ((
u64
)
≤
[4] << 8) |

427 ((
u64
)
≤
[3] << 16) |

428 ((
u64
)
≤
[2] << 24) |

429 ((
u64
)
≤
[1] << 32) |

430 ((
u64
)
≤
[0] << 40));

433 
	`rcu_ªad_u∆ock
();

435 
i
 = 0; i < 
IWL_MAX_TID_COUNT
; i++) {

436 
u8
 *
≤
 = 
£q
.
ccmp
.pn;

438 
	`õì80211_gë_key_rx_£q
(
key
, 
i
, &
£q
);

439 
rsc
[
i
] = 
	`˝u_to_À64
((
u64
)
≤
[5] |

440 ((
u64
)
≤
[4] << 8) |

441 ((
u64
)
≤
[3] << 16) |

442 ((
u64
)
≤
[2] << 24) |

443 ((
u64
)
≤
[1] << 32) |

444 ((
u64
)
≤
[0] << 40));

447 
d©a
->
have_rsc
 = 
åue
;

450 
	}
}

452 
	$iwl_mvm_wowœn_c⁄fig_rsc_tsc
(
iwl_mvm
 *
mvm
,

453 
õì80211_vif
 *
vif
,

454 
iwl_mvm_vif_lök_öfo
 *
mvm_lök
)

456 
vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
WOWLAN_TSC_RSC_PARAM
,

457 
IWL_FW_CMD_VER_UNKNOWN
);

458 
ªt
;

460 i‡(
vî
 == 5) {

461 
wowœn_key_rsc_v5_d©a
 
d©a
 = {};

462 
i
;

464 
d©a
.
rsc
 = 
	`kzÆloc
((*d©a.rsc), 
GFP_KERNEL
);

465 i‡(!
d©a
.
rsc
)

466  -
ENOMEM
;

468 
i
 = 0; i < 
	`ARRAY_SIZE
(
d©a
.
rsc
->
mˇ°_key_id_m≠
); i++)

469 
d©a
.
rsc
->
mˇ°_key_id_m≠
[
i
] =

470 
IWL_MCAST_KEY_MAP_INVALID
;

471 
d©a
.
rsc
->
°a_id
 = 
	`˝u_to_À32
(
mvm_lök
->
≠_°a_id
);

473 
	`õì80211_ôî_keys
(
mvm
->
hw
, 
vif
,

474 
iwl_mvm_wowœn_gë_rsc_v5_d©a
,

475 &
d©a
);

477 i‡(
d©a
.
have_rsc
)

478 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
WOWLAN_TSC_RSC_PARAM
,

479 
CMD_ASYNC
, (*
d©a
.
rsc
),

480 
d©a
.
rsc
);

482 
ªt
 = 0;

483 
	`k‰ì
(
d©a
.
rsc
);

484 } i‡(
vî
 =4 || vî =2 || vî =
IWL_FW_CMD_VER_UNKNOWN
) {

485 
wowœn_key_rsc_tsc_d©a
 
d©a
 = {};

486 
size
;

488 
d©a
.
rsc_tsc
 = 
	`kzÆloc
((*d©a.rsc_tsc), 
GFP_KERNEL
);

489 i‡(!
d©a
.
rsc_tsc
)

490  -
ENOMEM
;

492 i‡(
vî
 == 4) {

493 
size
 = (*
d©a
.
rsc_tsc
);

494 
d©a
.
rsc_tsc
->
°a_id
 =

495 
	`˝u_to_À32
(
mvm_lök
->
≠_°a_id
);

498 
size
 = (
d©a
.
rsc_tsc
->
∑øms
);

501 
	`õì80211_ôî_keys
(
mvm
->
hw
, 
vif
,

502 
iwl_mvm_wowœn_gë_rsc_tsc_d©a
,

503 &
d©a
);

505 i‡(
d©a
.
have_rsc_tsc
)

506 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
WOWLAN_TSC_RSC_PARAM
,

507 
CMD_ASYNC
, 
size
,

508 
d©a
.
rsc_tsc
);

510 
ªt
 = 0;

511 
	`k‰ì
(
d©a
.
rsc_tsc
);

513 
ªt
 = 0;

514 
	`WARN_ON_ONCE
(1);

517  
ªt
;

518 
	}
}

520 
	swowœn_key_tkù_d©a
 {

521 
iwl_wowœn_tkù_∑øms_cmd
 
	mtkù
;

522 
boﬁ
 
	mhave_tkù_keys
;

525 
	$iwl_mvm_wowœn_gë_tkù_d©a
(
õì80211_hw
 *
hw
,

526 
õì80211_vif
 *
vif
,

527 
õì80211_°a
 *
°a
,

528 
õì80211_key_c⁄f
 *
key
,

529 *
_d©a
)

531 
wowœn_key_tkù_d©a
 *
d©a
 = 
_d©a
;

532 
iwl_p1k_ˇche
 *
rx_p1ks
;

533 
u8
 *
rx_mic_key
;

534 
õì80211_key_£q
 
£q
;

535 
u32
 
cur_rx_iv32
 = 0;

536 
u16
 
p1k
[
IWL_P1K_SIZE
];

537 
i
;

539 
key
->
cùhî
) {

542 
WLAN_CIPHER_SUITE_TKIP
:

543 i‡(
°a
) {

544 
u64
 
≤64
;

546 
rx_p1ks
 = 
d©a
->
tkù
.
rx_uni
;

548 
≤64
 = 
	`©omic64_ªad
(&
key
->
tx_≤
);

550 
	`õì80211_gë_tkù_p1k_iv
(
key
, 
	`TKIP_PN_TO_IV32
(
≤64
),

551 
p1k
);

552 
	`iwl_mvm_c⁄vît_p1k
(
p1k
, 
d©a
->
tkù
.
tx
.p1k);

554 
	`mem˝y
(
d©a
->
tkù
.
mic_keys
.
tx
,

555 &
key
->key[
NL80211_TKIP_DATA_OFFSET_TX_MIC_KEY
],

556 
IWL_MIC_KEY_SIZE
);

558 
rx_mic_key
 = 
d©a
->
tkù
.
mic_keys
.
rx_uniˇ°
;

560 
rx_p1ks
 = 
d©a
->
tkù
.
rx_mu…i
;

561 
rx_mic_key
 = 
d©a
->
tkù
.
mic_keys
.
rx_mˇ°
;

564 
i
 = 0; i < 
IWL_NUM_RSC
; i++) {

565 
	`õì80211_gë_key_rx_£q
(
key
, 
i
, &
£q
);

567 i‡(
£q
.
tkù
.
iv32
 > 
cur_rx_iv32
)

568 
cur_rx_iv32
 = 
£q
.
tkù
.
iv32
;

571 
	`õì80211_gë_tkù_rx_p1k
(
key
, 
vif
->
bss_c⁄f
.
bssid
,

572 
cur_rx_iv32
, 
p1k
);

573 
	`iwl_mvm_c⁄vît_p1k
(
p1k
, 
rx_p1ks
[0].p1k);

574 
	`õì80211_gë_tkù_rx_p1k
(
key
, 
vif
->
bss_c⁄f
.
bssid
,

575 
cur_rx_iv32
 + 1, 
p1k
);

576 
	`iwl_mvm_c⁄vît_p1k
(
p1k
, 
rx_p1ks
[1].p1k);

578 
	`mem˝y
(
rx_mic_key
,

579 &
key
->key[
NL80211_TKIP_DATA_OFFSET_RX_MIC_KEY
],

580 
IWL_MIC_KEY_SIZE
);

582 
d©a
->
have_tkù_keys
 = 
åue
;

585 
	}
}

587 
	swowœn_key_gtk_ty≥_ôî
 {

588 
iwl_wowœn_kek_kck_m©îül_cmd_v4
 *
	mkek_kck_cmd
;

591 
	$iwl_mvm_wowœn_gtk_ty≥_ôî
(
õì80211_hw
 *
hw
,

592 
õì80211_vif
 *
vif
,

593 
õì80211_°a
 *
°a
,

594 
õì80211_key_c⁄f
 *
key
,

595 *
_d©a
)

597 
wowœn_key_gtk_ty≥_ôî
 *
d©a
 = 
_d©a
;

599 
key
->
cùhî
) {

602 
WLAN_CIPHER_SUITE_TKIP
:

603 i‡(!
°a
)

604 
d©a
->
kek_kck_cmd
->
gtk_cùhî
 =

605 
	`˝u_to_À32
(
STA_KEY_FLG_TKIP
);

607 
WLAN_CIPHER_SUITE_BIP_GMAC_256
:

608 
WLAN_CIPHER_SUITE_BIP_GMAC_128
:

609 
d©a
->
kek_kck_cmd
->
igtk_cùhî
 = 
	`˝u_to_À32
(
STA_KEY_FLG_GCMP
);

611 
WLAN_CIPHER_SUITE_AES_CMAC
:

612 
d©a
->
kek_kck_cmd
->
igtk_cùhî
 = 
	`˝u_to_À32
(
STA_KEY_FLG_CCM
);

614 
WLAN_CIPHER_SUITE_CCMP
:

615 i‡(!
°a
)

616 
d©a
->
kek_kck_cmd
->
gtk_cùhî
 =

617 
	`˝u_to_À32
(
STA_KEY_FLG_CCM
);

619 
WLAN_CIPHER_SUITE_GCMP
:

620 
WLAN_CIPHER_SUITE_GCMP_256
:

621 i‡(!
°a
)

622 
d©a
->
kek_kck_cmd
->
gtk_cùhî
 =

623 
	`˝u_to_À32
(
STA_KEY_FLG_GCMP
);

626 
	}
}

628 
	$iwl_mvm_£nd_∑âîns_v1
(
iwl_mvm
 *
mvm
,

629 
cfg80211_wowœn
 *
wowœn
)

631 
iwl_wowœn_∑âîns_cmd_v1
 *
∑âîn_cmd
;

632 
iwl_ho°_cmd
 
cmd
 = {

633 .
id
 = 
WOWLAN_PATTERNS
,

634 .
d©aÊags
[0] = 
IWL_HCMD_DFL_NOCOPY
,

636 
i
, 
îr
;

638 i‡(!
wowœn
->
n_∑âîns
)

641 
cmd
.
Àn
[0] = 
	`°ru˘_size
(
∑âîn_cmd
, 
∑âîns
, 
wowœn
->
n_∑âîns
);

643 
∑âîn_cmd
 = 
	`kmÆloc
(
cmd
.
Àn
[0], 
GFP_KERNEL
);

644 i‡(!
∑âîn_cmd
)

645  -
ENOMEM
;

647 
∑âîn_cmd
->
n_∑âîns
 = 
	`˝u_to_À32
(
wowœn
->n_patterns);

649 
i
 = 0; i < 
wowœn
->
n_∑âîns
; i++) {

650 
mask_Àn
 = 
	`DIV_ROUND_UP
(
wowœn
->
∑âîns
[
i
].
∑âîn_Àn
, 8);

652 
	`mem˝y
(&
∑âîn_cmd
->
∑âîns
[
i
].
mask
,

653 
wowœn
->
∑âîns
[
i
].
mask
, 
mask_Àn
);

654 
	`mem˝y
(&
∑âîn_cmd
->
∑âîns
[
i
].
∑âîn
,

655 
wowœn
->
∑âîns
[
i
].
∑âîn
,

656 
wowœn
->
∑âîns
[
i
].
∑âîn_Àn
);

657 
∑âîn_cmd
->
∑âîns
[
i
].
mask_size
 = 
mask_Àn
;

658 
∑âîn_cmd
->
∑âîns
[
i
].
∑âîn_size
 =

659 
wowœn
->
∑âîns
[
i
].
∑âîn_Àn
;

662 
cmd
.
d©a
[0] = 
∑âîn_cmd
;

663 
îr
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
cmd
);

664 
	`k‰ì
(
∑âîn_cmd
);

665  
îr
;

666 
	}
}

668 
	$iwl_mvm_£nd_∑âîns
(
iwl_mvm
 *
mvm
,

669 
iwl_mvm_vif_lök_öfo
 *
mvm_lök
,

670 
cfg80211_wowœn
 *
wowœn
)

672 
iwl_wowœn_∑âîns_cmd
 *
∑âîn_cmd
;

673 
iwl_ho°_cmd
 
cmd
 = {

674 .
id
 = 
WOWLAN_PATTERNS
,

675 .
d©aÊags
[0] = 
IWL_HCMD_DFL_NOCOPY
,

677 
i
, 
îr
;

678 
vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
cmd
.
id
,

679 
IWL_FW_CMD_VER_UNKNOWN
);

681 i‡(!
wowœn
->
n_∑âîns
)

684 
cmd
.
Àn
[0] = (*
∑âîn_cmd
) +

685 
wowœn
->
n_∑âîns
 * (
iwl_wowœn_∑âîn_v2
);

687 
∑âîn_cmd
 = 
	`kzÆloc
(
cmd
.
Àn
[0], 
GFP_KERNEL
);

688 i‡(!
∑âîn_cmd
)

689  -
ENOMEM
;

691 
∑âîn_cmd
->
n_∑âîns
 = 
wowœn
->n_patterns;

692 i‡(
vî
 >= 3)

693 
∑âîn_cmd
->
°a_id
 = 
mvm_lök
->
≠_°a_id
;

695 
i
 = 0; i < 
wowœn
->
n_∑âîns
; i++) {

696 
mask_Àn
 = 
	`DIV_ROUND_UP
(
wowœn
->
∑âîns
[
i
].
∑âîn_Àn
, 8);

698 
∑âîn_cmd
->
∑âîns
[
i
].
∑âîn_ty≥
 =

699 
WOWLAN_PATTERN_TYPE_BITMASK
;

701 
	`mem˝y
(&
∑âîn_cmd
->
∑âîns
[
i
].
u
.
bômask
.
mask
,

702 
wowœn
->
∑âîns
[
i
].
mask
, 
mask_Àn
);

703 
	`mem˝y
(&
∑âîn_cmd
->
∑âîns
[
i
].
u
.
bômask
.
∑âîn
,

704 
wowœn
->
∑âîns
[
i
].
∑âîn
,

705 
wowœn
->
∑âîns
[
i
].
∑âîn_Àn
);

706 
∑âîn_cmd
->
∑âîns
[
i
].
u
.
bômask
.
mask_size
 = 
mask_Àn
;

707 
∑âîn_cmd
->
∑âîns
[
i
].
u
.
bômask
.
∑âîn_size
 =

708 
wowœn
->
∑âîns
[
i
].
∑âîn_Àn
;

711 
cmd
.
d©a
[0] = 
∑âîn_cmd
;

712 
îr
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
cmd
);

713 
	`k‰ì
(
∑âîn_cmd
);

714  
îr
;

715 
	}
}

717 
	$iwl_mvm_d3_ª¥ogøm
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

718 
õì80211_°a
 *
≠_°a
)

720 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

721 
õì80211_ch™˘x_c⁄f
 *
˘x
;

722 
u8
 
chaös_°©ic
, 
chaös_dy«mic
;

723 
cfg80211_ch™_def
 
ch™def
, 
≠_def
;

724 
ªt
, 
i
;

725 
iwl_bödög_cmd_v1
 
bödög_cmd
 = {};

726 
iwl_time_quŸa_cmd
 
quŸa_cmd
 = {};

727 
iwl_time_quŸa_d©a
 *
quŸa
;

728 
u32
 
°©us
;

730 i‡(
	`WARN_ON_ONCE
(
	`iwl_mvm_is_cdb_suµ‹ãd
(
mvm
) ||

731 
	`õì80211_vif_is_mld
(
vif
)))

732  -
EINVAL
;

735 i‡(
	`WARN_ON
(!
mvmvif
->
deÊök
.
phy_˘xt
))

736  -
EINVAL
;

738 
	`rcu_ªad_lock
();

739 
˘x
 = 
	`rcu_dîe„ªn˚
(
vif
->
bss_c⁄f
.
ch™˘x_c⁄f
);

740 i‡(
	`WARN_ON
(!
˘x
)) {

741 
	`rcu_ªad_u∆ock
();

742  -
EINVAL
;

744 
ch™def
 = 
˘x
->
def
;

745 
≠_def
 = 
˘x
->
≠
;

746 
chaös_°©ic
 = 
˘x
->
rx_chaös_°©ic
;

747 
chaös_dy«mic
 = 
˘x
->
rx_chaös_dy«mic
;

748 
	`rcu_ªad_u∆ock
();

750 
ªt
 = 
	`iwl_mvm_phy_˘xt_add
(
mvm
, 
mvmvif
->
deÊök
.
phy_˘xt
, &
ch™def
,

751 &
≠_def
, 
chaös_°©ic
, 
chaös_dy«mic
);

752 i‡(
ªt
)

753  
ªt
;

756 
mvmvif
->
u∂ﬂded
 = 
Ál£
;

758 i‡(
	`WARN_ON
(!
vif
->
cfg
.
assoc
))

759  -
EINVAL
;

761 
ªt
 = 
	`iwl_mvm_mac_˘xt_add
(
mvm
, 
vif
);

762 i‡(
ªt
)

763  
ªt
;

766 
bödög_cmd
.
id_™d_cﬁ‹
 =

767 
	`˝u_to_À32
(
	`FW_CMD_ID_AND_COLOR
(
mvmvif
->
deÊök
.
phy_˘xt
->
id
,

768 
mvmvif
->
deÊök
.
phy_˘xt
->
cﬁ‹
));

769 
bödög_cmd
.
a˘i⁄
 = 
	`˝u_to_À32
(
FW_CTXT_ACTION_ADD
);

770 
bödög_cmd
.
phy
 =

771 
	`˝u_to_À32
(
	`FW_CMD_ID_AND_COLOR
(
mvmvif
->
deÊök
.
phy_˘xt
->
id
,

772 
mvmvif
->
deÊök
.
phy_˘xt
->
cﬁ‹
));

773 
bödög_cmd
.
macs
[0] = 
	`˝u_to_À32
(
	`FW_CMD_ID_AND_COLOR
(
mvmvif
->
id
,

774 
mvmvif
->
cﬁ‹
));

775 
i
 = 1; i < 
MAX_MACS_IN_BINDING
; i++)

776 
bödög_cmd
.
macs
[
i
] = 
	`˝u_to_À32
(
FW_CTXT_INVALID
);

778 
°©us
 = 0;

779 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu_°©us
(
mvm
, 
BINDING_CONTEXT_CMD
,

780 
IWL_BINDING_CMD_SIZE_V1
, &
bödög_cmd
,

781 &
°©us
);

782 i‡(
ªt
) {

783 
	`IWL_ERR
(
mvm
, "FaûedÅÿadd bödög: %d\n", 
ªt
);

784  
ªt
;

787 i‡(
°©us
) {

788 
	`IWL_ERR
(
mvm
, "Bödög comm™d faûed: %u\n", 
°©us
);

789  -
EIO
;

792 
ªt
 = 
	`iwl_mvm_°a_£nd_to_fw
(
mvm
, 
≠_°a
, 
Ál£
, 0);

793 i‡(
ªt
)

794  
ªt
;

795 
	`rcu_assign_poöãr
(
mvm
->
fw_id_to_mac_id
[
mvmvif
->
deÊök
.
≠_°a_id
],

796 
≠_°a
);

798 
ªt
 = 
	`iwl_mvm_mac_˘xt_ch™ged
(
mvm
, 
vif
, 
Ál£
, 
NULL
);

799 i‡(
ªt
)

800  
ªt
;

803 
quŸa
 = 
	`iwl_mvm_quŸa_cmd_gë_quŸa
(
mvm
, &
quŸa_cmd
, 0);

804 
quŸa
->
id_™d_cﬁ‹
 =

805 
	`˝u_to_À32
(
	`FW_CMD_ID_AND_COLOR
(
mvmvif
->
deÊök
.
phy_˘xt
->
id
,

806 
mvmvif
->
deÊök
.
phy_˘xt
->
cﬁ‹
));

807 
quŸa
->quŸ®
	`˝u_to_À32
(
IWL_MVM_MAX_QUOTA
);

808 
quŸa
->
max_duøti⁄
 = 
	`˝u_to_À32
(
IWL_MVM_MAX_QUOTA
);

810 
i
 = 1; i < 
MAX_BINDINGS
; i++) {

811 
quŸa
 = 
	`iwl_mvm_quŸa_cmd_gë_quŸa
(
mvm
, &
quŸa_cmd
, 
i
);

812 
quŸa
->
id_™d_cﬁ‹
 = 
	`˝u_to_À32
(
FW_CTXT_INVALID
);

815 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
TIME_QUOTA_CMD
, 0,

816 
	`iwl_mvm_quŸa_cmd_size
(
mvm
), &
quŸa_cmd
);

817 i‡(
ªt
)

818 
	`IWL_ERR
(
mvm
, "FaûedÅÿ£nd quŸa: %d\n", 
ªt
);

820 i‡(
	`iwl_mvm_is_œr_suµ‹ãd
(
mvm
Ë&& 
	`iwl_mvm_öô_fw_ªgd
(mvm, 
Ál£
))

821 
	`IWL_ERR
(
mvm
, "FailedÅo initialize D3 LAR information\n");

824 
	}
}

826 
	$iwl_mvm_gë_œ°_n⁄qos_£q
(
iwl_mvm
 *
mvm
,

827 
õì80211_vif
 *
vif
)

829 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

830 
iwl_n⁄qos_£q_quîy_cmd
 
quîy_cmd
 = {

831 .
gë_£t_Êag
 = 
	`˝u_to_À32
(
IWL_NONQOS_SEQ_GET
),

832 .
mac_id_n_cﬁ‹
 =

833 
	`˝u_to_À32
(
	`FW_CMD_ID_AND_COLOR
(
mvmvif
->
id
,

834 
mvmvif
->
cﬁ‹
)),

836 
iwl_ho°_cmd
 
cmd
 = {

837 .
id
 = 
NON_QOS_TX_COUNTER_CMD
,

838 .
Êags
 = 
CMD_WANT_SKB
,

840 
îr
;

841 
u32
 
size
;

843 
cmd
.
d©a
[0] = &
quîy_cmd
;

844 
cmd
.
Àn
[0] = (
quîy_cmd
);

846 
îr
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
cmd
);

847 i‡(
îr
)

848  
îr
;

850 
size
 = 
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
cmd
.
ª•_pkt
);

851 i‡(
size
 < (
__À16
)) {

852 
îr
 = -
EINVAL
;

854 
îr
 = 
	`À16_to_˝up
((
__À16
 *)
cmd
.
ª•_pkt
->
d©a
);

856 
îr
 = (
u16
) (err - 0x10);

859 
	`iwl_‰ì_ª•
(&
cmd
);

860  
îr
;

861 
	}
}

863 
	$iwl_mvm_£t_œ°_n⁄qos_£q
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

865 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

866 
iwl_n⁄qos_£q_quîy_cmd
 
quîy_cmd
 = {

867 .
gë_£t_Êag
 = 
	`˝u_to_À32
(
IWL_NONQOS_SEQ_SET
),

868 .
mac_id_n_cﬁ‹
 =

869 
	`˝u_to_À32
(
	`FW_CMD_ID_AND_COLOR
(
mvmvif
->
id
,

870 
mvmvif
->
cﬁ‹
)),

871 .
vÆue
 = 
	`˝u_to_À16
(
mvmvif
->
£qno
),

875 i‡(!
mvmvif
->
£qno_vÆid
)

878 
mvmvif
->
£qno_vÆid
 = 
Ál£
;

880 i‡(
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
NON_QOS_TX_COUNTER_CMD
, 0,

881 (
quîy_cmd
), &query_cmd))

882 
	`IWL_ERR
(
mvm
, "failedÅo setÇon-QoS seqno\n");

883 
	}
}

885 
	$iwl_mvm_swôch_to_d3
(
iwl_mvm
 *
mvm
)

887 
	`iwl_mvm_sˇn_°›
(
mvm
, 
IWL_MVM_SCAN_REGULAR
, 
åue
);

889 
	`iwl_mvm_°›_devi˚
(
mvm
);

900 
	`£t_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
);

903 
	`mem£t
(
mvm
->
fw_key_èbÀ
, 0, (mvm->fw_key_table));

905 
mvm
->
±k_ivÀn
 = 0;

906 
mvm
->
±k_icvÀn
 = 0;

907 
mvm
->
±k_ivÀn
 = 0;

908 
mvm
->
±k_icvÀn
 = 0;

910  
	`iwl_mvm_lﬂd_d3_fw
(
mvm
);

911 
	}
}

914 
	$iwl_mvm_gë_wowœn_c⁄fig
(
iwl_mvm
 *
mvm
,

915 
cfg80211_wowœn
 *
wowœn
,

916 
iwl_wowœn_c⁄fig_cmd
 *
wowœn_c⁄fig_cmd
,

917 
õì80211_vif
 *
vif
, 
iwl_mvm_vif
 *
mvmvif
,

918 
õì80211_°a
 *
≠_°a
)

920 
iwl_mvm_°a
 *
mvm_≠_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
≠_°a
);

924 
wowœn_c⁄fig_cmd
->
is_11n_c⁄√˘i⁄
 =

925 
≠_°a
->
deÊök
.
ht_ˇp
.
ht_suµ‹ãd
;

926 
wowœn_c⁄fig_cmd
->
Êags
 = 
ENABLE_L3_FILTERING
 |

927 
ENABLE_NBNS_FILTERING
 | 
ENABLE_DHCP_FILTERING
;

929 i‡(
≠_°a
->
mÂ
)

930 
wowœn_c⁄fig_cmd
->
Êags
 |
IS_11W_ASSOC
;

932 i‡(
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
WOWLAN_CONFIGURATION
, 0) < 6) {

934 
ªt
 = 
	`iwl_mvm_gë_œ°_n⁄qos_£q
(
mvm
, 
vif
);

936 i‡(
ªt
 < 0)

937  
ªt
;

939 
wowœn_c⁄fig_cmd
->
n⁄_qos_£q
 = 
	`˝u_to_À16
(
ªt
);

942 
	`iwl_mvm_£t_wowœn_qos_£q
(
mvm_≠_°a
, 
wowœn_c⁄fig_cmd
);

944 i‡(
wowœn
->
disc⁄√˘
)

945 
wowœn_c⁄fig_cmd
->
wakeup_fûãr
 |=

946 
	`˝u_to_À32
(
IWL_WOWLAN_WAKEUP_BEACON_MISS
 |

947 
IWL_WOWLAN_WAKEUP_LINK_CHANGE
);

948 i‡(
wowœn
->
magic_pkt
)

949 
wowœn_c⁄fig_cmd
->
wakeup_fûãr
 |=

950 
	`˝u_to_À32
(
IWL_WOWLAN_WAKEUP_MAGIC_PACKET
);

951 i‡(
wowœn
->
gtk_ªkey_Áûuª
)

952 
wowœn_c⁄fig_cmd
->
wakeup_fûãr
 |=

953 
	`˝u_to_À32
(
IWL_WOWLAN_WAKEUP_GTK_REKEY_FAIL
);

954 i‡(
wowœn
->
óp_idítôy_ªq
)

955 
wowœn_c⁄fig_cmd
->
wakeup_fûãr
 |=

956 
	`˝u_to_À32
(
IWL_WOWLAN_WAKEUP_EAP_IDENT_REQ
);

957 i‡(
wowœn
->
four_way_h™dshake
)

958 
wowœn_c⁄fig_cmd
->
wakeup_fûãr
 |=

959 
	`˝u_to_À32
(
IWL_WOWLAN_WAKEUP_4WAY_HANDSHAKE
);

960 i‡(
wowœn
->
n_∑âîns
)

961 
wowœn_c⁄fig_cmd
->
wakeup_fûãr
 |=

962 
	`˝u_to_À32
(
IWL_WOWLAN_WAKEUP_PATTERN_MATCH
);

964 i‡(
wowœn
->
rfkûl_ªÀa£
)

965 
wowœn_c⁄fig_cmd
->
wakeup_fûãr
 |=

966 
	`˝u_to_À32
(
IWL_WOWLAN_WAKEUP_RF_KILL_DEASSERT
);

968 i‡(
wowœn
->
t˝
) {

973 
wowœn_c⁄fig_cmd
->
wakeup_fûãr
 |=

974 
	`˝u_to_À32
(
IWL_WOWLAN_WAKEUP_REMOTE_LINK_LOSS
 |

975 
IWL_WOWLAN_WAKEUP_REMOTE_SIGNATURE_TABLE
 |

976 
IWL_WOWLAN_WAKEUP_REMOTE_WAKEUP_PACKET
 |

977 
IWL_WOWLAN_WAKEUP_LINK_CHANGE
);

980 i‡(
wowœn
->
™y
) {

981 
wowœn_c⁄fig_cmd
->
wakeup_fûãr
 |=

982 
	`˝u_to_À32
(
IWL_WOWLAN_WAKEUP_BEACON_MISS
 |

983 
IWL_WOWLAN_WAKEUP_LINK_CHANGE
 |

984 
IWL_WOWLAN_WAKEUP_RX_FRAME
 |

985 
IWL_WOWLAN_WAKEUP_BCN_FILTERING
);

989 
	}
}

991 
	$iwl_mvm_wowœn_c⁄fig_key_∑øms
(
iwl_mvm
 *
mvm
,

992 
õì80211_vif
 *
vif
,

993 
iwl_mvm_vif_lök_öfo
 *
mvm_lök
)

995 
boﬁ
 
unifõd
 = 
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

996 
IWL_UCODE_TLV_CAPA_CNSLDTD_D3_D0_IMG
);

997 
wowœn_key_ª¥ogøm_d©a
 
key_d©a
 = {};

998 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

999 
ªt
;

1000 
u8
 
cmd_vî
;

1001 
size_t
 
cmd_size
;

1003 i‡(!
unifõd
) {

1015 
	`õì80211_ôî_keys
(
mvm
->
hw
, 
vif
, 
iwl_mvm_wowœn_¥ogøm_keys
,

1016 &
key_d©a
);

1018 i‡(
key_d©a
.
îr‹
)

1019  -
EIO
;

1022 
ªt
 = 
	`iwl_mvm_wowœn_c⁄fig_rsc_tsc
(
mvm
, 
vif
, 
mvm_lök
);

1023 i‡(
ªt
)

1024  
ªt
;

1026 i‡(!
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

1027 
IWL_UCODE_TLV_API_TKIP_MIC_KEYS
)) {

1028 
vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
WOWLAN_TKIP_PARAM
,

1029 
IWL_FW_CMD_VER_UNKNOWN
);

1030 
wowœn_key_tkù_d©a
 
tkù_d©a
 = {};

1031 
size
;

1033 i‡(
vî
 == 2) {

1034 
size
 = (
tkù_d©a
.
tkù
);

1035 
tkù_d©a
.
tkù
.
°a_id
 =

1036 
	`˝u_to_À32
(
mvm_lök
->
≠_°a_id
);

1037 } i‡(
vî
 =1 || vî =
IWL_FW_CMD_VER_UNKNOWN
) {

1038 
size
 = (
iwl_wowœn_tkù_∑øms_cmd_vî_1
);

1040 
	`WARN_ON_ONCE
(1);

1041  -
EINVAL
;

1044 
	`õì80211_ôî_keys
(
mvm
->
hw
, 
vif
, 
iwl_mvm_wowœn_gë_tkù_d©a
,

1045 &
tkù_d©a
);

1047 i‡(
tkù_d©a
.
have_tkù_keys
) {

1049 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
,

1050 
WOWLAN_TKIP_PARAM
,

1051 
CMD_ASYNC
, 
size
,

1052 &
tkù_d©a
.
tkù
);

1053 i‡(
ªt
)

1054  
ªt
;

1059 i‡(
mvmvif
->
ªkey_d©a
.
vÆid
) {

1060 
iwl_wowœn_kek_kck_m©îül_cmd_v4
 
kek_kck_cmd
 = {};

1061 
iwl_wowœn_kek_kck_m©îül_cmd_v4
 *
_kek_kck_cmd
 =

1062 &
kek_kck_cmd
;

1063 
wowœn_key_gtk_ty≥_ôî
 
gtk_ty≥_d©a
 = {

1064 .
kek_kck_cmd
 = 
_kek_kck_cmd
,

1067 
cmd_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
,

1068 
WOWLAN_KEK_KCK_MATERIAL
,

1069 
IWL_FW_CMD_VER_UNKNOWN
);

1070 i‡(
	`WARN_ON
(
cmd_vî
 != 2 && cmd_ver != 3 && cmd_ver != 4 &&

1071 
cmd_vî
 !
IWL_FW_CMD_VER_UNKNOWN
))

1072  -
EINVAL
;

1074 
	`õì80211_ôî_keys
(
mvm
->
hw
, 
vif
, 
iwl_mvm_wowœn_gtk_ty≥_ôî
,

1075 &
gtk_ty≥_d©a
);

1077 
	`mem˝y
(
kek_kck_cmd
.
kck
, 
mvmvif
->
ªkey_d©a
.kck,

1078 
mvmvif
->
ªkey_d©a
.
kck_Àn
);

1079 
kek_kck_cmd
.
kck_Àn
 = 
	`˝u_to_À16
(
mvmvif
->
ªkey_d©a
.kck_len);

1080 
	`mem˝y
(
kek_kck_cmd
.
kek
, 
mvmvif
->
ªkey_d©a
.kek,

1081 
mvmvif
->
ªkey_d©a
.
kek_Àn
);

1082 
kek_kck_cmd
.
kek_Àn
 = 
	`˝u_to_À16
(
mvmvif
->
ªkey_d©a
.kek_len);

1083 
kek_kck_cmd
.
ª∂ay_˘r
 = 
mvmvif
->
ªkey_d©a
.replay_ctr;

1084 
kek_kck_cmd
.
akm
 = 
	`˝u_to_À32
(
mvmvif
->
ªkey_d©a
.akm);

1085 
kek_kck_cmd
.
°a_id
 = 
	`˝u_to_À32
(
mvm_lök
->
≠_°a_id
);

1087 i‡(
cmd_vî
 == 4) {

1088 
cmd_size
 = (
iwl_wowœn_kek_kck_m©îül_cmd_v4
);

1090 i‡(
cmd_vî
 == 3)

1091 
cmd_size
 =

1092 (
iwl_wowœn_kek_kck_m©îül_cmd_v3
);

1094 
cmd_size
 =

1095 (
iwl_wowœn_kek_kck_m©îül_cmd_v2
);

1097 
_kek_kck_cmd
 = (*)

1098 ((
u8
 *)
_kek_kck_cmd
 + (
kek_kck_cmd
.
°a_id
));

1101 
	`IWL_DEBUG_WOWLAN
(
mvm
, "settingákm %d\n",

1102 
mvmvif
->
ªkey_d©a
.
akm
);

1104 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
WOWLAN_KEK_KCK_MATERIAL
,

1105 
CMD_ASYNC
, 
cmd_size
, 
_kek_kck_cmd
);

1106 i‡(
ªt
)

1107  
ªt
;

1111 
	}
}

1114 
	$iwl_mvm_wowœn_c⁄fig
(
iwl_mvm
 *
mvm
,

1115 
cfg80211_wowœn
 *
wowœn
,

1116 
iwl_wowœn_c⁄fig_cmd
 *
wowœn_c⁄fig_cmd
,

1117 
õì80211_vif
 *
vif
, 
iwl_mvm_vif
 *
mvmvif
,

1118 
iwl_mvm_vif_lök_öfo
 *
mvm_lök
,

1119 
õì80211_°a
 *
≠_°a
)

1121 
ªt
;

1122 
boﬁ
 
unifõd_image
 = 
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

1123 
IWL_UCODE_TLV_CAPA_CNSLDTD_D3_D0_IMG
);

1125 
mvm
->
ofÊﬂd_tid
 = 
wowœn_c⁄fig_cmd
->
ofÊﬂdög_tid
;

1127 i‡(!
unifõd_image
) {

1128 
ªt
 = 
	`iwl_mvm_swôch_to_d3
(
mvm
);

1129 i‡(
ªt
)

1130  
ªt
;

1132 
ªt
 = 
	`iwl_mvm_d3_ª¥ogøm
(
mvm
, 
vif
, 
≠_°a
);

1133 i‡(
ªt
)

1134  
ªt
;

1137 
ªt
 = 
	`iwl_mvm_wowœn_c⁄fig_key_∑øms
(
mvm
, 
vif
, 
mvm_lök
);

1138 i‡(
ªt
)

1139  
ªt
;

1141 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
WOWLAN_CONFIGURATION
, 0,

1142 (*
wowœn_c⁄fig_cmd
),

1143 
wowœn_c⁄fig_cmd
);

1144 i‡(
ªt
)

1145  
ªt
;

1147 i‡(
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

1148 
IWL_UCODE_TLV_API_WOWLAN_TCP_SYN_WAKE
))

1149 
ªt
 = 
	`iwl_mvm_£nd_∑âîns
(
mvm
, 
mvm_lök
, 
wowœn
);

1151 
ªt
 = 
	`iwl_mvm_£nd_∑âîns_v1
(
mvm
, 
wowœn
);

1152 i‡(
ªt
)

1153  
ªt
;

1155  
	`iwl_mvm_£nd_¥Ÿo_ofÊﬂd
(
mvm
, 
vif
, 
Ál£
, 
åue
, 0);

1156 
	}
}

1159 
	$iwl_mvm_√tdëe˘_c⁄fig
(
iwl_mvm
 *
mvm
,

1160 
cfg80211_wowœn
 *
wowœn
,

1161 
cfg80211_sched_sˇn_ªque°
 *
nd_c⁄fig
,

1162 
õì80211_vif
 *
vif
)

1164 
ªt
;

1165 
boﬁ
 
unifõd_image
 = 
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

1166 
IWL_UCODE_TLV_CAPA_CNSLDTD_D3_D0_IMG
);

1168 i‡(!
unifõd_image
) {

1169 
ªt
 = 
	`iwl_mvm_swôch_to_d3
(
mvm
);

1170 i‡(
ªt
)

1171  
ªt
;

1178 
ªt
 = 
	`iwl_mvm_sˇn_°›
(
mvm
, 
IWL_MVM_SCAN_SCHED
, 
åue
);

1179 i‡(
ªt
)

1180  
ªt
;

1183 
ªt
 = 
	`iwl_mvm_sched_sˇn_°¨t
(
mvm
, 
vif
, 
nd_c⁄fig
, &mvm->
nd_õs
,

1184 
IWL_MVM_SCAN_NETDETECT
);

1185 i‡(
ªt
)

1186  
ªt
;

1188 i‡(
	`WARN_ON
(
mvm
->
nd_m©ch_£ts
 || mvm->
nd_ch™√ls
))

1189  -
EBUSY
;

1192 i‡(
nd_c⁄fig
->
n_m©ch_£ts
) {

1193 
mvm
->
nd_m©ch_£ts
 = 
	`kmemdup
(
nd_c⁄fig
->
m©ch_£ts
,

1194 (*
nd_c⁄fig
->
m©ch_£ts
) *

1195 
nd_c⁄fig
->
n_m©ch_£ts
,

1196 
GFP_KERNEL
);

1197 i‡(
mvm
->
nd_m©ch_£ts
)

1198 
mvm
->
n_nd_m©ch_£ts
 = 
nd_c⁄fig
->
n_m©ch_£ts
;

1202 
mvm
->
nd_ch™√ls
 = 
	`kmemdup
(
nd_c⁄fig
->
ch™√ls
,

1203 (*
nd_c⁄fig
->
ch™√ls
) *

1204 
nd_c⁄fig
->
n_ch™√ls
,

1205 
GFP_KERNEL
);

1206 i‡(
mvm
->
nd_ch™√ls
)

1207 
mvm
->
n_nd_ch™√ls
 = 
nd_c⁄fig
->
n_ch™√ls
;

1210 
	}
}

1212 
	$iwl_mvm_‰ì_nd
(
iwl_mvm
 *
mvm
)

1214 
	`k‰ì
(
mvm
->
nd_m©ch_£ts
);

1215 
mvm
->
nd_m©ch_£ts
 = 
NULL
;

1216 
mvm
->
n_nd_m©ch_£ts
 = 0;

1217 
	`k‰ì
(
mvm
->
nd_ch™√ls
);

1218 
mvm
->
nd_ch™√ls
 = 
NULL
;

1219 
mvm
->
n_nd_ch™√ls
 = 0;

1220 
	}
}

1222 
	$__iwl_mvm_su•íd
(
õì80211_hw
 *
hw
,

1223 
cfg80211_wowœn
 *
wowœn
,

1224 
boﬁ
 
ã°
)

1226 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

1227 
õì80211_vif
 *
vif
 = 
NULL
;

1228 
iwl_mvm_vif
 *
mvmvif
 = 
NULL
;

1229 
õì80211_°a
 *
≠_°a
 = 
NULL
;

1230 
iwl_mvm_vif_lök_öfo
 *
mvm_lök
;

1231 
iwl_d3_m™agî_c⁄fig
 
d3_cfg_cmd_d©a
 = {

1237 .
mö_¶ìp_time
 = 
	`˝u_to_À32
(10 * 1000 * 1000),

1239 
iwl_ho°_cmd
 
d3_cfg_cmd
 = {

1240 .
id
 = 
D3_CONFIG_CMD
,

1241 .
Êags
 = 
CMD_WANT_SKB
 | 
CMD_SEND_IN_D3
,

1242 .
d©a
[0] = &
d3_cfg_cmd_d©a
,

1243 .
Àn
[0] = (
d3_cfg_cmd_d©a
),

1245 
ªt
, 
¥im¨y_lök
;

1246 
Àn
 
__maybe_unu£d
;

1247 
boﬁ
 
unifõd_image
 = 
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

1248 
IWL_UCODE_TLV_CAPA_CNSLDTD_D3_D0_IMG
);

1250 i‡(!
wowœn
) {

1255 
	`WARN_ON
(!
ã°
);

1256  -
EINVAL
;

1259 
vif
 = 
	`iwl_mvm_gë_bss_vif
(
mvm
);

1260 i‡(
	`IS_ERR_OR_NULL
(
vif
))

1263 i‡(
	`hweight16
(
vif
->
a˘ive_löks
) > 1) {

1270 
¥im¨y_lök
 = 
	`iwl_mvm_mld_gë_¥im¨y_lök
(
mvm
, 
vif
,

1271 
vif
->
a˘ive_löks
);

1273 i‡(
	`WARN_ONCE
(
¥im¨y_lök
 < 0, "noÖrimaryÜink in 0x%x\n",

1274 
vif
->
a˘ive_löks
))

1275 
¥im¨y_lök
 = 
	`__ffs
(
vif
->
a˘ive_löks
);

1277 
ªt
 = 
	`õì80211_£t_a˘ive_löks
(
vif
, 
	`BIT
(
¥im¨y_lök
));

1278 i‡(
ªt
)

1279  
ªt
;

1280 } i‡(
vif
->
a˘ive_löks
) {

1281 
¥im¨y_lök
 = 
	`__ffs
(
vif
->
a˘ive_löks
);

1283 
¥im¨y_lök
 = 0;

1286 
	`muãx_lock
(&
mvm
->
muãx
);

1288 
	`£t_bô
(
IWL_MVM_STATUS_IN_D3
, &
mvm
->
°©us
);

1290 
	`synchr⁄ize_√t
();

1292 
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1294 
mvm_lök
 = 
mvmvif
->
lök
[
¥im¨y_lök
];

1295 i‡(
	`WARN_ON_ONCE
(!
mvm_lök
)) {

1296 
ªt
 = -
EINVAL
;

1297 
out_n‹e£t
;

1300 i‡(
mvm_lök
->
≠_°a_id
 =
IWL_MVM_INVALID_STA
) {

1302 i‡(!
wowœn
->
nd_c⁄fig
) {

1303 
ªt
 = 1;

1304 
out_n‹e£t
;

1307 
ªt
 = 
	`iwl_mvm_√tdëe˘_c⁄fig
(

1308 
mvm
, 
wowœn
, wowœn->
nd_c⁄fig
, 
vif
);

1309 i‡(
ªt
)

1310 
out
;

1312 
mvm
->
√t_dëe˘
 = 
åue
;

1314 
iwl_wowœn_c⁄fig_cmd
 
wowœn_c⁄fig_cmd
 = {

1315 .
ofÊﬂdög_tid
 = 0,

1318 
wowœn_c⁄fig_cmd
.
°a_id
 = 
mvm_lök
->
≠_°a_id
;

1320 
≠_°a
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(

1321 
mvm
->
fw_id_to_mac_id
[
mvm_lök
->
≠_°a_id
],

1322 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

1323 i‡(
	`IS_ERR_OR_NULL
(
≠_°a
)) {

1324 
ªt
 = -
EINVAL
;

1325 
out_n‹e£t
;

1328 
ªt
 = 
	`iwl_mvm_°a_ísuª_queue
(

1329 
mvm
, 
≠_°a
->
txq
[
wowœn_c⁄fig_cmd
.
ofÊﬂdög_tid
]);

1330 i‡(
ªt
)

1331 
out_n‹e£t
;

1333 
ªt
 = 
	`iwl_mvm_gë_wowœn_c⁄fig
(
mvm
, 
wowœn
, &
wowœn_c⁄fig_cmd
,

1334 
vif
, 
mvmvif
, 
≠_°a
);

1335 i‡(
ªt
)

1336 
out_n‹e£t
;

1337 
ªt
 = 
	`iwl_mvm_wowœn_c⁄fig
(
mvm
, 
wowœn
, &
wowœn_c⁄fig_cmd
,

1338 
vif
, 
mvmvif
, 
mvm_lök
, 
≠_°a
);

1339 i‡(
ªt
)

1340 
out
;

1342 
mvm
->
√t_dëe˘
 = 
Ál£
;

1345 
ªt
 = 
	`iwl_mvm_powî_upd©e_devi˚
(
mvm
);

1346 i‡(
ªt
)

1347 
out
;

1349 
ªt
 = 
	`iwl_mvm_powî_upd©e_mac
(
mvm
);

1350 i‡(
ªt
)

1351 
out
;

1353 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


1354 i‡(
mvm
->
d3_wake_syßs£π
)

1355 
d3_cfg_cmd_d©a
.
wakeup_Êags
 |=

1356 
	`˝u_to_À32
(
IWL_WAKEUP_D3_CONFIG_FW_ERROR
);

1364 i‡(
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 < 
IWL_DEVICE_FAMILY_9000
)

1365 
	`iwl_fw_dbg_°›_ª°¨t_ªc‹dög
(&
mvm
->
fwπ
, 
NULL
, 
åue
);

1367 
mvm
->
å™s
->
sy°em_pm_mode
 = 
IWL_PLAT_PM_MODE_D3
;

1370 
ªt
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
d3_cfg_cmd
);

1371 i‡(
ªt
)

1372 
out
;

1373 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


1374 
Àn
 = 
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
d3_cfg_cmd
.
ª•_pkt
);

1375 i‡(
Àn
 >(
u32
)) {

1376 
mvm
->
d3_ã°_pme_±r
 =

1377 
	`À32_to_˝up
((
__À32
 *)
d3_cfg_cmd
.
ª•_pkt
->
d©a
);

1380 
	`iwl_‰ì_ª•
(&
d3_cfg_cmd
);

1382 
	`˛ór_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
);

1384 
ªt
 = 
	`iwl_å™s_d3_su•íd
(
mvm
->
å™s
, 
ã°
, !
unifõd_image
);

1385 
out
:

1386 i‡(
ªt
 < 0) {

1387 
	`iwl_mvm_‰ì_nd
(
mvm
);

1389 i‡(!
unifõd_image
) {

1390 i‡(
mvm
->
fw_ª°¨t
 > 0) {

1391 
mvm
->
fw_ª°¨t
--;

1392 
	`õì80211_ª°¨t_hw
(
mvm
->
hw
);

1396 
	`˛ór_bô
(
IWL_MVM_STATUS_IN_D3
, &
mvm
->
°©us
);

1398 
out_n‹e£t
:

1399 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1401  
ªt
;

1402 
	}
}

1404 
	$iwl_mvm_su•íd
(
õì80211_hw
 *
hw
, 
cfg80211_wowœn
 *
wowœn
)

1406 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

1408 
	`iwl_mvm_∑u£_tcm
(
mvm
, 
åue
);

1410 
	`iwl_fw_ru¡ime_su•íd
(&
mvm
->
fwπ
);

1412  
	`__iwl_mvm_su•íd
(
hw
, 
wowœn
, 
Ál£
);

1413 
	}
}

1415 
	siwl_mu…iˇ°_key_d©a
 {

1416 
u8
 
	mkey
[
WOWLAN_KEY_MAX_SIZE
];

1417 
u8
 
	mÀn
;

1418 
u8
 
	mÊags
;

1419 
u8
 
	mid
;

1420 
u8
 
	mùn
[6];

1424 
	siwl_wowœn_°©us_d©a
 {

1425 
u64
 
	mª∂ay_˘r
;

1426 
u32
 
	mnum_of_gtk_ªkeys
;

1427 
u32
 
	mª˚ived_bóc⁄s
;

1428 
u32
 
	mwakeup_ªas⁄s
;

1429 
u32
 
	mwake_∑ckë_Àngth
;

1430 
u32
 
	mwake_∑ckë_bufsize
;

1431 
u16
 
	m∑âîn_numbî
;

1432 
u16
 
	mn⁄_qos_£q_˘r
;

1433 
u16
 
	mqos_£q_˘r
[8];

1434 
u8
 
	mtid_ã¨_down
;

1438 
u8
 
	mkey
[
WOWLAN_KEY_MAX_SIZE
];

1439 
u8
 
	mÀn
;

1440 
u8
 
	mÊags
;

1441 
u8
 
	mid
;

1442 } 
	mgtk
[
WOWLAN_GTK_KEYS_NUM
];

1452 
õì80211_key_£q
 
	m£q
[
IWL_MAX_TID_COUNT
];

1453 } 
	mtkù
, 
	m´s
;

1460 
s8
 
	mkey_id
;

1461 
boﬁ
 
	mvÆid
;

1462 } 
	mgtk_£q
[2];

1467 
õì80211_key_£q
 
	m£q
[
IWL_MAX_TID_COUNT
];

1468 
u64
 
	mtx_≤
;

1469 } 
	mtkù
, 
	m´s
;

1470 } 
	m±k
;

1472 
iwl_mu…iˇ°_key_d©a
 
	migtk
;

1473 
iwl_mu…iˇ°_key_d©a
 
	mbigtk
[
WOWLAN_BIGTK_KEYS_NUM
];

1475 
u8
 *
	mwake_∑ckë
;

1478 
	$iwl_mvm_ªp‹t_wakeup_ªas⁄s
(
iwl_mvm
 *
mvm
,

1479 
õì80211_vif
 *
vif
,

1480 
iwl_wowœn_°©us_d©a
 *
°©us
)

1482 
sk_buff
 *
pkt
 = 
NULL
;

1483 
cfg80211_wowœn_wakeup
 
wakeup
 = {

1484 .
∑âîn_idx
 = -1,

1486 
cfg80211_wowœn_wakeup
 *
wakeup_ªp‹t
 = &
wakeup
;

1487 
u32
 
ªas⁄s
 = 
°©us
->
wakeup_ªas⁄s
;

1489 i‡(
ªas⁄s
 =
IWL_WOWLAN_WAKEUP_BY_NON_WIRELESS
) {

1490 
wakeup_ªp‹t
 = 
NULL
;

1491 
ªp‹t
;

1494 
	`pm_wakeup_evít
(
mvm
->
dev
, 0);

1496 i‡(
ªas⁄s
 & 
IWL_WOWLAN_WAKEUP_BY_MAGIC_PACKET
)

1497 
wakeup
.
magic_pkt
 = 
åue
;

1499 i‡(
ªas⁄s
 & 
IWL_WOWLAN_WAKEUP_BY_PATTERN
)

1500 
wakeup
.
∑âîn_idx
 =

1501 
°©us
->
∑âîn_numbî
;

1503 i‡(
ªas⁄s
 & (
IWL_WOWLAN_WAKEUP_BY_DISCONNECTION_ON_MISSED_BEACON
 |

1504 
IWL_WOWLAN_WAKEUP_BY_DISCONNECTION_ON_DEAUTH
 |

1505 
IWL_WOWLAN_WAKEUP_BY_GTK_REKEY_FAILURE
))

1506 
wakeup
.
disc⁄√˘
 = 
åue
;

1508 i‡(
ªas⁄s
 & 
IWL_WOWLAN_WAKEUP_BY_GTK_REKEY_FAILURE
)

1509 
wakeup
.
gtk_ªkey_Áûuª
 = 
åue
;

1511 i‡(
ªas⁄s
 & 
IWL_WOWLAN_WAKEUP_BY_RFKILL_DEASSERTED
)

1512 
wakeup
.
rfkûl_ªÀa£
 = 
åue
;

1514 i‡(
ªas⁄s
 & 
IWL_WOWLAN_WAKEUP_BY_EAPOL_REQUEST
)

1515 
wakeup
.
óp_idítôy_ªq
 = 
åue
;

1517 i‡(
ªas⁄s
 & 
IWL_WOWLAN_WAKEUP_BY_FOUR_WAY_HANDSHAKE
)

1518 
wakeup
.
four_way_h™dshake
 = 
åue
;

1520 i‡(
ªas⁄s
 & 
IWL_WOWLAN_WAKEUP_BY_REM_WAKE_LINK_LOSS
)

1521 
wakeup
.
t˝_c⁄∆o°
 = 
åue
;

1523 i‡(
ªas⁄s
 & 
IWL_WOWLAN_WAKEUP_BY_REM_WAKE_SIGNATURE_TABLE
)

1524 
wakeup
.
t˝_nom‹ëokís
 = 
åue
;

1526 i‡(
ªas⁄s
 & 
IWL_WOWLAN_WAKEUP_BY_REM_WAKE_WAKEUP_PACKET
)

1527 
wakeup
.
t˝_m©ch
 = 
åue
;

1529 i‡(
ªas⁄s
 & 
IWL_WAKEUP_BY_11W_UNPROTECTED_DEAUTH_OR_DISASSOC
)

1530 
wakeup
.
u≈rŸ_dóuth_dißssoc
 = 
åue
;

1532 i‡(
°©us
->
wake_∑ckë
) {

1533 
pktsize
 = 
°©us
->
wake_∑ckë_bufsize
;

1534 
pkéí
 = 
°©us
->
wake_∑ckë_Àngth
;

1535 c⁄° 
u8
 *
pktd©a
 = 
°©us
->
wake_∑ckë
;

1536 c⁄° 
õì80211_hdr
 *
hdr
 = (c⁄° *)
pktd©a
;

1537 
åunˇãd
 = 
pkéí
 - 
pktsize
;

1540 i‡(
	`WARN_ON_ONCE
(
åunˇãd
 < 0))

1541 
åunˇãd
 = 0;

1543 i‡(
	`õì80211_is_d©a
(
hdr
->
‰ame_c⁄åﬁ
)) {

1544 
hdæí
 = 
	`õì80211_hdæí
(
hdr
->
‰ame_c⁄åﬁ
);

1545 
ivÀn
 = 0, 
icvÀn
 = 4;

1547 
pkt
 = 
	`Æloc_skb
(
pktsize
, 
GFP_KERNEL
);

1548 i‡(!
pkt
)

1549 
ªp‹t
;

1551 
	`skb_put_d©a
(
pkt
, 
pktd©a
, 
hdæí
);

1552 
pktd©a
 +
hdæí
;

1553 
pktsize
 -
hdæí
;

1555 i‡(
	`õì80211_has_¥Ÿe˘ed
(
hdr
->
‰ame_c⁄åﬁ
)) {

1562 i‡(
	`is_mu…iˇ°_ëhî_addr
(
hdr
->
addr1
)) {

1563 
ivÀn
 = 
mvm
->
gtk_ivÀn
;

1564 
icvÀn
 +
mvm
->
gtk_icvÀn
;

1566 
ivÀn
 = 
mvm
->
±k_ivÀn
;

1567 
icvÀn
 +
mvm
->
±k_icvÀn
;

1572 i‡(
åunˇãd
 >
icvÀn
) {

1573 
icvÀn
 = 0;

1574 
åunˇãd
 -
icvÀn
;

1576 
icvÀn
 -
åunˇãd
;

1577 
åunˇãd
 = 0;

1580 
pktsize
 -
ivÀn
 + 
icvÀn
;

1581 
pktd©a
 +
ivÀn
;

1583 
	`skb_put_d©a
(
pkt
, 
pktd©a
, 
pktsize
);

1585 i‡(
	`õì80211_d©a_to_8023
(
pkt
, 
vif
->
addr
, vif->
ty≥
))

1586 
ªp‹t
;

1587 
wakeup
.
∑ckë
 = 
pkt
->
d©a
;

1588 
wakeup
.
∑ckë_¥e£¡_Àn
 = 
pkt
->
Àn
;

1589 
wakeup
.
∑ckë_Àn
 = 
pkt
->
Àn
 - 
åunˇãd
;

1590 
wakeup
.
∑ckë_80211
 = 
Ál£
;

1592 
fc¶í
 = 4;

1594 i‡(
åunˇãd
 >= 4) {

1595 
åunˇãd
 -= 4;

1596 
fc¶í
 = 0;

1598 
fc¶í
 -
åunˇãd
;

1599 
åunˇãd
 = 0;

1601 
pktsize
 -
fc¶í
;

1602 
wakeup
.
∑ckë
 = 
°©us
->
wake_∑ckë
;

1603 
wakeup
.
∑ckë_¥e£¡_Àn
 = 
pktsize
;

1604 
wakeup
.
∑ckë_Àn
 = 
pkéí
 - 
åunˇãd
;

1605 
wakeup
.
∑ckë_80211
 = 
åue
;

1609 
ªp‹t
:

1610 
	`õì80211_ªp‹t_wowœn_wakeup
(
vif
, 
wakeup_ªp‹t
, 
GFP_KERNEL
);

1611 
	`k‰ì_skb
(
pkt
);

1612 
	}
}

1614 
	$iwl_mvm_À64_to_´s_£q
(
__À64
 
À_≤
, 
õì80211_key_£q
 *
£q
)

1616 
u64
 
≤
 = 
	`À64_to_˝u
(
À_≤
);

1618 
£q
->
ccmp
.
≤
[0] =Ön >> 40;

1619 
£q
->
ccmp
.
≤
[1] =Ön >> 32;

1620 
£q
->
ccmp
.
≤
[2] =Ön >> 24;

1621 
£q
->
ccmp
.
≤
[3] =Ön >> 16;

1622 
£q
->
ccmp
.
≤
[4] =Ön >> 8;

1623 
£q
->
ccmp
.
≤
[5] =Ön;

1624 
	}
}

1626 
	$iwl_mvm_´s_sc_to_£q
(
´s_sc
 *
sc
,

1627 
õì80211_key_£q
 *
£q
)

1629 
	`iwl_mvm_À64_to_´s_£q
(
sc
->
≤
, 
£q
);

1630 
	}
}

1632 
	$iwl_mvm_À64_to_tkù_£q
(
__À64
 
À_≤
, 
õì80211_key_£q
 *
£q
)

1634 
u64
 
≤
 = 
	`À64_to_˝u
(
À_≤
);

1636 
£q
->
tkù
.
iv16
 = (
u16
)
≤
;

1637 
£q
->
tkù
.
iv32
 = (
u32
)(
≤
 >> 16);

1638 
	}
}

1640 
	$iwl_mvm_tkù_sc_to_£q
(
tkù_sc
 *
sc
,

1641 
õì80211_key_£q
 *
£q
)

1643 
£q
->
tkù
.
iv32
 = 
	`À32_to_˝u
(
sc
->iv32);

1644 
£q
->
tkù
.
iv16
 = 
	`À16_to_˝u
(
sc
->iv16);

1645 
	}
}

1647 
	$iwl_mvm_£t_key_rx_£q_tids
(
õì80211_key_c⁄f
 *
key
,

1648 
õì80211_key_£q
 *
£q
)

1650 
tid
;

1652 
tid
 = 0;Åid < 
IWL_MAX_TID_COUNT
;Åid++)

1653 
	`õì80211_£t_key_rx_£q
(
key
, 
tid
, &
£q
[tid]);

1654 
	}
}

1656 
	$iwl_mvm_£t_´s_±k_rx_£q
(
iwl_mvm
 *
mvm
,

1657 
iwl_wowœn_°©us_d©a
 *
°©us
,

1658 
õì80211_°a
 *
°a
,

1659 
õì80211_key_c⁄f
 *
key
)

1661 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

1662 
iwl_mvm_key_≤
 *
±k_≤
;

1663 
tid
;

1665 
	`iwl_mvm_£t_key_rx_£q_tids
(
key
, 
°©us
->
±k
.
´s
.
£q
);

1667 i‡(!
	`iwl_mvm_has_√w_rx_≠i
(
mvm
))

1671 
	`rcu_ªad_lock
();

1672 
±k_≤
 = 
	`rcu_dîe„ªn˚
(
mvm°a
->±k_≤[
key
->
keyidx
]);

1673 i‡(
	`WARN_ON
(!
±k_≤
)) {

1674 
	`rcu_ªad_u∆ock
();

1678 
tid
 = 0;Åid < 
IWL_MAX_TID_COUNT
;Åid++) {

1679 
i
;

1681 
i
 = 1; i < 
mvm
->
å™s
->
num_rx_queues
; i++)

1682 
	`mem˝y
(
±k_≤
->
q
[
i
].
≤
[
tid
],

1683 
°©us
->
±k
.
´s
.
£q
[
tid
].
ccmp
.
≤
,

1684 
IEEE80211_CCMP_PN_LEN
);

1686 
	`rcu_ªad_u∆ock
();

1687 
	}
}

1689 
	$iwl_mvm_c⁄vît_key_cou¡îs
(
iwl_wowœn_°©us_d©a
 *
°©us
,

1690 
iwl_Æl_tsc_rsc
 *
sc
)

1692 
i
;

1694 
	`BUILD_BUG_ON
(
IWL_MAX_TID_COUNT
 > IWL_MAX_TID_COUNT);

1695 
	`BUILD_BUG_ON
(
IWL_MAX_TID_COUNT
 > 
IWL_NUM_RSC
);

1698 
i
 = 0; i < 
IWL_MAX_TID_COUNT
; i++) {

1699 
	`iwl_mvm_tkù_sc_to_£q
(&
sc
->
tkù
.
mu…iˇ°_rsc
[
i
],

1700 &
°©us
->
gtk_£q
[0].
tkù
.
£q
[
i
]);

1701 
	`iwl_mvm_´s_sc_to_£q
(&
sc
->
´s
.
mu…iˇ°_rsc
[
i
],

1702 &
°©us
->
gtk_£q
[0].
´s
.
£q
[
i
]);

1704 
°©us
->
gtk_£q
[0].
vÆid
 = 
åue
;

1705 
°©us
->
gtk_£q
[0].
key_id
 = -1;

1708 
°©us
->
±k
.
tkù
.
tx_≤
 = (
u64
)
	`À16_to_˝u
(
sc
->tkù.
tsc
.
iv16
) |

1709 ((
u64
)
	`À32_to_˝u
(
sc
->
tkù
.
tsc
.
iv32
) << 16);

1710 
°©us
->
±k
.
´s
.
tx_≤
 = 
	`À64_to_˝u
(
sc
->´s.
tsc
.
≤
);

1713 
i
 = 0; i < 
IWL_MAX_TID_COUNT
; i++) {

1714 
	`iwl_mvm_tkù_sc_to_£q
(&
sc
->
tkù
.
uniˇ°_rsc
[
i
],

1715 &
°©us
->
±k
.
tkù
.
£q
[
i
]);

1716 
	`iwl_mvm_´s_sc_to_£q
(&
sc
->
´s
.
uniˇ°_rsc
[
i
],

1717 &
°©us
->
±k
.
´s
.
£q
[
i
]);

1719 
	}
}

1722 
	$iwl_mvm_c⁄vît_key_cou¡îs_v5_gtk_£q
(
iwl_wowœn_°©us_d©a
 *
°©us
,

1723 
iwl_wowœn_Æl_rsc_tsc_v5
 *
sc
,

1724 
idx
, 
key_id
)

1726 
tid
;

1728 
tid
 = 0;Åid < 
IWL_MAX_TID_COUNT
;Åid++) {

1729 
	`iwl_mvm_À64_to_tkù_£q
(
sc
->
mˇ°_rsc
[
idx
][
tid
],

1730 &
°©us
->
gtk_£q
[
idx
].
tkù
.
£q
[
tid
]);

1731 
	`iwl_mvm_À64_to_´s_£q
(
sc
->
mˇ°_rsc
[
idx
][
tid
],

1732 &
°©us
->
gtk_£q
[
idx
].
´s
.
£q
[
tid
]);

1735 
°©us
->
gtk_£q
[
idx
].
vÆid
 = 
åue
;

1736 
°©us
->
gtk_£q
[
idx
].
key_id
 = key_id;

1737 
	}
}

1740 
	$iwl_mvm_c⁄vît_key_cou¡îs_v5
(
iwl_wowœn_°©us_d©a
 *
°©us
,

1741 
iwl_wowœn_Æl_rsc_tsc_v5
 *
sc
)

1743 
i
, 
tid
;

1745 
	`BUILD_BUG_ON
(
IWL_MAX_TID_COUNT
 > IWL_MAX_TID_COUNT);

1746 
	`BUILD_BUG_ON
(
IWL_MAX_TID_COUNT
 > 
IWL_NUM_RSC
);

1747 
	`BUILD_BUG_ON
(
	`ARRAY_SIZE
(
sc
->
mˇ°_rsc
Ë!ARRAY_SIZE(
°©us
->
gtk_£q
));

1750 
i
 = 0; i < 
	`ARRAY_SIZE
(
sc
->
mˇ°_key_id_m≠
); i++) {

1751 
u8
 
íåy
 = 
sc
->
mˇ°_key_id_m≠
[
i
];

1753 i‡(
íåy
 < 
	`ARRAY_SIZE
(
sc
->
mˇ°_rsc
))

1754 
	`iwl_mvm_c⁄vît_key_cou¡îs_v5_gtk_£q
(
°©us
, 
sc
,

1755 
íåy
, 
i
);

1761 
tid
 = 0;Åid < 
IWL_MAX_TID_COUNT
;Åid++) {

1762 
	`iwl_mvm_À64_to_tkù_£q
(
sc
->
uˇ°_rsc
[
tid
],

1763 &
°©us
->
±k
.
tkù
.
£q
[
tid
]);

1764 
	`iwl_mvm_À64_to_´s_£q
(
sc
->
uˇ°_rsc
[
tid
],

1765 &
°©us
->
±k
.
´s
.
£q
[
tid
]);

1767 
	}
}

1769 
	$iwl_mvm_£t_key_rx_£q_idx
(
õì80211_key_c⁄f
 *
key
,

1770 
iwl_wowœn_°©us_d©a
 *
°©us
,

1771 
idx
)

1773 
key
->
cùhî
) {

1774 
WLAN_CIPHER_SUITE_CCMP
:

1775 
WLAN_CIPHER_SUITE_GCMP
:

1776 
WLAN_CIPHER_SUITE_GCMP_256
:

1777 
	`iwl_mvm_£t_key_rx_£q_tids
(
key
, 
°©us
->
gtk_£q
[
idx
].
´s
.
£q
);

1779 
WLAN_CIPHER_SUITE_TKIP
:

1780 
	`iwl_mvm_£t_key_rx_£q_tids
(
key
, 
°©us
->
gtk_£q
[
idx
].
tkù
.
£q
);

1783 
	`WARN_ON
(1);

1785 
	}
}

1787 
	$iwl_mvm_£t_key_rx_£q
(
õì80211_key_c⁄f
 *
key
,

1788 
iwl_wowœn_°©us_d©a
 *
°©us
,

1789 
boﬁ
 
ö°ÆÀd
)

1791 
i
;

1793 
i
 = 0; i < 
	`ARRAY_SIZE
(
°©us
->
gtk_£q
); i++) {

1794 i‡(!
°©us
->
gtk_£q
[
i
].
vÆid
)

1798 i‡(
°©us
->
gtk_£q
[
i
].
key_id
 =
key
->
keyidx
) {

1799 
s8
 
√w_key_id
 = -1;

1801 i‡(
°©us
->
num_of_gtk_ªkeys
)

1802 
√w_key_id
 = 
°©us
->
gtk
[0].
Êags
 &

1803 
IWL_WOWLAN_GTK_IDX_MASK
;

1806 i‡(
√w_key_id
 !
key
->
keyidx
)

1807 
	`iwl_mvm_£t_key_rx_£q_idx
(
key
, 
°©us
, 
i
);

1812 i‡(
°©us
->
gtk_£q
[
i
].
key_id
 == -1 &&

1813 (!
°©us
->
num_of_gtk_ªkeys
 || 
ö°ÆÀd
))

1814 
	`iwl_mvm_£t_key_rx_£q_idx
(
key
, 
°©us
, 
i
);

1816 
	}
}

1818 
	siwl_mvm_d3_gtk_ôî_d©a
 {

1819 
iwl_mvm
 *
	mmvm
;

1820 
iwl_wowœn_°©us_d©a
 *
	m°©us
;

1821 
u32
 
	mgtk_cùhî
, 
	migtk_cùhî
, 
	mbigtk_cùhî
;

1822 
boﬁ
 
	munh™dÀd_cùhî
, 
	migtk_suµ‹t
, 
	mbigtk_suµ‹t
;

1823 
	mnum_keys
;

1826 
	$iwl_mvm_d3_föd_œ°_keys
(
õì80211_hw
 *
hw
,

1827 
õì80211_vif
 *
vif
,

1828 
õì80211_°a
 *
°a
,

1829 
õì80211_key_c⁄f
 *
key
,

1830 *
_d©a
)

1832 
iwl_mvm_d3_gtk_ôî_d©a
 *
d©a
 = 
_d©a
;

1834 i‡(
d©a
->
unh™dÀd_cùhî
)

1837 
key
->
cùhî
) {

1838 
WLAN_CIPHER_SUITE_WEP40
:

1839 
WLAN_CIPHER_SUITE_WEP104
:

1842 
WLAN_CIPHER_SUITE_CCMP
:

1843 
WLAN_CIPHER_SUITE_GCMP
:

1844 
WLAN_CIPHER_SUITE_GCMP_256
:

1845 
WLAN_CIPHER_SUITE_TKIP
:

1847 
d©a
->
gtk_cùhî
 = 
key
->
cùhî
;

1849 
WLAN_CIPHER_SUITE_BIP_GMAC_128
:

1850 
WLAN_CIPHER_SUITE_BIP_GMAC_256
:

1851 
WLAN_CIPHER_SUITE_BIP_CMAC_256
:

1852 
WLAN_CIPHER_SUITE_AES_CMAC
:

1854 i‡(
d©a
->
igtk_suµ‹t
 &&

1855 (
key
->
keyidx
 == 4 || key->keyidx == 5)) {

1856 
d©a
->
igtk_cùhî
 = 
key
->
cùhî
;

1857 } i‡(
d©a
->
bigtk_suµ‹t
 &&

1858 (
key
->
keyidx
 == 6 || key->keyidx == 7)) {

1859 
d©a
->
bigtk_cùhî
 = 
key
->
cùhî
;

1861 
d©a
->
unh™dÀd_cùhî
 = 
åue
;

1867 
d©a
->
unh™dÀd_cùhî
 = 
åue
;

1871 
d©a
->
num_keys
++;

1872 
	}
}

1875 
	$iwl_mvm_d3_£t_igtk_bigtk_ùn
(c⁄° 
iwl_mu…iˇ°_key_d©a
 *
key
,

1876 
õì80211_key_£q
 *
£q
, 
u32
 
cùhî
)

1878 
cùhî
) {

1879 
WLAN_CIPHER_SUITE_BIP_GMAC_128
:

1880 
WLAN_CIPHER_SUITE_BIP_GMAC_256
:

1881 
	`BUILD_BUG_ON
((
£q
->
´s_gmac
.
≤
Ë!(
key
->
ùn
));

1882 
	`mem˝y
(
£q
->
´s_gmac
.
≤
, 
key
->
ùn
, (seq->aes_gmac.pn));

1884 
WLAN_CIPHER_SUITE_BIP_CMAC_256
:

1885 
WLAN_CIPHER_SUITE_AES_CMAC
:

1886 
	`BUILD_BUG_ON
((
£q
->
´s_cmac
.
≤
Ë!(
key
->
ùn
));

1887 
	`mem˝y
(
£q
->
´s_cmac
.
≤
, 
key
->
ùn
, (seq->aes_cmac.pn));

1890 
	`WARN_ON
(1);

1892 
	}
}

1895 
	$iwl_mvm_d3_upd©e_igtk_bigtk
(
iwl_wowœn_°©us_d©a
 *
°©us
,

1896 
õì80211_key_c⁄f
 *
key
,

1897 
iwl_mu…iˇ°_key_d©a
 *
key_d©a
)

1899 i‡(
°©us
->
num_of_gtk_ªkeys
 && 
key_d©a
->
Àn
) {

1901 
	`õì80211_ªmove_key
(
key
);

1903 
õì80211_key_£q
 
£q
;

1905 
	`iwl_mvm_d3_£t_igtk_bigtk_ùn
(
key_d©a
,

1906 &
£q
,

1907 
key
->
cùhî
);

1908 
	`õì80211_£t_key_rx_£q
(
key
, 0, &
£q
);

1910 
	}
}

1912 
	$iwl_mvm_d3_upd©e_keys
(
õì80211_hw
 *
hw
,

1913 
õì80211_vif
 *
vif
,

1914 
õì80211_°a
 *
°a
,

1915 
õì80211_key_c⁄f
 *
key
,

1916 *
_d©a
)

1918 
iwl_mvm_d3_gtk_ôî_d©a
 *
d©a
 = 
_d©a
;

1919 
iwl_wowœn_°©us_d©a
 *
°©us
 = 
d©a
->status;

1920 
s8
 
keyidx
;

1922 i‡(
d©a
->
unh™dÀd_cùhî
)

1925 
key
->
cùhî
) {

1926 
WLAN_CIPHER_SUITE_WEP40
:

1927 
WLAN_CIPHER_SUITE_WEP104
:

1930 
WLAN_CIPHER_SUITE_CCMP
:

1931 
WLAN_CIPHER_SUITE_GCMP
:

1932 
WLAN_CIPHER_SUITE_GCMP_256
:

1933 i‡(
°a
) {

1934 
	`©omic64_£t
(&
key
->
tx_≤
, 
°©us
->
±k
.
´s
.tx_pn);

1935 
	`iwl_mvm_£t_´s_±k_rx_£q
(
d©a
->
mvm
, 
°©us
, 
°a
, 
key
);

1938 
ÁŒthrough
;

1939 
WLAN_CIPHER_SUITE_TKIP
:

1940 i‡(
°a
) {

1941 
	`©omic64_£t
(&
key
->
tx_≤
, 
°©us
->
±k
.
tkù
.tx_pn);

1942 
	`iwl_mvm_£t_key_rx_£q_tids
(
key
, 
°©us
->
±k
.
tkù
.
£q
);

1945 
keyidx
 = 
key
->keyidx;

1951 i‡(
°©us
->
num_of_gtk_ªkeys
 &&

1952 ((
°©us
->
gtk
[0].
Àn
 && 
keyidx
 =°©us->gtk[0].
id
) ||

1953 (
°©us
->
gtk
[1].
Àn
 && 
keyidx
 =°©us->gtk[1].
id
))) {

1954 
	`õì80211_ªmove_key
(
key
);

1956 
	`iwl_mvm_£t_key_rx_£q
(
key
, 
d©a
->
°©us
, 
Ál£
);

1959 
WLAN_CIPHER_SUITE_BIP_GMAC_128
:

1960 
WLAN_CIPHER_SUITE_BIP_GMAC_256
:

1961 
WLAN_CIPHER_SUITE_BIP_CMAC_256
:

1962 
WLAN_CIPHER_SUITE_AES_CMAC
:

1963 i‡(
key
->
keyidx
 == 4 || key->keyidx == 5) {

1964 
	`iwl_mvm_d3_upd©e_igtk_bigtk
(
°©us
, 
key
,

1965 &
°©us
->
igtk
);

1967 i‡(
key
->
keyidx
 == 6 || key->keyidx == 7) {

1968 
u8
 
idx
 = 
key
->
keyidx
 =
°©us
->
bigtk
[1].
id
;

1970 
	`iwl_mvm_d3_upd©e_igtk_bigtk
(
°©us
, 
key
,

1971 &
°©us
->
bigtk
[
idx
]);

1974 
	}
}

1976 
boﬁ
 
	$iwl_mvm_gtk_ªkey
(
iwl_wowœn_°©us_d©a
 *
°©us
,

1977 
õì80211_vif
 *
vif
,

1978 
iwl_mvm
 *
mvm
, 
u32
 
gtk_cùhî
)

1980 
i
, 
j
;

1981 
õì80211_key_c⁄f
 *
key
;

1983 
õì80211_key_c⁄f
 
c⁄f
;

1984 
u8
 
key
[32];

1985 } 
c⁄f
 = {

1986 .
c⁄f
.
cùhî
 = 
gtk_cùhî
,

1988 
lök_id
 = 
vif
->
a˘ive_löks
 ? 
	`__ffs
(vif->active_links) : -1;

1990 
	`BUILD_BUG_ON
(
WLAN_KEY_LEN_CCMP
 !
WLAN_KEY_LEN_GCMP
);

1991 
	`BUILD_BUG_ON
((
c⁄f
.
key
Ë< 
WLAN_KEY_LEN_CCMP
);

1992 
	`BUILD_BUG_ON
((
c⁄f
.
key
Ë< 
WLAN_KEY_LEN_GCMP_256
);

1993 
	`BUILD_BUG_ON
((
c⁄f
.
key
Ë< 
WLAN_KEY_LEN_TKIP
);

1994 
	`BUILD_BUG_ON
((
c⁄f
.
key
Ë< (
°©us
->
gtk
[0].key));

1996 
gtk_cùhî
) {

1997 
WLAN_CIPHER_SUITE_CCMP
:

1998 
WLAN_CIPHER_SUITE_GCMP
:

1999 
c⁄f
.c⁄f.
keyÀn
 = 
WLAN_KEY_LEN_CCMP
;

2001 
WLAN_CIPHER_SUITE_GCMP_256
:

2002 
c⁄f
.c⁄f.
keyÀn
 = 
WLAN_KEY_LEN_GCMP_256
;

2004 
WLAN_CIPHER_SUITE_TKIP
:

2005 
c⁄f
.c⁄f.
keyÀn
 = 
WLAN_KEY_LEN_TKIP
;

2008 
	`WARN_ON
(1);

2011 
i
 = 0; i < 
	`ARRAY_SIZE
(
°©us
->
gtk
); i++) {

2012 i‡(!
°©us
->
gtk
[
i
].
Àn
)

2015 
c⁄f
.c⁄f.
keyidx
 = 
°©us
->
gtk
[
i
].
id
;

2016 
	`IWL_DEBUG_WOWLAN
(
mvm
,

2018 
c⁄f
.c⁄f.
cùhî
, c⁄f.c⁄f.
keyidx
);

2019 
	`mem˝y
(
c⁄f
.c⁄f.
key
, 
°©us
->
gtk
[
i
].key,

2020 (
°©us
->
gtk
[
i
].
key
));

2022 
key
 = 
	`õì80211_gtk_ªkey_add
(
vif
, &
c⁄f
.c⁄f, 
lök_id
);

2023 i‡(
	`IS_ERR
(
key
))

2024  
Ál£
;

2026 
j
 = 0; j < 
	`ARRAY_SIZE
(
°©us
->
gtk_£q
); j++) {

2027 i‡(!
°©us
->
gtk_£q
[
j
].
vÆid
 ||

2028 
°©us
->
gtk_£q
[
j
].
key_id
 !
key
->
keyidx
)

2030 
	`iwl_mvm_£t_key_rx_£q_idx
(
key
, 
°©us
, 
j
);

2033 
	`WARN_ON
(
j
 =
	`ARRAY_SIZE
(
°©us
->
gtk_£q
));

2036  
åue
;

2037 
	}
}

2039 
boﬁ


2040 
	$iwl_mvm_d3_igtk_bigtk_ªkey_add
(
iwl_wowœn_°©us_d©a
 *
°©us
,

2041 
õì80211_vif
 *
vif
, 
u32
 
cùhî
,

2042 
iwl_mu…iˇ°_key_d©a
 *
key_d©a
)

2044 
õì80211_key_c⁄f
 *
key_c⁄fig
;

2046 
õì80211_key_c⁄f
 
c⁄f
;

2047 
u8
 
key
[
WOWLAN_KEY_MAX_SIZE
];

2048 } 
c⁄f
 = {

2049 .
c⁄f
.
cùhî
 = cipher,

2050 .
c⁄f
.
keyidx
 = 
key_d©a
->
id
,

2052 
õì80211_key_£q
 
£q
;

2053 
lök_id
 = 
vif
->
a˘ive_löks
 ? 
	`__ffs
(vif->active_links) : -1;

2055 i‡(!
key_d©a
->
Àn
)

2056  
åue
;

2058 
	`iwl_mvm_d3_£t_igtk_bigtk_ùn
(
key_d©a
, &
£q
, 
c⁄f
.c⁄f.
cùhî
);

2060 
cùhî
) {

2061 
WLAN_CIPHER_SUITE_BIP_GMAC_128
:

2062 
c⁄f
.c⁄f.
keyÀn
 = 
WLAN_KEY_LEN_BIP_GMAC_128
;

2064 
WLAN_CIPHER_SUITE_BIP_GMAC_256
:

2065 
c⁄f
.c⁄f.
keyÀn
 = 
WLAN_KEY_LEN_BIP_GMAC_256
;

2067 
WLAN_CIPHER_SUITE_AES_CMAC
:

2068 
c⁄f
.c⁄f.
keyÀn
 = 
WLAN_KEY_LEN_AES_CMAC
;

2070 
WLAN_CIPHER_SUITE_BIP_CMAC_256
:

2071 
c⁄f
.c⁄f.
keyÀn
 = 
WLAN_KEY_LEN_BIP_CMAC_256
;

2074 
	`WARN_ON
(1);

2076 
	`BUILD_BUG_ON
((
c⁄f
.
key
Ë< (
key_d©a
->key));

2077 
	`mem˝y
(
c⁄f
.c⁄f.
key
, 
key_d©a
->key, c⁄f.c⁄f.
keyÀn
);

2079 
key_c⁄fig
 = 
	`õì80211_gtk_ªkey_add
(
vif
, &
c⁄f
.c⁄f, 
lök_id
);

2080 i‡(
	`IS_ERR
(
key_c⁄fig
))

2081  
Ál£
;

2082 
	`õì80211_£t_key_rx_£q
(
key_c⁄fig
, 0, &
£q
);

2084 i‡(
key_c⁄fig
->
keyidx
 == 4 || key_config->keyidx == 5) {

2085 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

2086 
iwl_mvm_vif_lök_öfo
 *
mvm_lök
;

2088 
lök_id
 =Üink_id < 0 ? 0 :Üink_id;

2089 
mvm_lök
 = 
mvmvif
->
lök
[
lök_id
];

2090 
mvm_lök
->
igtk
 = 
key_c⁄fig
;

2093  
åue
;

2094 
	}
}

2096 
	$iwl_mvm_lookup_wowœn_°©us_vî
(
iwl_mvm
 *
mvm
)

2098 
u8
 
nŸif_vî
;

2100 i‡(!
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

2101 
IWL_UCODE_TLV_API_WOWLAN_KEY_MATERIAL
))

2105 
nŸif_vî
 = 
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
LONG_GROUP
,

2106 
WOWLAN_GET_STATUSES
, 0);

2107 i‡(!
nŸif_vî
)

2108 
nŸif_vî
 = 
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
LEGACY_GROUP
,

2109 
WOWLAN_GET_STATUSES
, 7);

2111  
nŸif_vî
;

2112 
	}
}

2114 
boﬁ
 
	$iwl_mvm_£tup_c⁄√˘i⁄_kìp
(
iwl_mvm
 *
mvm
,

2115 
õì80211_vif
 *
vif
,

2116 
iwl_wowœn_°©us_d©a
 *
°©us
)

2118 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

2119 
iwl_mvm_d3_gtk_ôî_d©a
 
gtkd©a
 = {

2120 .
mvm
 = mvm,

2121 .
°©us
 = status,

2123 
i
;

2124 
u32
 
disc⁄√˘i⁄_ªas⁄s
 =

2125 
IWL_WOWLAN_WAKEUP_BY_DISCONNECTION_ON_MISSED_BEACON
 |

2126 
IWL_WOWLAN_WAKEUP_BY_DISCONNECTION_ON_DEAUTH
;

2128 i‡(!
°©us
 || !
vif
->
bss_c⁄f
.
bssid
)

2129  
Ál£
;

2131 i‡(
	`iwl_mvm_lookup_wowœn_°©us_vî
(
mvm
) > 6 ||

2132 
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
PROT_OFFLOAD_GROUP
,

2133 
WOWLAN_INFO_NOTIFICATION
,

2135 
gtkd©a
.
igtk_suµ‹t
 = 
åue
;

2137 i‡(
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
PROT_OFFLOAD_GROUP
,

2138 
WOWLAN_INFO_NOTIFICATION
,

2140 
gtkd©a
.
bigtk_suµ‹t
 = 
åue
;

2143 
	`õì80211_ôî_keys
(
mvm
->
hw
, 
vif
,

2144 
iwl_mvm_d3_föd_œ°_keys
, &
gtkd©a
);

2146 i‡(
gtkd©a
.
unh™dÀd_cùhî
)

2147  
Ál£
;

2148 i‡(!
gtkd©a
.
num_keys
)

2149 
out
;

2155 
	`õì80211_ôî_keys
(
mvm
->
hw
, 
vif
,

2156 
iwl_mvm_d3_upd©e_keys
, &
gtkd©a
);

2158 i‡(
°©us
->
num_of_gtk_ªkeys
) {

2159 
__be64
 
ª∂ay_˘r
 = 
	`˝u_to_be64
(
°©us
->replay_ctr);

2161 
	`IWL_DEBUG_WOWLAN
(
mvm
, "num of GTKÑekeying %d\n",

2162 
°©us
->
num_of_gtk_ªkeys
);

2164 i‡(!
	`iwl_mvm_gtk_ªkey
(
°©us
, 
vif
, 
mvm
, 
gtkd©a
.
gtk_cùhî
))

2165  
Ál£
;

2167 i‡(!
	`iwl_mvm_d3_igtk_bigtk_ªkey_add
(
°©us
, 
vif
,

2168 
gtkd©a
.
igtk_cùhî
,

2169 &
°©us
->
igtk
))

2170  
Ál£
;

2172 
i
 = 0; i < 
	`ARRAY_SIZE
(
°©us
->
bigtk
); i++) {

2173 i‡(!
	`iwl_mvm_d3_igtk_bigtk_ªkey_add
(
°©us
, 
vif
,

2174 
gtkd©a
.
bigtk_cùhî
,

2175 &
°©us
->
bigtk
[
i
]))

2176  
Ál£
;

2179 
	`õì80211_gtk_ªkey_nŸify
(
vif
, vif->
bss_c⁄f
.
bssid
,

2180 (*)&
ª∂ay_˘r
, 
GFP_KERNEL
);

2183 
out
:

2184 i‡(
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
LONG_GROUP
,

2185 
WOWLAN_GET_STATUSES
, 0) < 10) {

2186 
mvmvif
->
£qno_vÆid
 = 
åue
;

2188 
mvmvif
->
£qno
 = 
°©us
->
n⁄_qos_£q_˘r
 + 0x10;

2191 i‡(
°©us
->
wakeup_ªas⁄s
 & 
disc⁄√˘i⁄_ªas⁄s
)

2192  
Ál£
;

2194  
åue
;

2195 
	}
}

2197 
	$iwl_mvm_c⁄vît_gtk_v2
(
iwl_wowœn_°©us_d©a
 *
°©us
,

2198 
iwl_wowœn_gtk_°©us_v2
 *
d©a
)

2200 
	`BUILD_BUG_ON
((
°©us
->
gtk
[0].
key
Ë< (
d©a
->key));

2201 
	`BUILD_BUG_ON
(
NL80211_TKIP_DATA_OFFSET_RX_MIC_KEY
 +

2202 (
d©a
->
tkù_mic_key
) >

2203 (
°©us
->
gtk
[0].
key
));

2205 
°©us
->
gtk
[0].
Àn
 = 
d©a
->
key_Àn
;

2206 
°©us
->
gtk
[0].
Êags
 = 
d©a
->
key_Êags
;

2208 
	`mem˝y
(
°©us
->
gtk
[0].
key
, 
d©a
->key, (data->key));

2211 i‡(
°©us
->
gtk
[0].
Àn
 =
NL80211_TKIP_DATA_OFFSET_TX_MIC_KEY
)

2212 
	`mem˝y
(
°©us
->
gtk
[0].
key
 + 
NL80211_TKIP_DATA_OFFSET_RX_MIC_KEY
,

2213 
d©a
->
tkù_mic_key
, (data->tkip_mic_key));

2214 
	}
}

2216 
	$iwl_mvm_c⁄vît_gtk_v3
(
iwl_wowœn_°©us_d©a
 *
°©us
,

2217 
iwl_wowœn_gtk_°©us_v3
 *
d©a
)

2219 
d©a_idx
, 
°©us_idx
 = 0;

2221 
	`BUILD_BUG_ON
((
°©us
->
gtk
[0].
key
Ë< (
d©a
[0].key));

2222 
	`BUILD_BUG_ON
(
NL80211_TKIP_DATA_OFFSET_RX_MIC_KEY
 +

2223 (
d©a
[0].
tkù_mic_key
) >

2224 (
°©us
->
gtk
[0].
key
));

2225 
	`BUILD_BUG_ON
(
	`ARRAY_SIZE
(
°©us
->
gtk
Ë< 
WOWLAN_GTK_KEYS_NUM
);

2226 
d©a_idx
 = 0; d©a_idx < 
	`ARRAY_SIZE
(
°©us
->
gtk
); data_idx++) {

2227 i‡(!(
d©a
[
d©a_idx
].
key_Àn
))

2229 
°©us
->
gtk
[
°©us_idx
].
Àn
 = 
d©a
[
d©a_idx
].
key_Àn
;

2230 
°©us
->
gtk
[
°©us_idx
].
Êags
 = 
d©a
[
d©a_idx
].
key_Êags
;

2231 
°©us
->
gtk
[
°©us_idx
].
id
 = sètus->gtk[°©us_idx].
Êags
 &

2232 
IWL_WOWLAN_GTK_IDX_MASK
;

2234 
	`mem˝y
(
°©us
->
gtk
[
°©us_idx
].
key
, 
d©a
[
d©a_idx
].key,

2235 (
d©a
[
d©a_idx
].
key
));

2238 i‡(
°©us
->
gtk
[
°©us_idx
].
Àn
 ==

2239 
NL80211_TKIP_DATA_OFFSET_TX_MIC_KEY
)

2240 
	`mem˝y
(
°©us
->
gtk
[
°©us_idx
].
key
 +

2241 
NL80211_TKIP_DATA_OFFSET_RX_MIC_KEY
,

2242 
d©a
[
d©a_idx
].
tkù_mic_key
,

2243 (
d©a
[
d©a_idx
].
tkù_mic_key
));

2244 
°©us_idx
++;

2246 
	}
}

2248 
	$iwl_mvm_c⁄vît_igtk
(
iwl_wowœn_°©us_d©a
 *
°©us
,

2249 
iwl_wowœn_igtk_°©us
 *
d©a
)

2251 
i
;

2253 
	`BUILD_BUG_ON
((
°©us
->
igtk
.
key
Ë< (
d©a
->key));

2254 
	`BUILD_BUG_ON
((
°©us
->
igtk
.
ùn
Ë!(
d©a
->ipn));

2256 i‡(!
d©a
->
key_Àn
)

2259 
°©us
->
igtk
.
Àn
 = 
d©a
->
key_Àn
;

2260 
°©us
->
igtk
.
Êags
 = 
d©a
->
key_Êags
;

2261 
°©us
->
igtk
.
id
 = 
	`u32_gë_bôs
(
d©a
->
key_Êags
,

2262 
IWL_WOWLAN_IGTK_BIGTK_IDX_MASK
)

2263 + 
WOWLAN_IGTK_MIN_INDEX
;

2265 
	`mem˝y
(
°©us
->
igtk
.
key
, 
d©a
->key, (data->key));

2268 
i
 = 0; i < (
d©a
->
ùn
); i++)

2269 
°©us
->
igtk
.
ùn
[
i
] = 
d©a
->ipn[(data->ipn) - i - 1];

2270 
	}
}

2272 
	$iwl_mvm_c⁄vît_bigtk
(
iwl_wowœn_°©us_d©a
 *
°©us
,

2273 c⁄° 
iwl_wowœn_igtk_°©us
 *
d©a
)

2275 
d©a_idx
, 
°©us_idx
 = 0;

2277 
	`BUILD_BUG_ON
(
	`ARRAY_SIZE
(
°©us
->
bigtk
Ë< 
WOWLAN_BIGTK_KEYS_NUM
);

2279 
d©a_idx
 = 0; d©a_idx < 
WOWLAN_BIGTK_KEYS_NUM
; data_idx++) {

2280 i‡(!
d©a
[
d©a_idx
].
key_Àn
)

2283 
°©us
->
bigtk
[
°©us_idx
].
Àn
 = 
d©a
[
d©a_idx
].
key_Àn
;

2284 
°©us
->
bigtk
[
°©us_idx
].
Êags
 = 
d©a
[
d©a_idx
].
key_Êags
;

2285 
°©us
->
bigtk
[
°©us_idx
].
id
 =

2286 
	`u32_gë_bôs
(
d©a
[
d©a_idx
].
key_Êags
,

2287 
IWL_WOWLAN_IGTK_BIGTK_IDX_MASK
)

2288 + 
WOWLAN_BIGTK_MIN_INDEX
;

2290 
	`BUILD_BUG_ON
((
°©us
->
bigtk
[
°©us_idx
].
key
) <

2291 (
d©a
[
d©a_idx
].
key
));

2292 
	`BUILD_BUG_ON
((
°©us
->
bigtk
[
°©us_idx
].
ùn
) <

2293 (
d©a
[
d©a_idx
].
ùn
));

2295 
	`mem˝y
(
°©us
->
bigtk
[
°©us_idx
].
key
, 
d©a
[
d©a_idx
].key,

2296 (
d©a
[
d©a_idx
].
key
));

2297 
	`mem˝y
(
°©us
->
bigtk
[
°©us_idx
].
ùn
, 
d©a
[
d©a_idx
].ipn,

2298 (
d©a
[
d©a_idx
].
ùn
));

2299 
°©us_idx
++;

2301 
	}
}

2303 
	$iwl_mvm_∑r£_wowœn_öfo_nŸif
(
iwl_mvm
 *
mvm
,

2304 
iwl_wowœn_öfo_nŸif
 *
d©a
,

2305 
iwl_wowœn_°©us_d©a
 *
°©us
,

2306 
u32
 
Àn
)

2308 
u32
 
i
;

2310 i‡(!
d©a
) {

2311 
	`IWL_ERR
(
mvm
, "iwl_wowlan_info_notif data is NULL\n");

2312 
°©us
 = 
NULL
;

2316 i‡(
Àn
 < (*
d©a
)) {

2317 
	`IWL_ERR
(
mvm
, "Invalid WoWLAN infoÇotification!\n");

2318 
°©us
 = 
NULL
;

2322 
	`iwl_mvm_c⁄vît_key_cou¡îs_v5
(
°©us
, &
d©a
->
gtk
[0].
sc
);

2323 
	`iwl_mvm_c⁄vît_gtk_v3
(
°©us
, 
d©a
->
gtk
);

2324 
	`iwl_mvm_c⁄vît_igtk
(
°©us
, &
d©a
->
igtk
[0]);

2325 
	`iwl_mvm_c⁄vît_bigtk
(
°©us
, 
d©a
->
bigtk
);

2326 
°©us
->
ª∂ay_˘r
 = 
	`À64_to_˝u
(
d©a
->replay_ctr);

2327 
°©us
->
∑âîn_numbî
 = 
	`À16_to_˝u
(
d©a
->pattern_number);

2328 
i
 = 0; i < 
IWL_MAX_TID_COUNT
; i++)

2329 
°©us
->
qos_£q_˘r
[
i
] =

2330 
	`À16_to_˝u
(
d©a
->
qos_£q_˘r
[
i
]);

2331 
°©us
->
wakeup_ªas⁄s
 = 
	`À32_to_˝u
(
d©a
->wakeup_reasons);

2332 
°©us
->
num_of_gtk_ªkeys
 =

2333 
	`À32_to_˝u
(
d©a
->
num_of_gtk_ªkeys
);

2334 
°©us
->
ª˚ived_bóc⁄s
 = 
	`À32_to_˝u
(
d©a
->received_beacons);

2335 
°©us
->
tid_ã¨_down
 = 
d©a
->tid_tear_down;

2336 
	}
}

2339 
	$iwl_mvm_∑r£_wowœn_öfo_nŸif_v2
(
iwl_mvm
 *
mvm
,

2340 
iwl_wowœn_öfo_nŸif_v2
 *
d©a
,

2341 
iwl_wowœn_°©us_d©a
 *
°©us
,

2342 
u32
 
Àn
)

2344 
u32
 
i
;

2346 i‡(!
d©a
) {

2347 
	`IWL_ERR
(
mvm
, "iwl_wowlan_info_notif data is NULL\n");

2348 
°©us
 = 
NULL
;

2352 i‡(
Àn
 < (*
d©a
)) {

2353 
	`IWL_ERR
(
mvm
, "Invalid WoWLAN infoÇotification!\n");

2354 
°©us
 = 
NULL
;

2358 
	`iwl_mvm_c⁄vît_key_cou¡îs_v5
(
°©us
, &
d©a
->
gtk
[0].
sc
);

2359 
	`iwl_mvm_c⁄vît_gtk_v3
(
°©us
, 
d©a
->
gtk
);

2360 
	`iwl_mvm_c⁄vît_igtk
(
°©us
, &
d©a
->
igtk
[0]);

2361 
°©us
->
ª∂ay_˘r
 = 
	`À64_to_˝u
(
d©a
->replay_ctr);

2362 
°©us
->
∑âîn_numbî
 = 
	`À16_to_˝u
(
d©a
->pattern_number);

2363 
i
 = 0; i < 
IWL_MAX_TID_COUNT
; i++)

2364 
°©us
->
qos_£q_˘r
[
i
] =

2365 
	`À16_to_˝u
(
d©a
->
qos_£q_˘r
[
i
]);

2366 
°©us
->
wakeup_ªas⁄s
 = 
	`À32_to_˝u
(
d©a
->wakeup_reasons);

2367 
°©us
->
num_of_gtk_ªkeys
 =

2368 
	`À32_to_˝u
(
d©a
->
num_of_gtk_ªkeys
);

2369 
°©us
->
ª˚ived_bóc⁄s
 = 
	`À32_to_˝u
(
d©a
->received_beacons);

2370 
°©us
->
tid_ã¨_down
 = 
d©a
->tid_tear_down;

2371 
	}
}

2374 
	#iwl_mvm_∑r£_wowœn_°©us_comm⁄
(
_vî
) \

2375 
iwl_wowœn_°©us_d©a
 * \

2376 
iwl_mvm_∑r£_wowœn_°©us_comm⁄_
 ## 
	`_vî
(
iwl_mvm
 *
mvm
, \

2377 
iwl_wowœn_°©us_
 ##
_vî
 *
d©a
,\

2378 
Àn
) \

2380 
iwl_wowœn_°©us_d©a
 *
°©us
; \

2381 
d©a_size
, 
i
; \

2383 i‡(
Àn
 < (*
d©a
)) { \

2384 
	`IWL_ERR
(
mvm
, "Invalid WoWLAN statusÑesponse!\n"); \

2385  
NULL
; \

2388 
d©a_size
 = 
	`ALIGN
(
	`À32_to_˝u
(
d©a
->
wake_∑ckë_bufsize
), 4); \

2389 i‡(
Àn
 !(*
d©a
Ë+ 
d©a_size
) { \

2390 
	`IWL_ERR
(
mvm
, "Invalid WoWLAN statusÑesponse!\n"); \

2391  
NULL
; \

2394 
°©us
 = 
	`kzÆloc
((*°©us), 
GFP_KERNEL
); \

2395 i‡(!
°©us
) \

2396  
NULL
; \

2399 
°©us
->
ª∂ay_˘r
 = 
	`À64_to_˝u
(
d©a
->replay_ctr); \

2400 
°©us
->
∑âîn_numbî
 = 
	`À16_to_˝u
(
d©a
->pattern_number); \

2401 
°©us
->
n⁄_qos_£q_˘r
 = 
	`À16_to_˝u
(
d©a
->non_qos_seq_ctr); \

2402 
i
 = 0; i < 8; i++) \

2403 
°©us
->
qos_£q_˘r
[
i
] = \

2404 
	`À16_to_˝u
(
d©a
->
qos_£q_˘r
[
i
]); \

2405 
°©us
->
wakeup_ªas⁄s
 = 
	`À32_to_˝u
(
d©a
->wakeup_reasons); \

2406 
°©us
->
num_of_gtk_ªkeys
 = \

2407 
	`À32_to_˝u
(
d©a
->
num_of_gtk_ªkeys
); \

2408 
°©us
->
ª˚ived_bóc⁄s
 = 
	`À32_to_˝u
(
d©a
->received_beacons); \

2409 
°©us
->
wake_∑ckë_Àngth
 = \

2410 
	`À32_to_˝u
(
d©a
->
wake_∑ckë_Àngth
); \

2411 
°©us
->
wake_∑ckë_bufsize
 = \

2412 
	`À32_to_˝u
(
d©a
->
wake_∑ckë_bufsize
); \

2413 i‡(
°©us
->
wake_∑ckë_bufsize
) { \

2414 
°©us
->
wake_∑ckë
 = \

2415 
	`kmemdup
(
d©a
->
wake_∑ckë
, \

2416 
°©us
->
wake_∑ckë_bufsize
, \

2417 
GFP_KERNEL
); \

2418 i‡(!
°©us
->
wake_∑ckë
) { \

2419 
	`k‰ì
(
°©us
); \

2420  
NULL
; \

2423 
°©us
->
wake_∑ckë
 = 
NULL
; \

2426  
°©us
; \

2427 }

	)

2429 
	$iwl_mvm_∑r£_wowœn_°©us_comm⁄
(
v6
)

2430 
	$iwl_mvm_∑r£_wowœn_°©us_comm⁄
(
v7
)

2431 
	$iwl_mvm_∑r£_wowœn_°©us_comm⁄
(
v9
)

2432 
	$iwl_mvm_∑r£_wowœn_°©us_comm⁄
(
v12
)

2434 
iwl_wowœn_°©us_d©a
 *

2435 
	$iwl_mvm_£nd_wowœn_gë_°©us
(
iwl_mvm
 *
mvm
, 
u8
 
°a_id
)

2437 
iwl_wowœn_°©us_d©a
 *
°©us
;

2438 
iwl_wowœn_gë_°©us_cmd
 
gë_°©us_cmd
 = {

2439 .
°a_id
 = 
	`˝u_to_À32
(sta_id),

2441 
iwl_ho°_cmd
 
cmd
 = {

2442 .
id
 = 
WOWLAN_GET_STATUSES
,

2443 .
Êags
 = 
CMD_WANT_SKB
,

2444 .
d©a
 = { &
gë_°©us_cmd
, },

2445 .
Àn
 = { (
gë_°©us_cmd
), },

2447 
ªt
, 
Àn
;

2448 
u8
 
nŸif_vî
;

2449 
u8
 
cmd_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
cmd
.
id
,

2450 
IWL_FW_CMD_VER_UNKNOWN
);

2452 i‡(
cmd_vî
 =
IWL_FW_CMD_VER_UNKNOWN
)

2453 
cmd
.
Àn
[0] = 0;

2455 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

2457 
ªt
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
cmd
);

2458 i‡(
ªt
) {

2459 
	`IWL_ERR
(
mvm
, "ÁûedÅÿquîy wakeu∞°©u†(%d)\n", 
ªt
);

2460  
	`ERR_PTR
(
ªt
);

2463 
Àn
 = 
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
cmd
.
ª•_pkt
);

2466 
nŸif_vî
 = 
	`iwl_mvm_lookup_wowœn_°©us_vî
(
mvm
);

2468 i‡(
nŸif_vî
 < 7) {

2469 
iwl_wowœn_°©us_v6
 *
v6
 = (*)
cmd
.
ª•_pkt
->
d©a
;

2471 
°©us
 = 
	`iwl_mvm_∑r£_wowœn_°©us_comm⁄_v6
(
mvm
, 
v6
, 
Àn
);

2472 i‡(!
°©us
)

2473 
out_‰ì_ª•
;

2475 
	`BUILD_BUG_ON
((
v6
->
gtk
.
de¸y±_key
) >

2476 (
°©us
->
gtk
[0].
key
));

2477 
	`BUILD_BUG_ON
(
NL80211_TKIP_DATA_OFFSET_RX_MIC_KEY
 +

2478 (
v6
->
gtk
.
tkù_mic_key
) >

2479 (
°©us
->
gtk
[0].
key
));

2482 
	`mem˝y
(
°©us
->
gtk
[0].
key
, 
v6
->gtk.
de¸y±_key
,

2483 (
v6
->
gtk
.
de¸y±_key
));

2484 
	`mem˝y
(
°©us
->
gtk
[0].
key
 + 
NL80211_TKIP_DATA_OFFSET_RX_MIC_KEY
,

2485 
v6
->
gtk
.
tkù_mic_key
,

2486 (
v6
->
gtk
.
tkù_mic_key
));

2488 
	`iwl_mvm_c⁄vît_key_cou¡îs
(
°©us
, &
v6
->
gtk
.
rsc
.
Æl_tsc_rsc
);

2491 
°©us
->
gtk
[0].
Àn
 = 16;

2498 
°©us
->
gtk
[0].
Êags
 = 
v6
->gtk.
key_ödex
 | 
	`BIT
(7);

2499 } i‡(
nŸif_vî
 == 7) {

2500 
iwl_wowœn_°©us_v7
 *
v7
 = (*)
cmd
.
ª•_pkt
->
d©a
;

2502 
°©us
 = 
	`iwl_mvm_∑r£_wowœn_°©us_comm⁄_v7
(
mvm
, 
v7
, 
Àn
);

2503 i‡(!
°©us
)

2504 
out_‰ì_ª•
;

2506 
	`iwl_mvm_c⁄vît_key_cou¡îs
(
°©us
, &
v7
->
gtk
[0].
rsc
.
Æl_tsc_rsc
);

2507 
	`iwl_mvm_c⁄vît_gtk_v2
(
°©us
, &
v7
->
gtk
[0]);

2508 
	`iwl_mvm_c⁄vît_igtk
(
°©us
, &
v7
->
igtk
[0]);

2509 } i‡(
nŸif_vî
 == 9 ||Çotif_ver == 10 ||Çotif_ver == 11) {

2510 
iwl_wowœn_°©us_v9
 *
v9
 = (*)
cmd
.
ª•_pkt
->
d©a
;

2515 
°©us
 = 
	`iwl_mvm_∑r£_wowœn_°©us_comm⁄_v9
(
mvm
, 
v9
, 
Àn
);

2516 i‡(!
°©us
)

2517 
out_‰ì_ª•
;

2519 
	`iwl_mvm_c⁄vît_key_cou¡îs
(
°©us
, &
v9
->
gtk
[0].
rsc
.
Æl_tsc_rsc
);

2520 
	`iwl_mvm_c⁄vît_gtk_v2
(
°©us
, &
v9
->
gtk
[0]);

2521 
	`iwl_mvm_c⁄vît_igtk
(
°©us
, &
v9
->
igtk
[0]);

2523 
°©us
->
tid_ã¨_down
 = 
v9
->tid_tear_down;

2524 } i‡(
nŸif_vî
 == 12) {

2525 
iwl_wowœn_°©us_v12
 *
v12
 = (*)
cmd
.
ª•_pkt
->
d©a
;

2527 
°©us
 = 
	`iwl_mvm_∑r£_wowœn_°©us_comm⁄_v12
(
mvm
, 
v12
, 
Àn
);

2528 i‡(!
°©us
)

2529 
out_‰ì_ª•
;

2531 
	`iwl_mvm_c⁄vît_key_cou¡îs_v5
(
°©us
, &
v12
->
gtk
[0].
sc
);

2532 
	`iwl_mvm_c⁄vît_gtk_v3
(
°©us
, 
v12
->
gtk
);

2533 
	`iwl_mvm_c⁄vît_igtk
(
°©us
, &
v12
->
igtk
[0]);

2535 
°©us
->
tid_ã¨_down
 = 
v12
->tid_tear_down;

2537 
	`IWL_ERR
(
mvm
,

2539 
nŸif_vî
);

2540 
°©us
 = 
NULL
;

2543 
out_‰ì_ª•
:

2544 
	`iwl_‰ì_ª•
(&
cmd
);

2545  
°©us
;

2546 
	}
}

2549 
boﬁ
 
	$iwl_mvm_quîy_wakeup_ªas⁄s
(
iwl_mvm
 *
mvm
,

2550 
õì80211_vif
 *
vif
,

2551 
iwl_wowœn_°©us_d©a
 *
°©us
)

2553 
i
;

2554 
boﬁ
 
kìp
 = 
Ál£
;

2555 
iwl_mvm_°a
 *
mvm_≠_°a
;

2557 i‡(!
°©us
)

2558 
out_u∆ock
;

2560 
	`IWL_DEBUG_WOWLAN
(
mvm
, "wakeupÑeason 0x%x\n",

2561 
°©us
->
wakeup_ªas⁄s
);

2564 
mvm_≠_°a
 = 
	`iwl_mvm_°a_‰om_°aid_¥Ÿe˘ed
(
mvm
, 0);

2565 i‡(!
mvm_≠_°a
)

2566 
out_u∆ock
;

2568 
i
 = 0; i < 
IWL_MAX_TID_COUNT
; i++) {

2569 
u16
 
£q
 = 
°©us
->
qos_£q_˘r
[
i
];

2571 
£q
 += 0x10;

2572 
mvm_≠_°a
->
tid_d©a
[
i
].
£q_numbî
 = 
£q
;

2575 i‡(
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 >
IWL_DEVICE_FAMILY_22000
) {

2576 
i
 = 
mvm
->
ofÊﬂd_tid
;

2577 
	`iwl_å™s_£t_q_±rs
(
mvm
->
å™s
,

2578 
mvm_≠_°a
->
tid_d©a
[
i
].
txq_id
,

2579 
mvm_≠_°a
->
tid_d©a
[
i
].
£q_numbî
 >> 4);

2582 
	`iwl_mvm_ªp‹t_wakeup_ªas⁄s
(
mvm
, 
vif
, 
°©us
);

2584 
kìp
 = 
	`iwl_mvm_£tup_c⁄√˘i⁄_kìp
(
mvm
, 
vif
, 
°©us
);

2585 
out_u∆ock
:

2586 
	`muãx_u∆ock
(&
mvm
->
muãx
);

2587  
kìp
;

2588 
	}
}

2590 
	#ND_QUERY_BUF_LEN
 ((
iwl_sˇn_ofÊﬂd_¥ofûe_m©ch
) * \

2591 
IWL_SCAN_MAX_PROFILES
)

	)

2593 
	siwl_mvm_nd_ªsu…s
 {

2594 
u32
 
	mm©ched_¥ofûes
;

2595 
u8
 
	mm©ches
[
ND_QUERY_BUF_LEN
];

2599 
	$iwl_mvm_√tdëe˘_quîy_ªsu…s
(
iwl_mvm
 *
mvm
,

2600 
iwl_mvm_nd_ªsu…s
 *
ªsu…s
)

2602 
iwl_sˇn_ofÊﬂd_m©ch_öfo
 *
quîy
;

2603 
iwl_ho°_cmd
 
cmd
 = {

2604 .
id
 = 
SCAN_OFFLOAD_PROFILES_QUERY_CMD
,

2605 .
Êags
 = 
CMD_WANT_SKB
,

2607 
ªt
, 
Àn
;

2608 
size_t
 
quîy_Àn
, 
m©ches_Àn
;

2609 
max_¥ofûes
 = 
	`iwl_umac_sˇn_gë_max_¥ofûes
(
mvm
->
fw
);

2611 
ªt
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
cmd
);

2612 i‡(
ªt
) {

2613 
	`IWL_ERR
(
mvm
, "ÁûedÅÿquîy m©chedÖrofûe†(%d)\n", 
ªt
);

2614  
ªt
;

2617 i‡(
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

2618 
IWL_UCODE_TLV_API_SCAN_OFFLOAD_CHANS
)) {

2619 
quîy_Àn
 = (
iwl_sˇn_ofÊﬂd_m©ch_öfo
);

2620 
m©ches_Àn
 = (
iwl_sˇn_ofÊﬂd_¥ofûe_m©ch
) *

2621 
max_¥ofûes
;

2623 
quîy_Àn
 = (
iwl_sˇn_ofÊﬂd_¥ofûes_quîy_v1
);

2624 
m©ches_Àn
 = (
iwl_sˇn_ofÊﬂd_¥ofûe_m©ch_v1
) *

2625 
max_¥ofûes
;

2628 
Àn
 = 
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
cmd
.
ª•_pkt
);

2629 i‡(
Àn
 < 
quîy_Àn
) {

2630 
	`IWL_ERR
(
mvm
, "Invalid scan offloadÖrofiles queryÑesponse!\n");

2631 
ªt
 = -
EIO
;

2632 
out_‰ì_ª•
;

2635 
quîy
 = (*)
cmd
.
ª•_pkt
->
d©a
;

2637 
ªsu…s
->
m©ched_¥ofûes
 = 
	`À32_to_˝u
(
quîy
->matched_profiles);

2638 
	`mem˝y
(
ªsu…s
->
m©ches
, 
quîy
->m©ches, 
m©ches_Àn
);

2640 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


2641 
mvm
->
œ°_√tdëe˘_sˇns
 = 
	`À32_to_˝u
(
quîy
->
n_sˇns_d⁄e
);

2644 
out_‰ì_ª•
:

2645 
	`iwl_‰ì_ª•
(&
cmd
);

2646  
ªt
;

2647 
	}
}

2649 
	$iwl_mvm_quîy_num_m©ch_ch™s
(
iwl_mvm
 *
mvm
,

2650 
iwl_mvm_nd_ªsu…s
 *
ªsu…s
,

2651 
idx
)

2653 
n_ch™s
 = 0, 
i
;

2655 i‡(
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

2656 
IWL_UCODE_TLV_API_SCAN_OFFLOAD_CHANS
)) {

2657 
iwl_sˇn_ofÊﬂd_¥ofûe_m©ch
 *
m©ches
 =

2658 (*)
ªsu…s
->
m©ches
;

2660 
i
 = 0; i < 
SCAN_OFFLOAD_MATCHING_CHANNELS_LEN
; i++)

2661 
n_ch™s
 +
	`hweight8
(
m©ches
[
idx
].
m©chög_ch™√ls
[
i
]);

2663 
iwl_sˇn_ofÊﬂd_¥ofûe_m©ch_v1
 *
m©ches
 =

2664 (*)
ªsu…s
->
m©ches
;

2666 
i
 = 0; i < 
SCAN_OFFLOAD_MATCHING_CHANNELS_LEN_V1
; i++)

2667 
n_ch™s
 +
	`hweight8
(
m©ches
[
idx
].
m©chög_ch™√ls
[
i
]);

2670  
n_ch™s
;

2671 
	}
}

2673 
	$iwl_mvm_quîy_£t_‰eqs
(
iwl_mvm
 *
mvm
,

2674 
iwl_mvm_nd_ªsu…s
 *
ªsu…s
,

2675 
cfg80211_wowœn_nd_m©ch
 *
m©ch
,

2676 
idx
)

2678 
i
;

2680 i‡(
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

2681 
IWL_UCODE_TLV_API_SCAN_OFFLOAD_CHANS
)) {

2682 
iwl_sˇn_ofÊﬂd_¥ofûe_m©ch
 *
m©ches
 =

2683 (*)
ªsu…s
->
m©ches
;

2685 
i
 = 0; i < 
SCAN_OFFLOAD_MATCHING_CHANNELS_LEN
 * 8; i++)

2686 i‡(
m©ches
[
idx
].
m©chög_ch™√ls
[
i
 / 8] & (
	`BIT
(i % 8)))

2687 
m©ch
->
ch™√ls
[m©ch->
n_ch™√ls
++] =

2688 
mvm
->
nd_ch™√ls
[
i
]->
˚¡î_‰eq
;

2690 
iwl_sˇn_ofÊﬂd_¥ofûe_m©ch_v1
 *
m©ches
 =

2691 (*)
ªsu…s
->
m©ches
;

2693 
i
 = 0; i < 
SCAN_OFFLOAD_MATCHING_CHANNELS_LEN_V1
 * 8; i++)

2694 i‡(
m©ches
[
idx
].
m©chög_ch™√ls
[
i
 / 8] & (
	`BIT
(i % 8)))

2695 
m©ch
->
ch™√ls
[m©ch->
n_ch™√ls
++] =

2696 
mvm
->
nd_ch™√ls
[
i
]->
˚¡î_‰eq
;

2698 
	}
}

2708 
	eiwl_d3_nŸif
 {

2709 
	mIWL_D3_NOTIF_WOWLAN_INFO
 = 
BIT
(0),

2710 
	mIWL_D3_NOTIF_WOWLAN_WAKE_PKT
 = 
BIT
(1),

2711 
	mIWL_D3_NOTIF_PROT_OFFLOAD
 = 
BIT
(2),

2712 
	mIWL_D3_ND_MATCH_INFO
 = 
BIT
(3),

2713 
	mIWL_D3_NOTIF_D3_END_NOTIF
 = 
BIT
(4)

2717 
	siwl_d3_d©a
 {

2718 
iwl_wowœn_°©us_d©a
 *
	m°©us
;

2719 
boﬁ
 
	mã°
;

2720 
u32
 
	md3_íd_Êags
;

2721 
u32
 
	mnŸif_ex≥˘ed
;

2722 
u32
 
	mnŸif_ª˚ived
;

2723 
iwl_mvm_nd_ªsu…s
 *
	mnd_ªsu…s
;

2724 
boﬁ
 
	mnd_ªsu…s_vÆid
;

2727 
	$iwl_mvm_quîy_√tdëe˘_ªas⁄s
(
iwl_mvm
 *
mvm
,

2728 
õì80211_vif
 *
vif
,

2729 
iwl_d3_d©a
 *
d3_d©a
)

2731 
cfg80211_wowœn_nd_öfo
 *
√t_dëe˘
 = 
NULL
;

2732 
cfg80211_wowœn_wakeup
 
wakeup
 = {

2733 .
∑âîn_idx
 = -1,

2735 
cfg80211_wowœn_wakeup
 *
wakeup_ªp‹t
 = &
wakeup
;

2736 
m©ched_¥ofûes
;

2737 
u32
 
ªas⁄s
 = 0;

2738 
i
, 
n_m©ches
, 
ªt
;

2740 i‡(
	`WARN_ON
(!
d3_d©a
 || !d3_d©a->
°©us
))

2741 
out
;

2743 
ªas⁄s
 = 
d3_d©a
->
°©us
->
wakeup_ªas⁄s
;

2745 i‡(
ªas⁄s
 & 
IWL_WOWLAN_WAKEUP_BY_RFKILL_DEASSERTED
)

2746 
wakeup
.
rfkûl_ªÀa£
 = 
åue
;

2748 i‡(
ªas⁄s
 !
IWL_WOWLAN_WAKEUP_BY_NON_WIRELESS
)

2749 
out
;

2751 i‡(!
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
PROT_OFFLOAD_GROUP
,

2752 
WOWLAN_INFO_NOTIFICATION
, 0)) {

2753 
	`IWL_INFO
(
mvm
, "Query FW for NDÑesults\n");

2754 
ªt
 = 
	`iwl_mvm_√tdëe˘_quîy_ªsu…s
(
mvm
, 
d3_d©a
->
nd_ªsu…s
);

2757 
	`IWL_INFO
(
mvm
, "Notification based NDÑesults\n");

2758 
ªt
 = 
d3_d©a
->
nd_ªsu…s_vÆid
 ? 0 : -1;

2761 i‡(
ªt
 || !
d3_d©a
->
nd_ªsu…s
->
m©ched_¥ofûes
) {

2762 
wakeup_ªp‹t
 = 
NULL
;

2763 
out
;

2766 
m©ched_¥ofûes
 = 
d3_d©a
->
nd_ªsu…s
->matched_profiles;

2767 i‡(
mvm
->
n_nd_m©ch_£ts
) {

2768 
n_m©ches
 = 
	`hweight_l⁄g
(
m©ched_¥ofûes
);

2770 
	`IWL_ERR
(
mvm
, "noÇet detect match informationávailable\n");

2771 
n_m©ches
 = 0;

2774 
√t_dëe˘
 = 
	`kzÆloc
(
	`°ru˘_size
“ë_dëe˘, 
m©ches
, 
n_m©ches
),

2775 
GFP_KERNEL
);

2776 i‡(!
√t_dëe˘
 || !
n_m©ches
)

2777 
out_ªp‹t_nd
;

2779 
	`f‹_óch_£t_bô
(
i
, &
m©ched_¥ofûes
, 
mvm
->
n_nd_m©ch_£ts
) {

2780 
cfg80211_wowœn_nd_m©ch
 *
m©ch
;

2781 
idx
, 
n_ch™√ls
 = 0;

2783 
n_ch™√ls
 = 
	`iwl_mvm_quîy_num_m©ch_ch™s
(
mvm
,

2784 
d3_d©a
->
nd_ªsu…s
,

2785 
i
);

2787 
m©ch
 = 
	`kzÆloc
(
	`°ru˘_size
(m©ch, 
ch™√ls
, 
n_ch™√ls
),

2788 
GFP_KERNEL
);

2789 i‡(!
m©ch
)

2790 
out_ªp‹t_nd
;

2792 
√t_dëe˘
->
m©ches
[√t_dëe˘->
n_m©ches
++] = 
m©ch
;

2797 
idx
 = 
mvm
->
n_nd_m©ch_£ts
 - 
i
 - 1;

2798 
m©ch
->
ssid
.
ssid_Àn
 = 
mvm
->
nd_m©ch_£ts
[
idx
].ssid.ssid_len;

2799 
	`mem˝y
(
m©ch
->
ssid
.ssid, 
mvm
->
nd_m©ch_£ts
[
idx
].ssid.ssid,

2800 
m©ch
->
ssid
.
ssid_Àn
);

2802 i‡(
mvm
->
n_nd_ch™√ls
 < 
n_ch™√ls
)

2805 
	`iwl_mvm_quîy_£t_‰eqs
(
mvm
, 
d3_d©a
->
nd_ªsu…s
, 
m©ch
, 
i
);

2808 
out_ªp‹t_nd
:

2809 
wakeup
.
√t_dëe˘
 =Çet_detect;

2810 
out
:

2811 
	`iwl_mvm_‰ì_nd
(
mvm
);

2813 
	`muãx_u∆ock
(&
mvm
->
muãx
);

2814 
	`õì80211_ªp‹t_wowœn_wakeup
(
vif
, 
wakeup_ªp‹t
, 
GFP_KERNEL
);

2816 i‡(
√t_dëe˘
) {

2817 
i
 = 0; i < 
√t_dëe˘
->
n_m©ches
; i++)

2818 
	`k‰ì
(
√t_dëe˘
->
m©ches
[
i
]);

2819 
	`k‰ì
(
√t_dëe˘
);

2821 
	}
}

2823 
	$iwl_mvm_d3_disc⁄√˘_ôî
(*
d©a
, 
u8
 *
mac
,

2824 
õì80211_vif
 *
vif
)

2827 i‡(
d©a
 =
vif
)

2830 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
)

2831 
	`õì80211_ªsume_disc⁄√˘
(
vif
);

2832 
	}
}

2834 
boﬁ
 
	$iwl_mvm_π_°©us
(
iwl_å™s
 *
å™s
, 
u32
 
ba£
, u32 *
îr_id
)

2836 
	sîr‹_èbÀ_°¨t
 {

2838 
u32
 
vÆid
;

2839 
__À32
 
îr_id
;

2840 } 
îr_öfo
;

2842 i‡(!
ba£
)

2843  
Ál£
;

2845 
	`iwl_å™s_ªad_mem_byãs
(
å™s
, 
ba£
,

2846 &
îr_öfo
, (err_info));

2847 i‡(
îr_öfo
.
vÆid
 && 
îr_id
)

2848 *
îr_id
 = 
	`À32_to_˝u
(
îr_öfo
.err_id);

2850  !!
îr_öfo
.
vÆid
;

2851 
	}
}

2853 
boﬁ
 
	$iwl_mvm_check_π_°©us
(
iwl_mvm
 *
mvm
,

2854 
õì80211_vif
 *
vif
)

2856 
u32
 
îr_id
;

2859 i‡(
	`iwl_mvm_π_°©us
(
mvm
->
å™s
,

2860 
mvm
->
å™s
->
dbg
.
lmac_îr‹_evít_èbÀ
[0],

2861 &
îr_id
)) {

2862 i‡(
îr_id
 =
RF_KILL_INDICATOR_FOR_WOWLAN
) {

2863 
cfg80211_wowœn_wakeup
 
wakeup
 = {

2864 .
rfkûl_ªÀa£
 = 
åue
,

2866 
	`õì80211_ªp‹t_wowœn_wakeup
(
vif
, &
wakeup
,

2867 
GFP_KERNEL
);

2869  
åue
;

2873 i‡(
	`iwl_mvm_π_°©us
(
mvm
->
å™s
,

2874 
mvm
->
å™s
->
dbg
.
lmac_îr‹_evít_èbÀ
[1], 
NULL
))

2875  
åue
;

2878 i‡(
	`iwl_mvm_π_°©us
(
mvm
->
å™s
,

2879 
mvm
->
å™s
->
dbg
.
umac_îr‹_evít_èbÀ
, 
NULL
))

2880  
åue
;

2882  
Ál£
;

2883 
	}
}

2890 
boﬁ


2891 
	$iwl_mvm_choo£_quîy_wakeup_ªas⁄s
(
iwl_mvm
 *
mvm
,

2892 
õì80211_vif
 *
vif
,

2893 
iwl_d3_d©a
 *
d3_d©a
)

2895 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

2898 i‡(!
d3_d©a
->
°©us
) {

2899 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

2900 
u8
 
°a_id
 = 
mvm
->
√t_dëe˘
 ? 
IWL_MVM_INVALID_STA
 :

2901 
mvmvif
->
deÊök
.
≠_°a_id
;

2904 
	`WARN_ON
(
	`õì80211_vif_is_mld
(
vif
));

2906 
d3_d©a
->
°©us
 = 
	`iwl_mvm_£nd_wowœn_gë_°©us
(
mvm
, 
°a_id
);

2909 i‡(
mvm
->
√t_dëe˘
) {

2910 
	`iwl_mvm_quîy_√tdëe˘_ªas⁄s
(
mvm
, 
vif
, 
d3_d©a
);

2912 
boﬁ
 
kìp
 = 
	`iwl_mvm_quîy_wakeup_ªas⁄s
(
mvm
, 
vif
,

2913 
d3_d©a
->
°©us
);

2915 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


2916 i‡(
kìp
)

2917 
mvm
->
kìp_vif
 = 
vif
;

2920  
kìp
;

2922  
Ál£
;

2923 
	}
}

2925 
	#IWL_WOWLAN_WAKEUP_REASON_HAS_WAKEUP_PKT
 (
IWL_WOWLAN_WAKEUP_BY_MAGIC_PACKET
 | \

2926 
IWL_WOWLAN_WAKEUP_BY_PATTERN
 | \

2927 
IWL_WAKEUP_BY_PATTERN_IPV4_TCP_SYN
 |\

2928 
IWL_WAKEUP_BY_PATTERN_IPV4_TCP_SYN_WILDCARD
 |\

2929 
IWL_WAKEUP_BY_PATTERN_IPV6_TCP_SYN
 |\

2930 
IWL_WAKEUP_BY_PATTERN_IPV6_TCP_SYN_WILDCARD
)

	)

2932 
	$iwl_mvm_wowœn_°‹e_wake_pkt
(
iwl_mvm
 *
mvm
,

2933 
iwl_wowœn_wake_pkt_nŸif
 *
nŸif
,

2934 
iwl_wowœn_°©us_d©a
 *
°©us
,

2935 
u32
 
Àn
)

2937 
u32
 
d©a_size
, 
∑ckë_Àn
 = 
	`À32_to_˝u
(
nŸif
->
wake_∑ckë_Àngth
);

2939 i‡(
Àn
 < (*
nŸif
)) {

2940 
	`IWL_ERR
(
mvm
, "Invalid WoWLAN wakeÖacketÇotification!\n");

2941  -
EIO
;

2944 i‡(
	`WARN_ON
(!
°©us
)) {

2945 
	`IWL_ERR
(
mvm
, "Got wakeÖacketÇotification but wowlan status data is NULL\n");

2946  -
EIO
;

2949 i‡(
	`WARN_ON
(!(
°©us
->
wakeup_ªas⁄s
 &

2950 
IWL_WOWLAN_WAKEUP_REASON_HAS_WAKEUP_PKT
))) {

2951 
	`IWL_ERR
(
mvm
, "Got wakeupÖacket but wakeupÑeason is %x\n",

2952 
°©us
->
wakeup_ªas⁄s
);

2953  -
EIO
;

2956 
d©a_size
 = 
Àn
 - 
	`off£tof
(
iwl_wowœn_wake_pkt_nŸif
, 
wake_∑ckë
);

2959 i‡(
∑ckë_Àn
 < 
d©a_size
)

2960 
d©a_size
 = 
∑ckë_Àn
;

2962 
°©us
->
wake_∑ckë
 = 
	`kmemdup
(
nŸif
->wake_∑ckë, 
d©a_size
,

2963 
GFP_ATOMIC
);

2965 i‡(!
°©us
->
wake_∑ckë
)

2966  -
ENOMEM
;

2968 
°©us
->
wake_∑ckë_Àngth
 = 
∑ckë_Àn
;

2969 
°©us
->
wake_∑ckë_bufsize
 = 
d©a_size
;

2972 
	}
}

2974 
	$iwl_mvm_nd_m©ch_öfo_h™dÀr
(
iwl_mvm
 *
mvm
,

2975 
iwl_d3_d©a
 *
d3_d©a
,

2976 
iwl_sˇn_ofÊﬂd_m©ch_öfo
 *
nŸif
,

2977 
u32
 
Àn
)

2979 
iwl_wowœn_°©us_d©a
 *
°©us
 = 
d3_d©a
->status;

2980 
õì80211_vif
 *
vif
 = 
	`iwl_mvm_gë_bss_vif
(
mvm
);

2981 
iwl_mvm_nd_ªsu…s
 *
ªsu…s
 = 
d3_d©a
->
nd_ªsu…s
;

2982 
size_t
 
i
, 
m©ches_Àn
 = (
iwl_sˇn_ofÊﬂd_¥ofûe_m©ch
) *

2983 
	`iwl_umac_sˇn_gë_max_¥ofûes
(
mvm
->
fw
);

2985 i‡(
	`IS_ERR_OR_NULL
(
vif
))

2988 i‡(
Àn
 < (
iwl_sˇn_ofÊﬂd_m©ch_öfo
)) {

2989 
	`IWL_ERR
(
mvm
, "Invalid scan match infoÇotification\n");

2993 i‡(!
mvm
->
√t_dëe˘
) {

2994 
	`IWL_ERR
(
mvm
, "Unexpected scan match infoÇotification\n");

2998 i‡(!
°©us
 || sètus->
wakeup_ªas⁄s
 !
IWL_WOWLAN_WAKEUP_BY_NON_WIRELESS
) {

2999 
	`IWL_ERR
(
mvm
,

3004 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


3005 
mvm
->
œ°_√tdëe˘_sˇns
 = 
	`À32_to_˝u
(
nŸif
->
n_sˇns_d⁄e
);

3008 
ªsu…s
->
m©ched_¥ofûes
 = 
	`À32_to_˝u
(
nŸif
->matched_profiles);

3009 
	`IWL_INFO
(
mvm
, "number of matchedÖrofiles=%u\n",

3010 
ªsu…s
->
m©ched_¥ofûes
);

3012 i‡(
ªsu…s
->
m©ched_¥ofûes
) {

3013 
	`mem˝y
(
ªsu…s
->
m©ches
, 
nŸif
->m©ches, 
m©ches_Àn
);

3014 
d3_d©a
->
nd_ªsu…s_vÆid
 = 
åue
;

3018 
mvm
->
sˇn_°©us
 = 0;

3019 
i
 = 0; i < 
mvm
->
max_sˇns
; i++)

3020 
mvm
->
sˇn_uid_°©us
[
i
] = 0;

3021 
	}
}

3023 
boﬁ
 
	$iwl_mvm_waô_d3_nŸif
(
iwl_nŸif_waô_d©a
 *
nŸif_waô
,

3024 
iwl_rx_∑ckë
 *
pkt
, *
d©a
)

3026 
iwl_mvm
 *
mvm
 =

3027 
	`c⁄èöî_of
(
nŸif_waô
, 
iwl_mvm
,Çotif_wait);

3028 
iwl_d3_d©a
 *
d3_d©a
 = 
d©a
;

3029 
u32
 
Àn
 = 
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
);

3030 
ªt
;

3031 
wowœn_öfo_vî
 = 
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
,

3032 
PROT_OFFLOAD_GROUP
,

3033 
WOWLAN_INFO_NOTIFICATION
,

3034 
IWL_FW_CMD_VER_UNKNOWN
);

3037 
	`WIDE_ID
(
pkt
->
hdr
.
group_id
,Ökt->hdr.
cmd
)) {

3038 
	`WIDE_ID
(
PROT_OFFLOAD_GROUP
, 
WOWLAN_INFO_NOTIFICATION
): {

3040 i‡(
d3_d©a
->
nŸif_ª˚ived
 & 
IWL_D3_NOTIF_WOWLAN_INFO
) {

3042 
	`IWL_DEBUG_WOWLAN
(
mvm
,

3047 i‡(
wowœn_öfo_vî
 < 2) {

3048 
iwl_wowœn_öfo_nŸif_v1
 *
nŸif_v1
 =

3049 (*)
pkt
->
d©a
;

3050 
iwl_wowœn_öfo_nŸif_v2
 *
nŸif_v2
;

3052 
nŸif_v2
 = 
	`kmemdup
(
nŸif_v1
, (*nŸif_v2), 
GFP_ATOMIC
);

3054 i‡(!
nŸif_v2
)

3055  
Ál£
;

3057 
nŸif_v2
->
tid_ã¨_down
 = 
nŸif_v1
->tid_tear_down;

3058 
nŸif_v2
->
°©i⁄_id
 = 
nŸif_v1
->station_id;

3059 
	`mem£t_a·î
(
nŸif_v2
, 0, 
°©i⁄_id
);

3060 
	`iwl_mvm_∑r£_wowœn_öfo_nŸif_v2
(
mvm
, 
nŸif_v2
,

3061 
d3_d©a
->
°©us
,

3062 
Àn
);

3063 
	`k‰ì
(
nŸif_v2
);

3065 } i‡(
wowœn_öfo_vî
 == 2) {

3066 
iwl_wowœn_öfo_nŸif_v2
 *
nŸif_v2
 =

3067 (*)
pkt
->
d©a
;

3069 
	`iwl_mvm_∑r£_wowœn_öfo_nŸif_v2
(
mvm
, 
nŸif_v2
,

3070 
d3_d©a
->
°©us
,

3071 
Àn
);

3073 
iwl_wowœn_öfo_nŸif
 *
nŸif
 =

3074 (*)
pkt
->
d©a
;

3076 
	`iwl_mvm_∑r£_wowœn_öfo_nŸif
(
mvm
, 
nŸif
,

3077 
d3_d©a
->
°©us
, 
Àn
);

3080 
d3_d©a
->
nŸif_ª˚ived
 |
IWL_D3_NOTIF_WOWLAN_INFO
;

3082 i‡(
d3_d©a
->
°©us
 &&

3083 
d3_d©a
->
°©us
->
wakeup_ªas⁄s
 & 
IWL_WOWLAN_WAKEUP_REASON_HAS_WAKEUP_PKT
)

3085 
d3_d©a
->
nŸif_ex≥˘ed
 |
IWL_D3_NOTIF_WOWLAN_WAKE_PKT
;

3089 
	`WIDE_ID
(
PROT_OFFLOAD_GROUP
, 
WOWLAN_WAKE_PKT_NOTIFICATION
): {

3090 
iwl_wowœn_wake_pkt_nŸif
 *
nŸif
 = (*)
pkt
->
d©a
;

3092 i‡(
d3_d©a
->
nŸif_ª˚ived
 & 
IWL_D3_NOTIF_WOWLAN_WAKE_PKT
) {

3094 
	`IWL_ERR
(
mvm
,

3097 
d3_d©a
->
nŸif_ª˚ived
 |
IWL_D3_NOTIF_WOWLAN_WAKE_PKT
;

3098 
Àn
 = 
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
);

3099 
ªt
 = 
	`iwl_mvm_wowœn_°‹e_wake_pkt
(
mvm
, 
nŸif
,

3100 
d3_d©a
->
°©us
,

3101 
Àn
);

3102 i‡(
ªt
)

3103 
	`IWL_ERR
(
mvm
,

3109 
	`WIDE_ID
(
SCAN_GROUP
, 
OFFLOAD_MATCH_INFO_NOTIF
): {

3110 
iwl_sˇn_ofÊﬂd_m©ch_öfo
 *
nŸif
 = (*)
pkt
->
d©a
;

3112 i‡(
d3_d©a
->
nŸif_ª˚ived
 & 
IWL_D3_ND_MATCH_INFO
) {

3113 
	`IWL_ERR
(
mvm
,

3118 
d3_d©a
->
nŸif_ª˚ived
 |
IWL_D3_ND_MATCH_INFO
;

3121 
d3_d©a
->
nŸif_ex≥˘ed
 |
IWL_D3_ND_MATCH_INFO
;

3123 
Àn
 = 
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
);

3124 
	`iwl_mvm_nd_m©ch_öfo_h™dÀr
(
mvm
, 
d3_d©a
, 
nŸif
, 
Àn
);

3127 
	`WIDE_ID
(
PROT_OFFLOAD_GROUP
, 
D3_END_NOTIFICATION
): {

3128 
iwl_mvm_d3_íd_nŸif
 *
nŸif
 = (*)
pkt
->
d©a
;

3130 
d3_d©a
->
d3_íd_Êags
 = 
	`__À32_to_˝u
(
nŸif
->
Êags
);

3131 
d3_d©a
->
nŸif_ª˚ived
 |
IWL_D3_NOTIF_D3_END_NOTIF
;

3136 
	`WARN_ON
(1);

3139  
d3_d©a
->
nŸif_ª˚ived
 =d3_d©a->
nŸif_ex≥˘ed
;

3140 
	}
}

3142 
	$iwl_mvm_ªsume_fúmw¨e
(
iwl_mvm
 *
mvm
, 
boﬁ
 
ã°
)

3144 
ªt
;

3145 
iwl_d3_°©us
 
d3_°©us
;

3146 
iwl_ho°_cmd
 
cmd
 = {

3147 .
id
 = 
D0I3_END_CMD
,

3148 .
Êags
 = 
CMD_WANT_SKB
 | 
CMD_SEND_IN_D3
,

3150 
boﬁ
 
ª£t
 = 
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

3151 
IWL_UCODE_TLV_CAPA_CNSLDTD_D3_D0_IMG
);

3153 
ªt
 = 
	`iwl_å™s_d3_ªsume
(
mvm
->
å™s
, &
d3_°©us
, 
ã°
, !
ª£t
);

3154 i‡(
ªt
)

3155  
ªt
;

3157 i‡(
d3_°©us
 !
IWL_D3_STATUS_ALIVE
) {

3158 
	`IWL_INFO
(
mvm
, "Device wasÑeset during suspend\n");

3159  -
ENOENT
;

3167 i‡(
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 <
IWL_DEVICE_FAMILY_22000
 &&

3168 
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_CAPA_D0I3_END_FIRST
)) {

3169 
ªt
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
cmd
);

3170 i‡(
ªt
 < 0)

3171 
	`IWL_ERR
(
mvm
, "FailedÅo send D0I3_END_CMD first (%d)\n",

3172 
ªt
);

3175  
ªt
;

3176 
	}
}

3178 
	#IWL_MVM_D3_NOTIF_TIMEOUT
 (
HZ
 / 5)

	)

3180 
	$iwl_mvm_d3_nŸif_waô
(
iwl_mvm
 *
mvm
,

3181 
iwl_d3_d©a
 *
d3_d©a
)

3183 c⁄° 
u16
 
d3_ªsume_nŸif
[] = {

3184 
	`WIDE_ID
(
PROT_OFFLOAD_GROUP
, 
WOWLAN_INFO_NOTIFICATION
),

3185 
	`WIDE_ID
(
PROT_OFFLOAD_GROUP
, 
WOWLAN_WAKE_PKT_NOTIFICATION
),

3186 
	`WIDE_ID
(
SCAN_GROUP
, 
OFFLOAD_MATCH_INFO_NOTIF
),

3187 
	`WIDE_ID
(
PROT_OFFLOAD_GROUP
, 
D3_END_NOTIFICATION
)

3189 
iwl_nŸifiˇti⁄_waô
 
waô_d3_nŸif
;

3190 
ªt
;

3192 
	`iwl_öô_nŸifiˇti⁄_waô
(&
mvm
->
nŸif_waô
, &
waô_d3_nŸif
,

3193 
d3_ªsume_nŸif
, 
	`ARRAY_SIZE
(d3_resume_notif),

3194 
iwl_mvm_waô_d3_nŸif
, 
d3_d©a
);

3196 
ªt
 = 
	`iwl_mvm_ªsume_fúmw¨e
(
mvm
, 
d3_d©a
->
ã°
);

3197 i‡(
ªt
) {

3198 
	`iwl_ªmove_nŸifiˇti⁄
(&
mvm
->
nŸif_waô
, &
waô_d3_nŸif
);

3199  
ªt
;

3202  
	`iwl_waô_nŸifiˇti⁄
(&
mvm
->
nŸif_waô
, &
waô_d3_nŸif
,

3203 
IWL_MVM_D3_NOTIF_TIMEOUT
);

3204 
	}
}

3206 
ölöe
 
boﬁ
 
	$iwl_mvm_d3_ªsume_nŸif_ba£d
(
iwl_mvm
 *
mvm
)

3208  
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
PROT_OFFLOAD_GROUP
,

3209 
WOWLAN_INFO_NOTIFICATION
, 0) &&

3210 
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
PROT_OFFLOAD_GROUP
,

3211 
WOWLAN_WAKE_PKT_NOTIFICATION
, 0) &&

3212 
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
PROT_OFFLOAD_GROUP
,

3213 
D3_END_NOTIFICATION
, 0);

3214 
	}
}

3216 
	$__iwl_mvm_ªsume
(
iwl_mvm
 *
mvm
, 
boﬁ
 
ã°
)

3218 
õì80211_vif
 *
vif
 = 
NULL
;

3219 
ªt
 = 1;

3220 
iwl_mvm_nd_ªsu…s
 
ªsu…s
 = {};

3221 
iwl_d3_d©a
 
d3_d©a
 = {

3222 .
ã°
 =Åest,

3223 .
nŸif_ex≥˘ed
 =

3224 
IWL_D3_NOTIF_WOWLAN_INFO
 |

3225 
IWL_D3_NOTIF_D3_END_NOTIF
,

3226 .
nd_ªsu…s_vÆid
 = 
Ál£
,

3227 .
nd_ªsu…s
 = &
ªsu…s
,

3229 
boﬁ
 
unifõd_image
 = 
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

3230 
IWL_UCODE_TLV_CAPA_CNSLDTD_D3_D0_IMG
);

3231 
boﬁ
 
d0i3_fú°
 = 
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

3232 
IWL_UCODE_TLV_CAPA_D0I3_END_FIRST
);

3233 
boﬁ
 
ªsume_nŸif_ba£d
 = 
	`iwl_mvm_d3_ªsume_nŸif_ba£d
(
mvm
);

3234 
boﬁ
 
kìp
 = 
Ál£
;

3236 
	`muãx_lock
(&
mvm
->
muãx
);

3238 
mvm
->
œ°_ª£t_‹_ªsume_time_jiffõs
 = 
jiffõs
;

3241 
vif
 = 
	`iwl_mvm_gë_bss_vif
(
mvm
);

3242 i‡(
	`IS_ERR_OR_NULL
(
vif
))

3243 
îr
;

3245 
	`iwl_fw_dbg_ªad_d3_debug_d©a
(&
mvm
->
fwπ
);

3247 i‡(
	`iwl_mvm_check_π_°©us
(
mvm
, 
vif
)) {

3248 
	`£t_bô
(
STATUS_FW_ERROR
, &
mvm
->
å™s
->
°©us
);

3249 
	`iwl_mvm_dump_nic_îr‹_log
(
mvm
);

3250 
	`iwl_dbg_év_time_poöt
(&
mvm
->
fwπ
,

3251 
IWL_FW_INI_TIME_POINT_FW_ASSERT
, 
NULL
);

3252 
	`iwl_fw_dbg_cﬁÀ˘_desc
(&
mvm
->
fwπ
, &
iwl_dump_desc_as£π
,

3253 
Ál£
, 0);

3254 
ªt
 = 1;

3255 
îr
;

3258 i‡(
ªsume_nŸif_ba£d
) {

3259 
d3_d©a
.
°©us
 = 
	`kzÆloc
((*d3_d©a.°©us), 
GFP_KERNEL
);

3260 i‡(!
d3_d©a
.
°©us
) {

3261 
	`IWL_ERR
(
mvm
, "FailedÅoállocate wowlan status\n");

3262 
ªt
 = -
ENOMEM
;

3263 
îr
;

3266 
ªt
 = 
	`iwl_mvm_d3_nŸif_waô
(
mvm
, &
d3_d©a
);

3267 i‡(
ªt
)

3268 
îr
;

3270 
ªt
 = 
	`iwl_mvm_ªsume_fúmw¨e
(
mvm
, 
ã°
);

3271 i‡(
ªt
 < 0)

3272 
îr
;

3276 
mvm
->
å™s
->
sy°em_pm_mode
 = 
IWL_PLAT_PM_MODE_DISABLED
;

3279 i‡(
d3_d©a
.
d3_íd_Êags
 & 
IWL_D0I3_RESET_REQUIRE
)

3280 
quîy_wakeup_ªas⁄s
;

3286 
	`iwl_mvm_upd©e_ch™ged_ªgdom
(
mvm
);

3289 
	`iwl_mvm_µag_£nd_cmd
(
mvm
);

3291 i‡(!
unifõd_image
)

3293 
	`iwl_mvm_ßr_£À˘_¥ofûe
(
mvm
, 1, 1);

3295 i‡(
mvm
->
√t_dëe˘
 && 
unifõd_image
) {

3302 
ªt
 = 
	`iwl_mvm_sˇn_°›
(
mvm
, 
IWL_MVM_SCAN_NETDETECT
,

3303 
Ál£
);

3306 
quîy_wakeup_ªas⁄s
:

3307 
kìp
 = 
	`iwl_mvm_choo£_quîy_wakeup_ªas⁄s
(
mvm
, 
vif
, &
d3_d©a
);

3309 
out
;

3311 
îr
:

3312 
	`muãx_u∆ock
(&
mvm
->
muãx
);

3313 
out
:

3314 i‡(
d3_d©a
.
°©us
)

3315 
	`k‰ì
(
d3_d©a
.
°©us
->
wake_∑ckë
);

3316 
	`k‰ì
(
d3_d©a
.
°©us
);

3317 
	`iwl_mvm_‰ì_nd
(
mvm
);

3319 i‡(!
d3_d©a
.
ã°
 && !
mvm
->
√t_dëe˘
)

3320 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s_mtx
(
mvm
->
hw
,

3321 
IEEE80211_IFACE_ITER_NORMAL
,

3322 
iwl_mvm_d3_disc⁄√˘_ôî
,

3323 
kìp
 ? 
vif
 : 
NULL
);

3325 
	`˛ór_bô
(
IWL_MVM_STATUS_IN_D3
, &
mvm
->
°©us
);

3328 i‡(
unifõd_image
 && !
ªt
) {

3330 i‡(
d0i3_fú°
)

3333 i‡(!
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
PROT_OFFLOAD_GROUP
,

3334 
D3_END_NOTIFICATION
, 0)) {

3335 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
D0I3_END_CMD
, 0, 0, 
NULL
);

3336 i‡(!
ªt
)

3338 } i‡(!(
d3_d©a
.
d3_íd_Êags
 & 
IWL_D0I3_RESET_REQUIRE
)) {

3348 
	`£t_bô
(
IWL_MVM_STATUS_HW_RESTART_REQUESTED
, &
mvm
->
°©us
);

3351 
mvm
->
å™s
->
sy°em_pm_mode
 = 
IWL_PLAT_PM_MODE_DISABLED
;

3354 
	}
}

3356 
	$iwl_mvm_ªsume
(
õì80211_hw
 *
hw
)

3358 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

3359 
ªt
;

3361 
ªt
 = 
	`__iwl_mvm_ªsume
(
mvm
, 
Ál£
);

3363 
	`iwl_mvm_ªsume_tcm
(
mvm
);

3365 
	`iwl_fw_ru¡ime_ªsume
(&
mvm
->
fwπ
);

3367  
ªt
;

3368 
	}
}

3370 
	$iwl_mvm_£t_wakeup
(
õì80211_hw
 *
hw
, 
boﬁ
 
íabÀd
)

3372 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

3374 
	`devi˚_£t_wakeup_íabÀ
(
mvm
->
å™s
->
dev
, 
íabÀd
);

3375 
	}
}

3377 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


3378 
	$iwl_mvm_d3_ã°_›í
(
öode
 *öode, 
fûe
 *file)

3380 
iwl_mvm
 *
mvm
 = 
öode
->
i_¥iv©e
;

3381 
îr
;

3383 i‡(
mvm
->
d3_ã°_a˘ive
)

3384  -
EBUSY
;

3386 
fûe
->
¥iv©e_d©a
 = 
öode
->
i_¥iv©e
;

3388 
	`iwl_mvm_∑u£_tcm
(
mvm
, 
åue
);

3390 
	`iwl_fw_ru¡ime_su•íd
(&
mvm
->
fwπ
);

3393 
	`π∆_lock
();

3394 
	`wùhy_lock
(
mvm
->
hw
->
wùhy
);

3395 
îr
 = 
	`__iwl_mvm_su•íd
(
mvm
->
hw
, mvm->hw->
wùhy
->
wowœn_c⁄fig
, 
åue
);

3396 
	`wùhy_u∆ock
(
mvm
->
hw
->
wùhy
);

3397 
	`π∆_u∆ock
();

3398 i‡(
îr
 > 0)

3399 
îr
 = -
EINVAL
;

3400 i‡(
îr
)

3401  
îr
;

3403 
mvm
->
d3_ã°_a˘ive
 = 
åue
;

3404 
mvm
->
kìp_vif
 = 
NULL
;

3406 
	}
}

3408 
ssize_t
 
	$iwl_mvm_d3_ã°_ªad
(
fûe
 *fûe, 
__u£r
 *
u£r_buf
,

3409 
size_t
 
cou¡
, 
loff_t
 *
µos
)

3411 
iwl_mvm
 *
mvm
 = 
fûe
->
¥iv©e_d©a
;

3412 
íd
 = 
jiffõs
 + 60 * 
HZ
;

3413 
u32
 
pme_as£πed
;

3415 
åue
) {

3417 i‡(
mvm
->
d3_ã°_pme_±r
) {

3418 
pme_as£πed
 = 
	`iwl_å™s_ªad_mem32
(
mvm
->
å™s
,

3419 
mvm
->
d3_ã°_pme_±r
);

3420 i‡(
pme_as£πed
)

3424 i‡(
	`m¶ìp_öãºu±ibÀ
(100))

3427 i‡(
	`time_is_bef‹e_jiffõs
(
íd
)) {

3428 
	`IWL_ERR
(
mvm
,

3430  -
ETIMEDOUT
;

3435 
	}
}

3437 
	$iwl_mvm_d3_ã°_disc⁄n_w‹k_ôî
(*
_d©a
, 
u8
 *
mac
,

3438 
õì80211_vif
 *
vif
)

3441 i‡(
_d©a
 =
vif
)

3444 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
)

3445 
	`õì80211_c⁄√˘i⁄_loss
(
vif
);

3446 
	}
}

3448 
	$iwl_mvm_d3_ã°_ªÀa£
(
öode
 *öode, 
fûe
 *file)

3450 
iwl_mvm
 *
mvm
 = 
öode
->
i_¥iv©e
;

3451 
boﬁ
 
unifõd_image
 = 
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

3452 
IWL_UCODE_TLV_CAPA_CNSLDTD_D3_D0_IMG
);

3454 
mvm
->
d3_ã°_a˘ive
 = 
Ál£
;

3456 
	`iwl_fw_dbg_ªad_d3_debug_d©a
(&
mvm
->
fwπ
);

3458 
	`π∆_lock
();

3459 
	`wùhy_lock
(
mvm
->
hw
->
wùhy
);

3460 
	`__iwl_mvm_ªsume
(
mvm
, 
åue
);

3461 
	`wùhy_u∆ock
(
mvm
->
hw
->
wùhy
);

3462 
	`π∆_u∆ock
();

3464 
	`iwl_mvm_ªsume_tcm
(
mvm
);

3466 
	`iwl_fw_ru¡ime_ªsume
(&
mvm
->
fwπ
);

3468 
	`iwl_ab‹t_nŸifiˇti⁄_waôs
(&
mvm
->
nŸif_waô
);

3469 i‡(!
unifõd_image
) {

3470 
ªmaöög_time
 = 10;

3472 
	`õì80211_ª°¨t_hw
(
mvm
->
hw
);

3475 
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
) &&

3476 
ªmaöög_time
 > 0) {

3477 
ªmaöög_time
--;

3478 
	`m¶ìp
(1000);

3481 i‡(
ªmaöög_time
 == 0)

3482 
	`IWL_ERR
(
mvm
, "Timed out waiting for HWÑestart!\n");

3485 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s_©omic
(

3486 
mvm
->
hw
, 
IEEE80211_IFACE_ITER_NORMAL
,

3487 
iwl_mvm_d3_ã°_disc⁄n_w‹k_ôî
, 
mvm
->
kìp_vif
);

3490 
	}
}

3492 c⁄° 
fûe_›î©i⁄s
 
	giwl_dbgfs_d3_ã°_›s
 = {

3493 .
Œ£ek
 = 
no_Œ£ek
,

3494 .
	g›í
 = 
iwl_mvm_d3_ã°_›í
,

3495 .
	gªad
 = 
iwl_mvm_d3_ã°_ªad
,

3496 .
	gªÀa£
 = 
iwl_mvm_d3_ã°_ªÀa£
,

	@debugfs-vif.c

7 
	~"mvm.h
"

8 
	~"debugfs.h
"

10 
	$iwl_dbgfs_upd©e_pm
(
iwl_mvm
 *
mvm
,

11 
õì80211_vif
 *
vif
,

12 
iwl_dbgfs_pm_mask
 
∑øm
, 
vÆ
)

14 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

15 
iwl_dbgfs_pm
 *
dbgfs_pm
 = &
mvmvif
->dbgfs_pm;

17 
dbgfs_pm
->
mask
 |
∑øm
;

19 
∑øm
) {

20 
MVM_DEBUGFS_PM_KEEP_ALIVE
: {

21 
dtim≥r
 = 
vif
->
bss_c⁄f
.
dtim_≥riod
 ?: 1;

22 
dtim≥r_m£c
 = 
dtim≥r
 * 
vif
->
bss_c⁄f
.
bóc⁄_öt
;

24 
	`IWL_DEBUG_POWER
(
mvm
, "debugfs: së kìp_Æive%d sec\n", 
vÆ
);

25 i‡(
vÆ
 * 
MSEC_PER_SEC
 < 3 * 
dtim≥r_m£c
)

26 
	`IWL_WARN
(
mvm
,

28 
vÆ
 * 
MSEC_PER_SEC
, 3 * 
dtim≥r_m£c
);

29 
dbgfs_pm
->
kìp_Æive_£c⁄ds
 = 
vÆ
;

32 
MVM_DEBUGFS_PM_SKIP_OVER_DTIM
:

33 
	`IWL_DEBUG_POWER
(
mvm
, "skip_over_dtim %s\n",

34 
vÆ
 ? "enabled" : "disabled");

35 
dbgfs_pm
->
skù_ovî_dtim
 = 
vÆ
;

37 
MVM_DEBUGFS_PM_SKIP_DTIM_PERIODS
:

38 
	`IWL_DEBUG_POWER
(
mvm
, "skù_dtim_≥riods=%d\n", 
vÆ
);

39 
dbgfs_pm
->
skù_dtim_≥riods
 = 
vÆ
;

41 
MVM_DEBUGFS_PM_RX_DATA_TIMEOUT
:

42 
	`IWL_DEBUG_POWER
(
mvm
, "rx_d©a_timeout=%d\n", 
vÆ
);

43 
dbgfs_pm
->
rx_d©a_timeout
 = 
vÆ
;

45 
MVM_DEBUGFS_PM_TX_DATA_TIMEOUT
:

46 
	`IWL_DEBUG_POWER
(
mvm
, "tx_d©a_timeout=%d\n", 
vÆ
);

47 
dbgfs_pm
->
tx_d©a_timeout
 = 
vÆ
;

49 
MVM_DEBUGFS_PM_LPRX_ENA
:

50 
	`IWL_DEBUG_POWER
(
mvm
, "Õrx %s\n", 
vÆ
 ? "enabled" : "disabled");

51 
dbgfs_pm
->
Õrx_ía
 = 
vÆ
;

53 
MVM_DEBUGFS_PM_LPRX_RSSI_THRESHOLD
:

54 
	`IWL_DEBUG_POWER
(
mvm
, "Õrx_rssi_thªshﬁd=%d\n", 
vÆ
);

55 
dbgfs_pm
->
Õrx_rssi_thªshﬁd
 = 
vÆ
;

57 
MVM_DEBUGFS_PM_SNOOZE_ENABLE
:

58 
	`IWL_DEBUG_POWER
(
mvm
, "¢ooze_íabÀ=%d\n", 
vÆ
);

59 
dbgfs_pm
->
¢ooze_ía
 = 
vÆ
;

61 
MVM_DEBUGFS_PM_UAPSD_MISBEHAVING
:

62 
	`IWL_DEBUG_POWER
(
mvm
, "u≠sd_misbehavög_íabÀ=%d\n", 
vÆ
);

63 
dbgfs_pm
->
u≠sd_misbehavög
 = 
vÆ
;

65 
MVM_DEBUGFS_PM_USE_PS_POLL
:

66 
	`IWL_DEBUG_POWER
(
mvm
, "u£_ps_pﬁl=%d\n", 
vÆ
);

67 
dbgfs_pm
->
u£_ps_pﬁl
 = 
vÆ
;

70 
	}
}

72 
ssize_t
 
	$iwl_dbgfs_pm_∑øms_wrôe
(
õì80211_vif
 *
vif
, *
buf
,

73 
size_t
 
cou¡
, 
loff_t
 *
µos
)

75 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

76 
iwl_mvm
 *
mvm
 = 
mvmvif
->mvm;

77 
iwl_dbgfs_pm_mask
 
∑øm
;

78 
vÆ
, 
ªt
;

80 i‡(!
	`°∫cmp
("kìp_Æive=", 
buf
, 11)) {

81 i‡(
	`ssˇnf
(
buf
 + 11, "%d", &
vÆ
) != 1)

82  -
EINVAL
;

83 
∑øm
 = 
MVM_DEBUGFS_PM_KEEP_ALIVE
;

84 } i‡(!
	`°∫cmp
("skù_ovî_dtim=", 
buf
, 15)) {

85 i‡(
	`ssˇnf
(
buf
 + 15, "%d", &
vÆ
) != 1)

86  -
EINVAL
;

87 
∑øm
 = 
MVM_DEBUGFS_PM_SKIP_OVER_DTIM
;

88 } i‡(!
	`°∫cmp
("skù_dtim_≥riods=", 
buf
, 18)) {

89 i‡(
	`ssˇnf
(
buf
 + 18, "%d", &
vÆ
) != 1)

90  -
EINVAL
;

91 
∑øm
 = 
MVM_DEBUGFS_PM_SKIP_DTIM_PERIODS
;

92 } i‡(!
	`°∫cmp
("rx_d©a_timeout=", 
buf
, 16)) {

93 i‡(
	`ssˇnf
(
buf
 + 16, "%d", &
vÆ
) != 1)

94  -
EINVAL
;

95 
∑øm
 = 
MVM_DEBUGFS_PM_RX_DATA_TIMEOUT
;

96 } i‡(!
	`°∫cmp
("tx_d©a_timeout=", 
buf
, 16)) {

97 i‡(
	`ssˇnf
(
buf
 + 16, "%d", &
vÆ
) != 1)

98  -
EINVAL
;

99 
∑øm
 = 
MVM_DEBUGFS_PM_TX_DATA_TIMEOUT
;

100 } i‡(!
	`°∫cmp
("Õrx=", 
buf
, 5)) {

101 i‡(
	`ssˇnf
(
buf
 + 5, "%d", &
vÆ
) != 1)

102  -
EINVAL
;

103 
∑øm
 = 
MVM_DEBUGFS_PM_LPRX_ENA
;

104 } i‡(!
	`°∫cmp
("Õrx_rssi_thªshﬁd=", 
buf
, 20)) {

105 i‡(
	`ssˇnf
(
buf
 + 20, "%d", &
vÆ
) != 1)

106  -
EINVAL
;

107 i‡(
vÆ
 > 
POWER_LPRX_RSSI_THRESHOLD_MAX
 || val <

108 
POWER_LPRX_RSSI_THRESHOLD_MIN
)

109  -
EINVAL
;

110 
∑øm
 = 
MVM_DEBUGFS_PM_LPRX_RSSI_THRESHOLD
;

111 } i‡(!
	`°∫cmp
("¢ooze_íabÀ=", 
buf
, 14)) {

112 i‡(
	`ssˇnf
(
buf
 + 14, "%d", &
vÆ
) != 1)

113  -
EINVAL
;

114 
∑øm
 = 
MVM_DEBUGFS_PM_SNOOZE_ENABLE
;

115 } i‡(!
	`°∫cmp
("u≠sd_misbehavög=", 
buf
, 18)) {

116 i‡(
	`ssˇnf
(
buf
 + 18, "%d", &
vÆ
) != 1)

117  -
EINVAL
;

118 
∑øm
 = 
MVM_DEBUGFS_PM_UAPSD_MISBEHAVING
;

119 } i‡(!
	`°∫cmp
("u£_ps_pﬁl=", 
buf
, 12)) {

120 i‡(
	`ssˇnf
(
buf
 + 12, "%d", &
vÆ
) != 1)

121  -
EINVAL
;

122 
∑øm
 = 
MVM_DEBUGFS_PM_USE_PS_POLL
;

124  -
EINVAL
;

127 
	`muãx_lock
(&
mvm
->
muãx
);

128 
	`iwl_dbgfs_upd©e_pm
(
mvm
, 
vif
, 
∑øm
, 
vÆ
);

129 
ªt
 = 
	`iwl_mvm_powî_upd©e_mac
(
mvm
);

130 
	`muãx_u∆ock
(&
mvm
->
muãx
);

132  
ªt
 ?: 
cou¡
;

133 
	}
}

135 
ssize_t
 
	$iwl_dbgfs_tx_pwr_lmt_ªad
(
fûe
 *file,

136 
__u£r
 *
u£r_buf
,

137 
size_t
 
cou¡
, 
loff_t
 *
µos
)

139 
õì80211_vif
 *
vif
 = 
fûe
->
¥iv©e_d©a
;

140 
buf
[64];

141 
bufsz
 = (
buf
);

142 
pos
;

144 
pos
 = 
	`s˙¥ötf
(
buf
, 
bufsz
, "bssÜimit = %d\n",

145 
vif
->
bss_c⁄f
.
txpowî
);

147  
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buf
, 
pos
);

148 
	}
}

150 
ssize_t
 
	$iwl_dbgfs_pm_∑øms_ªad
(
fûe
 *file,

151 
__u£r
 *
u£r_buf
,

152 
size_t
 
cou¡
, 
loff_t
 *
µos
)

154 
õì80211_vif
 *
vif
 = 
fûe
->
¥iv©e_d©a
;

155 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

156 
iwl_mvm
 *
mvm
 = 
mvmvif
->mvm;

157 
buf
[512];

158 
bufsz
 = (
buf
);

159 
pos
;

161 
pos
 = 
	`iwl_mvm_powî_mac_dbgfs_ªad
(
mvm
, 
vif
, 
buf
, 
bufsz
);

163  
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buf
, 
pos
);

164 
	}
}

166 
ssize_t
 
	$iwl_dbgfs_mac_∑øms_ªad
(
fûe
 *file,

167 
__u£r
 *
u£r_buf
,

168 
size_t
 
cou¡
, 
loff_t
 *
µos
)

170 
õì80211_vif
 *
vif
 = 
fûe
->
¥iv©e_d©a
;

171 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

172 
iwl_mvm
 *
mvm
 = 
mvmvif
->mvm;

173 
u8
 
≠_°a_id
;

174 
õì80211_ch™˘x_c⁄f
 *
ch™˘x_c⁄f
;

175 
buf
[512];

176 
bufsz
 = (
buf
);

177 
pos
 = 0;

178 
i
;

180 
	`muãx_lock
(&
mvm
->
muãx
);

182 
≠_°a_id
 = 
mvmvif
->
deÊök
.ap_sta_id;

184 
	`õì80211_vif_ty≥_p2p
(
vif
)) {

185 
NL80211_IFTYPE_ADHOC
:

186 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "type: ibss\n");

188 
NL80211_IFTYPE_STATION
:

189 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "type: bss\n");

191 
NL80211_IFTYPE_AP
:

192 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "type:áp\n");

194 
NL80211_IFTYPE_P2P_CLIENT
:

195 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "type:Ö2p client\n");

197 
NL80211_IFTYPE_P2P_GO
:

198 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "type:Ö2p go\n");

200 
NL80211_IFTYPE_P2P_DEVICE
:

201 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "type:Ö2p dev\n");

207 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "mac id/color: %d / %d\n",

208 
mvmvif
->
id
, mvmvif->
cﬁ‹
);

209 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "bssid: %pM\n",

210 
vif
->
bss_c⁄f
.
bssid
);

211 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "Load: %d\n",

212 
mvm
->
tcm
.
ªsu…
.
lﬂd
[
mvmvif
->
id
]);

213 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "QoS:\n");

214 
i
 = 0; i < 
	`ARRAY_SIZE
(
mvmvif
->
deÊök
.
queue_∑øms
); i++)

215 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos,

217 
i
, 
mvmvif
->
deÊök
.
queue_∑øms
[i].
tx›
,

218 
mvmvif
->
deÊök
.
queue_∑øms
[
i
].
cw_mö
,

219 
mvmvif
->
deÊök
.
queue_∑øms
[
i
].
cw_max
,

220 
mvmvif
->
deÊök
.
queue_∑øms
[
i
].
aifs
,

221 
mvmvif
->
deÊök
.
queue_∑øms
[
i
].
u≠sd
);

223 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
 &&

224 
≠_°a_id
 !
IWL_MVM_INVALID_STA
) {

225 
iwl_mvm_°a
 *
mvm_°a
;

227 
mvm_°a
 = 
	`iwl_mvm_°a_‰om_°aid_¥Ÿe˘ed
(
mvm
, 
≠_°a_id
);

228 i‡(
mvm_°a
) {

229 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos,

231 
≠_°a_id
,

232 
mvm_°a
->
bt_ªdu˚d_txpowî
);

236 
	`rcu_ªad_lock
();

237 
ch™˘x_c⁄f
 = 
	`rcu_dîe„ªn˚
(
vif
->
bss_c⁄f
.chanctx_conf);

238 i‡(
ch™˘x_c⁄f
)

239 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos,

241 
ch™˘x_c⁄f
->
rx_chaös_°©ic
,

242 
ch™˘x_c⁄f
->
rx_chaös_dy«mic
);

243 
	`rcu_ªad_u∆ock
();

245 
	`muãx_u∆ock
(&
mvm
->
muãx
);

247  
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buf
, 
pos
);

248 
	}
}

250 
	$iwl_dbgfs_upd©e_bf
(
õì80211_vif
 *
vif
,

251 
iwl_dbgfs_bf_mask
 
∑øm
, 
vÆue
)

253 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

254 
iwl_dbgfs_bf
 *
dbgfs_bf
 = &
mvmvif
->dbgfs_bf;

256 
dbgfs_bf
->
mask
 |
∑øm
;

258 
∑øm
) {

259 
MVM_DEBUGFS_BF_ENERGY_DELTA
:

260 
dbgfs_bf
->
bf_íîgy_dñè
 = 
vÆue
;

262 
MVM_DEBUGFS_BF_ROAMING_ENERGY_DELTA
:

263 
dbgfs_bf
->
bf_rﬂmög_íîgy_dñè
 = 
vÆue
;

265 
MVM_DEBUGFS_BF_ROAMING_STATE
:

266 
dbgfs_bf
->
bf_rﬂmög_°©e
 = 
vÆue
;

268 
MVM_DEBUGFS_BF_TEMP_THRESHOLD
:

269 
dbgfs_bf
->
bf_ãmp_thªshﬁd
 = 
vÆue
;

271 
MVM_DEBUGFS_BF_TEMP_FAST_FILTER
:

272 
dbgfs_bf
->
bf_ãmp_Á°_fûãr
 = 
vÆue
;

274 
MVM_DEBUGFS_BF_TEMP_SLOW_FILTER
:

275 
dbgfs_bf
->
bf_ãmp_¶ow_fûãr
 = 
vÆue
;

277 
MVM_DEBUGFS_BF_ENABLE_BEACON_FILTER
:

278 
dbgfs_bf
->
bf_íabÀ_bóc⁄_fûãr
 = 
vÆue
;

280 
MVM_DEBUGFS_BF_DEBUG_FLAG
:

281 
dbgfs_bf
->
bf_debug_Êag
 = 
vÆue
;

283 
MVM_DEBUGFS_BF_ESCAPE_TIMER
:

284 
dbgfs_bf
->
bf_esˇ≥_timî
 = 
vÆue
;

286 
MVM_DEBUGFS_BA_ENABLE_BEACON_ABORT
:

287 
dbgfs_bf
->
ba_íabÀ_bóc⁄_ab‹t
 = 
vÆue
;

289 
MVM_DEBUGFS_BA_ESCAPE_TIMER
:

290 
dbgfs_bf
->
ba_esˇ≥_timî
 = 
vÆue
;

293 
	}
}

295 
ssize_t
 
	$iwl_dbgfs_bf_∑øms_wrôe
(
õì80211_vif
 *
vif
, *
buf
,

296 
size_t
 
cou¡
, 
loff_t
 *
µos
)

298 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

299 
iwl_mvm
 *
mvm
 = 
mvmvif
->mvm;

300 
iwl_dbgfs_bf_mask
 
∑øm
;

301 
vÆue
, 
ªt
 = 0;

303 i‡(!
	`°∫cmp
("bf_íîgy_dñè=", 
buf
, 16)) {

304 i‡(
	`ssˇnf
(
buf
+16, "%d", &
vÆue
) != 1)

305  -
EINVAL
;

306 i‡(
vÆue
 < 
IWL_BF_ENERGY_DELTA_MIN
 ||

307 
vÆue
 > 
IWL_BF_ENERGY_DELTA_MAX
)

308  -
EINVAL
;

309 
∑øm
 = 
MVM_DEBUGFS_BF_ENERGY_DELTA
;

310 } i‡(!
	`°∫cmp
("bf_rﬂmög_íîgy_dñè=", 
buf
, 24)) {

311 i‡(
	`ssˇnf
(
buf
+24, "%d", &
vÆue
) != 1)

312  -
EINVAL
;

313 i‡(
vÆue
 < 
IWL_BF_ROAMING_ENERGY_DELTA_MIN
 ||

314 
vÆue
 > 
IWL_BF_ROAMING_ENERGY_DELTA_MAX
)

315  -
EINVAL
;

316 
∑øm
 = 
MVM_DEBUGFS_BF_ROAMING_ENERGY_DELTA
;

317 } i‡(!
	`°∫cmp
("bf_rﬂmög_°©e=", 
buf
, 17)) {

318 i‡(
	`ssˇnf
(
buf
+17, "%d", &
vÆue
) != 1)

319  -
EINVAL
;

320 i‡(
vÆue
 < 
IWL_BF_ROAMING_STATE_MIN
 ||

321 
vÆue
 > 
IWL_BF_ROAMING_STATE_MAX
)

322  -
EINVAL
;

323 
∑øm
 = 
MVM_DEBUGFS_BF_ROAMING_STATE
;

324 } i‡(!
	`°∫cmp
("bf_ãmp_thªshﬁd=", 
buf
, 18)) {

325 i‡(
	`ssˇnf
(
buf
+18, "%d", &
vÆue
) != 1)

326  -
EINVAL
;

327 i‡(
vÆue
 < 
IWL_BF_TEMP_THRESHOLD_MIN
 ||

328 
vÆue
 > 
IWL_BF_TEMP_THRESHOLD_MAX
)

329  -
EINVAL
;

330 
∑øm
 = 
MVM_DEBUGFS_BF_TEMP_THRESHOLD
;

331 } i‡(!
	`°∫cmp
("bf_ãmp_Á°_fûãr=", 
buf
, 20)) {

332 i‡(
	`ssˇnf
(
buf
+20, "%d", &
vÆue
) != 1)

333  -
EINVAL
;

334 i‡(
vÆue
 < 
IWL_BF_TEMP_FAST_FILTER_MIN
 ||

335 
vÆue
 > 
IWL_BF_TEMP_FAST_FILTER_MAX
)

336  -
EINVAL
;

337 
∑øm
 = 
MVM_DEBUGFS_BF_TEMP_FAST_FILTER
;

338 } i‡(!
	`°∫cmp
("bf_ãmp_¶ow_fûãr=", 
buf
, 20)) {

339 i‡(
	`ssˇnf
(
buf
+20, "%d", &
vÆue
) != 1)

340  -
EINVAL
;

341 i‡(
vÆue
 < 
IWL_BF_TEMP_SLOW_FILTER_MIN
 ||

342 
vÆue
 > 
IWL_BF_TEMP_SLOW_FILTER_MAX
)

343  -
EINVAL
;

344 
∑øm
 = 
MVM_DEBUGFS_BF_TEMP_SLOW_FILTER
;

345 } i‡(!
	`°∫cmp
("bf_íabÀ_bóc⁄_fûãr=", 
buf
, 24)) {

346 i‡(
	`ssˇnf
(
buf
+24, "%d", &
vÆue
) != 1)

347  -
EINVAL
;

348 i‡(
vÆue
 < 0 || value > 1)

349  -
EINVAL
;

350 
∑øm
 = 
MVM_DEBUGFS_BF_ENABLE_BEACON_FILTER
;

351 } i‡(!
	`°∫cmp
("bf_debug_Êag=", 
buf
, 14)) {

352 i‡(
	`ssˇnf
(
buf
+14, "%d", &
vÆue
) != 1)

353  -
EINVAL
;

354 i‡(
vÆue
 < 0 || value > 1)

355  -
EINVAL
;

356 
∑øm
 = 
MVM_DEBUGFS_BF_DEBUG_FLAG
;

357 } i‡(!
	`°∫cmp
("bf_esˇ≥_timî=", 
buf
, 16)) {

358 i‡(
	`ssˇnf
(
buf
+16, "%d", &
vÆue
) != 1)

359  -
EINVAL
;

360 i‡(
vÆue
 < 
IWL_BF_ESCAPE_TIMER_MIN
 ||

361 
vÆue
 > 
IWL_BF_ESCAPE_TIMER_MAX
)

362  -
EINVAL
;

363 
∑øm
 = 
MVM_DEBUGFS_BF_ESCAPE_TIMER
;

364 } i‡(!
	`°∫cmp
("ba_esˇ≥_timî=", 
buf
, 16)) {

365 i‡(
	`ssˇnf
(
buf
+16, "%d", &
vÆue
) != 1)

366  -
EINVAL
;

367 i‡(
vÆue
 < 
IWL_BA_ESCAPE_TIMER_MIN
 ||

368 
vÆue
 > 
IWL_BA_ESCAPE_TIMER_MAX
)

369  -
EINVAL
;

370 
∑øm
 = 
MVM_DEBUGFS_BA_ESCAPE_TIMER
;

371 } i‡(!
	`°∫cmp
("ba_íabÀ_bóc⁄_ab‹t=", 
buf
, 23)) {

372 i‡(
	`ssˇnf
(
buf
+23, "%d", &
vÆue
) != 1)

373  -
EINVAL
;

374 i‡(
vÆue
 < 0 || value > 1)

375  -
EINVAL
;

376 
∑øm
 = 
MVM_DEBUGFS_BA_ENABLE_BEACON_ABORT
;

378  -
EINVAL
;

381 
	`muãx_lock
(&
mvm
->
muãx
);

382 
	`iwl_dbgfs_upd©e_bf
(
vif
, 
∑øm
, 
vÆue
);

383 i‡(
∑øm
 =
MVM_DEBUGFS_BF_ENABLE_BEACON_FILTER
 && !
vÆue
)

384 
ªt
 = 
	`iwl_mvm_dißbÀ_bóc⁄_fûãr
(
mvm
, 
vif
);

386 
ªt
 = 
	`iwl_mvm_íabÀ_bóc⁄_fûãr
(
mvm
, 
vif
);

387 
	`muãx_u∆ock
(&
mvm
->
muãx
);

389  
ªt
 ?: 
cou¡
;

390 
	}
}

392 
ssize_t
 
	$iwl_dbgfs_bf_∑øms_ªad
(
fûe
 *file,

393 
__u£r
 *
u£r_buf
,

394 
size_t
 
cou¡
, 
loff_t
 *
µos
)

396 
õì80211_vif
 *
vif
 = 
fûe
->
¥iv©e_d©a
;

397 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

398 
buf
[256];

399 
pos
 = 0;

400 c⁄° 
size_t
 
bufsz
 = (
buf
);

401 
iwl_bóc⁄_fûãr_cmd
 
cmd
 = {

402 
IWL_BF_CMD_CONFIG_DEFAULTS
,

403 .
bf_íabÀ_bóc⁄_fûãr
 =

404 
	`˝u_to_À32
(
IWL_BF_ENABLE_BEACON_FILTER_DEFAULT
),

405 .
ba_íabÀ_bóc⁄_ab‹t
 =

406 
	`˝u_to_À32
(
IWL_BA_ENABLE_BEACON_ABORT_DEFAULT
),

409 
	`iwl_mvm_bóc⁄_fûãr_debugfs_∑ømëîs
(
vif
, &
cmd
);

410 i‡(
mvmvif
->
bf_d©a
.
bf_íabÀd
)

411 
cmd
.
bf_íabÀ_bóc⁄_fûãr
 = 
	`˝u_to_À32
(1);

413 
cmd
.
bf_íabÀ_bóc⁄_fûãr
 = 0;

415 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "bf_energy_delta = %d\n",

416 
	`À32_to_˝u
(
cmd
.
bf_íîgy_dñè
));

417 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "bf_roaming_energy_delta = %d\n",

418 
	`À32_to_˝u
(
cmd
.
bf_rﬂmög_íîgy_dñè
));

419 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "bf_roaming_state = %d\n",

420 
	`À32_to_˝u
(
cmd
.
bf_rﬂmög_°©e
));

421 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "bf_temp_threshold = %d\n",

422 
	`À32_to_˝u
(
cmd
.
bf_ãmp_thªshﬁd
));

423 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "bf_temp_fast_filter = %d\n",

424 
	`À32_to_˝u
(
cmd
.
bf_ãmp_Á°_fûãr
));

425 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "bf_temp_slow_filter = %d\n",

426 
	`À32_to_˝u
(
cmd
.
bf_ãmp_¶ow_fûãr
));

427 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "bf_enable_beacon_filter = %d\n",

428 
	`À32_to_˝u
(
cmd
.
bf_íabÀ_bóc⁄_fûãr
));

429 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "bf_debug_flag = %d\n",

430 
	`À32_to_˝u
(
cmd
.
bf_debug_Êag
));

431 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "bf_escape_timer = %d\n",

432 
	`À32_to_˝u
(
cmd
.
bf_esˇ≥_timî
));

433 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "ba_escape_timer = %d\n",

434 
	`À32_to_˝u
(
cmd
.
ba_esˇ≥_timî
));

435 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "ba_enable_beacon_abort = %d\n",

436 
	`À32_to_˝u
(
cmd
.
ba_íabÀ_bóc⁄_ab‹t
));

438  
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buf
, 
pos
);

439 
	}
}

441 
ssize_t
 
	$iwl_dbgfs_os_devi˚_timediff_ªad
(
fûe
 *file,

442 
__u£r
 *
u£r_buf
,

443 
size_t
 
cou¡
, 
loff_t
 *
µos
)

445 
õì80211_vif
 *
vif
 = 
fûe
->
¥iv©e_d©a
;

446 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

447 
iwl_mvm
 *
mvm
 = 
mvmvif
->mvm;

448 
u32
 
cuº_gp2
;

449 
u64
 
cuº_os
;

450 
s64
 
diff
;

451 
buf
[64];

452 c⁄° 
size_t
 
bufsz
 = (
buf
);

453 
pos
 = 0;

455 
	`muãx_lock
(&
mvm
->
muãx
);

456 
	`iwl_mvm_gë_sync_time
(
mvm
, 
CLOCK_BOOTTIME
, &
cuº_gp2
, &
cuº_os
, 
NULL
);

457 
	`muãx_u∆ock
(&
mvm
->
muãx
);

459 
	`do_div
(
cuº_os
, 
NSEC_PER_USEC
);

460 
diff
 = 
cuº_os
 - 
cuº_gp2
;

461 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
bufsz
 -Öos, "diff=%Œd\n", 
diff
);

463  
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buf
, 
pos
);

464 
	}
}

466 
ssize_t
 
	$iwl_dbgfs_low_œãncy_wrôe
(
õì80211_vif
 *
vif
, *
buf
,

467 
size_t
 
cou¡
, 
loff_t
 *
µos
)

469 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

470 
iwl_mvm
 *
mvm
 = 
mvmvif
->mvm;

471 
u8
 
vÆue
;

472 
ªt
;

474 
ªt
 = 
	`k°πou8
(
buf
, 0, &
vÆue
);

475 i‡(
ªt
)

476  
ªt
;

477 i‡(
vÆue
 > 1)

478  -
EINVAL
;

480 
	`muãx_lock
(&
mvm
->
muãx
);

481 
	`iwl_mvm_upd©e_low_œãncy
(
mvm
, 
vif
, 
vÆue
, 
LOW_LATENCY_DEBUGFS
);

482 
	`muãx_u∆ock
(&
mvm
->
muãx
);

484  
cou¡
;

485 
	}
}

487 
ssize_t


488 
	$iwl_dbgfs_low_œãncy_f‹˚_wrôe
(
õì80211_vif
 *
vif
, *
buf
,

489 
size_t
 
cou¡
, 
loff_t
 *
µos
)

491 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

492 
iwl_mvm
 *
mvm
 = 
mvmvif
->mvm;

493 
u8
 
vÆue
;

494 
ªt
;

496 
ªt
 = 
	`k°πou8
(
buf
, 0, &
vÆue
);

497 i‡(
ªt
)

498  
ªt
;

500 i‡(
vÆue
 > 
NUM_LOW_LATENCY_FORCE
)

501  -
EINVAL
;

503 
	`muãx_lock
(&
mvm
->
muãx
);

504 i‡(
vÆue
 =
LOW_LATENCY_FORCE_UNSET
) {

505 
	`iwl_mvm_upd©e_low_œãncy
(
mvm
, 
vif
, 
Ál£
,

506 
LOW_LATENCY_DEBUGFS_FORCE
);

507 
	`iwl_mvm_upd©e_low_œãncy
(
mvm
, 
vif
, 
Ál£
,

508 
LOW_LATENCY_DEBUGFS_FORCE_ENABLE
);

510 
	`iwl_mvm_upd©e_low_œãncy
(
mvm
, 
vif
,

511 
vÆue
 =
LOW_LATENCY_FORCE_ON
,

512 
LOW_LATENCY_DEBUGFS_FORCE
);

513 
	`iwl_mvm_upd©e_low_œãncy
(
mvm
, 
vif
, 
åue
,

514 
LOW_LATENCY_DEBUGFS_FORCE_ENABLE
);

516 
	`muãx_u∆ock
(&
mvm
->
muãx
);

517  
cou¡
;

518 
	}
}

520 
ssize_t
 
	$iwl_dbgfs_low_œãncy_ªad
(
fûe
 *file,

521 
__u£r
 *
u£r_buf
,

522 
size_t
 
cou¡
, 
loff_t
 *
µos
)

524 
õì80211_vif
 *
vif
 = 
fûe
->
¥iv©e_d©a
;

525 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

526 
f‹m©
[] = "traffic=%d\ndbgfs=%d\nvcmd=%d\nvif_type=%d\n"

533 
buf
[(
f‹m©
) + 1] = {};

534 
Àn
;

536 
Àn
 = 
	`s˙¥ötf
(
buf
, (bufË- 1, 
f‹m©
,

537 !!(
mvmvif
->
low_œãncy
 & 
LOW_LATENCY_TRAFFIC
),

538 !!(
mvmvif
->
low_œãncy
 & 
LOW_LATENCY_DEBUGFS
),

539 !!(
mvmvif
->
low_œãncy
 & 
LOW_LATENCY_VCMD
),

540 !!(
mvmvif
->
low_œãncy
 & 
LOW_LATENCY_VIF_TYPE
),

541 !!(
mvmvif
->
low_œãncy
 &

542 
LOW_LATENCY_DEBUGFS_FORCE_ENABLE
),

543 !!(
mvmvif
->
low_œãncy
 & 
LOW_LATENCY_DEBUGFS_FORCE
),

544 !!(
mvmvif
->
low_œãncy_a˘uÆ
));

545  
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buf
, 
Àn
);

546 
	}
}

548 
ssize_t
 
	$iwl_dbgfs_u≠sd_misbehavög_ªad
(
fûe
 *file,

549 
__u£r
 *
u£r_buf
,

550 
size_t
 
cou¡
, 
loff_t
 *
µos
)

552 
õì80211_vif
 *
vif
 = 
fûe
->
¥iv©e_d©a
;

553 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

554 
buf
[20];

555 
Àn
;

557 
Àn
 = 
	`•rötf
(
buf
, "%pM\n", 
mvmvif
->
u≠sd_misbehavög_≠_addr
);

558  
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buf
, 
Àn
);

559 
	}
}

561 
ssize_t
 
	$iwl_dbgfs_u≠sd_misbehavög_wrôe
(
õì80211_vif
 *
vif
,

562 *
buf
, 
size_t
 
cou¡
,

563 
loff_t
 *
µos
)

565 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

566 
iwl_mvm
 *
mvm
 = 
mvmvif
->mvm;

567 
boﬁ
 
ªt
;

569 
	`muãx_lock
(&
mvm
->
muãx
);

570 
ªt
 = 
	`mac_±⁄
(
buf
, 
mvmvif
->
u≠sd_misbehavög_≠_addr
);

571 
	`muãx_u∆ock
(&
mvm
->
muãx
);

573  
ªt
 ? 
cou¡
 : -
EINVAL
;

574 
	}
}

576 
ssize_t
 
	$iwl_dbgfs_rx_phyöfo_wrôe
(
õì80211_vif
 *
vif
, *
buf
,

577 
size_t
 
cou¡
, 
loff_t
 *
µos
)

579 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

580 
iwl_mvm
 *
mvm
 = 
mvmvif
->mvm;

581 
õì80211_bss_c⁄f
 *
lök_c⁄f
;

582 
u16
 
vÆue
;

583 
lök_id
, 
ªt
 = -
EINVAL
;

585 
ªt
 = 
	`k°πou16
(
buf
, 0, &
vÆue
);

586 i‡(
ªt
)

587  
ªt
;

589 
	`muãx_lock
(&
mvm
->
muãx
);

591 
mvm
->
dbgfs_rx_phyöfo
 = 
vÆue
;

593 
	`f‹_óch_vif_a˘ive_lök
(
vif
, 
lök_c⁄f
, 
lök_id
) {

594 
õì80211_ch™˘x_c⁄f
 *
ch™˘x_c⁄f
;

595 
cfg80211_ch™_def
 
mö_def
, 
≠_def
;

596 
iwl_mvm_phy_˘xt
 *
phy_˘xt
;

597 
u8
 
chaös_°©ic
, 
chaös_dy«mic
;

599 
	`rcu_ªad_lock
();

600 
ch™˘x_c⁄f
 = 
	`rcu_dîe„ªn˚
(
lök_c⁄f
->chanctx_conf);

601 i‡(!
ch™˘x_c⁄f
) {

602 
	`rcu_ªad_u∆ock
();

608 
mö_def
 = 
ch™˘x_c⁄f
->min_def;

609 
≠_def
 = 
ch™˘x_c⁄f
->
≠
;

610 
chaös_°©ic
 = 
ch™˘x_c⁄f
->
rx_chaös_°©ic
;

611 
chaös_dy«mic
 = 
ch™˘x_c⁄f
->
rx_chaös_dy«mic
;

612 
	`rcu_ªad_u∆ock
();

614 
phy_˘xt
 = 
mvmvif
->
lök
[
lök_id
]->phy_ctxt;

615 i‡(!
phy_˘xt
)

618 
ªt
 = 
	`iwl_mvm_phy_˘xt_ch™ged
(
mvm
, 
phy_˘xt
, &
mö_def
, &
≠_def
,

619 
chaös_°©ic
, 
chaös_dy«mic
);

622 
	`muãx_u∆ock
(&
mvm
->
muãx
);

624  
ªt
 ?: 
cou¡
;

625 
	}
}

627 
ssize_t
 
	$iwl_dbgfs_rx_phyöfo_ªad
(
fûe
 *file,

628 
__u£r
 *
u£r_buf
,

629 
size_t
 
cou¡
, 
loff_t
 *
µos
)

631 
õì80211_vif
 *
vif
 = 
fûe
->
¥iv©e_d©a
;

632 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

633 
buf
[8];

634 
Àn
;

636 
Àn
 = 
	`s˙¥ötf
(
buf
, (buf), "0x%04x\n",

637 
mvmvif
->
mvm
->
dbgfs_rx_phyöfo
);

639  
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buf
, 
Àn
);

640 
	}
}

642 
	$iwl_dbgfs_quŸa_check
(*
d©a
, 
u8
 *
mac
,

643 
õì80211_vif
 *
vif
)

645 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

646 *
ªt
 = 
d©a
;

648 i‡(
mvmvif
->
dbgfs_quŸa_mö
)

649 *
ªt
 = -
EINVAL
;

650 
	}
}

652 
ssize_t
 
	$iwl_dbgfs_quŸa_mö_wrôe
(
õì80211_vif
 *
vif
, *
buf
,

653 
size_t
 
cou¡
, 
loff_t
 *
µos
)

655 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

656 
iwl_mvm
 *
mvm
 = 
mvmvif
->mvm;

657 
u16
 
vÆue
;

658 
ªt
;

660 
ªt
 = 
	`k°πou16
(
buf
, 0, &
vÆue
);

661 i‡(
ªt
)

662  
ªt
;

664 i‡(
vÆue
 > 95)

665  -
EINVAL
;

667 
	`muãx_lock
(&
mvm
->
muãx
);

669 
mvmvif
->
dbgfs_quŸa_mö
 = 0;

670 
	`õì80211_ôî©e_öãrÁ˚s
(
mvm
->
hw
, 
IEEE80211_IFACE_ITER_NORMAL
,

671 
iwl_dbgfs_quŸa_check
, &
ªt
);

672 i‡(
ªt
 == 0) {

673 
mvmvif
->
dbgfs_quŸa_mö
 = 
vÆue
;

674 
	`iwl_mvm_upd©e_quŸas
(
mvm
, 
Ál£
, 
NULL
);

676 
	`muãx_u∆ock
(&
mvm
->
muãx
);

678  
ªt
 ?: 
cou¡
;

679 
	}
}

681 
ssize_t
 
	$iwl_dbgfs_quŸa_mö_ªad
(
fûe
 *file,

682 
__u£r
 *
u£r_buf
,

683 
size_t
 
cou¡
, 
loff_t
 *
µos
)

685 
õì80211_vif
 *
vif
 = 
fûe
->
¥iv©e_d©a
;

686 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

687 
buf
[10];

688 
Àn
;

690 
Àn
 = 
	`s˙¥ötf
(
buf
, (buf), "%d\n", 
mvmvif
->
dbgfs_quŸa_mö
);

692  
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buf
, 
Àn
);

693 
	}
}

695 
	#MVM_DEBUGFS_WRITE_FILE_OPS
(
«me
, 
bufsz
) \

696 
	`_MVM_DEBUGFS_WRITE_FILE_OPS
(
«me
, 
bufsz
, 
õì80211_vif
)

	)

697 
	#MVM_DEBUGFS_READ_WRITE_FILE_OPS
(
«me
, 
bufsz
) \

698 
	`_MVM_DEBUGFS_READ_WRITE_FILE_OPS
(
«me
, 
bufsz
, 
õì80211_vif
)

	)

699 
	#MVM_DEBUGFS_ADD_FILE_VIF
(
«me
, 
∑ª¡
, 
mode
) do { \

700 
	`debugfs_¸óã_fûe
(#«me, 
mode
, 
∑ª¡
, 
vif
, \

701 &
iwl_dbgfs_
##
«me
##
_›s
); \

702 } 0)

	)

704 
MVM_DEBUGFS_READ_FILE_OPS
(
mac_∑øms
);

705 
MVM_DEBUGFS_READ_FILE_OPS
(
tx_pwr_lmt
);

706 
MVM_DEBUGFS_READ_WRITE_FILE_OPS
(
pm_∑øms
, 32);

707 
MVM_DEBUGFS_READ_WRITE_FILE_OPS
(
bf_∑øms
, 256);

708 
MVM_DEBUGFS_READ_WRITE_FILE_OPS
(
low_œãncy
, 10);

709 
MVM_DEBUGFS_WRITE_FILE_OPS
(
low_œãncy_f‹˚
, 10);

710 
MVM_DEBUGFS_READ_WRITE_FILE_OPS
(
u≠sd_misbehavög
, 20);

711 
MVM_DEBUGFS_READ_WRITE_FILE_OPS
(
rx_phyöfo
, 10);

712 
MVM_DEBUGFS_READ_WRITE_FILE_OPS
(
quŸa_mö
, 32);

713 
MVM_DEBUGFS_READ_FILE_OPS
(
os_devi˚_timediff
);

715 
	$iwl_mvm_vif_add_debugfs
(
õì80211_hw
 *
hw
, 
õì80211_vif
 *
vif
)

717 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

718 
díåy
 *
dbgfs_dú
 = 
vif
->
debugfs_dú
;

719 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

721 
mvmvif
->
dbgfs_dú
 = 
	`debugfs_¸óã_dú
("iwlmvm", dbgfs_dir);

722 i‡(
	`IS_ERR_OR_NULL
(
mvmvif
->
dbgfs_dú
)) {

723 
	`IWL_ERR
(
mvm
, "FailedÅo create debugfs directory under %pd\n",

724 
dbgfs_dú
);

728 i‡(
iwlmvm_mod_∑øms
.
powî_scheme
 !
IWL_POWER_SCHEME_CAM
 &&

729 ((
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
 && !vif->
p2p
) ||

730 (
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
 && vif->
p2p
)))

731 
	`MVM_DEBUGFS_ADD_FILE_VIF
(
pm_∑øms
, 
mvmvif
->
dbgfs_dú
, 0600);

733 
	`MVM_DEBUGFS_ADD_FILE_VIF
(
tx_pwr_lmt
, 
mvmvif
->
dbgfs_dú
, 0400);

734 
	`MVM_DEBUGFS_ADD_FILE_VIF
(
mac_∑øms
, 
mvmvif
->
dbgfs_dú
, 0400);

735 
	`MVM_DEBUGFS_ADD_FILE_VIF
(
low_œãncy
, 
mvmvif
->
dbgfs_dú
, 0600);

736 
	`MVM_DEBUGFS_ADD_FILE_VIF
(
low_œãncy_f‹˚
, 
mvmvif
->
dbgfs_dú
, 0600);

737 
	`MVM_DEBUGFS_ADD_FILE_VIF
(
u≠sd_misbehavög
, 
mvmvif
->
dbgfs_dú
, 0600);

738 
	`MVM_DEBUGFS_ADD_FILE_VIF
(
rx_phyöfo
, 
mvmvif
->
dbgfs_dú
, 0600);

739 
	`MVM_DEBUGFS_ADD_FILE_VIF
(
quŸa_mö
, 
mvmvif
->
dbgfs_dú
, 0600);

740 
	`MVM_DEBUGFS_ADD_FILE_VIF
(
os_devi˚_timediff
, 
mvmvif
->
dbgfs_dú
, 0400);

742 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
 && !vif->
p2p
 &&

743 
mvmvif
 =
mvm
->
bf_Ælowed_vif
)

744 
	`MVM_DEBUGFS_ADD_FILE_VIF
(
bf_∑øms
, 
mvmvif
->
dbgfs_dú
, 0600);

745 
	}
}

747 
	$iwl_mvm_vif_dbgfs_add_lök
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

749 
díåy
 *
dbgfs_dú
 = 
vif
->
debugfs_dú
;

750 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

751 
buf
[3 * 3 + 11 + (
NL80211_WIPHY_NAME_MAXLEN
 + 1) +

752 (7 + 
IFNAMSIZ
 + 1) + 6 + 1];

753 
«me
[7 + 
IFNAMSIZ
 + 1];

756 i‡(!
dbgfs_dú
)

766 
	`¢¥ötf
(
«me
, “ame), "%pd", 
dbgfs_dú
);

767 
	`¢¥ötf
(
buf
, (buf), "../../../%pd3/iwlmvm", 
dbgfs_dú
);

769 
mvmvif
->
dbgfs_¶ök
 =

770 
	`debugfs_¸óã_symlök
(
«me
, 
mvm
->
debugfs_dú
, 
buf
);

771 
	}
}

773 
	$iwl_mvm_vif_dbgfs_rm_lök
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

775 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

777 
	`debugfs_ªmove
(
mvmvif
->
dbgfs_¶ök
);

778 
mvmvif
->
dbgfs_¶ök
 = 
NULL
;

779 
	}
}

781 
	#MVM_DEBUGFS_WRITE_LINK_FILE_OPS
(
«me
, 
bufsz
) \

782 
	`_MVM_DEBUGFS_WRITE_FILE_OPS
(
lök_
##
«me
, 
bufsz
, \

783 
õì80211_bss_c⁄f
)

	)

784 
	#MVM_DEBUGFS_READ_WRITE_LINK_FILE_OPS
(
«me
, 
bufsz
) \

785 
	`_MVM_DEBUGFS_READ_WRITE_FILE_OPS
(
lök_
##
«me
, 
bufsz
, \

786 
õì80211_bss_c⁄f
)

	)

787 
	#MVM_DEBUGFS_ADD_LINK_FILE
(
«me
, 
∑ª¡
, 
mode
) \

788 
	`debugfs_¸óã_fûe
(#«me, 
mode
, 
∑ª¡
, 
lök_c⁄f
, \

789 &
iwl_dbgfs_lök_
##
«me
##
_›s
)

	)

791 
	$iwl_mvm_debugfs_add_lök_fûes
(
õì80211_vif
 *
vif
,

792 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

793 
díåy
 *
mvm_dú
)

796 
	}
}

798 
	$iwl_mvm_lök_add_debugfs
(
õì80211_hw
 *
hw
,

799 
õì80211_vif
 *
vif
,

800 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

801 
díåy
 *
dú
)

803 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

804 
iwl_mvm
 *
mvm
 = 
mvmvif
->mvm;

805 
lök_id
 = 
lök_c⁄f
->link_id;

806 
iwl_mvm_vif_lök_öfo
 *
lök_öfo
 = 
mvmvif
->
lök
[
lök_id
];

807 
díåy
 *
mvm_dú
;

809 i‡(
	`WARN_ON
(!
lök_öfo
Ë|| !
dú
)

812 i‡(
dú
 =
vif
->
debugfs_dú
) {

813 
	`WARN_ON
(!
mvmvif
->
dbgfs_dú
);

814 
mvm_dú
 = 
mvmvif
->
dbgfs_dú
;

816 
mvm_dú
 = 
	`debugfs_¸óã_dú
("iwlmvm", 
dú
);

817 i‡(
	`IS_ERR_OR_NULL
(
mvm_dú
)) {

818 
	`IWL_ERR
(
mvm
, "FailedÅo create debugfs directory under %pd\n",

819 
dú
);

824 
	`iwl_mvm_debugfs_add_lök_fûes
(
vif
, 
lök_c⁄f
, 
mvm_dú
);

825 
	}
}

	@debugfs.c

7 
	~<löux/vmÆloc.h
>

8 
	~<löux/îr.h
>

9 
	~<löux/õì80211.h
>

10 
	~<löux/√tdevi˚.h
>

11 
	~<löux/dmi.h
>

13 
	~"mvm.h
"

14 
	~"°a.h
"

15 
	~"iwl-io.h
"

16 
	~"debugfs.h
"

17 
	~"iwl-mod∑øms.h
"

18 
	~"iwl-drv.h
"

19 
	~"fw/îr‹-dump.h
"

20 
	~"fw/≠i/phy-˘xt.h
"

22 
ssize_t
 
	$iwl_dbgfs_˘dp_budgë_ªad
(
fûe
 *file,

23 
__u£r
 *
u£r_buf
,

24 
size_t
 
cou¡
, 
loff_t
 *
µos
)

26 
iwl_mvm
 *
mvm
 = 
fûe
->
¥iv©e_d©a
;

27 
buf
[16];

28 
pos
, 
budgë
;

30 i‡(!
	`iwl_mvm_is_˘dp_suµ‹ãd
(
mvm
))

31  -
EOPNOTSUPP
;

33 i‡(!
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
) ||

34 
mvm
->
fwπ
.
cur_fw_img
 !
IWL_UCODE_REGULAR
)

35  -
EIO
;

37 
	`muãx_lock
(&
mvm
->
muãx
);

38 
budgë
 = 
	`iwl_mvm_˘dp_comm™d
(
mvm
, 
CTDP_CMD_OPERATION_REPORT
, 0);

39 
	`muãx_u∆ock
(&
mvm
->
muãx
);

41 i‡(
budgë
 < 0)

42  
budgë
;

44 
pos
 = 
	`s˙¥ötf
(
buf
, (buf), "%d\n", 
budgë
);

46  
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buf
, 
pos
);

47 
	}
}

49 
ssize_t
 
	$iwl_dbgfs_°›_˘dp_wrôe
(
iwl_mvm
 *
mvm
, *
buf
,

50 
size_t
 
cou¡
, 
loff_t
 *
µos
)

52 
ªt
;

53 
boﬁ
 
f‹˚
;

55 i‡(!
	`k°πoboﬁ
(
buf
, &
f‹˚
))

56 
	`IWL_DEBUG_INFO
(
mvm
,

58 
f‹˚
);

64 i‡(!
f‹˚
 && !
	`iwl_mvm_is_˘dp_suµ‹ãd
(
mvm
))

65  -
EOPNOTSUPP
;

67 i‡(!
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
) ||

68 
mvm
->
fwπ
.
cur_fw_img
 !
IWL_UCODE_REGULAR
)

69  -
EIO
;

71 
	`muãx_lock
(&
mvm
->
muãx
);

72 
ªt
 = 
	`iwl_mvm_˘dp_comm™d
(
mvm
, 
CTDP_CMD_OPERATION_STOP
, 0);

73 
	`muãx_u∆ock
(&
mvm
->
muãx
);

75  
ªt
 ?: 
cou¡
;

76 
	}
}

78 
ssize_t
 
	$iwl_dbgfs_°¨t_˘dp_wrôe
(
iwl_mvm
 *
mvm
,

79 *
buf
, 
size_t
 
cou¡
,

80 
loff_t
 *
µos
)

82 
ªt
;

83 
boﬁ
 
f‹˚
;

85 i‡(!
	`k°πoboﬁ
(
buf
, &
f‹˚
))

86 
	`IWL_DEBUG_INFO
(
mvm
,

88 
f‹˚
);

94 i‡(!
f‹˚
 && !
	`iwl_mvm_is_˘dp_suµ‹ãd
(
mvm
))

95  -
EOPNOTSUPP
;

97 i‡(!
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
) ||

98 
mvm
->
fwπ
.
cur_fw_img
 !
IWL_UCODE_REGULAR
)

99  -
EIO
;

101 
	`muãx_lock
(&
mvm
->
muãx
);

102 
ªt
 = 
	`iwl_mvm_˘dp_comm™d
(
mvm
, 
CTDP_CMD_OPERATION_START
, 0);

103 
	`muãx_u∆ock
(&
mvm
->
muãx
);

105  
ªt
 ?: 
cou¡
;

106 
	}
}

108 
ssize_t
 
	$iwl_dbgfs_f‹˚_˘kûl_wrôe
(
iwl_mvm
 *
mvm
, *
buf
,

109 
size_t
 
cou¡
, 
loff_t
 *
µos
)

111 i‡(!
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
) ||

112 
mvm
->
fwπ
.
cur_fw_img
 !
IWL_UCODE_REGULAR
)

113  -
EIO
;

115 
	`iwl_mvm_íãr_˘kûl
(
mvm
);

117  
cou¡
;

118 
	}
}

120 
ssize_t
 
	$iwl_dbgfs_tx_Êush_wrôe
(
iwl_mvm
 *
mvm
, *
buf
,

121 
size_t
 
cou¡
, 
loff_t
 *
µos
)

123 
ªt
;

124 
u32
 
Êush_¨g
;

126 i‡(!
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
) ||

127 
mvm
->
fwπ
.
cur_fw_img
 !
IWL_UCODE_REGULAR
)

128  -
EIO
;

130 i‡(
	`k°πou32
(
buf
, 0, &
Êush_¨g
))

131  -
EINVAL
;

133 i‡(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)) {

134 
	`IWL_DEBUG_TX_QUEUES
(
mvm
,

136 
Êush_¨g
);

137 
	`muãx_lock
(&
mvm
->
muãx
);

138 
ªt
 = 
	`iwl_mvm_Êush_°a_tids
(
mvm
, 
Êush_¨g
, 0xFFFF)

139 ? : 
cou¡
;

140 
	`muãx_u∆ock
(&
mvm
->
muãx
);

141  
ªt
;

144 
	`IWL_DEBUG_TX_QUEUES
(
mvm
, "FLUSHING queues maskÅo flush = 0x%x\n",

145 
Êush_¨g
);

147 
	`muãx_lock
(&
mvm
->
muãx
);

148 
ªt
 = 
	`iwl_mvm_Êush_tx_∑th
(
mvm
, 
Êush_¨g
Ë? : 
cou¡
;

149 
	`muãx_u∆ock
(&
mvm
->
muãx
);

151  
ªt
;

152 
	}
}

154 
ssize_t
 
	$iwl_dbgfs_°a_døö_wrôe
(
iwl_mvm
 *
mvm
, *
buf
,

155 
size_t
 
cou¡
, 
loff_t
 *
µos
)

157 
iwl_mvm_°a
 *
mvm°a
;

158 
°a_id
, 
døö
, 
ªt
;

160 i‡(!
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
) ||

161 
mvm
->
fwπ
.
cur_fw_img
 !
IWL_UCODE_REGULAR
)

162  -
EIO
;

164 i‡(
	`ssˇnf
(
buf
, "%d %d", &
°a_id
, &
døö
) != 2)

165  -
EINVAL
;

166 i‡(
°a_id
 < 0 || sè_id >
mvm
->
fw
->
ucode_ˇ∑
.
num_°©i⁄s
)

167  -
EINVAL
;

168 i‡(
døö
 < 0 || drain > 1)

169  -
EINVAL
;

171 
	`muãx_lock
(&
mvm
->
muãx
);

173 
mvm°a
 = 
	`iwl_mvm_°a_‰om_°aid_¥Ÿe˘ed
(
mvm
, 
°a_id
);

175 i‡(!
mvm°a
)

176 
ªt
 = -
ENOENT
;

178 
ªt
 = 
	`iwl_mvm_døö_°a
(
mvm
, 
mvm°a
, 
døö
Ë? : 
cou¡
;

180 
	`muãx_u∆ock
(&
mvm
->
muãx
);

182  
ªt
;

183 
	}
}

185 
ssize_t
 
	$iwl_dbgfs_§am_ªad
(
fûe
 *fûe, 
__u£r
 *
u£r_buf
,

186 
size_t
 
cou¡
, 
loff_t
 *
µos
)

188 
iwl_mvm
 *
mvm
 = 
fûe
->
¥iv©e_d©a
;

189 c⁄° 
fw_img
 *
img
;

190 
ofs
, 
Àn
;

191 
size_t
 
ªt
;

192 
u8
 *
±r
;

194 i‡(!
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
))

195  -
EINVAL
;

198 
img
 = &
mvm
->
fw
->img[mvm->
fwπ
.
cur_fw_img
];

199 
ofs
 = 
img
->
£c
[
IWL_UCODE_SECTION_DATA
].
off£t
;

200 
Àn
 = 
img
->
£c
[
IWL_UCODE_SECTION_DATA
].len;

202 i‡(
mvm
->
dbgfs_§am_Àn
) {

203 
ofs
 = 
mvm
->
dbgfs_§am_off£t
;

204 
Àn
 = 
mvm
->
dbgfs_§am_Àn
;

207 
±r
 = 
	`kzÆloc
(
Àn
, 
GFP_KERNEL
);

208 i‡(!
±r
)

209  -
ENOMEM
;

211 
	`iwl_å™s_ªad_mem_byãs
(
mvm
->
å™s
, 
ofs
, 
±r
, 
Àn
);

213 
ªt
 = 
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
±r
, 
Àn
);

215 
	`k‰ì
(
±r
);

217  
ªt
;

218 
	}
}

220 
ssize_t
 
	$iwl_dbgfs_§am_wrôe
(
iwl_mvm
 *
mvm
, *
buf
,

221 
size_t
 
cou¡
, 
loff_t
 *
µos
)

223 c⁄° 
fw_img
 *
img
;

224 
u32
 
off£t
, 
Àn
;

225 
u32
 
img_off£t
, 
img_Àn
;

227 i‡(!
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
))

228  -
EINVAL
;

230 
img
 = &
mvm
->
fw
->img[mvm->
fwπ
.
cur_fw_img
];

231 
img_off£t
 = 
img
->
£c
[
IWL_UCODE_SECTION_DATA
].
off£t
;

232 
img_Àn
 = 
img
->
£c
[
IWL_UCODE_SECTION_DATA
].
Àn
;

234 i‡(
	`ssˇnf
(
buf
, "%x,%x", &
off£t
, &
Àn
) == 2) {

235 i‡((
off£t
 & 0x3Ë|| (
Àn
 & 0x3))

236  -
EINVAL
;

238 i‡(
off£t
 + 
Àn
 > 
img_off£t
 + 
img_Àn
)

239  -
EINVAL
;

241 
mvm
->
dbgfs_§am_off£t
 = 
off£t
;

242 
mvm
->
dbgfs_§am_Àn
 = 
Àn
;

244 
mvm
->
dbgfs_§am_off£t
 = 0;

245 
mvm
->
dbgfs_§am_Àn
 = 0;

248  
cou¡
;

249 
	}
}

251 
ssize_t
 
	$iwl_dbgfs_£t_nic_ãm≥øtuª_ªad
(
fûe
 *file,

252 
__u£r
 *
u£r_buf
,

253 
size_t
 
cou¡
, 
loff_t
 *
µos
)

255 
iwl_mvm
 *
mvm
 = 
fûe
->
¥iv©e_d©a
;

256 
buf
[16];

257 
pos
;

259 i‡(!
mvm
->
ãm≥øtuª_ã°
)

260 
pos
 = 
	`s˙¥ötf
(
buf
, (buf), "disabled\n");

262 
pos
 = 
	`s˙¥ötf
(
buf
, (buf), "%d\n", 
mvm
->
ãm≥øtuª
);

264  
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buf
, 
pos
);

265 
	}
}

274 
ssize_t
 
	$iwl_dbgfs_£t_nic_ãm≥øtuª_wrôe
(
iwl_mvm
 *
mvm
,

275 *
buf
, 
size_t
 
cou¡
,

276 
loff_t
 *
µos
)

278 
ãm≥øtuª
;

280 i‡(!
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
Ë&& !mvm->
ãm≥øtuª_ã°
)

281  -
EIO
;

283 i‡(
	`k°πoöt
(
buf
, 10, &
ãm≥øtuª
))

284  -
EINVAL
;

286 i‡((
ãm≥øtuª
 > 
IWL_MVM_DEBUG_SET_TEMPERATURE_MAX
 &&

287 
ãm≥øtuª
 !
IWL_MVM_DEBUG_SET_TEMPERATURE_DISABLE
) ||

288 
ãm≥øtuª
 < 
IWL_MVM_DEBUG_SET_TEMPERATURE_MIN
)

289  -
EINVAL
;

291 
	`muãx_lock
(&
mvm
->
muãx
);

292 i‡(
ãm≥øtuª
 =
IWL_MVM_DEBUG_SET_TEMPERATURE_DISABLE
) {

293 i‡(!
mvm
->
ãm≥øtuª_ã°
)

294 
out
;

296 
mvm
->
ãm≥øtuª_ã°
 = 
Ál£
;

301 
mvm
->
ãm≥øtuª
 = 0;

303 
mvm
->
ãm≥øtuª_ã°
 = 
åue
;

304 
mvm
->
ãm≥øtuª
 =Åemperature;

306 
	`IWL_DEBUG_TEMP
(
mvm
, "%sabling debug setÅemperature (temp = %d)\n",

307 
mvm
->
ãm≥øtuª_ã°
 ? "En" : "Dis",

308 
mvm
->
ãm≥øtuª
);

310 
	`iwl_mvm_â_h™dÀr
(
mvm
);

312 
out
:

313 
	`muãx_u∆ock
(&
mvm
->
muãx
);

315  
cou¡
;

316 
	}
}

318 
ssize_t
 
	$iwl_dbgfs_nic_ãmp_ªad
(
fûe
 *file,

319 
__u£r
 *
u£r_buf
,

320 
size_t
 
cou¡
, 
loff_t
 *
µos
)

322 
iwl_mvm
 *
mvm
 = 
fûe
->
¥iv©e_d©a
;

323 
buf
[16];

324 
pos
, 
ªt
;

325 
s32
 
ãmp
;

327 i‡(!
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
))

328  -
EIO
;

330 
	`muãx_lock
(&
mvm
->
muãx
);

331 
ªt
 = 
	`iwl_mvm_gë_ãmp
(
mvm
, &
ãmp
);

332 
	`muãx_u∆ock
(&
mvm
->
muãx
);

334 i‡(
ªt
)

335  -
EIO
;

337 
pos
 = 
	`s˙¥ötf
(
buf
, (buf), "%d\n", 
ãmp
);

339  
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buf
, 
pos
);

340 
	}
}

342 #ifde‡
CONFIG_ACPI


343 
ssize_t
 
	$iwl_dbgfs_ßr_geo_¥ofûe_ªad
(
fûe
 *file,

344 
__u£r
 *
u£r_buf
,

345 
size_t
 
cou¡
, 
loff_t
 *
µos
)

347 
iwl_mvm
 *
mvm
 = 
fûe
->
¥iv©e_d©a
;

348 
buf
[256];

349 
pos
 = 0;

350 
bufsz
 = (
buf
);

351 
tbl_idx
;

353 i‡(!
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
))

354  -
EIO
;

356 
	`muãx_lock
(&
mvm
->
muãx
);

357 
tbl_idx
 = 
	`iwl_mvm_gë_ßr_geo_¥ofûe
(
mvm
);

358 i‡(
tbl_idx
 < 0) {

359 
	`muãx_u∆ock
(&
mvm
->
muãx
);

360  
tbl_idx
;

363 i‡(!
tbl_idx
) {

364 
pos
 = 
	`s˙¥ötf
(
buf
, 
bufsz
,

367 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
bufsz
 -Öos,

368 "U£ geogøphi¯¥ofûê%d\n", 
tbl_idx
);

369 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
bufsz
 -Öos,

371 
mvm
->
fwπ
.
geo_¥ofûes
[
tbl_idx
 - 1].
b™ds
[0].
chaös
[0],

372 
mvm
->
fwπ
.
geo_¥ofûes
[
tbl_idx
 - 1].
b™ds
[0].
chaös
[1],

373 
mvm
->
fwπ
.
geo_¥ofûes
[
tbl_idx
 - 1].
b™ds
[0].
max
);

374 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
bufsz
 -Öos,

376 
mvm
->
fwπ
.
geo_¥ofûes
[
tbl_idx
 - 1].
b™ds
[1].
chaös
[0],

377 
mvm
->
fwπ
.
geo_¥ofûes
[
tbl_idx
 - 1].
b™ds
[1].
chaös
[1],

378 
mvm
->
fwπ
.
geo_¥ofûes
[
tbl_idx
 - 1].
b™ds
[1].
max
);

380 
	`muãx_u∆ock
(&
mvm
->
muãx
);

382  
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buf
, 
pos
);

383 
	}
}

385 
ssize_t
 
	$iwl_dbgfs_wifi_6e_íabÀ_ªad
(
fûe
 *file,

386 
__u£r
 *
u£r_buf
,

387 
size_t
 
cou¡
, 
loff_t
 *
µos
)

389 
iwl_mvm
 *
mvm
 = 
fûe
->
¥iv©e_d©a
;

390 
îr
, 
pos
;

391 
buf
[12];

392 
u32
 
vÆue
;

394 
îr
 = 
	`iwl_bios_gë_dsm
(&
mvm
->
fwπ
, 
DSM_FUNC_ENABLE_6E
, &
vÆue
);

395 i‡(
îr
)

396  
îr
;

398 
pos
 = 
	`•rötf
(
buf
, "0x%08x\n", 
vÆue
);

400  
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buf
, 
pos
);

401 
	}
}

404 
ssize_t
 
	$iwl_dbgfs_°©i⁄s_ªad
(
fûe
 *fûe, 
__u£r
 *
u£r_buf
,

405 
size_t
 
cou¡
, 
loff_t
 *
µos
)

407 
iwl_mvm
 *
mvm
 = 
fûe
->
¥iv©e_d©a
;

408 
õì80211_°a
 *
°a
;

409 
buf
[400];

410 
i
, 
pos
 = 0, 
bufsz
 = (
buf
);

412 
	`muãx_lock
(&
mvm
->
muãx
);

414 
i
 = 0; i < 
mvm
->
fw
->
ucode_ˇ∑
.
num_°©i⁄s
; i++) {

415 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
bufsz
 -Öos, "%.2d: ", 
i
);

416 
°a
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm
->
fw_id_to_mac_id
[
i
],

417 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

418 i‡(!
°a
)

419 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
bufsz
 -Öos, "N/A\n");

420 i‡(
	`IS_ERR
(
°a
))

421 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
bufsz
 -Öos, "%ld\n",

422 
	`PTR_ERR
(
°a
));

424 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
bufsz
 -Öos, "%pM\n",

425 
°a
->
addr
);

428 
	`muãx_u∆ock
(&
mvm
->
muãx
);

430  
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buf
, 
pos
);

431 
	}
}

433 
ssize_t
 
	$iwl_dbgfs_rs_d©a_ªad
(
õì80211_lök_°a
 *
lök_°a
,

434 
iwl_mvm_°a
 *
mvm°a
,

435 
iwl_mvm
 *
mvm
,

436 
iwl_mvm_lök_°a
 *
mvm_lök_°a
,

437 
__u£r
 *
u£r_buf
,

438 
size_t
 
cou¡
, 
loff_t
 *
µos
)

440 
iwl_lq_°a_rs_fw
 *
lq_°a
 = &
mvm_lök_°a
->lq_°a.
rs_fw
;

441 c⁄° 
size_t
 
bufsz
 = 2048;

442 *
buff
;

443 
desc
 = 0;

444 
ssize_t
 
ªt
;

446 
buff
 = 
	`kmÆloc
(
bufsz
, 
GFP_KERNEL
);

447 i‡(!
buff
)

448  -
ENOMEM
;

450 
desc
 +
	`s˙¥ötf
(
buff
 + desc, 
bufsz
 - desc, "sta_id %d\n",

451 
lq_°a
->
≥rs
.
°a_id
);

452 
desc
 +
	`s˙¥ötf
(
buff
 + desc, 
bufsz
 - desc,

454 
lq_°a
->
≥rs
.
dbg_fixed_øã
);

455 
desc
 +
	`s˙¥ötf
(
buff
 + desc, 
bufsz
 - desc,

457 
lq_°a
->
≥rs
.
dbg_agg_‰ame_cou¡_lim
);

458 
desc
 +
	`s˙¥ötf
(
buff
 + desc, 
bufsz
 - desc,

460 (
	`iwl_mvm_gë_vÆid_tx_™t
(
mvm
Ë& 
ANT_A
) ? "ANT_A," : "",

461 (
	`iwl_mvm_gë_vÆid_tx_™t
(
mvm
Ë& 
ANT_B
) ? "ANT_B," : "");

462 
desc
 +
	`s˙¥ötf
(
buff
 + desc, 
bufsz
 - desc,

464 
lq_°a
->
œ°_øã_n_Êags
);

466 
desc
 +
	`rs_¥ëty_¥öt_øã
(
buff
 + desc, 
bufsz
 - desc,

467 
lq_°a
->
œ°_øã_n_Êags
);

468 i‡(
desc
 < 
bufsz
 - 1)

469 
buff
[
desc
++] = '\n';

471 
ªt
 = 
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buff
, 
desc
);

472 
	`k‰ì
(
buff
);

473  
ªt
;

474 
	}
}

476 
ssize_t
 
	$iwl_dbgfs_amsdu_Àn_wrôe
(
õì80211_lök_°a
 *
lök_°a
,

477 
iwl_mvm_°a
 *
mvm°a
,

478 
iwl_mvm
 *
mvm
,

479 
iwl_mvm_lök_°a
 *
mvm_lök_°a
,

480 *
buf
, 
size_t
 
cou¡
,

481 
loff_t
 *
µos
)

483 
i
;

484 
u16
 
amsdu_Àn
;

486 i‡(
	`k°πou16
(
buf
, 0, &
amsdu_Àn
))

487  -
EINVAL
;

490 i‡(
amsdu_Àn
 && 
mvm_lök_°a
->
‹ig_amsdu_Àn
)

491  -
EBUSY
;

493 i‡(
amsdu_Àn
) {

494 
mvm_lök_°a
->
‹ig_amsdu_Àn
 = 
lök_°a
->
agg
.
max_amsdu_Àn
;

495 
lök_°a
->
agg
.
max_amsdu_Àn
 = 
amsdu_Àn
;

496 
lök_°a
->
agg
.
max_amsdu_Àn
 = 
amsdu_Àn
;

497 
i
 = 0; i < 
	`ARRAY_SIZE
(
lök_°a
->
agg
.
max_tid_amsdu_Àn
); i++)

498 
lök_°a
->
agg
.
max_tid_amsdu_Àn
[
i
] = 
amsdu_Àn
;

500 
lök_°a
->
agg
.
max_amsdu_Àn
 = 
mvm_lök_°a
->
‹ig_amsdu_Àn
;

501 
mvm_lök_°a
->
‹ig_amsdu_Àn
 = 0;

504 
	`õì80211_°a_ªˇlc_aggªg©es
(
lök_°a
->
°a
);

506  
cou¡
;

507 
	}
}

509 
ssize_t
 
	$iwl_dbgfs_amsdu_Àn_ªad
(
õì80211_lök_°a
 *
lök_°a
,

510 
iwl_mvm_°a
 *
mvm°a
,

511 
iwl_mvm
 *
mvm
,

512 
iwl_mvm_lök_°a
 *
mvm_lök_°a
,

513 
__u£r
 *
u£r_buf
,

514 
size_t
 
cou¡
, 
loff_t
 *
µos
)

516 
buf
[32];

517 
pos
;

519 
pos
 = 
	`s˙¥ötf
(
buf
, (buf), "current %d ",

520 
lök_°a
->
agg
.
max_amsdu_Àn
);

521 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, (buf) -Öos, "stored %d\n",

522 
mvm_lök_°a
->
‹ig_amsdu_Àn
);

524  
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buf
, 
pos
);

525 
	}
}

527 
ssize_t
 
	$iwl_dbgfs_dißbÀ_powî_off_ªad
(
fûe
 *file,

528 
__u£r
 *
u£r_buf
,

529 
size_t
 
cou¡
, 
loff_t
 *
µos
)

531 
iwl_mvm
 *
mvm
 = 
fûe
->
¥iv©e_d©a
;

532 
buf
[64];

533 
bufsz
 = (
buf
);

534 
pos
 = 0;

536 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "disable_power_off_d0=%d\n",

537 
mvm
->
dißbÀ_powî_off
);

538 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "disable_power_off_d3=%d\n",

539 
mvm
->
dißbÀ_powî_off_d3
);

541  
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buf
, 
pos
);

542 
	}
}

544 
ssize_t
 
	$iwl_dbgfs_dißbÀ_powî_off_wrôe
(
iwl_mvm
 *
mvm
, *
buf
,

545 
size_t
 
cou¡
, 
loff_t
 *
µos
)

547 
ªt
, 
vÆ
;

549 i‡(!
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
))

550  -
EIO
;

552 i‡(!
	`°∫cmp
("dißbÀ_powî_off_d0=", 
buf
, 21)) {

553 i‡(
	`ssˇnf
(
buf
 + 21, "%d", &
vÆ
) != 1)

554  -
EINVAL
;

555 
mvm
->
dißbÀ_powî_off
 = 
vÆ
;

556 } i‡(!
	`°∫cmp
("dißbÀ_powî_off_d3=", 
buf
, 21)) {

557 i‡(
	`ssˇnf
(
buf
 + 21, "%d", &
vÆ
) != 1)

558  -
EINVAL
;

559 
mvm
->
dißbÀ_powî_off_d3
 = 
vÆ
;

561  -
EINVAL
;

564 
	`muãx_lock
(&
mvm
->
muãx
);

565 
ªt
 = 
	`iwl_mvm_powî_upd©e_devi˚
(
mvm
);

566 
	`muãx_u∆ock
(&
mvm
->
muãx
);

568  
ªt
 ?: 
cou¡
;

569 
	}
}

572 
	$iwl_mvm_c€x_dump_mbox
(
iwl_bt_c€x_¥ofûe_nŸif
 *
nŸif
, *
buf
,

573 
pos
, 
bufsz
)

575 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "MBOX dw0:\n");

577 
	`BT_MBOX_PRINT
(0, 
LE_SLAVE_LAT
, 
Ál£
);

578 
	`BT_MBOX_PRINT
(0, 
LE_PROF1
, 
Ál£
);

579 
	`BT_MBOX_PRINT
(0, 
LE_PROF2
, 
Ál£
);

580 
	`BT_MBOX_PRINT
(0, 
LE_PROF_OTHER
, 
Ál£
);

581 
	`BT_MBOX_PRINT
(0, 
CHL_SEQ_N
, 
Ál£
);

582 
	`BT_MBOX_PRINT
(0, 
INBAND_S
, 
Ál£
);

583 
	`BT_MBOX_PRINT
(0, 
LE_MIN_RSSI
, 
Ál£
);

584 
	`BT_MBOX_PRINT
(0, 
LE_SCAN
, 
Ál£
);

585 
	`BT_MBOX_PRINT
(0, 
LE_ADV
, 
Ál£
);

586 
	`BT_MBOX_PRINT
(0, 
LE_MAX_TX_POWER
, 
Ál£
);

587 
	`BT_MBOX_PRINT
(0, 
OPEN_CON_1
, 
åue
);

589 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "MBOX dw1:\n");

591 
	`BT_MBOX_PRINT
(1, 
BR_MAX_TX_POWER
, 
Ál£
);

592 
	`BT_MBOX_PRINT
(1, 
IP_SR
, 
Ál£
);

593 
	`BT_MBOX_PRINT
(1, 
LE_MSTR
, 
Ál£
);

594 
	`BT_MBOX_PRINT
(1, 
AGGR_TRFC_LD
, 
Ál£
);

595 
	`BT_MBOX_PRINT
(1, 
MSG_TYPE
, 
Ál£
);

596 
	`BT_MBOX_PRINT
(1, 
SSN
, 
åue
);

598 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "MBOX dw2:\n");

600 
	`BT_MBOX_PRINT
(2, 
SNIFF_ACT
, 
Ál£
);

601 
	`BT_MBOX_PRINT
(2, 
PAG
, 
Ál£
);

602 
	`BT_MBOX_PRINT
(2, 
INQUIRY
, 
Ál£
);

603 
	`BT_MBOX_PRINT
(2, 
CONN
, 
Ál£
);

604 
	`BT_MBOX_PRINT
(2, 
SNIFF_INTERVAL
, 
Ál£
);

605 
	`BT_MBOX_PRINT
(2, 
DISC
, 
Ál£
);

606 
	`BT_MBOX_PRINT
(2, 
SCO_TX_ACT
, 
Ál£
);

607 
	`BT_MBOX_PRINT
(2, 
SCO_RX_ACT
, 
Ál£
);

608 
	`BT_MBOX_PRINT
(2, 
ESCO_RE_TX
, 
Ál£
);

609 
	`BT_MBOX_PRINT
(2, 
SCO_DURATION
, 
åue
);

611 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "MBOX dw3:\n");

613 
	`BT_MBOX_PRINT
(3, 
SCO_STATE
, 
Ál£
);

614 
	`BT_MBOX_PRINT
(3, 
SNIFF_STATE
, 
Ál£
);

615 
	`BT_MBOX_PRINT
(3, 
A2DP_STATE
, 
Ál£
);

616 
	`BT_MBOX_PRINT
(3, 
A2DP_SRC
, 
Ál£
);

617 
	`BT_MBOX_PRINT
(3, 
ACL_STATE
, 
Ál£
);

618 
	`BT_MBOX_PRINT
(3, 
MSTR_STATE
, 
Ál£
);

619 
	`BT_MBOX_PRINT
(3, 
OBX_STATE
, 
Ál£
);

620 
	`BT_MBOX_PRINT
(3, 
OPEN_CON_2
, 
Ál£
);

621 
	`BT_MBOX_PRINT
(3, 
TRAFFIC_LOAD
, 
Ál£
);

622 
	`BT_MBOX_PRINT
(3, 
CHL_SEQN_LSB
, 
Ál£
);

623 
	`BT_MBOX_PRINT
(3, 
INBAND_P
, 
Ál£
);

624 
	`BT_MBOX_PRINT
(3, 
MSG_TYPE_2
, 
Ál£
);

625 
	`BT_MBOX_PRINT
(3, 
SSN_2
, 
Ál£
);

626 
	`BT_MBOX_PRINT
(3, 
UPDATE_REQUEST
, 
åue
);

628  
pos
;

629 
	}
}

631 
ssize_t
 
	$iwl_dbgfs_bt_nŸif_ªad
(
fûe
 *fûe, 
__u£r
 *
u£r_buf
,

632 
size_t
 
cou¡
, 
loff_t
 *
µos
)

634 
iwl_mvm
 *
mvm
 = 
fûe
->
¥iv©e_d©a
;

635 
iwl_bt_c€x_¥ofûe_nŸif
 *
nŸif
 = &
mvm
->
œ°_bt_nŸif
;

636 *
buf
;

637 
ªt
, 
pos
 = 0, 
bufsz
 = () * 1024;

639 
buf
 = 
	`kmÆloc
(
bufsz
, 
GFP_KERNEL
);

640 i‡(!
buf
)

641  -
ENOMEM
;

643 
	`muãx_lock
(&
mvm
->
muãx
);

645 
pos
 +
	`iwl_mvm_c€x_dump_mbox
(
nŸif
, 
buf
,Öos, 
bufsz
);

647 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
bufsz
 -Öos, "bt_ci_compliance = %d\n",

648 
nŸif
->
bt_ci_com∂ün˚
);

649 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
bufsz
 -Öos, "primary_ch_lut = %d\n",

650 
	`À32_to_˝u
(
nŸif
->
¥im¨y_ch_lut
));

651 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
bufsz
 -Öos, "secondary_ch_lut = %d\n",

652 
	`À32_to_˝u
(
nŸif
->
£c⁄d¨y_ch_lut
));

653 
pos
 +
	`s˙¥ötf
(
buf
 +Öos,

654 
bufsz
 - 
pos
, "bt_activity_grading = %d\n",

655 
	`À32_to_˝u
(
nŸif
->
bt_a˘ivôy_gødög
));

656 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
bufsz
 -Öos, "bt_rrc = %d\n",

657 
nŸif
->
ºc_°©us
 & 0xF);

658 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
bufsz
 -Öos, "bt_ttc = %d\n",

659 
nŸif
->
âc_°©us
 & 0xF);

661 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
bufsz
 -Öos, "sync_sco = %d\n",

662 
IWL_MVM_BT_COEX_SYNC2SCO
);

663 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
bufsz
 -Öos, "mplut = %d\n",

664 
IWL_MVM_BT_COEX_MPLUT
);

666 
	`muãx_u∆ock
(&
mvm
->
muãx
);

668 
ªt
 = 
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buf
, 
pos
);

669 
	`k‰ì
(
buf
);

671  
ªt
;

672 
	}
}

673 #unde‡
BT_MBOX_PRINT


675 
ssize_t
 
	$iwl_dbgfs_bt_cmd_ªad
(
fûe
 *fûe, 
__u£r
 *
u£r_buf
,

676 
size_t
 
cou¡
, 
loff_t
 *
µos
)

678 
iwl_mvm
 *
mvm
 = 
fûe
->
¥iv©e_d©a
;

679 
iwl_bt_c€x_ci_cmd
 *
cmd
 = &
mvm
->
œ°_bt_ci_cmd
;

680 
buf
[256];

681 
bufsz
 = (
buf
);

682 
pos
 = 0;

684 
	`muãx_lock
(&
mvm
->
muãx
);

686 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
bufsz
 -Öos, "Channel inhibition CMD\n");

687 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
bufsz
 -Öos,

689 
	`À64_to_˝u
(
cmd
->
bt_¥im¨y_ci
));

690 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
bufsz
 -Öos,

692 
	`À64_to_˝u
(
cmd
->
bt_£c⁄d¨y_ci
));

694 
	`muãx_u∆ock
(&
mvm
->
muãx
);

696  
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buf
, 
pos
);

697 
	}
}

699 
ssize_t


700 
	$iwl_dbgfs_bt_tx_¥io_wrôe
(
iwl_mvm
 *
mvm
, *
buf
,

701 
size_t
 
cou¡
, 
loff_t
 *
µos
)

703 
u32
 
bt_tx_¥io
;

705 i‡(
	`ssˇnf
(
buf
, "%u", &
bt_tx_¥io
) != 1)

706  -
EINVAL
;

707 i‡(
bt_tx_¥io
 > 4)

708  -
EINVAL
;

710 
mvm
->
bt_tx_¥io
 = bt_tx_prio;

712  
cou¡
;

713 
	}
}

715 
ssize_t


716 
	$iwl_dbgfs_bt_f‹˚_™t_wrôe
(
iwl_mvm
 *
mvm
, *
buf
,

717 
size_t
 
cou¡
, 
loff_t
 *
µos
)

719 c⁄° * c⁄° 
modes_°r
[
BT_FORCE_ANT_MAX
] = {

720 [
BT_FORCE_ANT_DIS
] = "dis",

721 [
BT_FORCE_ANT_AUTO
] = "auto",

722 [
BT_FORCE_ANT_BT
] = "bt",

723 [
BT_FORCE_ANT_WIFI
] = "wifi",

725 
ªt
, 
bt_f‹˚_™t_mode
;

727 
ªt
 = 
	`m©ch_°rög
(
modes_°r
, 
	`ARRAY_SIZE
(modes_°r), 
buf
);

728 i‡(
ªt
 < 0)

729  
ªt
;

731 
bt_f‹˚_™t_mode
 = 
ªt
;

732 
ªt
 = 0;

733 
	`muãx_lock
(&
mvm
->
muãx
);

734 i‡(
mvm
->
bt_f‹˚_™t_mode
 == bt_force_ant_mode)

735 
out
;

737 
mvm
->
bt_f‹˚_™t_mode
 = bt_force_ant_mode;

738 
	`IWL_DEBUG_COEX
(
mvm
, "Force mode: %s\n",

739 
modes_°r
[
mvm
->
bt_f‹˚_™t_mode
]);

741 i‡(
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
))

742 
ªt
 = 
	`iwl_mvm_£nd_bt_öô_c⁄f
(
mvm
);

744 
ªt
 = 0;

746 
out
:

747 
	`muãx_u∆ock
(&
mvm
->
muãx
);

748  
ªt
 ?: 
cou¡
;

749 
	}
}

751 
ssize_t
 
	$iwl_dbgfs_fw_vî_ªad
(
fûe
 *fûe, 
__u£r
 *
u£r_buf
,

752 
size_t
 
cou¡
, 
loff_t
 *
µos
)

754 
iwl_mvm
 *
mvm
 = 
fûe
->
¥iv©e_d©a
;

755 *
buff
, *
pos
, *
ídpos
;

756 c⁄° 
size_t
 
bufsz
 = 1024;

757 
_fw_«me_¥e
[
FW_NAME_PRE_BUFSIZE
];

758 
ªt
;

760 
buff
 = 
	`kmÆloc
(
bufsz
, 
GFP_KERNEL
);

761 i‡(!
buff
)

762  -
ENOMEM
;

764 
pos
 = 
buff
;

765 
ídpos
 = 
pos
 + 
bufsz
;

767 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "FWÖrefix: %s\n",

768 
	`iwl_drv_gë_fw«me_¥e
(
mvm
->
å™s
, 
_fw_«me_¥e
));

769 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "FW: %s\n",

770 
mvm
->
fwπ
.
fw
->
hum™_ªadabÀ
);

771 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "Device: %s\n",

772 
mvm
->
fwπ
.
å™s
->
«me
);

773 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "Bus: %s\n",

774 
mvm
->
fwπ
.
dev
->
bus
->
«me
);

776 
ªt
 = 
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buff
, 
pos
 - buff);

777 
	`k‰ì
(
buff
);

779  
ªt
;

780 
	}
}

782 
ssize_t
 
	$iwl_dbgfs_ès_gë_°©us_ªad
(
fûe
 *file,

783 
__u£r
 *
u£r_buf
,

784 
size_t
 
cou¡
, 
loff_t
 *
µos
)

786 
iwl_mvm
 *
mvm
 = 
fûe
->
¥iv©e_d©a
;

787 
iwl_mvm_ès_°©us_ª•
 
ès_r•
;

788 
iwl_mvm_ès_°©us_ª•
 *
r•
 = &
ès_r•
;

789 c⁄° 
size_t
 
bufsz
 = 1024;

790 *
buff
, *
pos
, *
ídpos
;

791 c⁄° * c⁄° 
ès_dis_ªas⁄
[
TAS_DISABLED_REASON_MAX
] = {

792 [
TAS_DISABLED_DUE_TO_BIOS
] =

794 [
TAS_DISABLED_DUE_TO_SAR_6DBM
] =

796 [
TAS_DISABLED_REASON_INVALID
] =

799 c⁄° * c⁄° 
ès_cuºít_°©us
[
TAS_DYNA_STATUS_MAX
] = {

800 [
TAS_DYNA_INACTIVE
] = "INACTIVE",

801 [
TAS_DYNA_INACTIVE_MVM_MODE
] =

803 [
TAS_DYNA_INACTIVE_TRIGGER_MODE
] =

805 [
TAS_DYNA_INACTIVE_BLOCK_LISTED
] =

807 [
TAS_DYNA_INACTIVE_UHB_NON_US
] =

809 [
TAS_DYNA_ACTIVE
] = "ACTIVE",

811 
iwl_ho°_cmd
 
hcmd
 = {

812 .
id
 = 
	`WIDE_ID
(
DEBUG_GROUP
, 
GET_TAS_STATUS
),

813 .
Êags
 = 
CMD_WANT_SKB
,

814 .
Àn
 = { 0, },

815 .
d©a
 = { 
NULL
, },

817 
ªt
, 
i
, 
tmp
;

818 
boﬁ
 
ès_íabÀd
 = 
Ál£
;

819 
dyn_°©us
;

821 i‡(!
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
))

822  -
ENODEV
;

824 
	`muãx_lock
(&
mvm
->
muãx
);

825 
ªt
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
hcmd
);

826 
	`muãx_u∆ock
(&
mvm
->
muãx
);

827 i‡(
ªt
 < 0)

828  
ªt
;

830 
buff
 = 
	`kzÆloc
(
bufsz
, 
GFP_KERNEL
);

831 i‡(!
buff
)

832  -
ENOMEM
;

833 
pos
 = 
buff
;

834 
ídpos
 = 
pos
 + 
bufsz
;

836 
r•
 = (*)
hcmd
.
ª•_pkt
->
d©a
;

838 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "TAS Conclusion:\n");

839 
i
 = 0; i < 
r•
->
ö_duÆ_ødio
 + 1; i++) {

840 i‡(
r•
->
ès_°©us_mac
[
i
].
b™d
 !
TAS_LMAC_BAND_INVALID
 &&

841 
r•
->
ès_°©us_mac
[
i
].
dy«mic_°©us
 & 
	`BIT
(
TAS_DYNA_ACTIVE
)) {

842 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "\tON for ");

843 
r•
->
ès_°©us_mac
[
i
].
b™d
) {

844 
TAS_LMAC_BAND_HB
:

845 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "HB\n");

847 
TAS_LMAC_BAND_LB
:

848 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "LB\n");

850 
TAS_LMAC_BAND_UHB
:

851 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "UHB\n");

853 
TAS_LMAC_BAND_INVALID
:

854 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos,

858 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos,

860 
r•
->
ès_°©us_mac
[
i
].
b™d
);

861 
out
;

863 
ès_íabÀd
 = 
åue
;

866 i‡(!
ès_íabÀd
)

867 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "\tOFF\n");

869 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "TAS Report\n");

870 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "TAS FW version: %d\n",

871 
r•
->
ès_fw_vîsi⁄
);

872 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "Is UHBÉnabled for USA?: %s\n",

873 
r•
->
is_uhb_f‹_uß_íabÀ
 ? "True" : "False");

874 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "Current MCC: 0x%x\n",

875 
	`À16_to_˝u
(
r•
->
cuº_mcc
));

877 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "BlockÜistÉntries:");

878 
i
 = 0; i < 
IWL_WTAS_BLACK_LIST_MAX
; i++)

879 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, " 0x%x",

880 
	`À16_to_˝u
(
r•
->
block_li°
[
i
]));

882 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "\nOEMÇame: %s\n",

883 
	`dmi_gë_sy°em_öfo
(
DMI_SYS_VENDOR
) ?: "<unknown>");

884 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "\tVendor In Approved List: %s\n",

885 
	`iwl_is_ès_≠¥oved
() ? "YES" : "NO");

886 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos,

888 
r•
->
ö_duÆ_ødio
 ? "TRUE" : "FALSE");

890 
i
 = 0; i < 
r•
->
ö_duÆ_ødio
 + 1; i++) {

891 i‡(
r•
->
ès_°©us_mac
[
i
].
°©ic_°©us
 == 0) {

892 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos,

894 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos,

896 
ès_dis_ªas⁄
[0]);

897 
out
;

900 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "TAS status for ");

901 
r•
->
ès_°©us_mac
[
i
].
b™d
) {

902 
TAS_LMAC_BAND_HB
:

903 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "High band\n");

905 
TAS_LMAC_BAND_LB
:

906 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "Low band\n");

908 
TAS_LMAC_BAND_UHB
:

909 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos,

912 
TAS_LMAC_BAND_INVALID
:

913 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos,

917 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos,

919 
r•
->
ès_°©us_mac
[
i
].
b™d
);

920 
out
;

922 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "Static status: %sabled\n",

923 
r•
->
ès_°©us_mac
[
i
].
°©ic_°©us
 ?

925 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos,

927 i‡(
r•
->
ès_°©us_mac
[
i
].
°©ic_dis_ªas⁄
 < 
TAS_DISABLED_REASON_MAX
)

928 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "%s (%d)\n",

929 
ès_dis_ªas⁄
[
r•
->
ès_°©us_mac
[
i
].
°©ic_dis_ªas⁄
],

930 
r•
->
ès_°©us_mac
[
i
].
°©ic_dis_ªas⁄
);

932 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos,

934 
r•
->
ès_°©us_mac
[
i
].
°©ic_dis_ªas⁄
);

936 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "Dynamic status:\n");

937 
dyn_°©us
 = (
r•
->
ès_°©us_mac
[
i
].
dy«mic_°©us
);

938 
	`f‹_óch_£t_bô
(
tmp
, &
dyn_°©us
, (dyn_status)) {

939 i‡(
tmp
 >0 &&Åm∞< 
TAS_DYNA_STATUS_MAX
)

940 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos,

942 
ès_cuºít_°©us
[
tmp
],Åmp);

945 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos,

947 
r•
->
ès_°©us_mac
[
i
].
√¨_disc⁄√˘i⁄
 ?

949 
tmp
 = 
	`À16_to_˝u
(
r•
->
ès_°©us_mac
[
i
].
max_ªg_pwr_limô
);

950 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos,

952 
tmp
 / 8, 125 * (tmp % 8));

953 
tmp
 = 
	`À16_to_˝u
(
r•
->
ès_°©us_mac
[
i
].
ßr_limô
);

954 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos,

956 
tmp
 / 8, 125 * (tmp % 8));

959 
out
:

960 
ªt
 = 
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buff
, 
pos
 - buff);

961 
	`k‰ì
(
buff
);

962 
	`iwl_‰ì_ª•
(&
hcmd
);

963  
ªt
;

964 
	}
}

966 
ssize_t
 
	$iwl_dbgfs_phy_öãgøti⁄_vî_ªad
(
fûe
 *file,

967 
__u£r
 *
u£r_buf
,

968 
size_t
 
cou¡
, 
loff_t
 *
µos
)

970 
iwl_mvm
 *
mvm
 = 
fûe
->
¥iv©e_d©a
;

971 *
buf
;

972 
size_t
 
bufsz
;

973 
pos
;

974 
ssize_t
 
ªt
;

976 
bufsz
 = 
mvm
->
fw
->
phy_öãgøti⁄_vî_Àn
 + 2;

977 
buf
 = 
	`kmÆloc
(
bufsz
, 
GFP_KERNEL
);

978 i‡(!
buf
)

979  -
ENOMEM
;

981 
pos
 = 
	`s˙¥ötf
(
buf
, 
bufsz
, "%.*s\n", 
mvm
->
fw
->
phy_öãgøti⁄_vî_Àn
,

982 
mvm
->
fw
->
phy_öãgøti⁄_vî
);

984 
ªt
 = 
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buf
, 
pos
);

986 
	`k‰ì
(
buf
);

987  
ªt
;

988 
	}
}

990 
	#PRINT_STATS_LE32
(
_°ru˘
, 
_memb
) \

991 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
bufsz
 -Öos, \

992 
fmt_èbÀ
, #_memb, \

993 
	`À32_to_˝u
(
_°ru˘
->
_memb
))

	)

995 
ssize_t
 
	$iwl_dbgfs_fw_rx_°©s_ªad
(
fûe
 *file,

996 
__u£r
 *
u£r_buf
, 
size_t
 
cou¡
,

997 
loff_t
 *
µos
)

999 
iwl_mvm
 *
mvm
 = 
fûe
->
¥iv©e_d©a
;

1000 c⁄° *
fmt_èbÀ
 = "\t%-30s %10u\n";

1001 c⁄° *
fmt_hódî
 = "%-32s\n";

1002 
pos
 = 0;

1003 *
buf
;

1004 
ªt
;

1005 
size_t
 
bufsz
;

1006 
u8
 
cmd_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
,

1007 
	`WIDE_ID
(
SYSTEM_GROUP
,

1008 
SYSTEM_STATISTICS_CMD
),

1009 
IWL_FW_CMD_VER_UNKNOWN
);

1011 i‡(
cmd_vî
 !
IWL_FW_CMD_VER_UNKNOWN
)

1012  -
EOPNOTSUPP
;

1014 i‡(
	`iwl_mvm_has_√w_rx_°©s_≠i
(
mvm
))

1015 
bufsz
 = (((
mvm_°©i°ics_rx
) /

1016 (
__À32
)) * 43) + (4 * 33) + 1;

1019 
bufsz
 = (((
mvm_°©i°ics_rx_v3
) /

1020 (
__À32
)) * 43) + (4 * 33) + 1;

1022 
buf
 = 
	`kzÆloc
(
bufsz
, 
GFP_KERNEL
);

1023 i‡(!
buf
)

1024  -
ENOMEM
;

1026 
	`muãx_lock
(&
mvm
->
muãx
);

1028 i‡(
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
))

1029 
	`iwl_mvm_ªque°_°©i°ics
(
mvm
, 
Ál£
);

1031 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
bufsz
 -Öos, 
fmt_hódî
,

1033 i‡(!
	`iwl_mvm_has_√w_rx_°©s_≠i
(
mvm
)) {

1034 
mvm_°©i°ics_rx_phy_v2
 *
ofdm
 = &
mvm
->
rx_°©s_v3
.ofdm;

1036 
	`PRINT_STATS_LE32
(
ofdm
, 
öa_˙t
);

1037 
	`PRINT_STATS_LE32
(
ofdm
, 
föa_˙t
);

1038 
	`PRINT_STATS_LE32
(
ofdm
, 
∂˝_îr
);

1039 
	`PRINT_STATS_LE32
(
ofdm
, 
¸c32_îr
);

1040 
	`PRINT_STATS_LE32
(
ofdm
, 
ovîrun_îr
);

1041 
	`PRINT_STATS_LE32
(
ofdm
, 
óæy_ovîrun_îr
);

1042 
	`PRINT_STATS_LE32
(
ofdm
, 
¸c32_good
);

1043 
	`PRINT_STATS_LE32
(
ofdm
, 
Ál£_Æ¨m_˙t
);

1044 
	`PRINT_STATS_LE32
(
ofdm
, 
föa_sync_îr_˙t
);

1045 
	`PRINT_STATS_LE32
(
ofdm
, 
sfd_timeout
);

1046 
	`PRINT_STATS_LE32
(
ofdm
, 
föa_timeout
);

1047 
	`PRINT_STATS_LE32
(
ofdm
, 
uƒe•⁄ded_πs
);

1048 
	`PRINT_STATS_LE32
(
ofdm
, 
rxe_‰ame_lmt_ovîrun
);

1049 
	`PRINT_STATS_LE32
(
ofdm
, 
£¡_ack_˙t
);

1050 
	`PRINT_STATS_LE32
(
ofdm
, 
£¡_˘s_˙t
);

1051 
	`PRINT_STATS_LE32
(
ofdm
, 
£¡_ba_r•_˙t
);

1052 
	`PRINT_STATS_LE32
(
ofdm
, 
d•_£lf_kûl
);

1053 
	`PRINT_STATS_LE32
(
ofdm
, 
mh_f‹m©_îr
);

1054 
	`PRINT_STATS_LE32
(
ofdm
, 
ª_acq_maö_rssi_sum
);

1055 
	`PRINT_STATS_LE32
(
ofdm
, 
ª£rved
);

1057 
mvm_°©i°ics_rx_phy
 *
ofdm
 = &
mvm
->
rx_°©s
.ofdm;

1059 
	`PRINT_STATS_LE32
(
ofdm
, 
uƒe•⁄ded_πs
);

1060 
	`PRINT_STATS_LE32
(
ofdm
, 
rxe_‰ame_lmt_ovîrun
);

1061 
	`PRINT_STATS_LE32
(
ofdm
, 
£¡_ba_r•_˙t
);

1062 
	`PRINT_STATS_LE32
(
ofdm
, 
d•_£lf_kûl
);

1063 
	`PRINT_STATS_LE32
(
ofdm
, 
ª£rved
);

1066 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
bufsz
 -Öos, 
fmt_hódî
,

1068 i‡(!
	`iwl_mvm_has_√w_rx_°©s_≠i
(
mvm
)) {

1069 
mvm_°©i°ics_rx_phy_v2
 *
cck
 = &
mvm
->
rx_°©s_v3
.cck;

1071 
	`PRINT_STATS_LE32
(
cck
, 
öa_˙t
);

1072 
	`PRINT_STATS_LE32
(
cck
, 
föa_˙t
);

1073 
	`PRINT_STATS_LE32
(
cck
, 
∂˝_îr
);

1074 
	`PRINT_STATS_LE32
(
cck
, 
¸c32_îr
);

1075 
	`PRINT_STATS_LE32
(
cck
, 
ovîrun_îr
);

1076 
	`PRINT_STATS_LE32
(
cck
, 
óæy_ovîrun_îr
);

1077 
	`PRINT_STATS_LE32
(
cck
, 
¸c32_good
);

1078 
	`PRINT_STATS_LE32
(
cck
, 
Ál£_Æ¨m_˙t
);

1079 
	`PRINT_STATS_LE32
(
cck
, 
föa_sync_îr_˙t
);

1080 
	`PRINT_STATS_LE32
(
cck
, 
sfd_timeout
);

1081 
	`PRINT_STATS_LE32
(
cck
, 
föa_timeout
);

1082 
	`PRINT_STATS_LE32
(
cck
, 
uƒe•⁄ded_πs
);

1083 
	`PRINT_STATS_LE32
(
cck
, 
rxe_‰ame_lmt_ovîrun
);

1084 
	`PRINT_STATS_LE32
(
cck
, 
£¡_ack_˙t
);

1085 
	`PRINT_STATS_LE32
(
cck
, 
£¡_˘s_˙t
);

1086 
	`PRINT_STATS_LE32
(
cck
, 
£¡_ba_r•_˙t
);

1087 
	`PRINT_STATS_LE32
(
cck
, 
d•_£lf_kûl
);

1088 
	`PRINT_STATS_LE32
(
cck
, 
mh_f‹m©_îr
);

1089 
	`PRINT_STATS_LE32
(
cck
, 
ª_acq_maö_rssi_sum
);

1090 
	`PRINT_STATS_LE32
(
cck
, 
ª£rved
);

1092 
mvm_°©i°ics_rx_phy
 *
cck
 = &
mvm
->
rx_°©s
.cck;

1094 
	`PRINT_STATS_LE32
(
cck
, 
uƒe•⁄ded_πs
);

1095 
	`PRINT_STATS_LE32
(
cck
, 
rxe_‰ame_lmt_ovîrun
);

1096 
	`PRINT_STATS_LE32
(
cck
, 
£¡_ba_r•_˙t
);

1097 
	`PRINT_STATS_LE32
(
cck
, 
d•_£lf_kûl
);

1098 
	`PRINT_STATS_LE32
(
cck
, 
ª£rved
);

1101 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
bufsz
 -Öos, 
fmt_hódî
,

1103 i‡(!
	`iwl_mvm_has_√w_rx_°©s_≠i
(
mvm
)) {

1104 
mvm_°©i°ics_rx_n⁄_phy_v3
 *
gíîÆ
 =

1105 &
mvm
->
rx_°©s_v3
.
gíîÆ
;

1107 
	`PRINT_STATS_LE32
(
gíîÆ
, 
bogus_˘s
);

1108 
	`PRINT_STATS_LE32
(
gíîÆ
, 
bogus_ack
);

1109 
	`PRINT_STATS_LE32
(
gíîÆ
, 
n⁄_bssid_‰ames
);

1110 
	`PRINT_STATS_LE32
(
gíîÆ
, 
fûãªd_‰ames
);

1111 
	`PRINT_STATS_LE32
(
gíîÆ
, 
n⁄_ch™√l_bóc⁄s
);

1112 
	`PRINT_STATS_LE32
(
gíîÆ
, 
ch™√l_bóc⁄s
);

1113 
	`PRINT_STATS_LE32
(
gíîÆ
, 
num_mis£d_bc⁄
);

1114 
	`PRINT_STATS_LE32
(
gíîÆ
, 
adc_rx_ßtuøti⁄_time
);

1115 
	`PRINT_STATS_LE32
(
gíîÆ
, 
öa_dëe˘i⁄_£¨ch_time
);

1116 
	`PRINT_STATS_LE32
(
gíîÆ
, 
bóc⁄_sûí˚_rssi_a
);

1117 
	`PRINT_STATS_LE32
(
gíîÆ
, 
bóc⁄_sûí˚_rssi_b
);

1118 
	`PRINT_STATS_LE32
(
gíîÆ
, 
bóc⁄_sûí˚_rssi_c
);

1119 
	`PRINT_STATS_LE32
(
gíîÆ
, 
öãr„ªn˚_d©a_Êag
);

1120 
	`PRINT_STATS_LE32
(
gíîÆ
, 
ch™√l_lﬂd
);

1121 
	`PRINT_STATS_LE32
(
gíîÆ
, 
d•_Ál£_Æ¨ms
);

1122 
	`PRINT_STATS_LE32
(
gíîÆ
, 
bóc⁄_rssi_a
);

1123 
	`PRINT_STATS_LE32
(
gíîÆ
, 
bóc⁄_rssi_b
);

1124 
	`PRINT_STATS_LE32
(
gíîÆ
, 
bóc⁄_rssi_c
);

1125 
	`PRINT_STATS_LE32
(
gíîÆ
, 
bóc⁄_íîgy_a
);

1126 
	`PRINT_STATS_LE32
(
gíîÆ
, 
bóc⁄_íîgy_b
);

1127 
	`PRINT_STATS_LE32
(
gíîÆ
, 
bóc⁄_íîgy_c
);

1128 
	`PRINT_STATS_LE32
(
gíîÆ
, 
num_bt_kûls
);

1129 
	`PRINT_STATS_LE32
(
gíîÆ
, 
mac_id
);

1130 
	`PRINT_STATS_LE32
(
gíîÆ
, 
dúe˘ed_d©a_mpdu
);

1132 
mvm_°©i°ics_rx_n⁄_phy
 *
gíîÆ
 =

1133 &
mvm
->
rx_°©s
.
gíîÆ
;

1135 
	`PRINT_STATS_LE32
(
gíîÆ
, 
bogus_˘s
);

1136 
	`PRINT_STATS_LE32
(
gíîÆ
, 
bogus_ack
);

1137 
	`PRINT_STATS_LE32
(
gíîÆ
, 
n⁄_ch™√l_bóc⁄s
);

1138 
	`PRINT_STATS_LE32
(
gíîÆ
, 
ch™√l_bóc⁄s
);

1139 
	`PRINT_STATS_LE32
(
gíîÆ
, 
num_mis£d_bc⁄
);

1140 
	`PRINT_STATS_LE32
(
gíîÆ
, 
adc_rx_ßtuøti⁄_time
);

1141 
	`PRINT_STATS_LE32
(
gíîÆ
, 
öa_dëe˘i⁄_£¨ch_time
);

1142 
	`PRINT_STATS_LE32
(
gíîÆ
, 
bóc⁄_sûí˚_rssi_a
);

1143 
	`PRINT_STATS_LE32
(
gíîÆ
, 
bóc⁄_sûí˚_rssi_b
);

1144 
	`PRINT_STATS_LE32
(
gíîÆ
, 
bóc⁄_sûí˚_rssi_c
);

1145 
	`PRINT_STATS_LE32
(
gíîÆ
, 
öãr„ªn˚_d©a_Êag
);

1146 
	`PRINT_STATS_LE32
(
gíîÆ
, 
ch™√l_lﬂd
);

1147 
	`PRINT_STATS_LE32
(
gíîÆ
, 
bóc⁄_rssi_a
);

1148 
	`PRINT_STATS_LE32
(
gíîÆ
, 
bóc⁄_rssi_b
);

1149 
	`PRINT_STATS_LE32
(
gíîÆ
, 
bóc⁄_rssi_c
);

1150 
	`PRINT_STATS_LE32
(
gíîÆ
, 
bóc⁄_íîgy_a
);

1151 
	`PRINT_STATS_LE32
(
gíîÆ
, 
bóc⁄_íîgy_b
);

1152 
	`PRINT_STATS_LE32
(
gíîÆ
, 
bóc⁄_íîgy_c
);

1153 
	`PRINT_STATS_LE32
(
gíîÆ
, 
num_bt_kûls
);

1154 
	`PRINT_STATS_LE32
(
gíîÆ
, 
mac_id
);

1157 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
bufsz
 -Öos, 
fmt_hódî
,

1159 i‡(!
	`iwl_mvm_has_√w_rx_°©s_≠i
(
mvm
)) {

1160 
mvm_°©i°ics_rx_ht_phy_v1
 *
ht
 =

1161 &
mvm
->
rx_°©s_v3
.
ofdm_ht
;

1163 
	`PRINT_STATS_LE32
(
ht
, 
∂˝_îr
);

1164 
	`PRINT_STATS_LE32
(
ht
, 
ovîrun_îr
);

1165 
	`PRINT_STATS_LE32
(
ht
, 
óæy_ovîrun_îr
);

1166 
	`PRINT_STATS_LE32
(
ht
, 
¸c32_good
);

1167 
	`PRINT_STATS_LE32
(
ht
, 
¸c32_îr
);

1168 
	`PRINT_STATS_LE32
(
ht
, 
mh_f‹m©_îr
);

1169 
	`PRINT_STATS_LE32
(
ht
, 
agg_¸c32_good
);

1170 
	`PRINT_STATS_LE32
(
ht
, 
agg_mpdu_˙t
);

1171 
	`PRINT_STATS_LE32
(
ht
, 
agg_˙t
);

1172 
	`PRINT_STATS_LE32
(
ht
, 
unsuµ‹t_mcs
);

1174 
mvm_°©i°ics_rx_ht_phy
 *
ht
 =

1175 &
mvm
->
rx_°©s
.
ofdm_ht
;

1177 
	`PRINT_STATS_LE32
(
ht
, 
mh_f‹m©_îr
);

1178 
	`PRINT_STATS_LE32
(
ht
, 
agg_mpdu_˙t
);

1179 
	`PRINT_STATS_LE32
(
ht
, 
agg_˙t
);

1180 
	`PRINT_STATS_LE32
(
ht
, 
unsuµ‹t_mcs
);

1183 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1185 
ªt
 = 
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buf
, 
pos
);

1186 
	`k‰ì
(
buf
);

1188  
ªt
;

1189 
	}
}

1190 #unde‡
PRINT_STAT_LE32


1192 
ssize_t
 
	$iwl_dbgfs_fw_sy°em_°©s_ªad
(
fûe
 *file,

1193 
__u£r
 *
u£r_buf
,

1194 
size_t
 
cou¡
, 
loff_t
 *
µos
)

1196 *
buff
, *
pos
, *
ídpos
;

1197 
ªt
;

1198 
size_t
 
bufsz
;

1199 
i
;

1200 
iwl_mvm_vif
 *
mvmvif
;

1201 
õì80211_vif
 *
vif
;

1202 
iwl_mvm
 *
mvm
 = 
fûe
->
¥iv©e_d©a
;

1203 
u8
 
cmd_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
,

1204 
	`WIDE_ID
(
SYSTEM_GROUP
,

1205 
SYSTEM_STATISTICS_CMD
),

1206 
IWL_FW_CMD_VER_UNKNOWN
);

1209 
bufsz
 = (
cmd_vî
 == 1) ? 4096 : 64;

1211 
buff
 = 
	`kzÆloc
(
bufsz
, 
GFP_KERNEL
);

1212 i‡(!
buff
)

1213  -
ENOMEM
;

1215 
pos
 = 
buff
;

1216 
ídpos
 = 
pos
 + 
bufsz
;

1218 i‡(
cmd_vî
 != 1) {

1219 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos,

1220 "Sy°em sèt†nŸ suµ‹ãd:%d\n", 
cmd_vî
);

1221 
£nd_out
;

1224 
	`muãx_lock
(&
mvm
->
muãx
);

1225 i‡(
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
))

1226 
	`iwl_mvm_ªque°_°©i°ics
(
mvm
, 
Ál£
);

1228 
i
 = 0; i < 
NUM_MAC_INDEX_DRIVER
; i++) {

1229 
vif
 = 
	`iwl_mvm_rcu_dîe„ªn˚_vif_id
(
mvm
, 
i
, 
Ál£
);

1230 i‡(!
vif
)

1233 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
)

1237 i‡(
i
 =
NUM_MAC_INDEX_DRIVER
 || !
vif
) {

1238 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "vif is NULL\n");

1239 
ªÀa£_£nd_out
;

1242 
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1243 i‡(!
mvmvif
) {

1244 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "mvmvif is NULL\n");

1245 
ªÀa£_£nd_out
;

1248 
	`f‹_óch_mvm_vif_vÆid_lök
(
mvmvif
, 
i
) {

1249 
iwl_mvm_vif_lök_öfo
 *
lök_öfo
 = 
mvmvif
->
lök
[
i
];

1251 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos,

1252 "lök_id %d", 
i
);

1253 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos,

1255 
lök_öfo
->
bóc⁄_°©s
.
num_bóc⁄s
);

1256 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos,

1258 
lök_öfo
->
bóc⁄_°©s
.
accu_num_bóc⁄s
);

1259 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos,

1261 
lök_öfo
->
bóc⁄_°©s
.
avg_sig«l
);

1264 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos,

1266 
mvm
->
ødio_°©s
.
rx_time
);

1267 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos,

1269 
mvm
->
ødio_°©s
.
tx_time
);

1270 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos,

1272 
mvm
->
accu_ødio_°©s
.
rx_time
);

1273 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos,

1275 
mvm
->
accu_ødio_°©s
.
tx_time
);

1277 
ªÀa£_£nd_out
:

1278 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1280 
£nd_out
:

1281 
ªt
 = 
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buff
, 
pos
 - buff);

1282 
	`k‰ì
(
buff
);

1284  
ªt
;

1285 
	}
}

1287 
ssize_t
 
	$iwl_dbgfs_‰ame_°©s_ªad
(
iwl_mvm
 *
mvm
,

1288 
__u£r
 *
u£r_buf
, 
size_t
 
cou¡
,

1289 
loff_t
 *
µos
,

1290 
iwl_mvm_‰ame_°©s
 *
°©s
)

1292 *
buff
, *
pos
, *
ídpos
;

1293 
idx
, 
i
;

1294 
ªt
;

1295 c⁄° 
size_t
 
bufsz
 = 1024;

1297 
buff
 = 
	`kmÆloc
(
bufsz
, 
GFP_KERNEL
);

1298 i‡(!
buff
)

1299  -
ENOMEM
;

1301 
	`•ö_lock_bh
(&
mvm
->
drv_°©s_lock
);

1303 
pos
 = 
buff
;

1304 
ídpos
 = 
pos
 + 
bufsz
;

1306 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos,

1308 
°©s
->
Àgacy_‰ames
,

1309 
°©s
->
ht_‰ames
,

1310 
°©s
->
vht_‰ames
);

1311 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "20/40/80\t:\t%d/%d/%d\n",

1312 
°©s
->
bw_20_‰ames
,

1313 
°©s
->
bw_40_‰ames
,

1314 
°©s
->
bw_80_‰ames
);

1315 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "NGI/SGI\t\t:\t%d/%d\n",

1316 
°©s
->
ngi_‰ames
,

1317 
°©s
->
sgi_‰ames
);

1318 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "SISO/MIMO2\t:\t%d/%d\n",

1319 
°©s
->
siso_‰ames
,

1320 
°©s
->
mimo2_‰ames
);

1321 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "FAIL/SCSS\t:\t%d/%d\n",

1322 
°©s
->
Áû_‰ames
,

1323 
°©s
->
suc˚ss_‰ames
);

1324 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "MPDUságg\t:\t%d\n",

1325 
°©s
->
agg_‰ames
);

1326 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "A-MPDUs\t\t:\t%d\n",

1327 
°©s
->
ampdu_cou¡
);

1328 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "Avg MPDUs/A-MPDU:\t%d\n",

1329 
°©s
->
ampdu_cou¡
 > 0 ?

1330 (
°©s
->
agg_‰ames
 / sèts->
ampdu_cou¡
) : 0);

1332 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "Last Rates\n");

1334 
idx
 = 
°©s
->
œ°_‰ame_idx
 - 1;

1335 
i
 = 0; i < 
	`ARRAY_SIZE
(
°©s
->
œ°_øãs
); i++) {

1336 
idx
 = (idx + 1Ë% 
	`ARRAY_SIZE
(
°©s
->
œ°_øãs
);

1337 i‡(
°©s
->
œ°_øãs
[
idx
] == 0)

1339 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "Rate[%d]: ",

1340 ()(
	`ARRAY_SIZE
(
°©s
->
œ°_øãs
Ë- 
i
));

1341 
pos
 +
	`rs_¥ëty_¥öt_øã_v1
’os, 
ídpos
 -Öos,

1342 
°©s
->
œ°_øãs
[
idx
]);

1343 i‡(
pos
 < 
ídpos
 - 1)

1344 *
pos
++ = '\n';

1346 
	`•ö_u∆ock_bh
(&
mvm
->
drv_°©s_lock
);

1348 
ªt
 = 
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buff
, 
pos
 - buff);

1349 
	`k‰ì
(
buff
);

1351  
ªt
;

1352 
	}
}

1354 
ssize_t
 
	$iwl_dbgfs_drv_rx_°©s_ªad
(
fûe
 *file,

1355 
__u£r
 *
u£r_buf
, 
size_t
 
cou¡
,

1356 
loff_t
 *
µos
)

1358 
iwl_mvm
 *
mvm
 = 
fûe
->
¥iv©e_d©a
;

1360  
	`iwl_dbgfs_‰ame_°©s_ªad
(
mvm
, 
u£r_buf
, 
cou¡
, 
µos
,

1361 &
mvm
->
drv_rx_°©s
);

1362 
	}
}

1364 
ssize_t
 
	$iwl_dbgfs_fw_ª°¨t_wrôe
(
iwl_mvm
 *
mvm
, *
buf
,

1365 
size_t
 
cou¡
, 
loff_t
 *
µos
)

1367 
__maybe_unu£d
 
ªt
;

1369 i‡(!
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
))

1370  -
EIO
;

1372 
	`muãx_lock
(&
mvm
->
muãx
);

1375 i‡(
mvm
->
fw_ª°¨t
 >= 0)

1376 
mvm
->
fw_ª°¨t
++;

1378 i‡(
cou¡
 =6 && !
	`°rcmp
(
buf
, "nolog\n")) {

1379 
	`£t_bô
(
IWL_MVM_STATUS_SUPPRESS_ERROR_LOG_ONCE
, &
mvm
->
°©us
);

1380 
	`£t_bô
(
STATUS_SUPPRESS_CMD_ERROR_ONCE
, &
mvm
->
å™s
->
°©us
);

1384 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
,

1385 
	`WIDE_ID
(
LONG_GROUP
, 
REPLY_ERROR
),

1386 0, 0, 
NULL
);

1388 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1390  
cou¡
;

1391 
	}
}

1393 
ssize_t
 
	$iwl_dbgfs_fw_nmi_wrôe
(
iwl_mvm
 *
mvm
, *
buf
,

1394 
size_t
 
cou¡
, 
loff_t
 *
µos
)

1396 i‡(!
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
))

1397  -
EIO
;

1399 i‡(
cou¡
 =6 && !
	`°rcmp
(
buf
, "nolog\n"))

1400 
	`£t_bô
(
IWL_MVM_STATUS_SUPPRESS_ERROR_LOG_ONCE
, &
mvm
->
°©us
);

1402 
	`iwl_f‹˚_nmi
(
mvm
->
å™s
);

1404  
cou¡
;

1405 
	}
}

1407 
ssize_t


1408 
	$iwl_dbgfs_sˇn_™t_rxchaö_ªad
(
fûe
 *file,

1409 
__u£r
 *
u£r_buf
,

1410 
size_t
 
cou¡
, 
loff_t
 *
µos
)

1412 
iwl_mvm
 *
mvm
 = 
fûe
->
¥iv©e_d©a
;

1413 
pos
 = 0;

1414 
buf
[32];

1415 c⁄° 
size_t
 
bufsz
 = (
buf
);

1418 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
bufsz
 -Öos, "Antennas for scan: ");

1419 i‡(
mvm
->
sˇn_rx_™t
 & 
ANT_A
)

1420 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
bufsz
 -Öos, "A");

1421 i‡(
mvm
->
sˇn_rx_™t
 & 
ANT_B
)

1422 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
bufsz
 -Öos, "B");

1423 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
bufsz
 -Öos, " (%x)\n", 
mvm
->
sˇn_rx_™t
);

1425  
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buf
, 
pos
);

1426 
	}
}

1428 
ssize_t


1429 
	$iwl_dbgfs_sˇn_™t_rxchaö_wrôe
(
iwl_mvm
 *
mvm
, *
buf
,

1430 
size_t
 
cou¡
, 
loff_t
 *
µos
)

1432 
u8
 
sˇn_rx_™t
;

1434 i‡(!
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
))

1435  -
EIO
;

1437 i‡(
	`ssˇnf
(
buf
, "%hhx", &
sˇn_rx_™t
) != 1)

1438  -
EINVAL
;

1439 i‡(
sˇn_rx_™t
 > 
ANT_ABC
)

1440  -
EINVAL
;

1441 i‡(
sˇn_rx_™t
 & ~(
	`iwl_mvm_gë_vÆid_rx_™t
(
mvm
)))

1442  -
EINVAL
;

1444 i‡(
mvm
->
sˇn_rx_™t
 != scan_rx_ant) {

1445 
mvm
->
sˇn_rx_™t
 = scan_rx_ant;

1446 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

1447 
IWL_UCODE_TLV_CAPA_UMAC_SCAN
))

1448 
	`iwl_mvm_c⁄fig_sˇn
(
mvm
);

1451  
cou¡
;

1452 
	}
}

1454 
ssize_t
 
	$iwl_dbgfs_ödúe˘i⁄_tbl_wrôe
(
iwl_mvm
 *
mvm
,

1455 *
buf
, 
size_t
 
cou¡
,

1456 
loff_t
 *
µos
)

1458 
iwl_rss_c⁄fig_cmd
 
cmd
 = {

1459 .
Êags
 = 
	`˝u_to_À32
(
IWL_RSS_ENABLE
),

1460 .
hash_mask
 = 
IWL_RSS_HASH_TYPE_IPV4_TCP
 |

1461 
IWL_RSS_HASH_TYPE_IPV4_UDP
 |

1462 
IWL_RSS_HASH_TYPE_IPV4_PAYLOAD
 |

1463 
IWL_RSS_HASH_TYPE_IPV6_TCP
 |

1464 
IWL_RSS_HASH_TYPE_IPV6_UDP
 |

1465 
IWL_RSS_HASH_TYPE_IPV6_PAYLOAD
,

1467 
ªt
, 
i
, 
num_ª≥©s
, 
nbyãs
 = 
cou¡
 / 2;

1469 
ªt
 = 
	`hex2bö
(
cmd
.
ödúe˘i⁄_èbÀ
, 
buf
, 
nbyãs
);

1470 i‡(
ªt
)

1471  
ªt
;

1480 
num_ª≥©s
 = 
	`ARRAY_SIZE
(
cmd
.
ödúe˘i⁄_èbÀ
Ë/ 
nbyãs
;

1481 
i
 = 1; i < 
num_ª≥©s
; i++)

1482 
	`mem˝y
(&
cmd
.
ödúe˘i⁄_èbÀ
[
i
 * 
nbyãs
],

1483 
cmd
.
ödúe˘i⁄_èbÀ
, 
nbyãs
);

1485 
	`mem˝y
(&
cmd
.
ödúe˘i⁄_èbÀ
[
i
 * 
nbyãs
], cmd.indirection_table,

1486 
	`ARRAY_SIZE
(
cmd
.
ödúe˘i⁄_èbÀ
Ë% 
nbyãs
);

1488 
	`√tdev_rss_key_fûl
(
cmd
.
£¸ë_key
, (cmd.secret_key));

1490 
	`muãx_lock
(&
mvm
->
muãx
);

1491 i‡(
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
))

1492 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
RSS_CONFIG_CMD
, 0,

1493 (
cmd
), &cmd);

1495 
ªt
 = 0;

1496 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1498  
ªt
 ?: 
cou¡
;

1499 
	}
}

1501 
ssize_t
 
	$iwl_dbgfs_öje˘_∑ckë_wrôe
(
iwl_mvm
 *
mvm
,

1502 *
buf
, 
size_t
 
cou¡
,

1503 
loff_t
 *
µos
)

1505 
iwl_›_mode
 *
›mode
 = 
	`c⁄èöî_of
((*)
mvm
,

1506 
iwl_›_mode
,

1507 
›_mode_•ecific
);

1508 
iwl_rx_cmd_buf„r
 
rxb
 = {

1509 .
_rx_∑ge_‹dî
 = 0,

1510 .
åuesize
 = 0,

1511 .
_off£t
 = 0,

1513 
iwl_rx_∑ckë
 *
pkt
;

1514 
bö_Àn
 = 
cou¡
 / 2;

1515 
ªt
 = -
EINVAL
;

1517 i‡(!
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
))

1518  -
EIO
;

1521 i‡(!
mvm
->
å™s
->
å™s_cfg
->
mq_rx_suµ‹ãd
)

1522  -
EOPNOTSUPP
;

1524 
rxb
.
_∑ge
 = 
	`Æloc_∑ges
(
GFP_ATOMIC
, 0);

1525 i‡(!
rxb
.
_∑ge
)

1526  -
ENOMEM
;

1527 
pkt
 = 
	`rxb_addr
(&
rxb
);

1529 
ªt
 = 
	`hex2bö
(
	`∑ge_addªss
(
rxb
.
_∑ge
), 
buf
, 
bö_Àn
);

1530 i‡(
ªt
)

1531 
out
;

1534 i‡(
bö_Àn
 < (*
pkt
) ||

1535 
bö_Àn
 !(*
pkt
Ë+ 
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(pkt))

1536 
out
;

1538 
	`loˇl_bh_dißbÀ
();

1539 
	`iwl_mvm_rx_mq
(
›mode
, 
NULL
, &
rxb
);

1540 
	`loˇl_bh_íabÀ
();

1541 
ªt
 = 0;

1543 
out
:

1544 
	`iwl_‰ì_rxb
(&
rxb
);

1546  
ªt
 ?: 
cou¡
;

1547 
	}
}

1549 
	$_iwl_dbgfs_öje˘_bóc⁄_õ
(
iwl_mvm
 *
mvm
, *
bö
, 
Àn
)

1551 
õì80211_vif
 *
vif
;

1552 
iwl_mvm_vif
 *
mvmvif
;

1553 
sk_buff
 *
bóc⁄
;

1554 
õì80211_tx_öfo
 *
öfo
;

1555 
iwl_mac_bóc⁄_cmd
 
bóc⁄_cmd
 = {};

1556 
lök_id
;

1557 
u8
 
øã
;

1558 
i
;

1560 
Àn
 /= 2;

1563 i‡(
Àn
 >
U8_MAX
)

1564  -
EINVAL
;

1566 i‡(!
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
))

1567  -
EIO
;

1569 i‡(!
	`iwl_mvm_has_√w_tx_≠i
(
mvm
) &&

1570 !
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

1571 
IWL_UCODE_TLV_API_NEW_BEACON_TEMPLATE
))

1572  -
EINVAL
;

1574 
	`muãx_lock
(&
mvm
->
muãx
);

1576 
i
 = 0; i < 
NUM_MAC_INDEX_DRIVER
; i++) {

1577 
vif
 = 
	`iwl_mvm_rcu_dîe„ªn˚_vif_id
(
mvm
, 
i
, 
Ál£
);

1578 i‡(!
vif
)

1581 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
)

1585 i‡(
i
 =
NUM_MAC_INDEX_DRIVER
 || !
vif
)

1586 
out_îr
;

1588 
mvm
->
hw
->
exåa_bóc⁄_èûroom
 = 
Àn
;

1590 
bóc⁄
 = 
	`õì80211_bóc⁄_gë_ãm∂©e
(
mvm
->
hw
, 
vif
, 
NULL
, 0);

1591 i‡(!
bóc⁄
)

1592 
out_îr
;

1594 i‡(
Àn
 && 
	`hex2bö
(
	`skb_put_zîo
(
bóc⁄
,Üí), 
bö
,Üen)) {

1595 
	`dev_k‰ì_skb
(
bóc⁄
);

1596 
out_îr
;

1599 
mvm
->
bóc⁄_öje˘_a˘ive
 = 
åue
;

1601 
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1602 
öfo
 = 
	`IEEE80211_SKB_CB
(
bóc⁄
);

1603 
øã
 = 
	`iwl_mvm_mac_˘xt_gë_bóc⁄_øã
(
mvm
, 
öfo
, 
vif
);

1605 
	`f‹_óch_mvm_vif_vÆid_lök
(
mvmvif
, 
lök_id
) {

1606 
bóc⁄_cmd
.
Êags
 =

1607 
	`˝u_to_À16
(
	`iwl_mvm_mac_˘xt_gë_bóc⁄_Êags
(
mvm
->
fw
,

1608 
øã
));

1609 
bóc⁄_cmd
.
byã_˙t
 = 
	`˝u_to_À16
((
u16
)
bóc⁄
->
Àn
);

1610 i‡(
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
BEACON_TEMPLATE_CMD
, 0) > 12)

1611 
bóc⁄_cmd
.
lök_id
 =

1612 
	`˝u_to_À32
(
mvmvif
->
lök
[
lök_id
]->
fw_lök_id
);

1614 
bóc⁄_cmd
.
lök_id
 = 
	`˝u_to_À32
((
u32
)
mvmvif
->
id
);

1616 
	`iwl_mvm_mac_˘xt_£t_tim
(
mvm
, &
bóc⁄_cmd
.
tim_idx
,

1617 &
bóc⁄_cmd
.
tim_size
,

1618 
bóc⁄
->
d©a
, bóc⁄->
Àn
);

1620 
	`iwl_mvm_mac_˘xt_£nd_bóc⁄_cmd
(
mvm
, 
bóc⁄
, &
bóc⁄_cmd
,

1621 (
bóc⁄_cmd
));

1623 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1625 
	`dev_k‰ì_skb
(
bóc⁄
);

1629 
out_îr
:

1630 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1631  -
EINVAL
;

1632 
	}
}

1634 
ssize_t
 
	$iwl_dbgfs_öje˘_bóc⁄_õ_wrôe
(
iwl_mvm
 *
mvm
,

1635 *
buf
, 
size_t
 
cou¡
,

1636 
loff_t
 *
µos
)

1638 
ªt
 = 
	`_iwl_dbgfs_öje˘_bóc⁄_õ
(
mvm
, 
buf
, 
cou¡
);

1640 
mvm
->
hw
->
exåa_bóc⁄_èûroom
 = 0;

1641  
ªt
 ?: 
cou¡
;

1642 
	}
}

1644 
ssize_t
 
	$iwl_dbgfs_öje˘_bóc⁄_õ_ª°‹e_wrôe
(
iwl_mvm
 *
mvm
,

1645 *
buf
,

1646 
size_t
 
cou¡
,

1647 
loff_t
 *
µos
)

1649 
ªt
 = 
	`_iwl_dbgfs_öje˘_bóc⁄_õ
(
mvm
, 
NULL
, 0);

1651 
mvm
->
hw
->
exåa_bóc⁄_èûroom
 = 0;

1652 
mvm
->
bóc⁄_öje˘_a˘ive
 = 
Ál£
;

1653  
ªt
 ?: 
cou¡
;

1654 
	}
}

1656 
ssize_t
 
	$iwl_dbgfs_fw_dbg_c⁄f_ªad
(
fûe
 *file,

1657 
__u£r
 *
u£r_buf
,

1658 
size_t
 
cou¡
, 
loff_t
 *
µos
)

1660 
iwl_mvm
 *
mvm
 = 
fûe
->
¥iv©e_d©a
;

1661 
c⁄f
;

1662 
buf
[8];

1663 c⁄° 
size_t
 
bufsz
 = (
buf
);

1664 
pos
 = 0;

1666 
	`muãx_lock
(&
mvm
->
muãx
);

1667 
c⁄f
 = 
mvm
->
fwπ
.
dump
.conf;

1668 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1670 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
bufsz
 -Öos, "%d\n", 
c⁄f
);

1672  
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buf
, 
pos
);

1673 
	}
}

1675 
ssize_t
 
	$iwl_dbgfs_fw_dbg_c⁄f_wrôe
(
iwl_mvm
 *
mvm
,

1676 *
buf
, 
size_t
 
cou¡
,

1677 
loff_t
 *
µos
)

1679 
c⁄f_id
;

1680 
ªt
;

1682 i‡(!
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
))

1683  -
EIO
;

1685 
ªt
 = 
	`k°πouöt
(
buf
, 0, &
c⁄f_id
);

1686 i‡(
ªt
)

1687  
ªt
;

1689 i‡(
	`WARN_ON
(
c⁄f_id
 >
FW_DBG_CONF_MAX
))

1690  -
EINVAL
;

1692 
	`muãx_lock
(&
mvm
->
muãx
);

1693 
ªt
 = 
	`iwl_fw_°¨t_dbg_c⁄f
(&
mvm
->
fwπ
, 
c⁄f_id
);

1694 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1696  
ªt
 ?: 
cou¡
;

1697 
	}
}

1699 
ssize_t
 
	$iwl_dbgfs_fw_dbg_cﬁÀ˘_wrôe
(
iwl_mvm
 *
mvm
,

1700 *
buf
, 
size_t
 
cou¡
,

1701 
loff_t
 *
µos
)

1703 i‡(
cou¡
 == 0)

1706 
	`iwl_dbg_év_time_poöt
(&
mvm
->
fwπ
, 
IWL_FW_INI_TIME_POINT_USER_TRIGGER
,

1707 
NULL
);

1709 
	`iwl_fw_dbg_cﬁÀ˘
(&
mvm
->
fwπ
, 
FW_DBG_TRIGGER_USER
, 
buf
,

1710 (
cou¡
 - 1), 
NULL
);

1712  
cou¡
;

1713 
	}
}

1715 
ssize_t
 
	$iwl_dbgfs_fw_dbg_˛ór_wrôe
(
iwl_mvm
 *
mvm
,

1716 *
buf
, 
size_t
 
cou¡
,

1717 
loff_t
 *
µos
)

1719 i‡(
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 < 
IWL_DEVICE_FAMILY_9000
)

1720  -
EOPNOTSUPP
;

1722 
	`muãx_lock
(&
mvm
->
muãx
);

1723 
	`iwl_fw_dbg_˛ór_m⁄ô‹_buf
(&
mvm
->
fwπ
);

1724 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1726  
cou¡
;

1727 
	}
}

1729 
ssize_t
 
	$iwl_dbgfs_dbg_time_poöt_wrôe
(
iwl_mvm
 *
mvm
,

1730 *
buf
, 
size_t
 
cou¡
,

1731 
loff_t
 *
µos
)

1733 
u32
 
timïoöt
;

1735 i‡(
	`k°πou32
(
buf
, 0, &
timïoöt
))

1736  -
EINVAL
;

1738 i‡(
timïoöt
 =
IWL_FW_INI_TIME_POINT_INVALID
 ||

1739 
timïoöt
 >
IWL_FW_INI_TIME_POINT_NUM
)

1740  -
EINVAL
;

1742 
	`iwl_dbg_év_time_poöt
(&
mvm
->
fwπ
, 
timïoöt
, 
NULL
);

1744  
cou¡
;

1745 
	}
}

1747 
	#MVM_DEBUGFS_WRITE_FILE_OPS
(
«me
, 
bufsz
) \

1748 
	`_MVM_DEBUGFS_WRITE_FILE_OPS
(
«me
, 
bufsz
, 
iwl_mvm
)

	)

1749 
	#MVM_DEBUGFS_READ_WRITE_FILE_OPS
(
«me
, 
bufsz
) \

1750 
	`_MVM_DEBUGFS_READ_WRITE_FILE_OPS
(
«me
, 
bufsz
, 
iwl_mvm
)

	)

1751 
	#MVM_DEBUGFS_ADD_FILE_ALIAS
(
Æüs
, 
«me
, 
∑ª¡
, 
mode
) do { \

1752 
	`debugfs_¸óã_fûe
(
Æüs
, 
mode
, 
∑ª¡
, 
mvm
, \

1753 &
iwl_dbgfs_
##
«me
##
_›s
); \

1754 } 0)

	)

1755 
	#MVM_DEBUGFS_ADD_FILE
(
«me
, 
∑ª¡
, 
mode
) \

1756 
	`MVM_DEBUGFS_ADD_FILE_ALIAS
(#«me, 
«me
, 
∑ª¡
, 
mode
)

	)

1758 
ssize_t


1759 
	$_iwl_dbgfs_lök_°a_wøp_wrôe
(
	$ssize_t
 (*
ªÆ
)(
õì80211_lök_°a
 *,

1760 
iwl_mvm_°a
 *,

1761 
iwl_mvm
 *,

1762 
iwl_mvm_lök_°a
 *,

1764 
size_t
, 
loff_t
 *),

1765 
fûe
 *file,

1766 *
buf
, 
size_t
 
buf_size
, 
loff_t
 *
µos
)

1768 
õì80211_lök_°a
 *
lök_°a
 = 
fûe
->
¥iv©e_d©a
;

1769 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
lök_°a
->
°a
);

1770 
iwl_mvm
 *
mvm
 = 
	`iwl_mvm_vif_‰om_mac80211
(
mvm°a
->
vif
)->mvm;

1771 
iwl_mvm_lök_°a
 *
mvm_lök_°a
;

1772 
ssize_t
 
ªt
;

1774 
	`muãx_lock
(&
mvm
->
muãx
);

1776 
mvm_lök_°a
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm°a
->
lök
[
lök_°a
->
lök_id
],

1777 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

1778 i‡(
	`WARN_ON
(!
mvm_lök_°a
)) {

1779 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1780  -
ENODEV
;

1783 
ªt
 = 
	`ªÆ
(
lök_°a
, 
mvm°a
, 
mvm
, 
mvm_lök_°a
, 
buf
, 
buf_size
, 
µos
);

1785 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1787  
ªt
;

1788 
	}
}

1790 
ssize_t


1791 
	$_iwl_dbgfs_lök_°a_wøp_ªad
(
	$ssize_t
 (*
ªÆ
)(
õì80211_lök_°a
 *,

1792 
iwl_mvm_°a
 *,

1793 
iwl_mvm
 *,

1794 
iwl_mvm_lök_°a
 *,

1795 
__u£r
 *,

1796 
size_t
, 
loff_t
 *),

1797 
fûe
 *file,

1798 
__u£r
 *
u£r_buf
, 
size_t
 
cou¡
, 
loff_t
 *
µos
)

1800 
õì80211_lök_°a
 *
lök_°a
 = 
fûe
->
¥iv©e_d©a
;

1801 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
lök_°a
->
°a
);

1802 
iwl_mvm
 *
mvm
 = 
	`iwl_mvm_vif_‰om_mac80211
(
mvm°a
->
vif
)->mvm;

1803 
iwl_mvm_lök_°a
 *
mvm_lök_°a
;

1804 
ssize_t
 
ªt
;

1806 
	`muãx_lock
(&
mvm
->
muãx
);

1808 
mvm_lök_°a
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm°a
->
lök
[
lök_°a
->
lök_id
],

1809 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

1810 i‡(
	`WARN_ON
(!
mvm_lök_°a
)) {

1811 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1812  -
ENODEV
;

1815 
ªt
 = 
	`ªÆ
(
lök_°a
, 
mvm°a
, 
mvm
, 
mvm_lök_°a
, 
u£r_buf
, 
cou¡
, 
µos
);

1817 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1819  
ªt
;

1820 
	}
}

1822 
	#MVM_DEBUGFS_LINK_STA_WRITE_WRAPPER
(
«me
, 
buÊí
) \

1823 
ssize_t
 
_iwl_dbgfs_lök_°a_
##
«me
##
	`_wrôe
(
fûe
 *file, \

1824 c⁄° 
__u£r
 *
u£r_buf
, \

1825 
size_t
 
cou¡
, 
loff_t
 *
µos
) \

1827 
buf
[
buÊí
] = {}; \

1828 
size_t
 
buf_size
 = 
	`mö
(
cou¡
, (
buf
) - 1); \

1830 i‡(
	`c›y_‰om_u£r
(
buf
, 
u£r_buf
, 
buf_size
)) \

1831  -
EFAULT
; \

1833  
	`_iwl_dbgfs_lök_°a_wøp_wrôe
(
iwl_dbgfs_
##
«me
##
_wrôe
, \

1834 
fûe
, \

1835 
buf
, 
buf_size
, 
µos
); \

1837 

	)

1838 
	#MVM_DEBUGFS_LINK_STA_READ_WRAPPER
(
«me
) \

1839 
ssize_t
 
_iwl_dbgfs_lök_°a_
##
«me
##
	`_ªad
(
fûe
 *file, \

1840 
__u£r
 *
u£r_buf
, \

1841 
size_t
 
cou¡
, 
loff_t
 *
µos
) \

1843  
	`_iwl_dbgfs_lök_°a_wøp_ªad
(
iwl_dbgfs_
##
«me
##
_ªad
, \

1844 
fûe
, \

1845 
u£r_buf
, 
cou¡
, 
µos
); \

1847 

	)

1848 
	#MVM_DEBUGFS_WRITE_LINK_STA_FILE_OPS
(
«me
, 
bufsz
) \

1849 
	`MVM_DEBUGFS_LINK_STA_WRITE_WRAPPER
(
«me
, 
bufsz
) \

1850 c⁄° 
fûe_›î©i⁄s
 
iwl_dbgfs_lök_°a_
##
«me
##
_›s
 = { \

1851 .
wrôe
 = 
_iwl_dbgfs_lök_°a_
##
«me
##
_wrôe
, \

1852 .
›í
 = 
sim∂e_›í
, \

1853 .
Œ£ek
 = 
gíîic_fûe_Œ£ek
, \

1854 }

	)

1856 
	#MVM_DEBUGFS_READ_LINK_STA_FILE_OPS
(
«me
) \

1857 
	`MVM_DEBUGFS_LINK_STA_READ_WRAPPER
(
«me
) \

1858 c⁄° 
fûe_›î©i⁄s
 
iwl_dbgfs_lök_°a_
##
«me
##
_›s
 = { \

1859 .
ªad
 = 
_iwl_dbgfs_lök_°a_
##
«me
##
_ªad
, \

1860 .
›í
 = 
sim∂e_›í
, \

1861 .
Œ£ek
 = 
gíîic_fûe_Œ£ek
, \

1862 }

	)

1864 
	#MVM_DEBUGFS_READ_WRITE_LINK_STA_FILE_OPS
(
«me
, 
bufsz
) \

1865 
	`MVM_DEBUGFS_LINK_STA_READ_WRAPPER
(
«me
) \

1866 
	`MVM_DEBUGFS_LINK_STA_WRITE_WRAPPER
(
«me
, 
bufsz
) \

1867 c⁄° 
fûe_›î©i⁄s
 
iwl_dbgfs_lök_°a_
##
«me
##
_›s
 = { \

1868 .
ªad
 = 
_iwl_dbgfs_lök_°a_
##
«me
##
_ªad
, \

1869 .
wrôe
 = 
_iwl_dbgfs_lök_°a_
##
«me
##
_wrôe
, \

1870 .
›í
 = 
sim∂e_›í
, \

1871 .
Œ£ek
 = 
gíîic_fûe_Œ£ek
, \

1872 }

	)

1874 
	#MVM_DEBUGFS_ADD_LINK_STA_FILE_ALIAS
(
Æüs
, 
«me
, 
∑ª¡
, 
mode
) \

1875 
	`debugfs_¸óã_fûe
(
Æüs
, 
mode
, 
∑ª¡
, 
lök_°a
, \

1876 &
iwl_dbgfs_lök_°a_
##
«me
##
_›s
)

	)

1877 
	#MVM_DEBUGFS_ADD_LINK_STA_FILE
(
«me
, 
∑ª¡
, 
mode
) \

1878 
	`MVM_DEBUGFS_ADD_LINK_STA_FILE_ALIAS
(#«me, 
«me
, 
∑ª¡
, 
mode
)

	)

1880 
ssize_t


1881 
	$iwl_dbgfs_¥ph_ªg_ªad
(
fûe
 *file,

1882 
__u£r
 *
u£r_buf
,

1883 
size_t
 
cou¡
, 
loff_t
 *
µos
)

1885 
iwl_mvm
 *
mvm
 = 
fûe
->
¥iv©e_d©a
;

1886 
pos
 = 0;

1887 
buf
[32];

1888 c⁄° 
size_t
 
bufsz
 = (
buf
);

1890 i‡(!
mvm
->
dbgfs_¥ph_ªg_addr
)

1891  -
EINVAL
;

1893 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
bufsz
 -Öos, "Reg 0x%x: (0x%x)\n",

1894 
mvm
->
dbgfs_¥ph_ªg_addr
,

1895 
	`iwl_ªad_¥ph
(
mvm
->
å™s
, mvm->
dbgfs_¥ph_ªg_addr
));

1897  
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buf
, 
pos
);

1898 
	}
}

1900 
ssize_t


1901 
	$iwl_dbgfs_¥ph_ªg_wrôe
(
iwl_mvm
 *
mvm
, *
buf
,

1902 
size_t
 
cou¡
, 
loff_t
 *
µos
)

1904 
u8
 
¨gs
;

1905 
u32
 
vÆue
;

1907 
¨gs
 = 
	`ssˇnf
(
buf
, "%ò%i", &
mvm
->
dbgfs_¥ph_ªg_addr
, &
vÆue
);

1909 i‡(
¨gs
 == 1)

1910 
out
;

1913 i‡(
¨gs
 != 2)

1914  -
EINVAL
;

1916 
	`iwl_wrôe_¥ph
(
mvm
->
å™s
, mvm->
dbgfs_¥ph_ªg_addr
, 
vÆue
);

1918 
out
:

1919  
cou¡
;

1920 
	}
}

1922 
ssize_t


1923 
	$iwl_dbgfs_£nd_echo_cmd_wrôe
(
iwl_mvm
 *
mvm
, *
buf
,

1924 
size_t
 
cou¡
, 
loff_t
 *
µos
)

1926 
ªt
;

1928 i‡(!
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
))

1929  -
EIO
;

1931 
	`muãx_lock
(&
mvm
->
muãx
);

1932 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
ECHO_CMD
, 0, 0, 
NULL
);

1933 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1935  
ªt
 ?: 
cou¡
;

1936 
	}
}

1938 
	siwl_mvm_¢if„r_≠∂y
 {

1939 
iwl_mvm
 *
	mmvm
;

1940 
u8
 *
	mbssid
;

1941 
u16
 
	maid
;

1944 
boﬁ
 
	$iwl_mvm_¢if„r_≠∂y
(
iwl_nŸif_waô_d©a
 *
nŸif_d©a
,

1945 
iwl_rx_∑ckë
 *
pkt
, *
d©a
)

1947 
iwl_mvm_¢if„r_≠∂y
 *
≠∂y
 = 
d©a
;

1949 
≠∂y
->
mvm
->
cur_aid
 = 
	`˝u_to_À16
◊µly->
aid
);

1950 
	`mem˝y
(
≠∂y
->
mvm
->
cur_bssid
,áµly->
bssid
,

1951 (
≠∂y
->
mvm
->
cur_bssid
));

1953  
åue
;

1954 
	}
}

1956 
ssize_t


1957 
	$iwl_dbgfs_he_¢if„r_∑øms_wrôe
(
iwl_mvm
 *
mvm
, *
buf
,

1958 
size_t
 
cou¡
, 
loff_t
 *
µos
)

1960 
iwl_nŸifiˇti⁄_waô
 
waô
;

1961 
iwl_he_m⁄ô‹_cmd
 
he_m⁄_cmd
 = {};

1962 
iwl_mvm_¢if„r_≠∂y
 
≠∂y
 = {

1963 .
mvm
 = mvm,

1965 
u16
 
waô_cmds
[] = {

1966 
	`WIDE_ID
(
DATA_PATH_GROUP
, 
HE_AIR_SNIFFER_CONFIG_CMD
),

1968 
u32
 
aid
;

1969 
ªt
;

1971 i‡(!
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
))

1972  -
EIO
;

1974 
ªt
 = 
	`ssˇnf
(
buf
, "%x %2hhx:%2hhx:%2hhx:%2hhx:%2hhx:%2hhx", &
aid
,

1975 &
he_m⁄_cmd
.
bssid
[0], &he_mon_cmd.bssid[1],

1976 &
he_m⁄_cmd
.
bssid
[2], &he_mon_cmd.bssid[3],

1977 &
he_m⁄_cmd
.
bssid
[4], &he_mon_cmd.bssid[5]);

1978 i‡(
ªt
 != 7)

1979  -
EINVAL
;

1981 
he_m⁄_cmd
.
aid
 = 
	`˝u_to_À16
(aid);

1983 
≠∂y
.
aid
 =áid;

1984 
≠∂y
.
bssid
 = (*)
he_m⁄_cmd
.bssid;

1986 
	`muãx_lock
(&
mvm
->
muãx
);

1997 
	`iwl_öô_nŸifiˇti⁄_waô
(&
mvm
->
nŸif_waô
, &
waô
,

1998 
waô_cmds
, 
	`ARRAY_SIZE
(wait_cmds),

1999 
iwl_mvm_¢if„r_≠∂y
, &
≠∂y
);

2001 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
,

2002 
	`WIDE_ID
(
DATA_PATH_GROUP
, 
HE_AIR_SNIFFER_CONFIG_CMD
),

2004 (
he_m⁄_cmd
), &he_mon_cmd);

2007 
	`iwl_ªmove_nŸifiˇti⁄
(&
mvm
->
nŸif_waô
, &
waô
);

2009 
	`muãx_u∆ock
(&
mvm
->
muãx
);

2011  
ªt
 ?: 
cou¡
;

2012 
	}
}

2014 
ssize_t


2015 
	$iwl_dbgfs_he_¢if„r_∑øms_ªad
(
fûe
 *fûe, 
__u£r
 *
u£r_buf
,

2016 
size_t
 
cou¡
, 
loff_t
 *
µos
)

2018 
iwl_mvm
 *
mvm
 = 
fûe
->
¥iv©e_d©a
;

2019 
u8
 
buf
[32];

2020 
Àn
;

2022 
Àn
 = 
	`s˙¥ötf
(
buf
, (buf),

2024 
	`À16_to_˝u
(
mvm
->
cur_aid
), mvm->
cur_bssid
[0],

2025 
mvm
->
cur_bssid
[1], mvm->cur_bssid[2], mvm->cur_bssid[3],

2026 
mvm
->
cur_bssid
[4], mvm->cur_bssid[5]);

2028  
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buf
, 
Àn
);

2029 
	}
}

2031 
ssize_t


2032 
	$iwl_dbgfs_u≠sd_nﬂgg_bssids_ªad
(
fûe
 *fûe, 
__u£r
 *
u£r_buf
,

2033 
size_t
 
cou¡
, 
loff_t
 *
µos
)

2035 
iwl_mvm
 *
mvm
 = 
fûe
->
¥iv©e_d©a
;

2036 
u8
 
buf
[
IWL_MVM_UAPSD_NOAGG_BSSIDS_NUM
 * 
ETH_ALEN
 * 3 + 1];

2037 
pos
 = 0;

2038 
size_t
 
bufsz
 = (
buf
);

2039 
i
;

2041 
	`muãx_lock
(&
mvm
->
muãx
);

2043 
i
 = 0; i < 
IWL_MVM_UAPSD_NOAGG_LIST_LEN
; i++)

2044 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
bufsz
 -Öos, "%pM\n",

2045 
mvm
->
u≠sd_nﬂgg_bssids
[
i
].
addr
);

2047 
	`muãx_u∆ock
(&
mvm
->
muãx
);

2049  
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buf
, 
pos
);

2050 
	}
}

2052 
ssize_t


2053 
	$iwl_dbgfs_…r_c⁄fig_wrôe
(
iwl_mvm
 *
mvm
,

2054 *
buf
, 
size_t
 
cou¡
, 
loff_t
 *
µos
)

2056 
ªt
;

2057 
iwl_…r_c⁄fig_cmd
 
…r_c⁄fig
 = {0};

2059 i‡(!
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
))

2060  -
EIO
;

2062 i‡(
	`ssˇnf
(
buf
, "%x,%x,%x,%x,%x,%x,%x",

2063 &
…r_c⁄fig
.
Êags
,

2064 &
…r_c⁄fig
.
°©ic_l⁄g
,

2065 &
…r_c⁄fig
.
°©ic_sh‹t
,

2066 &
…r_c⁄fig
.
…r_cfg_vÆues
[0],

2067 &
…r_c⁄fig
.
…r_cfg_vÆues
[1],

2068 &
…r_c⁄fig
.
…r_cfg_vÆues
[2],

2069 &
…r_c⁄fig
.
…r_cfg_vÆues
[3]) != 7) {

2070  -
EINVAL
;

2073 
	`muãx_lock
(&
mvm
->
muãx
);

2074 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
LTR_CONFIG
, 0, (
…r_c⁄fig
),

2075 &
…r_c⁄fig
);

2076 
	`muãx_u∆ock
(&
mvm
->
muãx
);

2078 i‡(
ªt
)

2079 
	`IWL_ERR
(
mvm
, "failedÅo sendÜtr configuration cmd\n");

2081  
ªt
 ?: 
cou¡
;

2082 
	}
}

2084 
ssize_t
 
	$iwl_dbgfs_rfi_‰eq_èbÀ_wrôe
(
iwl_mvm
 *
mvm
, *
buf
,

2085 
size_t
 
cou¡
, 
loff_t
 *
µos
)

2087 
ªt
 = 0;

2088 
u16
 
›_id
;

2090 i‡(
	`k°πou16
(
buf
, 10, &
›_id
))

2091  -
EINVAL
;

2094 i‡(!
›_id
) {

2095 
	`muãx_lock
(&
mvm
->
muãx
);

2096 
ªt
 = 
	`iwl_rfi_£nd_c⁄fig_cmd
(
mvm
, 
NULL
);

2097 
	`muãx_u∆ock
(&
mvm
->
muãx
);

2099 
ªt
 = -
EOPNOTSUPP
;

2102  
ªt
 ?: 
cou¡
;

2103 
	}
}

2110 
	#IWL_RFI_BUF_SIZE
 (
IWL_RFI_LUT_INSTALLED_SIZE
 *\

2111 (5 + 
IWL_RFI_LUT_ENTRY_CHANNELS_NUM
 * (6 + 5)))

	)

2113 
ssize_t
 
	$iwl_dbgfs_rfi_‰eq_èbÀ_ªad
(
fûe
 *file,

2114 
__u£r
 *
u£r_buf
,

2115 
size_t
 
cou¡
, 
loff_t
 *
µos
)

2117 
iwl_mvm
 *
mvm
 = 
fûe
->
¥iv©e_d©a
;

2118 
iwl_rfi_‰eq_èbÀ_ª•_cmd
 *
ª•
;

2119 
u32
 
°©us
;

2120 
buf
[
IWL_RFI_BUF_SIZE
];

2121 
i
, 
j
, 
pos
 = 0;

2123 
ª•
 = 
	`iwl_rfi_gë_‰eq_èbÀ
(
mvm
);

2124 i‡(
	`IS_ERR
(
ª•
))

2125  
	`PTR_ERR
(
ª•
);

2127 
°©us
 = 
	`À32_to_˝u
(
ª•
->status);

2128 i‡(
°©us
 !
RFI_FREQ_TABLE_OK
) {

2129 
	`s˙¥ötf
(
buf
, 
IWL_RFI_BUF_SIZE
, "°©u†%d\n", 
°©us
);

2130 
out
;

2133 
i
 = 0; i < 
	`ARRAY_SIZE
(
ª•
->
èbÀ
); i++) {

2134 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
IWL_RFI_BUF_SIZE
 -Öos, "%d: ",

2135 
ª•
->
èbÀ
[
i
].
‰eq
);

2137 
j
 = 0; j < 
	`ARRAY_SIZE
(
ª•
->
èbÀ
[
i
].
ch™√ls
); j++)

2138 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
IWL_RFI_BUF_SIZE
 -Öos,

2140 
ª•
->
èbÀ
[
i
].
ch™√ls
[
j
],

2141 
ª•
->
èbÀ
[
i
].
b™ds
[
j
]);

2142 
pos
 +
	`s˙¥ötf
(
buf
 +Öos, 
IWL_RFI_BUF_SIZE
 -Öos, "\n");

2145 
out
:

2146 
	`k‰ì
(
ª•
);

2147  
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buf
, 
pos
);

2148 
	}
}

2150 
MVM_DEBUGFS_READ_WRITE_FILE_OPS
(
¥ph_ªg
, 64);

2153 
MVM_DEBUGFS_READ_FILE_OPS
(
˘dp_budgë
);

2154 
MVM_DEBUGFS_WRITE_FILE_OPS
(
°›_˘dp
, 8);

2155 
MVM_DEBUGFS_WRITE_FILE_OPS
(
°¨t_˘dp
, 8);

2156 
MVM_DEBUGFS_WRITE_FILE_OPS
(
f‹˚_˘kûl
, 8);

2157 
MVM_DEBUGFS_WRITE_FILE_OPS
(
tx_Êush
, 16);

2158 
MVM_DEBUGFS_WRITE_FILE_OPS
(
°a_døö
, 8);

2159 
MVM_DEBUGFS_WRITE_FILE_OPS
(
£nd_echo_cmd
, 8);

2160 
MVM_DEBUGFS_READ_WRITE_FILE_OPS
(
§am
, 64);

2161 
MVM_DEBUGFS_READ_WRITE_FILE_OPS
(
£t_nic_ãm≥øtuª
, 64);

2162 
MVM_DEBUGFS_READ_FILE_OPS
(
nic_ãmp
);

2163 
MVM_DEBUGFS_READ_FILE_OPS
(
°©i⁄s
);

2164 
MVM_DEBUGFS_READ_LINK_STA_FILE_OPS
(
rs_d©a
);

2165 
MVM_DEBUGFS_READ_FILE_OPS
(
bt_nŸif
);

2166 
MVM_DEBUGFS_READ_FILE_OPS
(
bt_cmd
);

2167 
MVM_DEBUGFS_READ_WRITE_FILE_OPS
(
dißbÀ_powî_off
, 64);

2168 
MVM_DEBUGFS_READ_FILE_OPS
(
fw_rx_°©s
);

2169 
MVM_DEBUGFS_READ_FILE_OPS
(
drv_rx_°©s
);

2170 
MVM_DEBUGFS_READ_FILE_OPS
(
fw_sy°em_°©s
);

2171 
MVM_DEBUGFS_READ_FILE_OPS
(
fw_vî
);

2172 
MVM_DEBUGFS_READ_FILE_OPS
(
phy_öãgøti⁄_vî
);

2173 
MVM_DEBUGFS_READ_FILE_OPS
(
ès_gë_°©us
);

2174 
MVM_DEBUGFS_WRITE_FILE_OPS
(
fw_ª°¨t
, 10);

2175 
MVM_DEBUGFS_WRITE_FILE_OPS
(
fw_nmi
, 10);

2176 
MVM_DEBUGFS_WRITE_FILE_OPS
(
bt_tx_¥io
, 10);

2177 
MVM_DEBUGFS_WRITE_FILE_OPS
(
bt_f‹˚_™t
, 10);

2178 
MVM_DEBUGFS_READ_WRITE_FILE_OPS
(
sˇn_™t_rxchaö
, 8);

2179 
MVM_DEBUGFS_READ_WRITE_FILE_OPS
(
fw_dbg_c⁄f
, 8);

2180 
MVM_DEBUGFS_WRITE_FILE_OPS
(
fw_dbg_cﬁÀ˘
, 64);

2181 
MVM_DEBUGFS_WRITE_FILE_OPS
(
fw_dbg_˛ór
, 64);

2182 
MVM_DEBUGFS_WRITE_FILE_OPS
(
dbg_time_poöt
, 64);

2183 
MVM_DEBUGFS_WRITE_FILE_OPS
(
ödúe˘i⁄_tbl
,

2184 (
IWL_RSS_INDIRECTION_TABLE_SIZE
 * 2));

2185 
MVM_DEBUGFS_WRITE_FILE_OPS
(
öje˘_∑ckë
, 512);

2186 
MVM_DEBUGFS_WRITE_FILE_OPS
(
öje˘_bóc⁄_õ
, 512);

2187 
MVM_DEBUGFS_WRITE_FILE_OPS
(
öje˘_bóc⁄_õ_ª°‹e
, 512);

2189 
MVM_DEBUGFS_READ_FILE_OPS
(
u≠sd_nﬂgg_bssids
);

2191 #ifde‡
CONFIG_ACPI


2192 
MVM_DEBUGFS_READ_FILE_OPS
(
ßr_geo_¥ofûe
);

2193 
MVM_DEBUGFS_READ_FILE_OPS
(
wifi_6e_íabÀ
);

2196 
MVM_DEBUGFS_READ_WRITE_LINK_STA_FILE_OPS
(
amsdu_Àn
, 16);

2198 
MVM_DEBUGFS_READ_WRITE_FILE_OPS
(
he_¢if„r_∑øms
, 32);

2200 
MVM_DEBUGFS_WRITE_FILE_OPS
(
…r_c⁄fig
, 512);

2201 
MVM_DEBUGFS_READ_WRITE_FILE_OPS
(
rfi_‰eq_èbÀ
, 16);

2203 
ssize_t
 
	$iwl_dbgfs_mem_ªad
(
fûe
 *fûe, 
__u£r
 *
u£r_buf
,

2204 
size_t
 
cou¡
, 
loff_t
 *
µos
)

2206 
iwl_mvm
 *
mvm
 = 
fûe
->
¥iv©e_d©a
;

2207 
iwl_dbg_mem_ac˚ss_cmd
 
cmd
 = {};

2208 
iwl_dbg_mem_ac˚ss_r•
 *
r•
;

2209 
iwl_ho°_cmd
 
hcmd
 = {

2210 .
Êags
 = 
CMD_WANT_SKB
 | 
CMD_SEND_IN_RFKILL
,

2211 .
d©a
 = { &
cmd
, },

2212 .
Àn
 = { (
cmd
) },

2214 
size_t
 
dñè
;

2215 
ssize_t
 
ªt
, 
Àn
;

2217 i‡(!
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
))

2218  -
EIO
;

2220 
hcmd
.
id
 = 
	`WIDE_ID
(
DEBUG_GROUP
, *
µos
 >> 24 ? 
UMAC_RD_WR
 : 
LMAC_RD_WR
);

2221 
cmd
.
›
 = 
	`˝u_to_À32
(
DEBUG_MEM_OP_READ
);

2224 
dñè
 = *
µos
 & 0x3;

2225 
cmd
.
addr
 = 
	`˝u_to_À32
(*
µos
 - 
dñè
);

2226 
cmd
.
Àn
 = 
	`˝u_to_À32
(
	`mö
(
	`ALIGN
(
cou¡
 + 
dñè
, 4) / 4,

2227 (
size_t
)
DEBUG_MEM_MAX_SIZE_DWORDS
));

2229 
	`muãx_lock
(&
mvm
->
muãx
);

2230 
ªt
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
hcmd
);

2231 
	`muãx_u∆ock
(&
mvm
->
muãx
);

2233 i‡(
ªt
 < 0)

2234  
ªt
;

2236 i‡(
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
hcmd
.
ª•_pkt
Ë< (*
r•
)) {

2237 
ªt
 = -
EIO
;

2238 
out
;

2241 
r•
 = (*)
hcmd
.
ª•_pkt
->
d©a
;

2242 i‡(
	`À32_to_˝u
(
r•
->
°©us
Ë!
DEBUG_MEM_STATUS_SUCCESS
) {

2243 
ªt
 = -
ENXIO
;

2244 
out
;

2247 
Àn
 = 
	`mö
((
size_t
)
	`À32_to_˝u
(
r•
->len) << 2,

2248 
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
hcmd
.
ª•_pkt
Ë- (*
r•
));

2249 
Àn
 = 
	`mö
÷í - 
dñè
, 
cou¡
);

2250 i‡(
Àn
 < 0) {

2251 
ªt
 = -
EFAULT
;

2252 
out
;

2255 
ªt
 = 
Àn
 - 
	`c›y_to_u£r
(
u£r_buf
, (
u8
 *)
r•
->
d©a
 + 
dñè
,Üen);

2256 *
µos
 +
ªt
;

2258 
out
:

2259 
	`iwl_‰ì_ª•
(&
hcmd
);

2260  
ªt
;

2261 
	}
}

2263 
ssize_t
 
	$iwl_dbgfs_mem_wrôe
(
fûe
 *file,

2264 c⁄° 
__u£r
 *
u£r_buf
, 
size_t
 
cou¡
,

2265 
loff_t
 *
µos
)

2267 
iwl_mvm
 *
mvm
 = 
fûe
->
¥iv©e_d©a
;

2268 
iwl_dbg_mem_ac˚ss_cmd
 *
cmd
;

2269 
iwl_dbg_mem_ac˚ss_r•
 *
r•
;

2270 
iwl_ho°_cmd
 
hcmd
 = {};

2271 
size_t
 
cmd_size
;

2272 
size_t
 
d©a_size
;

2273 
u32
 
›
, 
Àn
;

2274 
ssize_t
 
ªt
;

2276 i‡(!
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
))

2277  -
EIO
;

2279 
hcmd
.
id
 = 
	`WIDE_ID
(
DEBUG_GROUP
, *
µos
 >> 24 ? 
UMAC_RD_WR
 : 
LMAC_RD_WR
);

2281 i‡(*
µos
 & 0x3 || 
cou¡
 < 4) {

2282 
›
 = 
DEBUG_MEM_OP_WRITE_BYTES
;

2283 
Àn
 = 
	`mö
(
cou¡
, (
size_t
)(4 - (*
µos
 & 0x3)));

2284 
d©a_size
 = 
Àn
;

2286 
›
 = 
DEBUG_MEM_OP_WRITE
;

2287 
Àn
 = 
	`mö
(
cou¡
 >> 2, (
size_t
)
DEBUG_MEM_MAX_SIZE_DWORDS
);

2288 
d©a_size
 = 
Àn
 << 2;

2291 
cmd_size
 = (*
cmd
Ë+ 
	`ALIGN
(
d©a_size
, 4);

2292 
cmd
 = 
	`kzÆloc
(
cmd_size
, 
GFP_KERNEL
);

2293 i‡(!
cmd
)

2294  -
ENOMEM
;

2296 
cmd
->
›
 = 
	`˝u_to_À32
(op);

2297 
cmd
->
Àn
 = 
	`˝u_to_À32
(len);

2298 
cmd
->
addr
 = 
	`˝u_to_À32
(*
µos
);

2299 i‡(
	`c›y_‰om_u£r
((*)
cmd
->
d©a
, 
u£r_buf
, 
d©a_size
)) {

2300 
	`k‰ì
(
cmd
);

2301  -
EFAULT
;

2304 
hcmd
.
Êags
 = 
CMD_WANT_SKB
 | 
CMD_SEND_IN_RFKILL
,

2305 
hcmd
.
d©a
[0] = (*)
cmd
;

2306 
hcmd
.
Àn
[0] = 
cmd_size
;

2308 
	`muãx_lock
(&
mvm
->
muãx
);

2309 
ªt
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
hcmd
);

2310 
	`muãx_u∆ock
(&
mvm
->
muãx
);

2312 
	`k‰ì
(
cmd
);

2314 i‡(
ªt
 < 0)

2315  
ªt
;

2317 i‡(
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
hcmd
.
ª•_pkt
Ë< (*
r•
)) {

2318 
ªt
 = -
EIO
;

2319 
out
;

2322 
r•
 = (*)
hcmd
.
ª•_pkt
->
d©a
;

2323 i‡(
r•
->
°©us
 !
DEBUG_MEM_STATUS_SUCCESS
) {

2324 
ªt
 = -
ENXIO
;

2325 
out
;

2328 
ªt
 = 
d©a_size
;

2329 *
µos
 +
ªt
;

2331 
out
:

2332 
	`iwl_‰ì_ª•
(&
hcmd
);

2333  
ªt
;

2334 
	}
}

2336 c⁄° 
fûe_›î©i⁄s
 
	giwl_dbgfs_mem_›s
 = {

2337 .
ªad
 = 
iwl_dbgfs_mem_ªad
,

2338 .
	gwrôe
 = 
iwl_dbgfs_mem_wrôe
,

2339 .
	g›í
 = 
sim∂e_›í
,

2340 .
	gŒ£ek
 = 
deÁu…_Œ£ek
,

2343 
	$iwl_mvm_lök_°a_add_debugfs
(
õì80211_hw
 *
hw
,

2344 
õì80211_vif
 *
vif
,

2345 
õì80211_lök_°a
 *
lök_°a
,

2346 
díåy
 *
dú
)

2348 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

2350 i‡(
	`iwl_mvm_has_éc_ofÊﬂd
(
mvm
)) {

2351 
	`MVM_DEBUGFS_ADD_LINK_STA_FILE
(
rs_d©a
, 
dú
, 0400);

2354 
	`MVM_DEBUGFS_ADD_LINK_STA_FILE
(
amsdu_Àn
, 
dú
, 0600);

2355 
	}
}

2357 
	$iwl_mvm_dbgfs_ªgi°î
(
iwl_mvm
 *
mvm
)

2359 
díåy
 *
bˇ°_dú
 
__maybe_unu£d
;

2361 
	`•ö_lock_öô
(&
mvm
->
drv_°©s_lock
);

2363 
	`MVM_DEBUGFS_ADD_FILE
(
tx_Êush
, 
mvm
->
debugfs_dú
, 0200);

2364 
	`MVM_DEBUGFS_ADD_FILE
(
°a_døö
, 
mvm
->
debugfs_dú
, 0200);

2365 
	`MVM_DEBUGFS_ADD_FILE
(
§am
, 
mvm
->
debugfs_dú
, 0600);

2366 
	`MVM_DEBUGFS_ADD_FILE
(
£t_nic_ãm≥øtuª
, 
mvm
->
debugfs_dú
, 0600);

2367 
	`MVM_DEBUGFS_ADD_FILE
(
nic_ãmp
, 
mvm
->
debugfs_dú
, 0400);

2368 
	`MVM_DEBUGFS_ADD_FILE
(
˘dp_budgë
, 
mvm
->
debugfs_dú
, 0400);

2369 
	`MVM_DEBUGFS_ADD_FILE
(
°›_˘dp
, 
mvm
->
debugfs_dú
, 0200);

2370 
	`MVM_DEBUGFS_ADD_FILE
(
°¨t_˘dp
, 
mvm
->
debugfs_dú
, 0200);

2371 
	`MVM_DEBUGFS_ADD_FILE
(
f‹˚_˘kûl
, 
mvm
->
debugfs_dú
, 0200);

2372 
	`MVM_DEBUGFS_ADD_FILE
(
°©i⁄s
, 
mvm
->
debugfs_dú
, 0400);

2373 
	`MVM_DEBUGFS_ADD_FILE
(
bt_nŸif
, 
mvm
->
debugfs_dú
, 0400);

2374 
	`MVM_DEBUGFS_ADD_FILE
(
bt_cmd
, 
mvm
->
debugfs_dú
, 0400);

2375 
	`MVM_DEBUGFS_ADD_FILE
(
dißbÀ_powî_off
, 
mvm
->
debugfs_dú
, 0600);

2376 
	`MVM_DEBUGFS_ADD_FILE
(
fw_vî
, 
mvm
->
debugfs_dú
, 0400);

2377 
	`MVM_DEBUGFS_ADD_FILE
(
fw_rx_°©s
, 
mvm
->
debugfs_dú
, 0400);

2378 
	`MVM_DEBUGFS_ADD_FILE
(
drv_rx_°©s
, 
mvm
->
debugfs_dú
, 0400);

2379 
	`MVM_DEBUGFS_ADD_FILE
(
fw_sy°em_°©s
, 
mvm
->
debugfs_dú
, 0400);

2380 
	`MVM_DEBUGFS_ADD_FILE
(
fw_ª°¨t
, 
mvm
->
debugfs_dú
, 0200);

2381 
	`MVM_DEBUGFS_ADD_FILE
(
fw_nmi
, 
mvm
->
debugfs_dú
, 0200);

2382 
	`MVM_DEBUGFS_ADD_FILE
(
bt_tx_¥io
, 
mvm
->
debugfs_dú
, 0200);

2383 
	`MVM_DEBUGFS_ADD_FILE
(
bt_f‹˚_™t
, 
mvm
->
debugfs_dú
, 0200);

2384 
	`MVM_DEBUGFS_ADD_FILE
(
sˇn_™t_rxchaö
, 
mvm
->
debugfs_dú
, 0600);

2385 
	`MVM_DEBUGFS_ADD_FILE
(
¥ph_ªg
, 
mvm
->
debugfs_dú
, 0600);

2386 
	`MVM_DEBUGFS_ADD_FILE
(
fw_dbg_c⁄f
, 
mvm
->
debugfs_dú
, 0600);

2387 
	`MVM_DEBUGFS_ADD_FILE
(
fw_dbg_cﬁÀ˘
, 
mvm
->
debugfs_dú
, 0200);

2388 
	`MVM_DEBUGFS_ADD_FILE
(
fw_dbg_˛ór
, 
mvm
->
debugfs_dú
, 0200);

2389 
	`MVM_DEBUGFS_ADD_FILE
(
dbg_time_poöt
, 
mvm
->
debugfs_dú
, 0200);

2390 
	`MVM_DEBUGFS_ADD_FILE
(
£nd_echo_cmd
, 
mvm
->
debugfs_dú
, 0200);

2391 
	`MVM_DEBUGFS_ADD_FILE
(
ödúe˘i⁄_tbl
, 
mvm
->
debugfs_dú
, 0200);

2392 
	`MVM_DEBUGFS_ADD_FILE
(
öje˘_∑ckë
, 
mvm
->
debugfs_dú
, 0200);

2393 
	`MVM_DEBUGFS_ADD_FILE
(
öje˘_bóc⁄_õ
, 
mvm
->
debugfs_dú
, 0200);

2394 
	`MVM_DEBUGFS_ADD_FILE
(
öje˘_bóc⁄_õ_ª°‹e
, 
mvm
->
debugfs_dú
, 0200);

2395 
	`MVM_DEBUGFS_ADD_FILE
(
rfi_‰eq_èbÀ
, 
mvm
->
debugfs_dú
, 0600);

2397 i‡(
mvm
->
fw
->
phy_öãgøti⁄_vî
)

2398 
	`MVM_DEBUGFS_ADD_FILE
(
phy_öãgøti⁄_vî
, 
mvm
->
debugfs_dú
, 0400);

2399 
	`MVM_DEBUGFS_ADD_FILE
(
ès_gë_°©us
, 
mvm
->
debugfs_dú
, 0400);

2400 #ifde‡
CONFIG_ACPI


2401 
	`MVM_DEBUGFS_ADD_FILE
(
ßr_geo_¥ofûe
, 
mvm
->
debugfs_dú
, 0400);

2402 
	`MVM_DEBUGFS_ADD_FILE
(
wifi_6e_íabÀ
, 
mvm
->
debugfs_dú
, 0400);

2404 
	`MVM_DEBUGFS_ADD_FILE
(
he_¢if„r_∑øms
, 
mvm
->
debugfs_dú
, 0600);

2406 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_CAPA_SET_LTR_GEN2
))

2407 
	`MVM_DEBUGFS_ADD_FILE
(
…r_c⁄fig
, 
mvm
->
debugfs_dú
, 0200);

2409 
	`debugfs_¸óã_boﬁ
("enable_scan_iteration_notif", 0600,

2410 
mvm
->
debugfs_dú
, &mvm->
sˇn_ôî_nŸif_íabÀd
);

2411 
	`debugfs_¸óã_boﬁ
("dr›_b˙_≠_mode", 0600, 
mvm
->
debugfs_dú
,

2412 &
mvm
->
dr›_b˙_≠_mode
);

2414 
	`MVM_DEBUGFS_ADD_FILE
(
u≠sd_nﬂgg_bssids
, 
mvm
->
debugfs_dú
, 
S_IRUSR
);

2416 #ifde‡
CONFIG_PM_SLEEP


2417 
	`MVM_DEBUGFS_ADD_FILE
(
d3_ã°
, 
mvm
->
debugfs_dú
, 0400);

2418 
	`debugfs_¸óã_boﬁ
("d3_wake_syßs£π", 0600, 
mvm
->
debugfs_dú
,

2419 &
mvm
->
d3_wake_syßs£π
);

2420 
	`debugfs_¸óã_u32
("œ°_√tdëe˘_sˇns", 0400, 
mvm
->
debugfs_dú
,

2421 &
mvm
->
œ°_√tdëe˘_sˇns
);

2424 
	`debugfs_¸óã_u8
("ps_dißbÀd", 0400, 
mvm
->
debugfs_dú
,

2425 &
mvm
->
ps_dißbÀd
);

2426 
	`debugfs_¸óã_blob
("nvm_hw", 0400, 
mvm
->
debugfs_dú
,

2427 &
mvm
->
nvm_hw_blob
);

2428 
	`debugfs_¸óã_blob
("nvm_sw", 0400, 
mvm
->
debugfs_dú
,

2429 &
mvm
->
nvm_sw_blob
);

2430 
	`debugfs_¸óã_blob
("nvm_ˇlib", 0400, 
mvm
->
debugfs_dú
,

2431 &
mvm
->
nvm_ˇlib_blob
);

2432 
	`debugfs_¸óã_blob
("nvm_¥od", 0400, 
mvm
->
debugfs_dú
,

2433 &
mvm
->
nvm_¥od_blob
);

2434 
	`debugfs_¸óã_blob
("nvm_phy_sku", 0400, 
mvm
->
debugfs_dú
,

2435 &
mvm
->
nvm_phy_sku_blob
);

2436 
	`debugfs_¸óã_blob
("nvm_ªg", 
S_IRUSR
,

2437 
mvm
->
debugfs_dú
, &mvm->
nvm_ªg_blob
);

2439 
	`debugfs_¸óã_fûe
("mem", 0600, 
mvm
->
debugfs_dú
, mvm,

2440 &
iwl_dbgfs_mem_›s
);

2446 i‡(!
	`IS_ERR
(
mvm
->
debugfs_dú
)) {

2447 
buf
[100];

2449 
	`¢¥ötf
(
buf
, 100, "../../%pd2", 
mvm
->
debugfs_dú
->
d_∑ª¡
);

2450 
	`debugfs_¸óã_symlök
("iwlwifi", 
mvm
->
hw
->
wùhy
->
debugfsdú
,

2451 
buf
);

2453 
	}
}

	@debugfs.h

7 
	#MVM_DEBUGFS_READ_FILE_OPS
(
«me
) \

8 c⁄° 
fûe_›î©i⁄s
 
iwl_dbgfs_
##
«me
##
_›s
 = { \

9 .
ªad
 = 
iwl_dbgfs_
##
«me
##
_ªad
, \

10 .
›í
 = 
sim∂e_›í
, \

11 .
Œ£ek
 = 
gíîic_fûe_Œ£ek
, \

12 }

	)

14 
	#MVM_DEBUGFS_WRITE_WRAPPER
(
«me
, 
buÊí
, 
¨gty≥
) \

15 
ssize_t
 
_iwl_dbgfs_
##
«me
##
	`_wrôe
(
fûe
 *file, \

16 c⁄° 
__u£r
 *
u£r_buf
, \

17 
size_t
 
cou¡
, 
loff_t
 *
µos
) \

19 
¨gty≥
 *
¨g
 = 
fûe
->
¥iv©e_d©a
; \

20 
buf
[
buÊí
] = {}; \

21 
size_t
 
buf_size
 = 
	`mö
(
cou¡
, (
buf
) - 1); \

23 i‡(
	`c›y_‰om_u£r
(
buf
, 
u£r_buf
, 
buf_size
)) \

24  -
EFAULT
; \

26  
iwl_dbgfs_
##
«me
##
	`_wrôe
(
¨g
, 
buf
, 
buf_size
, 
µos
); \

28 

	)

29 
	#_MVM_DEBUGFS_READ_WRITE_FILE_OPS
(
«me
, 
buÊí
, 
¨gty≥
) \

30 
	`MVM_DEBUGFS_WRITE_WRAPPER
(
«me
, 
buÊí
, 
¨gty≥
) \

31 c⁄° 
fûe_›î©i⁄s
 
iwl_dbgfs_
##
«me
##
_›s
 = { \

32 .
wrôe
 = 
_iwl_dbgfs_
##
«me
##
_wrôe
, \

33 .
ªad
 = 
iwl_dbgfs_
##
«me
##
_ªad
, \

34 .
›í
 = 
sim∂e_›í
, \

35 .
Œ£ek
 = 
gíîic_fûe_Œ£ek
, \

36 };

	)

38 
	#_MVM_DEBUGFS_WRITE_FILE_OPS
(
«me
, 
buÊí
, 
¨gty≥
) \

39 
	`MVM_DEBUGFS_WRITE_WRAPPER
(
«me
, 
buÊí
, 
¨gty≥
) \

40 c⁄° 
fûe_›î©i⁄s
 
iwl_dbgfs_
##
«me
##
_›s
 = { \

41 .
wrôe
 = 
_iwl_dbgfs_
##
«me
##
_wrôe
, \

42 .
›í
 = 
sim∂e_›í
, \

43 .
Œ£ek
 = 
gíîic_fûe_Œ£ek
, \

44 };

	)

	@ftm-initiator.c

6 
	~<löux/ëhîdevi˚.h
>

7 
	~<löux/m©h64.h
>

8 
	~<√t/cfg80211.h
>

9 
	~"mvm.h
"

10 
	~"iwl-io.h
"

11 
	~"iwl-¥ph.h
"

12 
	~"c⁄°™ts.h
"

14 
	siwl_mvm_loc_íåy
 {

15 
li°_hód
 
	mli°
;

16 
u8
 
	maddr
[
ETH_ALEN
];

17 
u8
 
	mlci_Àn
, 
	mcivic_Àn
;

18 
u8
 
	mbuf
[];

21 
	siwl_mvm_smoŸh_íåy
 {

22 
li°_hód
 
	mli°
;

23 
u8
 
	maddr
[
ETH_ALEN
];

24 
s64
 
	mπt_avg
;

25 
u64
 
	mho°_time
;

28 
	eiwl_mvm_∑¢_Êags
 {

29 
	mIWL_MVM_PASN_FLAG_HAS_HLTK
 = 
BIT
(0),

32 
	siwl_mvm_·m_∑¢_íåy
 {

33 
li°_hód
 
	mli°
;

34 
u8
 
	maddr
[
ETH_ALEN
];

35 
u8
 
	mh…k
[
HLTK_11AZ_LEN
];

36 
u8
 
	mtk
[
TK_11AZ_LEN
];

37 
u8
 
	mcùhî
;

38 
u8
 
	mtx_≤
[
IEEE80211_CCMP_PN_LEN
];

39 
u8
 
	mrx_≤
[
IEEE80211_CCMP_PN_LEN
];

40 
u32
 
	mÊags
;

43 
	$iwl_mvm_·m_add_∑¢_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

44 
u8
 *
addr
, 
u32
 
cùhî
, u8 *
tk
, u32 
tk_Àn
,

45 
u8
 *
h…k
, 
u32
 
h…k_Àn
)

47 
iwl_mvm_·m_∑¢_íåy
 *
∑¢
 = 
	`kzÆloc
((*pasn),

48 
GFP_KERNEL
);

49 
u32
 
ex≥˘ed_tk_Àn
;

51 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

53 i‡(!
∑¢
)

54  -
ENOBUFS
;

56 
	`iwl_mvm_·m_ªmove_∑¢_°a
(
mvm
, 
addr
);

58 
∑¢
->
cùhî
 = 
	`iwl_mvm_cùhî_to_loˇti⁄_cùhî
(cipher);

60 
∑¢
->
cùhî
) {

61 
IWL_LOCATION_CIPHER_CCMP_128
:

62 
IWL_LOCATION_CIPHER_GCMP_128
:

63 
ex≥˘ed_tk_Àn
 = 
WLAN_KEY_LEN_CCMP
;

65 
IWL_LOCATION_CIPHER_GCMP_256
:

66 
ex≥˘ed_tk_Àn
 = 
WLAN_KEY_LEN_GCMP_256
;

69 
out
;

77 i‡(
vif
->
cfg
.
assoc
) {

78 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

79 
õì80211_bss_c⁄f
 *
lök_c⁄f
;

80 
lök_id
;

81 
õì80211_°a
 *
°a
;

82 
u8
 
°a_id
;

84 
	`rcu_ªad_lock
();

85 
	`f‹_óch_vif_a˘ive_lök
(
vif
, 
lök_c⁄f
, 
lök_id
) {

86 i‡(
	`memcmp
(
addr
, 
lök_c⁄f
->
bssid
, 
ETH_ALEN
))

89 
°a_id
 = 
mvmvif
->
lök
[
lök_id
]->
≠_°a_id
;

90 
°a
 = 
	`rcu_dîe„ªn˚
(
mvm
->
fw_id_to_mac_id
[
°a_id
]);

91 i‡(!
	`IS_ERR_OR_NULL
(
°a
Ë&& sè->
mÂ
)

92 
ex≥˘ed_tk_Àn
 = 0;

95 
	`rcu_ªad_u∆ock
();

98 i‡(
tk_Àn
 !
ex≥˘ed_tk_Àn
 ||

99 (
h…k_Àn
 && h…k_À¿!(
∑¢
->
h…k
))) {

100 
	`IWL_ERR
(
mvm
, "Invalid keyÜength:Åk_len=%u hltk_len=%u\n",

101 
tk_Àn
, 
h…k_Àn
);

102 
out
;

105 i‡(!
ex≥˘ed_tk_Àn
 && !
h…k_Àn
) {

106 
	`IWL_ERR
(
mvm
, "TKánd HLTKÇot set\n");

107 
out
;

110 
	`mem˝y
(
∑¢
->
addr
,áddr, (pasn->addr));

112 i‡(
h…k_Àn
) {

113 
	`mem˝y
(
∑¢
->
h…k
, hltk, (pasn->hltk));

114 
∑¢
->
Êags
 |
IWL_MVM_PASN_FLAG_HAS_HLTK
;

117 i‡(
tk
 && 
tk_Àn
)

118 
	`mem˝y
(
∑¢
->
tk
,Åk, (pasn->tk));

120 
	`li°_add_èû
(&
∑¢
->
li°
, &
mvm
->
·m_öôüt‹
.
∑¢_li°
);

122 
out
:

123 
	`k‰ì
(
∑¢
);

124  -
EINVAL
;

125 
	}
}

127 
	$iwl_mvm_·m_ªmove_∑¢_°a
(
iwl_mvm
 *
mvm
, 
u8
 *
addr
)

129 
iwl_mvm_·m_∑¢_íåy
 *
íåy
, *
¥ev
;

131 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

133 
	`li°_f‹_óch_íåy_ß„
(
íåy
, 
¥ev
, &
mvm
->
·m_öôüt‹
.
∑¢_li°
,

134 
li°
) {

135 i‡(
	`memcmp
(
íåy
->
addr
,áddr, (entry->addr)))

138 
	`li°_dñ
(&
íåy
->
li°
);

139 
	`k‰ì
(
íåy
);

142 
	}
}

144 
	$iwl_mvm_·m_ª£t
(
iwl_mvm
 *
mvm
)

146 
iwl_mvm_loc_íåy
 *
e
, *
t
;

148 
mvm
->
·m_öôüt‹
.
ªq
 = 
NULL
;

149 
mvm
->
·m_öôüt‹
.
ªq_wdev
 = 
NULL
;

150 
	`mem£t
(
mvm
->
·m_öôüt‹
.
ª•⁄£s
, 0,

151 (
mvm
->
·m_öôüt‹
.
ª•⁄£s
));

153 
	`li°_f‹_óch_íåy_ß„
(
e
, 
t
, &
mvm
->
·m_öôüt‹
.
loc_li°
, 
li°
) {

154 
	`li°_dñ
(&
e
->
li°
);

155 
	`k‰ì
(
e
);

157 
	}
}

159 
	$iwl_mvm_·m_ª°¨t
(
iwl_mvm
 *
mvm
)

161 
cfg80211_pm§_ªsu…
 
ªsu…
 = {

162 .
°©us
 = 
NL80211_PMSR_STATUS_FAILURE
,

163 .
föÆ
 = 1,

164 .
ho°_time
 = 
	`ktime_gë_boŸtime_ns
(),

165 .
ty≥
 = 
NL80211_PMSR_TYPE_FTM
,

167 
i
;

169 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

171 i‡(!
mvm
->
·m_öôüt‹
.
ªq
)

174 
i
 = 0; i < 
mvm
->
·m_öôüt‹
.
ªq
->
n_≥îs
; i++) {

175 
	`mem˝y
(
ªsu…
.
addr
, 
mvm
->
·m_öôüt‹
.
ªq
->
≥îs
[
i
].addr,

176 
ETH_ALEN
);

177 
ªsu…
.
·m
.
bur°_ödex
 = 
mvm
->
·m_öôüt‹
.
ª•⁄£s
[
i
];

179 
	`cfg80211_pm§_ªp‹t
(
mvm
->
·m_öôüt‹
.
ªq_wdev
,

180 
mvm
->
·m_öôüt‹
.
ªq
,

181 &
ªsu…
, 
GFP_KERNEL
);

184 
	`cfg80211_pm§_com∂ëe
(
mvm
->
·m_öôüt‹
.
ªq_wdev
,

185 
mvm
->
·m_öôüt‹
.
ªq
, 
GFP_KERNEL
);

186 
	`iwl_mvm_·m_ª£t
(
mvm
);

187 
	}
}

189 
	$iwl_mvm_·m_öôüt‹_smoŸh_c⁄fig
(
iwl_mvm
 *
mvm
)

191 
	`INIT_LIST_HEAD
(&
mvm
->
·m_öôüt‹
.
smoŸh
.
ª•
);

193 
	`IWL_DEBUG_INFO
(
mvm
,

195 
IWL_MVM_FTM_INITIATOR_ENABLE_SMOOTH
,

196 
IWL_MVM_FTM_INITIATOR_SMOOTH_ALPHA
,

197 
IWL_MVM_FTM_INITIATOR_SMOOTH_AGE_SEC
 * 
HZ
,

198 
IWL_MVM_FTM_INITIATOR_SMOOTH_OVERSHOOT
,

199 
IWL_MVM_FTM_INITIATOR_SMOOTH_UNDERSHOOT
);

200 
	}
}

202 
	$iwl_mvm_·m_öôüt‹_smoŸh_°›
(
iwl_mvm
 *
mvm
)

204 
iwl_mvm_smoŸh_íåy
 *
£
, *
°
;

206 
	`li°_f‹_óch_íåy_ß„
(
£
, 
°
, &
mvm
->
·m_öôüt‹
.
smoŸh
.
ª•
,

207 
li°
) {

208 
	`li°_dñ
(&
£
->
li°
);

209 
	`k‰ì
(
£
);

211 
	}
}

214 
	$iwl_·m_ønge_ªque°_°©us_to_îr
(
iwl_tof_ønge_ªque°_°©us
 
s
)

216 
s
) {

217 
IWL_TOF_RANGE_REQUEST_STATUS_SUCCESS
:

219 
IWL_TOF_RANGE_REQUEST_STATUS_BUSY
:

220  -
EBUSY
;

222 
	`WARN_ON_ONCE
(1);

223  -
EIO
;

225 
	}
}

227 
	$iwl_mvm_·m_cmd_v5
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

228 
iwl_tof_ønge_ªq_cmd_v5
 *
cmd
,

229 
cfg80211_pm§_ªque°
 *
ªq
)

231 
i
;

233 
cmd
->
ªque°_id
 = 
ªq
->
cookõ
;

234 
cmd
->
num_of_≠
 = 
ªq
->
n_≥îs
;

237 i‡(!
ªq
->
timeout
 ||Ñeq->timeout > 255 * 100)

238 
cmd
->
ªq_timeout
 = 255;

240 
cmd
->
ªq_timeout
 = 
	`DIV_ROUND_UP
(
ªq
->
timeout
, 100);

246 
cmd
->
maˇddr_øndom
 = 1;

247 
	`mem˝y
(
cmd
->
maˇddr_ãm∂©e
, 
ªq
->
mac_addr
, 
ETH_ALEN
);

248 
i
 = 0; i < 
ETH_ALEN
; i++)

249 
cmd
->
maˇddr_mask
[
i
] = ~
ªq
->
mac_addr_mask
[i];

251 i‡(
vif
->
cfg
.
assoc
)

252 
	`mem˝y
(
cmd
->
ønge_ªq_bssid
, 
vif
->
bss_c⁄f
.
bssid
, 
ETH_ALEN
);

254 
	`ëh_brﬂdˇ°_addr
(
cmd
->
ønge_ªq_bssid
);

255 
	}
}

257 
	$iwl_mvm_·m_cmd_comm⁄
(
iwl_mvm
 *
mvm
,

258 
õì80211_vif
 *
vif
,

259 
iwl_tof_ønge_ªq_cmd_v9
 *
cmd
,

260 
cfg80211_pm§_ªque°
 *
ªq
)

262 
i
;

264 
cmd
->
öôüt‹_Êags
 =

265 
	`˝u_to_À32
(
IWL_TOF_INITIATOR_FLAGS_MACADDR_RANDOM
 |

266 
IWL_TOF_INITIATOR_FLAGS_NON_ASAP_SUPPORT
);

267 
cmd
->
ªque°_id
 = 
ªq
->
cookõ
;

268 
cmd
->
num_of_≠
 = 
ªq
->
n_≥îs
;

274 i‡(
ªq
->
timeout
)

275 
cmd
->
ªq_timeout_ms
 = 
	`˝u_to_À32
(
ªq
->
timeout
);

277 
cmd
->
ªq_timeout_ms
 = 
	`˝u_to_À32
(0xfffff);

279 
	`mem˝y
(
cmd
->
maˇddr_ãm∂©e
, 
ªq
->
mac_addr
, 
ETH_ALEN
);

280 
i
 = 0; i < 
ETH_ALEN
; i++)

281 
cmd
->
maˇddr_mask
[
i
] = ~
ªq
->
mac_addr_mask
[i];

283 i‡(
vif
->
cfg
.
assoc
) {

284 
	`mem˝y
(
cmd
->
ønge_ªq_bssid
, 
vif
->
bss_c⁄f
.
bssid
, 
ETH_ALEN
);

287 
i
 = 0; i < 
ªq
->
n_≥îs
; i++) {

288 i‡(
ªq
->
≥îs
[
i
].
ªp‹t_≠_tsf
) {

289 
iwl_mvm_vif
 *
mvmvif
 =

290 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

292 
cmd
->
tsf_mac_id
 = 
	`˝u_to_À32
(
mvmvif
->
id
);

297 
	`ëh_brﬂdˇ°_addr
(
cmd
->
ønge_ªq_bssid
);

301 
cmd
->
tsf_mac_id
 = 
	`˝u_to_À32
(0xff);

302 
	}
}

304 
	$iwl_mvm_·m_cmd_v8
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

305 
iwl_tof_ønge_ªq_cmd_v8
 *
cmd
,

306 
cfg80211_pm§_ªque°
 *
ªq
)

308 
	`iwl_mvm_·m_cmd_comm⁄
(
mvm
, 
vif
, (*)
cmd
, 
ªq
);

309 
	}
}

312 
	$iwl_mvm_·m_èrgë_ch™def_v1
(
iwl_mvm
 *
mvm
,

313 
cfg80211_pm§_ªque°_≥î
 *
≥î
,

314 
u8
 *
ch™√l
, u8 *
b™dwidth
,

315 
u8
 *
˘æ_ch_posôi⁄
)

317 
u32
 
‰eq
 = 
≥î
->
ch™def
.
ch™
->
˚¡î_‰eq
;

319 *
ch™√l
 = 
	`õì80211_‰equícy_to_ch™√l
(
‰eq
);

321 
≥î
->
ch™def
.
width
) {

322 
NL80211_CHAN_WIDTH_20_NOHT
:

323 *
b™dwidth
 = 
IWL_TOF_BW_20_LEGACY
;

325 
NL80211_CHAN_WIDTH_20
:

326 *
b™dwidth
 = 
IWL_TOF_BW_20_HT
;

328 
NL80211_CHAN_WIDTH_40
:

329 *
b™dwidth
 = 
IWL_TOF_BW_40
;

331 
NL80211_CHAN_WIDTH_80
:

332 *
b™dwidth
 = 
IWL_TOF_BW_80
;

335 
	`IWL_ERR
(
mvm
, "Unsupported BW in FTMÑequest (%d)\n",

336 
≥î
->
ch™def
.
width
);

337  -
EINVAL
;

340 *
˘æ_ch_posôi⁄
 = (
≥î
->
ch™def
.
width
 > 
NL80211_CHAN_WIDTH_20
) ?

341 
	`iwl_mvm_gë_˘æ_pos
(&
≥î
->
ch™def
) : 0;

344 
	}
}

347 
	$iwl_mvm_·m_èrgë_ch™def_v2
(
iwl_mvm
 *
mvm
,

348 
cfg80211_pm§_ªque°_≥î
 *
≥î
,

349 
u8
 *
ch™√l
, u8 *
f‹m©_bw
,

350 
u8
 *
˘æ_ch_posôi⁄
)

352 
u32
 
‰eq
 = 
≥î
->
ch™def
.
ch™
->
˚¡î_‰eq
;

353 
u8
 
cmd_vî
;

355 *
ch™√l
 = 
	`õì80211_‰equícy_to_ch™√l
(
‰eq
);

357 
≥î
->
ch™def
.
width
) {

358 
NL80211_CHAN_WIDTH_20_NOHT
:

359 *
f‹m©_bw
 = 
IWL_LOCATION_FRAME_FORMAT_LEGACY
;

360 *
f‹m©_bw
 |
IWL_LOCATION_BW_20MHZ
 << 
LOCATION_BW_POS
;

362 
NL80211_CHAN_WIDTH_20
:

363 *
f‹m©_bw
 = 
IWL_LOCATION_FRAME_FORMAT_HT
;

364 *
f‹m©_bw
 |
IWL_LOCATION_BW_20MHZ
 << 
LOCATION_BW_POS
;

366 
NL80211_CHAN_WIDTH_40
:

367 *
f‹m©_bw
 = 
IWL_LOCATION_FRAME_FORMAT_HT
;

368 *
f‹m©_bw
 |
IWL_LOCATION_BW_40MHZ
 << 
LOCATION_BW_POS
;

370 
NL80211_CHAN_WIDTH_80
:

371 *
f‹m©_bw
 = 
IWL_LOCATION_FRAME_FORMAT_VHT
;

372 *
f‹m©_bw
 |
IWL_LOCATION_BW_80MHZ
 << 
LOCATION_BW_POS
;

374 
NL80211_CHAN_WIDTH_160
:

375 
cmd_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
,

376 
	`WIDE_ID
(
LOCATION_GROUP
, 
TOF_RANGE_REQ_CMD
),

377 
IWL_FW_CMD_VER_UNKNOWN
);

379 i‡(
cmd_vî
 >= 13) {

380 *
f‹m©_bw
 = 
IWL_LOCATION_FRAME_FORMAT_HE
;

381 *
f‹m©_bw
 |
IWL_LOCATION_BW_160MHZ
 << 
LOCATION_BW_POS
;

384 
ÁŒthrough
;

386 
	`IWL_ERR
(
mvm
, "Unsupported BW in FTMÑequest (%d)\n",

387 
≥î
->
ch™def
.
width
);

388  -
EINVAL
;

392 i‡(
≥î
->
·m
.
åiggî_ba£d
 ||Öìr->·m.
n⁄_åiggî_ba£d
)

393 *
f‹m©_bw
 |
IWL_LOCATION_FRAME_FORMAT_HE
;

395 *
˘æ_ch_posôi⁄
 = (
≥î
->
ch™def
.
width
 > 
NL80211_CHAN_WIDTH_20
) ?

396 
	`iwl_mvm_gë_˘æ_pos
(&
≥î
->
ch™def
) : 0;

399 
	}
}

402 
	$iwl_mvm_·m_put_èrgë_v2
(
iwl_mvm
 *
mvm
,

403 
cfg80211_pm§_ªque°_≥î
 *
≥î
,

404 
iwl_tof_ønge_ªq_≠_íåy_v2
 *
èrgë
)

406 
ªt
;

408 
ªt
 = 
	`iwl_mvm_·m_èrgë_ch™def_v1
(
mvm
, 
≥î
, &
èrgë
->
ch™√l_num
,

409 &
èrgë
->
b™dwidth
,

410 &
èrgë
->
˘æ_ch_posôi⁄
);

411 i‡(
ªt
)

412  
ªt
;

414 
	`mem˝y
(
èrgë
->
bssid
, 
≥î
->
addr
, 
ETH_ALEN
);

415 
èrgë
->
bur°_≥riod
 =

416 
	`˝u_to_À16
(
≥î
->
·m
.
bur°_≥riod
);

417 
èrgë
->
ßm∂es_≥r_bur°
 = 
≥î
->
·m
.
·ms_≥r_bur°
;

418 
èrgë
->
num_of_bur°s
 = 
≥î
->
·m
.
num_bur°s_exp
;

419 
èrgë
->
mósuª_ty≥
 = 0;

420 
èrgë
->
ªåõs_≥r_ßm∂e
 = 
≥î
->
·m
.
·mr_ªåõs
;

421 
èrgë
->
aßp_mode
 = 
≥î
->
·m
.
aßp
;

422 
èrgë
->
íabÀ_dyn_ack
 = 
IWL_MVM_FTM_INITIATOR_DYNACK
;

424 i‡(
≥î
->
·m
.
ªque°_lci
)

425 
èrgë
->
loˇti⁄_ªq
 |
IWL_TOF_LOC_LCI
;

426 i‡(
≥î
->
·m
.
ªque°_civi˛oc
)

427 
èrgë
->
loˇti⁄_ªq
 |
IWL_TOF_LOC_CIVIC
;

429 
èrgë
->
Ægo_ty≥
 = 
IWL_MVM_FTM_INITIATOR_ALGO
;

432 
	}
}

434 
	#FTM_PUT_FLAG
(
Êag
Ë(
èrgë
->
öôüt‹_≠_Êags
 |= \

435 
	`˝u_to_À32
(
IWL_INITIATOR_AP_FLAGS_
##
Êag
))

	)

438 
	$iwl_mvm_·m_put_èrgë_comm⁄
(
iwl_mvm
 *
mvm
,

439 
cfg80211_pm§_ªque°_≥î
 *
≥î
,

440 
iwl_tof_ønge_ªq_≠_íåy_v6
 *
èrgë
)

442 
	`mem˝y
(
èrgë
->
bssid
, 
≥î
->
addr
, 
ETH_ALEN
);

443 
èrgë
->
bur°_≥riod
 =

444 
	`˝u_to_À16
(
≥î
->
·m
.
bur°_≥riod
);

445 
èrgë
->
ßm∂es_≥r_bur°
 = 
≥î
->
·m
.
·ms_≥r_bur°
;

446 
èrgë
->
num_of_bur°s
 = 
≥î
->
·m
.
num_bur°s_exp
;

447 
èrgë
->
·mr_max_ªåõs
 = 
≥î
->
·m
.
·mr_ªåõs
;

448 
èrgë
->
öôüt‹_≠_Êags
 = 
	`˝u_to_À32
(0);

450 i‡(
≥î
->
·m
.
aßp
)

451 
	`FTM_PUT_FLAG
(
ASAP
);

453 i‡(
≥î
->
·m
.
ªque°_lci
)

454 
	`FTM_PUT_FLAG
(
LCI_REQUEST
);

456 i‡(
≥î
->
·m
.
ªque°_civi˛oc
)

457 
	`FTM_PUT_FLAG
(
CIVIC_REQUEST
);

459 i‡(
IWL_MVM_FTM_INITIATOR_DYNACK
)

460 
	`FTM_PUT_FLAG
(
DYN_ACK
);

462 i‡(
IWL_MVM_FTM_INITIATOR_ALGO
 =
IWL_TOF_ALGO_TYPE_LINEAR_REG
)

463 
	`FTM_PUT_FLAG
(
ALGO_LR
);

464 i‡(
IWL_MVM_FTM_INITIATOR_ALGO
 =
IWL_TOF_ALGO_TYPE_FFT
)

465 
	`FTM_PUT_FLAG
(
ALGO_FFT
);

467 i‡(
≥î
->
·m
.
åiggî_ba£d
)

468 
	`FTM_PUT_FLAG
(
TB
);

469 i‡(
≥î
->
·m
.
n⁄_åiggî_ba£d
)

470 
	`FTM_PUT_FLAG
(
NON_TB
);

472 i‡((
≥î
->
·m
.
åiggî_ba£d
 ||Öìr->·m.
n⁄_åiggî_ba£d
) &&

473 
≥î
->
·m
.
lmr_„edback
)

474 
	`FTM_PUT_FLAG
(
LMR_FEEDBACK
);

475 
	}
}

478 
	$iwl_mvm_·m_put_èrgë_v3
(
iwl_mvm
 *
mvm
,

479 
cfg80211_pm§_ªque°_≥î
 *
≥î
,

480 
iwl_tof_ønge_ªq_≠_íåy_v3
 *
èrgë
)

482 
ªt
;

484 
ªt
 = 
	`iwl_mvm_·m_èrgë_ch™def_v1
(
mvm
, 
≥î
, &
èrgë
->
ch™√l_num
,

485 &
èrgë
->
b™dwidth
,

486 &
èrgë
->
˘æ_ch_posôi⁄
);

487 i‡(
ªt
)

488  
ªt
;

494 
	`iwl_mvm_·m_put_èrgë_comm⁄
(
mvm
, 
≥î
, (*)
èrgë
);

497 
	}
}

500 
	$iwl_mvm_·m_put_èrgë_v4
(
iwl_mvm
 *
mvm
,

501 
cfg80211_pm§_ªque°_≥î
 *
≥î
,

502 
iwl_tof_ønge_ªq_≠_íåy_v4
 *
èrgë
)

504 
ªt
;

506 
ªt
 = 
	`iwl_mvm_·m_èrgë_ch™def_v2
(
mvm
, 
≥î
, &
èrgë
->
ch™√l_num
,

507 &
èrgë
->
f‹m©_bw
,

508 &
èrgë
->
˘æ_ch_posôi⁄
);

509 i‡(
ªt
)

510  
ªt
;

512 
	`iwl_mvm_·m_put_èrgë_comm⁄
(
mvm
, 
≥î
, (*)
èrgë
);

515 
	}
}

518 
	$iwl_mvm_·m_put_èrgë
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

519 
cfg80211_pm§_ªque°_≥î
 *
≥î
,

520 
iwl_tof_ønge_ªq_≠_íåy_v6
 *
èrgë
)

522 
ªt
;

524 
ªt
 = 
	`iwl_mvm_·m_èrgë_ch™def_v2
(
mvm
, 
≥î
, &
èrgë
->
ch™√l_num
,

525 &
èrgë
->
f‹m©_bw
,

526 &
èrgë
->
˘æ_ch_posôi⁄
);

527 i‡(
ªt
)

528  
ªt
;

530 
	`iwl_mvm_·m_put_èrgë_comm⁄
(
mvm
, 
≥î
, 
èrgë
);

532 i‡(
vif
->
cfg
.
assoc
) {

533 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

534 
õì80211_°a
 *
°a
;

535 
õì80211_bss_c⁄f
 *
lök_c⁄f
;

536 
lök_id
;

538 
	`rcu_ªad_lock
();

539 
	`f‹_óch_vif_a˘ive_lök
(
vif
, 
lök_c⁄f
, 
lök_id
) {

540 i‡(
	`memcmp
(
≥î
->
addr
, 
lök_c⁄f
->
bssid
, 
ETH_ALEN
))

543 
èrgë
->
°a_id
 = 
mvmvif
->
lök
[
lök_id
]->
≠_°a_id
;

544 
°a
 = 
	`rcu_dîe„ªn˚
(
mvm
->
fw_id_to_mac_id
[
èrgë
->
°a_id
]);

545 i‡(
	`WARN_ON_ONCE
(
	`IS_ERR_OR_NULL
(
°a
))) {

546 
	`rcu_ªad_u∆ock
();

547  
	`PTR_ERR_OR_ZERO
(
°a
);

550 i‡(
°a
->
mÂ
 && (
≥î
->
·m
.
åiggî_ba£d
 ||

551 
≥î
->
·m
.
n⁄_åiggî_ba£d
))

552 
	`FTM_PUT_FLAG
(
PMF
);

555 
	`rcu_ªad_u∆ock
();

557 
èrgë
->
°a_id
 = 
IWL_MVM_INVALID_STA
;

564 
èrgë
->
bóc⁄_öãrvÆ
 = 
	`˝u_to_À16
(100);

566 
	}
}

568 
	$iwl_mvm_·m_£nd_cmd
(
iwl_mvm
 *
mvm
, 
iwl_ho°_cmd
 *
hcmd
)

570 
u32
 
°©us
;

571 
îr
 = 
	`iwl_mvm_£nd_cmd_°©us
(
mvm
, 
hcmd
, &
°©us
);

573 i‡(!
îr
 && 
°©us
) {

574 
	`IWL_ERR
(
mvm
, "FTMÑangeÑequest command failure, status: %u\n",

575 
°©us
);

576 
îr
 = 
	`iwl_·m_ønge_ªque°_°©us_to_îr
(
°©us
);

579  
îr
;

580 
	}
}

582 
	$iwl_mvm_·m_°¨t_v5
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

583 
cfg80211_pm§_ªque°
 *
ªq
)

585 
iwl_tof_ønge_ªq_cmd_v5
 
cmd_v5
;

586 
iwl_ho°_cmd
 
hcmd
 = {

587 .
id
 = 
	`WIDE_ID
(
LOCATION_GROUP
, 
TOF_RANGE_REQ_CMD
),

588 .
d©aÊags
[0] = 
IWL_HCMD_DFL_DUP
,

589 .
d©a
[0] = &
cmd_v5
,

590 .
Àn
[0] = (
cmd_v5
),

592 
u8
 
i
;

593 
îr
;

595 
	`iwl_mvm_·m_cmd_v5
(
mvm
, 
vif
, &
cmd_v5
, 
ªq
);

597 
i
 = 0; i < 
cmd_v5
.
num_of_≠
; i++) {

598 
cfg80211_pm§_ªque°_≥î
 *
≥î
 = &
ªq
->
≥îs
[
i
];

600 
îr
 = 
	`iwl_mvm_·m_put_èrgë_v2
(
mvm
, 
≥î
, &
cmd_v5
.
≠
[
i
]);

601 i‡(
îr
)

602  
îr
;

605  
	`iwl_mvm_·m_£nd_cmd
(
mvm
, &
hcmd
);

606 
	}
}

608 
	$iwl_mvm_·m_°¨t_v7
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

609 
cfg80211_pm§_ªque°
 *
ªq
)

611 
iwl_tof_ønge_ªq_cmd_v7
 
cmd_v7
;

612 
iwl_ho°_cmd
 
hcmd
 = {

613 .
id
 = 
	`WIDE_ID
(
LOCATION_GROUP
, 
TOF_RANGE_REQ_CMD
),

614 .
d©aÊags
[0] = 
IWL_HCMD_DFL_DUP
,

615 .
d©a
[0] = &
cmd_v7
,

616 .
Àn
[0] = (
cmd_v7
),

618 
u8
 
i
;

619 
îr
;

625 
	`iwl_mvm_·m_cmd_v8
(
mvm
, 
vif
, (*)&
cmd_v7
, 
ªq
);

627 
i
 = 0; i < 
cmd_v7
.
num_of_≠
; i++) {

628 
cfg80211_pm§_ªque°_≥î
 *
≥î
 = &
ªq
->
≥îs
[
i
];

630 
îr
 = 
	`iwl_mvm_·m_put_èrgë_v3
(
mvm
, 
≥î
, &
cmd_v7
.
≠
[
i
]);

631 i‡(
îr
)

632  
îr
;

635  
	`iwl_mvm_·m_£nd_cmd
(
mvm
, &
hcmd
);

636 
	}
}

638 
	$iwl_mvm_·m_°¨t_v8
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

639 
cfg80211_pm§_ªque°
 *
ªq
)

641 
iwl_tof_ønge_ªq_cmd_v8
 
cmd
;

642 
iwl_ho°_cmd
 
hcmd
 = {

643 .
id
 = 
	`WIDE_ID
(
LOCATION_GROUP
, 
TOF_RANGE_REQ_CMD
),

644 .
d©aÊags
[0] = 
IWL_HCMD_DFL_DUP
,

645 .
d©a
[0] = &
cmd
,

646 .
Àn
[0] = (
cmd
),

648 
u8
 
i
;

649 
îr
;

651 
	`iwl_mvm_·m_cmd_v8
(
mvm
, 
vif
, (*)&
cmd
, 
ªq
);

653 
i
 = 0; i < 
cmd
.
num_of_≠
; i++) {

654 
cfg80211_pm§_ªque°_≥î
 *
≥î
 = &
ªq
->
≥îs
[
i
];

656 
îr
 = 
	`iwl_mvm_·m_put_èrgë_v4
(
mvm
, 
≥î
, &
cmd
.
≠
[
i
]);

657 i‡(
îr
)

658  
îr
;

661  
	`iwl_mvm_·m_£nd_cmd
(
mvm
, &
hcmd
);

662 
	}
}

664 
	$iwl_mvm_·m_°¨t_v9
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

665 
cfg80211_pm§_ªque°
 *
ªq
)

667 
iwl_tof_ønge_ªq_cmd_v9
 
cmd
;

668 
iwl_ho°_cmd
 
hcmd
 = {

669 .
id
 = 
	`WIDE_ID
(
LOCATION_GROUP
, 
TOF_RANGE_REQ_CMD
),

670 .
d©aÊags
[0] = 
IWL_HCMD_DFL_DUP
,

671 .
d©a
[0] = &
cmd
,

672 .
Àn
[0] = (
cmd
),

674 
u8
 
i
;

675 
îr
;

677 
	`iwl_mvm_·m_cmd_comm⁄
(
mvm
, 
vif
, &
cmd
, 
ªq
);

679 
i
 = 0; i < 
cmd
.
num_of_≠
; i++) {

680 
cfg80211_pm§_ªque°_≥î
 *
≥î
 = &
ªq
->
≥îs
[
i
];

681 
iwl_tof_ønge_ªq_≠_íåy_v6
 *
èrgë
 = &
cmd
.
≠
[
i
];

683 
îr
 = 
	`iwl_mvm_·m_put_èrgë
(
mvm
, 
vif
, 
≥î
, 
èrgë
);

684 i‡(
îr
)

685  
îr
;

688  
	`iwl_mvm_·m_£nd_cmd
(
mvm
, &
hcmd
);

689 
	}
}

691 
	$ôî
(
õì80211_hw
 *
hw
,

692 
õì80211_vif
 *
vif
,

693 
õì80211_°a
 *
°a
,

694 
õì80211_key_c⁄f
 *
key
,

695 *
d©a
)

697 
iwl_tof_ønge_ªq_≠_íåy_v6
 *
èrgë
 = 
d©a
;

699 i‡(!
°a
 || 
	`memcmp
(°a->
addr
, 
èrgë
->
bssid
, 
ETH_ALEN
))

702 
	`WARN_ON
(!
°a
->
mÂ
);

704 i‡(
	`WARN_ON
(
key
->
keyÀn
 > (
èrgë
->
tk
)))

707 
	`mem˝y
(
èrgë
->
tk
, 
key
->key, key->
keyÀn
);

708 
èrgë
->
cùhî
 = 
	`iwl_mvm_cùhî_to_loˇti⁄_cùhî
(
key
->cipher);

709 
	`WARN_ON
(
èrgë
->
cùhî
 =
IWL_LOCATION_CIPHER_INVALID
);

710 
	}
}

713 
	$iwl_mvm_·m_£t_£cuªd_øngög
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

714 
iwl_tof_ønge_ªq_≠_íåy_v7
 *
èrgë
)

716 
iwl_mvm_·m_∑¢_íåy
 *
íåy
;

717 
u32
 
Êags
 = 
	`À32_to_˝u
(
èrgë
->
öôüt‹_≠_Êags
);

719 i‡(!(
Êags
 & (
IWL_INITIATOR_AP_FLAGS_NON_TB
 |

720 
IWL_INITIATOR_AP_FLAGS_TB
)))

723 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

725 
	`li°_f‹_óch_íåy
(
íåy
, &
mvm
->
·m_öôüt‹
.
∑¢_li°
, 
li°
) {

726 i‡(
	`memcmp
(
íåy
->
addr
, 
èrgë
->
bssid
, (entry->addr)))

729 
èrgë
->
cùhî
 = 
íåy
->cipher;

731 i‡(
íåy
->
Êags
 & 
IWL_MVM_PASN_FLAG_HAS_HLTK
)

732 
	`mem˝y
(
èrgë
->
h…k
, 
íåy
->hltk, (target->hltk));

734 
	`mem£t
(
èrgë
->
h…k
, 0, (target->hltk));

736 i‡(
vif
->
cfg
.
assoc
 &&

737 !
	`memcmp
(
vif
->
bss_c⁄f
.
bssid
, 
èrgë
->bssid,

738 (
èrgë
->
bssid
)))

739 
	`õì80211_ôî_keys
(
mvm
->
hw
, 
vif
, 
ôî
, 
èrgë
);

741 
	`mem˝y
(
èrgë
->
tk
, 
íåy
->tk, (target->tk));

743 
	`mem˝y
(
èrgë
->
rx_≤
, 
íåy
->rx_pn, (target->rx_pn));

744 
	`mem˝y
(
èrgë
->
tx_≤
, 
íåy
->tx_pn, (target->tx_pn));

746 
èrgë
->
öôüt‹_≠_Êags
 |=

747 
	`˝u_to_À32
(
IWL_INITIATOR_AP_FLAGS_SECURED
);

750 
	}
}

753 
	$iwl_mvm_·m_put_èrgë_v7
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

754 
cfg80211_pm§_ªque°_≥î
 *
≥î
,

755 
iwl_tof_ønge_ªq_≠_íåy_v7
 *
èrgë
)

757 
îr
 = 
	`iwl_mvm_·m_put_èrgë
(
mvm
, 
vif
, 
≥î
, (*)
èrgë
);

758 i‡(
îr
)

759  
îr
;

761 
	`iwl_mvm_·m_£t_£cuªd_øngög
(
mvm
, 
vif
, 
èrgë
);

762  
îr
;

763 
	}
}

765 
	$iwl_mvm_·m_°¨t_v11
(
iwl_mvm
 *
mvm
,

766 
õì80211_vif
 *
vif
,

767 
cfg80211_pm§_ªque°
 *
ªq
)

769 
iwl_tof_ønge_ªq_cmd_v11
 
cmd
;

770 
iwl_ho°_cmd
 
hcmd
 = {

771 .
id
 = 
	`WIDE_ID
(
LOCATION_GROUP
, 
TOF_RANGE_REQ_CMD
),

772 .
d©aÊags
[0] = 
IWL_HCMD_DFL_DUP
,

773 .
d©a
[0] = &
cmd
,

774 .
Àn
[0] = (
cmd
),

776 
u8
 
i
;

777 
îr
;

779 
	`iwl_mvm_·m_cmd_comm⁄
(
mvm
, 
vif
, (*)&
cmd
, 
ªq
);

781 
i
 = 0; i < 
cmd
.
num_of_≠
; i++) {

782 
cfg80211_pm§_ªque°_≥î
 *
≥î
 = &
ªq
->
≥îs
[
i
];

783 
iwl_tof_ønge_ªq_≠_íåy_v7
 *
èrgë
 = &
cmd
.
≠
[
i
];

785 
îr
 = 
	`iwl_mvm_·m_put_èrgë_v7
(
mvm
, 
vif
, 
≥î
, 
èrgë
);

786 i‡(
îr
)

787  
îr
;

790  
	`iwl_mvm_·m_£nd_cmd
(
mvm
, &
hcmd
);

791 
	}
}

794 
	$iwl_mvm_·m_£t_ndp_∑øms
(
iwl_mvm
 *
mvm
,

795 
iwl_tof_ønge_ªq_≠_íåy_v8
 *
èrgë
)

798 
u32
 
i2r_max_°s
 = 
IWL_MVM_FTM_I2R_MAX_STS
 > 1 ? 1 :

799 
IWL_MVM_FTM_I2R_MAX_STS
;

801 
èrgë
->
r2i_ndp_∑øms
 = 
IWL_MVM_FTM_R2I_MAX_REP
 |

802 (
IWL_MVM_FTM_R2I_MAX_STS
 << 
IWL_LOCATION_MAX_STS_POS
);

803 
èrgë
->
i2r_ndp_∑øms
 = 
IWL_MVM_FTM_I2R_MAX_REP
 |

804 (
i2r_max_°s
 << 
IWL_LOCATION_MAX_STS_POS
);

805 
èrgë
->
r2i_max_tŸÆ_…f
 = 
IWL_MVM_FTM_R2I_MAX_TOTAL_LTF
;

806 
èrgë
->
i2r_max_tŸÆ_…f
 = 
IWL_MVM_FTM_I2R_MAX_TOTAL_LTF
;

807 
	}
}

810 
	$iwl_mvm_·m_put_èrgë_v8
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

811 
cfg80211_pm§_ªque°_≥î
 *
≥î
,

812 
iwl_tof_ønge_ªq_≠_íåy_v8
 *
èrgë
)

814 
u32
 
Êags
;

815 
ªt
 = 
	`iwl_mvm_·m_put_èrgë_v7
(
mvm
, 
vif
, 
≥î
, (*)
èrgë
);

817 i‡(
ªt
)

818  
ªt
;

820 
	`iwl_mvm_·m_£t_ndp_∑øms
(
mvm
, 
èrgë
);

825 
Êags
 = 
	`À32_to_˝u
(
èrgë
->
öôüt‹_≠_Êags
);

826 i‡(
Êags
 & 
IWL_INITIATOR_AP_FLAGS_SECURED
) {

827 i‡(!
IWL_MVM_FTM_INITIATOR_SECURE_LTF
)

828 
Êags
 &~
IWL_INITIATOR_AP_FLAGS_SECURED
;

830 
Êags
 |
IWL_INITIATOR_AP_FLAGS_PMF
;

831 
èrgë
->
öôüt‹_≠_Êags
 = 
	`˝u_to_À32
(
Êags
);

835 
	}
}

837 
	$iwl_mvm_·m_°¨t_v12
(
iwl_mvm
 *
mvm
,

838 
õì80211_vif
 *
vif
,

839 
cfg80211_pm§_ªque°
 *
ªq
)

841 
iwl_tof_ønge_ªq_cmd_v12
 
cmd
;

842 
iwl_ho°_cmd
 
hcmd
 = {

843 .
id
 = 
	`WIDE_ID
(
LOCATION_GROUP
, 
TOF_RANGE_REQ_CMD
),

844 .
d©aÊags
[0] = 
IWL_HCMD_DFL_DUP
,

845 .
d©a
[0] = &
cmd
,

846 .
Àn
[0] = (
cmd
),

848 
u8
 
i
;

849 
îr
;

851 
	`iwl_mvm_·m_cmd_comm⁄
(
mvm
, 
vif
, (*)&
cmd
, 
ªq
);

853 
i
 = 0; i < 
cmd
.
num_of_≠
; i++) {

854 
cfg80211_pm§_ªque°_≥î
 *
≥î
 = &
ªq
->
≥îs
[
i
];

855 
iwl_tof_ønge_ªq_≠_íåy_v8
 *
èrgë
 = &
cmd
.
≠
[
i
];

857 
îr
 = 
	`iwl_mvm_·m_put_èrgë_v8
(
mvm
, 
vif
, 
≥î
, 
èrgë
);

858 i‡(
îr
)

859  
îr
;

862  
	`iwl_mvm_·m_£nd_cmd
(
mvm
, &
hcmd
);

863 
	}
}

865 
	$iwl_mvm_·m_°¨t_v13
(
iwl_mvm
 *
mvm
,

866 
õì80211_vif
 *
vif
,

867 
cfg80211_pm§_ªque°
 *
ªq
)

869 
iwl_tof_ønge_ªq_cmd_v13
 
cmd
;

870 
iwl_ho°_cmd
 
hcmd
 = {

871 .
id
 = 
	`WIDE_ID
(
LOCATION_GROUP
, 
TOF_RANGE_REQ_CMD
),

872 .
d©aÊags
[0] = 
IWL_HCMD_DFL_DUP
,

873 .
d©a
[0] = &
cmd
,

874 .
Àn
[0] = (
cmd
),

876 
u8
 
i
;

877 
îr
;

879 
	`iwl_mvm_·m_cmd_comm⁄
(
mvm
, 
vif
, (*)&
cmd
, 
ªq
);

881 
i
 = 0; i < 
cmd
.
num_of_≠
; i++) {

882 
cfg80211_pm§_ªque°_≥î
 *
≥î
 = &
ªq
->
≥îs
[
i
];

883 
iwl_tof_ønge_ªq_≠_íåy_v9
 *
èrgë
 = &
cmd
.
≠
[
i
];

885 
îr
 = 
	`iwl_mvm_·m_put_èrgë_v8
(
mvm
, 
vif
, 
≥î
, (*)
èrgë
);

886 i‡(
îr
)

887  
îr
;

889 i‡(
≥î
->
·m
.
åiggî_ba£d
 ||Öìr->·m.
n⁄_åiggî_ba£d
)

890 
èrgë
->
bss_cﬁ‹
 = 
≥î
->
·m
.bss_color;

892 i‡(
≥î
->
·m
.
n⁄_åiggî_ba£d
) {

893 
èrgë
->
mö_time_bëwìn_m§
 =

894 
	`˝u_to_À16
(
IWL_MVM_FTM_NON_TB_MIN_TIME_BETWEEN_MSR
);

895 
èrgë
->
bur°_≥riod
 =

896 
	`˝u_to_À16
(
IWL_MVM_FTM_NON_TB_MAX_TIME_BETWEEN_MSR
);

898 
èrgë
->
mö_time_bëwìn_m§
 = 
	`˝u_to_À16
(0);

901 
èrgë
->
b™d
 =

902 
	`iwl_mvm_phy_b™d_‰om_∆80211
(
≥î
->
ch™def
.
ch™
->
b™d
);

905  
	`iwl_mvm_·m_£nd_cmd
(
mvm
, &
hcmd
);

906 
	}
}

908 
	$iwl_mvm_·m_°¨t
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

909 
cfg80211_pm§_ªque°
 *
ªq
)

911 
boﬁ
 
√w_≠i
 = 
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

912 
IWL_UCODE_TLV_API_FTM_NEW_RANGE_REQ
);

913 
îr
;

915 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

917 i‡(
mvm
->
·m_öôüt‹
.
ªq
)

918  -
EBUSY
;

920 i‡(
√w_≠i
) {

921 
u8
 
cmd_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
,

922 
	`WIDE_ID
(
LOCATION_GROUP
, 
TOF_RANGE_REQ_CMD
),

923 
IWL_FW_CMD_VER_UNKNOWN
);

925 
cmd_vî
) {

927 
îr
 = 
	`iwl_mvm_·m_°¨t_v13
(
mvm
, 
vif
, 
ªq
);

930 
îr
 = 
	`iwl_mvm_·m_°¨t_v12
(
mvm
, 
vif
, 
ªq
);

933 
îr
 = 
	`iwl_mvm_·m_°¨t_v11
(
mvm
, 
vif
, 
ªq
);

937 
îr
 = 
	`iwl_mvm_·m_°¨t_v9
(
mvm
, 
vif
, 
ªq
);

940 
îr
 = 
	`iwl_mvm_·m_°¨t_v8
(
mvm
, 
vif
, 
ªq
);

943 
îr
 = 
	`iwl_mvm_·m_°¨t_v7
(
mvm
, 
vif
, 
ªq
);

947 
îr
 = 
	`iwl_mvm_·m_°¨t_v5
(
mvm
, 
vif
, 
ªq
);

950 i‡(!
îr
) {

951 
mvm
->
·m_öôüt‹
.
ªq
 =Ñeq;

952 
mvm
->
·m_öôüt‹
.
ªq_wdev
 = 
	`õì80211_vif_to_wdev
(
vif
);

955  
îr
;

956 
	}
}

958 
	$iwl_mvm_·m_ab‹t
(
iwl_mvm
 *
mvm
, 
cfg80211_pm§_ªque°
 *
ªq
)

960 
iwl_tof_ønge_ab‹t_cmd
 
cmd
 = {

961 .
ªque°_id
 = 
ªq
->
cookõ
,

964 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

966 i‡(
ªq
 !
mvm
->
·m_öôüt‹
.req)

969 
	`iwl_mvm_·m_ª£t
(
mvm
);

971 i‡(
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
	`WIDE_ID
(
LOCATION_GROUP
, 
TOF_RANGE_ABORT_CMD
),

972 0, (
cmd
), &cmd))

973 
	`IWL_ERR
(
mvm
, "failedÅoábort FTMÖrocess\n");

974 
	}
}

976 
	$iwl_mvm_·m_föd_≥î
(
cfg80211_pm§_ªque°
 *
ªq
,

977 c⁄° 
u8
 *
addr
)

979 
i
;

981 
i
 = 0; i < 
ªq
->
n_≥îs
; i++) {

982 
cfg80211_pm§_ªque°_≥î
 *
≥î
 = &
ªq
->
≥îs
[
i
];

984 i‡(
	`ëhî_addr_equÆ_u«lig√d
(
≥î
->
addr
,áddr))

985  
i
;

988  -
ENOENT
;

989 
	}
}

991 
u64
 
	$iwl_mvm_·m_gë_ho°_time
(
iwl_mvm
 *
mvm
, 
__À32
 
fw_gp2_ts
)

993 
u32
 
gp2_ts
 = 
	`À32_to_˝u
(
fw_gp2_ts
);

994 
u32
 
cuº_gp2
, 
diff
;

995 
u64
 
now_‰om_boŸ_ns
;

997 
	`iwl_mvm_gë_sync_time
(
mvm
, 
CLOCK_BOOTTIME
, &
cuº_gp2
,

998 &
now_‰om_boŸ_ns
, 
NULL
);

1000 i‡(
cuº_gp2
 >
gp2_ts
)

1001 
diff
 = 
cuº_gp2
 - 
gp2_ts
;

1003 
diff
 = 
cuº_gp2
 + (
U32_MAX
 - 
gp2_ts
 + 1);

1005  
now_‰om_boŸ_ns
 - (
u64
)
diff
 * 1000;

1006 
	}
}

1008 
	$iwl_mvm_·m_gë_lci_civic
(
iwl_mvm
 *
mvm
,

1009 
cfg80211_pm§_ªsu…
 *
ªs
)

1011 
iwl_mvm_loc_íåy
 *
íåy
;

1013 
	`li°_f‹_óch_íåy
(
íåy
, &
mvm
->
·m_öôüt‹
.
loc_li°
, 
li°
) {

1014 i‡(!
	`ëhî_addr_equÆ_u«lig√d
(
ªs
->
addr
, 
íåy
->addr))

1017 i‡(
íåy
->
lci_Àn
) {

1018 
ªs
->
·m
.
lci_Àn
 = 
íåy
->lci_len;

1019 
ªs
->
·m
.
lci
 = 
íåy
->
buf
;

1022 i‡(
íåy
->
civic_Àn
) {

1023 
ªs
->
·m
.
civi˛oc_Àn
 = 
íåy
->
civic_Àn
;

1024 
ªs
->
·m
.
civi˛oc
 = 
íåy
->
buf
 +É¡ry->
lci_Àn
;

1030 
	}
}

1032 
	$iwl_mvm_·m_ønge_ª•_vÆid
(
iwl_mvm
 *
mvm
, 
u8
 
ªque°_id
,

1033 
u8
 
num_of_≠s
)

1035 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1037 i‡(
ªque°_id
 !(
u8
)
mvm
->
·m_öôüt‹
.
ªq
->
cookõ
) {

1038 
	`IWL_ERR
(
mvm
, "Request ID mismatch, got %u,áctive %u\n",

1039 
ªque°_id
, (
u8
)
mvm
->
·m_öôüt‹
.
ªq
->
cookõ
);

1040  -
EINVAL
;

1043 i‡(
num_of_≠s
 > 
mvm
->
·m_öôüt‹
.
ªq
->
n_≥îs
) {

1044 
	`IWL_ERR
(
mvm
, "FTMÑangeÑesponse invalid\n");

1045  -
EINVAL
;

1049 
	}
}

1051 
	$iwl_mvm_·m_πt_smoŸhög
(
iwl_mvm
 *
mvm
,

1052 
cfg80211_pm§_ªsu…
 *
ªs
)

1054 
iwl_mvm_smoŸh_íåy
 *
ª•
 = 
NULL
, *
ôî
;

1055 
s64
 
πt_avg
, 
πt
 = 
ªs
->
·m
.rtt_avg;

1056 
u32
 
undîshoŸ
, 
ovîshoŸ
;

1057 
u8
 
Æpha
;

1059 i‡(!
IWL_MVM_FTM_INITIATOR_ENABLE_SMOOTH
)

1062 
	`WARN_ON
(
πt
 < 0);

1064 i‡(
ªs
->
°©us
 !
NL80211_PMSR_STATUS_SUCCESS
) {

1065 
	`IWL_DEBUG_INFO
(
mvm
,

1067 
ªs
->
addr
,Ñes->
°©us
);

1071 
	`li°_f‹_óch_íåy
(
ôî
, &
mvm
->
·m_öôüt‹
.
smoŸh
.
ª•
, 
li°
) {

1072 i‡(!
	`memcmp
(
ªs
->
addr
, 
ôî
->addr, 
ETH_ALEN
)) {

1073 
ª•
 = 
ôî
;

1078 i‡(!
ª•
) {

1079 
ª•
 = 
	`kzÆloc
((*ª•), 
GFP_KERNEL
);

1080 i‡(!
ª•
)

1083 
	`mem˝y
(
ª•
->
addr
, 
ªs
->addr, 
ETH_ALEN
);

1084 
	`li°_add_èû
(&
ª•
->
li°
, &
mvm
->
·m_öôüt‹
.
smoŸh
.resp);

1086 
ª•
->
πt_avg
 = 
πt
;

1088 
	`IWL_DEBUG_INFO
(
mvm
, "new: %pM:Ñtt_avg=%lld\n",

1089 
ª•
->
addr
,Ñe•->
πt_avg
);

1090 
upd©e_time
;

1093 i‡(
ªs
->
ho°_time
 - 
ª•
->host_time >

1094 
IWL_MVM_FTM_INITIATOR_SMOOTH_AGE_SEC
 * 1000000000) {

1095 
ª•
->
πt_avg
 = 
πt
;

1097 
	`IWL_DEBUG_INFO
(
mvm
, "expired: %pM:Ñtt_avg=%lld\n",

1098 
ª•
->
addr
,Ñe•->
πt_avg
);

1099 
upd©e_time
;

1103 
undîshoŸ
 = 
IWL_MVM_FTM_INITIATOR_SMOOTH_UNDERSHOOT
;

1104 
ovîshoŸ
 = 
IWL_MVM_FTM_INITIATOR_SMOOTH_OVERSHOOT
;

1105 
Æpha
 = 
IWL_MVM_FTM_INITIATOR_SMOOTH_ALPHA
;

1107 
πt_avg
 = 
	`div_s64
(
Æpha
 * 
πt
 + (100 -áÕhaË* 
ª•
->rtt_avg, 100);

1109 
	`IWL_DEBUG_INFO
(
mvm
,

1111 
ª•
->
addr
,Ñe•->
πt_avg
,Ñâ_avg, 
πt
);

1117 
ª•
->
πt_avg
 =Ñtt_avg;

1120 i‡(
πt_avg
 > 
πt
 && (πt_avg -ÑâË> 
undîshoŸ
) {

1121 
ªs
->
·m
.
πt_avg
 =Ñtt_avg;

1123 
	`IWL_DEBUG_INFO
(
mvm
,

1125 (
πt_avg
 - 
πt
));

1126 } i‡(
πt_avg
 < 
πt
 && (rtt -Ñtt_avg) >

1127 
ovîshoŸ
) {

1128 
ªs
->
·m
.
πt_avg
 =Ñtt_avg;

1129 
	`IWL_DEBUG_INFO
(
mvm
,

1131 (
πt
 - 
πt_avg
));

1134 
upd©e_time
:

1135 
ª•
->
ho°_time
 = 
ªs
->host_time;

1136 
	}
}

1138 
	$iwl_mvm_debug_ønge_ª•
(
iwl_mvm
 *
mvm
, 
u8
 
ödex
,

1139 
cfg80211_pm§_ªsu…
 *
ªs
)

1141 
s64
 
πt_avg
 = 
	`div_s64
(
ªs
->
·m
.rtt_avg * 100, 6666);

1143 
	`IWL_DEBUG_INFO
(
mvm
, "íåy %d\n", 
ödex
);

1144 
	`IWL_DEBUG_INFO
(
mvm
, "\t°©us: %d\n", 
ªs
->
°©us
);

1145 
	`IWL_DEBUG_INFO
(
mvm
, "\tBSSID: %pM\n", 
ªs
->
addr
);

1146 
	`IWL_DEBUG_INFO
(
mvm
, "\tho°Åime: %Œu\n", 
ªs
->
ho°_time
);

1147 
	`IWL_DEBUG_INFO
(
mvm
, "\tbur° index: %d\n", 
ªs
->
·m
.
bur°_ödex
);

1148 
	`IWL_DEBUG_INFO
(
mvm
, "\tsuc˚s†num: %u\n", 
ªs
->
·m
.
num_·mr_suc˚s£s
);

1149 
	`IWL_DEBUG_INFO
(
mvm
, "\åssi: %d\n", 
ªs
->
·m
.
rssi_avg
);

1150 
	`IWL_DEBUG_INFO
(
mvm
, "\åssò•ªad: %d\n", 
ªs
->
·m
.
rssi_•ªad
);

1151 
	`IWL_DEBUG_INFO
(
mvm
, "\åâ: %Œd\n", 
ªs
->
·m
.
πt_avg
);

1152 
	`IWL_DEBUG_INFO
(
mvm
, "\åâ v¨: %Œu\n", 
ªs
->
·m
.
πt_v¨ün˚
);

1153 
	`IWL_DEBUG_INFO
(
mvm
, "\åâ s¥ód: %Œu\n", 
ªs
->
·m
.
πt_•ªad
);

1154 
	`IWL_DEBUG_INFO
(
mvm
, "\tdi°™˚: %Œd\n", 
πt_avg
);

1155 
	}
}

1158 
	$iwl_mvm_·m_∑¢_upd©e_≤
(
iwl_mvm
 *
mvm
,

1159 
iwl_tof_ønge_r•_≠_íåy_¡fy_v6
 *
fw_≠
)

1161 
iwl_mvm_·m_∑¢_íåy
 *
íåy
;

1163 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1165 
	`li°_f‹_óch_íåy
(
íåy
, &
mvm
->
·m_öôüt‹
.
∑¢_li°
, 
li°
) {

1166 i‡(
	`memcmp
(
fw_≠
->
bssid
, 
íåy
->
addr
, (entry->addr)))

1169 
	`mem˝y
(
íåy
->
rx_≤
, 
fw_≠
->rx_pn, (entry->rx_pn));

1170 
	`mem˝y
(
íåy
->
tx_≤
, 
fw_≠
->tx_pn, (entry->tx_pn));

1173 
	}
}

1175 
u8
 
	$iwl_mvm_·m_gë_ønge_ª•_vî
(
iwl_mvm
 *
mvm
)

1177 i‡(!
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

1178 
IWL_UCODE_TLV_API_FTM_NEW_RANGE_REQ
))

1182 i‡(
mvm
->
cmd_vî
.
ønge_ª•
 >= 8)

1183  
mvm
->
cmd_vî
.
ønge_ª•
;

1184 i‡(
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

1185 
IWL_UCODE_TLV_API_FTM_RTT_ACCURACY
))

1190 
	}
}

1192 
boﬁ
 
	$iwl_mvm_·m_ª•_size_vÆid©i⁄
(
u8
 
vî
, 
pkt_Àn
)

1194 
vî
) {

1197  
pkt_Àn
 =(
iwl_tof_ønge_r•_¡fy_v8
);

1199  
pkt_Àn
 =(
iwl_tof_ønge_r•_¡fy_v7
);

1201  
pkt_Àn
 =(
iwl_tof_ønge_r•_¡fy_v6
);

1203  
pkt_Àn
 =(
iwl_tof_ønge_r•_¡fy_v5
);

1205 
	`WARN_ONCE
(1, "FTM: unsuµ‹ãdÑ™gêª•⁄£ vîsi⁄ %u", 
vî
);

1206  
Ál£
;

1208 
	}
}

1210 
	$iwl_mvm_·m_ønge_ª•
(
iwl_mvm
 *
mvm
, 
iwl_rx_cmd_buf„r
 *
rxb
)

1212 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

1213 
pkt_Àn
 = 
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
);

1214 
iwl_tof_ønge_r•_¡fy_v5
 *
fw_ª•_v5
 = (*)
pkt
->
d©a
;

1215 
iwl_tof_ønge_r•_¡fy_v6
 *
fw_ª•_v6
 = (*)
pkt
->
d©a
;

1216 
iwl_tof_ønge_r•_¡fy_v7
 *
fw_ª•_v7
 = (*)
pkt
->
d©a
;

1217 
iwl_tof_ønge_r•_¡fy_v8
 *
fw_ª•_v8
 = (*)
pkt
->
d©a
;

1218 
i
;

1219 
boﬁ
 
√w_≠i
 = 
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

1220 
IWL_UCODE_TLV_API_FTM_NEW_RANGE_REQ
);

1221 
u8
 
num_of_≠s
, 
œ°_ö_b©ch
;

1222 
u8
 
nŸif_vî
 = 
	`iwl_mvm_·m_gë_ønge_ª•_vî
(
mvm
);

1224 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1226 i‡(!
mvm
->
·m_öôüt‹
.
ªq
) {

1230 i‡(
	`u∆ikñy
(!
	`iwl_mvm_·m_ª•_size_vÆid©i⁄
(
nŸif_vî
, 
pkt_Àn
)))

1233 i‡(
√w_≠i
) {

1234 i‡(
	`iwl_mvm_·m_ønge_ª•_vÆid
(
mvm
, 
fw_ª•_v8
->
ªque°_id
,

1235 
fw_ª•_v8
->
num_of_≠s
))

1238 
num_of_≠s
 = 
fw_ª•_v8
->num_of_aps;

1239 
œ°_ö_b©ch
 = 
fw_ª•_v8
->
œ°_ªp‹t
;

1241 i‡(
	`iwl_mvm_·m_ønge_ª•_vÆid
(
mvm
, 
fw_ª•_v5
->
ªque°_id
,

1242 
fw_ª•_v5
->
num_of_≠s
))

1245 
num_of_≠s
 = 
fw_ª•_v5
->num_of_aps;

1246 
œ°_ö_b©ch
 = 
fw_ª•_v5
->last_in_batch;

1249 
	`IWL_DEBUG_INFO
(
mvm
, "RangeÑesponseÑeceived\n");

1250 
	`IWL_DEBUG_INFO
(
mvm
, "request id: %lld,Çum ofÉntries: %u\n",

1251 
mvm
->
·m_öôüt‹
.
ªq
->
cookõ
, 
num_of_≠s
);

1253 
i
 = 0; i < 
num_of_≠s
 && i < 
IWL_MVM_TOF_MAX_APS
; i++) {

1254 
cfg80211_pm§_ªsu…
 
ªsu…
 = {};

1255 
iwl_tof_ønge_r•_≠_íåy_¡fy_v6
 *
fw_≠
;

1256 
≥î_idx
;

1258 i‡(
√w_≠i
) {

1259 i‡(
nŸif_vî
 >= 8) {

1260 
fw_≠
 = &
fw_ª•_v8
->
≠
[
i
];

1261 
	`iwl_mvm_·m_∑¢_upd©e_≤
(
mvm
, 
fw_≠
);

1262 } i‡(
nŸif_vî
 == 7) {

1263 
fw_≠
 = (*)&
fw_ª•_v7
->
≠
[
i
];

1265 
fw_≠
 = (*)&
fw_ª•_v6
->
≠
[
i
];

1268 
ªsu…
.
föÆ
 = 
fw_≠
->
œ°_bur°
;

1269 
ªsu…
.
≠_tsf
 = 
	`À32_to_˝u
(
fw_≠
->
°¨t_tsf
);

1270 
ªsu…
.
≠_tsf_vÆid
 = 1;

1273 
fw_≠
 = (*)&
fw_ª•_v5
->
≠
[
i
];

1279 
ªsu…
.
föÆ
 = 0;

1282 
≥î_idx
 = 
	`iwl_mvm_·m_föd_≥î
(
mvm
->
·m_öôüt‹
.
ªq
,

1283 
fw_≠
->
bssid
);

1284 i‡(
≥î_idx
 < 0) {

1285 
	`IWL_WARN
(
mvm
,

1287 
fw_≠
->
bssid
, 
i
);

1291 
fw_≠
->
mósuª_°©us
) {

1292 
IWL_TOF_ENTRY_SUCCESS
:

1293 
ªsu…
.
°©us
 = 
NL80211_PMSR_STATUS_SUCCESS
;

1295 
IWL_TOF_ENTRY_TIMING_MEASURE_TIMEOUT
:

1296 
ªsu…
.
°©us
 = 
NL80211_PMSR_STATUS_TIMEOUT
;

1298 
IWL_TOF_ENTRY_NO_RESPONSE
:

1299 
ªsu…
.
°©us
 = 
NL80211_PMSR_STATUS_FAILURE
;

1300 
ªsu…
.
·m
.
Áûuª_ªas⁄
 =

1301 
NL80211_PMSR_FTM_FAILURE_NO_RESPONSE
;

1303 
IWL_TOF_ENTRY_REQUEST_REJECTED
:

1304 
ªsu…
.
°©us
 = 
NL80211_PMSR_STATUS_FAILURE
;

1305 
ªsu…
.
·m
.
Áûuª_ªas⁄
 =

1306 
NL80211_PMSR_FTM_FAILURE_PEER_BUSY
;

1307 
ªsu…
.
·m
.
busy_ªåy_time
 = 
fw_≠
->
ªfußl_≥riod
;

1310 
ªsu…
.
°©us
 = 
NL80211_PMSR_STATUS_FAILURE
;

1311 
ªsu…
.
·m
.
Áûuª_ªas⁄
 =

1312 
NL80211_PMSR_FTM_FAILURE_UNSPECIFIED
;

1315 
	`mem˝y
(
ªsu…
.
addr
, 
fw_≠
->
bssid
, 
ETH_ALEN
);

1316 
ªsu…
.
ho°_time
 = 
	`iwl_mvm_·m_gë_ho°_time
(
mvm
,

1317 
fw_≠
->
time°amp
);

1318 
ªsu…
.
ty≥
 = 
NL80211_PMSR_TYPE_FTM
;

1319 
ªsu…
.
·m
.
bur°_ödex
 = 
mvm
->
·m_öôüt‹
.
ª•⁄£s
[
≥î_idx
];

1320 
mvm
->
·m_öôüt‹
.
ª•⁄£s
[
≥î_idx
]++;

1321 
ªsu…
.
·m
.
rssi_avg
 = 
fw_≠
->
rssi
;

1322 
ªsu…
.
·m
.
rssi_avg_vÆid
 = 1;

1323 
ªsu…
.
·m
.
rssi_•ªad
 = 
fw_≠
->rssi_spread;

1324 
ªsu…
.
·m
.
rssi_•ªad_vÆid
 = 1;

1325 
ªsu…
.
·m
.
πt_avg
 = (
s32
)
	`À32_to_˝u
(
fw_≠
->
πt
);

1326 
ªsu…
.
·m
.
πt_avg_vÆid
 = 1;

1327 
ªsu…
.
·m
.
πt_v¨ün˚
 = 
	`À32_to_˝u
(
fw_≠
->rtt_variance);

1328 
ªsu…
.
·m
.
πt_v¨ün˚_vÆid
 = 1;

1329 
ªsu…
.
·m
.
πt_•ªad
 = 
	`À32_to_˝u
(
fw_≠
->rtt_spread);

1330 
ªsu…
.
·m
.
πt_•ªad_vÆid
 = 1;

1332 
	`iwl_mvm_·m_gë_lci_civic
(
mvm
, &
ªsu…
);

1334 
	`iwl_mvm_·m_πt_smoŸhög
(
mvm
, &
ªsu…
);

1336 
	`cfg80211_pm§_ªp‹t
(
mvm
->
·m_öôüt‹
.
ªq_wdev
,

1337 
mvm
->
·m_öôüt‹
.
ªq
,

1338 &
ªsu…
, 
GFP_KERNEL
);

1340 i‡(
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

1341 
IWL_UCODE_TLV_API_FTM_RTT_ACCURACY
))

1342 
	`IWL_DEBUG_INFO
(
mvm
, "RTT confidence: %u\n",

1343 
fw_≠
->
πtC⁄fidí˚
);

1345 
	`iwl_mvm_debug_ønge_ª•
(
mvm
, 
i
, &
ªsu…
);

1348 i‡(
œ°_ö_b©ch
) {

1349 
	`cfg80211_pm§_com∂ëe
(
mvm
->
·m_öôüt‹
.
ªq_wdev
,

1350 
mvm
->
·m_öôüt‹
.
ªq
,

1351 
GFP_KERNEL
);

1352 
	`iwl_mvm_·m_ª£t
(
mvm
);

1354 
	}
}

1356 
	$iwl_mvm_·m_lc_nŸif
(
iwl_mvm
 *
mvm
, 
iwl_rx_cmd_buf„r
 *
rxb
)

1358 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

1359 c⁄° 
õì80211_mgmt
 *
mgmt
 = (*)
pkt
->
d©a
;

1360 
size_t
 
Àn
 = 
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
);

1361 
iwl_mvm_loc_íåy
 *
íåy
;

1362 c⁄° 
u8
 *
õs
, *
lci
, *
civic
, *
m§_õ
;

1363 
size_t
 
õs_Àn
, 
lci_Àn
 = 0, 
civic_Àn
 = 0;

1364 
size_t
 
ba£Àn
 = 
IEEE80211_MIN_ACTION_SIZE
 +

1365 (
mgmt
->
u
.
a˘i⁄
.u.
·m
);

1366 c⁄° 
u8
 
Ωπ_ty≥_lci
 = 
IEEE80211_SPCT_MSR_RPRT_TYPE_LCI
;

1367 c⁄° 
u8
 
Ωπ_ty≥_civic
 = 
IEEE80211_SPCT_MSR_RPRT_TYPE_CIVIC
;

1369 i‡(
Àn
 <
ba£Àn
)

1372 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1374 
õs
 = 
mgmt
->
u
.
a˘i⁄
.u.
·m
.
v¨übÀ
;

1375 
õs_Àn
 = 
Àn
 - 
ba£Àn
;

1377 
m§_õ
 = 
	`cfg80211_föd_õ_m©ch
(
WLAN_EID_MEASURE_REPORT
, 
õs
, 
õs_Àn
,

1378 &
Ωπ_ty≥_lci
, 1, 4);

1379 i‡(
m§_õ
) {

1380 
lci
 = 
m§_õ
 + 2;

1381 
lci_Àn
 = 
m§_õ
[1];

1384 
m§_õ
 = 
	`cfg80211_föd_õ_m©ch
(
WLAN_EID_MEASURE_REPORT
, 
õs
, 
õs_Àn
,

1385 &
Ωπ_ty≥_civic
, 1, 4);

1386 i‡(
m§_õ
) {

1387 
civic
 = 
m§_õ
 + 2;

1388 
civic_Àn
 = 
m§_õ
[1];

1391 
íåy
 = 
	`kmÆloc
((*íåyË+ 
lci_Àn
 + 
civic_Àn
, 
GFP_KERNEL
);

1392 i‡(!
íåy
)

1395 
	`mem˝y
(
íåy
->
addr
, 
mgmt
->
bssid
, 
ETH_ALEN
);

1397 
íåy
->
lci_Àn
 =Üci_len;

1398 i‡(
lci_Àn
)

1399 
	`mem˝y
(
íåy
->
buf
, 
lci
, 
lci_Àn
);

1401 
íåy
->
civic_Àn
 = civic_len;

1402 i‡(
civic_Àn
)

1403 
	`mem˝y
(
íåy
->
buf
 + 
lci_Àn
, 
civic
, 
civic_Àn
);

1405 
	`li°_add_èû
(&
íåy
->
li°
, &
mvm
->
·m_öôüt‹
.
loc_li°
);

1406 
	}
}

	@ftm-responder.c

6 
	~<√t/cfg80211.h
>

7 
	~<löux/ëhîdevi˚.h
>

8 
	~"mvm.h
"

9 
	~"c⁄°™ts.h
"

11 
	siwl_mvm_∑¢_°a
 {

12 
li°_hód
 
	mli°
;

13 
iwl_mvm_öt_°a
 
	möt_°a
;

14 
u8
 
	maddr
[
ETH_ALEN
];

17 
õì80211_key_c⁄f
 
	mkeyc⁄f
;

20 
	siwl_mvm_∑¢_h…k_d©a
 {

21 
u8
 *
	maddr
;

22 
u8
 
	mcùhî
;

23 
u8
 *
	mh…k
;

26 
	$iwl_mvm_·m_ª•⁄dî_£t_bw_v1
(
cfg80211_ch™_def
 *
ch™def
,

27 
u8
 *
bw
, u8 *
˘æ_ch_posôi⁄
)

29 
ch™def
->
width
) {

30 
NL80211_CHAN_WIDTH_20_NOHT
:

31 *
bw
 = 
IWL_TOF_BW_20_LEGACY
;

33 
NL80211_CHAN_WIDTH_20
:

34 *
bw
 = 
IWL_TOF_BW_20_HT
;

36 
NL80211_CHAN_WIDTH_40
:

37 *
bw
 = 
IWL_TOF_BW_40
;

38 *
˘æ_ch_posôi⁄
 = 
	`iwl_mvm_gë_˘æ_pos
(
ch™def
);

40 
NL80211_CHAN_WIDTH_80
:

41 *
bw
 = 
IWL_TOF_BW_80
;

42 *
˘æ_ch_posôi⁄
 = 
	`iwl_mvm_gë_˘æ_pos
(
ch™def
);

45  -
EOPNOTSUPP
;

49 
	}
}

51 
	$iwl_mvm_·m_ª•⁄dî_£t_bw_v2
(
cfg80211_ch™_def
 *
ch™def
,

52 
u8
 *
f‹m©_bw
, u8 *
˘æ_ch_posôi⁄
,

53 
u8
 
cmd_vî
)

55 
ch™def
->
width
) {

56 
NL80211_CHAN_WIDTH_20_NOHT
:

57 *
f‹m©_bw
 = 
IWL_LOCATION_FRAME_FORMAT_LEGACY
;

58 *
f‹m©_bw
 |
IWL_LOCATION_BW_20MHZ
 << 
LOCATION_BW_POS
;

60 
NL80211_CHAN_WIDTH_20
:

61 *
f‹m©_bw
 = 
IWL_LOCATION_FRAME_FORMAT_HT
;

62 *
f‹m©_bw
 |
IWL_LOCATION_BW_20MHZ
 << 
LOCATION_BW_POS
;

64 
NL80211_CHAN_WIDTH_40
:

65 *
f‹m©_bw
 = 
IWL_LOCATION_FRAME_FORMAT_HT
;

66 *
f‹m©_bw
 |
IWL_LOCATION_BW_40MHZ
 << 
LOCATION_BW_POS
;

67 *
˘æ_ch_posôi⁄
 = 
	`iwl_mvm_gë_˘æ_pos
(
ch™def
);

69 
NL80211_CHAN_WIDTH_80
:

70 *
f‹m©_bw
 = 
IWL_LOCATION_FRAME_FORMAT_VHT
;

71 *
f‹m©_bw
 |
IWL_LOCATION_BW_80MHZ
 << 
LOCATION_BW_POS
;

72 *
˘æ_ch_posôi⁄
 = 
	`iwl_mvm_gë_˘æ_pos
(
ch™def
);

74 
NL80211_CHAN_WIDTH_160
:

75 i‡(
cmd_vî
 >= 9) {

76 *
f‹m©_bw
 = 
IWL_LOCATION_FRAME_FORMAT_HE
;

77 *
f‹m©_bw
 |
IWL_LOCATION_BW_160MHZ
 << 
LOCATION_BW_POS
;

78 *
˘æ_ch_posôi⁄
 = 
	`iwl_mvm_gë_˘æ_pos
(
ch™def
);

81 
ÁŒthrough
;

83  -
EOPNOTSUPP
;

87 
	}
}

90 
	$iwl_mvm_·m_ª•⁄dî_£t_ndp
(
iwl_mvm
 *
mvm
,

91 
iwl_tof_ª•⁄dî_c⁄fig_cmd_v9
 *
cmd
)

94 
u32
 
r2i_max_°s
 = 
IWL_MVM_FTM_R2I_MAX_STS
 < 2 ?

95 
IWL_MVM_FTM_R2I_MAX_STS
 : 1;

97 
cmd
->
r2i_ndp_∑øms
 = 
IWL_MVM_FTM_R2I_MAX_REP
 |

98 (
r2i_max_°s
 << 
IWL_RESPONDER_STS_POS
) |

99 (
IWL_MVM_FTM_R2I_MAX_TOTAL_LTF
 << 
IWL_RESPONDER_TOTAL_LTF_POS
);

100 
cmd
->
i2r_ndp_∑øms
 = 
IWL_MVM_FTM_I2R_MAX_REP
 |

101 (
IWL_MVM_FTM_I2R_MAX_STS
 << 
IWL_RESPONDER_STS_POS
) |

102 (
IWL_MVM_FTM_I2R_MAX_TOTAL_LTF
 << 
IWL_RESPONDER_TOTAL_LTF_POS
);

103 
cmd
->
cmd_vÆid_fõlds
 |=

104 
	`˝u_to_À32
(
IWL_TOF_RESPONDER_CMD_VALID_NDP_PARAMS
);

105 
	}
}

108 
	$iwl_mvm_·m_ª•⁄dî_cmd
(
iwl_mvm
 *
mvm
,

109 
õì80211_vif
 *
vif
,

110 
cfg80211_ch™_def
 *
ch™def
,

111 
õì80211_bss_c⁄f
 *
lök_c⁄f
)

113 
u32
 
cmd_id
 = 
	`WIDE_ID
(
LOCATION_GROUP
, 
TOF_RESPONDER_CONFIG_CMD
);

114 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

120 
iwl_tof_ª•⁄dî_c⁄fig_cmd_v9
 
cmd
 = {

121 .
ch™√l_num
 = 
ch™def
->
ch™
->
hw_vÆue
,

122 .
cmd_vÆid_fõlds
 =

123 
	`˝u_to_À32
(
IWL_TOF_RESPONDER_CMD_VALID_CHAN_INFO
 |

124 
IWL_TOF_RESPONDER_CMD_VALID_BSSID
 |

125 
IWL_TOF_RESPONDER_CMD_VALID_STA_ID
),

126 .
°a_id
 = 
mvmvif
->
lök
[
lök_c⁄f
->
lök_id
]->
bˇ°_°a
.sta_id,

128 
u8
 
cmd_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
cmd_id
, 6);

129 
îr
;

130 
cmd_size
;

132 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

135 i‡(
cmd_vî
 == 9) {

136 
cmd
.
cmd_vÆid_fõlds
 |=

137 
	`˝u_to_À32
(
IWL_TOF_RESPONDER_CMD_VALID_BSS_COLOR
 |

138 
IWL_TOF_RESPONDER_CMD_VALID_MIN_MAX_TIME_BETWEEN_MSR
);

139 
cmd
.
bss_cﬁ‹
 = 1;

140 
cmd
.
mö_time_bëwìn_m§
 =

141 
	`˝u_to_À16
(
IWL_MVM_FTM_NON_TB_MIN_TIME_BETWEEN_MSR
);

142 
cmd
.
max_time_bëwìn_m§
 =

143 
	`˝u_to_À16
(
IWL_MVM_FTM_NON_TB_MAX_TIME_BETWEEN_MSR
);

144 
cmd_size
 = (
iwl_tof_ª•⁄dî_c⁄fig_cmd_v9
);

147 
cmd_size
 = (
iwl_tof_ª•⁄dî_c⁄fig_cmd_v8
);

150 i‡(
cmd_vî
 >= 8)

151 
	`iwl_mvm_·m_ª•⁄dî_£t_ndp
(
mvm
, &
cmd
);

153 i‡(
cmd_vî
 >= 7)

154 
îr
 = 
	`iwl_mvm_·m_ª•⁄dî_£t_bw_v2
(
ch™def
, &
cmd
.
f‹m©_bw
,

155 &
cmd
.
˘æ_ch_posôi⁄
,

156 
cmd_vî
);

158 
îr
 = 
	`iwl_mvm_·m_ª•⁄dî_£t_bw_v1
(
ch™def
, &
cmd
.
f‹m©_bw
,

159 &
cmd
.
˘æ_ch_posôi⁄
);

161 i‡(
îr
) {

162 
	`IWL_ERR
(
mvm
, "FailedÅo setÑesponder bandwidth\n");

163  
îr
;

166 
	`mem˝y
(
cmd
.
bssid
, 
vif
->
addr
, 
ETH_ALEN
);

168  
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
cmd_id
, 0, 
cmd_size
, &
cmd
);

169 
	}
}

172 
	$iwl_mvm_·m_ª•⁄dî_dyn_cfg_v2
(
iwl_mvm
 *
mvm
,

173 
õì80211_vif
 *
vif
,

174 
õì80211_·m_ª•⁄dî_∑øms
 *
∑øms
)

176 
iwl_tof_ª•⁄dî_dyn_c⁄fig_cmd_v2
 
cmd
 = {

177 .
lci_Àn
 = 
	`˝u_to_À32
(
∑øms
->lci_len + 2),

178 .
civic_Àn
 = 
	`˝u_to_À32
(
∑øms
->
civi˛oc_Àn
 + 2),

180 
u8
 
d©a
[
IWL_LCI_CIVIC_IE_MAX_SIZE
] = {0};

181 
iwl_ho°_cmd
 
hcmd
 = {

182 .
id
 = 
	`WIDE_ID
(
LOCATION_GROUP
, 
TOF_RESPONDER_DYN_CONFIG_CMD
),

183 .
d©a
[0] = &
cmd
,

184 .
Àn
[0] = (
cmd
),

185 .
d©a
[1] = &data,

188 .
d©aÊags
[1] = 
IWL_HCMD_DFL_DUP
,

190 
u32
 
Æig√d_lci_Àn
 = 
	`ALIGN
(
∑øms
->
lci_Àn
 + 2, 4);

191 
u32
 
Æig√d_civi˛oc_Àn
 = 
	`ALIGN
(
∑øms
->
civi˛oc_Àn
 + 2, 4);

192 
u8
 *
pos
 = 
d©a
;

194 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

196 i‡(
Æig√d_lci_Àn
 + 
Æig√d_civi˛oc_Àn
 > (
d©a
)) {

197 
	`IWL_ERR
(
mvm
, "LCI/civicloc dataÅoo big (%zd + %zd)\n",

198 
∑øms
->
lci_Àn
,Ö¨ams->
civi˛oc_Àn
);

199  -
ENOBUFS
;

202 
pos
[0] = 
WLAN_EID_MEASURE_REPORT
;

203 
pos
[1] = 
∑øms
->
lci_Àn
;

204 
	`mem˝y
(
pos
 + 2, 
∑øms
->
lci
,Ö¨ams->
lci_Àn
);

206 
pos
 +
Æig√d_lci_Àn
;

207 
pos
[0] = 
WLAN_EID_MEASURE_REPORT
;

208 
pos
[1] = 
∑øms
->
civi˛oc_Àn
;

209 
	`mem˝y
(
pos
 + 2, 
∑øms
->
civi˛oc
,Ö¨ams->
civi˛oc_Àn
);

211 
hcmd
.
Àn
[1] = 
Æig√d_lci_Àn
 + 
Æig√d_civi˛oc_Àn
;

213  
	`iwl_mvm_£nd_cmd
(
mvm
, &
hcmd
);

214 
	}
}

217 
	$iwl_mvm_·m_ª•⁄dî_dyn_cfg_v3
(
iwl_mvm
 *
mvm
,

218 
õì80211_vif
 *
vif
,

219 
õì80211_·m_ª•⁄dî_∑øms
 *
∑øms
,

220 
iwl_mvm_∑¢_h…k_d©a
 *
h…k_d©a
)

222 
iwl_tof_ª•⁄dî_dyn_c⁄fig_cmd
 
cmd
;

223 
iwl_ho°_cmd
 
hcmd
 = {

224 .
id
 = 
	`WIDE_ID
(
LOCATION_GROUP
, 
TOF_RESPONDER_DYN_CONFIG_CMD
),

225 .
d©a
[0] = &
cmd
,

226 .
Àn
[0] = (
cmd
),

228 .
d©aÊags
[0] = 
IWL_HCMD_DFL_DUP
,

231 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

233 
cmd
.
vÆid_Êags
 = 0;

235 i‡(
∑øms
) {

236 i‡(
∑øms
->
lci_Àn
 + 2 > (
cmd
.
lci_buf
) ||

237 
∑øms
->
civi˛oc_Àn
 + 2 > (
cmd
.
civic_buf
)) {

238 
	`IWL_ERR
(
mvm
,

240 
∑øms
->
lci_Àn
,Ö¨ams->
civi˛oc_Àn
);

241  -
ENOBUFS
;

244 
cmd
.
lci_buf
[0] = 
WLAN_EID_MEASURE_REPORT
;

245 
cmd
.
lci_buf
[1] = 
∑øms
->
lci_Àn
;

246 
	`mem˝y
(
cmd
.
lci_buf
 + 2, 
∑øms
->
lci
,Ö¨ams->
lci_Àn
);

247 
cmd
.
lci_Àn
 = 
∑øms
->lci_len + 2;

249 
cmd
.
civic_buf
[0] = 
WLAN_EID_MEASURE_REPORT
;

250 
cmd
.
civic_buf
[1] = 
∑øms
->
civi˛oc_Àn
;

251 
	`mem˝y
(
cmd
.
civic_buf
 + 2, 
∑øms
->
civi˛oc
,

252 
∑øms
->
civi˛oc_Àn
);

253 
cmd
.
civic_Àn
 = 
∑øms
->
civi˛oc_Àn
 + 2;

255 
cmd
.
vÆid_Êags
 |
IWL_RESPONDER_DYN_CFG_VALID_LCI
 |

256 
IWL_RESPONDER_DYN_CFG_VALID_CIVIC
;

259 i‡(
h…k_d©a
) {

260 i‡(
h…k_d©a
->
cùhî
 > 
IWL_LOCATION_CIPHER_GCMP_256
) {

261 
	`IWL_ERR
(
mvm
, "invalid cipher: %u\n",

262 
h…k_d©a
->
cùhî
);

263  -
EINVAL
;

266 
cmd
.
cùhî
 = 
h…k_d©a
->cipher;

267 
	`mem˝y
(
cmd
.
addr
, 
h…k_d©a
->addr, (cmd.addr));

268 
	`mem˝y
(
cmd
.
h…k_buf
, 
h…k_d©a
->
h…k
, (cmd.hltk_buf));

269 
cmd
.
vÆid_Êags
 |
IWL_RESPONDER_DYN_CFG_VALID_PASN_STA
;

272  
	`iwl_mvm_£nd_cmd
(
mvm
, &
hcmd
);

273 
	}
}

276 
	$iwl_mvm_·m_ª•⁄dî_dyn_cfg_cmd
(
iwl_mvm
 *
mvm
,

277 
õì80211_vif
 *
vif
,

278 
õì80211_·m_ª•⁄dî_∑øms
 *
∑øms
)

280 
ªt
;

281 
u8
 
cmd_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
,

282 
	`WIDE_ID
(
LOCATION_GROUP
, 
TOF_RESPONDER_DYN_CONFIG_CMD
),

285 
cmd_vî
) {

287 
ªt
 = 
	`iwl_mvm_·m_ª•⁄dî_dyn_cfg_v2
(
mvm
, 
vif
,

288 
∑øms
);

291 
ªt
 = 
	`iwl_mvm_·m_ª•⁄dî_dyn_cfg_v3
(
mvm
, 
vif
,

292 
∑øms
, 
NULL
);

295 
	`IWL_ERR
(
mvm
, "Unsupported DYN_CONFIG_CMD version %u\n",

296 
cmd_vî
);

297 
ªt
 = -
EOPNOTSUPP
;

300  
ªt
;

301 
	}
}

303 
	$iwl_mvm_ª•_dñ_∑¢_°a
(
iwl_mvm
 *
mvm
,

304 
õì80211_vif
 *
vif
,

305 
iwl_mvm_∑¢_°a
 *
°a
)

307 
	`li°_dñ
(&
°a
->
li°
);

309 i‡(
°a
->
keyc⁄f
.
keyÀn
)

310 
	`iwl_mvm_£c_key_dñ_∑¢
(
mvm
, 
vif
, 
	`BIT
(
°a
->
öt_°a
.
°a_id
),

311 &
°a
->
keyc⁄f
);

313 i‡(
	`iwl_mvm_has_mld_≠i
(
mvm
->
fw
))

314 
	`iwl_mvm_mld_rm_°a_id
(
mvm
, 
°a
->
öt_°a
.
°a_id
);

316 
	`iwl_mvm_rm_°a_id
(
mvm
, 
vif
, 
°a
->
öt_°a
.
°a_id
);

318 
	`iwl_mvm_dóŒoc_öt_°a
(
mvm
, &
°a
->
öt_°a
);

319 
	`k‰ì
(
°a
);

320 
	}
}

322 
	$iwl_mvm_·m_ª•odî_add_∑¢_°a
(
iwl_mvm
 *
mvm
,

323 
õì80211_vif
 *
vif
,

324 
u8
 *
addr
, 
u32
 
cùhî
, u8 *
tk
, u32 
tk_Àn
,

325 
u8
 *
h…k
, 
u32
 
h…k_Àn
)

327 
ªt
;

328 
iwl_mvm_∑¢_°a
 *
°a
 = 
NULL
;

329 
iwl_mvm_∑¢_h…k_d©a
 
h…k_d©a
 = {

330 .
addr
 =áddr,

331 .
h…k
 = hltk,

333 
iwl_mvm_∑¢_h…k_d©a
 *
h…k_d©a_±r
 = 
NULL
;

335 
u8
 
cmd_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
,

336 
	`WIDE_ID
(
LOCATION_GROUP
, 
TOF_RESPONDER_DYN_CONFIG_CMD
),

339 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

341 i‡(
cmd_vî
 < 3) {

342 
	`IWL_ERR
(
mvm
, "Adding PASN stationÇot supported by FW\n");

343  -
EOPNOTSUPP
;

346 i‡((!
h…k
 || !
h…k_Àn
Ë&& (!
tk
 || !
tk_Àn
)) {

347 
	`IWL_ERR
(
mvm
, "TKánd HLTKÇot set\n");

348  -
EINVAL
;

351 i‡(
h…k
 && 
h…k_Àn
) {

352 i‡(!
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

353 
IWL_UCODE_TLV_CAPA_SECURE_LTF_SUPPORT
)) {

354 
	`IWL_ERR
(
mvm
, "No support for secure LTF measurement\n");

355  -
EINVAL
;

358 
h…k_d©a
.
cùhî
 = 
	`iwl_mvm_cùhî_to_loˇti⁄_cùhî
(cipher);

359 i‡(
h…k_d©a
.
cùhî
 =
IWL_LOCATION_CIPHER_INVALID
) {

360 
	`IWL_ERR
(
mvm
, "övÆid cùhî: %u\n", 
cùhî
);

361  -
EINVAL
;

364 
h…k_d©a_±r
 = &
h…k_d©a
;

367 i‡(
tk
 && 
tk_Àn
) {

368 
°a
 = 
	`kzÆloc
((*°aË+ 
tk_Àn
, 
GFP_KERNEL
);

369 i‡(!
°a
)

370  -
ENOBUFS
;

372 
ªt
 = 
	`iwl_mvm_add_∑¢_°a
(
mvm
, 
vif
, &
°a
->
öt_°a
, 
addr
,

373 
cùhî
, 
tk
, 
tk_Àn
, &
°a
->
keyc⁄f
);

374 i‡(
ªt
) {

375 
	`k‰ì
(
°a
);

376  
ªt
;

379 
	`mem˝y
(
°a
->
addr
,áddr, 
ETH_ALEN
);

380 
	`li°_add_èû
(&
°a
->
li°
, &
mvm
->
ª•_∑¢_li°
);

383 
ªt
 = 
	`iwl_mvm_·m_ª•⁄dî_dyn_cfg_v3
(
mvm
, 
vif
, 
NULL
, 
h…k_d©a_±r
);

384 i‡(
ªt
 && 
°a
)

385 
	`iwl_mvm_ª•_dñ_∑¢_°a
(
mvm
, 
vif
, 
°a
);

387  
ªt
;

388 
	}
}

390 
	$iwl_mvm_·m_ª•_ªmove_∑¢_°a
(
iwl_mvm
 *
mvm
,

391 
õì80211_vif
 *
vif
, 
u8
 *
addr
)

393 
iwl_mvm_∑¢_°a
 *
°a
, *
¥ev
;

395 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

397 
	`li°_f‹_óch_íåy_ß„
(
°a
, 
¥ev
, &
mvm
->
ª•_∑¢_li°
, 
li°
) {

398 i‡(!
	`memcmp
(
°a
->
addr
,áddr, 
ETH_ALEN
)) {

399 
	`iwl_mvm_ª•_dñ_∑¢_°a
(
mvm
, 
vif
, 
°a
);

404 
	`IWL_ERR
(
mvm
, "FTM: PASN sèti⁄ %pMÇŸ found\n", 
addr
);

405  -
EINVAL
;

406 
	}
}

408 
	$iwl_mvm_·m_°¨t_ª•⁄dî
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

409 
õì80211_bss_c⁄f
 *
bss_c⁄f
)

411 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

412 
õì80211_·m_ª•⁄dî_∑øms
 *
∑øms
;

413 
õì80211_ch™˘x_c⁄f
 
˘x
, *
p˘x
;

414 
u16
 *
phy_˘xt_id
;

415 
iwl_mvm_phy_˘xt
 *
phy_˘xt
;

416 
ªt
;

418 
∑øms
 = 
bss_c⁄f
->
·mr_∑øms
;

420 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

422 i‡(
	`WARN_ON_ONCE
(!
bss_c⁄f
->
·m_ª•⁄dî
))

423  -
EINVAL
;

425 i‡(
vif
->
p2p
 || vif->
ty≥
 !
NL80211_IFTYPE_AP
 ||

426 !
mvmvif
->
≠_ibss_a˘ive
) {

427 
	`IWL_ERR
(
mvm
, "Cannot startÑesponder,Çot in AP mode\n");

428  -
EIO
;

431 
	`rcu_ªad_lock
();

432 
p˘x
 = 
	`rcu_dîe„ªn˚
(
bss_c⁄f
->
ch™˘x_c⁄f
);

436 
˘x
 = *
p˘x
;

437 
phy_˘xt_id
 = (
u16
 *)
p˘x
->
drv_¥iv
;

438 
	`rcu_ªad_u∆ock
();

440 
phy_˘xt
 = &
mvm
->
phy_˘xts
[*
phy_˘xt_id
];

441 
ªt
 = 
	`iwl_mvm_phy_˘xt_ch™ged
(
mvm
, 
phy_˘xt
, &
˘x
.
def
, &˘x.
≠
,

442 
˘x
.
rx_chaös_°©ic
,

443 
˘x
.
rx_chaös_dy«mic
);

444 i‡(
ªt
)

445  
ªt
;

447 
ªt
 = 
	`iwl_mvm_·m_ª•⁄dî_cmd
(
mvm
, 
vif
, &
˘x
.
def
, 
bss_c⁄f
);

448 i‡(
ªt
)

449  
ªt
;

451 i‡(
∑øms
)

452 
ªt
 = 
	`iwl_mvm_·m_ª•⁄dî_dyn_cfg_cmd
(
mvm
, 
vif
, 
∑øms
);

454  
ªt
;

455 
	}
}

457 
	$iwl_mvm_·m_ª•⁄dî_˛ór
(
iwl_mvm
 *
mvm
,

458 
õì80211_vif
 *
vif
)

460 
iwl_mvm_∑¢_°a
 *
°a
, *
¥ev
;

462 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

464 
	`li°_f‹_óch_íåy_ß„
(
°a
, 
¥ev
, &
mvm
->
ª•_∑¢_li°
, 
li°
)

465 
	`iwl_mvm_ª•_dñ_∑¢_°a
(
mvm
, 
vif
, 
°a
);

466 
	}
}

468 
	$iwl_mvm_·m_ª°¨t_ª•⁄dî
(
iwl_mvm
 *
mvm
,

469 
õì80211_vif
 *
vif
,

470 
õì80211_bss_c⁄f
 *
bss_c⁄f
)

472 i‡(!
bss_c⁄f
->
·m_ª•⁄dî
)

475 
	`iwl_mvm_·m_ª•⁄dî_˛ór
(
mvm
, 
vif
);

476 
	`iwl_mvm_·m_°¨t_ª•⁄dî
(
mvm
, 
vif
, 
bss_c⁄f
);

477 
	}
}

479 
	$iwl_mvm_·m_ª•⁄dî_°©s
(
iwl_mvm
 *
mvm
,

480 
iwl_rx_cmd_buf„r
 *
rxb
)

482 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

483 
iwl_·m_ª•⁄dî_°©s
 *
ª•
 = (*)
pkt
->
d©a
;

484 
cfg80211_·m_ª•⁄dî_°©s
 *
°©s
 = &
mvm
->
·m_ª•_°©s
;

485 
u32
 
Êags
 = 
	`À32_to_˝u
(
ª•
->flags);

487 i‡(
ª•
->
suc˚ss_·m
 =ª•->
·m_≥r_bur°
)

488 
°©s
->
suc˚ss_num
++;

489 i‡(
ª•
->
suc˚ss_·m
 >= 2)

490 
°©s
->
∑πül_num
++;

492 
°©s
->
Áûed_num
++;

494 i‡((
Êags
 & 
FTM_RESP_STAT_ASAP_REQ
) &&

495 (
Êags
 & 
FTM_RESP_STAT_ASAP_RESP
))

496 
°©s
->
aßp_num
++;

498 i‡(
Êags
 & 
FTM_RESP_STAT_NON_ASAP_RESP
)

499 
°©s
->
n⁄_aßp_num
++;

501 
°©s
->
tŸÆ_duøti⁄_ms
 +
	`À32_to_˝u
(
ª•
->
duøti⁄
Ë/ 
USEC_PER_MSEC
;

503 i‡(
Êags
 & 
FTM_RESP_STAT_TRIGGER_UNKNOWN
)

504 
°©s
->
unknown_åiggîs_num
++;

506 i‡(
Êags
 & 
FTM_RESP_STAT_DUP
)

507 
°©s
->
ªscheduÀ_ªque°s_num
++;

509 i‡(
Êags
 & 
FTM_RESP_STAT_NON_ASAP_OUT_WIN
)

510 
°©s
->
out_of_wödow_åiggîs_num
++;

511 
	}
}

	@fw-api.h

7 #i‚de‡
__fw_≠i_h__


8 
	#__fw_≠i_h__


	)

10 
	~"fw/≠i/tdls.h
"

11 
	~"fw/≠i/mac-cfg.h
"

12 
	~"fw/≠i/ofÊﬂd.h
"

13 
	~"fw/≠i/c⁄ãxt.h
"

14 
	~"fw/≠i/time-evít.h
"

15 
	~"fw/≠i/d©≠©h.h
"

16 
	~"fw/≠i/phy.h
"

17 
	~"fw/≠i/c⁄fig.h
"

18 
	~"fw/≠i/sy°em.h
"

19 
	~"fw/≠i/Æive.h
"

20 
	~"fw/≠i/bödög.h
"

21 
	~"fw/≠i/cmdhdr.h
"

22 
	~"fw/≠i/c€x.h
"

23 
	~"fw/≠i/comm™ds.h
"

24 
	~"fw/≠i/d3.h
"

25 
	~"fw/≠i/fûãr.h
"

26 
	~"fw/≠i/Àd.h
"

27 
	~"fw/≠i/mac.h
"

28 
	~"fw/≠i/nvm-ªg.h
"

29 
	~"fw/≠i/phy-˘xt.h
"

30 
	~"fw/≠i/powî.h
"

31 
	~"fw/≠i/rs.h
"

32 
	~"fw/≠i/rx.h
"

33 
	~"fw/≠i/sˇn.h
"

34 
	~"fw/≠i/sf.h
"

35 
	~"fw/≠i/°a.h
"

36 
	~"fw/≠i/°©s.h
"

37 
	~"fw/≠i/loˇti⁄.h
"

38 
	~"fw/≠i/tx.h
"

39 
	~"fw/≠i/rfi.h
"

	@fw.c

7 
	~<√t/mac80211.h
>

8 
	~<löux/√tdevi˚.h
>

9 
	~<löux/dmi.h
>

11 
	~"iwl-å™s.h
"

12 
	~"iwl-›-mode.h
"

13 
	~"fw/img.h
"

14 
	~"iwl-debug.h
"

15 
	~"iwl-¥ph.h
"

16 
	~"fw/a˝i.h
"

17 
	~"fw/≤vm.h
"

18 
	~"fw/uefi.h
"

19 
	~"fw/ªguœt‹y.h
"

21 
	~"mvm.h
"

22 
	~"fw/dbg.h
"

23 
	~"iwl-phy-db.h
"

24 
	~"iwl-mod∑øms.h
"

25 
	~"iwl-nvm-∑r£.h
"

26 
	~"time-sync.h
"

28 
	#MVM_UCODE_ALIVE_TIMEOUT
 (2 * 
HZ
)

	)

29 
	#MVM_UCODE_CALIB_TIMEOUT
 (2 * 
HZ
)

	)

31 
	#IWL_UATS_VLP_AP_SUPPORTED
 
	`BIT
(29)

	)

32 
	#IWL_UATS_AFC_AP_SUPPORTED
 
	`BIT
(30)

	)

34 
	siwl_mvm_Æive_d©a
 {

35 
boﬁ
 
	mvÆid
;

36 
u32
 
	mscd_ba£_addr
;

39 
	$iwl_£nd_tx_™t_cfg
(
iwl_mvm
 *
mvm
, 
u8
 
vÆid_tx_™t
)

41 
iwl_tx_™t_cfg_cmd
 
tx_™t_cmd
 = {

42 .
vÆid
 = 
	`˝u_to_À32
(
vÆid_tx_™t
),

45 
	`IWL_DEBUG_FW
(
mvm
, "£À˘ vÆidÅxá¡: %u\n", 
vÆid_tx_™t
);

46  
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
TX_ANT_CONFIGURATION_CMD
, 0,

47 (
tx_™t_cmd
), &tx_ant_cmd);

48 
	}
}

50 
	$iwl_£nd_rss_cfg_cmd
(
iwl_mvm
 *
mvm
)

52 
i
;

53 
iwl_rss_c⁄fig_cmd
 
cmd
 = {

54 .
Êags
 = 
	`˝u_to_À32
(
IWL_RSS_ENABLE
),

55 .
hash_mask
 = 
	`BIT
(
IWL_RSS_HASH_TYPE_IPV4_TCP
) |

56 
	`BIT
(
IWL_RSS_HASH_TYPE_IPV4_UDP
) |

57 
	`BIT
(
IWL_RSS_HASH_TYPE_IPV4_PAYLOAD
) |

58 
	`BIT
(
IWL_RSS_HASH_TYPE_IPV6_TCP
) |

59 
	`BIT
(
IWL_RSS_HASH_TYPE_IPV6_UDP
) |

60 
	`BIT
(
IWL_RSS_HASH_TYPE_IPV6_PAYLOAD
),

63 i‡(
mvm
->
å™s
->
num_rx_queues
 == 1)

67 
i
 = 0; i < 
	`ARRAY_SIZE
(
cmd
.
ödúe˘i⁄_èbÀ
); i++)

68 
cmd
.
ödúe˘i⁄_èbÀ
[
i
] =

69 1 + (
i
 % (
mvm
->
å™s
->
num_rx_queues
 - 1));

70 
	`√tdev_rss_key_fûl
(
cmd
.
£¸ë_key
, (cmd.secret_key));

72  
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
RSS_CONFIG_CMD
, 0, (
cmd
), &cmd);

73 
	}
}

75 
	$iwl_mvm_£nd_dqa_cmd
(
iwl_mvm
 *
mvm
)

77 
iwl_dqa_íabÀ_cmd
 
dqa_cmd
 = {

78 .
cmd_queue
 = 
	`˝u_to_À32
(
IWL_MVM_DQA_CMD_QUEUE
),

80 
u32
 
cmd_id
 = 
	`WIDE_ID
(
DATA_PATH_GROUP
, 
DQA_ENABLE_CMD
);

81 
ªt
;

83 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
cmd_id
, 0, (
dqa_cmd
), &dqa_cmd);

84 i‡(
ªt
)

85 
	`IWL_ERR
(
mvm
, "FaûedÅÿ£nd DQAÉ«blög comm™d: %d\n", 
ªt
);

87 
	`IWL_DEBUG_FW
(
mvm
, "Working in DQA mode\n");

89  
ªt
;

90 
	}
}

92 
	$iwl_mvm_mfu_as£π_dump_nŸif
(
iwl_mvm
 *
mvm
,

93 
iwl_rx_cmd_buf„r
 *
rxb
)

95 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

96 
iwl_mfu_as£π_dump_nŸif
 *
mfu_dump_nŸif
 = (*)
pkt
->
d©a
;

97 
__À32
 *
dump_d©a
 = 
mfu_dump_nŸif
->
d©a
;

98 
n_w‹ds
 = 
	`À32_to_˝u
(
mfu_dump_nŸif
->
d©a_size
Ë/ (
__À32
);

99 
i
;

101 i‡(
mfu_dump_nŸif
->
ödex_num
 == 0)

102 
	`IWL_INFO
(
mvm
, "MFUARTássert id 0x%x occurred\n",

103 
	`À32_to_˝u
(
mfu_dump_nŸif
->
as£π_id
));

105 
i
 = 0; i < 
n_w‹ds
; i++)

106 
	`IWL_DEBUG_INFO
(
mvm
,

108 
	`À16_to_˝u
(
mfu_dump_nŸif
->
ödex_num
) *

109 
n_w‹ds
 + 
i
,

110 
	`À32_to_˝u
(
dump_d©a
[
i
]));

111 
	}
}

113 
boﬁ
 
	$iwl_Æive_‚
(
iwl_nŸif_waô_d©a
 *
nŸif_waô
,

114 
iwl_rx_∑ckë
 *
pkt
, *
d©a
)

116 
pkt_Àn
 = 
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
);

117 
iwl_mvm
 *
mvm
 =

118 
	`c⁄èöî_of
(
nŸif_waô
, 
iwl_mvm
,Çotif_wait);

119 
iwl_mvm_Æive_d©a
 *
Æive_d©a
 = 
d©a
;

120 
iwl_umac_Æive
 *
umac
;

121 
iwl_lmac_Æive
 *
lmac1
;

122 
iwl_lmac_Æive
 *
lmac2
 = 
NULL
;

123 
u16
 
°©us
;

124 
u32
 
lmac_îr‹_evít_èbÀ
, 
umac_îr‹_èbÀ
;

125 
u32
 
vîsi⁄
 = 
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
LEGACY_GROUP
,

126 
UCODE_ALIVE_NTFY
, 0);

127 
u32
 
i
;

130 i‡(
vîsi⁄
 == 6) {

131 
iwl_Æive_¡f_v6
 *
∑live
;

133 i‡(
pkt_Àn
 < (*
∑live
))

134  
Ál£
;

136 
∑live
 = (*)
pkt
->
d©a
;

137 
mvm
->
å™s
->
dbg
.
imr_d©a
.
imr_íabÀ
 =

138 
	`À32_to_˝u
(
∑live
->
imr
.
íabÀd
);

139 
mvm
->
å™s
->
dbg
.
imr_d©a
.
imr_size
 =

140 
	`À32_to_˝u
(
∑live
->
imr
.
size
);

141 
mvm
->
å™s
->
dbg
.
imr_d©a
.
imr2§am_ªmaöbyã
 =

142 
mvm
->
å™s
->
dbg
.
imr_d©a
.
imr_size
;

143 
mvm
->
å™s
->
dbg
.
imr_d©a
.
imr_ba£_addr
 =

144 
∑live
->
imr
.
ba£_addr
;

145 
mvm
->
å™s
->
dbg
.
imr_d©a
.
imr_cuº_addr
 =

146 
	`À64_to_˝u
(
mvm
->
å™s
->
dbg
.
imr_d©a
.
imr_ba£_addr
);

147 
	`IWL_DEBUG_FW
(
mvm
, "IMR Enabled: 0x0%x size 0x0%x Address 0x%016llx\n",

148 
mvm
->
å™s
->
dbg
.
imr_d©a
.
imr_íabÀ
,

149 
mvm
->
å™s
->
dbg
.
imr_d©a
.
imr_size
,

150 
	`À64_to_˝u
(
mvm
->
å™s
->
dbg
.
imr_d©a
.
imr_ba£_addr
));

152 i‡(!
mvm
->
å™s
->
dbg
.
imr_d©a
.
imr_íabÀ
) {

153 
i
 = 0; i < 
	`ARRAY_SIZE
(
mvm
->
å™s
->
dbg
.
a˘ive_ªgi⁄s
); i++) {

154 
iwl_ucode_év
 *
ªg_év
;

155 
iwl_fw_öi_ªgi⁄_év
 *
ªg
;

157 
ªg_év
 = 
mvm
->
å™s
->
dbg
.
a˘ive_ªgi⁄s
[
i
];

158 i‡(!
ªg_év
)

161 
ªg
 = (*)
ªg_év
->
d©a
;

167 i‡(
ªg
->
ty≥
 =
IWL_FW_INI_REGION_DRAM_IMR
) {

168 
mvm
->
å™s
->
dbg
.
unsuµ‹ãd_ªgi⁄_msk
 |
	`BIT
(
i
);

175 i‡(
vîsi⁄
 >= 5) {

176 
iwl_Æive_¡f_v5
 *
∑live
;

178 i‡(
pkt_Àn
 < (*
∑live
))

179  
Ál£
;

181 
∑live
 = (*)
pkt
->
d©a
;

182 
umac
 = &
∑live
->
umac_d©a
;

183 
lmac1
 = &
∑live
->
lmac_d©a
[0];

184 
lmac2
 = &
∑live
->
lmac_d©a
[1];

185 
°©us
 = 
	`À16_to_˝u
(
∑live
->status);

187 
mvm
->
å™s
->
sku_id
[0] = 
	`À32_to_˝u
(
∑live
->sku_id.
d©a
[0]);

188 
mvm
->
å™s
->
sku_id
[1] = 
	`À32_to_˝u
(
∑live
->sku_id.
d©a
[1]);

189 
mvm
->
å™s
->
sku_id
[2] = 
	`À32_to_˝u
(
∑live
->sku_id.
d©a
[2]);

191 
	`IWL_DEBUG_FW
(
mvm
, "Got sku_id: 0x0%x 0x0%x 0x0%x\n",

192 
mvm
->
å™s
->
sku_id
[0],

193 
mvm
->
å™s
->
sku_id
[1],

194 
mvm
->
å™s
->
sku_id
[2]);

195 } i‡(
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
Ë=(
iwl_Æive_¡f_v4
)) {

196 
iwl_Æive_¡f_v4
 *
∑live
;

198 i‡(
pkt_Àn
 < (*
∑live
))

199  
Ál£
;

201 
∑live
 = (*)
pkt
->
d©a
;

202 
umac
 = &
∑live
->
umac_d©a
;

203 
lmac1
 = &
∑live
->
lmac_d©a
[0];

204 
lmac2
 = &
∑live
->
lmac_d©a
[1];

205 
°©us
 = 
	`À16_to_˝u
(
∑live
->status);

206 } i‡(
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
) ==

207 (
iwl_Æive_¡f_v3
)) {

208 
iwl_Æive_¡f_v3
 *
∑live3
;

210 i‡(
pkt_Àn
 < (*
∑live3
))

211  
Ál£
;

213 
∑live3
 = (*)
pkt
->
d©a
;

214 
umac
 = &
∑live3
->
umac_d©a
;

215 
lmac1
 = &
∑live3
->
lmac_d©a
;

216 
°©us
 = 
	`À16_to_˝u
(
∑live3
->status);

218 
	`WARN
(1, "unsupportedáliveÇotification (size %d)\n",

219 
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
));

221  
Ál£
;

224 
lmac_îr‹_evít_èbÀ
 =

225 
	`À32_to_˝u
(
lmac1
->
dbg_±rs
.
îr‹_evít_èbÀ_±r
);

226 
	`iwl_fw_lmac1_£t_Æive_îr_èbÀ
(
mvm
->
å™s
, 
lmac_îr‹_evít_èbÀ
);

228 i‡(
lmac2
)

229 
mvm
->
å™s
->
dbg
.
lmac_îr‹_evít_èbÀ
[1] =

230 
	`À32_to_˝u
(
lmac2
->
dbg_±rs
.
îr‹_evít_èbÀ_±r
);

232 
umac_îr‹_èbÀ
 = 
	`À32_to_˝u
(
umac
->
dbg_±rs
.
îr‹_öfo_addr
) &

233 ~
FW_ADDR_CACHE_CONTROL
;

235 i‡(
umac_îr‹_èbÀ
) {

236 i‡(
umac_îr‹_èbÀ
 >=

237 
mvm
->
å™s
->
cfg
->
mö_umac_îr‹_evít_èbÀ
) {

238 
	`iwl_fw_umac_£t_Æive_îr_èbÀ
(
mvm
->
å™s
,

239 
umac_îr‹_èbÀ
);

241 
	`IWL_ERR
(
mvm
,

243 
umac_îr‹_èbÀ
,

244 (
mvm
->
fwπ
.
cur_fw_img
 =
IWL_UCODE_INIT
) ?

249 
Æive_d©a
->
scd_ba£_addr
 = 
	`À32_to_˝u
(
lmac1
->
dbg_±rs
.
scd_ba£_±r
);

250 
Æive_d©a
->
vÆid
 = 
°©us
 =
IWL_ALIVE_STATUS_OK
;

252 
	`IWL_DEBUG_FW
(
mvm
,

254 
°©us
, 
lmac1
->
vî_ty≥
,Ümac1->
vî_subty≥
);

256 i‡(
lmac2
)

257 
	`IWL_DEBUG_FW
(
mvm
, "Alive ucode CDB\n");

259 
	`IWL_DEBUG_FW
(
mvm
,

261 
	`À32_to_˝u
(
umac
->
umac_maj‹
),

262 
	`À32_to_˝u
(
umac
->
umac_mö‹
));

264 
	`iwl_fwπ_upd©e_fw_vîsi⁄s
(&
mvm
->
fwπ
, 
lmac1
, 
umac
);

266  
åue
;

267 
	}
}

269 
boﬁ
 
	$iwl_waô_öô_com∂ëe
(
iwl_nŸif_waô_d©a
 *
nŸif_waô
,

270 
iwl_rx_∑ckë
 *
pkt
, *
d©a
)

272 
	`WARN_ON
(
pkt
->
hdr
.
cmd
 !
INIT_COMPLETE_NOTIF
);

274  
åue
;

275 
	}
}

277 
boﬁ
 
	$iwl_waô_phy_db_íåy
(
iwl_nŸif_waô_d©a
 *
nŸif_waô
,

278 
iwl_rx_∑ckë
 *
pkt
, *
d©a
)

280 
iwl_phy_db
 *
phy_db
 = 
d©a
;

282 i‡(
pkt
->
hdr
.
cmd
 !
CALIB_RES_NOTIF_PHY_DB
) {

283 
	`WARN_ON
(
pkt
->
hdr
.
cmd
 !
INIT_COMPLETE_NOTIF
);

284  
åue
;

287 
	`WARN_ON
(
	`iwl_phy_db_£t_£˘i⁄
(
phy_db
, 
pkt
));

289  
Ál£
;

290 
	}
}

292 
	$iwl_mvm_¥öt_pd_nŸifiˇti⁄
(
iwl_mvm
 *
mvm
)

294 
	#IWL_FW_PRINT_REG_INFO
(
ªg_«me
) \

295 
	`IWL_ERR
(
mvm
, #ªg_«mê": 0x%x\n", 
	`iwl_ªad_umac_¥ph
(
å™s
, 
ªg_«me
))

	)

297 
iwl_å™s
 *
å™s
 = 
mvm
->trans;

298 
iwl_devi˚_Ámûy
 
devi˚_Ámûy
 = 
å™s
->
å™s_cfg
->device_family;

300 i‡(
devi˚_Ámûy
 < 
IWL_DEVICE_FAMILY_8000
)

303 i‡(
devi˚_Ámûy
 <
IWL_DEVICE_FAMILY_9000
)

304 
	`IWL_FW_PRINT_REG_INFO
(
WFPM_ARC1_PD_NOTIFICATION
);

306 
	`IWL_FW_PRINT_REG_INFO
(
WFPM_LMAC1_PD_NOTIFICATION
);

308 
	`IWL_FW_PRINT_REG_INFO
(
HPM_SECONDARY_DEVICE_STATE
);

311 
	`IWL_FW_PRINT_REG_INFO
(
WFPM_MAC_OTP_CFG7_ADDR
);

312 
	`IWL_FW_PRINT_REG_INFO
(
WFPM_MAC_OTP_CFG7_DATA
);

313 
	}
}

315 
	$iwl_mvm_lﬂd_ucode_waô_Æive
(
iwl_mvm
 *
mvm
,

316 
iwl_ucode_ty≥
 
ucode_ty≥
)

318 
iwl_nŸifiˇti⁄_waô
 
Æive_waô
;

319 
iwl_mvm_Æive_d©a
 
Æive_d©a
 = {};

320 c⁄° 
fw_img
 *
fw
;

321 
ªt
;

322 
iwl_ucode_ty≥
 
ﬁd_ty≥
 = 
mvm
->
fwπ
.
cur_fw_img
;

323 c⁄° 
u16
 
Æive_cmd
[] = { 
UCODE_ALIVE_NTFY
 };

324 
boﬁ
 
run_ö_rfkûl
 =

325 
ucode_ty≥
 =
IWL_UCODE_INIT
 || 
	`iwl_mvm_has_unifõd_ucode
(
mvm
);

326 
u8
 
cou¡
;

327 
iwl_pc_d©a
 *
pc_d©a
;

329 i‡(
ucode_ty≥
 =
IWL_UCODE_REGULAR
 &&

330 
	`iwl_fw_dbg_c⁄f_u¢if„r
(
mvm
->
fw
, 
FW_DBG_START_FROM_ALIVE
) &&

331 !(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

332 
IWL_UCODE_TLV_CAPA_USNIFFER_UNIFIED
)))

333 
fw
 = 
	`iwl_gë_ucode_image
(
mvm
->fw, 
IWL_UCODE_REGULAR_USNIFFER
);

335 
fw
 = 
	`iwl_gë_ucode_image
(
mvm
->fw, 
ucode_ty≥
);

336 i‡(
	`WARN_ON
(!
fw
))

337  -
EINVAL
;

338 
	`iwl_fw_£t_cuºít_image
(&
mvm
->
fwπ
, 
ucode_ty≥
);

339 
	`˛ór_bô
(
IWL_MVM_STATUS_FIRMWARE_RUNNING
, &
mvm
->
°©us
);

341 
	`iwl_öô_nŸifiˇti⁄_waô
(&
mvm
->
nŸif_waô
, &
Æive_waô
,

342 
Æive_cmd
, 
	`ARRAY_SIZE
(alive_cmd),

343 
iwl_Æive_‚
, &
Æive_d©a
);

350 
ªt
 = 
	`iwl_å™s_°¨t_fw
(
mvm
->
å™s
, 
fw
, 
run_ö_rfkûl
);

351 i‡(
ªt
) {

352 
	`iwl_fw_£t_cuºít_image
(&
mvm
->
fwπ
, 
ﬁd_ty≥
);

353 
	`iwl_ªmove_nŸifiˇti⁄
(&
mvm
->
nŸif_waô
, &
Æive_waô
);

354  
ªt
;

361 
ªt
 = 
	`iwl_waô_nŸifiˇti⁄
(&
mvm
->
nŸif_waô
, &
Æive_waô
,

362 
MVM_UCODE_ALIVE_TIMEOUT
);

364 i‡(
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 ==

365 
IWL_DEVICE_FAMILY_AX210
) {

367 
	`IWL_INFO
(
mvm
, "WFPM_UMAC_PD_NOTIFICATION: 0x%x\n",

368 
	`iwl_ªad_umac_¥ph
(
mvm
->
å™s
, 
WFPM_ARC1_PD_NOTIFICATION
));

369 
	`IWL_INFO
(
mvm
, "WFPM_LMAC2_PD_NOTIFICATION: 0x%x\n",

370 
	`iwl_ªad_umac_¥ph
(
mvm
->
å™s
, 
WFPM_LMAC2_PD_NOTIFICATION
));

371 
	`IWL_INFO
(
mvm
, "WFPM_AUTH_KEY_0: 0x%x\n",

372 
	`iwl_ªad_umac_¥ph
(
mvm
->
å™s
, 
SB_MODIFY_CFG_FLAG
));

373 
	`IWL_INFO
(
mvm
, "CNVI_SCU_SEQ_DATA_DW9: 0x%x\n",

374 
	`iwl_ªad_¥ph
(
mvm
->
å™s
, 
CNVI_SCU_SEQ_DATA_DW9
));

377 i‡(
ªt
) {

378 
iwl_å™s
 *
å™s
 = 
mvm
->trans;

381 i‡(
å™s
->
å™s_cfg
->
devi˚_Ámûy
 >=

382 
IWL_DEVICE_FAMILY_22000
) {

383 
	`IWL_ERR
(
mvm
,

385 
	`iwl_ªad_umac_¥ph
(
å™s
, 
UMAG_SB_CPU_1_STATUS
),

386 
	`iwl_ªad_umac_¥ph
(
å™s
,

387 
UMAG_SB_CPU_2_STATUS
));

388 } i‡(
å™s
->
å™s_cfg
->
devi˚_Ámûy
 >=

389 
IWL_DEVICE_FAMILY_8000
) {

390 
	`IWL_ERR
(
mvm
,

392 
	`iwl_ªad_¥ph
(
å™s
, 
SB_CPU_1_STATUS
),

393 
	`iwl_ªad_¥ph
(
å™s
, 
SB_CPU_2_STATUS
));

396 
	`iwl_mvm_¥öt_pd_nŸifiˇti⁄
(
mvm
);

399 i‡(
å™s
->
å™s_cfg
->
devi˚_Ámûy
 >=

400 
IWL_DEVICE_FAMILY_22000
) {

401 
pc_d©a
 = 
å™s
->
dbg
.pc_data;

402 
cou¡
 = 0; cou¡ < 
å™s
->
dbg
.
num_pc
;

403 
cou¡
++, 
pc_d©a
++)

404 
	`IWL_ERR
(
mvm
, "%s: 0x%x\n",

405 
pc_d©a
->
pc_«me
,

406 
pc_d©a
->
pc_addªss
);

407 } i‡(
å™s
->
å™s_cfg
->
devi˚_Ámûy
 >=

408 
IWL_DEVICE_FAMILY_9000
) {

409 
	`IWL_ERR
(
mvm
, "UMAC PC: 0x%x\n",

410 
	`iwl_ªad_umac_¥ph
(
å™s
,

411 
UREG_UMAC_CURRENT_PC
));

412 
	`IWL_ERR
(
mvm
, "LMAC PC: 0x%x\n",

413 
	`iwl_ªad_umac_¥ph
(
å™s
,

414 
UREG_LMAC1_CURRENT_PC
));

415 i‡(
	`iwl_mvm_is_cdb_suµ‹ãd
(
mvm
))

416 
	`IWL_ERR
(
mvm
, "LMAC2 PC: 0x%x\n",

417 
	`iwl_ªad_umac_¥ph
(
å™s
,

418 
UREG_LMAC2_CURRENT_PC
));

421 i‡(
ªt
 =-
ETIMEDOUT
 && !
mvm
->
∂dr_sync
)

422 
	`iwl_fw_dbg_îr‹_cﬁÀ˘
(&
mvm
->
fwπ
,

423 
FW_DBG_TRIGGER_ALIVE_TIMEOUT
);

425 
	`iwl_fw_£t_cuºít_image
(&
mvm
->
fwπ
, 
ﬁd_ty≥
);

426  
ªt
;

429 i‡(!
Æive_d©a
.
vÆid
) {

430 
	`IWL_ERR
(
mvm
, "Loaded ucode isÇot valid!\n");

431 
	`iwl_fw_£t_cuºít_image
(&
mvm
->
fwπ
, 
ﬁd_ty≥
);

432  -
EIO
;

436 
	`iwl_mei_Æive_nŸif
(
åue
);

438 
ªt
 = 
	`iwl_≤vm_lﬂd
(
mvm
->
å™s
, &mvm->
nŸif_waô
,

439 &
mvm
->
fw
->
ucode_ˇ∑
);

440 i‡(
ªt
) {

441 
	`IWL_ERR
(
mvm
, "Timeout waiting for PNVMÜoad!\n");

442 
	`iwl_fw_£t_cuºít_image
(&
mvm
->
fwπ
, 
ﬁd_ty≥
);

443  
ªt
;

446 
	`iwl_å™s_fw_Æive
(
mvm
->
å™s
, 
Æive_d©a
.
scd_ba£_addr
);

457 
	`mem£t
(&
mvm
->
queue_öfo
, 0, (mvm->queue_info));

464 
mvm
->
queue_öfo
[
IWL_MVM_DQA_CMD_QUEUE
].
tid_bôm≠
 =

465 
	`BIT
(
IWL_MAX_TID_COUNT
 + 2);

467 
	`£t_bô
(
IWL_MVM_STATUS_FIRMWARE_RUNNING
, &
mvm
->
°©us
);

468 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


469 
	`iwl_fw_£t_dbg_ªc_⁄
(&
mvm
->
fwπ
);

478 
	`cfg80211_bss_Êush
(
mvm
->
hw
->
wùhy
);

481 
	}
}

483 
	$iwl_mvm_phy_fûãr_öô
(
iwl_mvm
 *
mvm
,

484 
iwl_phy_•ecific_cfg
 *
phy_fûãrs
)

486 #ifde‡
CONFIG_ACPI


487 *
phy_fûãrs
 = 
mvm
->phy_filters;

489 
	}
}

491 
	$iwl_mvm_u©s_öô
(
iwl_mvm
 *
mvm
)

493 
u8
 
cmd_vî
;

494 
ªt
;

495 
iwl_ho°_cmd
 
cmd
 = {

496 .
id
 = 
	`WIDE_ID
(
REGULATORY_AND_NVM_GROUP
,

497 
UATS_TABLE_CMD
),

498 .
Êags
 = 0,

499 .
d©a
[0] = &
mvm
->
fwπ
.
u©s_èbÀ
,

500 .
Àn
[0] = (
mvm
->
fwπ
.
u©s_èbÀ
),

501 .
d©aÊags
[0] = 
IWL_HCMD_DFL_NOCOPY
,

504 i‡(!(
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 >=

505 
IWL_DEVICE_FAMILY_AX210
)) {

506 
	`IWL_DEBUG_RADIO
(
mvm
, "UATS feature isÇot supported\n");

510 i‡(!
mvm
->
fwπ
.
u©s_íabÀd
) {

511 
	`IWL_DEBUG_RADIO
(
mvm
, "UATS feature is disabled\n");

515 
cmd_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
cmd
.
id
,

516 
IWL_FW_CMD_VER_UNKNOWN
);

517 i‡(
cmd_vî
 != 1) {

518 
	`IWL_DEBUG_RADIO
(
mvm
,

520 
cmd_vî
);

524 
ªt
 = 
	`iwl_uefi_gë_u©s_èbÀ
(
mvm
->
å™s
, &mvm->
fwπ
);

525 i‡(
ªt
 < 0) {

526 
	`IWL_ERR
(
mvm
, "ÁûedÅÿªad UATSÅabÀ (%d)\n", 
ªt
);

530 
ªt
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
cmd
);

531 i‡(
ªt
 < 0)

532 
	`IWL_ERR
(
mvm
, "ÁûedÅÿ£nd UATS_TABLE_CMD (%d)\n", 
ªt
);

534 
	`IWL_DEBUG_RADIO
(
mvm
, "UATS_TABLE_CMD sentÅo FW\n");

535 
	}
}

537 
	$iwl_mvm_sgom_öô
(
iwl_mvm
 *
mvm
)

539 
u8
 
cmd_vî
;

540 
ªt
;

541 
iwl_ho°_cmd
 
cmd
 = {

542 .
id
 = 
	`WIDE_ID
(
REGULATORY_AND_NVM_GROUP
,

543 
SAR_OFFSET_MAPPING_TABLE_CMD
),

544 .
Êags
 = 0,

545 .
d©a
[0] = &
mvm
->
fwπ
.
sgom_èbÀ
,

546 .
Àn
[0] = (
mvm
->
fwπ
.
sgom_èbÀ
),

547 .
d©aÊags
[0] = 
IWL_HCMD_DFL_NOCOPY
,

550 i‡(!
mvm
->
fwπ
.
sgom_íabÀd
) {

551 
	`IWL_DEBUG_RADIO
(
mvm
, "SGOMÅable is disabled\n");

555 
cmd_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
cmd
.
id
,

556 
IWL_FW_CMD_VER_UNKNOWN
);

558 i‡(
cmd_vî
 != 2) {

559 
	`IWL_DEBUG_RADIO
(
mvm
, "command version is unsupported. version = %d\n",

560 
cmd_vî
);

564 
ªt
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
cmd
);

565 i‡(
ªt
 < 0)

566 
	`IWL_ERR
(
mvm
, "ÁûedÅÿ£nd SAR_OFFSET_MAPPING_CMD (%d)\n", 
ªt
);

568  
ªt
;

569 
	}
}

571 
	$iwl_£nd_phy_cfg_cmd
(
iwl_mvm
 *
mvm
)

573 
u32
 
cmd_id
 = 
PHY_CONFIGURATION_CMD
;

574 
iwl_phy_cfg_cmd_v3
 
phy_cfg_cmd
;

575 
iwl_ucode_ty≥
 
ucode_ty≥
 = 
mvm
->
fwπ
.
cur_fw_img
;

576 
u8
 
cmd_vî
;

577 
size_t
 
cmd_size
;

579 i‡(
	`iwl_mvm_has_unifõd_ucode
(
mvm
) &&

580 !
mvm
->
å™s
->
cfg
->
tx_wôh_siso_divîsôy
)

583 i‡(
mvm
->
å™s
->
cfg
->
tx_wôh_siso_divîsôy
) {

588 
phy_cfg_cmd
.
phy_cfg
 =

589 
	`˝u_to_À32
(
FW_PHY_CFG_CHAIN_SAD_ENABLED
);

593 
phy_cfg_cmd
.
phy_cfg
 = 
	`˝u_to_À32
(
	`iwl_mvm_gë_phy_c⁄fig
(
mvm
));

596 
phy_cfg_cmd
.
phy_cfg
 |=

597 
	`˝u_to_À32
(
mvm
->
å™s
->
å™s_cfg
->
exåa_phy_cfg_Êags
);

599 
phy_cfg_cmd
.
ˇlib_c⁄åﬁ
.
evít_åiggî
 =

600 
mvm
->
fw
->
deÁu…_ˇlib
[
ucode_ty≥
].
evít_åiggî
;

601 
phy_cfg_cmd
.
ˇlib_c⁄åﬁ
.
Êow_åiggî
 =

602 
mvm
->
fw
->
deÁu…_ˇlib
[
ucode_ty≥
].
Êow_åiggî
;

604 
cmd_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
cmd_id
,

605 
IWL_FW_CMD_VER_UNKNOWN
);

606 i‡(
cmd_vî
 >= 3)

607 
	`iwl_mvm_phy_fûãr_öô
(
mvm
, &
phy_cfg_cmd
.
phy_•ecific_cfg
);

609 
	`IWL_DEBUG_INFO
(
mvm
, "Sending Phy CFG command: 0x%x\n",

610 
phy_cfg_cmd
.
phy_cfg
);

611 
cmd_size
 = (
cmd_vî
 =3Ë? (
iwl_phy_cfg_cmd_v3
) :

612 (
iwl_phy_cfg_cmd_v1
);

613  
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
cmd_id
, 0, 
cmd_size
, &
phy_cfg_cmd
);

614 
	}
}

616 
	$iwl_run_unifõd_mvm_ucode
(
iwl_mvm
 *
mvm
)

618 
iwl_nŸifiˇti⁄_waô
 
öô_waô
;

619 
iwl_nvm_ac˚ss_com∂ëe_cmd
 
nvm_com∂ëe
 = {};

620 
iwl_öô_exãnded_cfg_cmd
 
öô_cfg
 = {

621 .
öô_Êags
 = 
	`˝u_to_À32
(
	`BIT
(
IWL_INIT_NVM
)),

623 c⁄° 
u16
 
öô_com∂ëe
[] = {

624 
INIT_COMPLETE_NOTIF
,

626 
u32
 
sb_cfg
;

627 
ªt
;

629 i‡(
mvm
->
å™s
->
cfg
->
tx_wôh_siso_divîsôy
)

630 
öô_cfg
.
öô_Êags
 |
	`˝u_to_À32
(
	`BIT
(
IWL_INIT_PHY
));

632 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

634 
mvm
->
rfkûl_ß„_öô_d⁄e
 = 
Ál£
;

636 i‡(
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 =
IWL_DEVICE_FAMILY_AX210
) {

637 
sb_cfg
 = 
	`iwl_ªad_umac_¥ph
(
mvm
->
å™s
, 
SB_MODIFY_CFG_FLAG
);

639 
mvm
->
∂dr_sync
 = 
sb_cfg
 =
SB_CFG_RESIDES_IN_ROM
;

640 i‡(
mvm
->
∂dr_sync
 && 
	`iwl_mei_∂dr_ªq
())

641  -
EBUSY
;

644 
	`iwl_öô_nŸifiˇti⁄_waô
(&
mvm
->
nŸif_waô
,

645 &
öô_waô
,

646 
öô_com∂ëe
,

647 
	`ARRAY_SIZE
(
öô_com∂ëe
),

648 
iwl_waô_öô_com∂ëe
,

649 
NULL
);

651 
	`iwl_dbg_év_time_poöt
(&
mvm
->
fwπ
, 
IWL_FW_INI_TIME_POINT_EARLY
, 
NULL
);

654 
ªt
 = 
	`iwl_mvm_lﬂd_ucode_waô_Æive
(
mvm
, 
IWL_UCODE_REGULAR
);

655 i‡(
ªt
) {

656 
	`IWL_ERR
(
mvm
, "FaûedÅÿ°¨àRT ucode: %d\n", 
ªt
);

659 i‡(
mvm
->
∂dr_sync
) {

660 
	`iwl_mei_Æive_nŸif
(
Ál£
);

661 
	`iwl_å™s_pcõ_ªmove
(
mvm
->
å™s
, 
åue
);

664 
îr‹
;

666 
	`iwl_dbg_év_time_poöt
(&
mvm
->
fwπ
, 
IWL_FW_INI_TIME_POINT_AFTER_ALIVE
,

667 
NULL
);

669 i‡(
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 =
IWL_DEVICE_FAMILY_BZ
)

670 
mvm
->
å™s
->
°ï_urm
 = !!(
	`iwl_ªad_umac_¥ph
(mvm->trans,

671 
CNVI_PMU_STEP_FLOW
) &

672 
CNVI_PMU_STEP_FLOW_FORCE_URM
);

677 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
	`WIDE_ID
(
SYSTEM_GROUP
,

678 
INIT_EXTENDED_CFG_CMD
),

679 
CMD_SEND_IN_RFKILL
,

680 (
öô_cfg
), &init_cfg);

681 i‡(
ªt
) {

682 
	`IWL_ERR
(
mvm
, "FailedÅoÑun init config command: %d\n",

683 
ªt
);

684 
îr‹
;

688 i‡(
mvm
->
nvm_fûe_«me
) {

689 
ªt
 = 
	`iwl_ªad_exã∫Æ_nvm
(
mvm
->
å™s
, mvm->
nvm_fûe_«me
,

690 
mvm
->
nvm_£˘i⁄s
);

691 i‡(
ªt
)

692 
îr‹
;

693 
ªt
 = 
	`iwl_mvm_lﬂd_nvm_to_nic
(
mvm
);

694 i‡(
ªt
)

695 
îr‹
;

698 i‡(
IWL_MVM_PARSE_NVM
 && !
mvm
->
nvm_d©a
) {

699 
ªt
 = 
	`iwl_nvm_öô
(
mvm
);

700 i‡(
ªt
) {

701 
	`IWL_ERR
(
mvm
, "FaûedÅÿªad NVM: %d\n", 
ªt
);

702 
îr‹
;

706 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
	`WIDE_ID
(
REGULATORY_AND_NVM_GROUP
,

707 
NVM_ACCESS_COMPLETE
),

708 
CMD_SEND_IN_RFKILL
,

709 (
nvm_com∂ëe
), &nvm_complete);

710 i‡(
ªt
) {

711 
	`IWL_ERR
(
mvm
, "FailedÅoÑun complete NVMáccess: %d\n",

712 
ªt
);

713 
îr‹
;

716 
ªt
 = 
	`iwl_£nd_phy_cfg_cmd
(
mvm
);

717 i‡(
ªt
) {

718 
	`IWL_ERR
(
mvm
, "FailedÅoÑun PHY configuration: %d\n",

719 
ªt
);

720 
îr‹
;

724 
ªt
 = 
	`iwl_waô_nŸifiˇti⁄
(&
mvm
->
nŸif_waô
, &
öô_waô
,

725 
MVM_UCODE_ALIVE_TIMEOUT
);

726 i‡(
ªt
)

727  
ªt
;

730 i‡(!
IWL_MVM_PARSE_NVM
 && !
mvm
->
nvm_d©a
) {

731 
mvm
->
nvm_d©a
 = 
	`iwl_gë_nvm
(mvm->
å™s
, mvm->
fw
,

732 
mvm
->
£t_tx_™t
, mvm->
£t_rx_™t
);

733 i‡(
	`IS_ERR
(
mvm
->
nvm_d©a
)) {

734 
ªt
 = 
	`PTR_ERR
(
mvm
->
nvm_d©a
);

735 
mvm
->
nvm_d©a
 = 
NULL
;

736 
	`IWL_ERR
(
mvm
, "FaûedÅÿªad NVM: %d\n", 
ªt
);

737  
ªt
;

741 
mvm
->
rfkûl_ß„_öô_d⁄e
 = 
åue
;

745 
îr‹
:

746 
	`iwl_ªmove_nŸifiˇti⁄
(&
mvm
->
nŸif_waô
, &
öô_waô
);

747  
ªt
;

748 
	}
}

750 
	$iwl_run_öô_mvm_ucode
(
iwl_mvm
 *
mvm
)

752 
iwl_nŸifiˇti⁄_waô
 
ˇlib_waô
;

753 c⁄° 
u16
 
öô_com∂ëe
[] = {

754 
INIT_COMPLETE_NOTIF
,

755 
CALIB_RES_NOTIF_PHY_DB


757 
ªt
;

759 i‡(
	`iwl_mvm_has_unifõd_ucode
(
mvm
))

760  
	`iwl_run_unifõd_mvm_ucode
(
mvm
);

762 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

764 
mvm
->
rfkûl_ß„_öô_d⁄e
 = 
Ál£
;

766 
	`iwl_öô_nŸifiˇti⁄_waô
(&
mvm
->
nŸif_waô
,

767 &
ˇlib_waô
,

768 
öô_com∂ëe
,

769 
	`ARRAY_SIZE
(
öô_com∂ëe
),

770 
iwl_waô_phy_db_íåy
,

771 
mvm
->
phy_db
);

773 
	`iwl_dbg_év_time_poöt
(&
mvm
->
fwπ
, 
IWL_FW_INI_TIME_POINT_EARLY
, 
NULL
);

776 
ªt
 = 
	`iwl_mvm_lﬂd_ucode_waô_Æive
(
mvm
, 
IWL_UCODE_INIT
);

777 i‡(
ªt
) {

778 
	`IWL_ERR
(
mvm
, "FaûedÅÿ°¨àINIT ucode: %d\n", 
ªt
);

779 
ªmove_nŸif
;

782 i‡(
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 < 
IWL_DEVICE_FAMILY_8000
) {

783 
ªt
 = 
	`iwl_mvm_£nd_bt_öô_c⁄f
(
mvm
);

784 i‡(
ªt
)

785 
ªmove_nŸif
;

789 i‡(!
mvm
->
nvm_d©a
) {

790 
ªt
 = 
	`iwl_nvm_öô
(
mvm
);

791 i‡(
ªt
) {

792 
	`IWL_ERR
(
mvm
, "FaûedÅÿªad NVM: %d\n", 
ªt
);

793 
ªmove_nŸif
;

798 i‡(
mvm
->
nvm_fûe_«me
) {

799 
ªt
 = 
	`iwl_mvm_lﬂd_nvm_to_nic
(
mvm
);

800 i‡(
ªt
)

801 
ªmove_nŸif
;

804 
	`WARN_ONCE
(
mvm
->
nvm_d©a
->
nvm_vîsi⁄
 < mvm->
å™s
->
cfg
->
nvm_vî
,

806 
mvm
->
nvm_d©a
->
nvm_vîsi⁄
, mvm->
å™s
->
cfg
->
nvm_vî
);

812 i‡(
	`iwl_mvm_is_ødio_hw_kûÀd
(
mvm
)) {

813 
	`IWL_DEBUG_RF_KILL
(
mvm
,

815 
ªmove_nŸif
;

818 
mvm
->
rfkûl_ß„_öô_d⁄e
 = 
åue
;

821 
ªt
 = 
	`iwl_£nd_tx_™t_cfg
(
mvm
, 
	`iwl_mvm_gë_vÆid_tx_™t
(mvm));

822 i‡(
ªt
)

823 
ªmove_nŸif
;

825 
ªt
 = 
	`iwl_£nd_phy_cfg_cmd
(
mvm
);

826 i‡(
ªt
) {

827 
	`IWL_ERR
(
mvm
, "FailedÅoÑun INIT calibrations: %d\n",

828 
ªt
);

829 
ªmove_nŸif
;

836 
ªt
 = 
	`iwl_waô_nŸifiˇti⁄
(&
mvm
->
nŸif_waô
, &
ˇlib_waô
,

837 
MVM_UCODE_CALIB_TIMEOUT
);

838 i‡(!
ªt
)

839 
out
;

841 i‡(
	`iwl_mvm_is_ødio_hw_kûÀd
(
mvm
)) {

842 
	`IWL_DEBUG_RF_KILL
(
mvm
, "RFKILL while calibrating.\n");

843 
ªt
 = 0;

845 
	`IWL_ERR
(
mvm
, "FailedÅoÑun INIT calibrations: %d\n",

846 
ªt
);

849 
out
;

851 
ªmove_nŸif
:

852 
	`iwl_ªmove_nŸifiˇti⁄
(&
mvm
->
nŸif_waô
, &
ˇlib_waô
);

853 
out
:

854 
mvm
->
rfkûl_ß„_öô_d⁄e
 = 
Ál£
;

855 i‡(
iwlmvm_mod_∑øms
.
öô_dbg
 && !
mvm
->
nvm_d©a
) {

857 
mvm
->
nvm_d©a
 = 
	`kzÆloc
((
iwl_nvm_d©a
) +

858 (
õì80211_ch™√l
) +

859 (
õì80211_øã
),

860 
GFP_KERNEL
);

861 i‡(!
mvm
->
nvm_d©a
)

862  -
ENOMEM
;

863 
mvm
->
nvm_d©a
->
b™ds
[0].
ch™√ls
 = mvm->nvm_data->channels;

864 
mvm
->
nvm_d©a
->
b™ds
[0].
n_ch™√ls
 = 1;

865 
mvm
->
nvm_d©a
->
b™ds
[0].
n_bôøãs
 = 1;

866 
mvm
->
nvm_d©a
->
b™ds
[0].
bôøãs
 =

867 (*)(
mvm
->
nvm_d©a
->
ch™√ls
 + 1);

868 
mvm
->
nvm_d©a
->
b™ds
[0].
bôøãs
->
hw_vÆue
 = 10;

871  
ªt
;

872 
	}
}

874 
	$iwl_mvm_c⁄fig_…r
(
iwl_mvm
 *
mvm
)

876 
iwl_…r_c⁄fig_cmd
 
cmd
 = {

877 .
Êags
 = 
	`˝u_to_À32
(
LTR_CFG_FLAG_FEATURE_ENABLE
),

880 i‡(!
mvm
->
å™s
->
…r_íabÀd
)

883  
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
LTR_CONFIG
, 0,

884 (
cmd
), &cmd);

885 
	}
}

887 
	$iwl_mvm_ßr_£À˘_¥ofûe
(
iwl_mvm
 *
mvm
, 
¥of_a
, 
¥of_b
)

889 
u32
 
cmd_id
 = 
REDUCE_TX_POWER_CMD
;

890 
iwl_dev_tx_powî_cmd
 
cmd
 = {

891 .
comm⁄
.
£t_mode
 = 
	`˝u_to_À32
(
IWL_TX_POWER_MODE_SET_CHAINS
),

893 
__À16
 *
≥r_chaö
;

894 
ªt
;

895 
u16
 
Àn
 = 0;

896 
u32
 
n_subb™ds
;

897 
u8
 
cmd_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
cmd_id
,

898 
IWL_FW_CMD_VER_UNKNOWN
);

899 i‡(
cmd_vî
 == 7) {

900 
Àn
 = (
cmd
.
v7
);

901 
n_subb™ds
 = 
IWL_NUM_SUB_BANDS_V2
;

902 
≥r_chaö
 = 
cmd
.
v7
.per_chain[0][0];

903 
cmd
.
v7
.
Êags
 = 
	`˝u_to_À32
(
mvm
->
fwπ
.
ªdu˚d_powî_Êags
);

904 } i‡(
cmd_vî
 == 6) {

905 
Àn
 = (
cmd
.
v6
);

906 
n_subb™ds
 = 
IWL_NUM_SUB_BANDS_V2
;

907 
≥r_chaö
 = 
cmd
.
v6
.per_chain[0][0];

908 } i‡(
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

909 
IWL_UCODE_TLV_API_REDUCE_TX_POWER
)) {

910 
Àn
 = (
cmd
.
v5
);

911 
n_subb™ds
 = 
IWL_NUM_SUB_BANDS_V1
;

912 
≥r_chaö
 = 
cmd
.
v5
.per_chain[0][0];

913 } i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

914 
IWL_UCODE_TLV_CAPA_TX_POWER_ACK
)) {

915 
Àn
 = (
cmd
.
v4
);

916 
n_subb™ds
 = 
IWL_NUM_SUB_BANDS_V1
;

917 
≥r_chaö
 = 
cmd
.
v4
.per_chain[0][0];

919 
Àn
 = (
cmd
.
v3
);

920 
n_subb™ds
 = 
IWL_NUM_SUB_BANDS_V1
;

921 
≥r_chaö
 = 
cmd
.
v3
.per_chain[0][0];

925 
Àn
 +(
cmd
.
comm⁄
);

927 
ªt
 = 
	`iwl_ßr_fûl_¥ofûe
(&
mvm
->
fwπ
, 
≥r_chaö
,

928 
IWL_NUM_CHAIN_TABLES
,

929 
n_subb™ds
, 
¥of_a
, 
¥of_b
);

932 i‡(
ªt
)

933  
ªt
;

935 
	`iwl_mei_£t_powî_limô
(
≥r_chaö
);

937 
	`IWL_DEBUG_RADIO
(
mvm
, "Sending REDUCE_TX_POWER_CMDÖer chain\n");

938  
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
cmd_id
, 0, 
Àn
, &
cmd
);

939 
	}
}

941 
	$iwl_mvm_gë_ßr_geo_¥ofûe
(
iwl_mvm
 *
mvm
)

943 
iwl_geo_tx_powî_¥ofûes_cmd
 
geo_tx_cmd
;

944 
iwl_geo_tx_powî_¥ofûes_ª•
 *
ª•
;

945 
u16
 
Àn
;

946 
ªt
;

947 
iwl_ho°_cmd
 
cmd
 = {

948 .
id
 = 
	`WIDE_ID
(
PHY_OPS_GROUP
, 
PER_CHAIN_LIMIT_OFFSET_CMD
),

949 .
Êags
 = 
CMD_WANT_SKB
,

950 .
d©a
 = { &
geo_tx_cmd
 },

952 
u8
 
cmd_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
cmd
.
id
,

953 
IWL_FW_CMD_VER_UNKNOWN
);

956 
geo_tx_cmd
.
v1
.
›s
 =

957 
	`˝u_to_À32
(
IWL_PER_CHAIN_OFFSET_GET_CURRENT_TABLE
);

959 i‡(
cmd_vî
 == 5)

960 
Àn
 = (
geo_tx_cmd
.
v5
);

961 i‡(
cmd_vî
 == 4)

962 
Àn
 = (
geo_tx_cmd
.
v4
);

963 i‡(
cmd_vî
 == 3)

964 
Àn
 = (
geo_tx_cmd
.
v3
);

965 i‡(
	`fw_has_≠i
(&
mvm
->
fwπ
.
fw
->
ucode_ˇ∑
,

966 
IWL_UCODE_TLV_API_SAR_TABLE_VER
))

967 
Àn
 = (
geo_tx_cmd
.
v2
);

969 
Àn
 = (
geo_tx_cmd
.
v1
);

971 i‡(!
	`iwl_ßr_geo_suµ‹t
(&
mvm
->
fwπ
))

972  -
EOPNOTSUPP
;

974 
cmd
.
Àn
[0] =Üen;

976 
ªt
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
cmd
);

977 i‡(
ªt
) {

978 
	`IWL_ERR
(
mvm
, "FaûedÅÿgë geogøphi¯¥ofûêöfÿ%d\n", 
ªt
);

979  
ªt
;

982 
ª•
 = (*)
cmd
.
ª•_pkt
->
d©a
;

983 
ªt
 = 
	`À32_to_˝u
(
ª•
->
¥ofûe_idx
);

985 i‡(
	`WARN_ON
(
ªt
 > 
BIOS_GEO_MAX_PROFILE_NUM
))

986 
ªt
 = -
EIO
;

988 
	`iwl_‰ì_ª•
(&
cmd
);

989  
ªt
;

990 
	}
}

992 
	$iwl_mvm_ßr_geo_öô
(
iwl_mvm
 *
mvm
)

994 
u32
 
cmd_id
 = 
	`WIDE_ID
(
PHY_OPS_GROUP
, 
PER_CHAIN_LIMIT_OFFSET_CMD
);

995 
iwl_geo_tx_powî_¥ofûes_cmd
 
cmd
;

996 
u16
 
Àn
;

997 
u32
 
n_b™ds
;

998 
u32
 
n_¥ofûes
;

999 
__À32
 
sk
 = 
	`˝u_to_À32
(0);

1000 
ªt
;

1001 
u8
 
cmd_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
cmd_id
,

1002 
IWL_FW_CMD_VER_UNKNOWN
);

1004 
	`BUILD_BUG_ON
(
	`off£tof
(
iwl_geo_tx_powî_¥ofûes_cmd_v1
, 
›s
) !=

1005 
	`off£tof
(
iwl_geo_tx_powî_¥ofûes_cmd_v2
, 
›s
) ||

1006 
	`off£tof
(
iwl_geo_tx_powî_¥ofûes_cmd_v2
, 
›s
) !=

1007 
	`off£tof
(
iwl_geo_tx_powî_¥ofûes_cmd_v3
, 
›s
) ||

1008 
	`off£tof
(
iwl_geo_tx_powî_¥ofûes_cmd_v3
, 
›s
) !=

1009 
	`off£tof
(
iwl_geo_tx_powî_¥ofûes_cmd_v4
, 
›s
) ||

1010 
	`off£tof
(
iwl_geo_tx_powî_¥ofûes_cmd_v4
, 
›s
) !=

1011 
	`off£tof
(
iwl_geo_tx_powî_¥ofûes_cmd_v5
, 
›s
));

1014 
cmd
.
v1
.
›s
 = 
	`˝u_to_À32
(
IWL_PER_CHAIN_OFFSET_SET_TABLES
);

1017 i‡(
mvm
->
fwπ
.
geo_ªv
 == 1)

1018 
sk
 = 
	`˝u_to_À32
(1);

1020 i‡(
cmd_vî
 == 5) {

1021 
Àn
 = (
cmd
.
v5
);

1022 
n_b™ds
 = 
	`ARRAY_SIZE
(
cmd
.
v5
.
èbÀ
[0]);

1023 
n_¥ofûes
 = 
BIOS_GEO_MAX_PROFILE_NUM
;

1024 
cmd
.
v5
.
èbÀ_ªvisi⁄
 = 
sk
;

1025 } i‡(
cmd_vî
 == 4) {

1026 
Àn
 = (
cmd
.
v4
);

1027 
n_b™ds
 = 
	`ARRAY_SIZE
(
cmd
.
v4
.
èbÀ
[0]);

1028 
n_¥ofûes
 = 
BIOS_GEO_MAX_PROFILE_NUM
;

1029 
cmd
.
v4
.
èbÀ_ªvisi⁄
 = 
sk
;

1030 } i‡(
cmd_vî
 == 3) {

1031 
Àn
 = (
cmd
.
v3
);

1032 
n_b™ds
 = 
	`ARRAY_SIZE
(
cmd
.
v3
.
èbÀ
[0]);

1033 
n_¥ofûes
 = 
BIOS_GEO_MIN_PROFILE_NUM
;

1034 
cmd
.
v3
.
èbÀ_ªvisi⁄
 = 
sk
;

1035 } i‡(
	`fw_has_≠i
(&
mvm
->
fwπ
.
fw
->
ucode_ˇ∑
,

1036 
IWL_UCODE_TLV_API_SAR_TABLE_VER
)) {

1037 
Àn
 = (
cmd
.
v2
);

1038 
n_b™ds
 = 
	`ARRAY_SIZE
(
cmd
.
v2
.
èbÀ
[0]);

1039 
n_¥ofûes
 = 
BIOS_GEO_MIN_PROFILE_NUM
;

1040 
cmd
.
v2
.
èbÀ_ªvisi⁄
 = 
sk
;

1042 
Àn
 = (
cmd
.
v1
);

1043 
n_b™ds
 = 
	`ARRAY_SIZE
(
cmd
.
v1
.
èbÀ
[0]);

1044 
n_¥ofûes
 = 
BIOS_GEO_MIN_PROFILE_NUM
;

1047 
	`BUILD_BUG_ON
(
	`off£tof
(
iwl_geo_tx_powî_¥ofûes_cmd_v1
, 
èbÀ
) !=

1048 
	`off£tof
(
iwl_geo_tx_powî_¥ofûes_cmd_v2
, 
èbÀ
) ||

1049 
	`off£tof
(
iwl_geo_tx_powî_¥ofûes_cmd_v2
, 
èbÀ
) !=

1050 
	`off£tof
(
iwl_geo_tx_powî_¥ofûes_cmd_v3
, 
èbÀ
) ||

1051 
	`off£tof
(
iwl_geo_tx_powî_¥ofûes_cmd_v3
, 
èbÀ
) !=

1052 
	`off£tof
(
iwl_geo_tx_powî_¥ofûes_cmd_v4
, 
èbÀ
) ||

1053 
	`off£tof
(
iwl_geo_tx_powî_¥ofûes_cmd_v4
, 
èbÀ
) !=

1054 
	`off£tof
(
iwl_geo_tx_powî_¥ofûes_cmd_v5
, 
èbÀ
));

1056 
ªt
 = 
	`iwl_ßr_geo_fûl_èbÀ
(&
mvm
->
fwπ
, &
cmd
.
v1
.
èbÀ
[0][0],

1057 
n_b™ds
, 
n_¥ofûes
);

1063 i‡(
ªt
)

1066  
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
cmd_id
, 0, 
Àn
, &
cmd
);

1067 
	}
}

1069 
	$iwl_mvm_µag_£nd_cmd
(
iwl_mvm
 *
mvm
)

1071 
iwl_µag_èbÀ_cmd
 
cmd
;

1072 
ªt
, 
cmd_size
;

1074 
ªt
 = 
	`iwl_fûl_µag_èbÀ
(&
mvm
->
fwπ
, &
cmd
, &
cmd_size
);

1076 i‡(
ªt
 < 0)

1079 
	`IWL_DEBUG_RADIO
(
mvm
, "Sending PER_PLATFORM_ANT_GAIN_CMD\n");

1080 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
	`WIDE_ID
(
PHY_OPS_GROUP
,

1081 
PER_PLATFORM_ANT_GAIN_CMD
),

1082 0, 
cmd_size
, &
cmd
);

1083 i‡(
ªt
 < 0)

1084 
	`IWL_ERR
(
mvm
, "failedÅo send PER_PLATFORM_ANT_GAIN_CMD (%d)\n",

1085 
ªt
);

1087  
ªt
;

1088 
	}
}

1090 
	$iwl_mvm_µag_öô
(
iwl_mvm
 *
mvm
)

1093 i‡(!(
	`iwl_is_µag_≠¥oved
(&
mvm
->
fwπ
)))

1096  
	`iwl_mvm_µag_£nd_cmd
(
mvm
);

1097 
	}
}

1099 
boﬁ
 
	$iwl_mvm_add_to_ès_block_li°
(
__À32
 *
li°
, __À32 *
À_size
, 
mcc
)

1101 
i
;

1102 
u32
 
size
 = 
	`À32_to_˝u
(*
À_size
);

1105 i‡(
size
 >
IWL_WTAS_BLACK_LIST_MAX
)

1106  
Ál£
;

1108 
i
 = 0; i < 
size
; i++) {

1109 i‡(
li°
[
i
] =
	`˝u_to_À32
(
mcc
))

1110  
åue
;

1113 
li°
[
size
++] = 
	`˝u_to_À32
(
mcc
);

1114 *
À_size
 = 
	`˝u_to_À32
(
size
);

1115  
åue
;

1116 
	}
}

1118 
	$iwl_mvm_ès_öô
(
iwl_mvm
 *
mvm
)

1120 
u32
 
cmd_id
 = 
	`WIDE_ID
(
REGULATORY_AND_NVM_GROUP
, 
TAS_CONFIG
);

1121 
ªt
;

1122 
iwl_ès_d©a
 
d©a
 = {};

1123 
iwl_ès_c⁄fig_cmd
 
cmd
 = {};

1124 
cmd_size
, 
fw_vî
;

1126 
	`BUILD_BUG_ON
(
	`ARRAY_SIZE
(
d©a
.
block_li°_¨øy
) !=

1127 
IWL_WTAS_BLACK_LIST_MAX
);

1128 
	`BUILD_BUG_ON
(
	`ARRAY_SIZE
(
cmd
.
comm⁄
.
block_li°_¨øy
) !=

1129 
IWL_WTAS_BLACK_LIST_MAX
);

1131 i‡(!
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_CAPA_TAS_CFG
)) {

1132 
	`IWL_DEBUG_RADIO
(
mvm
, "TASÇotÉnabled in FW\n");

1136 
ªt
 = 
	`iwl_bios_gë_ès_èbÀ
(&
mvm
->
fwπ
, &
d©a
);

1137 i‡(
ªt
 < 0) {

1138 
	`IWL_DEBUG_RADIO
(
mvm
,

1140 
ªt
);

1144 i‡(
ªt
 == 0)

1147 i‡(!
	`iwl_is_ès_≠¥oved
()) {

1148 
	`IWL_DEBUG_RADIO
(
mvm
,

1150 
	`dmi_gë_sy°em_öfo
(
DMI_SYS_VENDOR
) ?: "<unknown>");

1151 i‡((!
	`iwl_mvm_add_to_ès_block_li°
(
d©a
.
block_li°_¨øy
,

1152 &
d©a
.
block_li°_size
,

1153 
IWL_MCC_US
)) ||

1154 (!
	`iwl_mvm_add_to_ès_block_li°
(
d©a
.
block_li°_¨øy
,

1155 &
d©a
.
block_li°_size
,

1156 
IWL_MCC_CANADA
))) {

1157 
	`IWL_DEBUG_RADIO
(
mvm
,

1162 
	`IWL_DEBUG_RADIO
(
mvm
,

1164 
	`dmi_gë_sy°em_öfo
(
DMI_SYS_VENDOR
) ?: "<unknown>");

1167 
fw_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
cmd_id
,

1168 
IWL_FW_CMD_VER_UNKNOWN
);

1170 
	`mem˝y
(&
cmd
.
comm⁄
, &
d©a
, (
iwl_ès_c⁄fig_cmd_comm⁄
));

1173 i‡(
fw_vî
 == 4) {

1174 
cmd
.
v4
.
ovîride_ès_õc
 = 
d©a
.override_tas_iec;

1175 
cmd
.
v4
.
íabÀ_ès_õc
 = 
d©a
.enable_tas_iec;

1176 
cmd
.
v4
.
uß_ès_uhb_Ælowed
 = 
d©a
.usa_tas_uhb_allowed;

1178 
cmd
.
v3
.
ovîride_ès_õc
 = 
	`˝u_to_À16
(
d©a
.override_tas_iec);

1179 
cmd
.
v3
.
íabÀ_ès_õc
 = 
	`˝u_to_À16
(
d©a
.enable_tas_iec);

1182 
cmd_size
 = (
iwl_ès_c⁄fig_cmd_comm⁄
);

1183 i‡(
fw_vî
 >= 3)

1185 
cmd_size
 +(
iwl_ès_c⁄fig_cmd_v3
);

1187 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
cmd_id
, 0, 
cmd_size
, &
cmd
);

1188 i‡(
ªt
 < 0)

1189 
	`IWL_DEBUG_RADIO
(
mvm
, "ÁûedÅÿ£nd TAS_CONFIG (%d)\n", 
ªt
);

1190 
	}
}

1192 
boﬁ
 
	$iwl_mvm_evÆ_dsm_rfi
(
iwl_mvm
 *
mvm
)

1194 
u32
 
vÆue
 = 0;

1196 
boﬁ
 
bios_íabÀ_rfi
 = 
Ál£
;

1197 
ªt
 = 
	`iwl_bios_gë_dsm
(&
mvm
->
fwπ
, 
DSM_FUNC_RFI_CONFIG
, &
vÆue
);

1200 i‡(
ªt
 < 0) {

1201 
	`IWL_DEBUG_RADIO
(
mvm
, "FaûedÅÿgë DSM RFI,Ñë=%d\n", 
ªt
);

1202  
bios_íabÀ_rfi
;

1205 
vÆue
 &
DSM_VALUE_RFI_DISABLE
;

1211 i‡(!
vÆue
) {

1212 
	`IWL_DEBUG_RADIO
(
mvm
, "DSM RFI isÉvaluatedÅoÉnable\n");

1213 
bios_íabÀ_rfi
 = 
åue
;

1214 } i‡(
vÆue
 =
DSM_VALUE_RFI_DISABLE
) {

1215 
	`IWL_DEBUG_RADIO
(
mvm
, "DSM RFI isÉvaluatedÅo disable\n");

1217 
	`IWL_DEBUG_RADIO
(
mvm
,

1218 "DSM RFI gŸ invÆid vÆue, vÆue=%d\n", 
vÆue
);

1221  
bios_íabÀ_rfi
;

1222 
	}
}

1224 
	$iwl_mvm_œri_cfg
(
iwl_mvm
 *
mvm
)

1226 
ªt
;

1227 
u32
 
vÆue
;

1228 
iwl_œri_c⁄fig_ch™ge_cmd_v7
 
cmd
 = {};

1229 
u8
 
cmd_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
,

1230 
	`WIDE_ID
(
REGULATORY_AND_NVM_GROUP
,

1231 
LARI_CONFIG_CHANGE
), 1);

1233 
cmd
.
c⁄fig_bôm≠
 = 
	`iwl_gë_œri_c⁄fig_bôm≠
(&
mvm
->
fwπ
);

1235 
ªt
 = 
	`iwl_bios_gë_dsm
(&
mvm
->
fwπ
, 
DSM_FUNC_11AX_ENABLEMENT
, &
vÆue
);

1236 i‡(!
ªt
)

1237 
cmd
.
€m_11ax_Ælow_bôm≠
 = 
	`˝u_to_À32
(
vÆue
);

1239 
ªt
 = 
	`iwl_bios_gë_dsm
(&
mvm
->
fwπ
, 
DSM_FUNC_ENABLE_UNII4_CHAN
, &
vÆue
);

1240 i‡(!
ªt
)

1241 
cmd
.
€m_unii4_Ælow_bôm≠
 = 
	`˝u_to_À32
(
vÆue
);

1243 
ªt
 = 
	`iwl_bios_gë_dsm
(&
mvm
->
fwπ
, 
DSM_FUNC_ACTIVATE_CHANNEL
, &
vÆue
);

1244 i‡(!
ªt
) {

1245 i‡(
cmd_vî
 < 8)

1246 
vÆue
 &~
ACTIVATE_5G2_IN_WW_MASK
;

1247 
cmd
.
ch™_°©e_a˘ive_bôm≠
 = 
	`˝u_to_À32
(
vÆue
);

1250 
ªt
 = 
	`iwl_bios_gë_dsm
(&
mvm
->
fwπ
, 
DSM_FUNC_ENABLE_6E
, &
vÆue
);

1251 i‡(!
ªt
)

1252 
cmd
.
€m_uhb_Ælow_bôm≠
 = 
	`˝u_to_À32
(
vÆue
);

1254 
ªt
 = 
	`iwl_bios_gë_dsm
(&
mvm
->
fwπ
, 
DSM_FUNC_FORCE_DISABLE_CHANNELS
,

1255 &
vÆue
);

1256 i‡(!
ªt
)

1257 
cmd
.
f‹˚_dißbÀ_ch™√ls_bôm≠
 = 
	`˝u_to_À32
(
vÆue
);

1259 
ªt
 = 
	`iwl_bios_gë_dsm
(&
mvm
->
fwπ
, 
DSM_FUNC_ENERGY_DETECTION_THRESHOLD
,

1260 &
vÆue
);

1261 i‡(!
ªt
)

1262 
cmd
.
edt_bôm≠
 = 
	`˝u_to_À32
(
vÆue
);

1264 i‡(
cmd
.
c⁄fig_bôm≠
 ||

1265 
cmd
.
€m_uhb_Ælow_bôm≠
 ||

1266 
cmd
.
€m_11ax_Ælow_bôm≠
 ||

1267 
cmd
.
€m_unii4_Ælow_bôm≠
 ||

1268 
cmd
.
ch™_°©e_a˘ive_bôm≠
 ||

1269 
cmd
.
f‹˚_dißbÀ_ch™√ls_bôm≠
 ||

1270 
cmd
.
edt_bôm≠
) {

1271 
size_t
 
cmd_size
;

1273 
cmd_vî
) {

1276 
cmd_size
 = (
iwl_œri_c⁄fig_ch™ge_cmd_v7
);

1279 
cmd_size
 = (
iwl_œri_c⁄fig_ch™ge_cmd_v6
);

1282 
cmd_size
 = (
iwl_œri_c⁄fig_ch™ge_cmd_v5
);

1285 
cmd_size
 = (
iwl_œri_c⁄fig_ch™ge_cmd_v4
);

1288 
cmd_size
 = (
iwl_œri_c⁄fig_ch™ge_cmd_v3
);

1291 
cmd_size
 = (
iwl_œri_c⁄fig_ch™ge_cmd_v2
);

1294 
cmd_size
 = (
iwl_œri_c⁄fig_ch™ge_cmd_v1
);

1298 
	`IWL_DEBUG_RADIO
(
mvm
,

1300 
	`À32_to_˝u
(
cmd
.
c⁄fig_bôm≠
),

1301 
	`À32_to_˝u
(
cmd
.
€m_11ax_Ælow_bôm≠
));

1302 
	`IWL_DEBUG_RADIO
(
mvm
,

1304 
	`À32_to_˝u
(
cmd
.
€m_unii4_Ælow_bôm≠
),

1305 
	`À32_to_˝u
(
cmd
.
ch™_°©e_a˘ive_bôm≠
),

1306 
cmd_vî
);

1307 
	`IWL_DEBUG_RADIO
(
mvm
,

1309 
	`À32_to_˝u
(
cmd
.
€m_uhb_Ælow_bôm≠
),

1310 
	`À32_to_˝u
(
cmd
.
f‹˚_dißbÀ_ch™√ls_bôm≠
));

1311 
	`IWL_DEBUG_RADIO
(
mvm
,

1313 
	`À32_to_˝u
(
cmd
.
edt_bôm≠
));

1314 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
,

1315 
	`WIDE_ID
(
REGULATORY_AND_NVM_GROUP
,

1316 
LARI_CONFIG_CHANGE
),

1317 0, 
cmd_size
, &
cmd
);

1318 i‡(
ªt
 < 0)

1319 
	`IWL_DEBUG_RADIO
(
mvm
,

1321 
ªt
);

1324 i‡(
	`À32_to_˝u
(
cmd
.
€m_uhb_Ælow_bôm≠
Ë& 
IWL_UATS_VLP_AP_SUPPORTED
 ||

1325 
	`À32_to_˝u
(
cmd
.
€m_uhb_Ælow_bôm≠
Ë& 
IWL_UATS_AFC_AP_SUPPORTED
)

1326 
mvm
->
fwπ
.
u©s_íabÀd
 = 
åue
;

1327 
	}
}

1329 
	$iwl_mvm_gë_bios_èbÀs
(
iwl_mvm
 *
mvm
)

1331 
ªt
;

1333 
	`iwl_a˝i_gë_guid_lock_°©us
(&
mvm
->
fwπ
);

1336 
ªt
 = 
	`iwl_bios_gë_µag_èbÀ
(&
mvm
->
fwπ
);

1337 i‡(
ªt
 < 0) {

1338 
	`IWL_DEBUG_RADIO
(
mvm
,

1340 
ªt
);

1344 
ªt
 = 
	`iwl_bios_gë_wrds_èbÀ
(&
mvm
->
fwπ
);

1345 i‡(
ªt
 < 0) {

1346 
	`IWL_DEBUG_RADIO
(
mvm
,

1348 
ªt
);

1353 i‡(!
	`iwl_bios_gë_wgds_èbÀ
(&
mvm
->
fwπ
)) {

1360 
	`IWL_ERR
(
mvm
, "BIOS contains WGDS butÇo WRDS\n");

1364 
ªt
 = 
	`iwl_bios_gë_ewrd_èbÀ
(&
mvm
->
fwπ
);

1367 i‡(
ªt
 < 0)

1368 
	`IWL_DEBUG_RADIO
(
mvm
,

1370 
ªt
);

1373 i‡(
	`iwl_ßr_geo_suµ‹t
(&
mvm
->
fwπ
)) {

1374 
ªt
 = 
	`iwl_bios_gë_wgds_èbÀ
(&
mvm
->
fwπ
);

1375 i‡(
ªt
 < 0)

1376 
	`IWL_DEBUG_RADIO
(
mvm
,

1378 
ªt
);

1383 
	`iwl_a˝i_gë_phy_fûãrs
(&
mvm
->
fwπ
, &mvm->
phy_fûãrs
);

1385 i‡(
	`iwl_bios_gë_eckv
(&
mvm
->
fwπ
, &mvm->
ext_˛ock_vÆid
))

1386 
	`IWL_DEBUG_RADIO
(
mvm
, "ECKVÅable doesn'tÉxist in BIOS\n");

1387 
	}
}

1389 
	$iwl_mvm_disc⁄√˘_ôî©‹
(*
d©a
, 
u8
 *
mac
,

1390 
õì80211_vif
 *
vif
)

1392 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
)

1393 
	`õì80211_hw_ª°¨t_disc⁄√˘
(
vif
);

1394 
	}
}

1396 
	$iwl_mvm_£nd_ªcovîy_cmd
(
iwl_mvm
 *
mvm
, 
u32
 
Êags
)

1398 
u32
 
îr‹_log_size
 = 
mvm
->
fw
->
ucode_ˇ∑
.error_log_size;

1399 
ªt
;

1400 
u32
 
ª•
;

1402 
iwl_fw_îr‹_ªcovîy_cmd
 
ªcovîy_cmd
 = {

1403 .
Êags
 = 
	`˝u_to_À32
(flags),

1404 .
buf_size
 = 0,

1406 
iwl_ho°_cmd
 
ho°_cmd
 = {

1407 .
id
 = 
	`WIDE_ID
(
SYSTEM_GROUP
, 
FW_ERROR_RECOVERY_CMD
),

1408 .
Êags
 = 
CMD_WANT_SKB
,

1409 .
d©a
 = {&
ªcovîy_cmd
, },

1410 .
Àn
 = {(
ªcovîy_cmd
), },

1414 i‡(!
îr‹_log_size
)

1417 i‡(
Êags
 & 
ERROR_RECOVERY_UPDATE_DB
) {

1419 i‡(!
mvm
->
îr‹_ªcovîy_buf
)

1422 
ho°_cmd
.
d©a
[1] = 
mvm
->
îr‹_ªcovîy_buf
;

1423 
ho°_cmd
.
Àn
[1] = 
îr‹_log_size
;

1424 
ho°_cmd
.
d©aÊags
[1] = 
IWL_HCMD_DFL_NOCOPY
;

1425 
ªcovîy_cmd
.
buf_size
 = 
	`˝u_to_À32
(
îr‹_log_size
);

1428 
ªt
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
ho°_cmd
);

1429 
	`k‰ì
(
mvm
->
îr‹_ªcovîy_buf
);

1430 
mvm
->
îr‹_ªcovîy_buf
 = 
NULL
;

1432 i‡(
ªt
) {

1433 
	`IWL_ERR
(
mvm
, "FaûedÅÿ£ndÑecovîy cmd %d\n", 
ªt
);

1438 i‡(
Êags
 & 
ERROR_RECOVERY_UPDATE_DB
) {

1439 
ª•
 = 
	`À32_to_˝u
(*(
__À32
 *)
ho°_cmd
.
ª•_pkt
->
d©a
);

1440 i‡(
ª•
) {

1441 
	`IWL_ERR
(
mvm
,

1443 
ª•
);

1445 
	`õì80211_ôî©e_öãrÁ˚s
(
mvm
->
hw
, 0,

1446 
iwl_mvm_disc⁄√˘_ôî©‹
,

1447 
mvm
);

1450 
	}
}

1452 
	$iwl_mvm_ßr_öô
(
iwl_mvm
 *
mvm
)

1454  
	`iwl_mvm_ßr_£À˘_¥ofûe
(
mvm
, 1, 1);

1455 
	}
}

1457 
	$iwl_mvm_lﬂd_π_fw
(
iwl_mvm
 *
mvm
)

1459 
ªt
;

1461 i‡(
	`iwl_mvm_has_unifõd_ucode
(
mvm
))

1462  
	`iwl_run_unifõd_mvm_ucode
(
mvm
);

1464 
ªt
 = 
	`iwl_run_öô_mvm_ucode
(
mvm
);

1466 i‡(
ªt
) {

1467 
	`IWL_ERR
(
mvm
, "FaûedÅÿru¿INIT ucode: %d\n", 
ªt
);

1469 i‡(
iwlmvm_mod_∑øms
.
öô_dbg
)

1471  
ªt
;

1474 
	`iwl_fw_dbg_°›_sync
(&
mvm
->
fwπ
);

1475 
	`iwl_å™s_°›_devi˚
(
mvm
->
å™s
);

1476 
ªt
 = 
	`iwl_å™s_°¨t_hw
(
mvm
->
å™s
);

1477 i‡(
ªt
)

1478  
ªt
;

1480 
mvm
->
rfkûl_ß„_öô_d⁄e
 = 
Ál£
;

1481 
ªt
 = 
	`iwl_mvm_lﬂd_ucode_waô_Æive
(
mvm
, 
IWL_UCODE_REGULAR
);

1482 i‡(
ªt
)

1483  
ªt
;

1485 
mvm
->
rfkûl_ß„_öô_d⁄e
 = 
åue
;

1487 
	`iwl_dbg_év_time_poöt
(&
mvm
->
fwπ
, 
IWL_FW_INI_TIME_POINT_AFTER_ALIVE
,

1488 
NULL
);

1490  
	`iwl_öô_∑gög
(&
mvm
->
fwπ
, mvm->fwπ.
cur_fw_img
);

1491 
	}
}

1493 
	$iwl_mvm_up
(
iwl_mvm
 *
mvm
)

1495 
ªt
, 
i
;

1496 
õì80211_suµ‹ãd_b™d
 *
sb™d
 = 
NULL
;

1498 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1500 
ªt
 = 
	`iwl_å™s_°¨t_hw
(
mvm
->
å™s
);

1501 i‡(
ªt
)

1502  
ªt
;

1504 
ªt
 = 
	`iwl_mvm_lﬂd_π_fw
(
mvm
);

1505 i‡(
ªt
) {

1506 
	`IWL_ERR
(
mvm
, "FaûedÅÿ°¨àRT ucode: %d\n", 
ªt
);

1507 i‡(
ªt
 !-
ERFKILL
 && !
mvm
->
∂dr_sync
)

1508 
	`iwl_fw_dbg_îr‹_cﬁÀ˘
(&
mvm
->
fwπ
,

1509 
FW_DBG_TRIGGER_DRIVER
);

1510 
îr‹
;

1514 
mvm
->
∂dr_sync
 = 
Ál£
;

1516 
	`iwl_fw_dißbÀ_dbg_as£πs
(&
mvm
->
fwπ
);

1517 
	`iwl_gë_sh¨ed_mem_c⁄f
(&
mvm
->
fwπ
);

1519 
ªt
 = 
	`iwl_mvm_sf_upd©e
(
mvm
, 
NULL
, 
Ál£
);

1520 i‡(
ªt
)

1521 
	`IWL_ERR
(
mvm
, "FailedÅo initialize Smart Fifo\n");

1523 i‡(!
	`iwl_å™s_dbg_öi_vÆid
(
mvm
->
å™s
)) {

1524 
mvm
->
fwπ
.
dump
.
c⁄f
 = 
FW_DBG_INVALID
;

1526 i‡(
mvm
->
fw
->
dbg
.
de°_év
)

1527 
mvm
->
fwπ
.
dump
.
c⁄f
 = 
FW_DBG_START_FROM_ALIVE
;

1528 
	`iwl_fw_°¨t_dbg_c⁄f
(&
mvm
->
fwπ
, 
FW_DBG_START_FROM_ALIVE
);

1531 
ªt
 = 
	`iwl_£nd_tx_™t_cfg
(
mvm
, 
	`iwl_mvm_gë_vÆid_tx_™t
(mvm));

1532 i‡(
ªt
)

1533 
îr‹
;

1535 i‡(!
	`iwl_mvm_has_unifõd_ucode
(
mvm
)) {

1537 
ªt
 = 
	`iwl_£nd_phy_db_d©a
(
mvm
->
phy_db
);

1538 i‡(
ªt
)

1539 
îr‹
;

1540 
ªt
 = 
	`iwl_£nd_phy_cfg_cmd
(
mvm
);

1541 i‡(
ªt
)

1542 
îr‹
;

1545 
ªt
 = 
	`iwl_mvm_£nd_bt_öô_c⁄f
(
mvm
);

1546 i‡(
ªt
)

1547 
îr‹
;

1549 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

1550 
IWL_UCODE_TLV_CAPA_SOC_LATENCY_SUPPORT
)) {

1551 
ªt
 = 
	`iwl_£t_soc_œãncy
(&
mvm
->
fwπ
);

1552 i‡(
ªt
)

1553 
îr‹
;

1556 
	`iwl_mvm_œri_cfg
(
mvm
);

1559 
ªt
 = 
	`iwl_c⁄figuª_rxq
(&
mvm
->
fwπ
);

1560 i‡(
ªt
)

1561 
îr‹
;

1563 i‡(
	`iwl_mvm_has_√w_rx_≠i
(
mvm
)) {

1564 
ªt
 = 
	`iwl_£nd_rss_cfg_cmd
(
mvm
);

1565 i‡(
ªt
) {

1566 
	`IWL_ERR
(
mvm
, "FailedÅo configure RSS queues: %d\n",

1567 
ªt
);

1568 
îr‹
;

1573 
i
 = 0; i < 
mvm
->
fw
->
ucode_ˇ∑
.
num_°©i⁄s
; i++) {

1574 
	`RCU_INIT_POINTER
(
mvm
->
fw_id_to_mac_id
[
i
], 
NULL
);

1575 
	`RCU_INIT_POINTER
(
mvm
->
fw_id_to_lök_°a
[
i
], 
NULL
);

1578 
i
 = 0; i < 
IWL_MVM_FW_MAX_LINK_ID
 + 1; i++)

1579 
	`RCU_INIT_POINTER
(
mvm
->
lök_id_to_lök_c⁄f
[
i
], 
NULL
);

1581 
	`mem£t
(&
mvm
->
fw_lök_ids_m≠
, 0, (mvm->fw_link_ids_map));

1583 
mvm
->
tdls_cs
.
≥î
.
°a_id
 = 
IWL_MVM_INVALID_STA
;

1586 
	`mem£t
(&
mvm
->
œ°_quŸa_cmd
, 0xff, (mvm->last_quota_cmd));

1588 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_CAPA_DQA_SUPPORT
)) {

1589 
ªt
 = 
	`iwl_mvm_£nd_dqa_cmd
(
mvm
);

1590 i‡(
ªt
)

1591 
îr‹
;

1600 i‡(!
	`iwl_mvm_has_√w_°©i⁄_≠i
(
mvm
->
fw
)) {

1605 
ªt
 = 
	`iwl_mvm_add_aux_°a
(
mvm
, 
MAC_INDEX_AUX
);

1606 i‡(
ªt
)

1607 
îr‹
;

1611 
i
 = 0;

1612 !
sb™d
 && 
i
 < 
NUM_NL80211_BANDS
)

1613 
sb™d
 = 
mvm
->
hw
->
wùhy
->
b™ds
[
i
++];

1615 i‡(
	`WARN_ON_ONCE
(!
sb™d
)) {

1616 
ªt
 = -
ENODEV
;

1617 
îr‹
;

1620 i‡(
	`iwl_mvm_is_â_ö_fw
(
mvm
)) {

1625 
	`iwl_mvm_£nd_ãmp_ªp‹t_ths_cmd
(
mvm
);

1628 
	`iwl_mvm_â_tx_backoff
(
mvm
, 0);

1631 #ifde‡
CONFIG_THERMAL


1638 i‡(
	`iwl_mvm_is_˘dp_suµ‹ãd
(
mvm
)) {

1639 
ªt
 = 
	`iwl_mvm_˘dp_comm™d
(
mvm
, 
CTDP_CMD_OPERATION_START
,

1640 
mvm
->
coﬁög_dev
.
cur_°©e
);

1641 i‡(
ªt
)

1642 
îr‹
;

1646 i‡(!
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_CAPA_SET_LTR_GEN2
))

1647 
	`WARN_ON
(
	`iwl_mvm_c⁄fig_…r
(
mvm
));

1649 
ªt
 = 
	`iwl_mvm_powî_upd©e_devi˚
(
mvm
);

1650 i‡(
ªt
)

1651 
îr‹
;

1657 i‡(!
	`ã°_bô
(
IWL_MVM_STATUS_HW_CTKILL
, &
mvm
->
°©us
)) {

1658 
ªt
 = 
	`iwl_mvm_öô_mcc
(
mvm
);

1659 i‡(
ªt
)

1660 
îr‹
;

1663 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_CAPA_UMAC_SCAN
)) {

1664 
mvm
->
sˇn_ty≥
 = 
IWL_SCAN_TYPE_NOT_SET
;

1665 
mvm
->
hb_sˇn_ty≥
 = 
IWL_SCAN_TYPE_NOT_SET
;

1666 
ªt
 = 
	`iwl_mvm_c⁄fig_sˇn
(
mvm
);

1667 i‡(
ªt
)

1668 
îr‹
;

1671 i‡(
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
)) {

1672 
	`iwl_mvm_£nd_ªcovîy_cmd
(
mvm
, 
ERROR_RECOVERY_UPDATE_DB
);

1674 i‡(
mvm
->
time_sync
.
a˘ive
)

1675 
	`iwl_mvm_time_sync_c⁄fig
(
mvm
, mvm->
time_sync
.
≥î_addr
,

1676 
IWL_TIME_SYNC_PROTOCOL_TM
 |

1677 
IWL_TIME_SYNC_PROTOCOL_FTM
);

1680 i‡(!
mvm
->
±p_d©a
.
±p_˛ock
)

1681 
	`iwl_mvm_±p_öô
(
mvm
);

1683 
ªt
 = 
	`iwl_mvm_µag_öô
(
mvm
);

1684 i‡(
ªt
)

1685 
îr‹
;

1687 
ªt
 = 
	`iwl_mvm_ßr_öô
(
mvm
);

1688 i‡(
ªt
 == 0)

1689 
ªt
 = 
	`iwl_mvm_ßr_geo_öô
(
mvm
);

1690 i‡(
ªt
 < 0)

1691 
îr‹
;

1693 
ªt
 = 
	`iwl_mvm_sgom_öô
(
mvm
);

1694 i‡(
ªt
)

1695 
îr‹
;

1697 
	`iwl_mvm_ès_öô
(
mvm
);

1698 
	`iwl_mvm_Àds_sync
(
mvm
);

1699 
	`iwl_mvm_u©s_öô
(
mvm
);

1701 i‡(
	`iwl_rfi_suµ‹ãd
(
mvm
)) {

1702 i‡(
	`iwl_mvm_evÆ_dsm_rfi
(
mvm
))

1703 
	`iwl_rfi_£nd_c⁄fig_cmd
(
mvm
, 
NULL
);

1706 
	`iwl_mvm_mei_devi˚_°©e
(
mvm
, 
åue
);

1708 
	`IWL_DEBUG_INFO
(
mvm
, "RT uCode started.\n");

1710 
îr‹
:

1711 i‡(!
iwlmvm_mod_∑øms
.
öô_dbg
 || !
ªt
)

1712 
	`iwl_mvm_°›_devi˚
(
mvm
);

1713  
ªt
;

1714 
	}
}

1716 
	$iwl_mvm_lﬂd_d3_fw
(
iwl_mvm
 *
mvm
)

1718 
ªt
, 
i
;

1720 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1722 
ªt
 = 
	`iwl_å™s_°¨t_hw
(
mvm
->
å™s
);

1723 i‡(
ªt
)

1724  
ªt
;

1726 
ªt
 = 
	`iwl_mvm_lﬂd_ucode_waô_Æive
(
mvm
, 
IWL_UCODE_WOWLAN
);

1727 i‡(
ªt
) {

1728 
	`IWL_ERR
(
mvm
, "FaûedÅÿ°¨àWoWLAN fúmw¨e: %d\n", 
ªt
);

1729 
îr‹
;

1732 
ªt
 = 
	`iwl_£nd_tx_™t_cfg
(
mvm
, 
	`iwl_mvm_gë_vÆid_tx_™t
(mvm));

1733 i‡(
ªt
)

1734 
îr‹
;

1737 
ªt
 = 
	`iwl_£nd_phy_db_d©a
(
mvm
->
phy_db
);

1738 i‡(
ªt
)

1739 
îr‹
;

1741 
ªt
 = 
	`iwl_£nd_phy_cfg_cmd
(
mvm
);

1742 i‡(
ªt
)

1743 
îr‹
;

1746 
i
 = 0; i < 
mvm
->
fw
->
ucode_ˇ∑
.
num_°©i⁄s
; i++) {

1747 
	`RCU_INIT_POINTER
(
mvm
->
fw_id_to_mac_id
[
i
], 
NULL
);

1748 
	`RCU_INIT_POINTER
(
mvm
->
fw_id_to_lök_°a
[
i
], 
NULL
);

1751 i‡(!
	`iwl_mvm_has_√w_°©i⁄_≠i
(
mvm
->
fw
)) {

1760 
ªt
 = 
	`iwl_mvm_add_aux_°a
(
mvm
, 
MAC_INDEX_AUX
);

1761 i‡(
ªt
)

1762 
îr‹
;

1766 
îr‹
:

1767 
	`iwl_mvm_°›_devi˚
(
mvm
);

1768  
ªt
;

1769 
	}
}

1771 
	$iwl_mvm_rx_mfu¨t_nŸif
(
iwl_mvm
 *
mvm
,

1772 
iwl_rx_cmd_buf„r
 *
rxb
)

1774 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

1775 
iwl_mfu¨t_lﬂd_nŸif
 *
mfu¨t_nŸif
 = (*)
pkt
->
d©a
;

1777 
	`IWL_DEBUG_INFO
(
mvm
,

1779 
	`À32_to_˝u
(
mfu¨t_nŸif
->
ö°ÆÀd_vî
),

1780 
	`À32_to_˝u
(
mfu¨t_nŸif
->
exã∫Æ_vî
),

1781 
	`À32_to_˝u
(
mfu¨t_nŸif
->
°©us
),

1782 
	`À32_to_˝u
(
mfu¨t_nŸif
->
duøti⁄
));

1784 i‡(
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
Ë=(*
mfu¨t_nŸif
))

1785 
	`IWL_DEBUG_INFO
(
mvm
,

1787 
	`À32_to_˝u
(
mfu¨t_nŸif
->
image_size
));

1788 
	}
}

	@iwlmvm.mod.c

1 
	~<löux/moduÀ.h
>

2 
	#INCLUDE_VERMAGIC


	)

3 
	~<löux/buûd-ß….h
>

4 
	~<löux/ñ‚Ÿe-…o.h
>

5 
	~<löux/exp‹t-öã∫Æ.h
>

6 
	~<löux/vîmagic.h
>

7 
	~<löux/compûî.h
>

9 #ifde‡
CONFIG_UNWINDER_ORC


10 
	~<asm/‹c_hódî.h
>

11 
	gORC_HEADER
;

14 
	gBUILD_SALT
;

15 
	gBUILD_LTO_INFO
;

17 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

18 
MODULE_INFO
(
«me
, 
KBUILD_MODNAME
);

20 
__visibÀ
 
moduÀ
 
__this_moduÀ


21 
__£˘i⁄
(".gnu.linkonce.this_module") = {

22 .
«me
 = 
KBUILD_MODNAME
,

23 .
	göô
 = 
öô_moduÀ
,

24 #ifde‡
CONFIG_MODULE_UNLOAD


25 .
	gexô
 = 
˛ónup_moduÀ
,

27 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

30 
MODULE_INFO
(
öåì
, "Y");

32 #ifde‡
CONFIG_MITIGATION_RETPOLINE


33 
MODULE_INFO
(
ªçﬁöe
, "Y");

38 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

39 
__u£d
 
__£˘i⁄
("__versions") = {

381 
MODULE_INFO
(
dïíds
, "mac80211,cfg80211,iwlwifi");

384 
MODULE_INFO
(
§cvîsi⁄
, "2290C3DDD2266D63C589D16");

	@led.c

6 
	~<löux/Àds.h
>

7 
	~"iwl-io.h
"

8 
	~"iwl-c§.h
"

9 
	~"mvm.h
"

11 
	$iwl_mvm_£nd_Àd_fw_cmd
(
iwl_mvm
 *
mvm
, 
boﬁ
 
⁄
)

13 
iwl_Àd_cmd
 
Àd_cmd
 = {

14 .
°©us
 = 
	`˝u_to_À32
(
⁄
),

16 
iwl_ho°_cmd
 
cmd
 = {

17 .
id
 = 
	`WIDE_ID
(
LONG_GROUP
, 
LEDS_CMD
),

18 .
Àn
 = { (
Àd_cmd
), },

19 .
d©a
 = { &
Àd_cmd
, },

20 .
Êags
 = 
CMD_ASYNC
,

22 
îr
;

24 i‡(!
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
))

27 
îr
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
cmd
);

29 i‡(
îr
)

30 
	`IWL_WARN
(
mvm
, "LED comm™d faûed: %d\n", 
îr
);

31 
	}
}

33 
	$iwl_mvm_Àd_£t
(
iwl_mvm
 *
mvm
, 
boﬁ
 
⁄
)

35 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

36 
IWL_UCODE_TLV_CAPA_LED_CMD_SUPPORT
)) {

37 
	`iwl_mvm_£nd_Àd_fw_cmd
(
mvm
, 
⁄
);

41 
	`iwl_wrôe32
(
mvm
->
å™s
, 
CSR_LED_REG
,

42 
⁄
 ? 
CSR_LED_REG_TURN_ON
 : 
CSR_LED_REG_TURN_OFF
);

43 
	}
}

45 
	$iwl_Àd_brighäess_£t
(
Àd_˛assdev
 *
Àd_cdev
,

46 
Àd_brighäess
 
brighäess
)

48 
iwl_mvm
 *
mvm
 = 
	`c⁄èöî_of
(
Àd_cdev
, iwl_mvm, 
Àd
);

50 
	`iwl_mvm_Àd_£t
(
mvm
, 
brighäess
 > 0);

51 
	}
}

53 
	$iwl_mvm_Àds_öô
(
iwl_mvm
 *
mvm
)

55 
mode
 = 
iwlwifi_mod_∑øms
.
Àd_mode
;

56 
ªt
;

58 
mode
) {

59 
IWL_LED_BLINK
:

60 
	`IWL_ERR
(
mvm
, "BlinkÜed modeÇot supported, used default\n");

61 
ÁŒthrough
;

62 
IWL_LED_DEFAULT
:

63 
IWL_LED_RF_STATE
:

64 
mode
 = 
IWL_LED_RF_STATE
;

66 
IWL_LED_DISABLE
:

67 
	`IWL_INFO
(
mvm
, "Led disabled\n");

70  -
EINVAL
;

73 
mvm
->
Àd
.
«me
 = 
	`ka•rötf
(
GFP_KERNEL
, "%s-led",

74 
	`wùhy_«me
(
mvm
->
hw
->
wùhy
));

75 i‡(!
mvm
->
Àd
.
«me
)

76  -
ENOMEM
;

78 
mvm
->
Àd
.
brighäess_£t
 = 
iwl_Àd_brighäess_£t
;

79 
mvm
->
Àd
.
max_brighäess
 = 1;

81 i‡(
mode
 =
IWL_LED_RF_STATE
)

82 
mvm
->
Àd
.
deÁu…_åiggî
 =

83 
	`õì80211_gë_ødio_Àd_«me
(
mvm
->
hw
);

85 
ªt
 = 
	`Àd_˛assdev_ªgi°î
(
mvm
->
å™s
->
dev
, &mvm->
Àd
);

86 i‡(
ªt
) {

87 
	`k‰ì
(
mvm
->
Àd
.
«me
);

88 
	`IWL_INFO
(
mvm
, "FailedÅoÉnableÜed\n");

89  
ªt
;

92 
mvm
->
öô_°©us
 |
IWL_MVM_INIT_STATUS_LEDS_INIT_COMPLETE
;

94 
	}
}

96 
	$iwl_mvm_Àds_sync
(
iwl_mvm
 *
mvm
)

98 i‡(!(
mvm
->
öô_°©us
 & 
IWL_MVM_INIT_STATUS_LEDS_INIT_COMPLETE
))

105 i‡(
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 < 
IWL_DEVICE_FAMILY_8000
)

108 
	`iwl_mvm_Àd_£t
(
mvm
, mvm->
Àd
.
brighäess
 > 0);

109 
	}
}

111 
	$iwl_mvm_Àds_exô
(
iwl_mvm
 *
mvm
)

113 i‡(!(
mvm
->
öô_°©us
 & 
IWL_MVM_INIT_STATUS_LEDS_INIT_COMPLETE
))

116 
	`Àd_˛assdev_uƒegi°î
(&
mvm
->
Àd
);

117 
	`k‰ì
(
mvm
->
Àd
.
«me
);

118 
mvm
->
öô_°©us
 &~
IWL_MVM_INIT_STATUS_LEDS_INIT_COMPLETE
;

119 
	}
}

	@link.c

5 
	~"mvm.h
"

6 
	~"time-evít.h
"

8 
u32
 
	$iwl_mvm_gë_‰ì_fw_lök_id
(
iwl_mvm
 *
mvm
,

9 
iwl_mvm_vif
 *
mvm_vif
)

11 
u32
 
lök_id
;

13 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

15 
lök_id
 = 
	`ffz
(
mvm
->
fw_lök_ids_m≠
);

18 i‡(
lök_id
 > 
IWL_MVM_FW_MAX_LINK_ID
)

19  
IWL_MVM_FW_LINK_ID_INVALID
;

21 
mvm
->
fw_lök_ids_m≠
 |
	`BIT
(
lök_id
);

22  
lök_id
;

23 
	}
}

25 
	$iwl_mvm_ªÀa£_fw_lök_id
(
iwl_mvm
 *
mvm
, 
u32
 
lök_id
)

27 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

29 i‡(!
	`WARN_ON
(
lök_id
 > 
IWL_MVM_FW_MAX_LINK_ID
))

30 
mvm
->
fw_lök_ids_m≠
 &~
	`BIT
(
lök_id
);

31 
	}
}

33 
	$iwl_mvm_lök_cmd_£nd
(
iwl_mvm
 *
mvm
,

34 
iwl_lök_c⁄fig_cmd
 *
cmd
,

35 
iwl_˘xt_a˘i⁄
 
a˘i⁄
)

37 
ªt
;

39 
cmd
->
a˘i⁄
 = 
	`˝u_to_À32
(action);

40 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
,

41 
	`WIDE_ID
(
MAC_CONF_GROUP
, 
LINK_CONFIG_CMD
), 0,

42 (*
cmd
), cmd);

43 i‡(
ªt
)

44 
	`IWL_ERR
(
mvm
, "FailedÅo send LINK_CONFIG_CMD (action:%d): %d\n",

45 
a˘i⁄
, 
ªt
);

46  
ªt
;

47 
	}
}

49 
	$iwl_mvm_£t_lök_m≠pög
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

50 
õì80211_bss_c⁄f
 *
lök_c⁄f
)

52 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

53 
iwl_mvm_vif_lök_öfo
 *
lök_öfo
 =

54 
mvmvif
->
lök
[
lök_c⁄f
->
lök_id
];

56 i‡(
lök_öfo
->
fw_lök_id
 =
IWL_MVM_FW_LINK_ID_INVALID
) {

57 
lök_öfo
->
fw_lök_id
 = 
	`iwl_mvm_gë_‰ì_fw_lök_id
(
mvm
,

58 
mvmvif
);

59 i‡(
lök_öfo
->
fw_lök_id
 >=

60 
	`ARRAY_SIZE
(
mvm
->
lök_id_to_lök_c⁄f
))

61  -
EINVAL
;

63 
	`rcu_assign_poöãr
(
mvm
->
lök_id_to_lök_c⁄f
[
lök_öfo
->
fw_lök_id
],

64 
lök_c⁄f
);

68 
	}
}

70 
	$iwl_mvm_add_lök
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

71 
õì80211_bss_c⁄f
 *
lök_c⁄f
)

73 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

74 
lök_id
 = 
lök_c⁄f
->link_id;

75 
iwl_mvm_vif_lök_öfo
 *
lök_öfo
 = 
mvmvif
->
lök
[
lök_id
];

76 
iwl_lök_c⁄fig_cmd
 
cmd
 = {};

77 
cmd_id
 = 
	`WIDE_ID
(
MAC_CONF_GROUP
, 
LINK_CONFIG_CMD
);

78 
u8
 
cmd_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
cmd_id
, 1);

79 
ªt
;

81 i‡(
	`WARN_ON_ONCE
(!
lök_öfo
))

82  -
EINVAL
;

84 
ªt
 = 
	`iwl_mvm_£t_lök_m≠pög
(
mvm
, 
vif
, 
lök_c⁄f
);

85 i‡(
ªt
)

86  
ªt
;

91 i‡(
	`iwl_mvm_sf_upd©e
(
mvm
, 
vif
, 
Ál£
))

92  -
EINVAL
;

94 
cmd
.
lök_id
 = 
	`˝u_to_À32
(
lök_öfo
->
fw_lök_id
);

95 
cmd
.
mac_id
 = 
	`˝u_to_À32
(
mvmvif
->
id
);

96 
cmd
.
•ec_lök_id
 = 
lök_c⁄f
->
lök_id
;

97 
	`WARN_ON_ONCE
(
lök_öfo
->
phy_˘xt
);

98 
cmd
.
phy_id
 = 
	`˝u_to_À32
(
FW_CTXT_INVALID
);

100 
	`mem˝y
(
cmd
.
loˇl_lök_addr
, 
lök_c⁄f
->
addr
, 
ETH_ALEN
);

102 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_ADHOC
 && 
lök_c⁄f
->
bssid
)

103 
	`mem˝y
(
cmd
.
ibss_bssid_addr
, 
lök_c⁄f
->
bssid
, 
ETH_ALEN
);

105 i‡(
cmd_vî
 < 2)

106 
cmd
.
li°í_lmac
 = 
	`˝u_to_À32
(
lök_öfo
->listen_lmac);

108  
	`iwl_mvm_lök_cmd_£nd
(
mvm
, &
cmd
, 
FW_CTXT_ACTION_ADD
);

109 
	}
}

111 
	$iwl_mvm_lök_ch™ged
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

112 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

113 
u32
 
ch™ges
, 
boﬁ
 
a˘ive
)

115 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

116 
lök_id
 = 
lök_c⁄f
->link_id;

117 
iwl_mvm_vif_lök_öfo
 *
lök_öfo
 = 
mvmvif
->
lök
[
lök_id
];

118 
iwl_mvm_phy_˘xt
 *
phy˘xt
;

119 
iwl_lök_c⁄fig_cmd
 
cmd
 = {};

120 
u32
 
ht_Êag
, 
Êags
 = 0, 
Êags_mask
 = 0;

121 
ªt
;

122 
cmd_id
 = 
	`WIDE_ID
(
MAC_CONF_GROUP
, 
LINK_CONFIG_CMD
);

123 
u8
 
cmd_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
cmd_id
, 1);

125 i‡(
	`WARN_ON_ONCE
(!
lök_öfo
 ||

126 
lök_öfo
->
fw_lök_id
 =
IWL_MVM_FW_LINK_ID_INVALID
))

127  -
EINVAL
;

129 i‡(
ch™ges
 & 
LINK_CONTEXT_MODIFY_ACTIVE
) {

136 i‡(!
lök_öfo
->
phy_˘xt
)

142 
	`WARN_ON_ONCE
(
a˘ive
 =
lök_öfo
->active);

147 i‡(!
a˘ive
 && 
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
)

148 
	`iwl_mvm_°›_£ssi⁄_¥Ÿe˘i⁄
(
mvm
, 
vif
);

151 
cmd
.
lök_id
 = 
	`˝u_to_À32
(
lök_öfo
->
fw_lök_id
);

156 
phy˘xt
 = 
lök_öfo
->
phy_˘xt
;

157 i‡(
phy˘xt
)

158 
cmd
.
phy_id
 = 
	`˝u_to_À32
(
phy˘xt
->
id
);

160 
cmd
.
phy_id
 = 
	`˝u_to_À32
(
FW_CTXT_INVALID
);

161 
cmd
.
mac_id
 = 
	`˝u_to_À32
(
mvmvif
->
id
);

163 
	`mem˝y
(
cmd
.
loˇl_lök_addr
, 
lök_c⁄f
->
addr
, 
ETH_ALEN
);

165 
cmd
.
a˘ive
 = 
	`˝u_to_À32
(active);

167 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_ADHOC
 && 
lök_c⁄f
->
bssid
)

168 
	`mem˝y
(
cmd
.
ibss_bssid_addr
, 
lök_c⁄f
->
bssid
, 
ETH_ALEN
);

170 
	`iwl_mvm_£t_fw_basic_øãs
(
mvm
, 
vif
, 
lök_c⁄f
,

171 &
cmd
.
cck_øãs
, &cmd.
ofdm_øãs
);

173 
cmd
.
cck_sh‹t_¥ómbÀ
 = 
	`˝u_to_À32
(
lök_c⁄f
->
u£_sh‹t_¥ómbÀ
);

174 
cmd
.
sh‹t_¶Ÿ
 = 
	`˝u_to_À32
(
lök_c⁄f
->
u£_sh‹t_¶Ÿ
);

177 
ht_Êag
 = 
LINK_PROT_FLG_HT_PROT
 | 
LINK_PROT_FLG_FAT_PROT
;

178 
	`iwl_mvm_£t_fw_¥Ÿe˘i⁄_Êags
(
mvm
, 
vif
, 
lök_c⁄f
,

179 &
cmd
.
¥Ÿe˘i⁄_Êags
,

180 
ht_Êag
, 
LINK_PROT_FLG_TGG_PROTECT
);

182 
	`iwl_mvm_£t_fw_qos_∑øms
(
mvm
, 
vif
, 
lök_c⁄f
, 
cmd
.
ac
,

183 &
cmd
.
qos_Êags
);

186 
cmd
.
bi
 = 
	`˝u_to_À32
(
lök_c⁄f
->
bóc⁄_öt
);

187 
cmd
.
dtim_öãrvÆ
 = 
	`˝u_to_À32
(
lök_c⁄f
->
bóc⁄_öt
 *

188 
lök_c⁄f
->
dtim_≥riod
);

190 i‡(!
lök_c⁄f
->
he_suµ‹t
 || 
iwlwifi_mod_∑øms
.
dißbÀ_11ax
 ||

191 (
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
 && !vif->
cfg
.
assoc
)) {

192 
ch™ges
 &~
LINK_CONTEXT_MODIFY_HE_PARAMS
;

193 
£nd_cmd
;

196 
cmd
.
htc_åig_ba£d_pkt_ext
 = 
lök_c⁄f
->htc_trig_based_pkt_ext;

198 i‡(
lök_c⁄f
->
u‹a_exi°s
) {

199 
cmd
.
ønd_Æloc_ecwmö
 =

200 
lök_c⁄f
->
u‹a_ocw_ønge
 & 0x7;

201 
cmd
.
ønd_Æloc_ecwmax
 =

202 (
lök_c⁄f
->
u‹a_ocw_ønge
 >> 3) & 0x7;

207 i‡(
	`iwl_mvm_£t_fw_mu_edˇ_∑øms
(
mvm
, 
mvmvif
->
lök
[
lök_id
],

208 &
cmd
.
åig_ba£d_txf
[0])) {

209 
Êags
 |
LINK_FLG_MU_EDCA_CW
;

210 
Êags_mask
 |
LINK_FLG_MU_EDCA_CW
;

213 i‡(
ch™ges
 & 
LINK_CONTEXT_MODIFY_EHT_PARAMS
) {

214 
õì80211_ch™˘x_c⁄f
 *
˘x
;

215 
cfg80211_ch™_def
 *
def
 = 
NULL
;

217 
	`rcu_ªad_lock
();

218 
˘x
 = 
	`rcu_dîe„ªn˚
(
lök_c⁄f
->
ch™˘x_c⁄f
);

219 i‡(
˘x
)

220 
def
 = 
	`iwl_mvm_ch™˘x_def
(
mvm
, 
˘x
);

222 i‡(
iwlwifi_mod_∑øms
.
dißbÀ_11be
 ||

223 !
lök_c⁄f
->
eht_suµ‹t
 || !
def
 ||

224 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
PHY_CONTEXT_CMD
, 1) >= 6)

225 
ch™ges
 &~
LINK_CONTEXT_MODIFY_EHT_PARAMS
;

227 
cmd
.
pun˘uª_mask
 = 
	`˝u_to_À16
(
def
->
pun˘uªd
);

228 
	`rcu_ªad_u∆ock
();

231 
cmd
.
bss_cﬁ‹
 = 
lök_c⁄f
->
he_bss_cﬁ‹
.
cﬁ‹
;

233 i‡(!
lök_c⁄f
->
he_bss_cﬁ‹
.
íabÀd
) {

234 
Êags
 |
LINK_FLG_BSS_COLOR_DIS
;

235 
Êags_mask
 |
LINK_FLG_BSS_COLOR_DIS
;

238 
cmd
.
‰ame_time_πs_th
 = 
	`˝u_to_À16
(
lök_c⁄f
->frame_time_rts_th);

241 i‡(
lök_öfo
->
he_ru_2mhz_block
) {

242 
Êags
 |
LINK_FLG_RU_2MHZ_BLOCK
;

243 
Êags_mask
 |
LINK_FLG_RU_2MHZ_BLOCK
;

246 i‡(
lök_c⁄f
->
n⁄å™smôãd
) {

247 
	`ëhî_addr_c›y
(
cmd
.
ªf_bssid_addr
,

248 
lök_c⁄f
->
å™smôãr_bssid
);

249 
cmd
.
bssid_ödex
 = 
lök_c⁄f
->bssid_index;

252 
£nd_cmd
:

253 
cmd
.
modify_mask
 = 
	`˝u_to_À32
(
ch™ges
);

254 
cmd
.
Êags
 = 
	`˝u_to_À32
(flags);

255 
cmd
.
Êags_mask
 = 
	`˝u_to_À32
(flags_mask);

256 
cmd
.
•ec_lök_id
 = 
lök_c⁄f
->
lök_id
;

257 i‡(
cmd_vî
 < 2)

258 
cmd
.
li°í_lmac
 = 
	`˝u_to_À32
(
lök_öfo
->listen_lmac);

260 
ªt
 = 
	`iwl_mvm_lök_cmd_£nd
(
mvm
, &
cmd
, 
FW_CTXT_ACTION_MODIFY
);

261 i‡(!
ªt
 && (
ch™ges
 & 
LINK_CONTEXT_MODIFY_ACTIVE
))

262 
lök_öfo
->
a˘ive
 =áctive;

264  
ªt
;

265 
	}
}

267 
	$iwl_mvm_un£t_lök_m≠pög
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

268 
õì80211_bss_c⁄f
 *
lök_c⁄f
)

270 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

271 
iwl_mvm_vif_lök_öfo
 *
lök_öfo
 =

272 
mvmvif
->
lök
[
lök_c⁄f
->
lök_id
];

275 i‡(
	`WARN_ON
(!
lök_öfo
 ||

276 
lök_öfo
->
fw_lök_id
 >=

277 
	`ARRAY_SIZE
(
mvm
->
lök_id_to_lök_c⁄f
)))

278  -
EINVAL
;

280 
	`RCU_INIT_POINTER
(
mvm
->
lök_id_to_lök_c⁄f
[
lök_öfo
->
fw_lök_id
],

281 
NULL
);

282 
	`iwl_mvm_ªÀa£_fw_lök_id
(
mvm
, 
lök_öfo
->
fw_lök_id
);

284 
	}
}

286 
	$iwl_mvm_ªmove_lök
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

287 
õì80211_bss_c⁄f
 *
lök_c⁄f
)

289 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

290 
lök_id
 = 
lök_c⁄f
->link_id;

291 
iwl_mvm_vif_lök_öfo
 *
lök_öfo
 = 
mvmvif
->
lök
[
lök_id
];

292 
iwl_lök_c⁄fig_cmd
 
cmd
 = {};

293 
ªt
;

295 
ªt
 = 
	`iwl_mvm_un£t_lök_m≠pög
(
mvm
, 
vif
, 
lök_c⁄f
);

296 i‡(
ªt
)

299 
cmd
.
lök_id
 = 
	`˝u_to_À32
(
lök_öfo
->
fw_lök_id
);

300 
lök_öfo
->
fw_lök_id
 = 
IWL_MVM_FW_LINK_ID_INVALID
;

301 
cmd
.
•ec_lök_id
 = 
lök_c⁄f
->
lök_id
;

302 
cmd
.
phy_id
 = 
	`˝u_to_À32
(
FW_CTXT_INVALID
);

304 
ªt
 = 
	`iwl_mvm_lök_cmd_£nd
(
mvm
, &
cmd
, 
FW_CTXT_ACTION_REMOVE
);

306 i‡(!
ªt
)

307 i‡(
	`iwl_mvm_sf_upd©e
(
mvm
, 
vif
, 
åue
))

308 
	`IWL_ERR
(
mvm
, "FailedÅo update SF state\n");

310  
ªt
;

311 
	}
}

316 
	$iwl_mvm_dißbÀ_lök
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

317 
õì80211_bss_c⁄f
 *
lök_c⁄f
)

319 
ªt
;

321 
ªt
 = 
	`iwl_mvm_lök_ch™ged
(
mvm
, 
vif
, 
lök_c⁄f
,

322 
LINK_CONTEXT_MODIFY_ACTIVE
, 
Ál£
);

323 i‡(
ªt
)

324  
ªt
;

326 
ªt
 = 
	`iwl_mvm_ªmove_lök
(
mvm
, 
vif
, 
lök_c⁄f
);

327 i‡(
ªt
)

328  
ªt
;

330  
ªt
;

331 
	}
}

	@mac-ctxt.c

7 
	~<löux/ëhîdevi˚.h
>

8 
	~<löux/¸c32.h
>

9 
	~<√t/mac80211.h
>

10 
	~"iwl-io.h
"

11 
	~"iwl-¥ph.h
"

12 
	~"fw-≠i.h
"

13 
	~"mvm.h
"

14 
	~"time-evít.h
"

16 c⁄° 
u8
 
	giwl_mvm_ac_to_tx_fifo
[] = {

17 
IWL_MVM_TX_FIFO_VO
,

18 
IWL_MVM_TX_FIFO_VI
,

19 
IWL_MVM_TX_FIFO_BE
,

20 
IWL_MVM_TX_FIFO_BK
,

23 c⁄° 
u8
 
	giwl_mvm_ac_to_gí2_tx_fifo
[] = {

24 
IWL_GEN2_EDCA_TX_FIFO_VO
,

25 
IWL_GEN2_EDCA_TX_FIFO_VI
,

26 
IWL_GEN2_EDCA_TX_FIFO_BE
,

27 
IWL_GEN2_EDCA_TX_FIFO_BK
,

28 
IWL_GEN2_TRIG_TX_FIFO_VO
,

29 
IWL_GEN2_TRIG_TX_FIFO_VI
,

30 
IWL_GEN2_TRIG_TX_FIFO_BE
,

31 
IWL_GEN2_TRIG_TX_FIFO_BK
,

34 c⁄° 
u8
 
	giwl_mvm_ac_to_bz_tx_fifo
[] = {

35 
IWL_BZ_EDCA_TX_FIFO_VO
,

36 
IWL_BZ_EDCA_TX_FIFO_VI
,

37 
IWL_BZ_EDCA_TX_FIFO_BE
,

38 
IWL_BZ_EDCA_TX_FIFO_BK
,

39 
IWL_BZ_TRIG_TX_FIFO_VO
,

40 
IWL_BZ_TRIG_TX_FIFO_VI
,

41 
IWL_BZ_TRIG_TX_FIFO_BE
,

42 
IWL_BZ_TRIG_TX_FIFO_BK
,

45 
	siwl_mvm_mac_iÁ˚_ôî©‹_d©a
 {

46 
iwl_mvm
 *
	mmvm
;

47 
õì80211_vif
 *
	mvif
;

48 
	mavaûabÀ_mac_ids
[
BITS_TO_LONGS
(
NUM_MAC_INDEX_DRIVER
)];

49 
	mavaûabÀ_tsf_ids
[
BITS_TO_LONGS
(
NUM_TSF_IDS
)];

50 
iwl_tsf_id
 
	m¥e„ºed_tsf
;

51 
boﬁ
 
	mfound_vif
;

54 
	$iwl_mvm_mac_tsf_id_ôî
(*
_d©a
, 
u8
 *
mac
,

55 
õì80211_vif
 *
vif
)

57 
iwl_mvm_mac_iÁ˚_ôî©‹_d©a
 *
d©a
 = 
_d©a
;

58 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

59 
u16
 
mö_bi
;

62 i‡(
vif
 =
d©a
->vif)

81 
d©a
->
vif
->
ty≥
) {

82 
NL80211_IFTYPE_STATION
:

91 i‡(
vif
->
ty≥
 !
NL80211_IFTYPE_AP
 ||

92 
d©a
->
¥e„ºed_tsf
 !
NUM_TSF_IDS
 ||

93 !
	`ã°_bô
(
mvmvif
->
tsf_id
, 
d©a
->
avaûabÀ_tsf_ids
))

96 
mö_bi
 = 
	`mö
(
d©a
->
vif
->
bss_c⁄f
.
bóc⁄_öt
,

97 
vif
->
bss_c⁄f
.
bóc⁄_öt
);

99 i‡(!
mö_bi
)

102 i‡((
d©a
->
vif
->
bss_c⁄f
.
bóc⁄_öt
 -

103 
vif
->
bss_c⁄f
.
bóc⁄_öt
Ë% 
mö_bi
 == 0) {

104 
d©a
->
¥e„ºed_tsf
 = 
mvmvif
->
tsf_id
;

109 
NL80211_IFTYPE_AP
:

119 i‡((
vif
->
ty≥
 !
NL80211_IFTYPE_AP
 &&

120 
vif
->
ty≥
 !
NL80211_IFTYPE_STATION
) ||

121 
d©a
->
¥e„ºed_tsf
 !
NUM_TSF_IDS
 ||

122 !
	`ã°_bô
(
mvmvif
->
tsf_id
, 
d©a
->
avaûabÀ_tsf_ids
))

125 
mö_bi
 = 
	`mö
(
d©a
->
vif
->
bss_c⁄f
.
bóc⁄_öt
,

126 
vif
->
bss_c⁄f
.
bóc⁄_öt
);

128 i‡(!
mö_bi
)

131 i‡((
d©a
->
vif
->
bss_c⁄f
.
bóc⁄_öt
 -

132 
vif
->
bss_c⁄f
.
bóc⁄_öt
Ë% 
mö_bi
 == 0) {

133 
d©a
->
¥e„ºed_tsf
 = 
mvmvif
->
tsf_id
;

154 
	`__˛ór_bô
(
mvmvif
->
tsf_id
, 
d©a
->
avaûabÀ_tsf_ids
);

156 i‡(
d©a
->
¥e„ºed_tsf
 =
mvmvif
->
tsf_id
)

157 
d©a
->
¥e„ºed_tsf
 = 
NUM_TSF_IDS
;

158 
	}
}

160 
	$iwl_mvm_mac_iÁ˚_ôî©‹
(*
_d©a
, 
u8
 *
mac
,

161 
õì80211_vif
 *
vif
)

163 
iwl_mvm_mac_iÁ˚_ôî©‹_d©a
 *
d©a
 = 
_d©a
;

164 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

167 i‡(
vif
 =
d©a
->vif) {

168 
d©a
->
found_vif
 = 
åue
;

178 
	`__˛ór_bô
(
mvmvif
->
id
, 
d©a
->
avaûabÀ_mac_ids
);

181 
	`iwl_mvm_mac_tsf_id_ôî
(
_d©a
, 
mac
, 
vif
);

182 
	}
}

184 
	$iwl_mvm_mac_˘xt_ªˇlc_tsf_id
(
iwl_mvm
 *
mvm
,

185 
õì80211_vif
 *
vif
)

187 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

188 
iwl_mvm_mac_iÁ˚_ôî©‹_d©a
 
d©a
 = {

189 .
mvm
 = mvm,

190 .
vif
 = vif,

191 .
avaûabÀ_tsf_ids
 = { (1 << 
NUM_TSF_IDS
) - 1 },

193 .
¥e„ºed_tsf
 = 
NUM_TSF_IDS
,

196 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s_©omic
(

197 
mvm
->
hw
, 
IEEE80211_IFACE_ITER_RESUME_ALL
,

198 
iwl_mvm_mac_tsf_id_ôî
, &
d©a
);

200 i‡(
d©a
.
¥e„ºed_tsf
 !
NUM_TSF_IDS
)

201 
mvmvif
->
tsf_id
 = 
d©a
.
¥e„ºed_tsf
;

202 i‡(!
	`ã°_bô
(
mvmvif
->
tsf_id
, 
d©a
.
avaûabÀ_tsf_ids
))

203 
mvmvif
->
tsf_id
 = 
	`föd_fú°_bô
(
d©a
.
avaûabÀ_tsf_ids
,

204 
NUM_TSF_IDS
);

205 
	}
}

207 
	$iwl_mvm_mac_˘xt_öô
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

209 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

210 
iwl_mvm_mac_iÁ˚_ôî©‹_d©a
 
d©a
 = {

211 .
mvm
 = mvm,

212 .
vif
 = vif,

213 .
avaûabÀ_mac_ids
 = { (1 << 
NUM_MAC_INDEX_DRIVER
) - 1 },

214 .
avaûabÀ_tsf_ids
 = { (1 << 
NUM_TSF_IDS
) - 1 },

216 .
¥e„ºed_tsf
 = 
NUM_TSF_IDS
,

217 .
found_vif
 = 
Ál£
,

219 
ªt
, 
i
;

221 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

242 i‡(!
mvm
->
mld_≠i_is_u£d
) {

243 
vif
->
ty≥
) {

244 
NL80211_IFTYPE_ADHOC
:

246 
NL80211_IFTYPE_STATION
:

247 i‡(!
vif
->
p2p
)

249 
ÁŒthrough
;

251 
	`__˛ór_bô
(0, 
d©a
.
avaûabÀ_mac_ids
);

255 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s_©omic
(

256 
mvm
->
hw
, 
IEEE80211_IFACE_ITER_RESUME_ALL
,

257 
iwl_mvm_mac_iÁ˚_ôî©‹
, &
d©a
);

269 i‡(
d©a
.
found_vif
)

273 i‡(
	`WARN_ON_ONCE
(
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
)))

274  -
EBUSY
;

276 
mvmvif
->
id
 = 
	`föd_fú°_bô
(
d©a
.
avaûabÀ_mac_ids
,

277 
NUM_MAC_INDEX_DRIVER
);

278 i‡(
mvmvif
->
id
 =
NUM_MAC_INDEX_DRIVER
) {

279 
	`IWL_ERR
(
mvm
, "FailedÅo init MAC context -Ço free ID!\n");

280 
ªt
 = -
EIO
;

281 
exô_Áû
;

284 i‡(
d©a
.
¥e„ºed_tsf
 !
NUM_TSF_IDS
)

285 
mvmvif
->
tsf_id
 = 
d©a
.
¥e„ºed_tsf
;

287 
mvmvif
->
tsf_id
 = 
	`föd_fú°_bô
(
d©a
.
avaûabÀ_tsf_ids
,

288 
NUM_TSF_IDS
);

289 i‡(
mvmvif
->
tsf_id
 =
NUM_TSF_IDS
) {

290 
	`IWL_ERR
(
mvm
, "FailedÅo init MAC context -Ço free TSF!\n");

291 
ªt
 = -
EIO
;

292 
exô_Áû
;

295 
mvmvif
->
cﬁ‹
 = 0;

297 
	`INIT_LIST_HEAD
(&
mvmvif
->
time_evít_d©a
.
li°
);

298 
mvmvif
->
time_evít_d©a
.
id
 = 
TE_MAX
;

300 
mvmvif
->
deÊök
.
bˇ°_°a
.
°a_id
 = 
IWL_MVM_INVALID_STA
;

301 
mvmvif
->
deÊök
.
mˇ°_°a
.
°a_id
 = 
IWL_MVM_INVALID_STA
;

302 
mvmvif
->
deÊök
.
≠_°a_id
 = 
IWL_MVM_INVALID_STA
;

305 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_P2P_DEVICE
)

309 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
 ||

310 
vif
->
ty≥
 =
NL80211_IFTYPE_ADHOC
) {

315 
mvmvif
->
deÊök
.
ˇb_queue
 = 
IWL_MVM_DQA_GCAST_QUEUE
;

318 
i
 = 0; i < 
NUM_IWL_MVM_SMPS_REQ
; i++)

319 
mvmvif
->
deÊök
.
smps_ªque°s
[
i
] = 
IEEE80211_SMPS_AUTOMATIC
;

323 
exô_Áû
:

324 
	`mem£t
(
mvmvif
, 0, (
iwl_mvm_vif
));

325  
ªt
;

326 
	}
}

328 
	$iwl_mvm_ack_øãs
(
iwl_mvm
 *
mvm
,

329 
õì80211_vif
 *
vif
,

330 
∆80211_b™d
 
b™d
,

331 
u8
 *
cck_øãs
, u8 *
ofdm_øãs
)

333 
õì80211_suµ‹ãd_b™d
 *
sb™d
;

334 
basic
 = 
vif
->
bss_c⁄f
.
basic_øãs
;

335 
lowe°_¥e£¡_ofdm
 = 100;

336 
lowe°_¥e£¡_cck
 = 100;

337 
u8
 
cck
 = 0;

338 
u8
 
ofdm
 = 0;

339 
i
;

341 
sb™d
 = 
mvm
->
hw
->
wùhy
->
b™ds
[
b™d
];

343 
	`f‹_óch_£t_bô
(
i
, &
basic
, 
BITS_PER_LONG
) {

344 
hw
 = 
sb™d
->
bôøãs
[
i
].
hw_vÆue
;

345 i‡(
hw
 >
IWL_FIRST_OFDM_RATE
) {

346 
ofdm
 |
	`BIT
(
hw
 - 
IWL_FIRST_OFDM_RATE
);

347 i‡(
lowe°_¥e£¡_ofdm
 > 
hw
)

348 
lowe°_¥e£¡_ofdm
 = 
hw
;

350 
	`BUILD_BUG_ON
(
IWL_FIRST_CCK_RATE
 != 0);

352 
cck
 |
	`BIT
(
hw
);

353 i‡(
lowe°_¥e£¡_cck
 > 
hw
)

354 
lowe°_¥e£¡_cck
 = 
hw
;

381 i‡(
IWL_RATE_24M_INDEX
 < 
lowe°_¥e£¡_ofdm
)

382 
ofdm
 |
	`IWL_RATE_BIT_MSK
(24Ë>> 
IWL_FIRST_OFDM_RATE
;

383 i‡(
IWL_RATE_12M_INDEX
 < 
lowe°_¥e£¡_ofdm
)

384 
ofdm
 |
	`IWL_RATE_BIT_MSK
(12Ë>> 
IWL_FIRST_OFDM_RATE
;

386 
ofdm
 |
	`IWL_RATE_BIT_MSK
(6Ë>> 
IWL_FIRST_OFDM_RATE
;

401 i‡(
IWL_RATE_11M_INDEX
 < 
lowe°_¥e£¡_cck
)

402 
cck
 |
	`IWL_RATE_BIT_MSK
(11Ë>> 
IWL_FIRST_CCK_RATE
;

403 i‡(
IWL_RATE_5M_INDEX
 < 
lowe°_¥e£¡_cck
)

404 
cck
 |
	`IWL_RATE_BIT_MSK
(5Ë>> 
IWL_FIRST_CCK_RATE
;

405 i‡(
IWL_RATE_2M_INDEX
 < 
lowe°_¥e£¡_cck
)

406 
cck
 |
	`IWL_RATE_BIT_MSK
(2Ë>> 
IWL_FIRST_CCK_RATE
;

408 
cck
 |
	`IWL_RATE_BIT_MSK
(1Ë>> 
IWL_FIRST_CCK_RATE
;

410 *
cck_øãs
 = 
cck
;

411 *
ofdm_øãs
 = 
ofdm
;

412 
	}
}

414 
	$iwl_mvm_£t_fw_basic_øãs
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

415 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

416 
__À32
 *
cck_øãs
, __À32 *
ofdm_øãs
)

418 
õì80211_ch™˘x_c⁄f
 *
ch™˘x
;

419 
u8
 
cck_ack_øãs
 = 0, 
ofdm_ack_øãs
 = 0;

421 
	`rcu_ªad_lock
();

422 
ch™˘x
 = 
	`rcu_dîe„ªn˚
(
lök_c⁄f
->
ch™˘x_c⁄f
);

423 
	`iwl_mvm_ack_øãs
(
mvm
, 
vif
, 
ch™˘x
 ? ch™˘x->
def
.
ch™
->
b™d


424 : 
NL80211_BAND_2GHZ
,

425 &
cck_ack_øãs
, &
ofdm_ack_øãs
);

427 
	`rcu_ªad_u∆ock
();

429 *
cck_øãs
 = 
	`˝u_to_À32
((
u32
)
cck_ack_øãs
);

430 *
ofdm_øãs
 = 
	`˝u_to_À32
((
u32
)
ofdm_ack_øãs
);

431 
	}
}

433 
	$iwl_mvm_£t_fw_¥Ÿe˘i⁄_Êags
(
iwl_mvm
 *
mvm
,

434 
õì80211_vif
 *
vif
,

435 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

436 
__À32
 *
¥Ÿe˘i⁄_Êags
, 
u32
 
ht_Êag
,

437 
u32
 
tgg_Êag
)

440 
u8
 
¥Ÿe˘i⁄_mode
 = 
lök_c⁄f
->
ht_›î©i⁄_mode
 &

441 
IEEE80211_HT_OP_MODE_PROTECTION
;

442 
boﬁ
 
ht_íabÀd
 = !!(
lök_c⁄f
->
ht_›î©i⁄_mode
 &

443 
IEEE80211_HT_OP_MODE_PROTECTION
);

445 i‡(
lök_c⁄f
->
u£_˘s_¥Ÿ
)

446 *
¥Ÿe˘i⁄_Êags
 |
	`˝u_to_À32
(
tgg_Êag
);

448 
	`IWL_DEBUG_RATE
(
mvm
, "use_cts_prot %d, ht_operation_mode %d\n",

449 
lök_c⁄f
->
u£_˘s_¥Ÿ
,

450 
lök_c⁄f
->
ht_›î©i⁄_mode
);

452 i‡(!
ht_íabÀd
)

455 
	`IWL_DEBUG_RATE
(
mvm
, "¥Ÿe˘i⁄ modê£àtÿ%d\n", 
¥Ÿe˘i⁄_mode
);

460 
¥Ÿe˘i⁄_mode
) {

461 
IEEE80211_HT_OP_MODE_PROTECTION_NONE
:

463 
IEEE80211_HT_OP_MODE_PROTECTION_NONMEMBER
:

464 
IEEE80211_HT_OP_MODE_PROTECTION_NONHT_MIXED
:

465 *
¥Ÿe˘i⁄_Êags
 |
	`˝u_to_À32
(
ht_Êag
);

467 
IEEE80211_HT_OP_MODE_PROTECTION_20MHZ
:

469 i‡(
lök_c⁄f
->
ch™ªq
.
›î
.
width
 > 
NL80211_CHAN_WIDTH_20
)

470 *
¥Ÿe˘i⁄_Êags
 |
	`˝u_to_À32
(
ht_Êag
);

473 
	`IWL_ERR
(
mvm
, "IllegalÖrotection mode %d\n",

474 
¥Ÿe˘i⁄_mode
);

477 
	}
}

479 
	$iwl_mvm_£t_fw_qos_∑øms
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

480 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

481 
iwl_ac_qos
 *
ac
, 
__À32
 *
qos_Êags
)

483 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

484 
iwl_mvm_vif_lök_öfo
 *
mvm_lök
 =

485 
mvmvif
->
lök
[
lök_c⁄f
->
lök_id
];

486 
i
;

488 i‡(!
mvm_lök
)

491 
i
 = 0; i < 
IEEE80211_NUM_ACS
; i++) {

492 
u8
 
txf
 = 
	`iwl_mvm_mac_ac_to_tx_fifo
(
mvm
, 
i
);

493 
u8
 
ucode_ac
 = 
	`iwl_mvm_mac80211_ac_to_ucode_ac
(
i
);

495 
ac
[
ucode_ac
].
cw_mö
 =

496 
	`˝u_to_À16
(
mvm_lök
->
queue_∑øms
[
i
].
cw_mö
);

497 
ac
[
ucode_ac
].
cw_max
 =

498 
	`˝u_to_À16
(
mvm_lök
->
queue_∑øms
[
i
].
cw_max
);

499 
ac
[
ucode_ac
].
edˇ_tx›
 =

500 
	`˝u_to_À16
(
mvm_lök
->
queue_∑øms
[
i
].
tx›
 * 32);

501 
ac
[
ucode_ac
].
aif¢
 = 
mvm_lök
->
queue_∑øms
[
i
].
aifs
;

502 
ac
[
ucode_ac
].
fifos_mask
 = 
	`BIT
(
txf
);

505 i‡(
lök_c⁄f
->
qos
)

506 *
qos_Êags
 |
	`˝u_to_À32
(
MAC_QOS_FLG_UPDATE_EDCA
);

508 i‡(
lök_c⁄f
->
ch™ªq
.
›î
.
width
 !
NL80211_CHAN_WIDTH_20_NOHT
)

509 *
qos_Êags
 |
	`˝u_to_À32
(
MAC_QOS_FLG_TGN
);

510 
	}
}

512 
	$iwl_mvm_gë_mac_ty≥
(
õì80211_vif
 *
vif
)

514 
u32
 
mac_ty≥
 = 
FW_MAC_TYPE_BSS_STA
;

516 
vif
->
ty≥
) {

517 
NL80211_IFTYPE_STATION
:

518 i‡(
vif
->
p2p
)

519 
mac_ty≥
 = 
FW_MAC_TYPE_P2P_STA
;

521 
mac_ty≥
 = 
FW_MAC_TYPE_BSS_STA
;

523 
NL80211_IFTYPE_AP
:

524 
mac_ty≥
 = 
FW_MAC_TYPE_GO
;

526 
NL80211_IFTYPE_MONITOR
:

527 
mac_ty≥
 = 
FW_MAC_TYPE_LISTENER
;

529 
NL80211_IFTYPE_P2P_DEVICE
:

530 
mac_ty≥
 = 
FW_MAC_TYPE_P2P_DEVICE
;

532 
NL80211_IFTYPE_ADHOC
:

533 
mac_ty≥
 = 
FW_MAC_TYPE_IBSS
;

536 
	`WARN_ON_ONCE
(1);

538  
mac_ty≥
;

539 
	}
}

541 
	$iwl_mvm_mac_˘xt_cmd_comm⁄
(
iwl_mvm
 *
mvm
,

542 
õì80211_vif
 *
vif
,

543 
iwl_mac_˘x_cmd
 *
cmd
,

544 c⁄° 
u8
 *
bssid_ovîride
,

545 
u32
 
a˘i⁄
)

547 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

548 c⁄° 
u8
 *
bssid
 = 
bssid_ovîride
 ?: 
vif
->
bss_c⁄f
.bssid;

549 
u32
 
ht_Êag
;

551 
cmd
->
id_™d_cﬁ‹
 = 
	`˝u_to_À32
(
	`FW_CMD_ID_AND_COLOR
(
mvmvif
->
id
,

552 
mvmvif
->
cﬁ‹
));

553 
cmd
->
a˘i⁄
 = 
	`˝u_to_À32
(action);

554 
cmd
->
mac_ty≥
 = 
	`˝u_to_À32
(
	`iwl_mvm_gë_mac_ty≥
(
vif
));

556 
cmd
->
tsf_id
 = 
	`˝u_to_À32
(
mvmvif
->tsf_id);

558 
	`mem˝y
(
cmd
->
node_addr
, 
vif
->
addr
, 
ETH_ALEN
);

560 i‡(
bssid
)

561 
	`mem˝y
(
cmd
->
bssid_addr
, 
bssid
, 
ETH_ALEN
);

563 
	`ëh_brﬂdˇ°_addr
(
cmd
->
bssid_addr
);

565 
	`iwl_mvm_£t_fw_basic_øãs
(
mvm
, 
vif
, &vif->
bss_c⁄f
, &
cmd
->
cck_øãs
,

566 &
cmd
->
ofdm_øãs
);

568 
cmd
->
cck_sh‹t_¥ómbÀ
 =

569 
	`˝u_to_À32
(
vif
->
bss_c⁄f
.
u£_sh‹t_¥ómbÀ
 ?

570 
MAC_FLG_SHORT_PREAMBLE
 : 0);

571 
cmd
->
sh‹t_¶Ÿ
 =

572 
	`˝u_to_À32
(
vif
->
bss_c⁄f
.
u£_sh‹t_¶Ÿ
 ?

573 
MAC_FLG_SHORT_SLOT
 : 0);

575 
cmd
->
fûãr_Êags
 = 0;

577 
	`iwl_mvm_£t_fw_qos_∑øms
(
mvm
, 
vif
, &vif->
bss_c⁄f
, 
cmd
->
ac
,

578 &
cmd
->
qos_Êags
);

581 
ht_Êag
 = 
MAC_PROT_FLG_HT_PROT
 | 
MAC_PROT_FLG_FAT_PROT
;

582 
	`iwl_mvm_£t_fw_¥Ÿe˘i⁄_Êags
(
mvm
, 
vif
, &vif->
bss_c⁄f
,

583 &
cmd
->
¥Ÿe˘i⁄_Êags
,

584 
ht_Êag
, 
MAC_PROT_FLG_TGG_PROTECT
);

585 
	}
}

587 
	$iwl_mvm_mac_˘xt_£nd_cmd
(
iwl_mvm
 *
mvm
,

588 
iwl_mac_˘x_cmd
 *
cmd
)

590 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
MAC_CONTEXT_CMD
, 0,

591 (*
cmd
), cmd);

592 i‡(
ªt
)

593 
	`IWL_ERR
(
mvm
, "FailedÅo send MAC_CONTEXT_CMD (action:%d): %d\n",

594 
	`À32_to_˝u
(
cmd
->
a˘i⁄
), 
ªt
);

595  
ªt
;

596 
	}
}

598 
	$iwl_mvm_£t_fw_dtim_tbâ
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

599 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

600 
__À64
 *
dtim_tsf
, 
__À32
 *
dtim_time
,

601 
__À32
 *
assoc_bóc⁄_¨rive_time
)

603 
u32
 
dtim_offs
;

620 
dtim_offs
 = 
lök_c⁄f
->
sync_dtim_cou¡
 *

621 
lök_c⁄f
->
bóc⁄_öt
;

623 
dtim_offs
 *= 1024;

625 *
dtim_tsf
 =

626 
	`˝u_to_À64
(
lök_c⁄f
->
sync_tsf
 + 
dtim_offs
);

627 *
dtim_time
 =

628 
	`˝u_to_À32
(
lök_c⁄f
->
sync_devi˚_ts
 + 
dtim_offs
);

629 *
assoc_bóc⁄_¨rive_time
 =

630 
	`˝u_to_À32
(
lök_c⁄f
->
sync_devi˚_ts
);

632 
	`IWL_DEBUG_INFO
(
mvm
, "DTIM TBTT is 0x%llx/0x%x, offset %d\n",

633 
	`À64_to_˝u
(*
dtim_tsf
),

634 
	`À32_to_˝u
(*
dtim_time
),

635 
dtim_offs
);

636 
	}
}

638 
__À32
 
	$iwl_mvm_mac_˘xt_cmd_p2p_°a_gë_›µs_˘wö
(
iwl_mvm
 *
mvm
,

639 
õì80211_vif
 *
vif
)

641 
õì80211_p2p_nﬂ_©å
 *
nﬂ
 =

642 &
vif
->
bss_c⁄f
.
p2p_nﬂ_©å
;

644  
	`˝u_to_À32
(
nﬂ
->
›µs_˘wödow
 &

645 
IEEE80211_P2P_OPPPS_CTWINDOW_MASK
);

646 
	}
}

648 
u32
 
	$iwl_mvm_mac_˘xt_cmd_°a_gë_twt_pﬁicy
(
iwl_mvm
 *
mvm
,

649 
õì80211_vif
 *
vif
)

651 
u32
 
twt_pﬁicy
 = 0;

653 i‡(
vif
->
bss_c⁄f
.
twt_ªque°î
 && 
IWL_MVM_USE_TWT
)

654 
twt_pﬁicy
 |
TWT_SUPPORTED
;

655 i‡(
vif
->
bss_c⁄f
.
twt_¥Ÿe˘ed
)

656 
twt_pﬁicy
 |
PROTECTED_TWT_SUPPORTED
;

657 i‡(
vif
->
bss_c⁄f
.
twt_brﬂdˇ°
)

658 
twt_pﬁicy
 |
BROADCAST_TWT_SUPPORTED
;

660  
twt_pﬁicy
;

661 
	}
}

663 
	$iwl_mvm_mac_˘xt_cmd_°a
(
iwl_mvm
 *
mvm
,

664 
õì80211_vif
 *
vif
,

665 
u32
 
a˘i⁄
, 
boﬁ
 
f‹˚_assoc_off
,

666 c⁄° 
u8
 *
bssid_ovîride
)

668 
iwl_mac_˘x_cmd
 
cmd
 = {};

669 
iwl_mac_d©a_°a
 *
˘xt_°a
;

671 
	`WARN_ON
(
vif
->
ty≥
 !
NL80211_IFTYPE_STATION
);

674 
	`iwl_mvm_mac_˘xt_cmd_comm⁄
(
mvm
, 
vif
, &
cmd
, 
bssid_ovîride
, 
a˘i⁄
);

680 
cmd
.
fûãr_Êags
 |
	`˝u_to_À32
(
MAC_FILTER_ACCEPT_GRP
);

682 i‡(
vif
->
p2p
) {

683 
cmd
.
p2p_°a
.
˘wö
 =

684 
	`iwl_mvm_mac_˘xt_cmd_p2p_°a_gë_›µs_˘wö
(
mvm
, 
vif
);

686 
˘xt_°a
 = &
cmd
.
p2p_°a
.
°a
;

688 
˘xt_°a
 = &
cmd
.
°a
;

692 i‡(
vif
->
cfg
.
assoc
 && vif->
bss_c⁄f
.
dtim_≥riod
 &&

693 !
f‹˚_assoc_off
) {

694 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

696 
	`iwl_mvm_£t_fw_dtim_tbâ
(
mvm
, 
vif
, &vif->
bss_c⁄f
,

697 &
˘xt_°a
->
dtim_tsf
,

698 &
˘xt_°a
->
dtim_time
,

699 &
˘xt_°a
->
assoc_bóc⁄_¨rive_time
);

701 
˘xt_°a
->
is_assoc
 = 
	`˝u_to_À32
(1);

703 i‡(!
mvmvif
->
auth‹ized
 &&

704 
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

705 
IWL_UCODE_TLV_CAPA_COEX_HIGH_PRIO
))

706 
˘xt_°a
->
d©a_pﬁicy
 |=

707 
	`˝u_to_À32
(
COEX_HIGH_PRIORITY_ENABLE
);

709 
˘xt_°a
->
is_assoc
 = 
	`˝u_to_À32
(0);

714 
cmd
.
fûãr_Êags
 |
	`˝u_to_À32
(
MAC_FILTER_IN_BEACON
);

717 
˘xt_°a
->
bi
 = 
	`˝u_to_À32
(
vif
->
bss_c⁄f
.
bóc⁄_öt
);

718 
˘xt_°a
->
dtim_öãrvÆ
 = 
	`˝u_to_À32
(
vif
->
bss_c⁄f
.
bóc⁄_öt
 *

719 
vif
->
bss_c⁄f
.
dtim_≥riod
);

721 
˘xt_°a
->
li°í_öãrvÆ
 = 
	`˝u_to_À32
(
mvm
->
hw
->
c⁄f
.listen_interval);

722 
˘xt_°a
->
assoc_id
 = 
	`˝u_to_À32
(
vif
->
cfg
.
aid
);

724 i‡(
vif
->
¥obe_ªq_ªg
 && vif->
cfg
.
assoc
 && vif->
p2p
)

725 
cmd
.
fûãr_Êags
 |
	`˝u_to_À32
(
MAC_FILTER_IN_PROBE_REQUEST
);

727 i‡(
vif
->
bss_c⁄f
.
he_suµ‹t
 && !
iwlwifi_mod_∑øms
.
dißbÀ_11ax
) {

728 
cmd
.
fûãr_Êags
 |
	`˝u_to_À32
(
MAC_FILTER_IN_11AX
);

729 
˘xt_°a
->
d©a_pﬁicy
 |=

730 
	`˝u_to_À32
(
	`iwl_mvm_mac_˘xt_cmd_°a_gë_twt_pﬁicy
(
mvm
, 
vif
));

734  
	`iwl_mvm_mac_˘xt_£nd_cmd
(
mvm
, &
cmd
);

735 
	}
}

737 
	$iwl_mvm_mac_˘xt_cmd_li°íî
(
iwl_mvm
 *
mvm
,

738 
õì80211_vif
 *
vif
,

739 
u32
 
a˘i⁄
)

741 
iwl_mac_˘x_cmd
 
cmd
 = {};

742 
u32
 
tfd_queue_msk
 = 0;

743 
ªt
;

745 
	`WARN_ON
(
vif
->
ty≥
 !
NL80211_IFTYPE_MONITOR
);

747 
	`iwl_mvm_mac_˘xt_cmd_comm⁄
(
mvm
, 
vif
, &
cmd
, 
NULL
, 
a˘i⁄
);

749 
cmd
.
fûãr_Êags
 = 
	`˝u_to_À32
(
MAC_FILTER_IN_PROMISC
 |

750 
MAC_FILTER_IN_CONTROL_AND_MGMT
 |

751 
MAC_FILTER_IN_BEACON
 |

752 
MAC_FILTER_IN_PROBE_REQUEST
 |

753 
MAC_FILTER_IN_CRC32
 |

754 
MAC_FILTER_ACCEPT_GRP
);

755 
	`õì80211_hw_£t
(
mvm
->
hw
, 
RX_INCLUDES_FCS
);

762 i‡(!
	`iwl_mvm_has_√w_tx_≠i
(
mvm
))

763 
tfd_queue_msk
 = 
	`BIT
(
mvm
->
¢if_queue
);

766 
ªt
 = 
	`iwl_mvm_Æloˇã_öt_°a
(
mvm
, &mvm->
¢if_°a
, 
tfd_queue_msk
,

767 
vif
->
ty≥
, 
IWL_STA_GENERAL_PURPOSE
);

768 i‡(
ªt
)

769  
ªt
;

771  
	`iwl_mvm_mac_˘xt_£nd_cmd
(
mvm
, &
cmd
);

772 
	}
}

774 
	$iwl_mvm_mac_˘xt_cmd_ibss
(
iwl_mvm
 *
mvm
,

775 
õì80211_vif
 *
vif
,

776 
u32
 
a˘i⁄
)

778 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

779 
iwl_mac_˘x_cmd
 
cmd
 = {};

781 
	`WARN_ON
(
vif
->
ty≥
 !
NL80211_IFTYPE_ADHOC
);

783 
	`iwl_mvm_mac_˘xt_cmd_comm⁄
(
mvm
, 
vif
, &
cmd
, 
NULL
, 
a˘i⁄
);

785 
cmd
.
fûãr_Êags
 = 
	`˝u_to_À32
(
MAC_FILTER_IN_BEACON
 |

786 
MAC_FILTER_IN_PROBE_REQUEST
 |

787 
MAC_FILTER_ACCEPT_GRP
);

790 
cmd
.
ibss
.
bi
 = 
	`˝u_to_À32
(
vif
->
bss_c⁄f
.
bóc⁄_öt
);

793 
cmd
.
ibss
.
bóc⁄_ãm∂©e
 = 
	`˝u_to_À32
(
mvmvif
->
id
);

795  
	`iwl_mvm_mac_˘xt_£nd_cmd
(
mvm
, &
cmd
);

796 
	}
}

798 
	siwl_mvm_go_ôî©‹_d©a
 {

799 
boﬁ
 
	mgo_a˘ive
;

802 
	$iwl_mvm_go_ôî©‹
(*
_d©a
, 
u8
 *
mac
, 
õì80211_vif
 *
vif
)

804 
iwl_mvm_go_ôî©‹_d©a
 *
d©a
 = 
_d©a
;

805 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

807 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
 && vif->
p2p
 &&

808 
mvmvif
->
≠_ibss_a˘ive
)

809 
d©a
->
go_a˘ive
 = 
åue
;

810 
	}
}

812 
__À32
 
	$iwl_mac_˘xt_p2p_dev_has_exãnded_disc
(
iwl_mvm
 *
mvm
,

813 
õì80211_vif
 *
vif
)

815 
iwl_mvm_go_ôî©‹_d©a
 
d©a
 = {};

825 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s_©omic
(

826 
mvm
->
hw
, 
IEEE80211_IFACE_ITER_RESUME_ALL
,

827 
iwl_mvm_go_ôî©‹
, &
d©a
);

829  
	`˝u_to_À32
(
d©a
.
go_a˘ive
 ? 1 : 0);

830 
	}
}

832 
	$iwl_mvm_mac_˘xt_cmd_p2p_devi˚
(
iwl_mvm
 *
mvm
,

833 
õì80211_vif
 *
vif
,

834 
u32
 
a˘i⁄
)

836 
iwl_mac_˘x_cmd
 
cmd
 = {};

838 
	`WARN_ON
(
vif
->
ty≥
 !
NL80211_IFTYPE_P2P_DEVICE
);

840 
	`iwl_mvm_mac_˘xt_cmd_comm⁄
(
mvm
, 
vif
, &
cmd
, 
NULL
, 
a˘i⁄
);

842 
cmd
.
p2p_dev
.
is_disc_exãnded
 =

843 
	`iwl_mac_˘xt_p2p_dev_has_exãnded_disc
(
mvm
, 
vif
);

846 
cmd
.
fûãr_Êags
 = 
	`˝u_to_À32
(
MAC_FILTER_IN_PROBE_REQUEST
);

848  
	`iwl_mvm_mac_˘xt_£nd_cmd
(
mvm
, &
cmd
);

849 
	}
}

851 
	$iwl_mvm_mac_˘xt_£t_tim
(
iwl_mvm
 *
mvm
,

852 
__À32
 *
tim_ödex
, __À32 *
tim_size
,

853 
u8
 *
bóc⁄
, 
u32
 
‰ame_size
)

855 
u32
 
tim_idx
;

856 
õì80211_mgmt
 *
mgmt
 = (õì80211_mgmà*)
bóc⁄
;

860 
tim_idx
 = 
mgmt
->
u
.
bóc⁄
.
v¨übÀ
 - beacon;

863 (
tim_idx
 < (
‰ame_size
 - 2)) &&

864 (
bóc⁄
[
tim_idx
] !
WLAN_EID_TIM
))

865 
tim_idx
 +
bóc⁄
[tim_idx+1] + 2;

868 i‡((
tim_idx
 < (
‰ame_size
 - 1)Ë&& (
bóc⁄
[tim_idx] =
WLAN_EID_TIM
)) {

869 *
tim_ödex
 = 
	`˝u_to_À32
(
tim_idx
);

870 *
tim_size
 = 
	`˝u_to_À32
((
u32
)
bóc⁄
[
tim_idx
 + 1]);

872 
	`IWL_WARN
(
mvm
, "UnableÅo find TIM Element in beacon\n");

874 
	}
}

876 
u32
 
	$iwl_mvm_föd_õ_off£t
(
u8
 *
bóc⁄
, u8 
eid
, 
u32
 
‰ame_size
)

878 
õì80211_mgmt
 *
mgmt
 = (*)
bóc⁄
;

879 c⁄° 
u8
 *
õ
;

881 i‡(
	`WARN_ON_ONCE
(
‰ame_size
 <(
mgmt
->
u
.
bóc⁄
.
v¨übÀ
 - beacon)))

884 
‰ame_size
 -
mgmt
->
u
.
bóc⁄
.
v¨übÀ
 - beacon;

886 
õ
 = 
	`cfg80211_föd_õ
(
eid
, 
mgmt
->
u
.
bóc⁄
.
v¨übÀ
, 
‰ame_size
);

887 i‡(!
õ
)

890  
õ
 - 
bóc⁄
;

891 
	}
}

893 
u8
 
	$iwl_mvm_mac_˘xt_gë_lowe°_øã
(
iwl_mvm
 *
mvm
,

894 
õì80211_tx_öfo
 *
öfo
,

895 
õì80211_vif
 *
vif
)

897 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

898 
õì80211_suµ‹ãd_b™d
 *
sb™d
;

899 
basic
 = 
vif
->
bss_c⁄f
.
basic_øãs
;

900 
u16
 
lowe°_cck
 = 
IWL_RATE_COUNT
, 
lowe°_ofdm
 = IWL_RATE_COUNT;

901 
u32
 
lök_id
 = 
	`u32_gë_bôs
(
öfo
->
c⁄åﬁ
.
Êags
,

902 
IEEE80211_TX_CTRL_MLO_LINK
);

903 
u8
 
b™d
 = 
öfo
->band;

904 
u8
 
øã
;

905 
u32
 
i
;

907 i‡(
lök_id
 =
IEEE80211_LINK_UNSPECIFIED
 && 
	`õì80211_vif_is_mld
(
vif
)) {

908 
i
 = 0; i < 
	`ARRAY_SIZE
(
mvmvif
->
lök
); i++) {

909 i‡(!
mvmvif
->
lök
[
i
])

912 
	`WARN_ON_ONCE
(
lök_id
 !
IEEE80211_LINK_UNSPECIFIED
);

913 
lök_id
 = 
i
;

917 i‡(
lök_id
 < 
IEEE80211_LINK_UNSPECIFIED
) {

918 
õì80211_bss_c⁄f
 *
lök_c⁄f
;

920 
	`rcu_ªad_lock
();

921 
lök_c⁄f
 = 
	`rcu_dîe„ªn˚
(
vif
->lök_c⁄f[
lök_id
]);

922 i‡(
lök_c⁄f
) {

923 
basic
 = 
lök_c⁄f
->
basic_øãs
;

924 i‡(
lök_c⁄f
->
ch™ªq
.
›î
.
ch™
)

925 
b™d
 = 
lök_c⁄f
->
ch™ªq
.
›î
.
ch™
->band;

927 
	`rcu_ªad_u∆ock
();

930 
sb™d
 = 
mvm
->
hw
->
wùhy
->
b™ds
[
b™d
];

931 
	`f‹_óch_£t_bô
(
i
, &
basic
, 
BITS_PER_LONG
) {

932 
u16
 
hw
 = 
sb™d
->
bôøãs
[
i
].
hw_vÆue
;

934 i‡(
hw
 >
IWL_FIRST_OFDM_RATE
) {

935 i‡(
lowe°_ofdm
 > 
hw
)

936 
lowe°_ofdm
 = 
hw
;

937 } i‡(
lowe°_cck
 > 
hw
) {

938 
lowe°_cck
 = 
hw
;

942 i‡(
b™d
 =
NL80211_BAND_2GHZ
 && !
vif
->
p2p
 &&

943 
vif
->
ty≥
 !
NL80211_IFTYPE_P2P_DEVICE
 &&

944 !(
öfo
->
Êags
 & 
IEEE80211_TX_CTL_NO_CCK_RATE
)) {

945 i‡(
lowe°_cck
 !
IWL_RATE_COUNT
)

946 
øã
 = 
lowe°_cck
;

947 i‡(
lowe°_ofdm
 !
IWL_RATE_COUNT
)

948 
øã
 = 
lowe°_ofdm
;

950 
øã
 = 
IWL_RATE_1M_INDEX
;

951 } i‡(
lowe°_ofdm
 !
IWL_RATE_COUNT
) {

952 
øã
 = 
lowe°_ofdm
;

954 
øã
 = 
IWL_RATE_6M_INDEX
;

957  
øã
;

958 
	}
}

960 
u16
 
	$iwl_mvm_mac_˘xt_gë_bóc⁄_Êags
(c⁄° 
iwl_fw
 *
fw
, 
u8
 
øã_idx
)

962 
u16
 
Êags
 = 
	`iwl_mvm_mac80211_idx_to_hwøã
(
fw
, 
øã_idx
);

963 
boﬁ
 
is_√w_øã
 = 
	`iwl_fw_lookup_cmd_vî
(
fw
, 
BEACON_TEMPLATE_CMD
, 0) > 10;

965 i‡(
øã_idx
 <
IWL_FIRST_CCK_RATE
)

966 
Êags
 |
is_√w_øã
 ? 
IWL_MAC_BEACON_CCK


967 : 
IWL_MAC_BEACON_CCK_V1
;

969  
Êags
;

970 
	}
}

972 
u8
 
	$iwl_mvm_mac_˘xt_gë_bóc⁄_øã
(
iwl_mvm
 *
mvm
,

973 
õì80211_tx_öfo
 *
öfo
,

974 
õì80211_vif
 *
vif
)

976 
õì80211_suµ‹ãd_b™d
 *
sb™d
 =

977 
mvm
->
hw
->
wùhy
->
b™ds
[
öfo
->
b™d
];

978 
u32
 
Àgacy
 = 
vif
->
bss_c⁄f
.
bóc⁄_tx_øã
.
c⁄åﬁ
[
öfo
->
b™d
].legacy;

981 i‡(
	`hweight32
(
Àgacy
) == 1) {

982 
u32
 
øã
 = 
	`ffs
(
Àgacy
) - 1;

984  
sb™d
->
bôøãs
[
øã
].
hw_vÆue
;

987  
	`iwl_mvm_mac_˘xt_gë_lowe°_øã
(
mvm
, 
öfo
, 
vif
);

988 
	}
}

990 
	$iwl_mvm_mac_˘xt_£t_tx
(
iwl_mvm
 *
mvm
,

991 
õì80211_vif
 *
vif
,

992 
sk_buff
 *
bóc⁄
,

993 
iwl_tx_cmd
 *
tx
)

995 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

996 
õì80211_tx_öfo
 *
öfo
;

997 
u8
 
øã
;

998 
u32
 
tx_Êags
;

1000 
öfo
 = 
	`IEEE80211_SKB_CB
(
bóc⁄
);

1003 
tx
->
Àn
 = 
	`˝u_to_À16
((
u16
)
bóc⁄
->len);

1004 
tx
->
°a_id
 = 
mvmvif
->
deÊök
.
bˇ°_°a
.sta_id;

1005 
tx
->
li„_time
 = 
	`˝u_to_À32
(
TX_CMD_LIFE_TIME_INFINITE
);

1006 
tx_Êags
 = 
TX_CMD_FLG_SEQ_CTL
 | 
TX_CMD_FLG_TSF
;

1007 
tx_Êags
 |=

1008 
	`iwl_mvm_bt_c€x_tx_¥io
(
mvm
, (*)
bóc⁄
->
d©a
, 
öfo
, 0) <<

1009 
TX_CMD_FLG_BT_PRIO_POS
;

1010 
tx
->
tx_Êags
 = 
	`˝u_to_À32
(tx_flags);

1012 i‡(!
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

1013 
IWL_UCODE_TLV_CAPA_BEACON_ANT_SELECTION
))

1014 
	`iwl_mvm_toggÀ_tx_™t
(
mvm
, &mvm->
mgmt_œ°_™ã¬a_idx
);

1016 
tx
->
øã_n_Êags
 =

1017 
	`˝u_to_À32
(
	`BIT
(
mvm
->
mgmt_œ°_™ã¬a_idx
) <<

1018 
RATE_MCS_ANT_POS
);

1020 
øã
 = 
	`iwl_mvm_mac_˘xt_gë_bóc⁄_øã
(
mvm
, 
öfo
, 
vif
);

1022 
tx
->
øã_n_Êags
 |=

1023 
	`˝u_to_À32
(
	`iwl_mvm_mac80211_idx_to_hwøã
(
mvm
->
fw
, 
øã
));

1024 i‡(
øã
 =
IWL_FIRST_CCK_RATE
)

1025 
tx
->
øã_n_Êags
 |
	`˝u_to_À32
(
RATE_MCS_CCK_MSK_V1
);

1027 
	}
}

1029 
	$iwl_mvm_mac_˘xt_£nd_bóc⁄_cmd
(
iwl_mvm
 *
mvm
,

1030 
sk_buff
 *
bóc⁄
,

1031 *
d©a
, 
Àn
)

1033 
iwl_ho°_cmd
 
cmd
 = {

1034 .
id
 = 
BEACON_TEMPLATE_CMD
,

1035 .
Êags
 = 
CMD_ASYNC
,

1038 
cmd
.
Àn
[0] =Üen;

1039 
cmd
.
d©a
[0] = data;

1040 
cmd
.
d©aÊags
[0] = 0;

1041 
cmd
.
Àn
[1] = 
bóc⁄
->len;

1042 
cmd
.
d©a
[1] = 
bóc⁄
->data;

1043 
cmd
.
d©aÊags
[1] = 
IWL_HCMD_DFL_DUP
;

1045  
	`iwl_mvm_£nd_cmd
(
mvm
, &
cmd
);

1046 
	}
}

1048 
	$iwl_mvm_mac_˘xt_£nd_bóc⁄_v6
(
iwl_mvm
 *
mvm
,

1049 
õì80211_vif
 *
vif
,

1050 
sk_buff
 *
bóc⁄
)

1052 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1053 
iwl_mac_bóc⁄_cmd_v6
 
bóc⁄_cmd
 = {};

1055 
	`iwl_mvm_mac_˘xt_£t_tx
(
mvm
, 
vif
, 
bóc⁄
, &
bóc⁄_cmd
.
tx
);

1057 
bóc⁄_cmd
.
ãm∂©e_id
 = 
	`˝u_to_À32
((
u32
)
mvmvif
->
id
);

1059 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
)

1060 
	`iwl_mvm_mac_˘xt_£t_tim
(
mvm
, &
bóc⁄_cmd
.
tim_idx
,

1061 &
bóc⁄_cmd
.
tim_size
,

1062 
bóc⁄
->
d©a
, bóc⁄->
Àn
);

1064  
	`iwl_mvm_mac_˘xt_£nd_bóc⁄_cmd
(
mvm
, 
bóc⁄
, &
bóc⁄_cmd
,

1065 (
bóc⁄_cmd
));

1066 
	}
}

1068 
	$iwl_mvm_mac_˘xt_£nd_bóc⁄_v7
(
iwl_mvm
 *
mvm
,

1069 
õì80211_vif
 *
vif
,

1070 
sk_buff
 *
bóc⁄
)

1072 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1073 
iwl_mac_bóc⁄_cmd_v7
 
bóc⁄_cmd
 = {};

1075 
	`iwl_mvm_mac_˘xt_£t_tx
(
mvm
, 
vif
, 
bóc⁄
, &
bóc⁄_cmd
.
tx
);

1077 
bóc⁄_cmd
.
ãm∂©e_id
 = 
	`˝u_to_À32
((
u32
)
mvmvif
->
id
);

1079 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
)

1080 
	`iwl_mvm_mac_˘xt_£t_tim
(
mvm
, &
bóc⁄_cmd
.
tim_idx
,

1081 &
bóc⁄_cmd
.
tim_size
,

1082 
bóc⁄
->
d©a
, bóc⁄->
Àn
);

1084 
bóc⁄_cmd
.
cß_off£t
 =

1085 
	`˝u_to_À32
(
	`iwl_mvm_föd_õ_off£t
(
bóc⁄
->
d©a
,

1086 
WLAN_EID_CHANNEL_SWITCH
,

1087 
bóc⁄
->
Àn
));

1088 
bóc⁄_cmd
.
ecß_off£t
 =

1089 
	`˝u_to_À32
(
	`iwl_mvm_föd_õ_off£t
(
bóc⁄
->
d©a
,

1090 
WLAN_EID_EXT_CHANSWITCH_ANN
,

1091 
bóc⁄
->
Àn
));

1093  
	`iwl_mvm_mac_˘xt_£nd_bóc⁄_cmd
(
mvm
, 
bóc⁄
, &
bóc⁄_cmd
,

1094 (
bóc⁄_cmd
));

1095 
	}
}

1097 
boﬁ
 
	$iwl_mvm_íabÀ_fûs
(
iwl_mvm
 *
mvm
,

1098 
õì80211_ch™˘x_c⁄f
 *
˘x
)

1100 i‡(
IWL_MVM_DISABLE_AP_FILS
)

1101  
Ál£
;

1103 i‡(
	`cfg80211_ch™√l_is_psc
(
˘x
->
def
.
ch™
))

1104  
åue
;

1106  (
˘x
->
def
.
ch™
->
b™d
 =
NL80211_BAND_6GHZ
 &&

1107 
˘x
->
def
.
width
 >
NL80211_CHAN_WIDTH_80
);

1108 
	}
}

1110 
	$iwl_mvm_mac_˘xt_£nd_bóc⁄_v9
(
iwl_mvm
 *
mvm
,

1111 
õì80211_vif
 *
vif
,

1112 
sk_buff
 *
bóc⁄
,

1113 
õì80211_bss_c⁄f
 *
lök_c⁄f
)

1115 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1116 
õì80211_tx_öfo
 *
öfo
 = 
	`IEEE80211_SKB_CB
(
bóc⁄
);

1117 
iwl_mac_bóc⁄_cmd
 
bóc⁄_cmd
 = {};

1118 
u8
 
øã
 = 
	`iwl_mvm_mac_˘xt_gë_bóc⁄_øã
(
mvm
, 
öfo
, 
vif
);

1119 
u16
 
Êags
;

1120 
õì80211_ch™˘x_c⁄f
 *
˘x
;

1121 
ch™√l
;

1122 
Êags
 = 
	`iwl_mvm_mac_˘xt_gë_bóc⁄_Êags
(
mvm
->
fw
, 
øã
);

1125 
	`rcu_ªad_lock
();

1126 
˘x
 = 
	`rcu_dîe„ªn˚
(
lök_c⁄f
->
ch™˘x_c⁄f
);

1127 
ch™√l
 = 
	`õì80211_‰equícy_to_ch™√l
(
˘x
->
def
.
ch™
->
˚¡î_‰eq
);

1128 
	`WARN_ON
(
ch™√l
 == 0);

1129 i‡(
	`iwl_mvm_íabÀ_fûs
(
mvm
, 
˘x
)) {

1130 
Êags
 |
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
BEACON_TEMPLATE_CMD
,

1132 
IWL_MAC_BEACON_FILS
 :

1133 
IWL_MAC_BEACON_FILS_V1
;

1134 
bóc⁄_cmd
.
sh‹t_ssid
 =

1135 
	`˝u_to_À32
(~
	`¸c32_À
(~0, 
vif
->
cfg
.
ssid
,

1136 
vif
->
cfg
.
ssid_Àn
));

1138 
	`rcu_ªad_u∆ock
();

1140 
bóc⁄_cmd
.
Êags
 = 
	`˝u_to_À16
(flags);

1141 
bóc⁄_cmd
.
byã_˙t
 = 
	`˝u_to_À16
((
u16
)
bóc⁄
->
Àn
);

1143 i‡(
	`WARN_ON
(!
mvmvif
->
lök
[
lök_c⁄f
->
lök_id
]))

1144  -
EINVAL
;

1146 i‡(
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
BEACON_TEMPLATE_CMD
, 0) > 12)

1147 
bóc⁄_cmd
.
lök_id
 =

1148 
	`˝u_to_À32
(
mvmvif
->
lök
[
lök_c⁄f
->
lök_id
]->
fw_lök_id
);

1150 
bóc⁄_cmd
.
lök_id
 = 
	`˝u_to_À32
((
u32
)
mvmvif
->
id
);

1152 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
)

1153 
	`iwl_mvm_mac_˘xt_£t_tim
(
mvm
, &
bóc⁄_cmd
.
tim_idx
,

1154 &
bóc⁄_cmd
.
tim_size
,

1155 
bóc⁄
->
d©a
, bóc⁄->
Àn
);

1157 
bóc⁄_cmd
.
cß_off£t
 =

1158 
	`˝u_to_À32
(
	`iwl_mvm_föd_õ_off£t
(
bóc⁄
->
d©a
,

1159 
WLAN_EID_CHANNEL_SWITCH
,

1160 
bóc⁄
->
Àn
));

1161 
bóc⁄_cmd
.
ecß_off£t
 =

1162 
	`˝u_to_À32
(
	`iwl_mvm_föd_õ_off£t
(
bóc⁄
->
d©a
,

1163 
WLAN_EID_EXT_CHANSWITCH_ANN
,

1164 
bóc⁄
->
Àn
));

1166  
	`iwl_mvm_mac_˘xt_£nd_bóc⁄_cmd
(
mvm
, 
bóc⁄
, &
bóc⁄_cmd
,

1167 (
bóc⁄_cmd
));

1168 
	}
}

1170 
	$iwl_mvm_mac_˘xt_£nd_bóc⁄
(
iwl_mvm
 *
mvm
,

1171 
õì80211_vif
 *
vif
,

1172 
sk_buff
 *
bóc⁄
,

1173 
õì80211_bss_c⁄f
 *
lök_c⁄f
)

1175 i‡(
	`WARN_ON
(!
bóc⁄
))

1176  -
EINVAL
;

1178 i‡(
IWL_MVM_NON_TRANSMITTING_AP
)

1181 i‡(!
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

1182 
IWL_UCODE_TLV_CAPA_CSA_AND_TBTT_OFFLOAD
))

1183  
	`iwl_mvm_mac_˘xt_£nd_bóc⁄_v6
(
mvm
, 
vif
, 
bóc⁄
);

1185 i‡(
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

1186 
IWL_UCODE_TLV_API_NEW_BEACON_TEMPLATE
))

1187  
	`iwl_mvm_mac_˘xt_£nd_bóc⁄_v9
(
mvm
, 
vif
, 
bóc⁄
,

1188 
lök_c⁄f
);

1190  
	`iwl_mvm_mac_˘xt_£nd_bóc⁄_v7
(
mvm
, 
vif
, 
bóc⁄
);

1191 
	}
}

1194 
	$iwl_mvm_mac_˘xt_bóc⁄_ch™ged
(
iwl_mvm
 *
mvm
,

1195 
õì80211_vif
 *
vif
,

1196 
õì80211_bss_c⁄f
 *
lök_c⁄f
)

1198 
sk_buff
 *
bóc⁄
;

1199 
ªt
;

1201 
	`WARN_ON
(
vif
->
ty≥
 !
NL80211_IFTYPE_AP
 &&

1202 
vif
->
ty≥
 !
NL80211_IFTYPE_ADHOC
);

1204 
bóc⁄
 = 
	`õì80211_bóc⁄_gë_ãm∂©e
(
mvm
->
hw
, 
vif
, 
NULL
,

1205 
lök_c⁄f
->
lök_id
);

1206 i‡(!
bóc⁄
)

1207  -
ENOMEM
;

1209 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


1210 i‡(
mvm
->
bóc⁄_öje˘_a˘ive
) {

1211 
	`dev_k‰ì_skb
(
bóc⁄
);

1212  -
EBUSY
;

1216 
ªt
 = 
	`iwl_mvm_mac_˘xt_£nd_bóc⁄
(
mvm
, 
vif
, 
bóc⁄
, 
lök_c⁄f
);

1217 
	`dev_k‰ì_skb
(
bóc⁄
);

1218  
ªt
;

1219 
	}
}

1221 
	siwl_mvm_mac_≠_ôî©‹_d©a
 {

1222 
iwl_mvm
 *
	mmvm
;

1223 
õì80211_vif
 *
	mvif
;

1224 
u32
 
	mbóc⁄_devi˚_ts
;

1225 
u16
 
	mbóc⁄_öt
;

1229 
	$iwl_mvm_mac_≠_ôî©‹
(*
_d©a
, 
u8
 *
mac
,

1230 
õì80211_vif
 *
vif
)

1232 
iwl_mvm_mac_≠_ôî©‹_d©a
 *
d©a
 = 
_d©a
;

1234 i‡(
vif
->
ty≥
 !
NL80211_IFTYPE_STATION
 || !vif->
cfg
.
assoc
)

1238 i‡(
vif
->
p2p
 && 
d©a
->
bóc⁄_devi˚_ts
)

1241 
d©a
->
bóc⁄_devi˚_ts
 = 
vif
->
bss_c⁄f
.
sync_devi˚_ts
;

1242 
d©a
->
bóc⁄_öt
 = 
vif
->
bss_c⁄f
.beacon_int;

1243 
	}
}

1248 
	$iwl_mvm_mac_˘xt_cmd_≠_£t_fûãr_Êags
(
iwl_mvm
 *
mvm
,

1249 
iwl_mvm_vif
 *
mvmvif
,

1250 
__À32
 *
fûãr_Êags
,

1251 
ac˚±_¥obe_ªq_Êag
,

1252 
ac˚±_bóc⁄_Êag
)

1260 *
fûãr_Êags
 |
	`˝u_to_À32
(
ac˚±_¥obe_ªq_Êag
);

1261 i‡(
mvmvif
->
≠_assoc_°a_cou¡
 || !
mvm
->
dr›_b˙_≠_mode
) {

1262 *
fûãr_Êags
 |
	`˝u_to_À32
(
ac˚±_bóc⁄_Êag
);

1263 
	`IWL_DEBUG_HC
(
mvm
, "Asking FWÅoÖass beacons\n");

1265 
	`IWL_DEBUG_HC
(
mvm
, "NoÇeedÅoÑeceive beacons\n");

1267 
	}
}

1272 
	$iwl_mvm_mac_˘xt_cmd_fûl_≠
(
iwl_mvm
 *
mvm
,

1273 
õì80211_vif
 *
vif
,

1274 
iwl_mac_˘x_cmd
 *
cmd
,

1275 
iwl_mac_d©a_≠
 *
˘xt_≠
,

1276 
boﬁ
 
add
)

1278 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1279 
iwl_mvm_mac_≠_ôî©‹_d©a
 
d©a
 = {

1280 .
mvm
 = mvm,

1281 .
vif
 = vif,

1282 .
bóc⁄_devi˚_ts
 = 0

1286 
cmd
->
ac
[
IWL_MVM_TX_FIFO_VO
].
fifos_mask
 |
	`BIT
(
IWL_MVM_TX_FIFO_MCAST
);

1288 
	`iwl_mvm_mac_˘xt_cmd_≠_£t_fûãr_Êags
(
mvm
, 
mvmvif
,

1289 &
cmd
->
fûãr_Êags
,

1290 
MAC_FILTER_IN_PROBE_REQUEST
,

1291 
MAC_FILTER_IN_BEACON
);

1293 
˘xt_≠
->
bi
 = 
	`˝u_to_À32
(
vif
->
bss_c⁄f
.
bóc⁄_öt
);

1294 
˘xt_≠
->
dtim_öãrvÆ
 = 
	`˝u_to_À32
(
vif
->
bss_c⁄f
.
bóc⁄_öt
 *

1295 
vif
->
bss_c⁄f
.
dtim_≥riod
);

1297 i‡(!
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

1298 
IWL_UCODE_TLV_API_STA_TYPE
))

1299 
˘xt_≠
->
mˇ°_qid
 = 
	`˝u_to_À32
(
mvmvif
->
deÊök
.
ˇb_queue
);

1306 i‡(
add
) {

1312 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s_©omic
(

1313 
mvm
->
hw
, 
IEEE80211_IFACE_ITER_RESUME_ALL
,

1314 
iwl_mvm_mac_≠_ôî©‹
, &
d©a
);

1316 i‡(
d©a
.
bóc⁄_devi˚_ts
) {

1317 
u32
 
ønd
 = 
	`gë_øndom_u32_ö˛usive
(36, 63);

1318 
mvmvif
->
≠_bóc⁄_time
 = 
d©a
.
bóc⁄_devi˚_ts
 +

1319 
	`õì80211_tu_to_u£c
(
d©a
.
bóc⁄_öt
 * 
ønd
 /

1322 
mvmvif
->
≠_bóc⁄_time
 = 
	`iwl_mvm_gë_sy°ime
(
mvm
);

1326 
˘xt_≠
->
bóc⁄_time
 = 
	`˝u_to_À32
(
mvmvif
->
≠_bóc⁄_time
);

1327 
˘xt_≠
->
bóc⁄_tsf
 = 0;

1330 
˘xt_≠
->
bóc⁄_ãm∂©e
 = 
	`˝u_to_À32
(
mvmvif
->
id
);

1331 
	}
}

1333 
	$iwl_mvm_mac_˘xt_cmd_≠
(
iwl_mvm
 *
mvm
,

1334 
õì80211_vif
 *
vif
,

1335 
u32
 
a˘i⁄
)

1337 
iwl_mac_˘x_cmd
 
cmd
 = {};

1339 
	`WARN_ON
(
vif
->
ty≥
 !
NL80211_IFTYPE_AP
 || vif->
p2p
);

1342 
	`iwl_mvm_mac_˘xt_cmd_comm⁄
(
mvm
, 
vif
, &
cmd
, 
NULL
, 
a˘i⁄
);

1345 
	`iwl_mvm_mac_˘xt_cmd_fûl_≠
(
mvm
, 
vif
, &
cmd
, &cmd.
≠
,

1346 
a˘i⁄
 =
FW_CTXT_ACTION_ADD
);

1348  
	`iwl_mvm_mac_˘xt_£nd_cmd
(
mvm
, &
cmd
);

1349 
	}
}

1351 
	$iwl_mvm_mac_˘xt_cmd_go
(
iwl_mvm
 *
mvm
,

1352 
õì80211_vif
 *
vif
,

1353 
u32
 
a˘i⁄
)

1355 
iwl_mac_˘x_cmd
 
cmd
 = {};

1356 
õì80211_p2p_nﬂ_©å
 *
nﬂ
 = &
vif
->
bss_c⁄f
.
p2p_nﬂ_©å
;

1358 
	`WARN_ON
(
vif
->
ty≥
 !
NL80211_IFTYPE_AP
 || !vif->
p2p
);

1361 
	`iwl_mvm_mac_˘xt_cmd_comm⁄
(
mvm
, 
vif
, &
cmd
, 
NULL
, 
a˘i⁄
);

1364 
	`iwl_mvm_mac_˘xt_cmd_fûl_≠
(
mvm
, 
vif
, &
cmd
, &cmd.
go
.
≠
,

1365 
a˘i⁄
 =
FW_CTXT_ACTION_ADD
);

1367 
cmd
.
go
.
˘wö
 = 
	`˝u_to_À32
(
nﬂ
->
›µs_˘wödow
 &

1368 
IEEE80211_P2P_OPPPS_CTWINDOW_MASK
);

1369 
cmd
.
go
.
›p_ps_íabÀd
 =

1370 
	`˝u_to_À32
(!!(
nﬂ
->
›µs_˘wödow
 &

1371 
IEEE80211_P2P_OPPPS_ENABLE_BIT
));

1373  
	`iwl_mvm_mac_˘xt_£nd_cmd
(
mvm
, &
cmd
);

1374 
	}
}

1376 
	$iwl_mvm_mac_˘x_£nd
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

1377 
u32
 
a˘i⁄
, 
boﬁ
 
f‹˚_assoc_off
,

1378 c⁄° 
u8
 *
bssid_ovîride
)

1380 
vif
->
ty≥
) {

1381 
NL80211_IFTYPE_STATION
:

1382  
	`iwl_mvm_mac_˘xt_cmd_°a
(
mvm
, 
vif
, 
a˘i⁄
,

1383 
f‹˚_assoc_off
,

1384 
bssid_ovîride
);

1385 
NL80211_IFTYPE_AP
:

1386 i‡(!
vif
->
p2p
)

1387  
	`iwl_mvm_mac_˘xt_cmd_≠
(
mvm
, 
vif
, 
a˘i⁄
);

1389  
	`iwl_mvm_mac_˘xt_cmd_go
(
mvm
, 
vif
, 
a˘i⁄
);

1390 
NL80211_IFTYPE_MONITOR
:

1391  
	`iwl_mvm_mac_˘xt_cmd_li°íî
(
mvm
, 
vif
, 
a˘i⁄
);

1392 
NL80211_IFTYPE_P2P_DEVICE
:

1393  
	`iwl_mvm_mac_˘xt_cmd_p2p_devi˚
(
mvm
, 
vif
, 
a˘i⁄
);

1394 
NL80211_IFTYPE_ADHOC
:

1395  
	`iwl_mvm_mac_˘xt_cmd_ibss
(
mvm
, 
vif
, 
a˘i⁄
);

1400  -
EOPNOTSUPP
;

1401 
	}
}

1403 
	$iwl_mvm_mac_˘xt_add
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

1405 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1406 
ªt
;

1408 i‡(
	`WARN_ONCE
(
mvmvif
->
u∂ﬂded
, "Addingáctive MAC %pM/%d\n",

1409 
vif
->
addr
, 
	`õì80211_vif_ty≥_p2p
(vif)))

1410  -
EIO
;

1412 
ªt
 = 
	`iwl_mvm_mac_˘x_£nd
(
mvm
, 
vif
, 
FW_CTXT_ACTION_ADD
,

1413 
åue
, 
NULL
);

1414 i‡(
ªt
)

1415  
ªt
;

1418 
	`iwl_mvm_£t_œ°_n⁄qos_£q
(
mvm
, 
vif
);

1420 
mvmvif
->
u∂ﬂded
 = 
åue
;

1422 
	}
}

1424 
	$iwl_mvm_mac_˘xt_ch™ged
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

1425 
boﬁ
 
f‹˚_assoc_off
, c⁄° 
u8
 *
bssid_ovîride
)

1427 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1429 i‡(
	`WARN_ONCE
(!
mvmvif
->
u∂ﬂded
, "Changing inactive MAC %pM/%d\n",

1430 
vif
->
addr
, 
	`õì80211_vif_ty≥_p2p
(vif)))

1431  -
EIO
;

1433  
	`iwl_mvm_mac_˘x_£nd
(
mvm
, 
vif
, 
FW_CTXT_ACTION_MODIFY
,

1434 
f‹˚_assoc_off
, 
bssid_ovîride
);

1435 
	}
}

1437 
	$iwl_mvm_mac_˘xt_ªmove
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

1439 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1440 
iwl_mac_˘x_cmd
 
cmd
;

1441 
ªt
;

1443 i‡(
	`WARN_ONCE
(!
mvmvif
->
u∂ﬂded
, "Removing inactive MAC %pM/%d\n",

1444 
vif
->
addr
, 
	`õì80211_vif_ty≥_p2p
(vif)))

1445  -
EIO
;

1447 
	`mem£t
(&
cmd
, 0, (cmd));

1449 
cmd
.
id_™d_cﬁ‹
 = 
	`˝u_to_À32
(
	`FW_CMD_ID_AND_COLOR
(
mvmvif
->
id
,

1450 
mvmvif
->
cﬁ‹
));

1451 
cmd
.
a˘i⁄
 = 
	`˝u_to_À32
(
FW_CTXT_ACTION_REMOVE
);

1453 
ªt
 = 
	`iwl_mvm_mac_˘xt_£nd_cmd
(
mvm
, &
cmd
);

1454 i‡(
ªt
)

1455  
ªt
;

1457 
mvmvif
->
u∂ﬂded
 = 
Ál£
;

1459 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_MONITOR
) {

1460 
	`__˛ór_bô
(
IEEE80211_HW_RX_INCLUDES_FCS
, 
mvm
->
hw
->
Êags
);

1461 
	`iwl_mvm_dóŒoc_¢if_°a
(
mvm
);

1465 
	}
}

1467 
	$iwl_mvm_cß_cou¡_down
(
iwl_mvm
 *
mvm
,

1468 
õì80211_vif
 *
cß_vif
, 
u32
 
gp2
,

1469 
boﬁ
 
tx_suc˚ss
)

1471 
iwl_mvm_vif
 *
mvmvif
 =

1472 
	`iwl_mvm_vif_‰om_mac80211
(
cß_vif
);

1475 i‡(!
tx_suc˚ss
 && !
mvmvif
->
cß_cou¡down
)

1478 
mvmvif
->
cß_cou¡down
 = 
åue
;

1480 i‡(!
	`õì80211_bóc⁄_˙tdwn_is_com∂ëe
(
cß_vif
, 0)) {

1481 
c
 = 
	`õì80211_bóc⁄_upd©e_˙tdwn
(
cß_vif
, 0);

1483 
	`iwl_mvm_mac_˘xt_bóc⁄_ch™ged
(
mvm
, 
cß_vif
,

1484 &
cß_vif
->
bss_c⁄f
);

1485 i‡(
cß_vif
->
p2p
 &&

1486 !
	`iwl_mvm_ã_scheduÀd
(&
mvmvif
->
time_evít_d©a
Ë&& 
gp2
 &&

1487 
tx_suc˚ss
) {

1488 
u32
 
ªl_time
 = (
c
 + 1) *

1489 
cß_vif
->
bss_c⁄f
.
bóc⁄_öt
 -

1490 
IWL_MVM_CHANNEL_SWITCH_TIME_GO
;

1491 
u32
 
≠∂y_time
 = 
gp2
 + 
ªl_time
 * 1024;

1493 
	`iwl_mvm_scheduÀ_cß_≥riod
(
mvm
, 
cß_vif
,

1494 
IWL_MVM_CHANNEL_SWITCH_TIME_GO
 -

1495 
IWL_MVM_CHANNEL_SWITCH_MARGIN
,

1496 
≠∂y_time
);

1498 } i‡(!
	`iwl_mvm_ã_scheduÀd
(&
mvmvif
->
time_evít_d©a
)) {

1500 
	`õì80211_cß_föish
(
cß_vif
, 0);

1501 
	`RCU_INIT_POINTER
(
mvm
->
cß_vif
, 
NULL
);

1503 
	}
}

1505 
	$iwl_mvm_rx_bóc⁄_nŸif
(
iwl_mvm
 *
mvm
,

1506 
iwl_rx_cmd_buf„r
 *
rxb
)

1508 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

1509 
pkt_Àn
 = 
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
);

1510 
iwl_exãnded_bóc⁄_nŸif
 *
bóc⁄
 = (*)
pkt
->
d©a
;

1511 
iwl_exãnded_bóc⁄_nŸif_v5
 *
bóc⁄_v5
 = (*)
pkt
->
d©a
;

1512 
õì80211_vif
 *
cß_vif
;

1513 
õì80211_vif
 *
tx_blocked_vif
;

1514 
agg_tx_°©us
 *
agg_°©us
;

1515 
u16
 
°©us
;

1517 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1519 
mvm
->
≠_œ°_bóc⁄_gp2
 = 
	`À32_to_˝u
(
bóc⁄
->
gp2
);

1521 i‡(!
	`iwl_mvm_is_sh‹t_bóc⁄_nŸif_suµ‹ãd
(
mvm
)) {

1522 
iwl_mvm_tx_ª•
 *
bóc⁄_nŸify_hdr
 =

1523 &
bóc⁄_v5
->
bóc⁄_nŸify_hdr
;

1525 i‡(
	`u∆ikñy
(
pkt_Àn
 < (*
bóc⁄_v5
)))

1528 
mvm
->
ibss_m™agî
 = 
bóc⁄_v5
->
ibss_mgr_°©us
 != 0;

1529 
agg_°©us
 = 
	`iwl_mvm_gë_agg_°©us
(
mvm
, 
bóc⁄_nŸify_hdr
);

1530 
°©us
 = 
	`À16_to_˝u
(
agg_°©us
->°©usË& 
TX_STATUS_MSK
;

1531 
	`IWL_DEBUG_RX
(
mvm
,

1533 
°©us
, 
bóc⁄_nŸify_hdr
->
Áûuª_‰ame
,

1534 
	`À64_to_˝u
(
bóc⁄
->
tsf
),

1535 
mvm
->
≠_œ°_bóc⁄_gp2
,

1536 
	`À32_to_˝u
(
bóc⁄_nŸify_hdr
->
öôül_øã
));

1538 i‡(
	`u∆ikñy
(
pkt_Àn
 < (*
bóc⁄
)))

1541 
mvm
->
ibss_m™agî
 = 
bóc⁄
->
ibss_mgr_°©us
 != 0;

1542 
°©us
 = 
	`À32_to_˝u
(
bóc⁄
->°©usË& 
TX_STATUS_MSK
;

1543 
	`IWL_DEBUG_RX
(
mvm
,

1545 
°©us
, 
	`À64_to_˝u
(
bóc⁄
->
tsf
),

1546 
mvm
->
≠_œ°_bóc⁄_gp2
);

1549 
cß_vif
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm
->csa_vif,

1550 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

1551 i‡(
	`u∆ikñy
(
cß_vif
 && cß_vif->
bss_c⁄f
.
cß_a˘ive
))

1552 
	`iwl_mvm_cß_cou¡_down
(
mvm
, 
cß_vif
, mvm->
≠_œ°_bóc⁄_gp2
,

1553 (
°©us
 =
TX_STATUS_SUCCESS
));

1555 
tx_blocked_vif
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm
->
cß_tx_blocked_vif
,

1556 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

1557 i‡(
	`u∆ikñy
(
tx_blocked_vif
)) {

1558 
iwl_mvm_vif
 *
mvmvif
 =

1559 
	`iwl_mvm_vif_‰om_mac80211
(
tx_blocked_vif
);

1566 i‡(!
mvm
->
cß_tx_block_b˙_timeout
)

1567 
mvm
->
cß_tx_block_b˙_timeout
 =

1568 
IWL_MVM_CS_UNBLOCK_TX_TIMEOUT
;

1570 
mvm
->
cß_tx_block_b˙_timeout
--;

1573 i‡(
mvm
->
cß_tx_block_b˙_timeout
 == 0) {

1574 
	`iwl_mvm_modify_Æl_°a_dißbÀ_tx
(
mvm
, 
mvmvif
, 
Ál£
);

1575 
	`RCU_INIT_POINTER
(
mvm
->
cß_tx_blocked_vif
, 
NULL
);

1578 
	}
}

1580 
	$iwl_mvm_rx_mis£d_bóc⁄s_nŸif
(
iwl_mvm
 *
mvm
,

1581 
iwl_rx_cmd_buf„r
 *
rxb
)

1583 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

1584 
iwl_mis£d_bóc⁄s_nŸif
 *
mb
 = (*)
pkt
->
d©a
;

1585 
iwl_fw_dbg_åiggî_mis£d_bc⁄
 *
bc⁄_åig
;

1586 
iwl_fw_dbg_åiggî_év
 *
åiggî
;

1587 
u32
 
°›_åig_mis£d_bc⁄
, 
°›_åig_mis£d_bc⁄_sö˚_rx
;

1588 
u32
 
rx_mis£d_bc⁄
, 
rx_mis£d_bc⁄_sö˚_rx
;

1589 
õì80211_vif
 *
vif
;

1591 
u32
 
id
 = 
	`À32_to_˝u
(
mb
->
lök_id
);

1592 
iwl_dbg_év_ç_d©a
 
ç_d©a
 = { .
fw_pkt
 = 
pkt
 };

1593 
u32
 
mac_ty≥
;

1594 
u8
 
nŸif_vî
 = 
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
LEGACY_GROUP
,

1595 
MISSED_BEACONS_NOTIFICATION
,

1598 
	`rcu_ªad_lock
();

1601 i‡(
nŸif_vî
 < 4) {

1602 
vif
 = 
	`iwl_mvm_rcu_dîe„ªn˚_vif_id
(
mvm
, 
id
, 
åue
);

1604 
õì80211_bss_c⁄f
 *
bss_c⁄f
 =

1605 
	`iwl_mvm_rcu_fw_lök_id_to_lök_c⁄f
(
mvm
, 
id
, 
åue
);

1607 i‡(!
bss_c⁄f
)

1608 
out
;

1610 
vif
 = 
bss_c⁄f
->vif;

1613 
	`IWL_DEBUG_INFO
(
mvm
,

1615 
nŸif_vî
 < 4 ? "mac" : "link",

1616 
id
,

1617 
	`À32_to_˝u
(
mb
->
c⁄£c_mis£d_bóc⁄s
),

1618 
	`À32_to_˝u
(
mb
->
c⁄£c_mis£d_bóc⁄s_sö˚_œ°_rx
),

1619 
	`À32_to_˝u
(
mb
->
num_ªcvd_bóc⁄s
),

1620 
	`À32_to_˝u
(
mb
->
num_ex≥˘ed_bóc⁄s
));

1622 i‡(!
vif
)

1623 
out
;

1625 
mac_ty≥
 = 
	`iwl_mvm_gë_mac_ty≥
(
vif
);

1627 
	`IWL_DEBUG_INFO
(
mvm
, "mis£d bóc⁄ mac_ty≥=%u,\n", 
mac_ty≥
);

1629 
mvm
->
å™s
->
dbg
.
dump_fûe_«me_ext_vÆid
 = 
åue
;

1630 
	`¢¥ötf
(
mvm
->
å™s
->
dbg
.
dump_fûe_«me_ext
, 
IWL_FW_INI_MAX_NAME
,

1631 "MacId_%d_MacTy≥_%d", 
id
, 
mac_ty≥
);

1633 
rx_mis£d_bc⁄
 = 
	`À32_to_˝u
(
mb
->
c⁄£c_mis£d_bóc⁄s
);

1634 
rx_mis£d_bc⁄_sö˚_rx
 =

1635 
	`À32_to_˝u
(
mb
->
c⁄£c_mis£d_bóc⁄s_sö˚_œ°_rx
);

1640 i‡(
rx_mis£d_bc⁄
 >
IWL_MVM_MISSED_BEACONS_THRESHOLD_LONG
) {

1641 i‡(
rx_mis£d_bc⁄_sö˚_rx
 >
IWL_MVM_MISSED_BEACONS_SINCE_RX_THOLD
) {

1642 
	`iwl_mvm_c⁄√˘i⁄_loss
(
mvm
, 
vif
, "missed beacons");

1644 
	`IWL_WARN
(
mvm
,

1646 
	`IWL_WARN
(
mvm
,

1648 
rx_mis£d_bc⁄
, 
rx_mis£d_bc⁄_sö˚_rx
);

1650 } i‡(
rx_mis£d_bc⁄_sö˚_rx
 > 
IWL_MVM_MISSED_BEACONS_THRESHOLD
) {

1651 i‡(!
	`iwl_mvm_has_√w_tx_≠i
(
mvm
))

1652 
	`õì80211_bóc⁄_loss
(
vif
);

1654 
	`õì80211_cqm_bóc⁄_loss_nŸify
(
vif
, 
GFP_ATOMIC
);

1657 
	`iwl_dbg_év_time_poöt
(&
mvm
->
fwπ
,

1658 
IWL_FW_INI_TIME_POINT_MISSED_BEACONS
, &
ç_d©a
);

1660 
åiggî
 = 
	`iwl_fw_dbg_åiggî_⁄
(&
mvm
->
fwπ
, 
	`õì80211_vif_to_wdev
(
vif
),

1661 
FW_DBG_TRIGGER_MISSED_BEACONS
);

1662 i‡(!
åiggî
)

1663 
out
;

1665 
bc⁄_åig
 = (*)
åiggî
->
d©a
;

1666 
°›_åig_mis£d_bc⁄
 = 
	`À32_to_˝u
(
bc⁄_åig
->
°›_c⁄£c_mis£d_bc⁄
);

1667 
°›_åig_mis£d_bc⁄_sö˚_rx
 =

1668 
	`À32_to_˝u
(
bc⁄_åig
->
°›_c⁄£c_mis£d_bc⁄_sö˚_rx
);

1672 i‡(
rx_mis£d_bc⁄_sö˚_rx
 >
°›_åig_mis£d_bc⁄_sö˚_rx
 ||

1673 
rx_mis£d_bc⁄
 >
°›_åig_mis£d_bc⁄
)

1674 
	`iwl_fw_dbg_cﬁÀ˘_åig
(&
mvm
->
fwπ
, 
åiggî
, 
NULL
);

1676 
out
:

1677 
	`rcu_ªad_u∆ock
();

1678 
	}
}

1680 
	$iwl_mvm_rx_°‹ed_bóc⁄_nŸif
(
iwl_mvm
 *
mvm
,

1681 
iwl_rx_cmd_buf„r
 *
rxb
)

1683 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

1684 
pkt_Àn
 = 
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
);

1685 
iwl_°‹ed_bóc⁄_nŸif_comm⁄
 *
sb
 = (*)
pkt
->
d©a
;

1686 
õì80211_rx_°©us
 
rx_°©us
;

1687 
sk_buff
 *
skb
;

1688 
u8
 *
d©a
;

1689 
u32
 
size
 = 
	`À32_to_˝u
(
sb
->
byã_cou¡
);

1690 
vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
,

1691 
	`WIDE_ID
(
PROT_OFFLOAD_GROUP
, 
STORED_BEACON_NTF
),

1694 i‡(
size
 == 0)

1698 i‡(
vî
 <= 2) {

1699 
iwl_°‹ed_bóc⁄_nŸif_v2
 *
sb_v2
 = (*)
pkt
->
d©a
;

1701 i‡(
pkt_Àn
 < 
	`°ru˘_size
(
sb_v2
, 
d©a
, 
size
))

1704 
d©a
 = 
sb_v2
->data;

1706 
iwl_°‹ed_bóc⁄_nŸif_v3
 *
sb_v3
 = (*)
pkt
->
d©a
;

1708 i‡(
pkt_Àn
 < 
	`°ru˘_size
(
sb_v3
, 
d©a
, 
size
))

1711 
d©a
 = 
sb_v3
->data;

1714 
skb
 = 
	`Æloc_skb
(
size
, 
GFP_ATOMIC
);

1715 i‡(!
skb
) {

1716 
	`IWL_ERR
(
mvm
, "alloc_skb failed\n");

1721 
	`mem£t
(&
rx_°©us
, 0, (rx_status));

1722 
rx_°©us
.
ma˘ime
 = 
	`À64_to_˝u
(
sb
->
tsf
);

1724 
rx_°©us
.
Êag
 |
RX_FLAG_MACTIME_PLCP_START
;

1725 
rx_°©us
.
devi˚_time°amp
 = 
	`À32_to_˝u
(
sb
->
sy°em_time
);

1726 
rx_°©us
.
b™d
 =

1727 (
sb
->
b™d
 & 
	`˝u_to_À16
(
RX_RES_PHY_FLAGS_BAND_24
)) ?

1728 
NL80211_BAND_2GHZ
 : 
NL80211_BAND_5GHZ
;

1729 
rx_°©us
.
‰eq
 =

1730 
	`õì80211_ch™√l_to_‰equícy
(
	`À16_to_˝u
(
sb
->
ch™√l
),

1731 
rx_°©us
.
b™d
);

1734 
	`skb_put_d©a
(
skb
, 
d©a
, 
size
);

1735 
	`mem˝y
(
	`IEEE80211_SKB_RXCB
(
skb
), &
rx_°©us
, (rx_status));

1738 
	`õì80211_rx_«pi
(
mvm
->
hw
, 
NULL
, 
skb
, NULL);

1739 
	}
}

1741 
	$iwl_mvm_¥obe_ª•_d©a_nŸif
(
iwl_mvm
 *
mvm
,

1742 
iwl_rx_cmd_buf„r
 *
rxb
)

1744 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

1745 
iwl_¥obe_ª•_d©a_nŸif
 *
nŸif
 = (*)
pkt
->
d©a
;

1746 
iwl_¥obe_ª•_d©a
 *
ﬁd_d©a
, *
√w_d©a
;

1747 
u32
 
id
 = 
	`À32_to_˝u
(
nŸif
->
mac_id
);

1748 
õì80211_vif
 *
vif
;

1749 
iwl_mvm_vif
 *
mvmvif
;

1751 
	`IWL_DEBUG_INFO
(
mvm
, "ProbeÑesponse dataÇotif:Çoa %d, csa %d\n",

1752 
nŸif
->
nﬂ_a˘ive
,ÇŸif->
cß_cou¡î
);

1754 
vif
 = 
	`iwl_mvm_rcu_dîe„ªn˚_vif_id
(
mvm
, 
id
, 
Ál£
);

1755 i‡(!
vif
)

1758 
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1760 
√w_d©a
 = 
	`kzÆloc
((*√w_d©a), 
GFP_KERNEL
);

1761 i‡(!
√w_d©a
)

1764 
	`mem˝y
(&
√w_d©a
->
nŸif
,Çotif, (new_data->notif));

1767 
√w_d©a
->
nﬂ_Àn
 = (
õì80211_víd‹_õ
) +

1768 (
√w_d©a
->
nŸif
.
nﬂ_©å
) - 1;

1774 i‡(
√w_d©a
->
nŸif
.
nﬂ_©å
.
Àn_low
 ==

1775 (
õì80211_p2p_nﬂ_desc
) + 2)

1776 
√w_d©a
->
nﬂ_Àn
 -(
õì80211_p2p_nﬂ_desc
);

1778 
ﬁd_d©a
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvmvif
->
deÊök
.
¥obe_ª•_d©a
,

1779 
	`lockdï_is_hñd
(&
mvmvif
->
mvm
->
muãx
));

1780 
	`rcu_assign_poöãr
(
mvmvif
->
deÊök
.
¥obe_ª•_d©a
, 
√w_d©a
);

1782 i‡(
ﬁd_d©a
)

1783 
	`k‰ì_rcu
(
ﬁd_d©a
, 
rcu_hód
);

1785 i‡(
nŸif
->
cß_cou¡î
 !
IWL_PROBE_RESP_DATA_NO_CSA
 &&

1786 
nŸif
->
cß_cou¡î
 >= 1)

1787 
	`õì80211_bóc⁄_£t_˙tdwn
(
vif
, 
nŸif
->
cß_cou¡î
);

1788 
	}
}

1790 
	$iwl_mvm_ch™√l_swôch_°¨t_nŸif
(
iwl_mvm
 *
mvm
,

1791 
iwl_rx_cmd_buf„r
 *
rxb
)

1793 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

1794 
õì80211_vif
 *
cß_vif
, *
vif
;

1795 
iwl_mvm_vif
 *
mvmvif
, *
cß_mvmvif
;

1796 
u32
 
id_n_cﬁ‹
, 
cß_id
;

1798 
u32
 
id
;

1799 
u32
 
mac_lök_id
 = 0;

1800 
u8
 
nŸif_vî
 = 
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
MAC_CONF_GROUP
,

1801 
CHANNEL_SWITCH_START_NOTIF
, 0);

1802 
boﬁ
 
cß_a˘ive
;

1804 
	`rcu_ªad_lock
();

1806 i‡(
nŸif_vî
 < 3) {

1807 
iwl_ch™√l_swôch_°¨t_nŸif_v1
 *
nŸif
 = (*)
pkt
->
d©a
;

1808 
u32
 
mac_id
;

1810 
id_n_cﬁ‹
 = 
	`À32_to_˝u
(
nŸif
->
id_™d_cﬁ‹
);

1811 
mac_id
 = 
id_n_cﬁ‹
 & 
FW_CTXT_ID_MSK
;

1813 
vif
 = 
	`iwl_mvm_rcu_dîe„ªn˚_vif_id
(
mvm
, 
mac_id
, 
åue
);

1814 i‡(!
vif
)

1815 
out_u∆ock
;

1817 
id
 = 
mac_id
;

1818 
cß_a˘ive
 = 
vif
->
bss_c⁄f
.csa_active;

1820 
iwl_ch™√l_swôch_°¨t_nŸif
 *
nŸif
 = (*)
pkt
->
d©a
;

1821 
u32
 
lök_id
 = 
	`À32_to_˝u
(
nŸif
->link_id);

1822 
õì80211_bss_c⁄f
 *
bss_c⁄f
 =

1823 
	`iwl_mvm_rcu_fw_lök_id_to_lök_c⁄f
(
mvm
, 
lök_id
, 
åue
);

1825 i‡(!
bss_c⁄f
)

1826 
out_u∆ock
;

1828 
id
 = 
lök_id
;

1829 
mac_lök_id
 = 
bss_c⁄f
->
lök_id
;

1830 
vif
 = 
bss_c⁄f
->vif;

1831 
cß_a˘ive
 = 
bss_c⁄f
->csa_active;

1834 
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1835 i‡(
nŸif_vî
 >= 3)

1836 
id_n_cﬁ‹
 = 
	`FW_CMD_ID_AND_COLOR
(
mvmvif
->
id
, mvmvif->
cﬁ‹
);

1838 
vif
->
ty≥
) {

1839 
NL80211_IFTYPE_AP
:

1840 
cß_vif
 = 
	`rcu_dîe„ªn˚
(
mvm
->csa_vif);

1841 i‡(
	`WARN_ON
(!
cß_vif
 || !cß_vif->
bss_c⁄f
.
cß_a˘ive
 ||

1842 
cß_vif
 !
vif
))

1843 
out_u∆ock
;

1845 
cß_mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
cß_vif
);

1846 
cß_id
 = 
	`FW_CMD_ID_AND_COLOR
(
cß_mvmvif
->
id
, cß_mvmvif->
cﬁ‹
);

1847 i‡(
	`WARN
(
cß_id
 !
id_n_cﬁ‹
,

1849 
cß_id
, 
id_n_cﬁ‹
))

1850 
out_u∆ock
;

1852 
	`IWL_DEBUG_INFO
(
mvm
, "Channel Switch Started Notification\n");

1854 
	`scheduÀ_dñayed_w‹k
(&
mvm
->
cs_tx_unblock_dw‹k
,

1855 
	`m£cs_to_jiffõs
(
IWL_MVM_CS_UNBLOCK_TX_TIMEOUT
 *

1856 
cß_vif
->
bss_c⁄f
.
bóc⁄_öt
));

1858 
	`õì80211_cß_föish
(
cß_vif
, 0);

1860 
	`rcu_ªad_u∆ock
();

1862 
	`RCU_INIT_POINTER
(
mvm
->
cß_vif
, 
NULL
);

1864 
NL80211_IFTYPE_STATION
:

1869 i‡(
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
MAC_CONF_GROUP
,

1870 
CHANNEL_SWITCH_ERROR_NOTIF
,

1871 0Ë&& !
cß_a˘ive
) {

1872 
	`IWL_DEBUG_INFO
(
mvm
, "Channel Switch was canceled\n");

1873 
	`iwl_mvm_ˇn˚l_ch™√l_swôch
(
mvm
, 
vif
, 
id
);

1877 
	`iwl_mvm_cß_˛õ¡_ab£¡
(
mvm
, 
vif
);

1878 
	`ˇn˚l_dñayed_w‹k
(&
mvmvif
->
cß_w‹k
);

1879 
	`õì80211_chswôch_d⁄e
(
vif
, 
åue
, 
mac_lök_id
);

1883 
	`WARN_ON_ONCE
(1);

1886 
out_u∆ock
:

1887 
	`rcu_ªad_u∆ock
();

1888 
	}
}

1890 
	$iwl_mvm_ch™√l_swôch_îr‹_nŸif
(
iwl_mvm
 *
mvm
,

1891 
iwl_rx_cmd_buf„r
 *
rxb
)

1893 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

1894 
iwl_ch™√l_swôch_îr‹_nŸif
 *
nŸif
 = (*)
pkt
->
d©a
;

1895 
õì80211_vif
 *
vif
;

1896 
u32
 
id
 = 
	`À32_to_˝u
(
nŸif
->
lök_id
);

1897 
u32
 
cß_îr_mask
 = 
	`À32_to_˝u
(
nŸif
->csa_err_mask);

1899 
	`rcu_ªad_lock
();

1900 
vif
 = 
	`iwl_mvm_rcu_dîe„ªn˚_vif_id
(
mvm
, 
id
, 
åue
);

1901 i‡(!
vif
) {

1902 
	`rcu_ªad_u∆ock
();

1906 
	`IWL_DEBUG_INFO
(
mvm
, "FWÑeports CSAÉrror: id=%u, csa_err_mask=%u\n",

1907 
id
, 
cß_îr_mask
);

1908 i‡(
cß_îr_mask
 & (
CS_ERR_COUNT_ERROR
 |

1909 
CS_ERR_LONG_DELAY_AFTER_CS
 |

1910 
CS_ERR_TX_BLOCK_TIMER_EXPIRED
))

1911 
	`õì80211_ch™√l_swôch_disc⁄√˘
(
vif
, 
åue
);

1912 
	`rcu_ªad_u∆ock
();

1913 
	}
}

1915 
	$iwl_mvm_rx_mis£d_v≠_nŸif
(
iwl_mvm
 *
mvm
,

1916 
iwl_rx_cmd_buf„r
 *
rxb
)

1918 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

1919 
iwl_mis£d_v≠_nŸif
 *
mb
 = (*)
pkt
->
d©a
;

1920 
õì80211_vif
 *
vif
;

1921 
u32
 
id
 = 
	`À32_to_˝u
(
mb
->
mac_id
);

1923 
	`IWL_DEBUG_INFO
(
mvm
,

1925 
	`À32_to_˝u
(
mb
->
mac_id
),

1926 
mb
->
num_bóc⁄_öãrvÆs_ñ≠£d
,

1927 
mb
->
¥ofûe_≥riodicôy
);

1929 
	`rcu_ªad_lock
();

1931 
vif
 = 
	`iwl_mvm_rcu_dîe„ªn˚_vif_id
(
mvm
, 
id
, 
åue
);

1932 i‡(
vif
)

1933 
	`iwl_mvm_c⁄√˘i⁄_loss
(
mvm
, 
vif
, "missed vap beacon");

1935 
	`rcu_ªad_u∆ock
();

1936 
	}
}

	@mac80211.c

7 
	~<löux/kî√l.h
>

8 
	~<löux/¶ab.h
>

9 
	~<löux/skbuff.h
>

10 
	~<löux/√tdevi˚.h
>

11 
	~<löux/ëhîdevi˚.h
>

12 
	~<löux/ù.h
>

13 
	~<löux/if_¨p.h
>

14 
	~<löux/time.h
>

15 
	~<√t/mac80211.h
>

16 
	~<√t/õì80211_ødiŸ≠.h
>

17 
	~<√t/t˝.h
>

19 
	~"iwl-drv.h
"

20 
	~"iwl-›-mode.h
"

21 
	~"iwl-io.h
"

22 
	~"mvm.h
"

23 
	~"°a.h
"

24 
	~"time-evít.h
"

25 
	~"iwl-ì¥om-∑r£.h
"

26 
	~"iwl-phy-db.h
"

27 
	~"ã°mode.h
"

28 
	~"fw/îr‹-dump.h
"

29 
	~"iwl-¥ph.h
"

30 
	~"iwl-nvm-∑r£.h
"

31 
	~"time-sync.h
"

33 c⁄° 
õì80211_iÁ˚_limô
 
	giwl_mvm_limôs
[] = {

35 .
max
 = 1,

36 .
	gty≥s
 = 
BIT
(
NL80211_IFTYPE_STATION
),

39 .
	gmax
 = 1,

40 .
	gty≥s
 = 
BIT
(
NL80211_IFTYPE_AP
) |

41 
BIT
(
NL80211_IFTYPE_P2P_CLIENT
) |

42 
BIT
(
NL80211_IFTYPE_P2P_GO
),

45 .
	gmax
 = 1,

46 .
	gty≥s
 = 
BIT
(
NL80211_IFTYPE_P2P_DEVICE
),

50 c⁄° 
õì80211_iÁ˚_combö©i⁄
 
	giwl_mvm_iÁ˚_combö©i⁄s
[] = {

52 .
num_dif„ª¡_ch™√ls
 = 2,

53 .
	gmax_öãrÁ˚s
 = 3,

54 .
	glimôs
 = 
iwl_mvm_limôs
,

55 .
	gn_limôs
 = 
ARRAY_SIZE
(
iwl_mvm_limôs
),

59 c⁄° 
cfg80211_pm§_ˇ∑bûôõs
 
	giwl_mvm_pm§_ˇ∑
 = {

60 .
max_≥îs
 = 
IWL_MVM_TOF_MAX_APS
,

61 .
	gªp‹t_≠_tsf
 = 1,

62 .
	gøndomize_mac_addr
 = 1,

64 .
	g·m
 = {

65 .
suµ‹ãd
 = 1,

66 .
	gaßp
 = 1,

67 .
	gn⁄_aßp
 = 1,

68 .
	gªque°_lci
 = 1,

69 .
	gªque°_civi˛oc
 = 1,

70 .
	gåiggî_ba£d
 = 1,

71 .
	gn⁄_åiggî_ba£d
 = 1,

72 .
	gmax_bur°s_exp⁄ít
 = -1,

73 .
	gmax_·ms_≥r_bur°
 = 0,

74 .
	gb™dwidths
 = 
BIT
(
NL80211_CHAN_WIDTH_20_NOHT
) |

75 
BIT
(
NL80211_CHAN_WIDTH_20
) |

76 
BIT
(
NL80211_CHAN_WIDTH_40
) |

77 
BIT
(
NL80211_CHAN_WIDTH_80
) |

78 
BIT
(
NL80211_CHAN_WIDTH_160
),

79 .
	g¥ómbÀs
 = 
BIT
(
NL80211_PREAMBLE_LEGACY
) |

80 
BIT
(
NL80211_PREAMBLE_HT
) |

81 
BIT
(
NL80211_PREAMBLE_VHT
) |

82 
BIT
(
NL80211_PREAMBLE_HE
),

86 
__iwl_mvm_mac_£t_key
(
õì80211_hw
 *
hw
,

87 
£t_key_cmd
 
cmd
,

88 
õì80211_vif
 *
vif
,

89 
õì80211_°a
 *
°a
,

90 
õì80211_key_c⁄f
 *
key
);

92 
	$iwl_mvm_ª£t_phy_˘xts
(
iwl_mvm
 *
mvm
)

94 
i
;

96 
	`mem£t
(
mvm
->
phy_˘xts
, 0, (mvm->phy_ctxts));

97 
i
 = 0; i < 
NUM_PHY_CTX
; i++) {

98 
mvm
->
phy_˘xts
[
i
].
id
 = i;

99 
mvm
->
phy_˘xts
[
i
].
ªf
 = 0;

101 
	}
}

103 
õì80211_ªgdomaö
 *
	$iwl_mvm_gë_ªgdomaö
(
wùhy
 *wiphy,

104 c⁄° *
Æpha2
,

105 
iwl_mcc_sour˚
 
§c_id
,

106 
boﬁ
 *
ch™ged
)

108 
õì80211_ªgdomaö
 *
ªgd
 = 
NULL
;

109 
õì80211_hw
 *
hw
 = 
	`wùhy_to_õì80211_hw
(
wùhy
);

110 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

111 
iwl_mcc_upd©e_ª•_v8
 *
ª•
;

112 
u8
 
ª•_vî
;

114 
	`IWL_DEBUG_LAR
(
mvm
, "GëtögÑegdomaö d©®f‹ %†‰om FW\n", 
Æpha2
);

116 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

118 
ª•
 = 
	`iwl_mvm_upd©e_mcc
(
mvm
, 
Æpha2
, 
§c_id
);

119 i‡(
	`IS_ERR_OR_NULL
(
ª•
)) {

120 
	`IWL_DEBUG_LAR
(
mvm
, "CouldÇot get update from FW %d\n",

121 
	`PTR_ERR_OR_ZERO
(
ª•
));

122 
ª•
 = 
NULL
;

123 
out
;

126 i‡(
ch™ged
) {

127 
u32
 
°©us
 = 
	`À32_to_˝u
(
ª•
->status);

129 *
ch™ged
 = (
°©us
 =
MCC_RESP_NEW_CHAN_PROFILE
 ||

130 
°©us
 =
MCC_RESP_ILLEGAL
);

132 
ª•_vî
 = 
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
IWL_ALWAYS_LONG_GROUP
,

133 
MCC_UPDATE_CMD
, 0);

134 
	`IWL_DEBUG_LAR
(
mvm
, "MCC upd©êª•⁄£ vîsi⁄: %d\n", 
ª•_vî
);

136 
ªgd
 = 
	`iwl_∑r£_nvm_mcc_öfo
(
mvm
->
å™s
->
dev
, mvm->
cfg
,

137 
	`__À32_to_˝u
(
ª•
->
n_ch™√ls
),

138 
ª•
->
ch™√ls
,

139 
	`__À16_to_˝u
(
ª•
->
mcc
),

140 
	`__À16_to_˝u
(
ª•
->
geo_öfo
),

141 
	`À32_to_˝u
(
ª•
->
ˇp
), 
ª•_vî
,

142 
mvm
->
fwπ
.
u©s_íabÀd
);

144 
§c_id
 = 
ª•
->
sour˚_id
;

145 i‡(
	`IS_ERR_OR_NULL
(
ªgd
)) {

146 
	`IWL_DEBUG_LAR
(
mvm
, "CouldÇot getÖarse update from FW %d\n",

147 
	`PTR_ERR_OR_ZERO
(
ªgd
));

148 
out
;

151 
	`IWL_DEBUG_LAR
(
mvm
, "settingálpha2 from FWÅo %s (0x%x, 0x%x) src=%d\n",

152 
ªgd
->
Æpha2
,Ñegd->Æpha2[0],Ñegd->Æpha2[1], 
§c_id
);

153 
mvm
->
œr_ªgdom_£t
 = 
åue
;

154 
mvm
->
mcc_§c
 = 
§c_id
;

160 i‡(
ª•
->
mcc
 =
	`˝u_to_À16
(
IWL_MCC_US
) ||

161 
ª•
->
mcc
 =
	`˝u_to_À16
(
IWL_MCC_CANADA
))

162 
	`õì80211_hw_£t
(
mvm
->
hw
, 
DISALLOW_PUNCTURING
);

164 
	`__˛ór_bô
(
IEEE80211_HW_DISALLOW_PUNCTURING
, 
mvm
->
hw
->
Êags
);

166 
	`iwl_mei_£t_cou¡ry_code
(
	`__À16_to_˝u
(
ª•
->
mcc
));

168 
out
:

169 
	`k‰ì
(
ª•
);

170  
ªgd
;

171 
	}
}

173 
	$iwl_mvm_upd©e_ch™ged_ªgdom
(
iwl_mvm
 *
mvm
)

175 
boﬁ
 
ch™ged
;

176 
õì80211_ªgdomaö
 *
ªgd
;

178 i‡(!
	`iwl_mvm_is_œr_suµ‹ãd
(
mvm
))

181 
ªgd
 = 
	`iwl_mvm_gë_cuºít_ªgdomaö
(
mvm
, &
ch™ged
);

182 i‡(!
	`IS_ERR_OR_NULL
(
ªgd
)) {

184 i‡(
ch™ged
)

185 
	`ªguœt‹y_£t_wùhy_ªgd
(
mvm
->
hw
->
wùhy
, 
ªgd
);

187 
	`k‰ì
(
ªgd
);

189 
	}
}

191 
õì80211_ªgdomaö
 *
	$iwl_mvm_gë_cuºít_ªgdomaö
(
iwl_mvm
 *
mvm
,

192 
boﬁ
 *
ch™ged
)

194  
	`iwl_mvm_gë_ªgdomaö
(
mvm
->
hw
->
wùhy
, "ZZ",

195 
	`iwl_mvm_is_wifi_mcc_suµ‹ãd
(
mvm
) ?

196 
MCC_SOURCE_GET_CURRENT
 :

197 
MCC_SOURCE_OLD_FW
, 
ch™ged
);

198 
	}
}

200 
	$iwl_mvm_öô_fw_ªgd
(
iwl_mvm
 *
mvm
, 
boﬁ
 
f‹˚_ªgd_sync
)

202 
iwl_mcc_sour˚
 
u£d_§c
;

203 
õì80211_ªgdomaö
 *
ªgd
;

204 
ªt
;

205 
boﬁ
 
ch™ged
;

206 c⁄° 
õì80211_ªgdomaö
 *
r
 =

207 
	`wùhy_dîe„ªn˚
(
mvm
->
hw
->
wùhy
, mvm->hw->wùhy->
ªgd
);

209 i‡(!
r
)

210  -
ENOENT
;

213 
u£d_§c
 = 
mvm
->
mcc_§c
;

214 i‡(
	`iwl_mvm_is_wifi_mcc_suµ‹ãd
(
mvm
)) {

216 
ªgd
 = 
	`iwl_mvm_gë_cuºít_ªgdomaö
(
mvm
, 
NULL
);

217 i‡(!
	`IS_ERR_OR_NULL
(
ªgd
))

218 
	`k‰ì
(
ªgd
);

222 
ªgd
 = 
	`iwl_mvm_gë_ªgdomaö
(
mvm
->
hw
->
wùhy
, 
r
->
Æpha2
, 
u£d_§c
,

223 &
ch™ged
);

224 i‡(
	`IS_ERR_OR_NULL
(
ªgd
))

225  -
EIO
;

230 i‡(
ch™ged
 || 
f‹˚_ªgd_sync
)

231 
ªt
 = 
	`ªguœt‹y_£t_wùhy_ªgd_sync
(
mvm
->
hw
->
wùhy
, 
ªgd
);

233 
ªt
 = 0;

235 
	`k‰ì
(
ªgd
);

236  
ªt
;

237 
	}
}

240 c⁄° 
u8
 
	ghe_if_ty≥s_ext_ˇ∑_°a
[] = {

241 [0] = 
WLAN_EXT_CAPA1_EXT_CHANNEL_SWITCHING
,

242 [2] = 
WLAN_EXT_CAPA3_MULTI_BSSID_SUPPORT
,

243 [7] = 
WLAN_EXT_CAPA8_OPMODE_NOTIF
 |

244 
WLAN_EXT_CAPA8_MAX_MSDU_IN_AMSDU_LSB
,

245 [8] = 
WLAN_EXT_CAPA9_MAX_MSDU_IN_AMSDU_MSB
,

248 c⁄° 
u8
 
	gtm_if_ty≥s_ext_ˇ∑_°a
[] = {

249 [0] = 
WLAN_EXT_CAPA1_EXT_CHANNEL_SWITCHING
,

250 [2] = 
WLAN_EXT_CAPA3_MULTI_BSSID_SUPPORT
 |

251 
WLAN_EXT_CAPA3_TIMING_MEASUREMENT_SUPPORT
,

252 [7] = 
WLAN_EXT_CAPA8_OPMODE_NOTIF
 |

253 
WLAN_EXT_CAPA8_MAX_MSDU_IN_AMSDU_LSB
,

254 [8] = 
WLAN_EXT_CAPA9_MAX_MSDU_IN_AMSDU_MSB
,

255 [9] = 
WLAN_EXT_CAPA10_TWT_REQUESTER_SUPPORT
,

262 
	#IWL_MVM_EMLSR_CAPA
 (
IEEE80211_EML_CAP_EMLSR_SUPP
 | \

263 
IEEE80211_EML_CAP_EMLSR_PADDING_DELAY_32US
 << \

264 
	`__bf_shf
(
IEEE80211_EML_CAP_EMLSR_PADDING_DELAY
) | \

265 
IEEE80211_EML_CAP_EMLSR_TRANSITION_DELAY_64US
 << \

266 
	`__bf_shf
(
IEEE80211_EML_CAP_EMLSR_TRANSITION_DELAY
))

	)

267 
	#IWL_MVM_MLD_CAPA_OPS
 
	`FIELD_PREP_CONST
( \

268 
IEEE80211_MLD_CAP_OP_TID_TO_LINK_MAP_NEG_SUPP
, \

269 
IEEE80211_MLD_CAP_OP_TID_TO_LINK_MAP_NEG_SUPP_SAME
)

	)

271 c⁄° 
wùhy_i·y≥_ext_ˇ∑b
 
	gadd_i·y≥s_ext_ˇ∑
[] = {

273 .
i·y≥
 = 
NL80211_IFTYPE_STATION
,

274 .
	gexãnded_ˇ∑bûôõs
 = 
he_if_ty≥s_ext_ˇ∑_°a
,

275 .
	gexãnded_ˇ∑bûôõs_mask
 = 
he_if_ty≥s_ext_ˇ∑_°a
,

276 .
	gexãnded_ˇ∑bûôõs_Àn
 = (
he_if_ty≥s_ext_ˇ∑_°a
),

278 .
	geml_ˇ∑bûôõs
 = 
IWL_MVM_EMLSR_CAPA
,

279 .
	gmld_ˇ∑_™d_›s
 = 
IWL_MVM_MLD_CAPA_OPS
,

282 .
	gi·y≥
 = 
NL80211_IFTYPE_STATION
,

283 .
	gexãnded_ˇ∑bûôõs
 = 
tm_if_ty≥s_ext_ˇ∑_°a
,

284 .
	gexãnded_ˇ∑bûôõs_mask
 = 
tm_if_ty≥s_ext_ˇ∑_°a
,

285 .
	gexãnded_ˇ∑bûôõs_Àn
 = (
tm_if_ty≥s_ext_ˇ∑_°a
),

287 .
	geml_ˇ∑bûôõs
 = 
IWL_MVM_EMLSR_CAPA
,

288 .
	gmld_ˇ∑_™d_›s
 = 
IWL_MVM_MLD_CAPA_OPS
,

292 
	$iwl_mvm_›_gë_™ã¬a
(
õì80211_hw
 *
hw
, 
u32
 *
tx_™t
, u32 *
rx_™t
)

294 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

295 *
tx_™t
 = 
	`iwl_mvm_gë_vÆid_tx_™t
(
mvm
);

296 *
rx_™t
 = 
	`iwl_mvm_gë_vÆid_rx_™t
(
mvm
);

298 
	}
}

300 
	$iwl_mvm_›_£t_™ã¬a
(
õì80211_hw
 *
hw
, 
u32
 
tx_™t
, u32 
rx_™t
)

302 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

305 i‡(
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 !
IWL_DEVICE_FAMILY_9000
 &&

306 
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 !
IWL_DEVICE_FAMILY_22000
)

307  -
EOPNOTSUPP
;

309 i‡(!
mvm
->
nvm_d©a
)

310  -
EBUSY
;

316 
mvm
->
£t_tx_™t
 = 
tx_™t
;

317 
mvm
->
£t_rx_™t
 = 
rx_™t
;

319 
	`iwl_ªöô_ˇb
(
mvm
->
å™s
, mvm->
nvm_d©a
, 
tx_™t
, 
rx_™t
, mvm->
fw
);

322 
	}
}

324 
	$iwl_mvm_mac_£tup_ªgi°î
(
iwl_mvm
 *
mvm
)

326 
õì80211_hw
 *
hw
 = 
mvm
->hw;

327 
num_mac
, 
ªt
, 
i
;

328 c⁄° 
u32
 
mvm_cùhîs
[] = {

329 
WLAN_CIPHER_SUITE_WEP40
,

330 
WLAN_CIPHER_SUITE_WEP104
,

331 
WLAN_CIPHER_SUITE_TKIP
,

332 
WLAN_CIPHER_SUITE_CCMP
,

334 #ifde‡
CONFIG_PM_SLEEP


335 
boﬁ
 
unifõd
 = 
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

336 
IWL_UCODE_TLV_CAPA_CNSLDTD_D3_D0_IMG
);

338 
u32
 
£c_key_id
 = 
	`WIDE_ID
(
DATA_PATH_GROUP
, 
SEC_KEY_CMD
);

339 
u8
 
£c_key_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
£c_key_id
, 0);

342 
	`õì80211_hw_£t
(
hw
, 
SIGNAL_DBM
);

343 
	`õì80211_hw_£t
(
hw
, 
SPECTRUM_MGMT
);

344 
	`õì80211_hw_£t
(
hw
, 
REPORTS_TX_ACK_STATUS
);

345 
	`õì80211_hw_£t
(
hw
, 
WANT_MONITOR_VIF
);

346 
	`õì80211_hw_£t
(
hw
, 
SUPPORTS_PS
);

347 
	`õì80211_hw_£t
(
hw
, 
SUPPORTS_DYNAMIC_PS
);

348 
	`õì80211_hw_£t
(
hw
, 
AMPDU_AGGREGATION
);

349 
	`õì80211_hw_£t
(
hw
, 
CONNECTION_MONITOR
);

350 
	`õì80211_hw_£t
(
hw
, 
CHANCTX_STA_CSA
);

351 
	`õì80211_hw_£t
(
hw
, 
SUPPORT_FAST_XMIT
);

352 
	`õì80211_hw_£t
(
hw
, 
SUPPORTS_CLONED_SKBS
);

353 
	`õì80211_hw_£t
(
hw
, 
SUPPORTS_AMSDU_IN_AMPDU
);

354 
	`õì80211_hw_£t
(
hw
, 
NEEDS_UNIQUE_STA_ADDR
);

355 
	`õì80211_hw_£t
(
hw
, 
SUPPORTS_VHT_EXT_NSS_BW
);

356 
	`õì80211_hw_£t
(
hw
, 
BUFF_MMPDU_TXQ
);

357 
	`õì80211_hw_£t
(
hw
, 
STA_MMPDU_TXQ
);

360 i‡(
mvm
->
mld_≠i_is_u£d
 && mvm->
nvm_d©a
->
sku_ˇp_11be_íabÀ
 &&

361 !
iwlwifi_mod_∑øms
.
dißbÀ_11ax
 &&

362 !
iwlwifi_mod_∑øms
.
dißbÀ_11be
)

363 
hw
->
wùhy
->
Êags
 |
WIPHY_FLAG_DISABLE_WEXT
;

368 i‡(!
mvm
->
mld_≠i_is_u£d
)

369 
	`õì80211_hw_£t
(
hw
, 
TIMING_BEACON_ONLY
);

374 i‡(!(
hw
->
wùhy
->
Êags
 & 
WIPHY_FLAG_SUPPORTS_MLO
))

375 
	`õì80211_hw_£t
(
hw
, 
DEAUTH_NEED_MGD_TX_PREP
);

388 i‡(
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 >
IWL_DEVICE_FAMILY_9000
)

389 
	`õì80211_hw_£t
(
hw
, 
TX_AMSDU
);

390 
	`õì80211_hw_£t
(
hw
, 
TX_FRAG_LIST
);

392 i‡(
	`iwl_mvm_has_éc_ofÊﬂd
(
mvm
)) {

393 
	`õì80211_hw_£t
(
hw
, 
TX_AMPDU_SETUP_IN_HW
);

394 
	`õì80211_hw_£t
(
hw
, 
HAS_RATE_CONTROL
);

398 i‡(
	`iwl_mvm_has_√w_rx_≠i
(
mvm
) &&

399 
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 > 
IWL_DEVICE_FAMILY_9000
)

400 
	`õì80211_hw_£t
(
hw
, 
SUPPORTS_REORDERING_BUFFER
);

402 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

403 
IWL_UCODE_TLV_CAPA_STA_PM_NOTIF
)) {

404 
	`õì80211_hw_£t
(
hw
, 
AP_LINK_PS
);

405 } i‡(
	`WARN_ON
(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
))) {

411  -
EINVAL
;

414 i‡(
mvm
->
å™s
->
num_rx_queues
 > 1)

415 
	`õì80211_hw_£t
(
hw
, 
USES_RSS
);

417 i‡(
mvm
->
å™s
->
max_skb_‰ags
)

418 
hw
->
√tdev_„©uªs
 = 
NETIF_F_HIGHDMA
 | 
NETIF_F_SG
;

420 
hw
->
queues
 = 
IEEE80211_NUM_ACS
;

421 
hw
->
offch™√l_tx_hw_queue
 = 
IWL_MVM_OFFCHANNEL_QUEUE
;

422 
hw
->
ødiŸ≠_mcs_dëaûs
 |
IEEE80211_RADIOTAP_MCS_HAVE_FEC
 |

423 
IEEE80211_RADIOTAP_MCS_HAVE_STBC
;

424 
hw
->
ødiŸ≠_vht_dëaûs
 |
IEEE80211_RADIOTAP_VHT_KNOWN_STBC
 |

425 
IEEE80211_RADIOTAP_VHT_KNOWN_BEAMFORMED
;

427 
hw
->
ødiŸ≠_time°amp
.
unôs_pos
 =

428 
IEEE80211_RADIOTAP_TIMESTAMP_UNIT_US
 |

429 
IEEE80211_RADIOTAP_TIMESTAMP_SPOS_PLCP_SIG_ACQ
;

431 
hw
->
ødiŸ≠_time°amp
.
accuøcy
 = 22;

433 i‡(!
	`iwl_mvm_has_éc_ofÊﬂd
(
mvm
))

434 
hw
->
øã_c⁄åﬁ_Æg‹ôhm
 = 
RS_NAME
;

436 
hw
->
u≠sd_queues
 = 
IWL_MVM_UAPSD_QUEUES
;

437 
hw
->
u≠sd_max_•_Àn
 = 
IWL_UAPSD_MAX_SP
;

438 
hw
->
max_tx_‰agmíts
 = 
mvm
->
å™s
->
max_skb_‰ags
;

440 
	`BUILD_BUG_ON
(
	`ARRAY_SIZE
(
mvm
->
cùhîs
Ë< ARRAY_SIZE(
mvm_cùhîs
) + 6);

441 
	`mem˝y
(
mvm
->
cùhîs
, 
mvm_cùhîs
, (mvm_ciphers));

442 
hw
->
wùhy
->
n_cùhî_suôes
 = 
	`ARRAY_SIZE
(
mvm_cùhîs
);

443 
hw
->
wùhy
->
cùhî_suôes
 = 
mvm
->
cùhîs
;

445 i‡(
	`iwl_mvm_has_√w_rx_≠i
(
mvm
)) {

446 
mvm
->
cùhîs
[
hw
->
wùhy
->
n_cùhî_suôes
] =

447 
WLAN_CIPHER_SUITE_GCMP
;

448 
hw
->
wùhy
->
n_cùhî_suôes
++;

449 
mvm
->
cùhîs
[
hw
->
wùhy
->
n_cùhî_suôes
] =

450 
WLAN_CIPHER_SUITE_GCMP_256
;

451 
hw
->
wùhy
->
n_cùhî_suôes
++;

454 i‡(
iwlwifi_mod_∑øms
.
sw¸y±o
)

455 
	`IWL_ERR
(
mvm
,

457 i‡(!
iwlwifi_mod_∑øms
.
bt_c€x_a˘ive
)

458 
	`IWL_ERR
(
mvm
,

461 
	`õì80211_hw_£t
(
hw
, 
MFP_CAPABLE
);

462 
mvm
->
cùhîs
[
hw
->
wùhy
->
n_cùhî_suôes
] = 
WLAN_CIPHER_SUITE_AES_CMAC
;

463 
hw
->
wùhy
->
n_cùhî_suôes
++;

464 i‡(
	`iwl_mvm_has_√w_rx_≠i
(
mvm
)) {

465 
mvm
->
cùhîs
[
hw
->
wùhy
->
n_cùhî_suôes
] =

466 
WLAN_CIPHER_SUITE_BIP_GMAC_128
;

467 
hw
->
wùhy
->
n_cùhî_suôes
++;

468 
mvm
->
cùhîs
[
hw
->
wùhy
->
n_cùhî_suôes
] =

469 
WLAN_CIPHER_SUITE_BIP_GMAC_256
;

470 
hw
->
wùhy
->
n_cùhî_suôes
++;

473 
	`wùhy_ext_„©uª_£t
(
hw
->
wùhy
,

474 
NL80211_EXT_FEATURE_BEACON_RATE_LEGACY
);

475 
	`wùhy_ext_„©uª_£t
(
hw
->
wùhy
,

476 
NL80211_EXT_FEATURE_SCAN_MIN_PREQ_CONTENT
);

478 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

479 
IWL_UCODE_TLV_CAPA_FTM_CALIBRATED
)) {

480 
	`wùhy_ext_„©uª_£t
(
hw
->
wùhy
,

481 
NL80211_EXT_FEATURE_ENABLE_FTM_RESPONDER
);

482 
hw
->
wùhy
->
pm§_ˇ∑
 = &
iwl_mvm_pm§_ˇ∑
;

485 i‡(
£c_key_vî
 &&

486 
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

487 
IWL_UCODE_TLV_CAPA_BIGTK_TX_SUPPORT
))

488 
	`wùhy_ext_„©uª_£t
(
hw
->
wùhy
,

489 
NL80211_EXT_FEATURE_BEACON_PROTECTION
);

490 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

491 
IWL_UCODE_TLV_CAPA_BIGTK_SUPPORT
))

492 
	`wùhy_ext_„©uª_£t
(
hw
->
wùhy
,

493 
NL80211_EXT_FEATURE_BEACON_PROTECTION_CLIENT
);

495 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

496 
IWL_UCODE_TLV_CAPA_TIME_SYNC_BOTH_FTM_TM
))

497 
hw
->
wùhy
->
hw_time°amp_max_≥îs
 = 1;

499 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

500 
IWL_UCODE_TLV_CAPA_SPP_AMSDU_SUPPORT
))

501 
	`wùhy_ext_„©uª_£t
(
hw
->
wùhy
,

502 
NL80211_EXT_FEATURE_SPP_AMSDU_SUPPORT
);

504 
	`õì80211_hw_£t
(
hw
, 
SINGLE_SCAN_ON_ALL_BANDS
);

505 
hw
->
wùhy
->
„©uªs
 |=

506 
NL80211_FEATURE_SCHED_SCAN_RANDOM_MAC_ADDR
 |

507 
NL80211_FEATURE_SCAN_RANDOM_MAC_ADDR
 |

508 
NL80211_FEATURE_ND_RANDOM_MAC_ADDR
;

510 
hw
->
°a_d©a_size
 = (
iwl_mvm_°a
);

511 
hw
->
vif_d©a_size
 = (
iwl_mvm_vif
);

512 
hw
->
ch™˘x_d©a_size
 = (
u16
);

513 
hw
->
txq_d©a_size
 = (
iwl_mvm_txq
);

515 
hw
->
wùhy
->
öãrÁ˚_modes
 = 
	`BIT
(
NL80211_IFTYPE_STATION
) |

516 
	`BIT
(
NL80211_IFTYPE_P2P_CLIENT
) |

517 
	`BIT
(
NL80211_IFTYPE_AP
) |

518 
	`BIT
(
NL80211_IFTYPE_P2P_GO
) |

519 
	`BIT
(
NL80211_IFTYPE_P2P_DEVICE
) |

520 
	`BIT
(
NL80211_IFTYPE_ADHOC
);

522 
hw
->
wùhy
->
Êags
 |
WIPHY_FLAG_IBSS_RSN
;

523 
	`wùhy_ext_„©uª_£t
(
hw
->
wùhy
, 
NL80211_EXT_FEATURE_VHT_IBSS
);

529 i‡(!
	`iwl_mvm_has_√w_tx_≠i
(
mvm
))

530 
	`wùhy_ext_„©uª_£t
(
hw
->
wùhy
,

531 
NL80211_EXT_FEATURE_EXT_KEY_ID
);

532 
hw
->
wùhy
->
„©uªs
 |
NL80211_FEATURE_HT_IBSS
;

534 
hw
->
wùhy
->
ªguœt‹y_Êags
 |
REGULATORY_ENABLE_RELAX_NO_IR
;

535 i‡(
	`iwl_mvm_is_œr_suµ‹ãd
(
mvm
))

536 
hw
->
wùhy
->
ªguœt‹y_Êags
 |
REGULATORY_WIPHY_SELF_MANAGED
;

538 
hw
->
wùhy
->
ªguœt‹y_Êags
 |
REGULATORY_CUSTOM_REG
 |

539 
REGULATORY_DISABLE_BEACON_HINTS
;

541 i‡(
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 >
IWL_DEVICE_FAMILY_AX210
)

542 
	`wùhy_ext_„©uª_£t
(
hw
->
wùhy
,

543 
NL80211_EXT_FEATURE_DFS_CONCURRENT
);

545 
hw
->
wùhy
->
Êags
 |
WIPHY_FLAG_AP_UAPSD
;

546 
hw
->
wùhy
->
Êags
 |
WIPHY_FLAG_HAS_CHANNEL_SWITCH
;

547 
hw
->
wùhy
->
Êags
 |
WIPHY_FLAG_SPLIT_SCAN_6GHZ
;

549 
hw
->
wùhy
->
iÁ˚_combö©i⁄s
 = 
iwl_mvm_iÁ˚_combö©i⁄s
;

550 
hw
->
wùhy
->
n_iÁ˚_combö©i⁄s
 =

551 
	`ARRAY_SIZE
(
iwl_mvm_iÁ˚_combö©i⁄s
);

553 
hw
->
wùhy
->
max_ªmaö_⁄_ch™√l_duøti⁄
 = 10000;

554 
hw
->
max_li°í_öãrvÆ
 = 
IWL_MVM_CONN_LISTEN_INTERVAL
;

557 
	`mem˝y
(
mvm
->
addªs£s
[0].
addr
, mvm->
nvm_d©a
->
hw_addr
, 
ETH_ALEN
);

558 
hw
->
wùhy
->
addªs£s
 = 
mvm
->addresses;

559 
hw
->
wùhy
->
n_addªs£s
 = 1;

562 
num_mac
 = (
mvm
->
nvm_d©a
->
n_hw_addrs
 > 1) ?

563 
	`mö
(
IWL_MVM_MAX_ADDRESSES
, 
mvm
->
nvm_d©a
->
n_hw_addrs
) : 1;

565 
i
 = 1; i < 
num_mac
; i++) {

566 
	`mem˝y
(
mvm
->
addªs£s
[
i
].
addr
, mvm->addresses[i-1].addr,

567 
ETH_ALEN
);

568 
mvm
->
addªs£s
[
i
].
addr
[5]++;

569 
hw
->
wùhy
->
n_addªs£s
++;

572 
	`iwl_mvm_ª£t_phy_˘xts
(
mvm
);

574 
hw
->
wùhy
->
max_sˇn_õ_Àn
 = 
	`iwl_mvm_max_sˇn_õ_Àn
(
mvm
);

576 
hw
->
wùhy
->
max_sˇn_ssids
 = 
PROBE_OPTION_MAX
;

578 
	`BUILD_BUG_ON
(
IWL_MVM_SCAN_STOPPING_MASK
 & 
IWL_MVM_SCAN_MASK
);

579 
	`BUILD_BUG_ON
(
IWL_MVM_MAX_UMAC_SCANS
 > 
	`HWEIGHT32
(
IWL_MVM_SCAN_MASK
) ||

580 
IWL_MVM_MAX_LMAC_SCANS
 > 
	`HWEIGHT32
(
IWL_MVM_SCAN_MASK
));

582 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_CAPA_UMAC_SCAN
))

583 
mvm
->
max_sˇns
 = 
IWL_MVM_MAX_UMAC_SCANS
;

585 
mvm
->
max_sˇns
 = 
IWL_MVM_MAX_LMAC_SCANS
;

587 i‡(
mvm
->
nvm_d©a
->
b™ds
[
NL80211_BAND_2GHZ
].
n_ch™√ls
)

588 
hw
->
wùhy
->
b™ds
[
NL80211_BAND_2GHZ
] =

589 &
mvm
->
nvm_d©a
->
b™ds
[
NL80211_BAND_2GHZ
];

590 i‡(
mvm
->
nvm_d©a
->
b™ds
[
NL80211_BAND_5GHZ
].
n_ch™√ls
) {

591 
hw
->
wùhy
->
b™ds
[
NL80211_BAND_5GHZ
] =

592 &
mvm
->
nvm_d©a
->
b™ds
[
NL80211_BAND_5GHZ
];

594 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

595 
IWL_UCODE_TLV_CAPA_BEAMFORMER
) &&

596 
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

597 
IWL_UCODE_TLV_API_LQ_SS_PARAMS
))

598 
hw
->
wùhy
->
b™ds
[
NL80211_BAND_5GHZ
]->
vht_ˇp
.
ˇp
 |=

599 
IEEE80211_VHT_CAP_SU_BEAMFORMER_CAPABLE
;

601 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

602 
IWL_UCODE_TLV_CAPA_PSC_CHAN_SUPPORT
) &&

603 
mvm
->
nvm_d©a
->
b™ds
[
NL80211_BAND_6GHZ
].
n_ch™√ls
)

604 
hw
->
wùhy
->
b™ds
[
NL80211_BAND_6GHZ
] =

605 &
mvm
->
nvm_d©a
->
b™ds
[
NL80211_BAND_6GHZ
];

607 
hw
->
wùhy
->
hw_vîsi⁄
 = 
mvm
->
å™s
->
hw_id
;

609 i‡(
iwlmvm_mod_∑øms
.
powî_scheme
 !
IWL_POWER_SCHEME_CAM
)

610 
hw
->
wùhy
->
Êags
 |
WIPHY_FLAG_PS_ON_BY_DEFAULT
;

612 
hw
->
wùhy
->
Êags
 &~
WIPHY_FLAG_PS_ON_BY_DEFAULT
;

614 
hw
->
wùhy
->
max_sched_sˇn_ªqs
 = 1;

615 
hw
->
wùhy
->
max_sched_sˇn_ssids
 = 
PROBE_OPTION_MAX
;

616 
hw
->
wùhy
->
max_m©ch_£ts
 = 
	`iwl_umac_sˇn_gë_max_¥ofûes
(
mvm
->
fw
);

618 
hw
->
wùhy
->
max_sched_sˇn_õ_Àn
 =

619 
SCAN_OFFLOAD_PROBE_REQ_SIZE
 - 24 - 2;

620 
hw
->
wùhy
->
max_sched_sˇn_∂™s
 = 
IWL_MAX_SCHED_SCAN_PLANS
;

621 
hw
->
wùhy
->
max_sched_sˇn_∂™_öãrvÆ
 = 
U16_MAX
;

627 
hw
->
wùhy
->
max_sched_sˇn_∂™_ôî©i⁄s
 = 254;

629 
hw
->
wùhy
->
„©uªs
 |
NL80211_FEATURE_P2P_GO_CTWIN
 |

630 
NL80211_FEATURE_LOW_PRIORITY_SCAN
 |

631 
NL80211_FEATURE_P2P_GO_OPPPS
 |

632 
NL80211_FEATURE_AP_MODE_CHAN_WIDTH_CHANGE
 |

633 
NL80211_FEATURE_DYNAMIC_SMPS
 |

634 
NL80211_FEATURE_STATIC_SMPS
 |

635 
NL80211_FEATURE_SUPPORTS_WMM_ADMISSION
;

637 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

638 
IWL_UCODE_TLV_CAPA_TXPOWER_INSERTION_SUPPORT
))

639 
hw
->
wùhy
->
„©uªs
 |
NL80211_FEATURE_TX_POWER_INSERTION
;

640 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

641 
IWL_UCODE_TLV_CAPA_QUIET_PERIOD_SUPPORT
))

642 
hw
->
wùhy
->
„©uªs
 |
NL80211_FEATURE_QUIET
;

644 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

645 
IWL_UCODE_TLV_CAPA_DS_PARAM_SET_IE_SUPPORT
))

646 
hw
->
wùhy
->
„©uªs
 |=

647 
NL80211_FEATURE_DS_PARAM_SET_IE_IN_PROBES
;

649 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

650 
IWL_UCODE_TLV_CAPA_WFA_TPC_REP_IE_SUPPORT
))

651 
hw
->
wùhy
->
„©uªs
 |
NL80211_FEATURE_WFA_TPC_IE_IN_PROBES
;

653 i‡(
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
WOWLAN_KEK_KCK_MATERIAL
,

654 
IWL_FW_CMD_VER_UNKNOWN
) == 3)

655 
hw
->
wùhy
->
Êags
 |
WIPHY_FLAG_SUPPORTS_EXT_KEK_KCK
;

657 i‡(
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

658 
IWL_UCODE_TLV_API_SCAN_TSF_REPORT
)) {

659 
	`wùhy_ext_„©uª_£t
(
hw
->
wùhy
,

660 
NL80211_EXT_FEATURE_SCAN_START_TIME
);

661 
	`wùhy_ext_„©uª_£t
(
hw
->
wùhy
,

662 
NL80211_EXT_FEATURE_BSS_PARENT_TSF
);

665 i‡(
	`iwl_mvm_is_o˚_suµ‹ãd
(
mvm
)) {

666 
u8
 
sˇn_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
SCAN_REQ_UMAC
, 0);

668 
	`wùhy_ext_„©uª_£t
(
hw
->
wùhy
,

669 
NL80211_EXT_FEATURE_ACCEPT_BCAST_PROBE_RESP
);

670 
	`wùhy_ext_„©uª_£t
(
hw
->
wùhy
,

671 
NL80211_EXT_FEATURE_FILS_MAX_CHANNEL_TIME
);

672 
	`wùhy_ext_„©uª_£t
(
hw
->
wùhy
,

673 
NL80211_EXT_FEATURE_OCE_PROBE_REQ_HIGH_TX_RATE
);

676 i‡(
sˇn_vî
 < 15)

677 
	`wùhy_ext_„©uª_£t
(
hw
->
wùhy
,

678 
NL80211_EXT_FEATURE_OCE_PROBE_REQ_DEFERRAL_SUPPRESSION
);

681 
hw
->
wùhy
->
i·y≥_ext_ˇ∑b
 = 
NULL
;

682 
hw
->
wùhy
->
num_i·y≥_ext_ˇ∑b
 = 0;

684 i‡(
mvm
->
nvm_d©a
->
sku_ˇp_11ax_íabÀ
 &&

685 !
iwlwifi_mod_∑øms
.
dißbÀ_11ax
) {

686 
hw
->
wùhy
->
i·y≥_ext_ˇ∑b
 = 
add_i·y≥s_ext_ˇ∑
;

687 
hw
->
wùhy
->
num_i·y≥_ext_ˇ∑b
 =

688 
	`ARRAY_SIZE
(
add_i·y≥s_ext_ˇ∑
) - 1;

690 
	`õì80211_hw_£t
(
hw
, 
SUPPORTS_MULTI_BSSID
);

691 
	`õì80211_hw_£t
(
hw
, 
SUPPORTS_ONLY_HE_MULTI_BSSID
);

694 i‡(
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
,

695 
	`WIDE_ID
(
DATA_PATH_GROUP
,

696 
WNM_80211V_TIMING_MEASUREMENT_CONFIG_CMD
),

697 
IWL_FW_CMD_VER_UNKNOWN
) >= 1) {

698 
	`IWL_DEBUG_INFO
(
mvm
->
å™s
, "Timing measurement supported\n");

700 i‡(!
hw
->
wùhy
->
i·y≥_ext_ˇ∑b
) {

701 
hw
->
wùhy
->
num_i·y≥_ext_ˇ∑b
 = 1;

702 
hw
->
wùhy
->
i·y≥_ext_ˇ∑b
 = 
add_i·y≥s_ext_ˇ∑
 +

703 
	`ARRAY_SIZE
(
add_i·y≥s_ext_ˇ∑
) - 1;

705 
hw
->
wùhy
->
i·y≥_ext_ˇ∑b
 = 
add_i·y≥s_ext_ˇ∑
 + 1;

709 i‡(
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
	`WIDE_ID
(
LOCATION_GROUP
,

710 
TOF_RANGE_REQ_CMD
),

711 
IWL_FW_CMD_VER_UNKNOWN
) >= 11) {

712 
	`wùhy_ext_„©uª_£t
(
hw
->
wùhy
,

713 
NL80211_EXT_FEATURE_PROT_RANGE_NEGO_AND_MEASURE
);

715 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

716 
IWL_UCODE_TLV_CAPA_SECURE_LTF_SUPPORT
))

717 
	`wùhy_ext_„©uª_£t
(
hw
->
wùhy
,

718 
NL80211_EXT_FEATURE_SECURE_LTF
);

721 
mvm
->
πs_thªshﬁd
 = 
IEEE80211_MAX_RTS_THRESHOLD
;

723 #ifde‡
CONFIG_PM_SLEEP


724 i‡((
unifõd
 || 
mvm
->
fw
->
img
[
IWL_UCODE_WOWLAN
].
num_£c
) &&

725 
mvm
->
å™s
->
›s
->
d3_su•íd
 &&

726 
mvm
->
å™s
->
›s
->
d3_ªsume
 &&

727 
	`devi˚_ˇn_wakeup
(
mvm
->
å™s
->
dev
)) {

728 
mvm
->
wowœn
.
Êags
 |
WIPHY_WOWLAN_MAGIC_PKT
 |

729 
WIPHY_WOWLAN_DISCONNECT
 |

730 
WIPHY_WOWLAN_EAP_IDENTITY_REQ
 |

731 
WIPHY_WOWLAN_RFKILL_RELEASE
 |

732 
WIPHY_WOWLAN_NET_DETECT
;

733 
mvm
->
wowœn
.
Êags
 |
WIPHY_WOWLAN_SUPPORTS_GTK_REKEY
 |

734 
WIPHY_WOWLAN_GTK_REKEY_FAILURE
 |

735 
WIPHY_WOWLAN_4WAY_HANDSHAKE
;

737 
mvm
->
wowœn
.
n_∑âîns
 = 
IWL_WOWLAN_MAX_PATTERNS
;

738 
mvm
->
wowœn
.
∑âîn_mö_Àn
 = 
IWL_WOWLAN_MIN_PATTERN_LEN
;

739 
mvm
->
wowœn
.
∑âîn_max_Àn
 = 
IWL_WOWLAN_MAX_PATTERN_LEN
;

740 
mvm
->
wowœn
.
max_nd_m©ch_£ts
 =

741 
	`iwl_umac_sˇn_gë_max_¥ofûes
(
mvm
->
fw
);

742 
hw
->
wùhy
->
wowœn
 = &
mvm
->wowlan;

746 
ªt
 = 
	`iwl_mvm_Àds_öô
(
mvm
);

747 i‡(
ªt
)

748  
ªt
;

750 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

751 
IWL_UCODE_TLV_CAPA_TDLS_SUPPORT
)) {

752 
	`IWL_DEBUG_TDLS
(
mvm
, "TDLS supported\n");

753 
hw
->
wùhy
->
Êags
 |
WIPHY_FLAG_SUPPORTS_TDLS
;

754 
	`õì80211_hw_£t
(
hw
, 
TDLS_WIDER_BW
);

757 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

758 
IWL_UCODE_TLV_CAPA_TDLS_CHANNEL_SWITCH
)) {

759 
	`IWL_DEBUG_TDLS
(
mvm
, "TDLS channel switch supported\n");

760 
hw
->
wùhy
->
„©uªs
 |
NL80211_FEATURE_TDLS_CHANNEL_SWITCH
;

763 
hw
->
√tdev_„©uªs
 |
mvm
->
cfg
->
„©uªs
;

764 i‡(!
	`iwl_mvm_is_csum_suµ‹ãd
(
mvm
))

765 
hw
->
√tdev_„©uªs
 &~
IWL_CSUM_NETIF_FLAGS_MASK
;

767 i‡(
mvm
->
cfg
->
vht_mu_mimo_suµ‹ãd
)

768 
	`wùhy_ext_„©uª_£t
(
hw
->
wùhy
,

769 
NL80211_EXT_FEATURE_MU_MIMO_AIR_SNIFFER
);

771 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_CAPA_PROTECTED_TWT
))

772 
	`wùhy_ext_„©uª_£t
(
hw
->
wùhy
,

773 
NL80211_EXT_FEATURE_PROTECTED_TWT
);

775 
	`iwl_mvm_víd‹_cmds_ªgi°î
(
mvm
);

777 
hw
->
wùhy
->
avaûabÀ_™ã¬as_tx
 = 
	`iwl_mvm_gë_vÆid_tx_™t
(
mvm
);

778 
hw
->
wùhy
->
avaûabÀ_™ã¬as_rx
 = 
	`iwl_mvm_gë_vÆid_rx_™t
(
mvm
);

780 
ªt
 = 
	`õì80211_ªgi°î_hw
(
mvm
->
hw
);

781 i‡(
ªt
) {

782 
	`iwl_mvm_Àds_exô
(
mvm
);

785  
ªt
;

786 
	}
}

788 
	$iwl_mvm_tx_skb
(
iwl_mvm
 *
mvm
, 
sk_buff
 *
skb
,

789 
õì80211_°a
 *
°a
)

791 i‡(
	`likñy
(
°a
)) {

792 i‡(
	`likñy
(
	`iwl_mvm_tx_skb_°a
(
mvm
, 
skb
, 
°a
) == 0))

795 i‡(
	`likñy
(
	`iwl_mvm_tx_skb_n⁄_°a
(
mvm
, 
skb
) == 0))

799 
	`õì80211_‰ì_txskb
(
mvm
->
hw
, 
skb
);

800 
	}
}

802 
	$iwl_mvm_mac_tx
(
õì80211_hw
 *
hw
,

803 
õì80211_tx_c⁄åﬁ
 *
c⁄åﬁ
, 
sk_buff
 *
skb
)

805 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

806 
õì80211_°a
 *
°a
 = 
c⁄åﬁ
->sta;

807 
õì80211_tx_öfo
 *
öfo
 = 
	`IEEE80211_SKB_CB
(
skb
);

808 
õì80211_hdr
 *
hdr
 = (*)
skb
->
d©a
;

809 
boﬁ
 
offch™√l
 = 
	`IEEE80211_SKB_CB
(
skb
)->
Êags
 &

810 
IEEE80211_TX_CTL_TX_OFFCHAN
;

811 
u32
 
lök_id
 = 
	`u32_gë_bôs
(
öfo
->
c⁄åﬁ
.
Êags
,

812 
IEEE80211_TX_CTRL_MLO_LINK
);

813 
õì80211_°a
 *
tmp_°a
 = 
°a
;

815 i‡(
	`iwl_mvm_is_ødio_kûÀd
(
mvm
)) {

816 
	`IWL_DEBUG_DROP
(
mvm
, "Dropping - RF/CT KILL\n");

817 
dr›
;

820 i‡(
offch™√l
 &&

821 !
	`ã°_bô
(
IWL_MVM_STATUS_ROC_RUNNING
, &
mvm
->
°©us
) &&

822 !
	`ã°_bô
(
IWL_MVM_STATUS_ROC_AUX_RUNNING
, &
mvm
->
°©us
))

823 
dr›
;

829 i‡(
	`õì80211_is_mgmt
(
hdr
->
‰ame_c⁄åﬁ
))

830 
°a
 = 
NULL
;

833 i‡(!
°a
 && 
öfo
->
c⁄åﬁ
.
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
 &&

834 !
offch™√l
) {

835 
iwl_mvm_vif
 *
mvmvif
 =

836 
	`iwl_mvm_vif_‰om_mac80211
(
öfo
->
c⁄åﬁ
.
vif
);

837 
u8
 
≠_°a_id
 = 
	`READ_ONCE
(
mvmvif
->
deÊök
.ap_sta_id);

839 i‡(
≠_°a_id
 < 
mvm
->
fw
->
ucode_ˇ∑
.
num_°©i⁄s
) {

841 
°a
 = 
	`rcu_dîe„ªn˚
(
mvm
->
fw_id_to_mac_id
[
≠_°a_id
]);

842 i‡(
	`IS_ERR_OR_NULL
(
°a
))

843 
dr›
;

847 i‡(
tmp_°a
 && !
°a
 && 
lök_id
 !
IEEE80211_LINK_UNSPECIFIED
 &&

848 !
	`õì80211_is_¥obe_ª•
(
hdr
->
‰ame_c⁄åﬁ
)) {

850 
õì80211_lök_°a
 *
lök_°a
 =

851 
	`rcu_dîe„ªn˚
(
tmp_°a
->
lök
[
lök_id
]);

852 
õì80211_bss_c⁄f
 *
lök_c⁄f
 =

853 
	`rcu_dîe„ªn˚
(
öfo
->
c⁄åﬁ
.
vif
->
lök_c⁄f
[
lök_id
]);

854 
õì80211_mgmt
 *
mgmt
;

856 i‡(
	`WARN_ON
(!
lök_°a
 || !
lök_c⁄f
))

857 
dr›
;

860 
mgmt
 = (*)
hdr
;

861 
	`mem˝y
(
mgmt
->
da
, 
lök_°a
->
addr
, 
ETH_ALEN
);

862 
	`mem˝y
(
mgmt
->
ß
, 
lök_c⁄f
->
addr
, 
ETH_ALEN
);

863 
	`mem˝y
(
mgmt
->
bssid
, 
lök_c⁄f
->bssid, 
ETH_ALEN
);

866 
	`iwl_mvm_tx_skb
(
mvm
, 
skb
, 
°a
);

868 
dr›
:

869 
	`õì80211_‰ì_txskb
(
hw
, 
skb
);

870 
	}
}

872 
	$iwl_mvm_mac_ôxq_xmô
(
õì80211_hw
 *
hw
, 
õì80211_txq
 *
txq
)

874 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

875 
iwl_mvm_txq
 *
mvmtxq
 = 
	`iwl_mvm_txq_‰om_mac80211
(
txq
);

876 
sk_buff
 *
skb
 = 
NULL
;

897 i‡(
	`©omic_„tch_add_u∆ess
(&
mvmtxq
->
tx_ªque°
, 1, 2))

900 
	`rcu_ªad_lock
();

902 
	`likñy
(!
	`ã°_bô
(
IWL_MVM_TXQ_STATE_STOP_FULL
,

903 &
mvmtxq
->
°©e
) &&

904 !
	`ã°_bô
(
IWL_MVM_TXQ_STATE_STOP_REDIRECT
,

905 &
mvmtxq
->
°©e
) &&

906 !
	`ã°_bô
(
IWL_MVM_STATUS_IN_D3
, &
mvm
->
°©us
))) {

907 
skb
 = 
	`õì80211_tx_dequeue
(
hw
, 
txq
);

909 i‡(!
skb
) {

910 i‡(
txq
->
°a
)

911 
	`IWL_DEBUG_TX
(
mvm
,

913 
txq
->
°a
->
addr
,

914 
txq
->
tid
);

918 
	`iwl_mvm_tx_skb
(
mvm
, 
skb
, 
txq
->
°a
);

920 } 
	`©omic_dec_ªtu∫
(&
mvmtxq
->
tx_ªque°
));

921 
	`rcu_ªad_u∆ock
();

922 
	}
}

924 
	$iwl_mvm_mac_wake_tx_queue
(
õì80211_hw
 *
hw
,

925 
õì80211_txq
 *
txq
)

927 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

928 
iwl_mvm_txq
 *
mvmtxq
 = 
	`iwl_mvm_txq_‰om_mac80211
(
txq
);

930 i‡(
	`likñy
(
	`ã°_bô
(
IWL_MVM_TXQ_STATE_READY
, &
mvmtxq
->
°©e
)) ||

931 !
txq
->
°a
) {

932 
	`iwl_mvm_mac_ôxq_xmô
(
hw
, 
txq
);

940 
	`•ö_lock_bh
(&
mvm
->
add_°ªam_lock
);

942 i‡(
	`li°_em±y
(&
mvmtxq
->
li°
) &&

944 !
	`ã°_bô
(
IWL_MVM_TXQ_STATE_READY
, &
mvmtxq
->
°©e
)) {

945 
	`li°_add_èû
(&
mvmtxq
->
li°
, &
mvm
->
add_°ªam_txqs
);

946 
	`scheduÀ_w‹k
(&
mvm
->
add_°ªam_wk
);

948 
	`•ö_u∆ock_bh
(&
mvm
->
add_°ªam_lock
);

949 
	}
}

951 
	#CHECK_BA_TRIGGER
(
_mvm
, 
_åig
, 
_tid_bm
, 
_tid
, 
_fmt
...) \

953 i‡(!(
	`À16_to_˝u
(
_tid_bm
Ë& 
	`BIT
(
_tid
))) \

955 
	`iwl_fw_dbg_cﬁÀ˘_åig
(&(
_mvm
)->
fwπ
, 
_åig
, 
_fmt
); \

956 } 0)

	)

959 
	$iwl_mvm_ampdu_check_åiggî
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

960 
õì80211_°a
 *
°a
, 
u16
 
tid
, u16 
rx_ba_s¢
,

961 
õì80211_ampdu_mlme_a˘i⁄
 
a˘i⁄
)

963 
iwl_fw_dbg_åiggî_év
 *
åig
;

964 
iwl_fw_dbg_åiggî_ba
 *
ba_åig
;

966 
åig
 = 
	`iwl_fw_dbg_åiggî_⁄
(&
mvm
->
fwπ
, 
	`õì80211_vif_to_wdev
(
vif
),

967 
FW_DBG_TRIGGER_BA
);

968 i‡(!
åig
)

971 
ba_åig
 = (*)
åig
->
d©a
;

973 
a˘i⁄
) {

974 
IEEE80211_AMPDU_TX_OPERATIONAL
: {

975 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

976 
iwl_mvm_tid_d©a
 *
tid_d©a
 = &
mvm°a
->tid_d©a[
tid
];

978 
	`CHECK_BA_TRIGGER
(
mvm
, 
åig
, 
ba_åig
->
tx_ba_°¨t
, 
tid
,

980 
°a
->
addr
, 
tid
, 
tid_d©a
->
s¢
);

983 
IEEE80211_AMPDU_TX_STOP_CONT
:

984 
	`CHECK_BA_TRIGGER
(
mvm
, 
åig
, 
ba_åig
->
tx_ba_°›
, 
tid
,

986 
°a
->
addr
, 
tid
);

988 
IEEE80211_AMPDU_RX_START
:

989 
	`CHECK_BA_TRIGGER
(
mvm
, 
åig
, 
ba_åig
->
rx_ba_°¨t
, 
tid
,

991 
°a
->
addr
, 
tid
, 
rx_ba_s¢
);

993 
IEEE80211_AMPDU_RX_STOP
:

994 
	`CHECK_BA_TRIGGER
(
mvm
, 
åig
, 
ba_åig
->
rx_ba_°›
, 
tid
,

996 
°a
->
addr
, 
tid
);

1001 
	}
}

1003 
	$iwl_mvm_mac_ampdu_a˘i⁄
(
õì80211_hw
 *
hw
,

1004 
õì80211_vif
 *
vif
,

1005 
õì80211_ampdu_∑øms
 *
∑øms
)

1007 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

1008 
ªt
;

1009 
õì80211_°a
 *
°a
 = 
∑øms
->sta;

1010 
õì80211_ampdu_mlme_a˘i⁄
 
a˘i⁄
 = 
∑øms
->action;

1011 
u16
 
tid
 = 
∑øms
->tid;

1012 
u16
 *
s¢
 = &
∑øms
->ssn;

1013 
u16
 
buf_size
 = 
∑øms
->buf_size;

1014 
boﬁ
 
amsdu
 = 
∑øms
->amsdu;

1015 
u16
 
timeout
 = 
∑øms
->timeout;

1017 
	`IWL_DEBUG_HT
(
mvm
, "A-MPDUáction onáddr %pMÅid %d:áction %d\n",

1018 
°a
->
addr
, 
tid
, 
a˘i⁄
);

1020 i‡(!(
mvm
->
nvm_d©a
->
sku_ˇp_11n_íabÀ
))

1021  -
EACCES
;

1023 
	`muãx_lock
(&
mvm
->
muãx
);

1025 
a˘i⁄
) {

1026 
IEEE80211_AMPDU_RX_START
:

1027 i‡(
	`iwl_mvm_vif_‰om_mac80211
(
vif
)->
deÊök
.
≠_°a_id
 ==

1028 
	`iwl_mvm_°a_‰om_mac80211
(
°a
)->
deÊök
.
°a_id
) {

1029 
iwl_mvm_vif
 *
mvmvif
;

1030 
u16
 
macid
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
)->
id
;

1031 
iwl_mvm_tcm_mac
 *
md©a
 = &
mvm
->
tcm
.
d©a
[
macid
];

1033 
md©a
->
›íed_rx_ba_£ssi⁄s
 = 
åue
;

1034 
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1035 
	`ˇn˚l_dñayed_w‹k
(&
mvmvif
->
u≠sd_n⁄agg_dëe˘ed_wk
);

1037 i‡(!
	`iwl_íabÀ_rx_ampdu
()) {

1038 
ªt
 = -
EINVAL
;

1041 
ªt
 = 
	`iwl_mvm_°a_rx_agg
(
mvm
, 
°a
, 
tid
, *
s¢
, 
åue
, 
buf_size
,

1042 
timeout
);

1044 
IEEE80211_AMPDU_RX_STOP
:

1045 
ªt
 = 
	`iwl_mvm_°a_rx_agg
(
mvm
, 
°a
, 
tid
, 0, 
Ál£
, 
buf_size
,

1046 
timeout
);

1048 
IEEE80211_AMPDU_TX_START
:

1049 i‡(!
	`iwl_íabÀ_tx_ampdu
()) {

1050 
ªt
 = -
EINVAL
;

1053 
ªt
 = 
	`iwl_mvm_°a_tx_agg_°¨t
(
mvm
, 
vif
, 
°a
, 
tid
, 
s¢
);

1055 
IEEE80211_AMPDU_TX_STOP_CONT
:

1056 
ªt
 = 
	`iwl_mvm_°a_tx_agg_°›
(
mvm
, 
vif
, 
°a
, 
tid
);

1058 
IEEE80211_AMPDU_TX_STOP_FLUSH
:

1059 
IEEE80211_AMPDU_TX_STOP_FLUSH_CONT
:

1060 
ªt
 = 
	`iwl_mvm_°a_tx_agg_Êush
(
mvm
, 
vif
, 
°a
, 
tid
);

1062 
IEEE80211_AMPDU_TX_OPERATIONAL
:

1063 
ªt
 = 
	`iwl_mvm_°a_tx_agg_›î
(
mvm
, 
vif
, 
°a
, 
tid
,

1064 
buf_size
, 
amsdu
);

1067 
	`WARN_ON_ONCE
(1);

1068 
ªt
 = -
EINVAL
;

1072 i‡(!
ªt
) {

1073 
u16
 
rx_ba_s¢
 = 0;

1075 i‡(
a˘i⁄
 =
IEEE80211_AMPDU_RX_START
)

1076 
rx_ba_s¢
 = *
s¢
;

1078 
	`iwl_mvm_ampdu_check_åiggî
(
mvm
, 
vif
, 
°a
, 
tid
,

1079 
rx_ba_s¢
, 
a˘i⁄
);

1081 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1083  
ªt
;

1084 
	}
}

1086 
	$iwl_mvm_˛ónup_ôî©‹
(*
d©a
, 
u8
 *
mac
,

1087 
õì80211_vif
 *
vif
)

1089 
iwl_mvm
 *
mvm
 = 
d©a
;

1090 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1091 
iwl_¥obe_ª•_d©a
 *
¥obe_d©a
;

1092 
lök_id
;

1094 
mvmvif
->
u∂ﬂded
 = 
Ál£
;

1096 
	`•ö_lock_bh
(&
mvm
->
time_evít_lock
);

1097 
	`iwl_mvm_ã_˛ór_d©a
(
mvm
, &
mvmvif
->
time_evít_d©a
);

1098 
	`•ö_u∆ock_bh
(&
mvm
->
time_evít_lock
);

1100 
	`mem£t
(&
mvmvif
->
bf_d©a
, 0, (mvmvif->bf_data));

1101 
mvmvif
->
≠_°a
 = 
NULL
;

1103 
	`f‹_óch_mvm_vif_vÆid_lök
(
mvmvif
, 
lök_id
) {

1104 
mvmvif
->
lök
[
lök_id
]->
≠_°a_id
 = 
IWL_MVM_INVALID_STA
;

1105 
mvmvif
->
lök
[
lök_id
]->
fw_lök_id
 = 
IWL_MVM_FW_LINK_ID_INVALID
;

1106 
mvmvif
->
lök
[
lök_id
]->
phy_˘xt
 = 
NULL
;

1107 
mvmvif
->
lök
[
lök_id
]->
a˘ive
 = 0;

1108 
mvmvif
->
lök
[
lök_id
]->
igtk
 = 
NULL
;

1111 
¥obe_d©a
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvmvif
->
deÊök
.
¥obe_ª•_d©a
,

1112 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

1113 i‡(
¥obe_d©a
)

1114 
	`k‰ì_rcu
(
¥obe_d©a
, 
rcu_hód
);

1115 
	`RCU_INIT_POINTER
(
mvmvif
->
deÊök
.
¥obe_ª•_d©a
, 
NULL
);

1116 
	}
}

1118 
	$iwl_mvm_ª°¨t_˛ónup
(
iwl_mvm
 *
mvm
)

1120 
	`iwl_mvm_°›_devi˚
(
mvm
);

1122 
mvm
->
cur_aid
 = 0;

1124 
mvm
->
sˇn_°©us
 = 0;

1125 
mvm
->
ps_dißbÀd
 = 
Ál£
;

1126 
mvm
->
rfkûl_ß„_öô_d⁄e
 = 
Ál£
;

1129 
	`iwl_mvm_˛ónup_roc_ã
(
mvm
);

1130 
	`õì80211_ªmaö_⁄_ch™√l_expúed
(
mvm
->
hw
);

1132 
	`iwl_mvm_·m_ª°¨t
(
mvm
);

1138 
	`õì80211_ôî©e_öãrÁ˚s
(
mvm
->
hw
, 0, 
iwl_mvm_˛ónup_ôî©‹
, mvm);

1140 
mvm
->
p2p_devi˚_vif
 = 
NULL
;

1142 
	`iwl_mvm_ª£t_phy_˘xts
(
mvm
);

1143 
	`mem£t
(
mvm
->
fw_key_èbÀ
, 0, (mvm->fw_key_table));

1144 
	`mem£t
(&
mvm
->
œ°_bt_nŸif
, 0, (mvm->last_bt_notif));

1145 
	`mem£t
(&
mvm
->
œ°_bt_ci_cmd
, 0, (mvm->last_bt_ci_cmd));

1147 
	`õì80211_wake_queues
(
mvm
->
hw
);

1149 
mvm
->
rx_ba_£ssi⁄s
 = 0;

1150 
mvm
->
fwπ
.
dump
.
c⁄f
 = 
FW_DBG_INVALID
;

1151 
mvm
->
m⁄ô‹_⁄
 = 
Ál£
;

1152 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


1153 
mvm
->
bóc⁄_öje˘_a˘ive
 = 
Ál£
;

1157 
	`iwl_mvm_accu_ødio_°©s
(
mvm
);

1158 
	}
}

1160 
	$__iwl_mvm_mac_°¨t
(
iwl_mvm
 *
mvm
)

1162 
ªt
;

1164 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1166 
ªt
 = 
	`iwl_mvm_mei_gë_ow√rshù
(
mvm
);

1167 i‡(
ªt
)

1168  
ªt
;

1170 i‡(
mvm
->
mei_nvm_d©a
) {

1172 
	`k‰ì
(
mvm
->
mei_nvm_d©a
);

1173 
mvm
->
mei_nvm_d©a
 = 
NULL
;

1183 
mvm
->
ãmp_nvm_d©a
 = mvm->
nvm_d©a
;

1184 
mvm
->
nvm_d©a
 = 
NULL
;

1187 i‡(
	`ã°_bô
(
IWL_MVM_STATUS_HW_RESTART_REQUESTED
, &
mvm
->
°©us
)) {

1192 
	`£t_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
);

1193 
	`˛ór_bô
(
IWL_MVM_STATUS_HW_RESTART_REQUESTED
, &
mvm
->
°©us
);

1195 
	`iwl_mvm_ª°¨t_˛ónup
(
mvm
);

1197 
ªt
 = 
	`iwl_mvm_up
(
mvm
);

1199 
	`iwl_dbg_év_time_poöt
(&
mvm
->
fwπ
, 
IWL_FW_INI_TIME_POINT_POST_INIT
,

1200 
NULL
);

1201 
	`iwl_dbg_év_time_poöt
(&
mvm
->
fwπ
, 
IWL_FW_INI_TIME_POINT_PERIODIC
,

1202 
NULL
);

1204 
mvm
->
œ°_ª£t_‹_ªsume_time_jiffõs
 = 
jiffõs
;

1206 i‡(
ªt
 && 
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
)) {

1211 
	`˛ór_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
);

1214  
ªt
;

1215 
	}
}

1217 
	$iwl_mvm_mac_°¨t
(
õì80211_hw
 *
hw
)

1219 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

1220 
ªt
;

1222 
	`muãx_lock
(&
mvm
->
muãx
);

1225 i‡(!
	`ã°_bô
(
IWL_MVM_STATUS_HW_RESTART_REQUESTED
, &
mvm
->
°©us
) &&

1226 
iwlwifi_mod_∑øms
.
fw_ª°¨t
) {

1231 
	`£t_bô
(
IWL_MVM_STATUS_STARTING
, &
mvm
->
°©us
);

1234 
ªt
 = 
	`__iwl_mvm_mac_°¨t
(
mvm
);

1235 
	`˛ór_bô
(
IWL_MVM_STATUS_STARTING
, &
mvm
->
°©us
);

1237 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1239 
	`iwl_mvm_mei_£t_sw_rfkûl_°©e
(
mvm
);

1241  
ªt
;

1242 
	}
}

1244 
	$iwl_mvm_ª°¨t_com∂ëe
(
iwl_mvm
 *
mvm
)

1246 
ªt
;

1248 
	`muãx_lock
(&
mvm
->
muãx
);

1250 
	`˛ór_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
);

1252 
ªt
 = 
	`iwl_mvm_upd©e_quŸas
(
mvm
, 
åue
, 
NULL
);

1253 i‡(
ªt
)

1254 
	`IWL_ERR
(
mvm
, "FailedÅo update quotasáfterÑestart (%d)\n",

1255 
ªt
);

1257 
	`iwl_mvm_£nd_ªcovîy_cmd
(
mvm
, 
ERROR_RECOVERY_END_OF_RECOVERY
);

1263 
	`iwl_mvm_ã¨down_tdls_≥îs
(
mvm
);

1265 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1266 
	}
}

1268 
	$iwl_mvm_mac_ªc⁄fig_com∂ëe
(
õì80211_hw
 *
hw
,

1269 
õì80211_ªc⁄fig_ty≥
 
ªc⁄fig_ty≥
)

1271 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

1273 
ªc⁄fig_ty≥
) {

1274 
IEEE80211_RECONFIG_TYPE_RESTART
:

1275 
	`iwl_mvm_ª°¨t_com∂ëe
(
mvm
);

1277 
IEEE80211_RECONFIG_TYPE_SUSPEND
:

1280 
	}
}

1282 
	$__iwl_mvm_mac_°›
(
iwl_mvm
 *
mvm
)

1284 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1286 
	`iwl_mvm_·m_öôüt‹_smoŸh_°›
(
mvm
);

1291 
	`mem£t
(&
mvm
->
accu_ødio_°©s
, 0, (mvm->accu_radio_stats));

1295 i‡(!
	`iwl_mvm_has_√w_°©i⁄_≠i
(
mvm
->
fw
))

1296 
	`iwl_mvm_rm_aux_°a
(
mvm
);

1298 
	`iwl_mvm_°›_devi˚
(
mvm
);

1300 
	`iwl_mvm_async_h™dÀrs_purge
(
mvm
);

1310 i‡(
	`ã°_™d_˛ór_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
) ||

1311 
	`ã°_™d_˛ór_bô
(
IWL_MVM_STATUS_HW_RESTART_REQUESTED
,

1312 &
mvm
->
°©us
))

1313 
	`õì80211_ôî©e_öãrÁ˚s
(
mvm
->
hw
, 0,

1314 
iwl_mvm_˛ónup_ôî©‹
, 
mvm
);

1319 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_CAPA_UMAC_SCAN
)) {

1320 
i
;

1322 
i
 = 0; i < 
mvm
->
max_sˇns
; i++) {

1323 i‡(
	`WARN_ONCE
(
mvm
->
sˇn_uid_°©us
[
i
],

1325 
i
))

1326 
mvm
->
sˇn_uid_°©us
[
i
] = 0;

1329 
	}
}

1331 
	$iwl_mvm_mac_°›
(
õì80211_hw
 *
hw
)

1333 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

1335 
	`Êush_w‹k
(&
mvm
->
async_h™dÀrs_wk
);

1336 
	`Êush_w‹k
(&
mvm
->
add_°ªam_wk
);

1346 
	`˛ór_bô
(
IWL_MVM_STATUS_FIRMWARE_RUNNING
, &
mvm
->
°©us
);

1348 
	`ˇn˚l_dñayed_w‹k_sync
(&
mvm
->
cs_tx_unblock_dw‹k
);

1349 
	`ˇn˚l_dñayed_w‹k_sync
(&
mvm
->
sˇn_timeout_dw‹k
);

1355 
	`Êush_w‹k
(&
mvm
->
roc_d⁄e_wk
);

1357 
	`iwl_mvm_mei_£t_sw_rfkûl_°©e
(
mvm
);

1359 
	`muãx_lock
(&
mvm
->
muãx
);

1360 
	`__iwl_mvm_mac_°›
(
mvm
);

1361 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1367 
	`ˇn˚l_w‹k_sync
(&
mvm
->
async_h™dÀrs_wk
);

1368 
	`wùhy_w‹k_ˇn˚l
(
hw
->
wùhy
, &
mvm
->
async_h™dÀrs_wùhy_wk
);

1369 
	}
}

1371 
iwl_mvm_phy_˘xt
 *
	$iwl_mvm_gë_‰ì_phy_˘xt
(
iwl_mvm
 *
mvm
)

1373 
u16
 
i
;

1375 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1377 
i
 = 0; i < 
NUM_PHY_CTX
; i++)

1378 i‡(!
mvm
->
phy_˘xts
[
i
].
ªf
)

1379  &
mvm
->
phy_˘xts
[
i
];

1381 
	`IWL_ERR
(
mvm
, "Noávailable PHY context\n");

1382  
NULL
;

1383 
	}
}

1385 
	$iwl_mvm_£t_tx_powî
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

1386 
s16
 
tx_powî
)

1388 
u32
 
cmd_id
 = 
REDUCE_TX_POWER_CMD
;

1389 
Àn
;

1390 
iwl_dev_tx_powî_cmd
 
cmd
 = {

1391 .
comm⁄
.
£t_mode
 = 
	`˝u_to_À32
(
IWL_TX_POWER_MODE_SET_MAC
),

1392 .
comm⁄
.
mac_c⁄ãxt_id
 =

1393 
	`˝u_to_À32
(
	`iwl_mvm_vif_‰om_mac80211
(
vif
)->
id
),

1394 .
comm⁄
.
pwr_ª°ri˘i⁄
 = 
	`˝u_to_À16
(8 * 
tx_powî
),

1396 
u8
 
cmd_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
cmd_id
,

1397 
IWL_FW_CMD_VER_UNKNOWN
);

1399 i‡(
tx_powî
 =
IWL_DEFAULT_MAX_TX_POWER
)

1400 
cmd
.
comm⁄
.
pwr_ª°ri˘i⁄
 = 
	`˝u_to_À16
(
IWL_DEV_MAX_TX_POWER
);

1402 i‡(
cmd_vî
 == 7)

1403 
Àn
 = (
cmd
.
v7
);

1404 i‡(
cmd_vî
 == 6)

1405 
Àn
 = (
cmd
.
v6
);

1406 i‡(
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

1407 
IWL_UCODE_TLV_API_REDUCE_TX_POWER
))

1408 
Àn
 = (
cmd
.
v5
);

1409 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

1410 
IWL_UCODE_TLV_CAPA_TX_POWER_ACK
))

1411 
Àn
 = (
cmd
.
v4
);

1413 
Àn
 = (
cmd
.
v3
);

1416 
Àn
 +(
cmd
.
comm⁄
);

1418  
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
cmd_id
, 0, 
Àn
, &
cmd
);

1419 
	}
}

1421 
	$iwl_mvm_po°_ch™√l_swôch
(
õì80211_hw
 *
hw
,

1422 
õì80211_vif
 *
vif
,

1423 
õì80211_bss_c⁄f
 *
lök_c⁄f
)

1425 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1426 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

1427 
ªt
;

1429 
	`muãx_lock
(&
mvm
->
muãx
);

1431 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
) {

1432 
iwl_mvm_°a
 *
mvm°a
;

1433 
lök_id
 = 
lök_c⁄f
->link_id;

1434 
u8
 
≠_°a_id
 = 
mvmvif
->
lök
[
lök_id
]->ap_sta_id;

1436 
mvmvif
->
cß_b˙_≥ndög
 = 
Ál£
;

1437 
mvm°a
 = 
	`iwl_mvm_°a_‰om_°aid_¥Ÿe˘ed
(
mvm
, 
≠_°a_id
);

1439 i‡(
	`WARN_ON
(!
mvm°a
)) {

1440 
ªt
 = -
EIO
;

1441 
out_u∆ock
;

1444 
	`iwl_mvm_°a_modify_dißbÀ_tx
(
mvm
, 
mvm°a
, 
Ál£
);

1445 i‡(
mvm
->
mld_≠i_is_u£d
)

1446 
	`iwl_mvm_mld_mac_˘xt_ch™ged
(
mvm
, 
vif
, 
Ál£
);

1448 
	`iwl_mvm_mac_˘xt_ch™ged
(
mvm
, 
vif
, 
Ál£
, 
NULL
);

1450 i‡(!
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

1451 
IWL_UCODE_TLV_CAPA_CHANNEL_SWITCH_CMD
)) {

1452 
ªt
 = 
	`iwl_mvm_íabÀ_bóc⁄_fûãr
(
mvm
, 
vif
);

1453 i‡(
ªt
)

1454 
out_u∆ock
;

1456 
	`iwl_mvm_°›_£ssi⁄_¥Ÿe˘i⁄
(
mvm
, 
vif
);

1460 
mvmvif
->
ps_dißbÀd
 = 
Ál£
;

1462 
ªt
 = 
	`iwl_mvm_powî_upd©e_ps
(
mvm
);

1464 
out_u∆ock
:

1465 i‡(
mvmvif
->
cß_Áûed
)

1466 
ªt
 = -
EIO
;

1467 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1469  
ªt
;

1470 
	}
}

1472 
	$iwl_mvm_ab‹t_ch™√l_swôch
(
õì80211_hw
 *
hw
,

1473 
õì80211_vif
 *
vif
,

1474 
õì80211_bss_c⁄f
 *
lök_c⁄f
)

1476 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

1477 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1478 
iwl_ch™_swôch_ã_cmd
 
cmd
 = {

1479 .
mac_id
 = 
	`˝u_to_À32
(
	`FW_CMD_ID_AND_COLOR
(
mvmvif
->
id
,

1480 
mvmvif
->
cﬁ‹
)),

1481 .
a˘i⁄
 = 
	`˝u_to_À32
(
FW_CTXT_ACTION_REMOVE
),

1489 i‡(
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
MAC_CONF_GROUP
,

1490 
CHANNEL_SWITCH_ERROR_NOTIF
, 0))

1493 
	`IWL_DEBUG_MAC80211
(
mvm
, "Ab‹àCSA o¿ma¯%d\n", 
mvmvif
->
id
);

1495 
	`muãx_lock
(&
mvm
->
muãx
);

1496 i‡(!
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

1497 
IWL_UCODE_TLV_CAPA_CHANNEL_SWITCH_CMD
))

1498 
	`iwl_mvm_ªmove_cß_≥riod
(
mvm
, 
vif
);

1500 
	`WARN_ON
(
	`iwl_mvm_£nd_cmd_pdu
(
mvm
,

1501 
	`WIDE_ID
(
MAC_CONF_GROUP
,

1502 
CHANNEL_SWITCH_TIME_EVENT_CMD
),

1503 0, (
cmd
), &cmd));

1504 
mvmvif
->
cß_Áûed
 = 
åue
;

1505 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1508 
	`iwl_mvm_po°_ch™√l_swôch
(
hw
, 
vif
, &vif->
bss_c⁄f
);

1509 
	}
}

1511 
	$iwl_mvm_ch™√l_swôch_disc⁄√˘_wk
(
w‹k_°ru˘
 *
wk
)

1513 
iwl_mvm_vif
 *
mvmvif
;

1514 
õì80211_vif
 *
vif
;

1516 
mvmvif
 = 
	`c⁄èöî_of
(
wk
, 
iwl_mvm_vif
, 
cß_w‹k
.
w‹k
);

1517 
vif
 = 
	`c⁄èöî_of
((*)
mvmvif
, 
õì80211_vif
, 
drv_¥iv
);

1520 
	`õì80211_chswôch_d⁄e
(
vif
, 
Ál£
, 0);

1521 
	}
}

1523 
u8


1524 
	$iwl_mvm_ch™def_gë_¥im¨y_80
(
cfg80211_ch™_def
 *
ch™def
)

1526 
d©a_°¨t
;

1527 
c⁄åﬁ_°¨t
;

1528 
bw
;

1530 i‡(
ch™def
->
width
 =
NL80211_CHAN_WIDTH_320
)

1531 
bw
 = 320;

1532 i‡(
ch™def
->
width
 =
NL80211_CHAN_WIDTH_160
)

1533 
bw
 = 160;

1538 
d©a_°¨t
 = 
ch™def
->
˚¡î_‰eq1
 - 
bw
 / 2;

1540 
c⁄åﬁ_°¨t
 = 
ch™def
->
ch™
->
˚¡î_‰eq
 - 10;

1542  (
c⁄åﬁ_°¨t
 - 
d©a_°¨t
) / 80;

1543 
	}
}

1545 
	$iwl_mvm_Æloc_bˇ°_mˇ°_°a
(
iwl_mvm
 *
mvm
,

1546 
õì80211_vif
 *
vif
)

1548 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1549 
ªt
;

1551 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1553 
ªt
 = 
	`iwl_mvm_Æloc_bˇ°_°a
(
mvm
, 
vif
);

1554 i‡(
ªt
) {

1555 
	`IWL_ERR
(
mvm
, "FailedÅoállocate bcast sta\n");

1556  
ªt
;

1562  
	`iwl_mvm_Æloˇã_öt_°a
(
mvm
, &
mvmvif
->
deÊök
.
mˇ°_°a
, 0,

1563 
vif
->
ty≥
,

1564 
IWL_STA_MULTICAST
);

1565 
	}
}

1567 
	$iwl_mvm_mac_add_öãrÁ˚
(
õì80211_hw
 *
hw
,

1568 
õì80211_vif
 *
vif
)

1570 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

1571 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1572 
ªt
;

1573 
i
;

1575 
	`muãx_lock
(&
mvm
->
muãx
);

1577 
mvmvif
->
mvm
 = mvm;

1580 
mvmvif
->
deÊök
.
fw_lök_id
 = 
IWL_MVM_FW_LINK_ID_INVALID
;

1581 
mvmvif
->
deÊök
.
a˘ive
 = 0;

1582 
mvmvif
->
lök
[0] = &mvmvif->
deÊök
;

1584 
ªt
 = 
	`iwl_mvm_£t_lök_m≠pög
(
mvm
, 
vif
, &vif->
bss_c⁄f
);

1585 i‡(
ªt
)

1586 
out
;

1595 i‡(
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
))

1596 
	`f‹_óch_mvm_vif_vÆid_lök
(
mvmvif
, 
i
)

1597 
mvmvif
->
lök
[
i
]->
bóc⁄_°©s
.
accu_num_bóc⁄s
 +=

1598 
mvmvif
->
lök
[
i
]->
bóc⁄_°©s
.
num_bóc⁄s
;

1601 
ªt
 = 
	`iwl_mvm_mac_˘xt_öô
(
mvm
, 
vif
);

1602 i‡(
ªt
)

1603 
out
;

1605 
	`rcu_assign_poöãr
(
mvm
->
vif_id_to_mac
[
mvmvif
->
id
], 
vif
);

1608 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_NAN
) {

1609 
ªt
 = 0;

1610 
out
;

1624 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
 ||

1625 
vif
->
ty≥
 =
NL80211_IFTYPE_ADHOC
) {

1626 i‡(!
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
))

1627 
	`iwl_mvm_vif_dbgfs_add_lök
(
mvm
, 
vif
);

1628 
ªt
 = 0;

1629 
out
;

1632 
mvmvif
->
„©uªs
 |
hw
->
√tdev_„©uªs
;

1634 
ªt
 = 
	`iwl_mvm_mac_˘xt_add
(
mvm
, 
vif
);

1635 i‡(
ªt
)

1636 
out_u∆ock
;

1638 
ªt
 = 
	`iwl_mvm_powî_upd©e_mac
(
mvm
);

1639 i‡(
ªt
)

1640 
out_ªmove_mac
;

1643 
ªt
 = 
	`iwl_mvm_dißbÀ_bóc⁄_fûãr
(
mvm
, 
vif
);

1644 i‡(
ªt
)

1645 
out_ªmove_mac
;

1647 i‡(!
mvm
->
bf_Ælowed_vif
 &&

1648 
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
 && !vif->
p2p
) {

1649 
mvm
->
bf_Ælowed_vif
 = 
mvmvif
;

1650 
vif
->
drivî_Êags
 |
IEEE80211_VIF_BEACON_FILTER
 |

1651 
IEEE80211_VIF_SUPPORTS_CQM_RSSI
;

1654 i‡(
vif
->
p2p
 || 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
PHY_CONTEXT_CMD
, 1) < 5)

1655 
vif
->
drivî_Êags
 |
IEEE80211_VIF_IGNORE_OFDMA_WIDER_BW
;

1657 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_P2P_DEVICE
)

1658 
mvm
->
p2p_devi˚_vif
 = 
vif
;

1660 
	`iwl_mvm_tcm_add_vif
(
mvm
, 
vif
);

1661 
	`INIT_DELAYED_WORK
(&
mvmvif
->
cß_w‹k
,

1662 
iwl_mvm_ch™√l_swôch_disc⁄√˘_wk
);

1664 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_MONITOR
) {

1665 
mvm
->
m⁄ô‹_⁄
 = 
åue
;

1666 
mvm
->
m⁄ô‹_p80
 =

1667 
	`iwl_mvm_ch™def_gë_¥im¨y_80
(&
vif
->
bss_c⁄f
.
ch™ªq
.
›î
);

1670 i‡(!
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
))

1671 
	`iwl_mvm_vif_dbgfs_add_lök
(
mvm
, 
vif
);

1673 i‡(!
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
) &&

1674 
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
 && !vif->
p2p
 &&

1675 !
mvm
->
csme_vif
 && mvm->
mei_ªgi°îed
) {

1676 
	`iwl_mei_£t_nic_öfo
(
vif
->
addr
, 
mvm
->
nvm_d©a
->
hw_addr
);

1677 
	`iwl_mei_£t_√tdev
(
	`õì80211_vif_to_wdev
(
vif
)->
√tdev
);

1678 
mvm
->
csme_vif
 = 
vif
;

1681 
out
:

1682 i‡(!
ªt
 && (
vif
->
ty≥
 =
NL80211_IFTYPE_AP
 ||

1683 
vif
->
ty≥
 =
NL80211_IFTYPE_ADHOC
))

1684 
ªt
 = 
	`iwl_mvm_Æloc_bˇ°_mˇ°_°a
(
mvm
, 
vif
);

1686 
out_u∆ock
;

1688 
out_ªmove_mac
:

1689 
mvmvif
->
deÊök
.
phy_˘xt
 = 
NULL
;

1690 
	`iwl_mvm_mac_˘xt_ªmove
(
mvm
, 
vif
);

1691 
out_u∆ock
:

1692 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1694  
ªt
;

1695 
	}
}

1697 
	$iwl_mvm_¥ï¨e_mac_ªmovÆ
(
iwl_mvm
 *
mvm
,

1698 
õì80211_vif
 *
vif
)

1700 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_P2P_DEVICE
) {

1706 
	`Êush_w‹k
(&
mvm
->
roc_d⁄e_wk
);

1708 
	}
}

1714 
boﬁ
 
	$iwl_mvm_mac_ªmove_öãrÁ˚_comm⁄
(
õì80211_hw
 *
hw
,

1715 
õì80211_vif
 *
vif
)

1717 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

1718 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1719 
iwl_¥obe_ª•_d©a
 *
¥obe_d©a
;

1721 
	`iwl_mvm_¥ï¨e_mac_ªmovÆ
(
mvm
, 
vif
);

1723 i‡(!(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
 ||

1724 
vif
->
ty≥
 =
NL80211_IFTYPE_ADHOC
))

1725 
	`iwl_mvm_tcm_rm_vif
(
mvm
, 
vif
);

1727 
	`muãx_lock
(&
mvm
->
muãx
);

1729 i‡(
vif
 =
mvm
->
csme_vif
) {

1730 
	`iwl_mei_£t_√tdev
(
NULL
);

1731 
mvm
->
csme_vif
 = 
NULL
;

1734 
¥obe_d©a
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvmvif
->
deÊök
.
¥obe_ª•_d©a
,

1735 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

1736 
	`RCU_INIT_POINTER
(
mvmvif
->
deÊök
.
¥obe_ª•_d©a
, 
NULL
);

1737 i‡(
¥obe_d©a
)

1738 
	`k‰ì_rcu
(
¥obe_d©a
, 
rcu_hód
);

1740 i‡(
mvm
->
bf_Ælowed_vif
 =
mvmvif
) {

1741 
mvm
->
bf_Ælowed_vif
 = 
NULL
;

1742 
vif
->
drivî_Êags
 &~(
IEEE80211_VIF_BEACON_FILTER
 |

1743 
IEEE80211_VIF_SUPPORTS_CQM_RSSI
);

1746 i‡(
vif
->
bss_c⁄f
.
·m_ª•⁄dî
)

1747 
	`mem£t
(&
mvm
->
·m_ª•_°©s
, 0, (mvm->ftm_resp_stats));

1749 
	`iwl_mvm_vif_dbgfs_rm_lök
(
mvm
, 
vif
);

1755 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
 ||

1756 
vif
->
ty≥
 =
NL80211_IFTYPE_ADHOC
) {

1757 #ifde‡
CONFIG_NL80211_TESTMODE


1758 i‡(
vif
 =
mvm
->
nﬂ_vif
) {

1759 
mvm
->
nﬂ_vif
 = 
NULL
;

1760 
mvm
->
nﬂ_duøti⁄
 = 0;

1763  
åue
;

1766 
	`iwl_mvm_powî_upd©e_mac
(
mvm
);

1767  
Ál£
;

1768 
	}
}

1770 
	$iwl_mvm_mac_ªmove_öãrÁ˚
(
õì80211_hw
 *
hw
,

1771 
õì80211_vif
 *
vif
)

1773 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

1774 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1776 i‡(
	`iwl_mvm_mac_ªmove_öãrÁ˚_comm⁄
(
hw
, 
vif
))

1777 
out
;

1784 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_P2P_DEVICE
) {

1785 i‡(
mvmvif
->
deÊök
.
phy_˘xt
) {

1786 
	`iwl_mvm_phy_˘xt_uƒef
(
mvm
, 
mvmvif
->
deÊök
.
phy_˘xt
);

1787 
mvmvif
->
deÊök
.
phy_˘xt
 = 
NULL
;

1789 
mvm
->
p2p_devi˚_vif
 = 
NULL
;

1792 
	`iwl_mvm_un£t_lök_m≠pög
(
mvm
, 
vif
, &vif->
bss_c⁄f
);

1793 
	`iwl_mvm_mac_˘xt_ªmove
(
mvm
, 
vif
);

1795 
	`RCU_INIT_POINTER
(
mvm
->
vif_id_to_mac
[
mvmvif
->
id
], 
NULL
);

1797 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_MONITOR
)

1798 
mvm
->
m⁄ô‹_⁄
 = 
Ál£
;

1800 
out
:

1801 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
 ||

1802 
vif
->
ty≥
 =
NL80211_IFTYPE_ADHOC
) {

1803 
	`iwl_mvm_dóŒoc_öt_°a
(
mvm
, &
mvmvif
->
deÊök
.
mˇ°_°a
);

1804 
	`iwl_mvm_dóŒoc_bˇ°_°a
(
mvm
, 
vif
);

1807 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1808 
	}
}

1810 
	siwl_mvm_mc_ôî_d©a
 {

1811 
iwl_mvm
 *
	mmvm
;

1812 
	mp‹t_id
;

1815 
	$iwl_mvm_mc_iÁ˚_ôî©‹
(*
_d©a
, 
u8
 *
mac
,

1816 
õì80211_vif
 *
vif
)

1818 
iwl_mvm_mc_ôî_d©a
 *
d©a
 = 
_d©a
;

1819 
iwl_mvm
 *
mvm
 = 
d©a
->mvm;

1820 
iwl_mˇ°_fûãr_cmd
 *
cmd
 = 
mvm
->
mˇ°_fûãr_cmd
;

1821 
iwl_ho°_cmd
 
hcmd
 = {

1822 .
id
 = 
MCAST_FILTER_CMD
,

1823 .
Êags
 = 
CMD_ASYNC
,

1824 .
d©aÊags
[0] = 
IWL_HCMD_DFL_NOCOPY
,

1826 
ªt
, 
Àn
;

1829 i‡(
	`WARN_ON_ONCE
(
d©a
->
p‹t_id
 >
MAX_PORT_ID_NUM
))

1832 i‡(
vif
->
ty≥
 !
NL80211_IFTYPE_STATION
 ||

1833 !
vif
->
cfg
.
assoc
)

1836 
cmd
->
p‹t_id
 = 
d©a
->port_id++;

1837 
	`mem˝y
(
cmd
->
bssid
, 
vif
->
bss_c⁄f
.bssid, 
ETH_ALEN
);

1838 
Àn
 = 
	`roundup
((*
cmd
Ë+ cmd->
cou¡
 * 
ETH_ALEN
, 4);

1840 
hcmd
.
Àn
[0] =Üen;

1841 
hcmd
.
d©a
[0] = 
cmd
;

1843 
ªt
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
hcmd
);

1844 i‡(
ªt
)

1845 
	`IWL_ERR
(
mvm
, "mˇ° fûã∏cmdÉº‹.Ñë=%d\n", 
ªt
);

1846 
	}
}

1848 
	$iwl_mvm_ªˇlc_mu…iˇ°
(
iwl_mvm
 *
mvm
)

1850 
iwl_mvm_mc_ôî_d©a
 
ôî_d©a
 = {

1851 .
mvm
 = mvm,

1853 
ªt
;

1855 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1857 i‡(
	`WARN_ON_ONCE
(!
mvm
->
mˇ°_fûãr_cmd
))

1860 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s_©omic
(

1861 
mvm
->
hw
, 
IEEE80211_IFACE_ITER_NORMAL
,

1862 
iwl_mvm_mc_iÁ˚_ôî©‹
, &
ôî_d©a
);

1876 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
ECHO_CMD
, 0, 0, 
NULL
);

1877 i‡(
ªt
)

1878 
	`IWL_ERR
(
mvm
, "FailedÅo synchronize multicast groups update\n");

1879 
	}
}

1881 
u64
 
	$iwl_mvm_¥ï¨e_mu…iˇ°
(
õì80211_hw
 *
hw
,

1882 
√tdev_hw_addr_li°
 *
mc_li°
)

1884 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

1885 
iwl_mˇ°_fûãr_cmd
 *
cmd
;

1886 
√tdev_hw_addr
 *
addr
;

1887 
addr_cou¡
;

1888 
boﬁ
 
∑ss_Æl
;

1889 
Àn
;

1891 
addr_cou¡
 = 
	`√tdev_hw_addr_li°_cou¡
(
mc_li°
);

1892 
∑ss_Æl
 = 
addr_cou¡
 > 
MAX_MCAST_FILTERING_ADDRESSES
 ||

1893 
IWL_MVM_FW_MCAST_FILTER_PASS_ALL
;

1894 i‡(
∑ss_Æl
)

1895 
addr_cou¡
 = 0;

1897 
Àn
 = 
	`roundup
((*
cmd
Ë+ 
addr_cou¡
 * 
ETH_ALEN
, 4);

1898 
cmd
 = 
	`kzÆloc
(
Àn
, 
GFP_ATOMIC
);

1899 i‡(!
cmd
)

1902 i‡(
∑ss_Æl
) {

1903 
cmd
->
∑ss_Æl
 = 1;

1904  (
u64
)()
cmd
;

1907 
	`√tdev_hw_addr_li°_f‹_óch
(
addr
, 
mc_li°
) {

1908 
	`IWL_DEBUG_MAC80211
(
mvm
, "mcastáddr (%d): %pM\n",

1909 
cmd
->
cou¡
, 
addr
->addr);

1910 
	`mem˝y
(&
cmd
->
addr_li°
[cmd->
cou¡
 * 
ETH_ALEN
],

1911 
addr
->addr, 
ETH_ALEN
);

1912 
cmd
->
cou¡
++;

1915  (
u64
)()
cmd
;

1916 
	}
}

1918 
	$iwl_mvm_c⁄figuª_fûãr
(
õì80211_hw
 *
hw
,

1919 
ch™ged_Êags
,

1920 *
tŸÆ_Êags
, 
u64
 
mu…iˇ°
)

1922 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

1923 
iwl_mˇ°_fûãr_cmd
 *
cmd
 = (*)()
mu…iˇ°
;

1925 
	`muãx_lock
(&
mvm
->
muãx
);

1928 
	`k‰ì
(
mvm
->
mˇ°_fûãr_cmd
);

1929 
mvm
->
mˇ°_fûãr_cmd
 = 
cmd
;

1931 i‡(!
cmd
)

1932 
out
;

1934 i‡(
ch™ged_Êags
 & 
FIF_ALLMULTI
)

1935 
cmd
->
∑ss_Æl
 = !!(*
tŸÆ_Êags
 & 
FIF_ALLMULTI
);

1937 i‡(
cmd
->
∑ss_Æl
)

1938 
cmd
->
cou¡
 = 0;

1940 
	`iwl_mvm_ªˇlc_mu…iˇ°
(
mvm
);

1941 
out
:

1942 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1943 *
tŸÆ_Êags
 = 0;

1944 
	}
}

1946 
	$iwl_mvm_c⁄fig_iÁ˚_fûãr
(
õì80211_hw
 *
hw
,

1947 
õì80211_vif
 *
vif
,

1948 
fûãr_Êags
,

1949 
ch™ged_Êags
)

1951 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

1954 i‡(!(
ch™ged_Êags
 & 
FIF_PROBE_REQ
))

1958 i‡(
vif
->
ty≥
 !
NL80211_IFTYPE_STATION
 || !vif->
cfg
.
assoc
 ||

1959 !
vif
->
p2p
)

1962 
	`muãx_lock
(&
mvm
->
muãx
);

1963 
	`iwl_mvm_mac_˘xt_ch™ged
(
mvm
, 
vif
, 
Ál£
, 
NULL
);

1964 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1965 
	}
}

1967 
	$iwl_mvm_upd©e_mu_groups
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

1969 
iwl_mu_group_mgmt_cmd
 
cmd
 = {};

1971 
	`mem˝y
(
cmd
.
membîshù_°©us
, 
vif
->
bss_c⁄f
.
mu_group
.
membîshù
,

1972 
WLAN_MEMBERSHIP_LEN
);

1973 
	`mem˝y
(
cmd
.
u£r_posôi⁄
, 
vif
->
bss_c⁄f
.
mu_group
.
posôi⁄
,

1974 
WLAN_USER_POSITION_LEN
);

1976  
	`iwl_mvm_£nd_cmd_pdu
(
mvm
,

1977 
	`WIDE_ID
(
DATA_PATH_GROUP
,

1978 
UPDATE_MU_GROUPS_CMD
),

1979 0, (
cmd
), &cmd);

1980 
	}
}

1982 
	$iwl_mvm_mu_mimo_iÁ˚_ôî©‹
(*
_d©a
, 
u8
 *
mac
,

1983 
õì80211_vif
 *
vif
)

1985 i‡(
vif
->
bss_c⁄f
.
mu_mimo_ow√r
) {

1986 
iwl_mu_group_mgmt_nŸif
 *
nŸif
 = 
_d©a
;

1993 
	`õì80211_upd©e_mu_groups
(
vif
, 0,

1994 (
u8
 *)&
nŸif
->
membîshù_°©us
,

1995 (
u8
 *)&
nŸif
->
u£r_posôi⁄
);

1997 
	}
}

1999 
	$iwl_mvm_mu_mimo_gΩ_nŸif
(
iwl_mvm
 *
mvm
,

2000 
iwl_rx_cmd_buf„r
 *
rxb
)

2002 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

2003 
iwl_mu_group_mgmt_nŸif
 *
nŸif
 = (*)
pkt
->
d©a
;

2005 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s_©omic
(

2006 
mvm
->
hw
, 
IEEE80211_IFACE_ITER_NORMAL
,

2007 
iwl_mvm_mu_mimo_iÁ˚_ôî©‹
, 
nŸif
);

2008 
	}
}

2010 
u8
 
	$iwl_mvm_he_gë_µe_vÆ
(
u8
 *
µe
, u8 
µe_pos_bô
)

2012 
u8
 
byã_num
 = 
µe_pos_bô
 / 8;

2013 
u8
 
bô_num
 = 
µe_pos_bô
 % 8;

2014 
u8
 
ªsidue_bôs
;

2015 
u8
 
ªs
;

2017 i‡(
bô_num
 <= 5)

2018  (
µe
[
byã_num
] >> 
bô_num
) &

2019 (
	`BIT
(
IEEE80211_PPE_THRES_INFO_PPET_SIZE
) - 1);

2027 
ªsidue_bôs
 = 8 - 
bô_num
;

2029 
ªs
 = (
µe
[
byã_num
 + 1] &

2030 (
	`BIT
(
IEEE80211_PPE_THRES_INFO_PPET_SIZE
 - 
ªsidue_bôs
) - 1)) <<

2031 
ªsidue_bôs
;

2032 
ªs
 +(
µe
[
byã_num
] >> 
bô_num
Ë& (
	`BIT
(
ªsidue_bôs
) - 1);

2034  
ªs
;

2035 
	}
}

2037 
	$iwl_mvm_∑r£_µe
(
iwl_mvm
 *
mvm
,

2038 
iwl_he_pkt_ext_v2
 *
pkt_ext
, 
u8
 
nss
,

2039 
u8
 
ru_ödex_bôm≠
, u8 *
µe
, u8 
µe_pos_bô
,

2040 
boﬁ
 
öhîô™˚
)

2042 
i
;

2050 i‡(
nss
 > 
MAX_HE_SUPP_NSS
) {

2051 
	`IWL_DEBUG_INFO
(
mvm
, "GŸ NSS = %d -ÅrimmögÅÿ%d\n", 
nss
,

2052 
MAX_HE_SUPP_NSS
);

2053 
nss
 = 
MAX_HE_SUPP_NSS
;

2056 
i
 = 0; i < 
nss
; i++) {

2057 
u8
 
ru_ödex_tmp
 = 
ru_ödex_bôm≠
 << 1;

2058 
u8
 
low_th
 = 
IWL_HE_PKT_EXT_NONE
, 
high_th
 = IWL_HE_PKT_EXT_NONE;

2059 
u8
 
bw
;

2061 
bw
 = 0;

2062 
bw
 < 
	`ARRAY_SIZE
(
pkt_ext
->
pkt_ext_qam_th
[
i
]);

2063 
bw
++) {

2064 
ru_ödex_tmp
 >>= 1;

2072 i‡(!(
ru_ödex_tmp
 & 1)) {

2073 i‡(
öhîô™˚
)

2074 
£t_thªshﬁds
;

2079 
high_th
 = 
	`iwl_mvm_he_gë_µe_vÆ
(
µe
, 
µe_pos_bô
);

2080 
µe_pos_bô
 +
IEEE80211_PPE_THRES_INFO_PPET_SIZE
;

2081 
low_th
 = 
	`iwl_mvm_he_gë_µe_vÆ
(
µe
, 
µe_pos_bô
);

2082 
µe_pos_bô
 +
IEEE80211_PPE_THRES_INFO_PPET_SIZE
;

2084 
£t_thªshﬁds
:

2085 
pkt_ext
->
pkt_ext_qam_th
[
i
][
bw
][0] = 
low_th
;

2086 
pkt_ext
->
pkt_ext_qam_th
[
i
][
bw
][1] = 
high_th
;

2089 
	}
}

2091 
	$iwl_mvm_£t_pkt_ext_‰om_he_µe
(
iwl_mvm
 *
mvm
,

2092 
õì80211_lök_°a
 *
lök_°a
,

2093 
iwl_he_pkt_ext_v2
 *
pkt_ext
,

2094 
boﬁ
 
öhîô™˚
)

2096 
u8
 
nss
 = (
lök_°a
->
he_ˇp
.
µe_thªs
[0] &

2097 
IEEE80211_PPE_THRES_NSS_MASK
) + 1;

2098 
u8
 *
µe
 = &
lök_°a
->
he_ˇp
.
µe_thªs
[0];

2099 
u8
 
ru_ödex_bôm≠
 =

2100 
	`u8_gë_bôs
(*
µe
,

2101 
IEEE80211_PPE_THRES_RU_INDEX_BITMASK_MASK
);

2103 
u8
 
µe_pos_bô
 = 
IEEE80211_HE_PPE_THRES_INFO_HEADER_SIZE
;

2105 
	`iwl_mvm_∑r£_µe
(
mvm
, 
pkt_ext
, 
nss
, 
ru_ödex_bôm≠
, 
µe
, 
µe_pos_bô
,

2106 
öhîô™˚
);

2107 
	}
}

2110 
	$iwl_mvm_£t_pkt_ext_‰om_nomöÆ_∑ddög
(
iwl_he_pkt_ext_v2
 *
pkt_ext
,

2111 
u8
 
nomöÆ_∑ddög
)

2113 
low_th
 = -1;

2114 
high_th
 = -1;

2115 
i
;

2118 
nomöÆ_∑ddög
) {

2119 
IEEE80211_EHT_PHY_CAP5_COMMON_NOMINAL_PKT_PAD_0US
:

2120 
low_th
 = 
IWL_HE_PKT_EXT_NONE
;

2121 
high_th
 = 
IWL_HE_PKT_EXT_NONE
;

2123 
IEEE80211_EHT_PHY_CAP5_COMMON_NOMINAL_PKT_PAD_8US
:

2124 
low_th
 = 
IWL_HE_PKT_EXT_BPSK
;

2125 
high_th
 = 
IWL_HE_PKT_EXT_NONE
;

2127 
IEEE80211_EHT_PHY_CAP5_COMMON_NOMINAL_PKT_PAD_16US
:

2128 
IEEE80211_EHT_PHY_CAP5_COMMON_NOMINAL_PKT_PAD_20US
:

2129 
low_th
 = 
IWL_HE_PKT_EXT_NONE
;

2130 
high_th
 = 
IWL_HE_PKT_EXT_BPSK
;

2134 i‡(
low_th
 < 0 || 
high_th
 < 0)

2135  -
EINVAL
;

2138 
i
 = 0; i < 
MAX_HE_SUPP_NSS
; i++) {

2139 
u8
 
bw
;

2141 
bw
 = 0;

2142 
bw
 < 
	`ARRAY_SIZE
(
pkt_ext
->
pkt_ext_qam_th
[
i
]);

2143 
bw
++) {

2144 
pkt_ext
->
pkt_ext_qam_th
[
i
][
bw
][0] = 
low_th
;

2145 
pkt_ext
->
pkt_ext_qam_th
[
i
][
bw
][1] = 
high_th
;

2150 
	}
}

2152 
	$iwl_mvm_gë_›timÆ_µe_öfo
(
iwl_he_pkt_ext_v2
 *
pkt_ext
,

2153 
u8
 
nomöÆ_∑ddög
)

2155 
i
;

2157 
i
 = 0; i < 
MAX_HE_SUPP_NSS
; i++) {

2158 
u8
 
bw
;

2160 
bw
 = 0; bw < 
	`ARRAY_SIZE
(
pkt_ext
->
pkt_ext_qam_th
[
i
]);

2161 
bw
++) {

2162 
u8
 *
qam_th
 = &
pkt_ext
->
pkt_ext_qam_th
[
i
][
bw
][0];

2164 i‡(
nomöÆ_∑ddög
 >

2165 
IEEE80211_EHT_PHY_CAP5_COMMON_NOMINAL_PKT_PAD_8US
 &&

2166 
qam_th
[1] =
IWL_HE_PKT_EXT_NONE
)

2167 
qam_th
[1] = 
IWL_HE_PKT_EXT_4096QAM
;

2168 i‡(
nomöÆ_∑ddög
 ==

2169 
IEEE80211_EHT_PHY_CAP5_COMMON_NOMINAL_PKT_PAD_8US
 &&

2170 
qam_th
[0] =
IWL_HE_PKT_EXT_NONE
 &&

2171 
qam_th
[1] =
IWL_HE_PKT_EXT_NONE
)

2172 
qam_th
[0] = 
IWL_HE_PKT_EXT_4096QAM
;

2175 
	}
}

2178 
	$iwl_mvm_£t_°a_pkt_ext
(
iwl_mvm
 *
mvm
,

2179 
õì80211_lök_°a
 *
lök_°a
,

2180 
iwl_he_pkt_ext_v2
 *
pkt_ext
)

2182 
u8
 
nomöÆ_∑ddög
;

2183 
i
, 
ªt
 = 0;

2185 i‡(
	`WARN_ON
(!
lök_°a
))

2186  -
EINVAL
;

2191 
	`mem£t
(
pkt_ext
, 
IWL_HE_PKT_EXT_NONE
,

2192 (
iwl_he_pkt_ext_v2
));

2194 i‡(
lök_°a
->
eht_ˇp
.
has_eht
) {

2195 
nomöÆ_∑ddög
 =

2196 
	`u8_gë_bôs
(
lök_°a
->
eht_ˇp
.
eht_ˇp_ñem
.
phy_ˇp_öfo
[5],

2197 
IEEE80211_EHT_PHY_CAP5_COMMON_NOMINAL_PKT_PAD_MASK
);

2202 i‡(
lök_°a
->
eht_ˇp
.
eht_ˇp_ñem
.
phy_ˇp_öfo
[5] &

2203 
IEEE80211_EHT_PHY_CAP5_PPE_THRESHOLD_PRESENT
) {

2204 
u8
 
nss
 = (
lök_°a
->
eht_ˇp
.
eht_µe_thªs
[0] &

2205 
IEEE80211_EHT_PPE_THRES_NSS_MASK
) + 1;

2206 
u8
 *
µe
 = &
lök_°a
->
eht_ˇp
.
eht_µe_thªs
[0];

2207 
u8
 
ru_ödex_bôm≠
 =

2208 
	`u16_gë_bôs
(*
µe
,

2209 
IEEE80211_EHT_PPE_THRES_RU_INDEX_BITMASK_MASK
);

2211 
u8
 
µe_pos_bô
 = 
IEEE80211_EHT_PPE_THRES_INFO_HEADER_SIZE
;

2213 
	`iwl_mvm_∑r£_µe
(
mvm
, 
pkt_ext
, 
nss
, 
ru_ödex_bôm≠
,

2214 
µe
, 
µe_pos_bô
, 
åue
);

2218 } i‡(
lök_°a
->
he_ˇp
.
he_ˇp_ñem
.
phy_ˇp_öfo
[6] &

2219 
IEEE80211_HE_PHY_CAP6_PPE_THRESHOLD_PRESENT
) {

2225 
	`iwl_mvm_£t_pkt_ext_‰om_he_µe
(
mvm
, 
lök_°a
, 
pkt_ext
,

2226 
åue
);

2232 
	`iwl_mvm_gë_›timÆ_µe_öfo
(
pkt_ext
, 
nomöÆ_∑ddög
);

2238 
ªt
 = 
	`iwl_mvm_£t_pkt_ext_‰om_nomöÆ_∑ddög
(
pkt_ext
,

2239 
nomöÆ_∑ddög
);

2241 } i‡(
lök_°a
->
he_ˇp
.
has_he
) {

2243 i‡(
lök_°a
->
he_ˇp
.
he_ˇp_ñem
.
phy_ˇp_öfo
[6] &

2244 
IEEE80211_HE_PHY_CAP6_PPE_THRESHOLD_PRESENT
) {

2245 
	`iwl_mvm_£t_pkt_ext_‰om_he_µe
(
mvm
, 
lök_°a
, 
pkt_ext
,

2246 
Ál£
);

2251 
nomöÆ_∑ddög
 =

2252 
	`u8_gë_bôs
(
lök_°a
->
he_ˇp
.
he_ˇp_ñem
.
phy_ˇp_öfo
[9],

2253 
IEEE80211_HE_PHY_CAP9_NOMINAL_PKT_PADDING_MASK
);

2254 i‡(
nomöÆ_∑ddög
 !
IEEE80211_HE_PHY_CAP9_NOMINAL_PKT_PADDING_RESERVED
)

2255 
ªt
 = 
	`iwl_mvm_£t_pkt_ext_‰om_nomöÆ_∑ddög
(
pkt_ext
,

2256 
nomöÆ_∑ddög
);

2260 
i
 = 0; i < 
MAX_HE_SUPP_NSS
; i++) {

2261 
bw
;

2263 
bw
 = 0;

2264 
bw
 < 
	`ARRAY_SIZE
(*
pkt_ext
->
pkt_ext_qam_th
[
i
]);

2265 
bw
++) {

2266 
u8
 *
qam_th
 =

2267 &
pkt_ext
->
pkt_ext_qam_th
[
i
][
bw
][0];

2269 
	`IWL_DEBUG_HT
(
mvm
,

2271 
i
, 
bw
, 
qam_th
[0], qam_th[1]);

2274  
ªt
;

2275 
	}
}

2281 
boﬁ
 
	$iwl_mvm_£t_fw_mu_edˇ_∑øms
(
iwl_mvm
 *
mvm
,

2282 c⁄° 
iwl_mvm_vif_lök_öfo
 *
lök_öfo
,

2283 
iwl_he_backoff_c⁄f
 *
åig_ba£d_txf
)

2285 
i
;

2287 
boﬁ
 
mu_edˇ_íabÀd
 = 
åue
;

2289 
i
 = 0; i < 
IEEE80211_NUM_ACS
; i++) {

2290 c⁄° 
õì80211_he_mu_edˇ_∑øm_ac_ªc
 *
mu_edˇ
 =

2291 &
lök_öfo
->
queue_∑øms
[
i
].
mu_edˇ_∑øm_ªc
;

2292 
u8
 
ac
 = 
	`iwl_mvm_mac80211_ac_to_ucode_ac
(
i
);

2294 i‡(!
lök_öfo
->
queue_∑øms
[
i
].
mu_edˇ
) {

2295 
mu_edˇ_íabÀd
 = 
Ál£
;

2299 
åig_ba£d_txf
[
ac
].
cwmö
 =

2300 
	`˝u_to_À16
(
mu_edˇ
->
ecw_mö_max
 & 0xf);

2301 
åig_ba£d_txf
[
ac
].
cwmax
 =

2302 
	`˝u_to_À16
((
mu_edˇ
->
ecw_mö_max
 & 0xf0) >> 4);

2303 
åig_ba£d_txf
[
ac
].
aif¢
 =

2304 
	`˝u_to_À16
(
mu_edˇ
->
aif¢
 & 0xf);

2305 
åig_ba£d_txf
[
ac
].
mu_time
 =

2306 
	`˝u_to_À16
(
mu_edˇ
->
mu_edˇ_timî
);

2309  
mu_edˇ_íabÀd
;

2310 
	}
}

2312 
boﬁ
 
	$iwl_mvm_is_nic_ack_íabÀd
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

2314 c⁄° 
õì80211_suµ‹ãd_b™d
 *
sb™d
;

2315 c⁄° 
õì80211_°a_he_ˇp
 *
own_he_ˇp
 = 
NULL
;

2320 
sb™d
 = 
mvm
->
hw
->
wùhy
->
b™ds
[
NL80211_BAND_2GHZ
];

2321 
own_he_ˇp
 = 
	`õì80211_gë_he_i·y≥_ˇp_vif
(
sb™d
, 
vif
);

2323  (
own_he_ˇp
 && (own_he_ˇp->
he_ˇp_ñem
.
mac_ˇp_öfo
[2] &

2324 
IEEE80211_HE_MAC_CAP2_ACK_EN
));

2325 
	}
}

2327 
__À32
 
	$iwl_mvm_gë_°a_htc_Êags
(
õì80211_°a
 *
°a
,

2328 
õì80211_lök_°a
 *
lök_°a
)

2330 
u8
 *
mac_ˇp_öfo
 =

2331 &
lök_°a
->
he_ˇp
.
he_ˇp_ñem
.
mac_ˇp_öfo
[0];

2332 
__À32
 
htc_Êags
 = 0;

2334 i‡(
mac_ˇp_öfo
[0] & 
IEEE80211_HE_MAC_CAP0_HTC_HE
)

2335 
htc_Êags
 |
	`˝u_to_À32
(
IWL_HE_HTC_SUPPORT
);

2336 i‡((
mac_ˇp_öfo
[1] & 
IEEE80211_HE_MAC_CAP1_LINK_ADAPTATION
) ||

2337 (
mac_ˇp_öfo
[2] & 
IEEE80211_HE_MAC_CAP2_LINK_ADAPTATION
)) {

2338 
u8
 
lök_ad≠
 =

2339 ((
mac_ˇp_öfo
[2] &

2340 
IEEE80211_HE_MAC_CAP2_LINK_ADAPTATION
) << 1) +

2341 (
mac_ˇp_öfo
[1] &

2342 
IEEE80211_HE_MAC_CAP1_LINK_ADAPTATION
);

2344 i‡(
lök_ad≠
 == 2)

2345 
htc_Êags
 |=

2346 
	`˝u_to_À32
(
IWL_HE_HTC_LINK_ADAP_UNSOLICITED
);

2347 i‡(
lök_ad≠
 == 3)

2348 
htc_Êags
 |
	`˝u_to_À32
(
IWL_HE_HTC_LINK_ADAP_BOTH
);

2350 i‡(
mac_ˇp_öfo
[2] & 
IEEE80211_HE_MAC_CAP2_BSR
)

2351 
htc_Êags
 |
	`˝u_to_À32
(
IWL_HE_HTC_BSR_SUPP
);

2352 i‡(
mac_ˇp_öfo
[3] & 
IEEE80211_HE_MAC_CAP3_OMI_CONTROL
)

2353 
htc_Êags
 |
	`˝u_to_À32
(
IWL_HE_HTC_OMI_SUPP
);

2354 i‡(
mac_ˇp_öfo
[4] & 
IEEE80211_HE_MAC_CAP4_BQR
)

2355 
htc_Êags
 |
	`˝u_to_À32
(
IWL_HE_HTC_BQR_SUPP
);

2357  
htc_Êags
;

2358 
	}
}

2360 
	$iwl_mvm_cfg_he_°a
(
iwl_mvm
 *
mvm
,

2361 
õì80211_vif
 *
vif
, 
u8
 
°a_id
)

2363 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

2364 
iwl_he_°a_c⁄ãxt_cmd_v3
 
°a_˘xt_cmd
 = {

2365 .
°a_id
 = sta_id,

2366 .
tid_limô
 = 
IWL_MAX_TID_COUNT
,

2367 .
bss_cﬁ‹
 = 
vif
->
bss_c⁄f
.
he_bss_cﬁ‹
.
cﬁ‹
,

2368 .
htc_åig_ba£d_pkt_ext
 = 
vif
->
bss_c⁄f
.htc_trig_based_pkt_ext,

2369 .
‰ame_time_πs_th
 =

2370 
	`˝u_to_À16
(
vif
->
bss_c⁄f
.
‰ame_time_πs_th
),

2372 
iwl_he_°a_c⁄ãxt_cmd_v2
 
°a_˘xt_cmd_v2
 = {};

2373 
u32
 
cmd_id
 = 
	`WIDE_ID
(
DATA_PATH_GROUP
, 
STA_HE_CTXT_CMD
);

2374 
u8
 
vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
cmd_id
, 2);

2375 
size
;

2376 
õì80211_°a
 *
°a
;

2377 
u32
 
Êags
;

2378 
i
;

2379 *
cmd
;

2381 i‡(!
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_API_MBSSID_HE
))

2382 
vî
 = 1;

2384 
vî
) {

2387 
cmd
 = &
°a_˘xt_cmd_v2
;

2388 
size
 = (
iwl_he_°a_c⁄ãxt_cmd_v1
);

2391 
cmd
 = &
°a_˘xt_cmd_v2
;

2392 
size
 = (
iwl_he_°a_c⁄ãxt_cmd_v2
);

2395 
cmd
 = &
°a_˘xt_cmd
;

2396 
size
 = (
iwl_he_°a_c⁄ãxt_cmd_v3
);

2399 
	`IWL_ERR
(
mvm
, "bad STA_HE_CTXT_CMD vîsi⁄ %d\n", 
vî
);

2403 
	`rcu_ªad_lock
();

2405 
°a
 = 
	`rcu_dîe„ªn˚
(
mvm
->
fw_id_to_mac_id
[
°a_˘xt_cmd
.
°a_id
]);

2406 i‡(
	`IS_ERR_OR_NULL
(
°a
)) {

2407 
	`rcu_ªad_u∆ock
();

2408 
	`WARN
(1, "Can't find STAÅo configure HE\n");

2412 i‡(!
°a
->
deÊök
.
he_ˇp
.
has_he
) {

2413 
	`rcu_ªad_u∆ock
();

2417 
Êags
 = 0;

2420 i‡(
mvmvif
->
deÊök
.
he_ru_2mhz_block
)

2421 
Êags
 |
STA_CTXT_HE_RU_2MHZ_BLOCK
;

2424 
°a_˘xt_cmd
.
htc_Êags
 = 
	`iwl_mvm_gë_°a_htc_Êags
(
°a
, &°a->
deÊök
);

2427 i‡(!
	`iwl_mvm_£t_°a_pkt_ext
(
mvm
, &
°a
->
deÊök
, &
°a_˘xt_cmd
.
pkt_ext
))

2428 
Êags
 |
STA_CTXT_HE_PACKET_EXT
;

2430 i‡(
°a
->
deÊök
.
he_ˇp
.
he_ˇp_ñem
.
mac_ˇp_öfo
[2] &

2431 
IEEE80211_HE_MAC_CAP2_32BIT_BA_BITMAP
)

2432 
Êags
 |
STA_CTXT_HE_32BIT_BA_BITMAP
;

2434 i‡(
°a
->
deÊök
.
he_ˇp
.
he_ˇp_ñem
.
mac_ˇp_öfo
[2] &

2435 
IEEE80211_HE_MAC_CAP2_ACK_EN
)

2436 
Êags
 |
STA_CTXT_HE_ACK_ENABLED
;

2438 
	`rcu_ªad_u∆ock
();

2440 i‡(
	`iwl_mvm_£t_fw_mu_edˇ_∑øms
(
mvm
, &
mvmvif
->
deÊök
,

2441 &
°a_˘xt_cmd
.
åig_ba£d_txf
[0]))

2442 
Êags
 |
STA_CTXT_HE_MU_EDCA_CW
;

2444 i‡(
vif
->
bss_c⁄f
.
u‹a_exi°s
) {

2445 
Êags
 |
STA_CTXT_HE_TRIG_RND_ALLOC
;

2447 
°a_˘xt_cmd
.
ønd_Æloc_ecwmö
 =

2448 
vif
->
bss_c⁄f
.
u‹a_ocw_ønge
 & 0x7;

2449 
°a_˘xt_cmd
.
ønd_Æloc_ecwmax
 =

2450 (
vif
->
bss_c⁄f
.
u‹a_ocw_ønge
 >> 3) & 0x7;

2453 i‡(!
	`iwl_mvm_is_nic_ack_íabÀd
(
mvm
, 
vif
))

2454 
Êags
 |
STA_CTXT_HE_NIC_NOT_ACK_ENABLED
;

2456 i‡(
vif
->
bss_c⁄f
.
n⁄å™smôãd
) {

2457 
Êags
 |
STA_CTXT_HE_REF_BSSID_VALID
;

2458 
	`ëhî_addr_c›y
(
°a_˘xt_cmd
.
ªf_bssid_addr
,

2459 
vif
->
bss_c⁄f
.
å™smôãr_bssid
);

2460 
°a_˘xt_cmd
.
max_bssid_ödiˇt‹
 =

2461 
vif
->
bss_c⁄f
.
bssid_ödiˇt‹
;

2462 
°a_˘xt_cmd
.
bssid_ödex
 = 
vif
->
bss_c⁄f
.bssid_index;

2463 
°a_˘xt_cmd
.
ema_≠
 = 
vif
->
bss_c⁄f
.ema_ap;

2464 
°a_˘xt_cmd
.
¥ofûe_≥riodicôy
 =

2465 
vif
->
bss_c⁄f
.
¥ofûe_≥riodicôy
;

2468 
°a_˘xt_cmd
.
Êags
 = 
	`˝u_to_À32
(flags);

2470 i‡(
vî
 < 3) {

2472 
	`BUILD_BUG_ON
(
	`off£tof
(
	`ty≥of
(
°a_˘xt_cmd
), 
pkt_ext
) !=

2473 
	`off£tof
(
	`ty≥of
(
°a_˘xt_cmd_v2
), 
pkt_ext
));

2474 
	`mem˝y
(&
°a_˘xt_cmd_v2
, &
°a_˘xt_cmd
,

2475 
	`off£tof
(
	`ty≥of
(
°a_˘xt_cmd
), 
pkt_ext
));

2478 
i
 = 0;

2479 
i
 < 
	`ARRAY_SIZE
(
°a_˘xt_cmd_v2
.
pkt_ext
.
pkt_ext_qam_th
);

2480 
i
++) {

2481 
u8
 
bw
;

2483 
bw
 = 0;

2484 
bw
 < 
	`ARRAY_SIZE
(
°a_˘xt_cmd_v2
.
pkt_ext
.
pkt_ext_qam_th
[
i
]);

2485 
bw
++) {

2486 
	`BUILD_BUG_ON
((
°a_˘xt_cmd
.
pkt_ext
.
pkt_ext_qam_th
[
i
][
bw
]) !=

2487 (
°a_˘xt_cmd_v2
.
pkt_ext
.
pkt_ext_qam_th
[
i
][
bw
]));

2489 
	`mem˝y
(&
°a_˘xt_cmd_v2
.
pkt_ext
.
pkt_ext_qam_th
[
i
][
bw
],

2490 &
°a_˘xt_cmd
.
pkt_ext
.
pkt_ext_qam_th
[
i
][
bw
],

2491 (
°a_˘xt_cmd
.
pkt_ext
.
pkt_ext_qam_th
[
i
][
bw
]));

2496 
	`BUILD_BUG_ON
((
°a_˘xt_cmd
) -

2497 
	`off£to„nd
(
	`ty≥of
(
°a_˘xt_cmd
), 
pkt_ext
) !=

2498 (
°a_˘xt_cmd_v2
) -

2499 
	`off£to„nd
(
	`ty≥of
(
°a_˘xt_cmd_v2
), 
pkt_ext
));

2500 
	`mem˝y
((
u8
 *)&
°a_˘xt_cmd_v2
 +

2501 
	`off£to„nd
(
	`ty≥of
(
°a_˘xt_cmd_v2
), 
pkt_ext
),

2502 (
u8
 *)&
°a_˘xt_cmd
 +

2503 
	`off£to„nd
(
	`ty≥of
(
°a_˘xt_cmd
), 
pkt_ext
),

2504 (
°a_˘xt_cmd
) -

2505 
	`off£to„nd
(
	`ty≥of
(
°a_˘xt_cmd
), 
pkt_ext
));

2506 
°a_˘xt_cmd_v2
.
ª£rved3
 = 0;

2509 i‡(
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
cmd_id
, 0, 
size
, 
cmd
))

2510 
	`IWL_ERR
(
mvm
, "FailedÅo config FWÅo work HE!\n");

2511 
	}
}

2513 
	$iwl_mvm_¥Ÿe˘_assoc
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

2514 
u32
 
duøti⁄_ovîride
, 
lök_id
)

2516 
u32
 
duøti⁄
 = 
IWL_MVM_TE_SESSION_PROTECTION_MAX_TIME_MS
;

2517 
u32
 
mö_duøti⁄
 = 
IWL_MVM_TE_SESSION_PROTECTION_MIN_TIME_MS
;

2519 i‡(
duøti⁄_ovîride
 > 
duøti⁄
)

2520 
duøti⁄
 = 
duøti⁄_ovîride
;

2531 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

2532 
IWL_UCODE_TLV_CAPA_SESSION_PROT_CMD
))

2533 
	`iwl_mvm_scheduÀ_£ssi⁄_¥Ÿe˘i⁄
(
mvm
, 
vif
, 900,

2534 
mö_duøti⁄
, 
Ál£
,

2535 
lök_id
);

2537 
	`iwl_mvm_¥Ÿe˘_£ssi⁄
(
mvm
, 
vif
, 
duøti⁄
,

2538 
mö_duøti⁄
, 500, 
Ál£
);

2539 
	}
}

2542 
	$iwl_mvm_bss_öfo_ch™ged_°©i⁄_assoc
(
iwl_mvm
 *
mvm
,

2543 
õì80211_vif
 *
vif
,

2544 
u64
 
ch™ges
)

2546 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

2547 
ªt
;

2552 i‡(
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
) &&

2553 (
ch™ges
 & 
BSS_CHANGED_MU_GROUPS
Ë&& 
vif
->
bss_c⁄f
.
mu_mimo_ow√r
) {

2554 
ªt
 = 
	`iwl_mvm_upd©e_mu_groups
(
mvm
, 
vif
);

2555 i‡(
ªt
)

2556 
	`IWL_ERR
(
mvm
,

2560 
	`iwl_mvm_ªˇlc_mu…iˇ°
(
mvm
);

2563 
mvmvif
->
bf_d©a
.
ave_bóc⁄_sig«l
 = 0;

2565 
	`iwl_mvm_bt_c€x_vif_ch™ge
(
mvm
);

2566 
	`iwl_mvm_upd©e_smps_⁄_a˘ive_löks
(
mvm
, 
vif
, 
IWL_MVM_SMPS_REQ_TT
,

2567 
IEEE80211_SMPS_AUTOMATIC
);

2568 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

2569 
IWL_UCODE_TLV_CAPA_UMAC_SCAN
))

2570 
	`iwl_mvm_c⁄fig_sˇn
(
mvm
);

2571 
	}
}

2575 
	$iwl_mvm_bss_öfo_ch™ged_°©i⁄_comm⁄
(
iwl_mvm
 *
mvm
,

2576 
õì80211_vif
 *
vif
,

2577 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

2578 
u64
 
ch™ges
)

2580 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

2581 
ªt
;

2583 i‡(
ch™ges
 & 
BSS_CHANGED_BEACON_INFO
) {

2587 
	`iwl_mvm_°›_£ssi⁄_¥Ÿe˘i⁄
(
mvm
, 
vif
);

2589 
	`iwl_mvm_sf_upd©e
(
mvm
, 
vif
, 
Ál£
);

2590 
	`WARN_ON
(
	`iwl_mvm_íabÀ_bóc⁄_fûãr
(
mvm
, 
vif
));

2593 i‡(
ch™ges
 & (
BSS_CHANGED_PS
 | 
BSS_CHANGED_P2P_PS
 | 
BSS_CHANGED_QOS
 |

2597 
BSS_CHANGED_BEACON_INFO
)) {

2598 
ªt
 = 
	`iwl_mvm_powî_upd©e_mac
(
mvm
);

2599 i‡(
ªt
)

2600 
	`IWL_ERR
(
mvm
, "failedÅo updateÖower mode\n");

2603 i‡(
ch™ges
 & 
BSS_CHANGED_CQM
) {

2604 
	`IWL_DEBUG_MAC80211
(
mvm
, "cqm info_changed\n");

2606 
mvmvif
->
bf_d©a
.
œ°_cqm_evít
 = 0;

2607 i‡(
mvmvif
->
bf_d©a
.
bf_íabÀd
) {

2611 
ªt
 = 
	`iwl_mvm_íabÀ_bóc⁄_fûãr
(
mvm
, 
vif
);

2612 i‡(
ªt
)

2613 
	`IWL_ERR
(
mvm
,

2618 i‡(
ch™ges
 & 
BSS_CHANGED_BANDWIDTH
)

2619 
	`iwl_mvm_upd©e_lök_smps
(
vif
, 
lök_c⁄f
);

2620 
	}
}

2622 
	$iwl_mvm_bss_öfo_ch™ged_°©i⁄
(
iwl_mvm
 *
mvm
,

2623 
õì80211_vif
 *
vif
,

2624 
õì80211_bss_c⁄f
 *
bss_c⁄f
,

2625 
u64
 
ch™ges
)

2627 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

2628 
ªt
;

2629 
i
;

2636 i‡(
ch™ges
 & 
BSS_CHANGED_ASSOC
 && 
vif
->
cfg
.
assoc
) {

2637 i‡((
vif
->
bss_c⁄f
.
he_suµ‹t
 &&

2638 !
iwlwifi_mod_∑øms
.
dißbÀ_11ax
))

2639 
	`iwl_mvm_cfg_he_°a
(
mvm
, 
vif
, 
mvmvif
->
deÊök
.
≠_°a_id
);

2641 
	`iwl_mvm_mac_˘xt_ªˇlc_tsf_id
(
mvm
, 
vif
);

2645 i‡(
ch™ges
 & 
BSS_CHANGED_QOS
 && 
mvmvif
->
assocüãd
 &&

2646 
vif
->
cfg
.
assoc
 &&

2647 (
vif
->
bss_c⁄f
.
he_suµ‹t
 && !
iwlwifi_mod_∑øms
.
dißbÀ_11ax
))

2648 
	`iwl_mvm_cfg_he_°a
(
mvm
, 
vif
, 
mvmvif
->
deÊök
.
≠_°a_id
);

2656 i‡(
ch™ges
 & 
BSS_CHANGED_BSSID
 && !
mvmvif
->
assocüãd
)

2657 
	`mem˝y
(
mvmvif
->
deÊök
.
bssid
, 
bss_c⁄f
->bssid, 
ETH_ALEN
);

2659 
ªt
 = 
	`iwl_mvm_mac_˘xt_ch™ged
(
mvm
, 
vif
, 
Ál£
, 
mvmvif
->
deÊök
.
bssid
);

2660 i‡(
ªt
)

2661 
	`IWL_ERR
(
mvm
, "ÁûedÅÿupd©êMAC %pM\n", 
vif
->
addr
);

2664 
	`mem˝y
(
mvmvif
->
deÊök
.
bssid
, 
bss_c⁄f
->bssid, 
ETH_ALEN
);

2665 
mvmvif
->
assocüãd
 = 
vif
->
cfg
.
assoc
;

2667 i‡(
ch™ges
 & 
BSS_CHANGED_ASSOC
) {

2668 i‡(
vif
->
cfg
.
assoc
) {

2670 
	`iwl_mvm_ªque°_°©i°ics
(
mvm
, 
åue
);

2671 
	`f‹_óch_mvm_vif_vÆid_lök
(
mvmvif
, 
i
)

2672 
	`mem£t
(&
mvmvif
->
lök
[
i
]->
bóc⁄_°©s
, 0,

2673 (
mvmvif
->
lök
[
i
]->
bóc⁄_°©s
));

2676 
ªt
 = 
	`iwl_mvm_upd©e_quŸas
(
mvm
, 
åue
, 
NULL
);

2677 i‡(
ªt
) {

2678 
	`IWL_ERR
(
mvm
, "failedÅo update quotas\n");

2682 i‡(
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
,

2683 &
mvm
->
°©us
) &&

2684 !
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

2685 
IWL_UCODE_TLV_CAPA_SESSION_PROT_CMD
)) {

2704 
u32
 
dur
 = (11 * 
vif
->
bss_c⁄f
.
bóc⁄_öt
) / 10;

2705 
	`iwl_mvm_¥Ÿe˘_£ssi⁄
(
mvm
, 
vif
, 
dur
, dur,

2706 5 * 
dur
, 
Ál£
);

2707 } i‡(!
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
,

2708 &
mvm
->
°©us
) &&

2709 !
vif
->
bss_c⁄f
.
dtim_≥riod
) {

2720 
	`iwl_mvm_¥Ÿe˘_assoc
(
mvm
, 
vif
, 0, 0);

2723 
	`iwl_mvm_sf_upd©e
(
mvm
, 
vif
, 
Ál£
);

2724 
	`iwl_mvm_powî_vif_assoc
(
mvm
, 
vif
);

2725 i‡(
vif
->
p2p
) {

2726 
	`iwl_mvm_upd©e_smps
(
mvm
, 
vif
,

2727 
IWL_MVM_SMPS_REQ_PROT
,

2728 
IEEE80211_SMPS_DYNAMIC
, 0);

2730 } i‡(
mvmvif
->
deÊök
.
≠_°a_id
 !
IWL_MVM_INVALID_STA
) {

2731 
	`iwl_mvm_mei_ho°_dißssocüãd
(
mvm
);

2736 
ªt
 = 
	`iwl_mvm_sf_upd©e
(
mvm
, 
vif
, 
Ál£
);

2737 
	`WARN_ONCE
(
ªt
 &&

2738 !
	`ã°_bô
(
IWL_MVM_STATUS_HW_RESTART_REQUESTED
,

2739 &
mvm
->
°©us
),

2750 i‡(!
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
,

2751 &
mvm
->
°©us
)) {

2753 
	`iwl_mvm_£c_key_ªmove_≠
(
mvm
, 
vif
,

2754 &
mvmvif
->
deÊök
, 0);

2760 
ªt
 = 
	`iwl_mvm_rm_°a_id
(
mvm
, 
vif
,

2761 
mvmvif
->
deÊök
.
≠_°a_id
);

2762 i‡(
ªt
)

2763 
	`IWL_ERR
(
mvm
,

2766 
mvmvif
->
deÊök
.
≠_°a_id
 = 
IWL_MVM_INVALID_STA
;

2770 
ªt
 = 
	`iwl_mvm_upd©e_quŸas
(
mvm
, 
Ál£
, 
NULL
);

2771 i‡(
ªt
)

2772 
	`IWL_ERR
(
mvm
, "failedÅo update quotas\n");

2775 
ªt
 = 
	`iwl_mvm_mac_˘xt_ch™ged
(
mvm
, 
vif
, 
Ál£
, 
NULL
);

2776 i‡(
ªt
)

2777 
	`IWL_ERR
(
mvm
,

2779 
vif
->
addr
);

2782 
	`iwl_mvm_bss_öfo_ch™ged_°©i⁄_assoc
(
mvm
, 
vif
, 
ch™ges
);

2785 
	`iwl_mvm_bss_öfo_ch™ged_°©i⁄_comm⁄
(
mvm
, 
vif
, &vif->
bss_c⁄f
,

2786 
ch™ges
);

2787 
	}
}

2789 
boﬁ
 
	$iwl_mvm_°¨t_≠_ibss_comm⁄
(
õì80211_hw
 *
hw
,

2790 
õì80211_vif
 *
vif
,

2791 *
ªt
)

2793 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

2794 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

2795 
i
;

2797 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

2799 
mvmvif
->
≠_assoc_°a_cou¡
 = 0;

2802 
mvmvif
->
≠_ibss_a˘ive
 = 
åue
;

2805 
i
 = 0; i < 
	`ARRAY_SIZE
(
mvmvif
->
≠_óæy_keys
); i++) {

2806 
õì80211_key_c⁄f
 *
key
 = 
mvmvif
->
≠_óæy_keys
[
i
];

2808 i‡(!
key
)

2811 
mvmvif
->
≠_óæy_keys
[
i
] = 
NULL
;

2813 *
ªt
 = 
	`__iwl_mvm_mac_£t_key
(
hw
, 
SET_KEY
, 
vif
, 
NULL
, 
key
);

2814 i‡(*
ªt
)

2815  
åue
;

2818 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
 && !vif->
p2p
) {

2819 
	`iwl_mvm_vif_£t_low_œãncy
(
mvmvif
, 
åue
,

2820 
LOW_LATENCY_VIF_TYPE
);

2821 
	`iwl_mvm_£nd_low_œãncy_cmd
(
mvm
, 
åue
, 
mvmvif
->
id
);

2825 
	`iwl_mvm_powî_upd©e_mac
(
mvm
);

2827  
Ál£
;

2828 
	}
}

2830 
	$iwl_mvm_°¨t_≠_ibss
(
õì80211_hw
 *
hw
,

2831 
õì80211_vif
 *
vif
,

2832 
õì80211_bss_c⁄f
 *
lök_c⁄f
)

2834 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

2835 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

2836 
ªt
;

2838 
	`muãx_lock
(&
mvm
->
muãx
);

2845 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
)

2846 
	`iwl_mvm_mac_˘xt_ªˇlc_tsf_id
(
mvm
, 
vif
);

2852 i‡(
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 > 
IWL_DEVICE_FAMILY_22000
) {

2854 
ªt
 = 
	`iwl_mvm_mac_˘xt_add
(
mvm
, 
vif
);

2855 i‡(
ªt
)

2856 
out_u∆ock
;

2859 
ªt
 = 
	`iwl_mvm_mac_˘xt_bóc⁄_ch™ged
(
mvm
, 
vif
, 
lök_c⁄f
);

2860 i‡(
ªt
)

2861 
out_u∆ock
;

2864 
ªt
 = 
	`iwl_mvm_mac_˘xt_bóc⁄_ch™ged
(
mvm
, 
vif
, 
lök_c⁄f
);

2865 i‡(
ªt
)

2866 
out_u∆ock
;

2869 
ªt
 = 
	`iwl_mvm_mac_˘xt_add
(
mvm
, 
vif
);

2870 i‡(
ªt
)

2871 
out_u∆ock
;

2875 
ªt
 = 
	`iwl_mvm_bödög_add_vif
(
mvm
, 
vif
);

2876 i‡(
ªt
)

2877 
out_ªmove
;

2886 i‡(
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_API_STA_TYPE
)) {

2887 
ªt
 = 
	`iwl_mvm_add_mˇ°_°a
(
mvm
, 
vif
);

2888 i‡(
ªt
)

2889 
out_unböd
;

2894 
ªt
 = 
	`iwl_mvm_£nd_add_bˇ°_°a
(
mvm
, 
vif
);

2895 i‡(
ªt
) {

2896 
	`iwl_mvm_rm_mˇ°_°a
(
mvm
, 
vif
);

2897 
out_unböd
;

2904 
ªt
 = 
	`iwl_mvm_£nd_add_bˇ°_°a
(
mvm
, 
vif
);

2905 i‡(
ªt
)

2906 
out_unböd
;

2907 
ªt
 = 
	`iwl_mvm_add_mˇ°_°a
(
mvm
, 
vif
);

2908 i‡(
ªt
) {

2909 
	`iwl_mvm_£nd_rm_bˇ°_°a
(
mvm
, 
vif
);

2910 
out_unböd
;

2914 i‡(
	`iwl_mvm_°¨t_≠_ibss_comm⁄
(
hw
, 
vif
, &
ªt
))

2915 
out_Áûed
;

2917 
ªt
 = 
	`iwl_mvm_upd©e_quŸas
(
mvm
, 
Ál£
, 
NULL
);

2918 i‡(
ªt
)

2919 
out_Áûed
;

2922 i‡(
vif
->
p2p
 && 
mvm
->
p2p_devi˚_vif
)

2923 
	`iwl_mvm_mac_˘xt_ch™ged
(
mvm
, mvm->
p2p_devi˚_vif
, 
Ál£
, 
NULL
);

2925 
	`iwl_mvm_bt_c€x_vif_ch™ge
(
mvm
);

2928 i‡(
	`iwl_mvm_phy_˘x_cou¡
(
mvm
) > 1)

2929 
	`iwl_mvm_ã¨down_tdls_≥îs
(
mvm
);

2931 
	`iwl_mvm_·m_ª°¨t_ª•⁄dî
(
mvm
, 
vif
, &vif->
bss_c⁄f
);

2933 
out_u∆ock
;

2935 
out_Áûed
:

2936 
	`iwl_mvm_powî_upd©e_mac
(
mvm
);

2937 
mvmvif
->
≠_ibss_a˘ive
 = 
Ál£
;

2938 
	`iwl_mvm_£nd_rm_bˇ°_°a
(
mvm
, 
vif
);

2939 
	`iwl_mvm_rm_mˇ°_°a
(
mvm
, 
vif
);

2940 
out_unböd
:

2941 
	`iwl_mvm_bödög_ªmove_vif
(
mvm
, 
vif
);

2942 
out_ªmove
:

2943 
	`iwl_mvm_mac_˘xt_ªmove
(
mvm
, 
vif
);

2944 
out_u∆ock
:

2945 
	`muãx_u∆ock
(&
mvm
->
muãx
);

2946  
ªt
;

2947 
	}
}

2949 
	$iwl_mvm_°¨t_≠
(
õì80211_hw
 *
hw
,

2950 
õì80211_vif
 *
vif
,

2951 
õì80211_bss_c⁄f
 *
lök_c⁄f
)

2953  
	`iwl_mvm_°¨t_≠_ibss
(
hw
, 
vif
, 
lök_c⁄f
);

2954 
	}
}

2956 
	$iwl_mvm_°¨t_ibss
(
õì80211_hw
 *
hw
,

2957 
õì80211_vif
 *
vif
)

2959  
	`iwl_mvm_°¨t_≠_ibss
(
hw
, 
vif
, &vif->
bss_c⁄f
);

2960 
	}
}

2963 
	$iwl_mvm_°›_≠_ibss_comm⁄
(
iwl_mvm
 *
mvm
,

2964 
õì80211_vif
 *
vif
)

2966 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

2968 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

2970 
	`iwl_mvm_¥ï¨e_mac_ªmovÆ
(
mvm
, 
vif
);

2973 i‡(
	`rcu_ac˚ss_poöãr
(
mvm
->
cß_vif
Ë=
vif
) {

2974 
	`iwl_mvm_ªmove_time_evít
(
mvm
, 
mvmvif
,

2975 &
mvmvif
->
time_evít_d©a
);

2976 
	`RCU_INIT_POINTER
(
mvm
->
cß_vif
, 
NULL
);

2977 
mvmvif
->
cß_cou¡down
 = 
Ál£
;

2980 i‡(
	`rcu_ac˚ss_poöãr
(
mvm
->
cß_tx_blocked_vif
Ë=
vif
) {

2981 
	`RCU_INIT_POINTER
(
mvm
->
cß_tx_blocked_vif
, 
NULL
);

2982 
mvm
->
cß_tx_block_b˙_timeout
 = 0;

2985 
mvmvif
->
≠_ibss_a˘ive
 = 
Ál£
;

2986 
mvm
->
≠_œ°_bóc⁄_gp2
 = 0;

2988 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
 && !vif->
p2p
) {

2989 
	`iwl_mvm_vif_£t_low_œãncy
(
mvmvif
, 
Ál£
,

2990 
LOW_LATENCY_VIF_TYPE
);

2991 
	`iwl_mvm_£nd_low_œãncy_cmd
(
mvm
, 
Ál£
, 
mvmvif
->
id
);

2994 
	`iwl_mvm_bt_c€x_vif_ch™ge
(
mvm
);

2995 
	}
}

2997 
	$iwl_mvm_°›_≠_ibss
(
õì80211_hw
 *
hw
,

2998 
õì80211_vif
 *
vif
,

2999 
õì80211_bss_c⁄f
 *
lök_c⁄f
)

3001 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

3003 
	`muãx_lock
(&
mvm
->
muãx
);

3005 
	`iwl_mvm_°›_≠_ibss_comm⁄
(
mvm
, 
vif
);

3008 i‡(
vif
->
p2p
 && 
mvm
->
p2p_devi˚_vif
)

3009 
	`iwl_mvm_mac_˘xt_ch™ged
(
mvm
, mvm->
p2p_devi˚_vif
, 
Ál£
, 
NULL
);

3011 
	`iwl_mvm_upd©e_quŸas
(
mvm
, 
Ál£
, 
NULL
);

3013 
	`iwl_mvm_·m_ª•⁄dî_˛ór
(
mvm
, 
vif
);

3023 i‡(!
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_API_STA_TYPE
))

3024 
	`iwl_mvm_rm_mˇ°_°a
(
mvm
, 
vif
);

3025 
	`iwl_mvm_£nd_rm_bˇ°_°a
(
mvm
, 
vif
);

3026 i‡(
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_API_STA_TYPE
))

3027 
	`iwl_mvm_rm_mˇ°_°a
(
mvm
, 
vif
);

3028 
	`iwl_mvm_bödög_ªmove_vif
(
mvm
, 
vif
);

3030 
	`iwl_mvm_powî_upd©e_mac
(
mvm
);

3032 
	`iwl_mvm_mac_˘xt_ªmove
(
mvm
, 
vif
);

3034 
	`muãx_u∆ock
(&
mvm
->
muãx
);

3035 
	}
}

3037 
	$iwl_mvm_°›_≠
(
õì80211_hw
 *
hw
,

3038 
õì80211_vif
 *
vif
,

3039 
õì80211_bss_c⁄f
 *
lök_c⁄f
)

3041 
	`iwl_mvm_°›_≠_ibss
(
hw
, 
vif
, 
lök_c⁄f
);

3042 
	}
}

3044 
	$iwl_mvm_°›_ibss
(
õì80211_hw
 *
hw
,

3045 
õì80211_vif
 *
vif
)

3047 
	`iwl_mvm_°›_≠_ibss
(
hw
, 
vif
, &vif->
bss_c⁄f
);

3048 
	}
}

3051 
	$iwl_mvm_bss_öfo_ch™ged_≠_ibss
(
iwl_mvm
 *
mvm
,

3052 
õì80211_vif
 *
vif
,

3053 
õì80211_bss_c⁄f
 *
bss_c⁄f
,

3054 
u64
 
ch™ges
)

3056 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

3059 i‡(!
mvmvif
->
≠_ibss_a˘ive
)

3062 i‡(
ch™ges
 & (
BSS_CHANGED_ERP_CTS_PROT
 | 
BSS_CHANGED_HT
 |

3063 
BSS_CHANGED_BANDWIDTH
 | 
BSS_CHANGED_QOS
) &&

3064 
	`iwl_mvm_mac_˘xt_ch™ged
(
mvm
, 
vif
, 
Ál£
, 
NULL
))

3065 
	`IWL_ERR
(
mvm
, "ÁûedÅÿupd©êMAC %pM\n", 
vif
->
addr
);

3068 i‡(
ch™ges
 & 
BSS_CHANGED_BEACON
 &&

3069 
	`iwl_mvm_mac_˘xt_bóc⁄_ch™ged
(
mvm
, 
vif
, &vif->
bss_c⁄f
))

3070 
	`IWL_WARN
(
mvm
, "Failed updating beacon data\n");

3072 i‡(
ch™ges
 & 
BSS_CHANGED_FTM_RESPONDER
) {

3073 
ªt
 = 
	`iwl_mvm_·m_°¨t_ª•⁄dî
(
mvm
, 
vif
, &vif->
bss_c⁄f
);

3075 i‡(
ªt
)

3076 
	`IWL_WARN
(
mvm
, "FailedÅoÉnable FTMÑesponder (%d)\n",

3077 
ªt
);

3080 
	}
}

3082 
	$iwl_mvm_bss_öfo_ch™ged
(
õì80211_hw
 *
hw
,

3083 
õì80211_vif
 *
vif
,

3084 
õì80211_bss_c⁄f
 *
bss_c⁄f
,

3085 
u64
 
ch™ges
)

3087 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

3089 
	`muãx_lock
(&
mvm
->
muãx
);

3091 i‡(
ch™ges
 & 
BSS_CHANGED_IDLE
 && !
vif
->
cfg
.
idÀ
)

3092 
	`iwl_mvm_sˇn_°›
(
mvm
, 
IWL_MVM_SCAN_SCHED
, 
åue
);

3094 
vif
->
ty≥
) {

3095 
NL80211_IFTYPE_STATION
:

3096 
	`iwl_mvm_bss_öfo_ch™ged_°©i⁄
(
mvm
, 
vif
, 
bss_c⁄f
, 
ch™ges
);

3098 
NL80211_IFTYPE_AP
:

3099 
NL80211_IFTYPE_ADHOC
:

3100 
	`iwl_mvm_bss_öfo_ch™ged_≠_ibss
(
mvm
, 
vif
, 
bss_c⁄f
, 
ch™ges
);

3102 
NL80211_IFTYPE_MONITOR
:

3103 i‡(
ch™ges
 & 
BSS_CHANGED_MU_GROUPS
)

3104 
	`iwl_mvm_upd©e_mu_groups
(
mvm
, 
vif
);

3108 
	`WARN_ON_ONCE
(1);

3111 i‡(
ch™ges
 & 
BSS_CHANGED_TXPOWER
) {

3112 
	`IWL_DEBUG_CALIB
(
mvm
, "Changing TX PowerÅo %d dBm\n",

3113 
bss_c⁄f
->
txpowî
);

3114 
	`iwl_mvm_£t_tx_powî
(
mvm
, 
vif
, 
bss_c⁄f
->
txpowî
);

3117 
	`muãx_u∆ock
(&
mvm
->
muãx
);

3118 
	}
}

3120 
	$iwl_mvm_mac_hw_sˇn
(
õì80211_hw
 *
hw
, 
õì80211_vif
 *
vif
,

3121 
õì80211_sˇn_ªque°
 *
hw_ªq
)

3123 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

3124 
ªt
;

3126 i‡(
hw_ªq
->
ªq
.
n_ch™√ls
 == 0 ||

3127 
hw_ªq
->
ªq
.
n_ch™√ls
 > 
mvm
->
fw
->
ucode_ˇ∑
.
n_sˇn_ch™√ls
)

3128  -
EINVAL
;

3130 
	`muãx_lock
(&
mvm
->
muãx
);

3131 
ªt
 = 
	`iwl_mvm_ªg_sˇn_°¨t
(
mvm
, 
vif
, &
hw_ªq
->
ªq
, &hw_ªq->
õs
);

3132 
	`muãx_u∆ock
(&
mvm
->
muãx
);

3134  
ªt
;

3135 
	}
}

3137 
	$iwl_mvm_mac_ˇn˚l_hw_sˇn
(
õì80211_hw
 *
hw
,

3138 
õì80211_vif
 *
vif
)

3140 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

3142 
	`muãx_lock
(&
mvm
->
muãx
);

3151 i‡(
mvm
->
sˇn_°©us
 & 
IWL_MVM_SCAN_REGULAR
)

3152 
	`iwl_mvm_sˇn_°›
(
mvm
, 
IWL_MVM_SCAN_REGULAR
, 
åue
);

3154 
	`muãx_u∆ock
(&
mvm
->
muãx
);

3155 
	}
}

3158 
	$iwl_mvm_mac_Ælow_buf„ªd_‰ames
(
õì80211_hw
 *
hw
,

3159 
õì80211_°a
 *
°a
, 
u16
 
tids
,

3160 
num_‰ames
,

3161 
õì80211_‰ame_ªÀa£_ty≥
 
ªas⁄
,

3162 
boﬁ
 
m‹e_d©a
)

3164 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

3168 
	`iwl_mvm_°a_modify_¶ìp_tx_cou¡
(
mvm
, 
°a
, 
ªas⁄
, 
num_‰ames
,

3169 
tids
, 
m‹e_d©a
, 
Ál£
);

3170 
	}
}

3173 
	$iwl_mvm_mac_ªÀa£_buf„ªd_‰ames
(
õì80211_hw
 *
hw
,

3174 
õì80211_°a
 *
°a
, 
u16
 
tids
,

3175 
num_‰ames
,

3176 
õì80211_‰ame_ªÀa£_ty≥
 
ªas⁄
,

3177 
boﬁ
 
m‹e_d©a
)

3179 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

3183 
	`iwl_mvm_°a_modify_¶ìp_tx_cou¡
(
mvm
, 
°a
, 
ªas⁄
, 
num_‰ames
,

3184 
tids
, 
m‹e_d©a
, 
åue
);

3185 
	}
}

3187 
	$__iwl_mvm_mac_°a_nŸify
(
õì80211_hw
 *
hw
,

3188 
°a_nŸify_cmd
 
cmd
,

3189 
õì80211_°a
 *
°a
)

3191 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

3192 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

3193 
txqs
 = 0, 
tids
 = 0;

3194 
tid
;

3201 i‡(
	`WARN_ON
(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)))

3204 
	`•ö_lock_bh
(&
mvm°a
->
lock
);

3205 
tid
 = 0;Åid < 
	`ARRAY_SIZE
(
mvm°a
->
tid_d©a
);Åid++) {

3206 
iwl_mvm_tid_d©a
 *
tid_d©a
 = &
mvm°a
->tid_d©a[
tid
];

3208 i‡(
tid_d©a
->
txq_id
 =
IWL_MVM_INVALID_QUEUE
)

3211 
	`__£t_bô
(
tid_d©a
->
txq_id
, &
txqs
);

3213 i‡(
	`iwl_mvm_tid_queued
(
mvm
, 
tid_d©a
) == 0)

3216 
	`__£t_bô
(
tid
, &
tids
);

3219 
cmd
) {

3220 
STA_NOTIFY_SLEEP
:

3221 
	`f‹_óch_£t_bô
(
tid
, &
tids
, 
IWL_MAX_TID_COUNT
)

3222 
	`õì80211_°a_£t_buf„ªd
(
°a
, 
tid
, 
åue
);

3224 i‡(
txqs
)

3225 
	`iwl_å™s_‰ìze_txq_timî
(
mvm
->
å™s
, 
txqs
, 
åue
);

3232 
STA_NOTIFY_AWAKE
:

3233 i‡(
	`WARN_ON
(
mvm°a
->
deÊök
.
°a_id
 =
IWL_MVM_INVALID_STA
))

3236 i‡(
txqs
)

3237 
	`iwl_å™s_‰ìze_txq_timî
(
mvm
->
å™s
, 
txqs
, 
Ál£
);

3238 
	`iwl_mvm_°a_modify_ps_wake
(
mvm
, 
°a
);

3243 
	`•ö_u∆ock_bh
(&
mvm°a
->
lock
);

3244 
	}
}

3246 
	$iwl_mvm_mac_°a_nŸify
(
õì80211_hw
 *
hw
, 
õì80211_vif
 *
vif
,

3247 
°a_nŸify_cmd
 
cmd
, 
õì80211_°a
 *
°a
)

3249 
	`__iwl_mvm_mac_°a_nŸify
(
hw
, 
cmd
, 
°a
);

3250 
	}
}

3252 
	$iwl_mvm_°a_pm_nŸif
(
iwl_mvm
 *
mvm
, 
iwl_rx_cmd_buf„r
 *
rxb
)

3254 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

3255 
iwl_mvm_pm_°©e_nŸifiˇti⁄
 *
nŸif
 = (*)
pkt
->
d©a
;

3256 
õì80211_°a
 *
°a
;

3257 
iwl_mvm_°a
 *
mvm°a
;

3258 
boﬁ
 
¶ìpög
 = (
nŸif
->
ty≥
 !
IWL_MVM_PM_EVENT_AWAKE
);

3260 i‡(
	`WARN_ON
(
nŸif
->
°a_id
 >
mvm
->
fw
->
ucode_ˇ∑
.
num_°©i⁄s
))

3263 
	`rcu_ªad_lock
();

3264 
°a
 = 
	`rcu_dîe„ªn˚
(
mvm
->
fw_id_to_mac_id
[
nŸif
->
°a_id
]);

3265 i‡(
	`WARN_ON
(
	`IS_ERR_OR_NULL
(
°a
))) {

3266 
	`rcu_ªad_u∆ock
();

3270 
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

3272 i‡(!
mvm°a
->
vif
 ||

3273 
mvm°a
->
vif
->
ty≥
 !
NL80211_IFTYPE_AP
) {

3274 
	`rcu_ªad_u∆ock
();

3278 i‡(
mvm°a
->
¶ìpög
 != sleeping) {

3279 
mvm°a
->
¶ìpög
 = sleeping;

3280 
	`__iwl_mvm_mac_°a_nŸify
(
mvm
->
hw
,

3281 
¶ìpög
 ? 
STA_NOTIFY_SLEEP
 : 
STA_NOTIFY_AWAKE
,

3282 
°a
);

3283 
	`õì80211_°a_ps_å™sôi⁄
(
°a
, 
¶ìpög
);

3286 i‡(
¶ìpög
) {

3287 
nŸif
->
ty≥
) {

3288 
IWL_MVM_PM_EVENT_AWAKE
:

3289 
IWL_MVM_PM_EVENT_ASLEEP
:

3291 
IWL_MVM_PM_EVENT_UAPSD
:

3292 
	`õì80211_°a_u≠sd_åiggî
(
°a
, 
IEEE80211_NUM_TIDS
);

3294 
IWL_MVM_PM_EVENT_PS_POLL
:

3295 
	`õì80211_°a_p•ﬁl
(
°a
);

3302 
	`rcu_ªad_u∆ock
();

3303 
	}
}

3305 
	$iwl_mvm_°a_¥e_rcu_ªmove
(
õì80211_hw
 *
hw
,

3306 
õì80211_vif
 *
vif
,

3307 
õì80211_°a
 *
°a
)

3309 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

3310 
iwl_mvm_°a
 *
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

3311 
lök_id
;

3323 
	`muãx_lock
(&
mvm
->
muãx
);

3324 
lök_id
 = 0;Üök_id < 
	`ARRAY_SIZE
(
mvm_°a
->
lök
);Üink_id++) {

3325 
iwl_mvm_lök_°a
 *
lök_°a
;

3326 
u32
 
°a_id
;

3328 i‡(!
mvm_°a
->
lök
[
lök_id
])

3331 
lök_°a
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm_°a
->
lök
[
lök_id
],

3332 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

3333 
°a_id
 = 
lök_°a
->sta_id;

3334 i‡(
°a
 =
	`rcu_ac˚ss_poöãr
(
mvm
->
fw_id_to_mac_id
[
°a_id
])) {

3335 
	`RCU_INIT_POINTER
(
mvm
->
fw_id_to_mac_id
[
°a_id
],

3336 
	`ERR_PTR
(-
ENOENT
));

3337 
	`RCU_INIT_POINTER
(
mvm
->
fw_id_to_lök_°a
[
°a_id
], 
NULL
);

3340 
	`muãx_u∆ock
(&
mvm
->
muãx
);

3341 
	}
}

3343 
	$iwl_mvm_check_u≠sd
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

3344 c⁄° 
u8
 *
bssid
)

3346 
i
;

3348 i‡(!
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
)) {

3349 
iwl_mvm_tcm_mac
 *
md©a
;

3351 
md©a
 = &
mvm
->
tcm
.
d©a
[
	`iwl_mvm_vif_‰om_mac80211
(
vif
)->
id
];

3352 
	`ewma_øã_öô
(&
md©a
->
u≠sd_n⁄agg_dëe˘
.
øã
);

3353 
md©a
->
›íed_rx_ba_£ssi⁄s
 = 
Ál£
;

3356 i‡(!(
mvm
->
fw
->
ucode_ˇ∑
.
Êags
 & 
IWL_UCODE_TLV_FLAGS_UAPSD_SUPPORT
))

3359 i‡(
vif
->
p2p
 && !
	`iwl_mvm_is_p2p_scm_u≠sd_suµ‹ãd
(
mvm
)) {

3360 
vif
->
drivî_Êags
 &~
IEEE80211_VIF_SUPPORTS_UAPSD
;

3364 i‡(!
vif
->
p2p
 &&

3365 (
iwlwifi_mod_∑øms
.
u≠sd_dißbÀ
 & 
IWL_DISABLE_UAPSD_BSS
)) {

3366 
vif
->
drivî_Êags
 &~
IEEE80211_VIF_SUPPORTS_UAPSD
;

3370 
i
 = 0; i < 
IWL_MVM_UAPSD_NOAGG_LIST_LEN
; i++) {

3371 i‡(
	`ëhî_addr_equÆ
(
mvm
->
u≠sd_nﬂgg_bssids
[
i
].
addr
, 
bssid
)) {

3372 
vif
->
drivî_Êags
 &~
IEEE80211_VIF_SUPPORTS_UAPSD
;

3377 
vif
->
drivî_Êags
 |
IEEE80211_VIF_SUPPORTS_UAPSD
;

3378 
	}
}

3381 
	$iwl_mvm_tdls_check_åiggî
(
iwl_mvm
 *
mvm
,

3382 
õì80211_vif
 *
vif
, 
u8
 *
≥î_addr
,

3383 
∆80211_tdls_›î©i⁄
 
a˘i⁄
)

3385 
iwl_fw_dbg_åiggî_év
 *
åig
;

3386 
iwl_fw_dbg_åiggî_tdls
 *
tdls_åig
;

3388 
åig
 = 
	`iwl_fw_dbg_åiggî_⁄
(&
mvm
->
fwπ
, 
	`õì80211_vif_to_wdev
(
vif
),

3389 
FW_DBG_TRIGGER_TDLS
);

3390 i‡(!
åig
)

3393 
tdls_åig
 = (*)
åig
->
d©a
;

3395 i‡(!(
tdls_åig
->
a˘i⁄_bôm≠
 & 
	`BIT
(
a˘i⁄
)))

3398 i‡(
tdls_åig
->
≥î_mode
 &&

3399 
	`memcmp
(
tdls_åig
->
≥î
, 
≥î_addr
, 
ETH_ALEN
) != 0)

3402 
	`iwl_fw_dbg_cﬁÀ˘_åig
(&
mvm
->
fwπ
, 
åig
,

3404 
≥î_addr
, 
a˘i⁄
);

3405 
	}
}

3407 
	siwl_mvm_he_obss_«ºow_bw_ru_d©a
 {

3408 
boﬁ
 
	mtﬁî©ed
;

3411 
	$iwl_mvm_check_he_obss_«ºow_bw_ru_ôî
(
wùhy
 *wiphy,

3412 
cfg80211_bss
 *
bss
,

3413 *
_d©a
)

3415 
iwl_mvm_he_obss_«ºow_bw_ru_d©a
 *
d©a
 = 
_d©a
;

3416 c⁄° 
cfg80211_bss_õs
 *
õs
;

3417 c⁄° 
ñemít
 *
ñem
;

3419 
	`rcu_ªad_lock
();

3420 
õs
 = 
	`rcu_dîe„ªn˚
(
bss
->ies);

3421 
ñem
 = 
	`cfg80211_föd_ñem
(
WLAN_EID_EXT_CAPABILITY
, 
õs
->
d©a
,

3422 
õs
->
Àn
);

3424 i‡(!
ñem
 ||ÉÀm->
d©Æí
 < 10 ||

3425 !(
ñem
->
d©a
[10] &

3426 
WLAN_EXT_CAPA10_OBSS_NARROW_BW_RU_TOLERANCE_SUPPORT
)) {

3427 
d©a
->
tﬁî©ed
 = 
Ál£
;

3429 
	`rcu_ªad_u∆ock
();

3430 
	}
}

3433 
	$iwl_mvm_check_he_obss_«ºow_bw_ru
(
õì80211_hw
 *
hw
,

3434 
õì80211_vif
 *
vif
,

3435 
lök_id
,

3436 
õì80211_bss_c⁄f
 *
lök_c⁄f
)

3438 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

3439 
iwl_mvm_he_obss_«ºow_bw_ru_d©a
 
ôî_d©a
 = {

3440 .
tﬁî©ed
 = 
åue
,

3443 i‡(
	`WARN_ON_ONCE
(!
lök_c⁄f
->
ch™ªq
.
›î
.
ch™
 ||

3444 !
mvmvif
->
lök
[
lök_id
]))

3447 i‡(!(
lök_c⁄f
->
ch™ªq
.
›î
.
ch™
->
Êags
 & 
IEEE80211_CHAN_RADAR
)) {

3448 
mvmvif
->
lök
[
lök_id
]->
he_ru_2mhz_block
 = 
Ál£
;

3452 
	`cfg80211_bss_ôî
(
hw
->
wùhy
, &
lök_c⁄f
->
ch™ªq
.
›î
,

3453 
iwl_mvm_check_he_obss_«ºow_bw_ru_ôî
,

3454 &
ôî_d©a
);

3460 
mvmvif
->
lök
[
lök_id
]->
he_ru_2mhz_block
 = !
ôî_d©a
.
tﬁî©ed
;

3461 
	}
}

3463 
	$iwl_mvm_ª£t_cˇ_40mhz_w‹k¨ound
(
iwl_mvm
 *
mvm
,

3464 
õì80211_vif
 *
vif
)

3466 
õì80211_suµ‹ãd_b™d
 *
sb™d
;

3467 c⁄° 
õì80211_°a_he_ˇp
 *
he_ˇp
;

3469 i‡(
vif
->
ty≥
 !
NL80211_IFTYPE_STATION
)

3472 i‡(!
mvm
->
cˇ_40mhz_w‹k¨ound
)

3476 
mvm
->
cˇ_40mhz_w‹k¨ound
--;

3477 i‡(
mvm
->
cˇ_40mhz_w‹k¨ound
)

3480 
sb™d
 = 
mvm
->
hw
->
wùhy
->
b™ds
[
NL80211_BAND_2GHZ
];

3482 
sb™d
->
ht_ˇp
.
ˇp
 |
IEEE80211_HT_CAP_SUP_WIDTH_20_40
;

3484 
he_ˇp
 = 
	`õì80211_gë_he_i·y≥_ˇp_vif
(
sb™d
, 
vif
);

3486 i‡(
he_ˇp
) {

3488 
õì80211_°a_he_ˇp
 *
he
 = (*)(
uöçå_t
)
he_ˇp
;

3490 
he
->
he_ˇp_ñem
.
phy_ˇp_öfo
[0] |=

3491 
IEEE80211_HE_PHY_CAP0_CHANNEL_WIDTH_SET_40MHZ_IN_2G
;

3493 
	}
}

3495 
	$iwl_mvm_mei_ho°_assocüãd
(
iwl_mvm
 *
mvm
,

3496 
õì80211_vif
 *
vif
,

3497 
iwl_mvm_°a
 *
mvm_°a
)

3499 #i‡
	`IS_ENABLED
(
CONFIG_IWLMEI
)

3500 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

3501 
iwl_mei_c⁄n_öfo
 
c⁄n_öfo
 = {

3502 .
ssid_Àn
 = 
vif
->
cfg
.ssid_len,

3505 i‡(
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
))

3508 i‡(!
mvm
->
mei_ªgi°îed
)

3512 i‡(!
vif
->
bss_c⁄f
.
ch™ªq
.
›î
.
ch™
)

3515 
c⁄n_öfo
.
ch™√l
 = 
vif
->
bss_c⁄f
.
ch™ªq
.
›î
.
ch™
->
hw_vÆue
;

3517 
mvm_°a
->
∑úwi£_cùhî
) {

3518 
WLAN_CIPHER_SUITE_TKIP
:

3519 
c⁄n_öfo
.
∑úwi£_cùhî
 = 
IWL_MEI_CIPHER_TKIP
;

3521 
WLAN_CIPHER_SUITE_CCMP
:

3522 
c⁄n_öfo
.
∑úwi£_cùhî
 = 
IWL_MEI_CIPHER_CCMP
;

3524 
WLAN_CIPHER_SUITE_GCMP
:

3525 
c⁄n_öfo
.
∑úwi£_cùhî
 = 
IWL_MEI_CIPHER_GCMP
;

3527 
WLAN_CIPHER_SUITE_GCMP_256
:

3528 
c⁄n_öfo
.
∑úwi£_cùhî
 = 
IWL_MEI_CIPHER_GCMP_256
;

3538 
mvmvif
->
ªkey_d©a
.
akm
) {

3539 
WLAN_AKM_SUITE_SAE
 & 0xff:

3540 
c⁄n_öfo
.
auth_mode
 = 
IWL_MEI_AKM_AUTH_SAE
;

3542 
WLAN_AKM_SUITE_PSK
 & 0xff:

3543 
c⁄n_öfo
.
auth_mode
 = 
IWL_MEI_AKM_AUTH_RSNA_PSK
;

3545 
WLAN_AKM_SUITE_8021X
 & 0xff:

3546 
c⁄n_öfo
.
auth_mode
 = 
IWL_MEI_AKM_AUTH_RSNA
;

3550 
c⁄n_öfo
.
auth_mode
 = 
IWL_MEI_AKM_AUTH_OPEN
;

3558 
	`mem˝y
(
c⁄n_öfo
.
ssid
, 
vif
->
cfg
.ssid, vif->cfg.
ssid_Àn
);

3559 
	`mem˝y
(
c⁄n_öfo
.
bssid
, 
vif
->
bss_c⁄f
.bssid, 
ETH_ALEN
);

3562 
	`iwl_mei_ho°_assocüãd
(&
c⁄n_öfo
, 
NULL
);

3564 
	}
}

3566 
	$iwl_mvm_mac_˘xt_ch™ged_wøµî
(
iwl_mvm
 *
mvm
,

3567 
õì80211_vif
 *
vif
,

3568 
boﬁ
 
f‹˚_assoc_off
)

3570  
	`iwl_mvm_mac_˘xt_ch™ged
(
mvm
, 
vif
, 
f‹˚_assoc_off
, 
NULL
);

3571 
	}
}

3573 
	$iwl_mvm_mac_°a_°©e
(
õì80211_hw
 *
hw
,

3574 
õì80211_vif
 *
vif
,

3575 
õì80211_°a
 *
°a
,

3576 
õì80211_°a_°©e
 
ﬁd_°©e
,

3577 
õì80211_°a_°©e
 
√w_°©e
)

3579 c⁄° 
iwl_mvm_°a_°©e_›s
 
ˇŒbacks
 = {

3580 .
add_°a
 = 
iwl_mvm_add_°a
,

3581 .
upd©e_°a
 = 
iwl_mvm_upd©e_°a
,

3582 .
rm_°a
 = 
iwl_mvm_rm_°a
,

3583 .
mac_˘xt_ch™ged
 = 
iwl_mvm_mac_˘xt_ch™ged_wøµî
,

3586  
	`iwl_mvm_mac_°a_°©e_comm⁄
(
hw
, 
vif
, 
°a
, 
ﬁd_°©e
, 
√w_°©e
,

3587 &
ˇŒbacks
);

3588 
	}
}

3595 
	$iwl_mvm_rs_øã_öô_Æl_löks
(
iwl_mvm
 *
mvm
,

3596 
õì80211_vif
 *
vif
,

3597 
õì80211_°a
 *
°a
)

3599 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

3600 
lök_id
;

3602 
	`f‹_óch_mvm_vif_vÆid_lök
(
mvmvif
, 
lök_id
) {

3603 
õì80211_bss_c⁄f
 *
c⁄f
 =

3604 
	`lök_c⁄f_dîe„ªn˚_check
(
vif
, 
lök_id
);

3605 
õì80211_lök_°a
 *
lök_°a
 =

3606 
	`lök_°a_dîe„ªn˚_check
(
°a
, 
lök_id
);

3608 i‡(!
c⁄f
 || !
lök_°a
 || !
mvmvif
->
lök
[
lök_id
]->
phy_˘xt
)

3611 
	`iwl_mvm_rs_øã_öô
(
mvm
, 
vif
, 
°a
, 
c⁄f
, 
lök_°a
,

3612 
mvmvif
->
lök
[
lök_id
]->
phy_˘xt
->
ch™√l
->
b™d
);

3614 
	}
}

3616 
	#IWL_MVM_MIN_BEACON_INTERVAL_TU
 16

	)

3618 
boﬁ
 
	$iwl_mvm_vif_c⁄f_‰om_°a
(
iwl_mvm
 *
mvm
,

3619 
õì80211_vif
 *
vif
,

3620 
õì80211_°a
 *
°a
)

3622 
õì80211_lök_°a
 *
lök_°a
;

3623 
lök_id
;

3632 
	`f‹_óch_°a_a˘ive_lök
(
vif
, 
°a
, 
lök_°a
, 
lök_id
) {

3633 
õì80211_bss_c⁄f
 *
lök_c⁄f
 =

3634 
	`lök_c⁄f_dîe„ªn˚_¥Ÿe˘ed
(
vif
, 
lök_id
);

3636 i‡(!
lök_c⁄f
)

3639 i‡(
lök_c⁄f
->
bóc⁄_öt
 < 
IWL_MVM_MIN_BEACON_INTERVAL_TU
) {

3640 
	`IWL_ERR
(
mvm
,

3642 
lök_c⁄f
->
bóc⁄_öt
, 
lök_°a
->
addr
);

3643  
Ál£
;

3646 
lök_c⁄f
->
he_suµ‹t
 = 
lök_°a
->
he_ˇp
.
has_he
;

3649  
åue
;

3650 
	}
}

3652 
	$iwl_mvm_vif_£t_he_suµ‹t
(
õì80211_hw
 *
hw
,

3653 
õì80211_vif
 *
vif
,

3654 
õì80211_°a
 *
°a
,

3655 
boﬁ
 
is_°a
)

3657 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

3658 
õì80211_lök_°a
 *
lök_°a
;

3659 
lök_id
;

3661 
	`f‹_óch_°a_a˘ive_lök
(
vif
, 
°a
, 
lök_°a
, 
lök_id
) {

3662 
õì80211_bss_c⁄f
 *
lök_c⁄f
 =

3663 
	`lök_c⁄f_dîe„ªn˚_¥Ÿe˘ed
(
vif
, 
lök_id
);

3665 i‡(!
lök_c⁄f
 || !
mvmvif
->
lök
[
lök_id
])

3668 
lök_c⁄f
->
he_suµ‹t
 = 
lök_°a
->
he_ˇp
.
has_he
;

3670 i‡(
is_°a
) {

3671 
mvmvif
->
lök
[
lök_id
]->
he_ru_2mhz_block
 = 
Ál£
;

3672 i‡(
lök_°a
->
he_ˇp
.
has_he
)

3673 
	`iwl_mvm_check_he_obss_«ºow_bw_ru
(
hw
, 
vif
,

3674 
lök_id
,

3675 
lök_c⁄f
);

3678 
	}
}

3681 
	$iwl_mvm_°a_°©e_nŸexi°_to_n⁄e
(
iwl_mvm
 *
mvm
,

3682 
õì80211_vif
 *
vif
,

3683 
õì80211_°a
 *
°a
,

3684 c⁄° 
iwl_mvm_°a_°©e_›s
 *
ˇŒbacks
)

3686 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

3687 
õì80211_lök_°a
 *
lök_°a
;

3688 
i
;

3689 
ªt
;

3691 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

3693 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
 &&

3694 !
	`iwl_mvm_vif_c⁄f_‰om_°a
(
mvm
, 
vif
, 
°a
))

3695  -
EINVAL
;

3697 i‡(
°a
->
tdls
 &&

3698 (
vif
->
p2p
 ||

3699 
	`iwl_mvm_tdls_°a_cou¡
(
mvm
, 
NULL
Ë=
IWL_MVM_TDLS_STA_COUNT
 ||

3700 
	`iwl_mvm_phy_˘x_cou¡
(
mvm
) > 1)) {

3701 
	`IWL_DEBUG_MAC80211
(
mvm
, "refusing TDLS sta\n");

3702  -
EBUSY
;

3705 
ªt
 = 
ˇŒbacks
->
	`add_°a
(
mvm
, 
vif
, 
°a
);

3706 i‡(
°a
->
tdls
 && 
ªt
 == 0) {

3707 
	`iwl_mvm_ªˇlc_tdls_°©e
(
mvm
, 
vif
, 
åue
);

3708 
	`iwl_mvm_tdls_check_åiggî
(
mvm
, 
vif
, 
°a
->
addr
,

3709 
NL80211_TDLS_SETUP
);

3712 i‡(
ªt
)

3713  
ªt
;

3715 
	`f‹_óch_°a_a˘ive_lök
(
vif
, 
°a
, 
lök_°a
, 
i
)

3716 
lök_°a
->
agg
.
max_rc_amsdu_Àn
 = 1;

3718 
	`õì80211_°a_ªˇlc_aggªg©es
(
°a
);

3720 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
 && !
°a
->
tdls
)

3721 
mvmvif
->
≠_°a
 = 
°a
;

3734 
	`iwl_mvm_rs_øã_öô_Æl_löks
(
mvm
, 
vif
, 
°a
);

3737 
	}
}

3740 
	$iwl_mvm_°a_°©e_auth_to_assoc
(
õì80211_hw
 *
hw
,

3741 
iwl_mvm
 *
mvm
,

3742 
õì80211_vif
 *
vif
,

3743 
õì80211_°a
 *
°a
,

3744 c⁄° 
iwl_mvm_°a_°©e_›s
 *
ˇŒbacks
)

3746 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

3747 
iwl_mvm_°a
 *
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

3748 
õì80211_lök_°a
 *
lök_°a
;

3749 
lök_id
;

3751 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

3753 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
) {

3754 
	`iwl_mvm_vif_£t_he_suµ‹t
(
hw
, 
vif
, 
°a
, 
Ál£
);

3755 
mvmvif
->
≠_assoc_°a_cou¡
++;

3756 
ˇŒbacks
->
	`mac_˘xt_ch™ged
(
mvm
, 
vif
, 
Ál£
);

3761 i‡(!
mvm
->
mld_≠i_is_u£d
 &&

3762 (
vif
->
bss_c⁄f
.
he_suµ‹t
 &&

3763 !
iwlwifi_mod_∑øms
.
dißbÀ_11ax
))

3764 
	`iwl_mvm_cfg_he_°a
(
mvm
, 
vif
, 
mvm_°a
->
deÊök
.
°a_id
);

3765 } i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
) {

3766 
	`iwl_mvm_vif_£t_he_suµ‹t
(
hw
, 
vif
, 
°a
, 
åue
);

3768 
ˇŒbacks
->
	`mac_˘xt_ch™ged
(
mvm
, 
vif
, 
Ál£
);

3770 i‡(!
mvm
->
mld_≠i_is_u£d
)

3771 
out
;

3773 
	`f‹_óch_°a_a˘ive_lök
(
vif
, 
°a
, 
lök_°a
, 
lök_id
) {

3774 
õì80211_bss_c⁄f
 *
lök_c⁄f
 =

3775 
	`lök_c⁄f_dîe„ªn˚_¥Ÿe˘ed
(
vif
, 
lök_id
);

3777 i‡(
	`WARN_ON
(!
lök_c⁄f
))

3778  -
EINVAL
;

3779 i‡(!
mvmvif
->
lök
[
lök_id
])

3782 
	`iwl_mvm_lök_ch™ged
(
mvm
, 
vif
, 
lök_c⁄f
,

3783 
LINK_CONTEXT_MODIFY_ALL
 &

3784 ~
LINK_CONTEXT_MODIFY_ACTIVE
,

3785 
åue
);

3789 
out
:

3790 
	`iwl_mvm_rs_øã_öô_Æl_löks
(
mvm
, 
vif
, 
°a
);

3792  
ˇŒbacks
->
	`upd©e_°a
(
mvm
, 
vif
, 
°a
);

3793 
	}
}

3796 
	$iwl_mvm_°a_°©e_assoc_to_auth‹ized
(
iwl_mvm
 *
mvm
,

3797 
õì80211_vif
 *
vif
,

3798 
õì80211_°a
 *
°a
,

3799 c⁄° 
iwl_mvm_°a_°©e_›s
 *
ˇŒbacks
)

3801 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

3802 
iwl_mvm_°a
 *
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

3804 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

3807 i‡(
	`iwl_mvm_phy_˘x_cou¡
(
mvm
) > 1)

3808 
	`iwl_mvm_ã¨down_tdls_≥îs
(
mvm
);

3810 i‡(
°a
->
tdls
) {

3811 
	`iwl_mvm_tdls_check_åiggî
(
mvm
, 
vif
, 
°a
->
addr
,

3812 
NL80211_TDLS_ENABLE_LINK
);

3815 
	`WARN_ON
(
	`iwl_mvm_íabÀ_bóc⁄_fûãr
(
mvm
, 
vif
));

3817 
mvmvif
->
auth‹ized
 = 1;

3819 
ˇŒbacks
->
	`mac_˘xt_ch™ged
(
mvm
, 
vif
, 
Ál£
);

3820 
	`iwl_mvm_mei_ho°_assocüãd
(
mvm
, 
vif
, 
mvm_°a
);

3825 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
 &&

3826 !
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
))

3827 
	`iwl_mvm_mld_£À˘_löks
(
mvm
, 
vif
, 
Ál£
);

3830 
mvm_°a
->
auth‹ized
 = 
åue
;

3835 i‡(!
°a
->
mÂ
) {

3836 
ªt
 = 
ˇŒbacks
->
	`upd©e_°a
(
mvm
, 
vif
, 
°a
);

3838 i‡(
ªt
)

3839  
ªt
;

3842 
	`iwl_mvm_rs_øã_öô_Æl_löks
(
mvm
, 
vif
, 
°a
);

3845 
	}
}

3848 
	$iwl_mvm_°a_°©e_auth‹ized_to_assoc
(
iwl_mvm
 *
mvm
,

3849 
õì80211_vif
 *
vif
,

3850 
õì80211_°a
 *
°a
,

3851 c⁄° 
iwl_mvm_°a_°©e_›s
 *
ˇŒbacks
)

3853 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

3854 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

3856 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

3858 
mvm°a
->
auth‹ized
 = 
Ál£
;

3863 
	`iwl_mvm_rs_øã_öô_Æl_löks
(
mvm
, 
vif
, 
°a
);

3865 i‡(!
°a
->
tdls
) {

3870 
mvmvif
->
auth‹ized
 = 0;

3873 
	`iwl_mvm_dißbÀ_bóc⁄_fûãr
(
mvm
, 
vif
);

3877 
	}
}

3880 
	$iwl_mvm_mac_°a_°©e_comm⁄
(
õì80211_hw
 *
hw
,

3881 
õì80211_vif
 *
vif
,

3882 
õì80211_°a
 *
°a
,

3883 
õì80211_°a_°©e
 
ﬁd_°©e
,

3884 
õì80211_°a_°©e
 
√w_°©e
,

3885 c⁄° 
iwl_mvm_°a_°©e_›s
 *
ˇŒbacks
)

3887 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

3888 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

3889 
iwl_mvm_°a
 *
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

3890 
õì80211_lök_°a
 *
lök_°a
;

3891 
lök_id
;

3892 
ªt
;

3894 
	`IWL_DEBUG_MAC80211
(
mvm
, "station %pM state change %d->%d\n",

3895 
°a
->
addr
, 
ﬁd_°©e
, 
√w_°©e
);

3910 i‡(
ﬁd_°©e
 =
IEEE80211_STA_NONE
 &&

3911 
√w_°©e
 =
IEEE80211_STA_NOTEXIST
) {

3912 
	`Êush_w‹k
(&
mvm
->
add_°ªam_wk
);

3923 
	`iwl_mvm_ª£t_cˇ_40mhz_w‹k¨ound
(
mvm
, 
vif
);

3926 
	`k‰ì
(
mvm_°a
->
dup_d©a
);

3929 
	`muãx_lock
(&
mvm
->
muãx
);

3936 
	`f‹_óch_°a_a˘ive_lök
(
vif
, 
°a
, 
lök_°a
, 
lök_id
) {

3937 i‡(
	`WARN_ON_ONCE
(!
mvmvif
->
lök
[
lök_id
] ||

3938 !
mvmvif
->
lök
[
lök_id
]->
phy_˘xt
)) {

3939 
	`muãx_u∆ock
(&
mvm
->
muãx
);

3940  
	`ã°_bô
(
IWL_MVM_STATUS_HW_RESTART_REQUESTED
,

3941 &
mvm
->
°©us
Ë? 0 : -
EINVAL
;

3946 
mvm_°a
->
°a_°©e
 = 
√w_°©e
;

3948 i‡(
ﬁd_°©e
 =
IEEE80211_STA_NOTEXIST
 &&

3949 
√w_°©e
 =
IEEE80211_STA_NONE
) {

3950 
ªt
 = 
	`iwl_mvm_°a_°©e_nŸexi°_to_n⁄e
(
mvm
, 
vif
, 
°a
,

3951 
ˇŒbacks
);

3952 i‡(
ªt
 < 0)

3953 
out_u∆ock
;

3954 } i‡(
ﬁd_°©e
 =
IEEE80211_STA_NONE
 &&

3955 
√w_°©e
 =
IEEE80211_STA_AUTH
) {

3960 
mvm
->
œ°_ebs_suc˚ssful
 = 
åue
;

3961 
	`iwl_mvm_check_u≠sd
(
mvm
, 
vif
, 
°a
->
addr
);

3962 
ªt
 = 0;

3963 } i‡(
ﬁd_°©e
 =
IEEE80211_STA_AUTH
 &&

3964 
√w_°©e
 =
IEEE80211_STA_ASSOC
) {

3965 
ªt
 = 
	`iwl_mvm_°a_°©e_auth_to_assoc
(
hw
, 
mvm
, 
vif
, 
°a
,

3966 
ˇŒbacks
);

3967 } i‡(
ﬁd_°©e
 =
IEEE80211_STA_ASSOC
 &&

3968 
√w_°©e
 =
IEEE80211_STA_AUTHORIZED
) {

3969 
ªt
 = 
	`iwl_mvm_°a_°©e_assoc_to_auth‹ized
(
mvm
, 
vif
, 
°a
,

3970 
ˇŒbacks
);

3971 } i‡(
ﬁd_°©e
 =
IEEE80211_STA_AUTHORIZED
 &&

3972 
√w_°©e
 =
IEEE80211_STA_ASSOC
) {

3973 
ªt
 = 
	`iwl_mvm_°a_°©e_auth‹ized_to_assoc
(
mvm
, 
vif
, 
°a
,

3974 
ˇŒbacks
);

3975 } i‡(
ﬁd_°©e
 =
IEEE80211_STA_ASSOC
 &&

3976 
√w_°©e
 =
IEEE80211_STA_AUTH
) {

3977 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
) {

3978 
mvmvif
->
≠_assoc_°a_cou¡
--;

3979 
ˇŒbacks
->
	`mac_˘xt_ch™ged
(
mvm
, 
vif
, 
Ál£
);

3980 } i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
 && !
°a
->
tdls
)

3981 
	`iwl_mvm_°›_£ssi⁄_¥Ÿe˘i⁄
(
mvm
, 
vif
);

3982 
ªt
 = 0;

3983 } i‡(
ﬁd_°©e
 =
IEEE80211_STA_AUTH
 &&

3984 
√w_°©e
 =
IEEE80211_STA_NONE
) {

3985 
ªt
 = 0;

3986 } i‡(
ﬁd_°©e
 =
IEEE80211_STA_NONE
 &&

3987 
√w_°©e
 =
IEEE80211_STA_NOTEXIST
) {

3988 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
 && !
°a
->
tdls
) {

3989 
	`iwl_mvm_°›_£ssi⁄_¥Ÿe˘i⁄
(
mvm
, 
vif
);

3990 
mvmvif
->
≠_°a
 = 
NULL
;

3992 
ªt
 = 
ˇŒbacks
->
	`rm_°a
(
mvm
, 
vif
, 
°a
);

3993 i‡(
°a
->
tdls
) {

3994 
	`iwl_mvm_ªˇlc_tdls_°©e
(
mvm
, 
vif
, 
Ál£
);

3995 
	`iwl_mvm_tdls_check_åiggî
(
mvm
, 
vif
, 
°a
->
addr
,

3996 
NL80211_TDLS_DISABLE_LINK
);

3999 i‡(
	`u∆ikñy
(
ªt
 &&

4000 
	`ã°_bô
(
IWL_MVM_STATUS_HW_RESTART_REQUESTED
,

4001 &
mvm
->
°©us
)))

4002 
ªt
 = 0;

4004 
ªt
 = -
EIO
;

4006 
out_u∆ock
:

4007 
	`muãx_u∆ock
(&
mvm
->
muãx
);

4009 i‡(
°a
->
tdls
 && 
ªt
 == 0) {

4010 i‡(
ﬁd_°©e
 =
IEEE80211_STA_NOTEXIST
 &&

4011 
√w_°©e
 =
IEEE80211_STA_NONE
)

4012 
	`õì80211_ª£rve_tid
(
°a
, 
IWL_MVM_TDLS_FW_TID
);

4013 i‡(
ﬁd_°©e
 =
IEEE80211_STA_NONE
 &&

4014 
√w_°©e
 =
IEEE80211_STA_NOTEXIST
)

4015 
	`õì80211_uƒe£rve_tid
(
°a
, 
IWL_MVM_TDLS_FW_TID
);

4018  
ªt
;

4019 
	}
}

4021 
	$iwl_mvm_mac_£t_πs_thªshﬁd
(
õì80211_hw
 *
hw
, 
u32
 
vÆue
)

4023 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

4025 
mvm
->
πs_thªshﬁd
 = 
vÆue
;

4028 
	}
}

4030 
	$iwl_mvm_°a_rc_upd©e
(
õì80211_hw
 *
hw
, 
õì80211_vif
 *
vif
,

4031 
õì80211_°a
 *
°a
, 
u32
 
ch™ged
)

4033 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

4035 i‡(
ch™ged
 & (
IEEE80211_RC_BW_CHANGED
 |

4036 
IEEE80211_RC_SUPP_RATES_CHANGED
 |

4037 
IEEE80211_RC_NSS_CHANGED
))

4038 
	`iwl_mvm_rs_øã_öô_Æl_löks
(
mvm
, 
vif
, 
°a
);

4040 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
 &&

4041 
ch™ged
 & 
IEEE80211_RC_NSS_CHANGED
)

4042 
	`iwl_mvm_sf_upd©e
(
mvm
, 
vif
, 
Ál£
);

4043 
	}
}

4045 
	$iwl_mvm_mac_c⁄f_tx
(
õì80211_hw
 *
hw
,

4046 
õì80211_vif
 *
vif
,

4047 
lök_id
, 
u16
 
ac
,

4048 c⁄° 
õì80211_tx_queue_∑øms
 *
∑øms
)

4050 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

4051 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

4053 
mvmvif
->
deÊök
.
queue_∑øms
[
ac
] = *
∑øms
;

4059 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_P2P_DEVICE
) {

4060 
ªt
;

4062 
	`muãx_lock
(&
mvm
->
muãx
);

4063 
ªt
 = 
	`iwl_mvm_mac_˘xt_ch™ged
(
mvm
, 
vif
, 
Ál£
, 
NULL
);

4064 
	`muãx_u∆ock
(&
mvm
->
muãx
);

4065  
ªt
;

4068 
	}
}

4070 
	$iwl_mvm_mac_mgd_¥ï¨e_tx
(
õì80211_hw
 *
hw
,

4071 
õì80211_vif
 *
vif
,

4072 
õì80211_¥ï_tx_öfo
 *
öfo
)

4074 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

4076 
	`muãx_lock
(&
mvm
->
muãx
);

4077 
	`iwl_mvm_¥Ÿe˘_assoc
(
mvm
, 
vif
, 
öfo
->
duøti⁄
, info->
lök_id
);

4078 
	`muãx_u∆ock
(&
mvm
->
muãx
);

4079 
	}
}

4081 
	$iwl_mvm_mac_mgd_com∂ëe_tx
(
õì80211_hw
 *
hw
,

4082 
õì80211_vif
 *
vif
,

4083 
õì80211_¥ï_tx_öfo
 *
öfo
)

4085 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

4088 i‡(
öfo
->
suc˚ss
)

4091 
	`muãx_lock
(&
mvm
->
muãx
);

4092 
	`iwl_mvm_°›_£ssi⁄_¥Ÿe˘i⁄
(
mvm
, 
vif
);

4093 
	`muãx_u∆ock
(&
mvm
->
muãx
);

4094 
	}
}

4096 
	$iwl_mvm_mac_sched_sˇn_°¨t
(
õì80211_hw
 *
hw
,

4097 
õì80211_vif
 *
vif
,

4098 
cfg80211_sched_sˇn_ªque°
 *
ªq
,

4099 
õì80211_sˇn_õs
 *
õs
)

4101 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

4103 
ªt
;

4105 
	`muãx_lock
(&
mvm
->
muãx
);

4107 i‡(!
vif
->
cfg
.
idÀ
) {

4108 
ªt
 = -
EBUSY
;

4109 
out
;

4112 
ªt
 = 
	`iwl_mvm_sched_sˇn_°¨t
(
mvm
, 
vif
, 
ªq
, 
õs
, 
IWL_MVM_SCAN_SCHED
);

4114 
out
:

4115 
	`muãx_u∆ock
(&
mvm
->
muãx
);

4116  
ªt
;

4117 
	}
}

4119 
	$iwl_mvm_mac_sched_sˇn_°›
(
õì80211_hw
 *
hw
,

4120 
õì80211_vif
 *
vif
)

4122 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

4123 
ªt
;

4125 
	`muãx_lock
(&
mvm
->
muãx
);

4135 i‡(!(
mvm
->
sˇn_°©us
 & 
IWL_MVM_SCAN_SCHED
)) {

4136 
	`muãx_u∆ock
(&
mvm
->
muãx
);

4140 
ªt
 = 
	`iwl_mvm_sˇn_°›
(
mvm
, 
IWL_MVM_SCAN_SCHED
, 
Ál£
);

4141 
	`muãx_u∆ock
(&
mvm
->
muãx
);

4142 
	`iwl_mvm_waô_f‹_async_h™dÀrs
(
mvm
);

4144  
ªt
;

4145 
	}
}

4147 
	$__iwl_mvm_mac_£t_key
(
õì80211_hw
 *
hw
,

4148 
£t_key_cmd
 
cmd
,

4149 
õì80211_vif
 *
vif
,

4150 
õì80211_°a
 *
°a
,

4151 
õì80211_key_c⁄f
 *
key
)

4153 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

4154 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

4155 
iwl_mvm_°a
 *
mvm°a
 = 
NULL
;

4156 
iwl_mvm_key_≤
 *
±k_≤
 = 
NULL
;

4157 
keyidx
 = 
key
->keyidx;

4158 
u32
 
£c_key_id
 = 
	`WIDE_ID
(
DATA_PATH_GROUP
, 
SEC_KEY_CMD
);

4159 
u8
 
£c_key_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
£c_key_id
, 0);

4160 
ªt
, 
i
;

4161 
u8
 
key_off£t
;

4163 i‡(
°a
)

4164 
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

4166 
key
->
cùhî
) {

4167 
WLAN_CIPHER_SUITE_TKIP
:

4168 i‡(!
mvm
->
å™s
->
å™s_cfg
->
gí2
) {

4169 
key
->
Êags
 |
IEEE80211_KEY_FLAG_GENERATE_MMIC
;

4170 
key
->
Êags
 |
IEEE80211_KEY_FLAG_PUT_IV_SPACE
;

4171 } i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
) {

4172 
key
->
Êags
 |
IEEE80211_KEY_FLAG_PUT_MIC_SPACE
;

4174 
	`IWL_DEBUG_MAC80211
(
mvm
, "Use SWÉncryption for TKIP\n");

4175  -
EOPNOTSUPP
;

4178 
WLAN_CIPHER_SUITE_CCMP
:

4179 
WLAN_CIPHER_SUITE_GCMP
:

4180 
WLAN_CIPHER_SUITE_GCMP_256
:

4181 i‡(!
	`iwl_mvm_has_√w_tx_≠i
(
mvm
))

4182 
key
->
Êags
 |
IEEE80211_KEY_FLAG_PUT_IV_SPACE
;

4184 
WLAN_CIPHER_SUITE_AES_CMAC
:

4185 
WLAN_CIPHER_SUITE_BIP_GMAC_128
:

4186 
WLAN_CIPHER_SUITE_BIP_GMAC_256
:

4187 
	`WARN_ON_ONCE
(!
	`õì80211_hw_check
(
hw
, 
MFP_CAPABLE
));

4189 
WLAN_CIPHER_SUITE_WEP40
:

4190 
WLAN_CIPHER_SUITE_WEP104
:

4191 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
)

4193 i‡(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
))

4194  -
EOPNOTSUPP
;

4198  -
EOPNOTSUPP
;

4201 
cmd
) {

4202 
SET_KEY
:

4203 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
 &&

4204 (
keyidx
 == 6 || keyidx == 7))

4205 
	`rcu_assign_poöãr
(
mvmvif
->
b˙_¥Ÿ
.
keys
[
keyidx
 - 6],

4206 
key
);

4208 i‡((
vif
->
ty≥
 =
NL80211_IFTYPE_ADHOC
 ||

4209 
vif
->
ty≥
 =
NL80211_IFTYPE_AP
Ë&& !
°a
) {

4227 i‡(!
	`wùhy_ext_„©uª_is£t
(
hw
->
wùhy
,

4228 
NL80211_EXT_FEATURE_BEACON_PROTECTION
) &&

4229 (
key
->
cùhî
 =
WLAN_CIPHER_SUITE_AES_CMAC
 ||

4230 
key
->
cùhî
 =
WLAN_CIPHER_SUITE_BIP_GMAC_128
 ||

4231 
key
->
cùhî
 =
WLAN_CIPHER_SUITE_BIP_GMAC_256
)) {

4232 
ªt
 = -
EOPNOTSUPP
;

4236 i‡(
key
->
cùhî
 !
WLAN_CIPHER_SUITE_GCMP
 &&

4237 
key
->
cùhî
 !
WLAN_CIPHER_SUITE_GCMP_256
 &&

4238 !
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)) {

4239 
key
->
hw_key_idx
 = 
STA_KEY_IDX_INVALID
;

4240 
ªt
 = 0;

4244 i‡(!
mvmvif
->
≠_ibss_a˘ive
) {

4245 
i
 = 0;

4246 
i
 < 
	`ARRAY_SIZE
(
mvmvif
->
≠_óæy_keys
);

4247 
i
++) {

4248 i‡(!
mvmvif
->
≠_óæy_keys
[
i
]) {

4249 
mvmvif
->
≠_óæy_keys
[
i
] = 
key
;

4254 i‡(
i
 >
	`ARRAY_SIZE
(
mvmvif
->
≠_óæy_keys
))

4255 
ªt
 = -
ENOSPC
;

4257 
ªt
 = 0;

4266 i‡(
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
) &&

4267 
key
->
hw_key_idx
 =
STA_KEY_IDX_INVALID
) {

4268 
	`IWL_DEBUG_MAC80211
(
mvm
,

4270 
ªt
 = 0;

4274 i‡(!
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
) &&

4275 
mvm°a
 && 
	`iwl_mvm_has_√w_rx_≠i
(
mvm
) &&

4276 
key
->
Êags
 & 
IEEE80211_KEY_FLAG_PAIRWISE
 &&

4277 (
key
->
cùhî
 =
WLAN_CIPHER_SUITE_CCMP
 ||

4278 
key
->
cùhî
 =
WLAN_CIPHER_SUITE_GCMP
 ||

4279 
key
->
cùhî
 =
WLAN_CIPHER_SUITE_GCMP_256
)) {

4280 
õì80211_key_£q
 
£q
;

4281 
tid
, 
q
;

4283 
	`WARN_ON
(
	`rcu_ac˚ss_poöãr
(
mvm°a
->
±k_≤
[
keyidx
]));

4284 
±k_≤
 = 
	`kzÆloc
(
	`°ru˘_size
’tk_≤, 
q
,

4285 
mvm
->
å™s
->
num_rx_queues
),

4286 
GFP_KERNEL
);

4287 i‡(!
±k_≤
) {

4288 
ªt
 = -
ENOMEM
;

4292 
tid
 = 0;Åid < 
IWL_MAX_TID_COUNT
;Åid++) {

4293 
	`õì80211_gë_key_rx_£q
(
key
, 
tid
, &
£q
);

4294 
q
 = 0; q < 
mvm
->
å™s
->
num_rx_queues
; q++)

4295 
	`mem˝y
(
±k_≤
->
q
[q].
≤
[
tid
],

4296 
£q
.
ccmp
.
≤
,

4297 
IEEE80211_CCMP_PN_LEN
);

4300 
	`rcu_assign_poöãr
(
mvm°a
->
±k_≤
[
keyidx
],Ötk_pn);

4304 i‡(
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
))

4305 
key_off£t
 = 
key
->
hw_key_idx
;

4307 
key_off£t
 = 
STA_KEY_IDX_INVALID
;

4309 i‡(
mvm°a
 && 
key
->
Êags
 & 
IEEE80211_KEY_FLAG_PAIRWISE
)

4310 
mvm°a
->
∑úwi£_cùhî
 = 
key
->
cùhî
;

4312 
	`IWL_DEBUG_MAC80211
(
mvm
, "set hwcrypto key (sta:%pM, id:%d)\n",

4313 
°a
 ? sè->
addr
 : 
NULL
, 
key
->
keyidx
);

4315 i‡(
£c_key_vî
)

4316 
ªt
 = 
	`iwl_mvm_£c_key_add
(
mvm
, 
vif
, 
°a
, 
key
);

4318 
ªt
 = 
	`iwl_mvm_£t_°a_key
(
mvm
, 
vif
, 
°a
, 
key
, 
key_off£t
);

4320 i‡(
ªt
) {

4321 
	`IWL_WARN
(
mvm
, "set key failed\n");

4322 
key
->
hw_key_idx
 = 
STA_KEY_IDX_INVALID
;

4323 i‡(
±k_≤
) {

4324 
	`RCU_INIT_POINTER
(
mvm°a
->
±k_≤
[
keyidx
], 
NULL
);

4325 
	`k‰ì
(
±k_≤
);

4333 i‡(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
))

4334 
ªt
 = -
EOPNOTSUPP
;

4336 
ªt
 = 0;

4340 
DISABLE_KEY
:

4341 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
 &&

4342 (
keyidx
 == 6 || keyidx == 7))

4343 
	`RCU_INIT_POINTER
(
mvmvif
->
b˙_¥Ÿ
.
keys
[
keyidx
 - 6],

4344 
NULL
);

4346 
ªt
 = -
ENOENT
;

4347 
i
 = 0; i < 
	`ARRAY_SIZE
(
mvmvif
->
≠_óæy_keys
); i++) {

4348 i‡(
mvmvif
->
≠_óæy_keys
[
i
] =
key
) {

4349 
mvmvif
->
≠_óæy_keys
[
i
] = 
NULL
;

4350 
ªt
 = 0;

4355 i‡(
ªt
 == 0)

4358 i‡(
key
->
hw_key_idx
 =
STA_KEY_IDX_INVALID
) {

4359 
ªt
 = 0;

4363 i‡(
mvm°a
 && 
	`iwl_mvm_has_√w_rx_≠i
(
mvm
) &&

4364 
key
->
Êags
 & 
IEEE80211_KEY_FLAG_PAIRWISE
 &&

4365 (
key
->
cùhî
 =
WLAN_CIPHER_SUITE_CCMP
 ||

4366 
key
->
cùhî
 =
WLAN_CIPHER_SUITE_GCMP
 ||

4367 
key
->
cùhî
 =
WLAN_CIPHER_SUITE_GCMP_256
)) {

4368 
±k_≤
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(

4369 
mvm°a
->
±k_≤
[
keyidx
],

4370 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

4371 
	`RCU_INIT_POINTER
(
mvm°a
->
±k_≤
[
keyidx
], 
NULL
);

4372 i‡(
±k_≤
)

4373 
	`k‰ì_rcu
(
±k_≤
, 
rcu_hód
);

4376 
	`IWL_DEBUG_MAC80211
(
mvm
, "disable hwcrypto key\n");

4377 i‡(
£c_key_vî
)

4378 
ªt
 = 
	`iwl_mvm_£c_key_dñ
(
mvm
, 
vif
, 
°a
, 
key
);

4380 
ªt
 = 
	`iwl_mvm_ªmove_°a_key
(
mvm
, 
vif
, 
°a
, 
key
);

4383 
ªt
 = -
EINVAL
;

4386  
ªt
;

4387 
	}
}

4389 
	$iwl_mvm_mac_£t_key
(
õì80211_hw
 *
hw
, 
£t_key_cmd
 
cmd
,

4390 
õì80211_vif
 *
vif
, 
õì80211_°a
 *
°a
,

4391 
õì80211_key_c⁄f
 *
key
)

4393 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

4394 
ªt
;

4396 
	`muãx_lock
(&
mvm
->
muãx
);

4397 
ªt
 = 
	`__iwl_mvm_mac_£t_key
(
hw
, 
cmd
, 
vif
, 
°a
, 
key
);

4398 
	`muãx_u∆ock
(&
mvm
->
muãx
);

4400  
ªt
;

4401 
	}
}

4403 
	$iwl_mvm_mac_upd©e_tkù_key
(
õì80211_hw
 *
hw
,

4404 
õì80211_vif
 *
vif
,

4405 
õì80211_key_c⁄f
 *
keyc⁄f
,

4406 
õì80211_°a
 *
°a
,

4407 
u32
 
iv32
, 
u16
 *
pha£1key
)

4409 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

4411 i‡(
keyc⁄f
->
hw_key_idx
 =
STA_KEY_IDX_INVALID
)

4414 
	`iwl_mvm_upd©e_tkù_key
(
mvm
, 
vif
, 
keyc⁄f
, 
°a
, 
iv32
, 
pha£1key
);

4415 
	}
}

4418 
boﬁ
 
	$iwl_mvm_rx_aux_roc
(
iwl_nŸif_waô_d©a
 *
nŸif_waô
,

4419 
iwl_rx_∑ckë
 *
pkt
, *
d©a
)

4421 
iwl_mvm
 *
mvm
 =

4422 
	`c⁄èöî_of
(
nŸif_waô
, 
iwl_mvm
,Çotif_wait);

4423 
iwl_hs20_roc_ªs
 *
ª•
;

4424 
ª•_Àn
 = 
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
);

4425 
iwl_mvm_time_evít_d©a
 *
ã_d©a
 = 
d©a
;

4427 i‡(
	`WARN_ON
(
pkt
->
hdr
.
cmd
 !
HOT_SPOT_CMD
))

4428  
åue
;

4430 i‡(
	`WARN_ON_ONCE
(
ª•_Àn
 !(*
ª•
))) {

4431 
	`IWL_ERR
(
mvm
, "Invalid HOT_SPOT_CMDÑesponse\n");

4432  
åue
;

4435 
ª•
 = (*)
pkt
->
d©a
;

4437 
	`IWL_DEBUG_TE
(
mvm
,

4439 
ª•
->
°©us
,Ñe•->
evít_unique_id
);

4441 
ã_d©a
->
uid
 = 
	`À32_to_˝u
(
ª•
->
evít_unique_id
);

4442 
	`IWL_DEBUG_TE
(
mvm
, "TIME_EVENT_CMDÑesponse - UID = 0x%x\n",

4443 
ã_d©a
->
uid
);

4445 
	`•ö_lock_bh
(&
mvm
->
time_evít_lock
);

4446 
	`li°_add_èû
(&
ã_d©a
->
li°
, &
mvm
->
aux_roc_ã_li°
);

4447 
	`•ö_u∆ock_bh
(&
mvm
->
time_evít_lock
);

4449  
åue
;

4450 
	}
}

4452 
	$iwl_mvm_£nd_aux_roc_cmd
(
iwl_mvm
 *
mvm
,

4453 
õì80211_ch™√l
 *
ch™√l
,

4454 
õì80211_vif
 *
vif
,

4455 
duøti⁄
)

4457 
ªs
;

4458 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

4459 
iwl_mvm_time_evít_d©a
 *
ã_d©a
 = &
mvmvif
->
hs_time_evít_d©a
;

4460 c⁄° 
u16
 
time_evít_ª•⁄£
[] = { 
HOT_SPOT_CMD
 };

4461 
iwl_nŸifiˇti⁄_waô
 
waô_time_evít
;

4462 
u32
 
ªq_dur
, 
dñay
;

4463 
iwl_hs20_roc_ªq
 
aux_roc_ªq
 = {

4464 .
a˘i⁄
 = 
	`˝u_to_À32
(
FW_CTXT_ACTION_ADD
),

4465 .
id_™d_cﬁ‹
 =

4466 
	`˝u_to_À32
(
	`FW_CMD_ID_AND_COLOR
(
MAC_INDEX_AUX
, 0)),

4467 .
°a_id_™d_cﬁ‹
 = 
	`˝u_to_À32
(
mvm
->
aux_°a
.
°a_id
),

4469 
iwl_hs20_roc_ªq_èû
 *
èû
 = 
	`iwl_mvm_ch™_öfo_cmd_èû
(
mvm
,

4470 &
aux_roc_ªq
.
ch™√l_öfo
);

4471 
u16
 
Àn
 = (
aux_roc_ªq
Ë- 
	`iwl_mvm_ch™_öfo_∑ddög
(
mvm
);

4474 
	`iwl_mvm_£t_ch™_öfo
(
mvm
, &
aux_roc_ªq
.
ch™√l_öfo
, 
ch™√l
->
hw_vÆue
,

4475 
	`iwl_mvm_phy_b™d_‰om_∆80211
(
ch™√l
->
b™d
),

4476 
IWL_PHY_CHANNEL_MODE20
,

4480 
èû
->
≠∂y_time
 = 
	`˝u_to_À32
(
	`iwl_mvm_gë_sy°ime
(
mvm
));

4482 
	`iwl_mvm_roc_duøti⁄_™d_dñay
(
vif
, 
duøti⁄
, &
ªq_dur
, &
dñay
);

4483 
èû
->
duøti⁄
 = 
	`˝u_to_À32
(
ªq_dur
);

4484 
èû
->
≠∂y_time_max_dñay
 = 
	`˝u_to_À32
(
dñay
);

4486 
	`IWL_DEBUG_TE
(
mvm
,

4488 
ch™√l
->
hw_vÆue
, 
ªq_dur
);

4489 
	`IWL_DEBUG_TE
(
mvm
,

4491 
duøti⁄
, 
dñay
);

4494 
	`mem˝y
(
èû
->
node_addr
, 
vif
->
addr
, 
ETH_ALEN
);

4496 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

4498 
	`•ö_lock_bh
(&
mvm
->
time_evít_lock
);

4500 i‡(
	`WARN_ON
(
ã_d©a
->
id
 =
HOT_SPOT_CMD
)) {

4501 
	`•ö_u∆ock_bh
(&
mvm
->
time_evít_lock
);

4502  -
EIO
;

4505 
ã_d©a
->
vif
 = vif;

4506 
ã_d©a
->
duøti⁄
 = duration;

4507 
ã_d©a
->
id
 = 
HOT_SPOT_CMD
;

4509 
	`•ö_u∆ock_bh
(&
mvm
->
time_evít_lock
);

4520 
	`iwl_öô_nŸifiˇti⁄_waô
(&
mvm
->
nŸif_waô
, &
waô_time_evít
,

4521 
time_evít_ª•⁄£
,

4522 
	`ARRAY_SIZE
(
time_evít_ª•⁄£
),

4523 
iwl_mvm_rx_aux_roc
, 
ã_d©a
);

4525 
ªs
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
HOT_SPOT_CMD
, 0, 
Àn
,

4526 &
aux_roc_ªq
);

4528 i‡(
ªs
) {

4529 
	`IWL_ERR
(
mvm
, "Couldn'à£nd HOT_SPOT_CMD: %d\n", 
ªs
);

4530 
	`iwl_ªmove_nŸifiˇti⁄
(&
mvm
->
nŸif_waô
, &
waô_time_evít
);

4531 
out_˛ór_ã
;

4535 
ªs
 = 
	`iwl_waô_nŸifiˇti⁄
(&
mvm
->
nŸif_waô
, &
waô_time_evít
, 1);

4537 
	`WARN_ON_ONCE
(
ªs
);

4539 i‡(
ªs
) {

4540 
out_˛ór_ã
:

4541 
	`•ö_lock_bh
(&
mvm
->
time_evít_lock
);

4542 
	`iwl_mvm_ã_˛ór_d©a
(
mvm
, 
ã_d©a
);

4543 
	`•ö_u∆ock_bh
(&
mvm
->
time_evít_lock
);

4546  
ªs
;

4547 
	}
}

4549 
	$iwl_mvm_add_aux_°a_f‹_hs20
(
iwl_mvm
 *
mvm
, 
u32
 
lmac_id
)

4551 
ªt
 = 0;

4553 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

4555 i‡(!
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

4556 
IWL_UCODE_TLV_CAPA_HOTSPOT_SUPPORT
)) {

4557 
	`IWL_ERR
(
mvm
, "hotspotÇot supported\n");

4558  -
EINVAL
;

4561 i‡(
	`iwl_mvm_has_√w_°©i⁄_≠i
(
mvm
->
fw
)) {

4562 
ªt
 = 
	`iwl_mvm_add_aux_°a
(
mvm
, 
lmac_id
);

4563 
	`WARN
(
ªt
, "FailedÅoállocateáux station");

4566  
ªt
;

4567 
	}
}

4569 
	$iwl_mvm_roc_lök
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

4571 
ªt
;

4573 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

4575 
ªt
 = 
	`iwl_mvm_bödög_add_vif
(
mvm
, 
vif
);

4576 i‡(
	`WARN
(
ªt
, "Failed binding P2P_DEVICE\n"))

4577  
ªt
;

4582  
	`iwl_mvm_add_p2p_bˇ°_°a
(
mvm
, 
vif
);

4583 
	}
}

4585 
	$iwl_mvm_roc
(
õì80211_hw
 *
hw
,

4586 
õì80211_vif
 *
vif
,

4587 
õì80211_ch™√l
 *
ch™√l
,

4588 
duøti⁄
,

4589 
õì80211_roc_ty≥
 
ty≥
)

4591 c⁄° 
iwl_mvm_roc_›s
 
›s
 = {

4592 .
add_aux_°a_f‹_hs20
 = 
iwl_mvm_add_aux_°a_f‹_hs20
,

4593 .
lök
 = 
iwl_mvm_roc_lök
,

4596  
	`iwl_mvm_roc_comm⁄
(
hw
, 
vif
, 
ch™√l
, 
duøti⁄
, 
ty≥
, &
›s
);

4597 
	}
}

4599 
	$iwl_mvm_roc_°©i⁄
(
iwl_mvm
 *
mvm
,

4600 
õì80211_ch™√l
 *
ch™√l
,

4601 
õì80211_vif
 *
vif
,

4602 
duøti⁄
)

4604 
ªt
;

4605 
u32
 
cmd_id
 = 
	`WIDE_ID
(
MAC_CONF_GROUP
, 
ROC_CMD
);

4606 
u8
 
fw_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
cmd_id
,

4607 
IWL_FW_CMD_VER_UNKNOWN
);

4609 i‡(
fw_vî
 =
IWL_FW_CMD_VER_UNKNOWN
) {

4610 
ªt
 = 
	`iwl_mvm_£nd_aux_roc_cmd
(
mvm
, 
ch™√l
, 
vif
, 
duøti⁄
);

4611 } i‡(
fw_vî
 == 3) {

4612 
ªt
 = 
	`iwl_mvm_roc_add_cmd
(
mvm
, 
ch™√l
, 
vif
, 
duøti⁄
,

4613 
ROC_ACTIVITY_HOTSPOT
);

4615 
ªt
 = -
EOPNOTSUPP
;

4616 
	`IWL_ERR
(
mvm
, "ROC comm™d vîsi⁄ %d mism©ch!\n", 
fw_vî
);

4619  
ªt
;

4620 
	}
}

4622 
	$iwl_mvm_p2p_föd_phy_˘xt
(
iwl_mvm
 *
mvm
,

4623 
õì80211_vif
 *
vif
,

4624 
õì80211_ch™√l
 *
ch™√l
)

4626 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

4627 
cfg80211_ch™_def
 
ch™def
;

4628 
i
;

4630 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

4632 i‡(
mvmvif
->
deÊök
.
phy_˘xt
 &&

4633 
ch™√l
 =
mvmvif
->
deÊök
.
phy_˘xt
->channel)

4637 
i
 = 0; i < 
NUM_PHY_CTX
; i++) {

4638 
iwl_mvm_phy_˘xt
 *
phy_˘xt
 = &
mvm
->
phy_˘xts
[
i
];

4640 i‡(!
phy_˘xt
->
ªf
 || 
mvmvif
->
deÊök
.phy_ctxt ==Öhy_ctxt)

4643 i‡(
ch™√l
 =
phy_˘xt
->channel) {

4644 i‡(
mvmvif
->
deÊök
.
phy_˘xt
)

4645 
	`iwl_mvm_phy_˘xt_uƒef
(
mvm
,

4646 
mvmvif
->
deÊök
.
phy_˘xt
);

4648 
mvmvif
->
deÊök
.
phy_˘xt
 =Öhy_ctxt;

4649 
	`iwl_mvm_phy_˘xt_ªf
(
mvm
, 
mvmvif
->
deÊök
.
phy_˘xt
);

4655 i‡(
mvmvif
->
deÊök
.
phy_˘xt
)

4656 
	`iwl_mvm_phy_˘xt_uƒef
(
mvm
, 
mvmvif
->
deÊök
.
phy_˘xt
);

4658 
mvmvif
->
deÊök
.
phy_˘xt
 = 
	`iwl_mvm_gë_‰ì_phy_˘xt
(
mvm
);

4659 i‡(!
mvmvif
->
deÊök
.
phy_˘xt
)

4660  -
ENOSPC
;

4662 
	`cfg80211_ch™def_¸óã
(&
ch™def
, 
ch™√l
, 
NL80211_CHAN_NO_HT
);

4664  
	`iwl_mvm_phy_˘xt_add
(
mvm
, 
mvmvif
->
deÊök
.
phy_˘xt
,

4665 &
ch™def
, 
NULL
, 1, 1);

4666 
	}
}

4669 
	$iwl_mvm_roc_comm⁄
(
õì80211_hw
 *
hw
, 
õì80211_vif
 *
vif
,

4670 
õì80211_ch™√l
 *
ch™√l
, 
duøti⁄
,

4671 
õì80211_roc_ty≥
 
ty≥
,

4672 c⁄° 
iwl_mvm_roc_›s
 *
›s
)

4674 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

4675 
u32
 
lmac_id
;

4676 
ªt
;

4678 
	`IWL_DEBUG_MAC80211
(
mvm
, "íã∏(%d, %d, %d)\n", 
ch™√l
->
hw_vÆue
,

4679 
duøti⁄
, 
ty≥
);

4685 
	`Êush_w‹k
(&
mvm
->
roc_d⁄e_wk
);

4687 
	`muãx_lock
(&
mvm
->
muãx
);

4689 
vif
->
ty≥
) {

4690 
NL80211_IFTYPE_STATION
:

4691 
lmac_id
 = 
	`iwl_mvm_gë_lmac_id
(
mvm
, 
ch™√l
->
b™d
);

4694 
ªt
 = 
›s
->
	`add_aux_°a_f‹_hs20
(
mvm
, 
lmac_id
);

4695 i‡(!
ªt
)

4696 
ªt
 = 
	`iwl_mvm_roc_°©i⁄
(
mvm
, 
ch™√l
, 
vif
, 
duøti⁄
);

4697 
out_u∆ock
;

4698 
NL80211_IFTYPE_P2P_DEVICE
:

4702 
	`IWL_ERR
(
mvm
, "ROC: InvÆid vi‡ty≥=%u\n", 
vif
->
ty≥
);

4703 
ªt
 = -
EINVAL
;

4704 
out_u∆ock
;

4708 
ªt
 = 
	`iwl_mvm_p2p_föd_phy_˘xt
(
mvm
, 
vif
, 
ch™√l
);

4709 i‡(
ªt
)

4710 
out_u∆ock
;

4712 
ªt
 = 
›s
->
	`lök
(
mvm
, 
vif
);

4713 i‡(
ªt
)

4714 
out_u∆ock
;

4716 
ªt
 = 
	`iwl_mvm_°¨t_p2p_roc
(
mvm
, 
vif
, 
duøti⁄
, 
ty≥
);

4717 
out_u∆ock
:

4718 
	`muãx_u∆ock
(&
mvm
->
muãx
);

4719 
	`IWL_DEBUG_MAC80211
(
mvm
, "leave\n");

4720  
ªt
;

4721 
	}
}

4723 
	$iwl_mvm_ˇn˚l_roc
(
õì80211_hw
 *
hw
,

4724 
õì80211_vif
 *
vif
)

4726 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

4728 
	`IWL_DEBUG_MAC80211
(
mvm
, "enter\n");

4730 
	`muãx_lock
(&
mvm
->
muãx
);

4731 
	`iwl_mvm_°›_roc
(
mvm
, 
vif
);

4732 
	`muãx_u∆ock
(&
mvm
->
muãx
);

4734 
	`IWL_DEBUG_MAC80211
(
mvm
, "leave\n");

4736 
	}
}

4738 
	siwl_mvm_·m_ª•⁄dî_ôî_d©a
 {

4739 
boﬁ
 
	mª•⁄dî
;

4740 
õì80211_ch™˘x_c⁄f
 *
	m˘x
;

4743 
	$iwl_mvm_·m_ª•⁄dî_ch™˘x_ôî
(*
_d©a
, 
u8
 *
mac
,

4744 
õì80211_vif
 *
vif
)

4746 
iwl_mvm_·m_ª•⁄dî_ôî_d©a
 *
d©a
 = 
_d©a
;

4748 i‡(
	`rcu_ac˚ss_poöãr
(
vif
->
bss_c⁄f
.
ch™˘x_c⁄f
Ë=
d©a
->
˘x
 &&

4749 
vif
->
ty≥
 =
NL80211_IFTYPE_AP
 && vif->
bss_c⁄f
.
·mr_∑øms
)

4750 
d©a
->
ª•⁄dî
 = 
åue
;

4751 
	}
}

4753 
boﬁ
 
	$iwl_mvm_is_·m_ª•⁄dî_ch™˘x
(
iwl_mvm
 *
mvm
,

4754 
õì80211_ch™˘x_c⁄f
 *
˘x
)

4756 
iwl_mvm_·m_ª•⁄dî_ôî_d©a
 
d©a
 = {

4757 .
ª•⁄dî
 = 
Ál£
,

4758 .
˘x
 = ctx,

4761 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s_©omic
(
mvm
->
hw
,

4762 
IEEE80211_IFACE_ITER_NORMAL
,

4763 
iwl_mvm_·m_ª•⁄dî_ch™˘x_ôî
,

4764 &
d©a
);

4765  
d©a
.
ª•⁄dî
;

4766 
	}
}

4768 
	$__iwl_mvm_add_ch™˘x
(
iwl_mvm
 *
mvm
,

4769 
õì80211_ch™˘x_c⁄f
 *
˘x
)

4771 
u16
 *
phy_˘xt_id
 = (u16 *)
˘x
->
drv_¥iv
;

4772 
iwl_mvm_phy_˘xt
 *
phy_˘xt
;

4773 
cfg80211_ch™_def
 *
def
 = 
	`iwl_mvm_ch™˘x_def
(
mvm
, 
˘x
);

4774 
ªt
;

4776 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

4778 
	`IWL_DEBUG_MAC80211
(
mvm
, "Add channel context\n");

4780 
phy_˘xt
 = 
	`iwl_mvm_gë_‰ì_phy_˘xt
(
mvm
);

4781 i‡(!
phy_˘xt
) {

4782 
ªt
 = -
ENOSPC
;

4783 
out
;

4786 
ªt
 = 
	`iwl_mvm_phy_˘xt_add
(
mvm
, 
phy_˘xt
, 
def
, &
˘x
->
≠
,

4787 
˘x
->
rx_chaös_°©ic
,

4788 
˘x
->
rx_chaös_dy«mic
);

4789 i‡(
ªt
) {

4790 
	`IWL_ERR
(
mvm
, "FailedÅoádd PHY context\n");

4791 
out
;

4794 *
phy_˘xt_id
 = 
phy_˘xt
->
id
;

4795 
out
:

4796  
ªt
;

4797 
	}
}

4799 
	$iwl_mvm_add_ch™˘x
(
õì80211_hw
 *
hw
,

4800 
õì80211_ch™˘x_c⁄f
 *
˘x
)

4802 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

4803 
ªt
;

4805 
	`muãx_lock
(&
mvm
->
muãx
);

4806 
ªt
 = 
	`__iwl_mvm_add_ch™˘x
(
mvm
, 
˘x
);

4807 
	`muãx_u∆ock
(&
mvm
->
muãx
);

4809  
ªt
;

4810 
	}
}

4812 
	$__iwl_mvm_ªmove_ch™˘x
(
iwl_mvm
 *
mvm
,

4813 
õì80211_ch™˘x_c⁄f
 *
˘x
)

4815 
u16
 *
phy_˘xt_id
 = (u16 *)
˘x
->
drv_¥iv
;

4816 
iwl_mvm_phy_˘xt
 *
phy_˘xt
 = &
mvm
->
phy_˘xts
[*
phy_˘xt_id
];

4818 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

4820 
	`iwl_mvm_phy_˘xt_uƒef
(
mvm
, 
phy_˘xt
);

4821 
	}
}

4823 
	$iwl_mvm_ªmove_ch™˘x
(
õì80211_hw
 *
hw
,

4824 
õì80211_ch™˘x_c⁄f
 *
˘x
)

4826 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

4828 
	`muãx_lock
(&
mvm
->
muãx
);

4829 
	`__iwl_mvm_ªmove_ch™˘x
(
mvm
, 
˘x
);

4830 
	`muãx_u∆ock
(&
mvm
->
muãx
);

4831 
	}
}

4833 
	$iwl_mvm_ch™ge_ch™˘x
(
õì80211_hw
 *
hw
,

4834 
õì80211_ch™˘x_c⁄f
 *
˘x
, 
u32
 
ch™ged
)

4836 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

4837 
u16
 *
phy_˘xt_id
 = (u16 *)
˘x
->
drv_¥iv
;

4838 
iwl_mvm_phy_˘xt
 *
phy_˘xt
 = &
mvm
->
phy_˘xts
[*
phy_˘xt_id
];

4839 
cfg80211_ch™_def
 *
def
 = 
	`iwl_mvm_ch™˘x_def
(
mvm
, 
˘x
);

4841 i‡(
	`WARN_ONCE
((
phy_˘xt
->
ªf
 > 1) &&

4842 (
ch™ged
 & ~(
IEEE80211_CHANCTX_CHANGE_WIDTH
 |

4843 
IEEE80211_CHANCTX_CHANGE_RX_CHAINS
 |

4844 
IEEE80211_CHANCTX_CHANGE_RADAR
 |

4845 
IEEE80211_CHANCTX_CHANGE_MIN_WIDTH
)),

4847 
phy_˘xt
->
ªf
, 
ch™ged
))

4850 
	`muãx_lock
(&
mvm
->
muãx
);

4853 i‡(
ch™ged
 =
IEEE80211_CHANCTX_CHANGE_MIN_WIDTH
) {

4854 i‡(
phy_˘xt
->
width
 =
def
->width)

4855 
out_u∆ock
;

4858 i‡(
phy_˘xt
->
width
 <
NL80211_CHAN_WIDTH_20
 &&

4859 
def
->
width
 <
NL80211_CHAN_WIDTH_20
)

4860 
out_u∆ock
;

4863 
	`iwl_mvm_bt_c€x_vif_ch™ge
(
mvm
);

4864 
	`iwl_mvm_phy_˘xt_ch™ged
(
mvm
, 
phy_˘xt
, 
def
, &
˘x
->
≠
,

4865 
˘x
->
rx_chaös_°©ic
,

4866 
˘x
->
rx_chaös_dy«mic
);

4868 
out_u∆ock
:

4869 
	`muãx_u∆ock
(&
mvm
->
muãx
);

4870 
	}
}

4878 
boﬁ


4879 
	$__iwl_mvm_assign_vif_ch™˘x_comm⁄
(
iwl_mvm
 *
mvm
,

4880 
õì80211_vif
 *
vif
,

4881 
õì80211_ch™˘x_c⁄f
 *
˘x
,

4882 
boﬁ
 
swôchög_ch™˘x
, *
ªt
)

4884 
u16
 *
phy_˘xt_id
 = (u16 *)
˘x
->
drv_¥iv
;

4885 
iwl_mvm_phy_˘xt
 *
phy_˘xt
 = &
mvm
->
phy_˘xts
[*
phy_˘xt_id
];

4886 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

4888 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

4890 
mvmvif
->
deÊök
.
phy_˘xt
 =Öhy_ctxt;

4892 
vif
->
ty≥
) {

4893 
NL80211_IFTYPE_AP
:

4895 i‡(
swôchög_ch™˘x
) {

4896 
mvmvif
->
≠_ibss_a˘ive
 = 
åue
;

4899 
ÁŒthrough
;

4900 
NL80211_IFTYPE_ADHOC
:

4905 *
ªt
 = 0;

4906  
åue
;

4907 
NL80211_IFTYPE_STATION
:

4909 
NL80211_IFTYPE_MONITOR
:

4911 
mvmvif
->
ps_dißbÀd
 = 
åue
;

4914 *
ªt
 = -
EINVAL
;

4915  
åue
;

4917  
Ál£
;

4918 
	}
}

4920 
	$__iwl_mvm_assign_vif_ch™˘x
(
iwl_mvm
 *
mvm
,

4921 
õì80211_vif
 *
vif
,

4922 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

4923 
õì80211_ch™˘x_c⁄f
 *
˘x
,

4924 
boﬁ
 
swôchög_ch™˘x
)

4926 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

4927 
ªt
;

4929 i‡(
	`WARN_ON
(!
lök_c⁄f
))

4930  -
EINVAL
;

4932 i‡(
	`__iwl_mvm_assign_vif_ch™˘x_comm⁄
(
mvm
, 
vif
, 
˘x
,

4933 
swôchög_ch™˘x
, &
ªt
))

4934 
out
;

4936 
ªt
 = 
	`iwl_mvm_bödög_add_vif
(
mvm
, 
vif
);

4937 i‡(
ªt
)

4938 
out
;

4944 
	`iwl_mvm_powî_upd©e_mac
(
mvm
);

4950 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_MONITOR
) {

4951 
mvmvif
->
m⁄ô‹_a˘ive
 = 
åue
;

4952 
ªt
 = 
	`iwl_mvm_upd©e_quŸas
(
mvm
, 
Ál£
, 
NULL
);

4953 i‡(
ªt
)

4954 
out_ªmove_bödög
;

4956 
ªt
 = 
	`iwl_mvm_add_¢if_°a
(
mvm
, 
vif
);

4957 i‡(
ªt
)

4958 
out_ªmove_bödög
;

4963 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
) {

4964 
	`iwl_mvm_upd©e_quŸas
(
mvm
, 
Ál£
, 
NULL
);

4965 
	`iwl_mvm_mac_˘xt_ch™ged
(
mvm
, 
vif
, 
Ál£
, 
NULL
);

4968 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
) {

4969 i‡(!
swôchög_ch™˘x
) {

4970 
mvmvif
->
cß_b˙_≥ndög
 = 
Ál£
;

4971 
out
;

4974 
mvmvif
->
cß_b˙_≥ndög
 = 
åue
;

4976 i‡(!
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

4977 
IWL_UCODE_TLV_CAPA_CHANNEL_SWITCH_CMD
)) {

4978 
u32
 
duøti⁄
 = 5 * 
vif
->
bss_c⁄f
.
bóc⁄_öt
;

4983 
	`iwl_mvm_¥Ÿe˘_£ssi⁄
(
mvm
, 
vif
, 
duøti⁄
, duration,

4984 
vif
->
bss_c⁄f
.
bóc⁄_öt
 / 2,

4985 
åue
);

4988 
	`iwl_mvm_upd©e_quŸas
(
mvm
, 
Ál£
, 
NULL
);

4991 
out
;

4993 
out_ªmove_bödög
:

4994 
	`iwl_mvm_bödög_ªmove_vif
(
mvm
, 
vif
);

4995 
	`iwl_mvm_powî_upd©e_mac
(
mvm
);

4996 
out
:

4997 i‡(
ªt
)

4998 
mvmvif
->
deÊök
.
phy_˘xt
 = 
NULL
;

4999  
ªt
;

5000 
	}
}

5002 
	$iwl_mvm_assign_vif_ch™˘x
(
õì80211_hw
 *
hw
,

5003 
õì80211_vif
 *
vif
,

5004 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

5005 
õì80211_ch™˘x_c⁄f
 *
˘x
)

5007 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

5008 
ªt
;

5010 
	`muãx_lock
(&
mvm
->
muãx
);

5011 
ªt
 = 
	`__iwl_mvm_assign_vif_ch™˘x
(
mvm
, 
vif
, 
lök_c⁄f
, 
˘x
, 
Ál£
);

5012 
	`muãx_u∆ock
(&
mvm
->
muãx
);

5014  
ªt
;

5015 
	}
}

5023 
boﬁ
 
	$__iwl_mvm_u«ssign_vif_ch™˘x_comm⁄
(
iwl_mvm
 *
mvm
,

5024 
õì80211_vif
 *
vif
,

5025 
boﬁ
 
swôchög_ch™˘x
)

5027 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

5029 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

5030 
	`iwl_mvm_ªmove_time_evít
(
mvm
, 
mvmvif
,

5031 &
mvmvif
->
time_evít_d©a
);

5033 
vif
->
ty≥
) {

5034 
NL80211_IFTYPE_ADHOC
:

5035  
åue
;

5036 
NL80211_IFTYPE_MONITOR
:

5037 
mvmvif
->
m⁄ô‹_a˘ive
 = 
Ál£
;

5038 
mvmvif
->
ps_dißbÀd
 = 
Ál£
;

5040 
NL80211_IFTYPE_AP
:

5042 i‡(!
swôchög_ch™˘x
 || !
mvmvif
->
≠_ibss_a˘ive
)

5043  
åue
;

5045 
mvmvif
->
cß_cou¡down
 = 
Ál£
;

5048 
	`iwl_mvm_modify_Æl_°a_dißbÀ_tx
(
mvm
, 
mvmvif
, 
åue
);

5051 
	`rcu_assign_poöãr
(
mvm
->
cß_tx_blocked_vif
, 
vif
);

5053 
mvmvif
->
≠_ibss_a˘ive
 = 
Ál£
;

5058  
Ál£
;

5059 
	}
}

5061 
	$__iwl_mvm_u«ssign_vif_ch™˘x
(
iwl_mvm
 *
mvm
,

5062 
õì80211_vif
 *
vif
,

5063 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

5064 
õì80211_ch™˘x_c⁄f
 *
˘x
,

5065 
boﬁ
 
swôchög_ch™˘x
)

5067 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

5068 
õì80211_vif
 *
dißbÀd_vif
 = 
NULL
;

5070 i‡(
	`__iwl_mvm_u«ssign_vif_ch™˘x_comm⁄
(
mvm
, 
vif
, 
swôchög_ch™˘x
))

5071 
out
;

5073 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_MONITOR
)

5074 
	`iwl_mvm_rm_¢if_°a
(
mvm
, 
vif
);

5077 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
 && 
swôchög_ch™˘x
) {

5078 
dißbÀd_vif
 = 
vif
;

5079 i‡(!
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

5080 
IWL_UCODE_TLV_CAPA_CHANNEL_SWITCH_CMD
))

5081 
	`iwl_mvm_mac_˘xt_ch™ged
(
mvm
, 
vif
, 
åue
, 
NULL
);

5084 
	`iwl_mvm_upd©e_quŸas
(
mvm
, 
Ál£
, 
dißbÀd_vif
);

5085 
	`iwl_mvm_bödög_ªmove_vif
(
mvm
, 
vif
);

5087 
out
:

5088 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_CAPA_CHANNEL_SWITCH_CMD
) &&

5089 
swôchög_ch™˘x
)

5091 
mvmvif
->
deÊök
.
phy_˘xt
 = 
NULL
;

5092 
	`iwl_mvm_powî_upd©e_mac
(
mvm
);

5093 
	}
}

5095 
	$iwl_mvm_u«ssign_vif_ch™˘x
(
õì80211_hw
 *
hw
,

5096 
õì80211_vif
 *
vif
,

5097 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

5098 
õì80211_ch™˘x_c⁄f
 *
˘x
)

5100 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

5102 
	`muãx_lock
(&
mvm
->
muãx
);

5103 
	`__iwl_mvm_u«ssign_vif_ch™˘x
(
mvm
, 
vif
, 
lök_c⁄f
, 
˘x
, 
Ál£
);

5104 
	`muãx_u∆ock
(&
mvm
->
muãx
);

5105 
	}
}

5108 
	$iwl_mvm_swôch_vif_ch™˘x_sw≠
(
iwl_mvm
 *
mvm
,

5109 
õì80211_vif_ch™˘x_swôch
 *
vifs
,

5110 c⁄° 
iwl_mvm_swôch_vif_ch™˘x_›s
 *
›s
)

5112 
ªt
;

5114 
	`muãx_lock
(&
mvm
->
muãx
);

5115 
›s
->
	`__u«ssign_vif_ch™˘x
(
mvm
, 
vifs
[0].
vif
, vifs[0].
lök_c⁄f
,

5116 
vifs
[0].
ﬁd_˘x
, 
åue
);

5117 
	`__iwl_mvm_ªmove_ch™˘x
(
mvm
, 
vifs
[0].
ﬁd_˘x
);

5119 
ªt
 = 
	`__iwl_mvm_add_ch™˘x
(
mvm
, 
vifs
[0].
√w_˘x
);

5120 i‡(
ªt
) {

5121 
	`IWL_ERR
(
mvm
, "failedÅoáddÇew_ctx during channel switch\n");

5122 
out_ªassign
;

5125 
ªt
 = 
›s
->
	`__assign_vif_ch™˘x
(
mvm
, 
vifs
[0].
vif
, vifs[0].
lök_c⁄f
,

5126 
vifs
[0].
√w_˘x
, 
åue
);

5127 i‡(
ªt
) {

5128 
	`IWL_ERR
(
mvm
,

5130 
out_ªmove
;

5134 i‡(
	`iwl_mvm_phy_˘x_cou¡
(
mvm
) > 1)

5135 
	`iwl_mvm_ã¨down_tdls_≥îs
(
mvm
);

5137 
out
;

5139 
out_ªmove
:

5140 
	`__iwl_mvm_ªmove_ch™˘x
(
mvm
, 
vifs
[0].
√w_˘x
);

5142 
out_ªassign
:

5143 i‡(
	`__iwl_mvm_add_ch™˘x
(
mvm
, 
vifs
[0].
ﬁd_˘x
)) {

5144 
	`IWL_ERR
(
mvm
, "failedÅoádd old_ctx backáfter failure.\n");

5145 
out_ª°¨t
;

5148 i‡(
›s
->
	`__assign_vif_ch™˘x
(
mvm
, 
vifs
[0].
vif
, vifs[0].
lök_c⁄f
,

5149 
vifs
[0].
ﬁd_˘x
, 
åue
)) {

5150 
	`IWL_ERR
(
mvm
, "failedÅoÑeassign old_ctxáfter failure.\n");

5151 
out_ª°¨t
;

5154 
out
;

5156 
out_ª°¨t
:

5158 
	`iwl_mvm_nic_ª°¨t
(
mvm
, 
Ál£
);

5160 
out
:

5161 
	`muãx_u∆ock
(&
mvm
->
muãx
);

5163  
ªt
;

5164 
	}
}

5167 
	$iwl_mvm_swôch_vif_ch™˘x_ªassign
(
iwl_mvm
 *
mvm
,

5168 
õì80211_vif_ch™˘x_swôch
 *
vifs
,

5169 c⁄° 
iwl_mvm_swôch_vif_ch™˘x_›s
 *
›s
)

5171 
ªt
;

5173 
	`muãx_lock
(&
mvm
->
muãx
);

5174 
›s
->
	`__u«ssign_vif_ch™˘x
(
mvm
, 
vifs
[0].
vif
, vifs[0].
lök_c⁄f
,

5175 
vifs
[0].
ﬁd_˘x
, 
åue
);

5177 
ªt
 = 
›s
->
	`__assign_vif_ch™˘x
(
mvm
, 
vifs
[0].
vif
, vifs[0].
lök_c⁄f
,

5178 
vifs
[0].
√w_˘x
, 
åue
);

5179 i‡(
ªt
) {

5180 
	`IWL_ERR
(
mvm
,

5182 
out_ªassign
;

5185 
out
;

5187 
out_ªassign
:

5188 i‡(
›s
->
	`__assign_vif_ch™˘x
(
mvm
, 
vifs
[0].
vif
, vifs[0].
lök_c⁄f
,

5189 
vifs
[0].
ﬁd_˘x
, 
åue
)) {

5190 
	`IWL_ERR
(
mvm
, "failedÅoÑeassign old_ctxáfter failure.\n");

5191 
out_ª°¨t
;

5194 
out
;

5196 
out_ª°¨t
:

5198 
	`iwl_mvm_nic_ª°¨t
(
mvm
, 
Ál£
);

5200 
out
:

5201 
	`muãx_u∆ock
(&
mvm
->
muãx
);

5203  
ªt
;

5204 
	}
}

5208 
	$iwl_mvm_swôch_vif_ch™˘x_comm⁄
(
õì80211_hw
 *
hw
,

5209 
õì80211_vif_ch™˘x_swôch
 *
vifs
,

5210 
n_vifs
,

5211 
õì80211_ch™˘x_swôch_mode
 
mode
,

5212 c⁄° 
iwl_mvm_swôch_vif_ch™˘x_›s
 *
›s
)

5214 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

5215 
ªt
;

5218 i‡(
n_vifs
 > 1)

5219  -
EOPNOTSUPP
;

5221 
mode
) {

5222 
CHANCTX_SWMODE_SWAP_CONTEXTS
:

5223 
ªt
 = 
	`iwl_mvm_swôch_vif_ch™˘x_sw≠
(
mvm
, 
vifs
, 
›s
);

5225 
CHANCTX_SWMODE_REASSIGN_VIF
:

5226 
ªt
 = 
	`iwl_mvm_swôch_vif_ch™˘x_ªassign
(
mvm
, 
vifs
, 
›s
);

5229 
ªt
 = -
EOPNOTSUPP
;

5233  
ªt
;

5234 
	}
}

5236 
	$iwl_mvm_swôch_vif_ch™˘x
(
õì80211_hw
 *
hw
,

5237 
õì80211_vif_ch™˘x_swôch
 *
vifs
,

5238 
n_vifs
,

5239 
õì80211_ch™˘x_swôch_mode
 
mode
)

5241 c⁄° 
iwl_mvm_swôch_vif_ch™˘x_›s
 
›s
 = {

5242 .
__assign_vif_ch™˘x
 = 
__iwl_mvm_assign_vif_ch™˘x
,

5243 .
__u«ssign_vif_ch™˘x
 = 
__iwl_mvm_u«ssign_vif_ch™˘x
,

5246  
	`iwl_mvm_swôch_vif_ch™˘x_comm⁄
(
hw
, 
vifs
, 
n_vifs
, 
mode
, &
›s
);

5247 
	}
}

5249 
	$iwl_mvm_tx_œ°_bóc⁄
(
õì80211_hw
 *
hw
)

5251 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

5253  
mvm
->
ibss_m™agî
;

5254 
	}
}

5256 
	$iwl_mvm_£t_tim
(
õì80211_hw
 *
hw
, 
õì80211_°a
 *
°a
,

5257 
boﬁ
 
£t
)

5259 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

5260 
iwl_mvm_°a
 *
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

5262 i‡(!
mvm_°a
 || !mvm_°a->
vif
) {

5263 
	`IWL_ERR
(
mvm
, "Station isÇotássociatedÅoá vif\n");

5264  -
EINVAL
;

5267  
	`iwl_mvm_mac_˘xt_bóc⁄_ch™ged
(
mvm
, 
mvm_°a
->
vif
,

5268 &
mvm_°a
->
vif
->
bss_c⁄f
);

5269 
	}
}

5271 #ifde‡
CONFIG_NL80211_TESTMODE


5272 c⁄° 
∆a_pﬁicy
 
	giwl_mvm_tm_pﬁicy
[
IWL_MVM_TM_ATTR_MAX
 + 1] = {

5273 [
IWL_MVM_TM_ATTR_CMD
] = { .
ty≥
 = 
NLA_U32
 },

5274 [
IWL_MVM_TM_ATTR_NOA_DURATION
] = { .
ty≥
 = 
NLA_U32
 },

5275 [
IWL_MVM_TM_ATTR_BEACON_FILTER_STATE
] = { .
ty≥
 = 
NLA_U32
 },

5278 
	$__iwl_mvm_mac_ã°mode_cmd
(
iwl_mvm
 *
mvm
,

5279 
õì80211_vif
 *
vif
,

5280 *
d©a
, 
Àn
)

5282 
∆©å
 *
tb
[
IWL_MVM_TM_ATTR_MAX
 + 1];

5283 
îr
;

5284 
u32
 
nﬂ_duøti⁄
;

5286 
îr
 = 
	`∆a_∑r£_dïªˇãd
(
tb
, 
IWL_MVM_TM_ATTR_MAX
, 
d©a
, 
Àn
,

5287 
iwl_mvm_tm_pﬁicy
, 
NULL
);

5288 i‡(
îr
)

5289  
îr
;

5291 i‡(!
tb
[
IWL_MVM_TM_ATTR_CMD
])

5292  -
EINVAL
;

5294 
	`∆a_gë_u32
(
tb
[
IWL_MVM_TM_ATTR_CMD
])) {

5295 
IWL_MVM_TM_CMD_SET_NOA
:

5296 i‡(!
vif
 || vif->
ty≥
 !
NL80211_IFTYPE_AP
 || !vif->
p2p
 ||

5297 !
vif
->
bss_c⁄f
.
íabÀ_bóc⁄
 ||

5298 !
tb
[
IWL_MVM_TM_ATTR_NOA_DURATION
])

5299  -
EINVAL
;

5301 
nﬂ_duøti⁄
 = 
	`∆a_gë_u32
(
tb
[
IWL_MVM_TM_ATTR_NOA_DURATION
]);

5302 i‡(
nﬂ_duøti⁄
 >
vif
->
bss_c⁄f
.
bóc⁄_öt
)

5303  -
EINVAL
;

5305 
mvm
->
nﬂ_duøti⁄
 =Çoa_duration;

5306 
mvm
->
nﬂ_vif
 = 
vif
;

5308  
	`iwl_mvm_upd©e_quŸas
(
mvm
, 
åue
, 
NULL
);

5309 
IWL_MVM_TM_CMD_SET_BEACON_FILTER
:

5311 i‡(!
vif
 || vif->
ty≥
 !
NL80211_IFTYPE_STATION
 ||

5312 !
vif
->
cfg
.
assoc
 || !vif->
bss_c⁄f
.
dtim_≥riod
 ||

5313 !
tb
[
IWL_MVM_TM_ATTR_BEACON_FILTER_STATE
])

5314  -
EINVAL
;

5316 i‡(
	`∆a_gë_u32
(
tb
[
IWL_MVM_TM_ATTR_BEACON_FILTER_STATE
]))

5317  
	`iwl_mvm_íabÀ_bóc⁄_fûãr
(
mvm
, 
vif
);

5318  
	`iwl_mvm_dißbÀ_bóc⁄_fûãr
(
mvm
, 
vif
);

5321  -
EOPNOTSUPP
;

5322 
	}
}

5324 
	$iwl_mvm_mac_ã°mode_cmd
(
õì80211_hw
 *
hw
,

5325 
õì80211_vif
 *
vif
,

5326 *
d©a
, 
Àn
)

5328 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

5329 
îr
;

5331 
	`muãx_lock
(&
mvm
->
muãx
);

5332 
îr
 = 
	`__iwl_mvm_mac_ã°mode_cmd
(
mvm
, 
vif
, 
d©a
, 
Àn
);

5333 
	`muãx_u∆ock
(&
mvm
->
muãx
);

5335  
îr
;

5336 
	}
}

5339 
	$iwl_mvm_ch™√l_swôch
(
õì80211_hw
 *
hw
, 
õì80211_vif
 *
vif
,

5340 
õì80211_ch™√l_swôch
 *
chsw
)

5348 
	`IWL_DEBUG_MAC80211
(
	`IWL_MAC80211_GET_MVM
(
hw
),

5350 
	}
}

5352 
	$iwl_mvm_scheduÀ_˛õ¡_cß
(
iwl_mvm
 *
mvm
,

5353 
õì80211_vif
 *
vif
,

5354 
õì80211_ch™√l_swôch
 *
chsw
)

5356 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

5357 
iwl_ch™_swôch_ã_cmd
 
cmd
 = {

5358 .
mac_id
 = 
	`˝u_to_À32
(
	`FW_CMD_ID_AND_COLOR
(
mvmvif
->
id
,

5359 
mvmvif
->
cﬁ‹
)),

5360 .
a˘i⁄
 = 
	`˝u_to_À32
(
FW_CTXT_ACTION_ADD
),

5361 .
tsf
 = 
	`˝u_to_À32
(
chsw
->
time°amp
),

5362 .
cs_cou¡
 = 
chsw
->
cou¡
,

5363 .
cs_mode
 = 
chsw
->
block_tx
,

5366 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

5368 i‡(
chsw
->
dñay
)

5369 
cmd
.
cs_dñayed_b˙_cou¡
 =

5370 
	`DIV_ROUND_UP
(
chsw
->
dñay
, 
vif
->
bss_c⁄f
.
bóc⁄_öt
);

5372  
	`iwl_mvm_£nd_cmd_pdu
(
mvm
,

5373 
	`WIDE_ID
(
MAC_CONF_GROUP
,

5374 
CHANNEL_SWITCH_TIME_EVENT_CMD
),

5375 0, (
cmd
), &cmd);

5376 
	}
}

5378 
	$iwl_mvm_ﬁd_¥e_ch™_sw_°a
(
iwl_mvm
 *
mvm
,

5379 
õì80211_vif
 *
vif
,

5380 
õì80211_ch™√l_swôch
 *
chsw
)

5382 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

5383 
u32
 
≠∂y_time
;

5391 i‡(
chsw
->
cou¡
 <= 1)

5392 
≠∂y_time
 = 0;

5394 
≠∂y_time
 = 
chsw
->
devi˚_time°amp
 +

5395 ((
vif
->
bss_c⁄f
.
bóc⁄_öt
 * (
chsw
->
cou¡
 - 1) -

5396 
IWL_MVM_CHANNEL_SWITCH_TIME_CLIENT
) * 1024);

5398 i‡(
chsw
->
block_tx
)

5399 
	`iwl_mvm_cß_˛õ¡_ab£¡
(
mvm
, 
vif
);

5401 i‡(
mvmvif
->
bf_d©a
.
bf_íabÀd
) {

5402 
ªt
 = 
	`iwl_mvm_dißbÀ_bóc⁄_fûãr
(
mvm
, 
vif
);

5404 i‡(
ªt
)

5405  
ªt
;

5408 
	`iwl_mvm_scheduÀ_cß_≥riod
(
mvm
, 
vif
, vif->
bss_c⁄f
.
bóc⁄_öt
,

5409 
≠∂y_time
);

5412 
	}
}

5414 
	#IWL_MAX_CSA_BLOCK_TX
 1500

	)

5415 
	$iwl_mvm_¥e_ch™√l_swôch
(
õì80211_hw
 *
hw
,

5416 
õì80211_vif
 *
vif
,

5417 
õì80211_ch™√l_swôch
 *
chsw
)

5419 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

5420 
õì80211_vif
 *
cß_vif
;

5421 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

5422 
ªt
;

5424 
	`muãx_lock
(&
mvm
->
muãx
);

5426 
mvmvif
->
cß_Áûed
 = 
Ál£
;

5428 
	`IWL_DEBUG_MAC80211
(
mvm
, "pre CSAÅo freq %d\n",

5429 
chsw
->
ch™def
.
˚¡î_‰eq1
);

5431 
	`iwl_fw_dbg_åiggî_sim∂e_°›
(&
mvm
->
fwπ
,

5432 
	`õì80211_vif_to_wdev
(
vif
),

5433 
FW_DBG_TRIGGER_CHANNEL_SWITCH
);

5435 
vif
->
ty≥
) {

5436 
NL80211_IFTYPE_AP
:

5437 
cß_vif
 =

5438 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm
->
cß_vif
,

5439 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

5440 i‡(
	`WARN_ONCE
(
cß_vif
 && cß_vif->
bss_c⁄f
.
cß_a˘ive
,

5442 
ªt
 = -
EBUSY
;

5443 
out_u∆ock
;

5447 i‡(
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm
->
cß_tx_blocked_vif
,

5448 
	`lockdï_is_hñd
(&
mvm
->
muãx
))) {

5449 
ªt
 = -
EBUSY
;

5450 
out_u∆ock
;

5453 
	`rcu_assign_poöãr
(
mvm
->
cß_vif
, 
vif
);

5455 i‡(
	`WARN_ONCE
(
mvmvif
->
cß_cou¡down
,

5457 
ªt
 = -
EBUSY
;

5458 
out_u∆ock
;

5461 
mvmvif
->
cß_èrgë_‰eq
 = 
chsw
->
ch™def
.
ch™
->
˚¡î_‰eq
;

5464 
NL80211_IFTYPE_STATION
:

5469 i‡(
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
MAC_CONF_GROUP
,

5470 
CHANNEL_SWITCH_ERROR_NOTIF
,

5479 i‡(!
vif
->
cfg
.
assoc
 || !vif->
bss_c⁄f
.
dtim_≥riod
) {

5480 
ªt
 = -
EBUSY
;

5481 
out_u∆ock
;

5484 i‡(
chsw
->
dñay
 > 
IWL_MAX_CSA_BLOCK_TX
 &&

5485 
	`hweight16
(
vif
->
vÆid_löks
) <= 1)

5486 
	`scheduÀ_dñayed_w‹k
(&
mvmvif
->
cß_w‹k
, 0);

5488 i‡(
chsw
->
block_tx
) {

5493 i‡(!
chsw
->
cou¡
 ||

5494 
chsw
->
cou¡
 * 
vif
->
bss_c⁄f
.
bóc⁄_öt
 >

5495 
IWL_MAX_CSA_BLOCK_TX
)

5496 
	`scheduÀ_dñayed_w‹k
(&
mvmvif
->
cß_w‹k
,

5497 
	`m£cs_to_jiffõs
(
IWL_MAX_CSA_BLOCK_TX
));

5500 i‡(!
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

5501 
IWL_UCODE_TLV_CAPA_CHANNEL_SWITCH_CMD
)) {

5502 
ªt
 = 
	`iwl_mvm_ﬁd_¥e_ch™_sw_°a
(
mvm
, 
vif
, 
chsw
);

5503 i‡(
ªt
)

5504 
out_u∆ock
;

5506 
	`iwl_mvm_scheduÀ_˛õ¡_cß
(
mvm
, 
vif
, 
chsw
);

5509 
mvmvif
->
cß_cou¡
 = 
chsw
->
cou¡
;

5510 
mvmvif
->
cß_misbehave
 = 
Ál£
;

5516 
mvmvif
->
ps_dißbÀd
 = 
åue
;

5518 
ªt
 = 
	`iwl_mvm_powî_upd©e_ps
(
mvm
);

5519 i‡(
ªt
)

5520 
out_u∆ock
;

5523 
	`iwl_mvm_ã¨down_tdls_≥îs
(
mvm
);

5525 
out_u∆ock
:

5526 
	`muãx_u∆ock
(&
mvm
->
muãx
);

5528  
ªt
;

5529 
	}
}

5531 
	$iwl_mvm_ch™√l_swôch_rx_bóc⁄
(
õì80211_hw
 *
hw
,

5532 
õì80211_vif
 *
vif
,

5533 
õì80211_ch™√l_swôch
 *
chsw
)

5535 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

5536 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

5537 
iwl_ch™_swôch_ã_cmd
 
cmd
 = {

5538 .
mac_id
 = 
	`˝u_to_À32
(
	`FW_CMD_ID_AND_COLOR
(
mvmvif
->
id
,

5539 
mvmvif
->
cﬁ‹
)),

5540 .
a˘i⁄
 = 
	`˝u_to_À32
(
FW_CTXT_ACTION_MODIFY
),

5541 .
tsf
 = 
	`˝u_to_À32
(
chsw
->
time°amp
),

5542 .
cs_cou¡
 = 
chsw
->
cou¡
,

5543 .
cs_mode
 = 
chsw
->
block_tx
,

5550 i‡(
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
MAC_CONF_GROUP
,

5551 
CHANNEL_SWITCH_ERROR_NOTIF
, 0))

5554 i‡(!
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_CAPA_CS_MODIFY
))

5557 
	`IWL_DEBUG_MAC80211
(
mvm
, "Modify CSA on mac %d count = %d (old %d) mode = %d\n",

5558 
mvmvif
->
id
, 
chsw
->
cou¡
, mvmvif->
cß_cou¡
, chsw->
block_tx
);

5560 i‡(
chsw
->
cou¡
 >
mvmvif
->
cß_cou¡
 && chsw->
block_tx
) {

5561 i‡(
mvmvif
->
cß_misbehave
) {

5562 
õì80211_bss_c⁄f
 *
lök_c⁄f
;

5566 
lök_c⁄f
 = 
	`wùhy_dîe„ªn˚
(
hw
->
wùhy
,

5567 
vif
->
lök_c⁄f
[
chsw
->
lök_id
]);

5568 i‡(
	`WARN_ON
(!
lök_c⁄f
))

5571 
	`iwl_mvm_ab‹t_ch™√l_swôch
(
hw
, 
vif
, 
lök_c⁄f
);

5572 
	`õì80211_chswôch_d⁄e
(
vif
, 
Ál£
, 0);

5573 
mvmvif
->
cß_misbehave
 = 
Ál£
;

5576 
mvmvif
->
cß_misbehave
 = 
åue
;

5578 
mvmvif
->
cß_cou¡
 = 
chsw
->
cou¡
;

5580 
	`muãx_lock
(&
mvm
->
muãx
);

5581 i‡(
mvmvif
->
cß_Áûed
)

5582 
out_u∆ock
;

5584 
	`WARN_ON
(
	`iwl_mvm_£nd_cmd_pdu
(
mvm
,

5585 
	`WIDE_ID
(
MAC_CONF_GROUP
,

5586 
CHANNEL_SWITCH_TIME_EVENT_CMD
),

5587 0, (
cmd
), &cmd));

5588 
out_u∆ock
:

5589 
	`muãx_u∆ock
(&
mvm
->
muãx
);

5590 
	}
}

5592 
	$iwl_mvm_Êush_no_vif
(
iwl_mvm
 *
mvm
, 
u32
 
queues
, 
boﬁ
 
dr›
)

5594 
i
;

5596 i‡(!
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)) {

5597 i‡(
dr›
) {

5598 
	`muãx_lock
(&
mvm
->
muãx
);

5599 
	`iwl_mvm_Êush_tx_∑th
(
mvm
,

5600 
	`iwl_mvm_ÊushabÀ_queues
(
mvm
Ë& 
queues
);

5601 
	`muãx_u∆ock
(&
mvm
->
muãx
);

5603 
	`iwl_å™s_waô_tx_queues_em±y
(
mvm
->
å™s
, 
queues
);

5608 
	`muãx_lock
(&
mvm
->
muãx
);

5609 
i
 = 0; i < 
mvm
->
fw
->
ucode_ˇ∑
.
num_°©i⁄s
; i++) {

5610 
õì80211_°a
 *
°a
;

5612 
°a
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm
->
fw_id_to_mac_id
[
i
],

5613 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

5614 i‡(
	`IS_ERR_OR_NULL
(
°a
))

5617 i‡(
dr›
)

5618 
	`iwl_mvm_Êush_°a_tids
(
mvm
, 
i
, 0xFFFF);

5620 
	`iwl_mvm_waô_°a_queues_em±y
(
mvm
,

5621 
	`iwl_mvm_°a_‰om_mac80211
(
°a
));

5623 
	`muãx_u∆ock
(&
mvm
->
muãx
);

5624 
	}
}

5626 
	$iwl_mvm_mac_Êush
(
õì80211_hw
 *
hw
, 
õì80211_vif
 *
vif
,

5627 
u32
 
queues
, 
boﬁ
 
dr›
)

5629 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

5630 
iwl_mvm_vif
 *
mvmvif
;

5631 
iwl_mvm_°a
 *
mvm°a
;

5632 
õì80211_°a
 *
°a
;

5633 
boﬁ
 
≠_°a_d⁄e
 = 
Ál£
;

5634 
i
;

5635 
u32
 
msk
 = 0;

5637 i‡(!
vif
) {

5638 
	`iwl_mvm_Êush_no_vif
(
mvm
, 
queues
, 
dr›
);

5643 
	`Êush_w‹k
(&
mvm
->
add_°ªam_wk
);

5645 
	`muãx_lock
(&
mvm
->
muãx
);

5646 
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

5649 
i
 = 0; i < 
mvm
->
fw
->
ucode_ˇ∑
.
num_°©i⁄s
; i++) {

5650 
°a
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm
->
fw_id_to_mac_id
[
i
],

5651 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

5652 i‡(
	`IS_ERR_OR_NULL
(
°a
))

5655 
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

5656 i‡(
mvm°a
->
vif
 != vif)

5659 i‡(
°a
 =
mvmvif
->
≠_°a
) {

5660 i‡(
≠_°a_d⁄e
)

5662 
≠_°a_d⁄e
 = 
åue
;

5665 i‡(
dr›
) {

5666 i‡(
	`iwl_mvm_Êush_°a
(
mvm
, 
mvm°a
->
deÊök
.
°a_id
,

5667 
mvm°a
->
tfd_queue_msk
))

5668 
	`IWL_ERR
(
mvm
, "flushÑequest fail\n");

5670 i‡(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
))

5671 
	`iwl_mvm_waô_°a_queues_em±y
(
mvm
, 
mvm°a
);

5673 
msk
 |
mvm°a
->
tfd_queue_msk
;

5677 
	`muãx_u∆ock
(&
mvm
->
muãx
);

5682 i‡(!
dr›
 && !
	`iwl_mvm_has_√w_tx_≠i
(
mvm
))

5683 
	`iwl_å™s_waô_tx_queues_em±y
(
mvm
->
å™s
, 
msk
);

5684 
	}
}

5686 
	$iwl_mvm_mac_Êush_°a
(
õì80211_hw
 *
hw
, 
õì80211_vif
 *
vif
,

5687 
õì80211_°a
 *
°a
)

5689 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

5690 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

5691 
iwl_mvm_lök_°a
 *
mvm_lök_°a
;

5692 
õì80211_lök_°a
 *
lök_°a
;

5693 
lök_id
;

5695 
	`muãx_lock
(&
mvm
->
muãx
);

5696 
	`f‹_óch_°a_a˘ive_lök
(
vif
, 
°a
, 
lök_°a
, 
lök_id
) {

5697 
mvm_lök_°a
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm°a
->
lök
[
lök_id
],

5698 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

5699 i‡(!
mvm_lök_°a
)

5702 i‡(
	`iwl_mvm_Êush_°a
(
mvm
, 
mvm_lök_°a
->
°a_id
,

5703 
mvm°a
->
tfd_queue_msk
))

5704 
	`IWL_ERR
(
mvm
, "flushÑequest fail\n");

5706 
	`muãx_u∆ock
(&
mvm
->
muãx
);

5707 
	}
}

5709 
	$iwl_mvm_mac_gë_survey
(
õì80211_hw
 *
hw
, 
idx
,

5710 
survey_öfo
 *
survey
)

5712 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

5713 
ªt
 = 0;

5714 
u8
 
cmd_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
,

5715 
	`WIDE_ID
(
SYSTEM_GROUP
,

5716 
SYSTEM_STATISTICS_CMD
),

5717 
IWL_FW_CMD_VER_UNKNOWN
);

5719 
	`mem£t
(
survey
, 0, (*survey));

5722 i‡(
idx
 != 0)

5723  -
ENOENT
;

5725 i‡(!
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

5726 
IWL_UCODE_TLV_CAPA_RADIO_BEACON_STATS
))

5727  -
ENOENT
;

5729 
	`muãx_lock
(&
mvm
->
muãx
);

5731 i‡(
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
)) {

5732 
ªt
 = 
	`iwl_mvm_ªque°_°©i°ics
(
mvm
, 
Ál£
);

5733 i‡(
ªt
)

5734 
out
;

5737 
survey
->
fûÀd
 = 
SURVEY_INFO_TIME_RX
 |

5738 
SURVEY_INFO_TIME_TX
;

5740 
survey
->
time_rx
 = 
mvm
->
accu_ødio_°©s
.
rx_time
 +

5741 
mvm
->
ødio_°©s
.
rx_time
;

5742 
	`do_div
(
survey
->
time_rx
, 
USEC_PER_MSEC
);

5744 
survey
->
time_tx
 = 
mvm
->
accu_ødio_°©s
.
tx_time
 +

5745 
mvm
->
ødio_°©s
.
tx_time
;

5746 
	`do_div
(
survey
->
time_tx
, 
USEC_PER_MSEC
);

5749 i‡(
cmd_vî
 !
IWL_FW_CMD_VER_UNKNOWN
)

5750 
out
;

5752 
survey
->
fûÀd
 |
SURVEY_INFO_TIME
 |

5753 
SURVEY_INFO_TIME_SCAN
;

5754 
survey
->
time
 = 
mvm
->
accu_ødio_°©s
.
⁄_time_rf
 +

5755 
mvm
->
ødio_°©s
.
⁄_time_rf
;

5756 
	`do_div
(
survey
->
time
, 
USEC_PER_MSEC
);

5758 
survey
->
time_sˇn
 = 
mvm
->
accu_ødio_°©s
.
⁄_time_sˇn
 +

5759 
mvm
->
ødio_°©s
.
⁄_time_sˇn
;

5760 
	`do_div
(
survey
->
time_sˇn
, 
USEC_PER_MSEC
);

5762 
out
:

5763 
	`muãx_u∆ock
(&
mvm
->
muãx
);

5764  
ªt
;

5765 
	}
}

5767 
	$iwl_mvm_£t_°a_øã
(
u32
 
øã_n_Êags
, 
øã_öfo
 *
röfo
)

5769 
u32
 
f‹m©
 = 
øã_n_Êags
 & 
RATE_MCS_MOD_TYPE_MSK
;

5770 
u32
 
gi_…f
;

5772 
øã_n_Êags
 & 
RATE_MCS_CHAN_WIDTH_MSK
) {

5773 
RATE_MCS_CHAN_WIDTH_20
:

5774 
röfo
->
bw
 = 
RATE_INFO_BW_20
;

5776 
RATE_MCS_CHAN_WIDTH_40
:

5777 
röfo
->
bw
 = 
RATE_INFO_BW_40
;

5779 
RATE_MCS_CHAN_WIDTH_80
:

5780 
röfo
->
bw
 = 
RATE_INFO_BW_80
;

5782 
RATE_MCS_CHAN_WIDTH_160
:

5783 
röfo
->
bw
 = 
RATE_INFO_BW_160
;

5785 
RATE_MCS_CHAN_WIDTH_320
:

5786 
röfo
->
bw
 = 
RATE_INFO_BW_320
;

5790 i‡(
f‹m©
 =
RATE_MCS_CCK_MSK
 ||

5791 
f‹m©
 =
RATE_MCS_LEGACY_OFDM_MSK
) {

5792 
øã
 = 
	`u32_gë_bôs
(
øã_n_Êags
, 
RATE_LEGACY_RATE_MSK
);

5795 i‡(
f‹m©
 =
RATE_MCS_LEGACY_OFDM_MSK
)

5796 
øã
 +
IWL_FIRST_OFDM_RATE
;

5798 
øã
) {

5799 
IWL_RATE_1M_INDEX
:

5800 
röfo
->
Àgacy
 = 10;

5802 
IWL_RATE_2M_INDEX
:

5803 
röfo
->
Àgacy
 = 20;

5805 
IWL_RATE_5M_INDEX
:

5806 
röfo
->
Àgacy
 = 55;

5808 
IWL_RATE_11M_INDEX
:

5809 
röfo
->
Àgacy
 = 110;

5811 
IWL_RATE_6M_INDEX
:

5812 
röfo
->
Àgacy
 = 60;

5814 
IWL_RATE_9M_INDEX
:

5815 
röfo
->
Àgacy
 = 90;

5817 
IWL_RATE_12M_INDEX
:

5818 
röfo
->
Àgacy
 = 120;

5820 
IWL_RATE_18M_INDEX
:

5821 
röfo
->
Àgacy
 = 180;

5823 
IWL_RATE_24M_INDEX
:

5824 
röfo
->
Àgacy
 = 240;

5826 
IWL_RATE_36M_INDEX
:

5827 
röfo
->
Àgacy
 = 360;

5829 
IWL_RATE_48M_INDEX
:

5830 
röfo
->
Àgacy
 = 480;

5832 
IWL_RATE_54M_INDEX
:

5833 
röfo
->
Àgacy
 = 540;

5838 
röfo
->
nss
 = 
	`u32_gë_bôs
(
øã_n_Êags
,

5839 
RATE_MCS_NSS_MSK
) + 1;

5840 
röfo
->
mcs
 = 
f‹m©
 =
RATE_MCS_HT_MSK
 ?

5841 
	`RATE_HT_MCS_INDEX
(
øã_n_Êags
) :

5842 
	`u32_gë_bôs
(
øã_n_Êags
, 
RATE_MCS_CODE_MSK
);

5844 i‡(
øã_n_Êags
 & 
RATE_MCS_SGI_MSK
)

5845 
röfo
->
Êags
 |
RATE_INFO_FLAGS_SHORT_GI
;

5847 
f‹m©
) {

5848 
RATE_MCS_EHT_MSK
:

5850 
röfo
->
Êags
 |
RATE_INFO_FLAGS_EHT_MCS
;

5852 
RATE_MCS_HE_MSK
:

5853 
gi_…f
 = 
	`u32_gë_bôs
(
øã_n_Êags
, 
RATE_MCS_HE_GI_LTF_MSK
);

5855 
röfo
->
Êags
 |
RATE_INFO_FLAGS_HE_MCS
;

5857 i‡(
øã_n_Êags
 & 
RATE_MCS_HE_106T_MSK
) {

5858 
röfo
->
bw
 = 
RATE_INFO_BW_HE_RU
;

5859 
röfo
->
he_ru_Æloc
 = 
NL80211_RATE_INFO_HE_RU_ALLOC_106
;

5862 
øã_n_Êags
 & 
RATE_MCS_HE_TYPE_MSK
) {

5863 
RATE_MCS_HE_TYPE_SU
:

5864 
RATE_MCS_HE_TYPE_EXT_SU
:

5865 i‡(
gi_…f
 == 0 || gi_ltf == 1)

5866 
röfo
->
he_gi
 = 
NL80211_RATE_INFO_HE_GI_0_8
;

5867 i‡(
gi_…f
 == 2)

5868 
röfo
->
he_gi
 = 
NL80211_RATE_INFO_HE_GI_1_6
;

5869 i‡(
gi_…f
 == 3)

5870 
röfo
->
he_gi
 = 
NL80211_RATE_INFO_HE_GI_3_2
;

5872 
röfo
->
he_gi
 = 
NL80211_RATE_INFO_HE_GI_0_8
;

5874 
RATE_MCS_HE_TYPE_MU
:

5875 i‡(
gi_…f
 == 0 || gi_ltf == 1)

5876 
röfo
->
he_gi
 = 
NL80211_RATE_INFO_HE_GI_0_8
;

5877 i‡(
gi_…f
 == 2)

5878 
röfo
->
he_gi
 = 
NL80211_RATE_INFO_HE_GI_1_6
;

5880 
röfo
->
he_gi
 = 
NL80211_RATE_INFO_HE_GI_3_2
;

5882 
RATE_MCS_HE_TYPE_TRIG
:

5883 i‡(
gi_…f
 == 0 || gi_ltf == 1)

5884 
röfo
->
he_gi
 = 
NL80211_RATE_INFO_HE_GI_1_6
;

5886 
röfo
->
he_gi
 = 
NL80211_RATE_INFO_HE_GI_3_2
;

5890 i‡(
øã_n_Êags
 & 
RATE_HE_DUAL_CARRIER_MODE_MSK
)

5891 
röfo
->
he_dcm
 = 1;

5893 
RATE_MCS_HT_MSK
:

5894 
röfo
->
Êags
 |
RATE_INFO_FLAGS_MCS
;

5896 
RATE_MCS_VHT_MSK
:

5897 
röfo
->
Êags
 |
RATE_INFO_FLAGS_VHT_MCS
;

5900 
	}
}

5902 
	$iwl_mvm_mac_°a_°©i°ics
(
õì80211_hw
 *
hw
,

5903 
õì80211_vif
 *
vif
,

5904 
õì80211_°a
 *
°a
,

5905 
°©i⁄_öfo
 *
söfo
)

5907 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

5908 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

5909 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

5910 
i
;

5912 i‡(
mvm°a
->
deÊök
.
avg_íîgy
) {

5913 
söfo
->
sig«l_avg
 = -(
s8
)
mvm°a
->
deÊök
.
avg_íîgy
;

5914 
söfo
->
fûÀd
 |
	`BIT_ULL
(
NL80211_STA_INFO_SIGNAL_AVG
);

5917 i‡(
	`iwl_mvm_has_éc_ofÊﬂd
(
mvm
)) {

5918 
iwl_lq_°a_rs_fw
 *
lq_°a
 = &
mvm°a
->
deÊök
.lq_°a.
rs_fw
;

5920 
	`iwl_mvm_£t_°a_øã
(
lq_°a
->
œ°_øã_n_Êags
, &
söfo
->
txøã
);

5921 
söfo
->
fûÀd
 |
	`BIT_ULL
(
NL80211_STA_INFO_TX_BITRATE
);

5925 i‡(!(
vif
->
drivî_Êags
 & 
IEEE80211_VIF_BEACON_FILTER
))

5928 i‡(!
vif
->
cfg
.
assoc
)

5931 
	`muãx_lock
(&
mvm
->
muãx
);

5933 i‡(
mvmvif
->
deÊök
.
≠_°a_id
 !
mvm°a
->deÊök.
°a_id
)

5934 
u∆ock
;

5936 i‡(
	`iwl_mvm_ªque°_°©i°ics
(
mvm
, 
Ál£
))

5937 
u∆ock
;

5939 
söfo
->
rx_bóc⁄
 = 0;

5940 
	`f‹_óch_mvm_vif_vÆid_lök
(
mvmvif
, 
i
)

5941 
söfo
->
rx_bóc⁄
 +
mvmvif
->
lök
[
i
]->
bóc⁄_°©s
.
num_bóc⁄s
 +

5942 
mvmvif
->
lök
[
i
]->
bóc⁄_°©s
.
accu_num_bóc⁄s
;

5944 
söfo
->
fûÀd
 |
	`BIT_ULL
(
NL80211_STA_INFO_BEACON_RX
);

5945 i‡(
mvmvif
->
deÊök
.
bóc⁄_°©s
.
avg_sig«l
) {

5947 
söfo
->
rx_bóc⁄_sig«l_avg
 =

5948 
mvmvif
->
deÊök
.
bóc⁄_°©s
.
avg_sig«l
;

5949 
söfo
->
fûÀd
 |
	`BIT_ULL
(
NL80211_STA_INFO_BEACON_SIGNAL_AVG
);

5951 
u∆ock
:

5952 
	`muãx_u∆ock
(&
mvm
->
muãx
);

5953 
	}
}

5955 
	$iwl_mvm_evít_mlme_ˇŒback_öi
(
iwl_mvm
 *
mvm
,

5956 
õì80211_vif
 *
vif
,

5957 c⁄° 
õì80211_mlme_evít
 *
mlme
)

5959 i‡((
mlme
->
d©a
 =
ASSOC_EVENT
 || mlme->d©®=
AUTH_EVENT
) &&

5960 (
mlme
->
°©us
 =
MLME_DENIED
 || mlme->°©u†=
MLME_TIMEOUT
)) {

5961 
	`iwl_dbg_év_time_poöt
(&
mvm
->
fwπ
,

5962 
IWL_FW_INI_TIME_POINT_ASSOC_FAILED
,

5963 
NULL
);

5967 i‡(
mlme
->
d©a
 =
DEAUTH_RX_EVENT
 || mlme->d©®=
DEAUTH_TX_EVENT
) {

5968 
	`iwl_dbg_év_time_poöt
(&
mvm
->
fwπ
,

5969 
IWL_FW_INI_TIME_POINT_DEASSOC
,

5970 
NULL
);

5973 
	}
}

5975 
	$iwl_mvm_evít_mlme_ˇŒback
(
iwl_mvm
 *
mvm
,

5976 
õì80211_vif
 *
vif
,

5977 c⁄° 
õì80211_evít
 *
evít
)

5979 
	#CHECK_MLME_TRIGGER
(
_˙t
, 
_fmt
...) \

5981 i‡((
åig_mlme
->
_˙t
) && --(trig_mlme->_cnt)) \

5983 
	`iwl_fw_dbg_cﬁÀ˘_åig
(&(
mvm
)->
fwπ
, 
åig
, 
_fmt
); \

5984 } 0)

	)

5986 
iwl_fw_dbg_åiggî_év
 *
åig
;

5987 
iwl_fw_dbg_åiggî_mlme
 *
åig_mlme
;

5989 i‡(
	`iwl_å™s_dbg_öi_vÆid
(
mvm
->
å™s
)) {

5990 
	`iwl_mvm_evít_mlme_ˇŒback_öi
(
mvm
, 
vif
, &
evít
->
u
.
mlme
);

5994 
åig
 = 
	`iwl_fw_dbg_åiggî_⁄
(&
mvm
->
fwπ
, 
	`õì80211_vif_to_wdev
(
vif
),

5995 
FW_DBG_TRIGGER_MLME
);

5996 i‡(!
åig
)

5999 
åig_mlme
 = (*)
åig
->
d©a
;

6001 i‡(
evít
->
u
.
mlme
.
d©a
 =
ASSOC_EVENT
) {

6002 i‡(
evít
->
u
.
mlme
.
°©us
 =
MLME_DENIED
)

6003 
	`CHECK_MLME_TRIGGER
(
°›_assoc_díõd
,

6005 
evít
->
u
.
mlme
.
ªas⁄
);

6006 i‡(
evít
->
u
.
mlme
.
°©us
 =
MLME_TIMEOUT
)

6007 
	`CHECK_MLME_TRIGGER
(
°›_assoc_timeout
,

6009 } i‡(
evít
->
u
.
mlme
.
d©a
 =
AUTH_EVENT
) {

6010 i‡(
evít
->
u
.
mlme
.
°©us
 =
MLME_DENIED
)

6011 
	`CHECK_MLME_TRIGGER
(
°›_auth_díõd
,

6013 
evít
->
u
.
mlme
.
ªas⁄
);

6014 i‡(
evít
->
u
.
mlme
.
°©us
 =
MLME_TIMEOUT
)

6015 
	`CHECK_MLME_TRIGGER
(
°›_auth_timeout
,

6017 } i‡(
evít
->
u
.
mlme
.
d©a
 =
DEAUTH_RX_EVENT
) {

6018 
	`CHECK_MLME_TRIGGER
(
°›_rx_dóuth
,

6019 "DEAUTH RX %d", 
evít
->
u
.
mlme
.
ªas⁄
);

6020 } i‡(
evít
->
u
.
mlme
.
d©a
 =
DEAUTH_TX_EVENT
) {

6021 
	`CHECK_MLME_TRIGGER
(
°›_tx_dóuth
,

6022 "DEAUTH TX %d", 
evít
->
u
.
mlme
.
ªas⁄
);

6024 #unde‡
CHECK_MLME_TRIGGER


6025 
	}
}

6027 
	$iwl_mvm_evít_b¨_rx_ˇŒback
(
iwl_mvm
 *
mvm
,

6028 
õì80211_vif
 *
vif
,

6029 c⁄° 
õì80211_evít
 *
evít
)

6031 
iwl_fw_dbg_åiggî_év
 *
åig
;

6032 
iwl_fw_dbg_åiggî_ba
 *
ba_åig
;

6034 
åig
 = 
	`iwl_fw_dbg_åiggî_⁄
(&
mvm
->
fwπ
, 
	`õì80211_vif_to_wdev
(
vif
),

6035 
FW_DBG_TRIGGER_BA
);

6036 i‡(!
åig
)

6039 
ba_åig
 = (*)
åig
->
d©a
;

6041 i‡(!(
	`À16_to_˝u
(
ba_åig
->
rx_b¨
Ë& 
	`BIT
(
evít
->
u
.
ba
.
tid
)))

6044 
	`iwl_fw_dbg_cﬁÀ˘_åig
(&
mvm
->
fwπ
, 
åig
,

6046 
evít
->
u
.
ba
.
°a
->
addr
,Évít->u.ba.
tid
,

6047 
evít
->
u
.
ba
.
s¢
);

6048 
	}
}

6050 
	$iwl_mvm_mac_evít_ˇŒback
(
õì80211_hw
 *
hw
,

6051 
õì80211_vif
 *
vif
,

6052 c⁄° 
õì80211_evít
 *
evít
)

6054 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

6056 
evít
->
ty≥
) {

6057 
MLME_EVENT
:

6058 
	`iwl_mvm_evít_mlme_ˇŒback
(
mvm
, 
vif
, 
evít
);

6060 
BAR_RX_EVENT
:

6061 
	`iwl_mvm_evít_b¨_rx_ˇŒback
(
mvm
, 
vif
, 
evít
);

6063 
BA_FRAME_TIMEOUT
:

6064 
	`iwl_mvm_evít_‰ame_timeout_ˇŒback
(
mvm
, 
vif
, 
evít
->
u
.
ba
.
°a
,

6065 
evít
->
u
.
ba
.
tid
);

6070 
	}
}

6072 
	#SYNC_RX_QUEUE_TIMEOUT
 (
HZ
)

	)

6073 
	$iwl_mvm_sync_rx_queues_öã∫Æ
(
iwl_mvm
 *
mvm
,

6074 
iwl_mvm_rxq_nŸif_ty≥
 
ty≥
,

6075 
boﬁ
 
sync
,

6076 c⁄° *
d©a
, 
u32
 
size
)

6079 
iwl_rxq_sync_cmd
 
cmd
;

6080 
iwl_mvm_öã∫Æ_rxq_nŸif
 
nŸif
;

6081 } 
__∑cked
 
cmd
 = {

6082 .
cmd
.
rxq_mask
 = 
	`˝u_to_À32
(
	`BIT
(
mvm
->
å™s
->
num_rx_queues
) - 1),

6083 .
cmd
.
cou¡
 =

6084 
	`˝u_to_À32
((
iwl_mvm_öã∫Æ_rxq_nŸif
) +

6085 
size
),

6086 .
nŸif
.
ty≥
 =Åype,

6087 .
nŸif
.
sync
 = sync,

6089 
iwl_ho°_cmd
 
hcmd
 = {

6090 .
id
 = 
	`WIDE_ID
(
DATA_PATH_GROUP
, 
TRIGGER_RX_QUEUES_NOTIF_CMD
),

6091 .
d©a
[0] = &
cmd
,

6092 .
Àn
[0] = (
cmd
),

6093 .
d©a
[1] = data,

6094 .
Àn
[1] = 
size
,

6095 .
Êags
 = 
sync
 ? 0 : 
CMD_ASYNC
,

6097 
ªt
;

6100 i‡(
	`WARN_ON
(
cmd
.cmd.
cou¡
 & 
	`˝u_to_À32
(3)))

6103 i‡(!
	`iwl_mvm_has_√w_rx_≠i
(
mvm
))

6106 i‡(
sync
) {

6107 
cmd
.
nŸif
.
cookõ
 = 
mvm
->
queue_sync_cookõ
;

6108 
mvm
->
queue_sync_°©e
 = (1 << mvm->
å™s
->
num_rx_queues
) - 1;

6111 
ªt
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
hcmd
);

6112 i‡(
ªt
) {

6113 
	`IWL_ERR
(
mvm
, "FaûedÅÿåiggî RX queue†syn¯(%d)\n", 
ªt
);

6114 
out
;

6117 i‡(
sync
) {

6118 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

6119 
ªt
 = 
	`waô_evít_timeout
(
mvm
->
rx_sync_waôq
,

6120 
	`READ_ONCE
(
mvm
->
queue_sync_°©e
) == 0 ||

6121 
	`iwl_mvm_is_ødio_hw_kûÀd
(
mvm
),

6122 
SYNC_RX_QUEUE_TIMEOUT
);

6123 
	`WARN_ONCE
(!
ªt
 && !
	`iwl_mvm_is_ødio_hw_kûÀd
(
mvm
),

6125 
mvm
->
queue_sync_°©e
,

6126 
mvm
->
queue_sync_cookõ
);

6129 
out
:

6130 i‡(
sync
) {

6131 
mvm
->
queue_sync_°©e
 = 0;

6132 
mvm
->
queue_sync_cookõ
++;

6134 
	}
}

6136 
	$iwl_mvm_sync_rx_queues
(
õì80211_hw
 *
hw
)

6138 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

6140 
	`muãx_lock
(&
mvm
->
muãx
);

6141 
	`iwl_mvm_sync_rx_queues_öã∫Æ
(
mvm
, 
IWL_MVM_RXQ_EMPTY
, 
åue
, 
NULL
, 0);

6142 
	`muãx_u∆ock
(&
mvm
->
muãx
);

6143 
	}
}

6146 
	$iwl_mvm_mac_gë_·m_ª•⁄dî_°©s
(
õì80211_hw
 *
hw
,

6147 
õì80211_vif
 *
vif
,

6148 
cfg80211_·m_ª•⁄dî_°©s
 *
°©s
)

6150 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

6151 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

6153 i‡(
vif
->
p2p
 || vif->
ty≥
 !
NL80211_IFTYPE_AP
 ||

6154 !
mvmvif
->
≠_ibss_a˘ive
 || !
vif
->
bss_c⁄f
.
·m_ª•⁄dî
)

6155  -
EINVAL
;

6157 
	`muãx_lock
(&
mvm
->
muãx
);

6158 *
°©s
 = 
mvm
->
·m_ª•_°©s
;

6159 
	`muãx_u∆ock
(&
mvm
->
muãx
);

6161 
°©s
->
fûÀd
 = 
	`BIT
(
NL80211_FTM_STATS_SUCCESS_NUM
) |

6162 
	`BIT
(
NL80211_FTM_STATS_PARTIAL_NUM
) |

6163 
	`BIT
(
NL80211_FTM_STATS_FAILED_NUM
) |

6164 
	`BIT
(
NL80211_FTM_STATS_ASAP_NUM
) |

6165 
	`BIT
(
NL80211_FTM_STATS_NON_ASAP_NUM
) |

6166 
	`BIT
(
NL80211_FTM_STATS_TOTAL_DURATION_MSEC
) |

6167 
	`BIT
(
NL80211_FTM_STATS_UNKNOWN_TRIGGERS_NUM
) |

6168 
	`BIT
(
NL80211_FTM_STATS_RESCHEDULE_REQUESTS_NUM
) |

6169 
	`BIT
(
NL80211_FTM_STATS_OUT_OF_WINDOW_TRIGGERS_NUM
);

6172 
	}
}

6174 
	$iwl_mvm_°¨t_pm§
(
õì80211_hw
 *
hw
, 
õì80211_vif
 *
vif
,

6175 
cfg80211_pm§_ªque°
 *
ªque°
)

6177 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

6178 
ªt
;

6180 
	`muãx_lock
(&
mvm
->
muãx
);

6181 
ªt
 = 
	`iwl_mvm_·m_°¨t
(
mvm
, 
vif
, 
ªque°
);

6182 
	`muãx_u∆ock
(&
mvm
->
muãx
);

6184  
ªt
;

6185 
	}
}

6187 
	$iwl_mvm_ab‹t_pm§
(
õì80211_hw
 *
hw
, 
õì80211_vif
 *
vif
,

6188 
cfg80211_pm§_ªque°
 *
ªque°
)

6190 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

6192 
	`muãx_lock
(&
mvm
->
muãx
);

6193 
	`iwl_mvm_·m_ab‹t
(
mvm
, 
ªque°
);

6194 
	`muãx_u∆ock
(&
mvm
->
muãx
);

6195 
	}
}

6197 
boﬁ
 
	$iwl_mvm_ˇn_hw_csum
(
sk_buff
 *
skb
)

6199 
u8
 
¥Ÿocﬁ
 = 
	`ù_hdr
(
skb
)->protocol;

6201 i‡(!
	`IS_ENABLED
(
CONFIG_INET
))

6202  
Ál£
;

6204  
¥Ÿocﬁ
 =
IPPROTO_TCP
 ||ÖrŸocﬁ =
IPPROTO_UDP
;

6205 
	}
}

6207 
boﬁ
 
	$iwl_mvm_mac_ˇn_aggªg©e
(
õì80211_hw
 *
hw
,

6208 
sk_buff
 *
hód
,

6209 
sk_buff
 *
skb
)

6211 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

6214 i‡(
skb
->
¥Ÿocﬁ
 !
	`ht⁄s
(
ETH_P_IP
))

6215  
Ál£
;

6217 i‡(!
	`iwl_mvm_is_csum_suµ‹ãd
(
mvm
))

6218  
åue
;

6220  
	`iwl_mvm_ˇn_hw_csum
(
skb
Ë=iwl_mvm_ˇn_hw_csum(
hód
);

6221 
	}
}

6223 
	$iwl_mvm_£t_hw_time°amp
(
õì80211_hw
 *
hw
,

6224 
õì80211_vif
 *
vif
,

6225 
cfg80211_£t_hw_time°amp
 *
hwts
)

6227 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

6228 
u32
 
¥Ÿocﬁs
 = 0;

6229 
ªt
;

6232 i‡(!
hwts
->
maˇddr
)

6233  -
EOPNOTSUPP
;

6235 i‡(
hwts
->
íabÀ
)

6236 
¥Ÿocﬁs
 =

6237 
IWL_TIME_SYNC_PROTOCOL_TM
 | 
IWL_TIME_SYNC_PROTOCOL_FTM
;

6239 
	`muãx_lock
(&
mvm
->
muãx
);

6240 
ªt
 = 
	`iwl_mvm_time_sync_c⁄fig
(
mvm
, 
hwts
->
maˇddr
, 
¥Ÿocﬁs
);

6241 
	`muãx_u∆ock
(&
mvm
->
muãx
);

6243  
ªt
;

6244 
	}
}

6246 c⁄° 
õì80211_›s
 
	giwl_mvm_hw_›s
 = {

6247 .
tx
 = 
iwl_mvm_mac_tx
,

6248 .
	gwake_tx_queue
 = 
iwl_mvm_mac_wake_tx_queue
,

6249 .
	gampdu_a˘i⁄
 = 
iwl_mvm_mac_ampdu_a˘i⁄
,

6250 .
	ggë_™ã¬a
 = 
iwl_mvm_›_gë_™ã¬a
,

6251 .
	g£t_™ã¬a
 = 
iwl_mvm_›_£t_™ã¬a
,

6252 .
	g°¨t
 = 
iwl_mvm_mac_°¨t
,

6253 .
	gªc⁄fig_com∂ëe
 = 
iwl_mvm_mac_ªc⁄fig_com∂ëe
,

6254 .
	g°›
 = 
iwl_mvm_mac_°›
,

6255 .
	gadd_öãrÁ˚
 = 
iwl_mvm_mac_add_öãrÁ˚
,

6256 .
	gªmove_öãrÁ˚
 = 
iwl_mvm_mac_ªmove_öãrÁ˚
,

6257 .
	gc⁄fig
 = 
iwl_mvm_mac_c⁄fig
,

6258 .
	g¥ï¨e_mu…iˇ°
 = 
iwl_mvm_¥ï¨e_mu…iˇ°
,

6259 .
	gc⁄figuª_fûãr
 = 
iwl_mvm_c⁄figuª_fûãr
,

6260 .
	gc⁄fig_iÁ˚_fûãr
 = 
iwl_mvm_c⁄fig_iÁ˚_fûãr
,

6261 .
	gbss_öfo_ch™ged
 = 
iwl_mvm_bss_öfo_ch™ged
,

6262 .
	ghw_sˇn
 = 
iwl_mvm_mac_hw_sˇn
,

6263 .
	gˇn˚l_hw_sˇn
 = 
iwl_mvm_mac_ˇn˚l_hw_sˇn
,

6264 .
	g°a_¥e_rcu_ªmove
 = 
iwl_mvm_°a_¥e_rcu_ªmove
,

6265 .
	g°a_°©e
 = 
iwl_mvm_mac_°a_°©e
,

6266 .
	g°a_nŸify
 = 
iwl_mvm_mac_°a_nŸify
,

6267 .
	gÆlow_buf„ªd_‰ames
 = 
iwl_mvm_mac_Ælow_buf„ªd_‰ames
,

6268 .
	gªÀa£_buf„ªd_‰ames
 = 
iwl_mvm_mac_ªÀa£_buf„ªd_‰ames
,

6269 .
	g£t_πs_thªshﬁd
 = 
iwl_mvm_mac_£t_πs_thªshﬁd
,

6270 .
	g°a_rc_upd©e
 = 
iwl_mvm_°a_rc_upd©e
,

6271 .
	gc⁄f_tx
 = 
iwl_mvm_mac_c⁄f_tx
,

6272 .
	gmgd_¥ï¨e_tx
 = 
iwl_mvm_mac_mgd_¥ï¨e_tx
,

6273 .
	gmgd_com∂ëe_tx
 = 
iwl_mvm_mac_mgd_com∂ëe_tx
,

6274 .
	gmgd_¥Ÿe˘_tdls_discovî
 = 
iwl_mvm_mac_mgd_¥Ÿe˘_tdls_discovî
,

6275 .
	gÊush
 = 
iwl_mvm_mac_Êush
,

6276 .
	gÊush_°a
 = 
iwl_mvm_mac_Êush_°a
,

6277 .
	gsched_sˇn_°¨t
 = 
iwl_mvm_mac_sched_sˇn_°¨t
,

6278 .
	gsched_sˇn_°›
 = 
iwl_mvm_mac_sched_sˇn_°›
,

6279 .
	g£t_key
 = 
iwl_mvm_mac_£t_key
,

6280 .
	gupd©e_tkù_key
 = 
iwl_mvm_mac_upd©e_tkù_key
,

6281 .
	gªmaö_⁄_ch™√l
 = 
iwl_mvm_roc
,

6282 .
	gˇn˚l_ªmaö_⁄_ch™√l
 = 
iwl_mvm_ˇn˚l_roc
,

6283 .
	gadd_ch™˘x
 = 
iwl_mvm_add_ch™˘x
,

6284 .
	gªmove_ch™˘x
 = 
iwl_mvm_ªmove_ch™˘x
,

6285 .
	gch™ge_ch™˘x
 = 
iwl_mvm_ch™ge_ch™˘x
,

6286 .
	gassign_vif_ch™˘x
 = 
iwl_mvm_assign_vif_ch™˘x
,

6287 .
	gu«ssign_vif_ch™˘x
 = 
iwl_mvm_u«ssign_vif_ch™˘x
,

6288 .
	gswôch_vif_ch™˘x
 = 
iwl_mvm_swôch_vif_ch™˘x
,

6290 .
	g°¨t_≠
 = 
iwl_mvm_°¨t_≠
,

6291 .
	g°›_≠
 = 
iwl_mvm_°›_≠
,

6292 .
	gjoö_ibss
 = 
iwl_mvm_°¨t_ibss
,

6293 .
	gÀave_ibss
 = 
iwl_mvm_°›_ibss
,

6295 .
	gtx_œ°_bóc⁄
 = 
iwl_mvm_tx_œ°_bóc⁄
,

6297 .
	g£t_tim
 = 
iwl_mvm_£t_tim
,

6299 .
	gch™√l_swôch
 = 
iwl_mvm_ch™√l_swôch
,

6300 .
	g¥e_ch™√l_swôch
 = 
iwl_mvm_¥e_ch™√l_swôch
,

6301 .
	gpo°_ch™√l_swôch
 = 
iwl_mvm_po°_ch™√l_swôch
,

6302 .
	gab‹t_ch™√l_swôch
 = 
iwl_mvm_ab‹t_ch™√l_swôch
,

6303 .
	gch™√l_swôch_rx_bóc⁄
 = 
iwl_mvm_ch™√l_swôch_rx_bóc⁄
,

6305 .
	gtdls_ch™√l_swôch
 = 
iwl_mvm_tdls_ch™√l_swôch
,

6306 .
	gtdls_ˇn˚l_ch™√l_swôch
 = 
iwl_mvm_tdls_ˇn˚l_ch™√l_swôch
,

6307 .
	gtdls_ªcv_ch™√l_swôch
 = 
iwl_mvm_tdls_ªcv_ch™√l_swôch
,

6309 .
	gevít_ˇŒback
 = 
iwl_mvm_mac_evít_ˇŒback
,

6311 .
	gsync_rx_queues
 = 
iwl_mvm_sync_rx_queues
,

6313 
CFG80211_TESTMODE_CMD
(
iwl_mvm_mac_ã°mode_cmd
)

6315 #ifde‡
CONFIG_PM_SLEEP


6317 .
	gsu•íd
 = 
iwl_mvm_su•íd
,

6318 .
	gªsume
 = 
iwl_mvm_ªsume
,

6319 .
	g£t_wakeup
 = 
iwl_mvm_£t_wakeup
,

6320 .
	g£t_ªkey_d©a
 = 
iwl_mvm_£t_ªkey_d©a
,

6321 #i‡
IS_ENABLED
(
CONFIG_IPV6
)

6322 .
	gùv6_addr_ch™ge
 = 
iwl_mvm_ùv6_addr_ch™ge
,

6324 .
	g£t_deÁu…_uniˇ°_key
 = 
iwl_mvm_£t_deÁu…_uniˇ°_key
,

6326 .
	ggë_survey
 = 
iwl_mvm_mac_gë_survey
,

6327 .
	g°a_°©i°ics
 = 
iwl_mvm_mac_°a_°©i°ics
,

6328 .
	ggë_·m_ª•⁄dî_°©s
 = 
iwl_mvm_mac_gë_·m_ª•⁄dî_°©s
,

6329 .
	g°¨t_pm§
 = 
iwl_mvm_°¨t_pm§
,

6330 .
	gab‹t_pm§
 = 
iwl_mvm_ab‹t_pm§
,

6332 .
	gˇn_aggªg©e_ö_amsdu
 = 
iwl_mvm_mac_ˇn_aggªg©e
,

6333 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


6334 .
	gvif_add_debugfs
 = 
iwl_mvm_vif_add_debugfs
,

6335 .
	glök_°a_add_debugfs
 = 
iwl_mvm_lök_°a_add_debugfs
,

6337 .
	g£t_hw_time°amp
 = 
iwl_mvm_£t_hw_time°amp
,

	@mld-key.c

5 
	~<löux/kî√l.h
>

6 
	~<√t/mac80211.h
>

7 
	~"mvm.h
"

8 
	~"fw/≠i/c⁄ãxt.h
"

9 
	~"fw/≠i/d©≠©h.h
"

11 
u32
 
	$iwl_mvm_gë_£c_°a_mask
(
iwl_mvm
 *
mvm
,

12 
õì80211_vif
 *
vif
,

13 
õì80211_°a
 *
°a
,

14 
õì80211_key_c⁄f
 *
keyc⁄f
)

16 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

17 
iwl_mvm_vif_lök_öfo
 *
lök_öfo
 = &
mvmvif
->
deÊök
;

19 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

21 i‡(
keyc⁄f
->
lök_id
 >= 0) {

22 
lök_öfo
 = 
mvmvif
->
lök
[
keyc⁄f
->
lök_id
];

23 i‡(!
lök_öfo
)

28 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
 &&

29 !(
keyc⁄f
->
Êags
 & 
IEEE80211_KEY_FLAG_PAIRWISE
)) {

31 i‡(
keyc⁄f
->
keyidx
 >= 4)

32  
	`BIT
(
lök_öfo
->
bˇ°_°a
.
°a_id
);

34  
	`BIT
(
lök_öfo
->
mˇ°_°a
.
°a_id
);

38 i‡(!
°a
 && 
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
)

39 
°a
 = 
mvmvif
->
≠_°a
;

50 i‡(!
°a
 && (
keyc⁄f
->
lök_id
 >0 || !
	`õì80211_vif_is_mld
(
vif
)))

51  
	`BIT
(
lök_öfo
->
≠_°a_id
);

56  
	`iwl_mvm_°a_fw_id_mask
(
mvm
, 
°a
, 
keyc⁄f
->
lök_id
);

57 
	}
}

59 
u32
 
	$iwl_mvm_gë_£c_Êags
(
iwl_mvm
 *
mvm
,

60 
õì80211_vif
 *
vif
,

61 
õì80211_°a
 *
°a
,

62 
õì80211_key_c⁄f
 *
keyc⁄f
)

64 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

65 
boﬁ
 
∑úwi£
 = 
keyc⁄f
->
Êags
 & 
IEEE80211_KEY_FLAG_PAIRWISE
;

66 
boﬁ
 
igtk
 = 
keyc⁄f
->
keyidx
 == 4 || keyconf->keyidx == 5;

67 
u32
 
Êags
 = 0;

69 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

71 i‡(!
∑úwi£
)

72 
Êags
 |
IWL_SEC_KEY_FLAG_MCAST_KEY
;

74 
keyc⁄f
->
cùhî
) {

75 
WLAN_CIPHER_SUITE_WEP104
:

76 
Êags
 |
IWL_SEC_KEY_FLAG_KEY_SIZE
;

77 
ÁŒthrough
;

78 
WLAN_CIPHER_SUITE_WEP40
:

79 
Êags
 |
IWL_SEC_KEY_FLAG_CIPHER_WEP
;

81 
WLAN_CIPHER_SUITE_TKIP
:

82 
Êags
 |
IWL_SEC_KEY_FLAG_CIPHER_TKIP
;

84 
WLAN_CIPHER_SUITE_AES_CMAC
:

85 
WLAN_CIPHER_SUITE_CCMP
:

86 
Êags
 |
IWL_SEC_KEY_FLAG_CIPHER_CCMP
;

88 
WLAN_CIPHER_SUITE_GCMP_256
:

89 
WLAN_CIPHER_SUITE_BIP_GMAC_256
:

90 
Êags
 |
IWL_SEC_KEY_FLAG_KEY_SIZE
;

91 
ÁŒthrough
;

92 
WLAN_CIPHER_SUITE_GCMP
:

93 
WLAN_CIPHER_SUITE_BIP_GMAC_128
:

94 
Êags
 |
IWL_SEC_KEY_FLAG_CIPHER_GCMP
;

98 i‡(!
°a
 && 
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
)

99 
°a
 = 
mvmvif
->
≠_°a
;

108 i‡((!
	`IS_ERR_OR_NULL
(
°a
Ë&& sè->
mÂ
 && 
∑úwi£
Ë|| 
igtk
)

109 
Êags
 |
IWL_SEC_KEY_FLAG_MFP
;

111 i‡(
keyc⁄f
->
Êags
 & 
IEEE80211_KEY_FLAG_SPP_AMSDU
)

112 
Êags
 |
IWL_SEC_KEY_FLAG_SPP_AMSDU
;

114  
Êags
;

115 
	}
}

117 
	siwl_mvm_°a_key_upd©e_d©a
 {

118 
õì80211_°a
 *
	m°a
;

119 
u32
 
	mﬁd_°a_mask
;

120 
u32
 
	m√w_°a_mask
;

121 
	mîr
;

124 
	$iwl_mvm_mld_upd©e_°a_key
(
õì80211_hw
 *
hw
,

125 
õì80211_vif
 *
vif
,

126 
õì80211_°a
 *
°a
,

127 
õì80211_key_c⁄f
 *
key
,

128 *
_d©a
)

130 
u32
 
cmd_id
 = 
	`WIDE_ID
(
DATA_PATH_GROUP
, 
SEC_KEY_CMD
);

131 
iwl_mvm_°a_key_upd©e_d©a
 *
d©a
 = 
_d©a
;

132 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

133 
iwl_£c_key_cmd
 
cmd
 = {

134 .
a˘i⁄
 = 
	`˝u_to_À32
(
FW_CTXT_ACTION_MODIFY
),

135 .
u
.
modify
.
ﬁd_°a_mask
 = 
	`˝u_to_À32
(
d©a
->old_sta_mask),

136 .
u
.
modify
.
√w_°a_mask
 = 
	`˝u_to_À32
(
d©a
->new_sta_mask),

137 .
u
.
modify
.
key_id
 = 
	`˝u_to_À32
(
key
->
keyidx
),

138 .
u
.
modify
.
key_Êags
 =

139 
	`˝u_to_À32
(
	`iwl_mvm_gë_£c_Êags
(
mvm
, 
vif
, 
°a
, 
key
)),

141 
îr
;

144 i‡(
°a
 !
d©a
->°®|| 
key
->
lök_id
 >= 0)

147 
îr
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
cmd_id
, 
CMD_ASYNC
, (
cmd
), &cmd);

149 i‡(
îr
)

150 
d©a
->
îr
 =Érr;

151 
	}
}

153 
	$iwl_mvm_mld_upd©e_°a_keys
(
iwl_mvm
 *
mvm
,

154 
õì80211_vif
 *
vif
,

155 
õì80211_°a
 *
°a
,

156 
u32
 
ﬁd_°a_mask
,

157 
u32
 
√w_°a_mask
)

159 
iwl_mvm_°a_key_upd©e_d©a
 
d©a
 = {

160 .
°a
 = sta,

161 .
ﬁd_°a_mask
 = old_sta_mask,

162 .
√w_°a_mask
 =Çew_sta_mask,

165 
	`õì80211_ôî_keys_rcu
(
mvm
->
hw
, 
vif
, 
iwl_mvm_mld_upd©e_°a_key
,

166 &
d©a
);

167  
d©a
.
îr
;

168 
	}
}

170 
	$__iwl_mvm_£c_key_dñ
(
iwl_mvm
 *
mvm
, 
u32
 
°a_mask
,

171 
u32
 
key_Êags
, u32 
keyidx
, u32 
Êags
)

173 
u32
 
cmd_id
 = 
	`WIDE_ID
(
DATA_PATH_GROUP
, 
SEC_KEY_CMD
);

174 
iwl_£c_key_cmd
 
cmd
 = {

175 .
a˘i⁄
 = 
	`˝u_to_À32
(
FW_CTXT_ACTION_REMOVE
),

176 .
u
.
ªmove
.
°a_mask
 = 
	`˝u_to_À32
(sta_mask),

177 .
u
.
ªmove
.
key_id
 = 
	`˝u_to_À32
(
keyidx
),

178 .
u
.
ªmove
.
key_Êags
 = 
	`˝u_to_À32
(key_flags),

181  
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
cmd_id
, 
Êags
, (
cmd
), &cmd);

182 
	}
}

184 
	$iwl_mvm_mld_£nd_key
(
iwl_mvm
 *
mvm
, 
u32
 
°a_mask
, u32 
key_Êags
,

185 
õì80211_key_c⁄f
 *
keyc⁄f
)

187 
u32
 
cmd_id
 = 
	`WIDE_ID
(
DATA_PATH_GROUP
, 
SEC_KEY_CMD
);

188 
iwl_£c_key_cmd
 
cmd
 = {

189 .
a˘i⁄
 = 
	`˝u_to_À32
(
FW_CTXT_ACTION_ADD
),

190 .
u
.
add
.
°a_mask
 = 
	`˝u_to_À32
(sta_mask),

191 .
u
.
add
.
key_id
 = 
	`˝u_to_À32
(
keyc⁄f
->
keyidx
),

192 .
u
.
add
.
key_Êags
 = 
	`˝u_to_À32
(key_flags),

193 .
u
.
add
.
tx_£q
 = 
	`˝u_to_À64
(
	`©omic64_ªad
(&
keyc⁄f
->
tx_≤
)),

195 
max_key_Àn
 = (
cmd
.
u
.
add
.
key
);

196 
ªt
;

198 i‡(
keyc⁄f
->
cùhî
 =
WLAN_CIPHER_SUITE_WEP40
 ||

199 
keyc⁄f
->
cùhî
 =
WLAN_CIPHER_SUITE_WEP104
)

200 
max_key_Àn
 -
IWL_SEC_WEP_KEY_OFFSET
;

202 i‡(
	`WARN_ON
(
keyc⁄f
->
keyÀn
 > 
max_key_Àn
))

203  -
EINVAL
;

205 i‡(
	`WARN_ON
(!
°a_mask
))

206  -
EINVAL
;

208 i‡(
keyc⁄f
->
cùhî
 =
WLAN_CIPHER_SUITE_WEP40
 ||

209 
keyc⁄f
->
cùhî
 =
WLAN_CIPHER_SUITE_WEP104
)

210 
	`mem˝y
(
cmd
.
u
.
add
.
key
 + 
IWL_SEC_WEP_KEY_OFFSET
, 
keyc⁄f
->key,

211 
keyc⁄f
->
keyÀn
);

213 
	`mem˝y
(
cmd
.
u
.
add
.
key
, 
keyc⁄f
->key, keyc⁄f->
keyÀn
);

215 i‡(
keyc⁄f
->
cùhî
 =
WLAN_CIPHER_SUITE_TKIP
) {

216 
	`mem˝y
(
cmd
.
u
.
add
.
tkù_mic_rx_key
,

217 
keyc⁄f
->
key
 + 
NL80211_TKIP_DATA_OFFSET_RX_MIC_KEY
,

219 
	`mem˝y
(
cmd
.
u
.
add
.
tkù_mic_tx_key
,

220 
keyc⁄f
->
key
 + 
NL80211_TKIP_DATA_OFFSET_TX_MIC_KEY
,

224 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
cmd_id
, 0, (
cmd
), &cmd);

225 i‡(
ªt
)

226  
ªt
;

232 i‡(
keyc⁄f
->
cùhî
 =
WLAN_CIPHER_SUITE_WEP40
 ||

233 
keyc⁄f
->
cùhî
 =
WLAN_CIPHER_SUITE_WEP104
) {

234 
cmd
.
u
.
add
.
key_Êags
 ^
	`˝u_to_À32
(
IWL_SEC_KEY_FLAG_MCAST_KEY
);

235 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
cmd_id
, 0, (
cmd
), &cmd);

236 i‡(
ªt
)

237 
	`__iwl_mvm_£c_key_dñ
(
mvm
, 
°a_mask
, 
key_Êags
,

238 
keyc⁄f
->
keyidx
, 0);

241  
ªt
;

242 
	}
}

244 
	$iwl_mvm_£c_key_add
(
iwl_mvm
 *
mvm
,

245 
õì80211_vif
 *
vif
,

246 
õì80211_°a
 *
°a
,

247 
õì80211_key_c⁄f
 *
keyc⁄f
)

249 
u32
 
°a_mask
 = 
	`iwl_mvm_gë_£c_°a_mask
(
mvm
, 
vif
, 
°a
, 
keyc⁄f
);

250 
u32
 
key_Êags
 = 
	`iwl_mvm_gë_£c_Êags
(
mvm
, 
vif
, 
°a
, 
keyc⁄f
);

251 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

252 
iwl_mvm_vif_lök_öfo
 *
mvm_lök
 = 
NULL
;

253 
ªt
;

255 i‡(
keyc⁄f
->
keyidx
 == 4 || keyconf->keyidx == 5) {

256 
lök_id
 = 0;

259 i‡(
keyc⁄f
->
lök_id
 >= 0)

260 
lök_id
 = 
keyc⁄f
->link_id;

262 
mvm_lök
 = 
mvmvif
->
lök
[
lök_id
];

263 i‡(
	`WARN_ON
(!
mvm_lök
))

264  -
EINVAL
;

266 i‡(
mvm_lök
->
igtk
) {

267 
	`IWL_DEBUG_MAC80211
(
mvm
, "remove old IGTK %d\n",

268 
mvm_lök
->
igtk
->
keyidx
);

269 
ªt
 = 
	`iwl_mvm_£c_key_dñ
(
mvm
, 
vif
, 
°a
,

270 
mvm_lök
->
igtk
);

271 i‡(
ªt
)

272 
	`IWL_ERR
(
mvm
,

274 
ªt
);

277 
	`WARN_ON
(
mvm_lök
->
igtk
);

280 
ªt
 = 
	`iwl_mvm_mld_£nd_key
(
mvm
, 
°a_mask
, 
key_Êags
, 
keyc⁄f
);

281 i‡(
ªt
)

282  
ªt
;

284 i‡(
mvm_lök
)

285 
mvm_lök
->
igtk
 = 
keyc⁄f
;

291 
keyc⁄f
->
hw_key_idx
 = 0;

294 
	}
}

296 
	$_iwl_mvm_£c_key_dñ
(
iwl_mvm
 *
mvm
,

297 
õì80211_vif
 *
vif
,

298 
õì80211_°a
 *
°a
,

299 
õì80211_key_c⁄f
 *
keyc⁄f
,

300 
u32
 
Êags
)

302 
u32
 
°a_mask
 = 
	`iwl_mvm_gë_£c_°a_mask
(
mvm
, 
vif
, 
°a
, 
keyc⁄f
);

303 
u32
 
key_Êags
 = 
	`iwl_mvm_gë_£c_Êags
(
mvm
, 
vif
, 
°a
, 
keyc⁄f
);

304 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

305 
ªt
;

307 i‡(
	`WARN_ON
(!
°a_mask
))

308  -
EINVAL
;

310 i‡(
keyc⁄f
->
keyidx
 == 4 || keyconf->keyidx == 5) {

311 
iwl_mvm_vif_lök_öfo
 *
mvm_lök
;

312 
lök_id
 = 0;

315 i‡(
keyc⁄f
->
lök_id
 >= 0)

316 
lök_id
 = 
keyc⁄f
->link_id;

318 
mvm_lök
 = 
mvmvif
->
lök
[
lök_id
];

319 i‡(
	`WARN_ON
(!
mvm_lök
))

320  -
EINVAL
;

322 i‡(
mvm_lök
->
igtk
 =
keyc⁄f
) {

324 
mvm_lök
->
igtk
->
hw_key_idx
 = 
STA_KEY_IDX_INVALID
;

325 
mvm_lök
->
igtk
 = 
NULL
;

329 
ªt
 = 
	`__iwl_mvm_£c_key_dñ
(
mvm
, 
°a_mask
, 
key_Êags
, 
keyc⁄f
->
keyidx
,

330 
Êags
);

331 i‡(
ªt
)

332  
ªt
;

335 i‡(
keyc⁄f
->
cùhî
 =
WLAN_CIPHER_SUITE_WEP40
 ||

336 
keyc⁄f
->
cùhî
 =
WLAN_CIPHER_SUITE_WEP104
) {

337 
key_Êags
 ^
IWL_SEC_KEY_FLAG_MCAST_KEY
;

338 
ªt
 = 
	`__iwl_mvm_£c_key_dñ
(
mvm
, 
°a_mask
, 
key_Êags
,

339 
keyc⁄f
->
keyidx
, 
Êags
);

342  
ªt
;

343 
	}
}

345 
	$iwl_mvm_£c_key_dñ_∑¢
(
iwl_mvm
 *
mvm
,

346 
õì80211_vif
 *
vif
,

347 
u32
 
°a_mask
,

348 
õì80211_key_c⁄f
 *
keyc⁄f
)

350 
u32
 
key_Êags
 = 
	`iwl_mvm_gë_£c_Êags
(
mvm
, 
vif
, 
NULL
, 
keyc⁄f
) |

351 
IWL_SEC_KEY_FLAG_MFP
;

353 i‡(
	`WARN_ON
(!
°a_mask
))

354  -
EINVAL
;

356  
	`__iwl_mvm_£c_key_dñ
(
mvm
, 
°a_mask
, 
key_Êags
, 
keyc⁄f
->
keyidx
,

358 
	}
}

360 
	$iwl_mvm_£c_key_dñ
(
iwl_mvm
 *
mvm
,

361 
õì80211_vif
 *
vif
,

362 
õì80211_°a
 *
°a
,

363 
õì80211_key_c⁄f
 *
keyc⁄f
)

365  
	`_iwl_mvm_£c_key_dñ
(
mvm
, 
vif
, 
°a
, 
keyc⁄f
, 0);

366 
	}
}

368 
	$iwl_mvm_£c_key_ªmove_≠_ôî
(
õì80211_hw
 *
hw
,

369 
õì80211_vif
 *
vif
,

370 
õì80211_°a
 *
°a
,

371 
õì80211_key_c⁄f
 *
key
,

372 *
d©a
)

374 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

375 
lök_id
 = (
uöçå_t
)
d©a
;

377 i‡(
key
->
hw_key_idx
 =
STA_KEY_IDX_INVALID
)

380 i‡(
°a
)

383 i‡(
key
->
lök_id
 >= 0 && key->link_id !=Üink_id)

386 
	`_iwl_mvm_£c_key_dñ
(
mvm
, 
vif
, 
NULL
, 
key
, 
CMD_ASYNC
);

387 
key
->
hw_key_idx
 = 
STA_KEY_IDX_INVALID
;

388 
	}
}

390 
	$iwl_mvm_£c_key_ªmove_≠
(
iwl_mvm
 *
mvm
,

391 
õì80211_vif
 *
vif
,

392 
iwl_mvm_vif_lök_öfo
 *
lök
,

393 
lök_id
)

395 
u32
 
£c_key_id
 = 
	`WIDE_ID
(
DATA_PATH_GROUP
, 
SEC_KEY_CMD
);

396 
u8
 
£c_key_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
£c_key_id
, 0);

398 i‡(
	`WARN_ON_ONCE
(
vif
->
ty≥
 !
NL80211_IFTYPE_STATION
 ||

399 
lök
->
≠_°a_id
 =
IWL_MVM_INVALID_STA
))

402 i‡(!
£c_key_vî
)

405 
	`õì80211_ôî_keys_rcu
(
mvm
->
hw
, 
vif
,

406 
iwl_mvm_£c_key_ªmove_≠_ôî
,

407 (*)(
uöçå_t
)
lök_id
);

408 
	}
}

	@mld-mac.c

5 
	~"mvm.h
"

7 
	$iwl_mvm_mld_£t_he_suµ‹t
(
iwl_mvm
 *
mvm
,

8 
õì80211_vif
 *
vif
,

9 
iwl_mac_c⁄fig_cmd
 *
cmd
)

11 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
)

12 
cmd
->
he_≠_suµ‹t
 = 
	`˝u_to_À16
(1);

14 
cmd
->
he_suµ‹t
 = 
	`˝u_to_À16
(1);

15 
	}
}

17 
	$iwl_mvm_mld_mac_˘xt_cmd_comm⁄
(
iwl_mvm
 *
mvm
,

18 
õì80211_vif
 *
vif
,

19 
iwl_mac_c⁄fig_cmd
 *
cmd
,

20 
u32
 
a˘i⁄
)

22 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

23 
õì80211_bss_c⁄f
 *
lök_c⁄f
;

24 
lök_id
;

26 
cmd
->
id_™d_cﬁ‹
 = 
	`˝u_to_À32
(
mvmvif
->
id
);

27 
cmd
->
a˘i⁄
 = 
	`˝u_to_À32
(action);

29 
cmd
->
mac_ty≥
 = 
	`˝u_to_À32
(
	`iwl_mvm_gë_mac_ty≥
(
vif
));

31 
	`mem˝y
(
cmd
->
loˇl_mld_addr
, 
vif
->
addr
, 
ETH_ALEN
);

33 
cmd
->
he_suµ‹t
 = 0;

34 
cmd
->
eht_suµ‹t
 = 0;

37 
cmd
->
fûãr_Êags
 = 0;

39 
cmd
->
nic_nŸ_ack_íabÀd
 =

40 
	`˝u_to_À32
(!
	`iwl_mvm_is_nic_ack_íabÀd
(
mvm
, 
vif
));

42 i‡(
iwlwifi_mod_∑øms
.
dißbÀ_11ax
)

53 i‡(
	`õì80211_vif_is_mld
(
vif
)) {

54 
	`iwl_mvm_mld_£t_he_suµ‹t
(
mvm
, 
vif
, 
cmd
);

55 
cmd
->
eht_suµ‹t
 = 
	`˝u_to_À32
(1);

59 
	`rcu_ªad_lock
();

60 
lök_id
 = 0;Üök_id < 
	`ARRAY_SIZE
((
vif
)->
lök_c⁄f
);Üink_id++) {

61 
lök_c⁄f
 = 
	`rcu_dîe„ªn˚
(
vif
->lök_c⁄f[
lök_id
]);

62 i‡(!
lök_c⁄f
)

65 i‡(
lök_c⁄f
->
he_suµ‹t
)

66 
	`iwl_mvm_mld_£t_he_suµ‹t
(
mvm
, 
vif
, 
cmd
);

71 i‡(!
lök_c⁄f
->
he_suµ‹t
 &&Üök_c⁄f->
eht_suµ‹t
)

74 i‡(
lök_c⁄f
->
eht_suµ‹t
) {

75 
cmd
->
eht_suµ‹t
 = 
	`˝u_to_À32
(1);

79 
	`rcu_ªad_u∆ock
();

80 
	}
}

82 
	$iwl_mvm_mld_mac_˘xt_£nd_cmd
(
iwl_mvm
 *
mvm
,

83 
iwl_mac_c⁄fig_cmd
 *
cmd
)

85 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
,

86 
	`WIDE_ID
(
MAC_CONF_GROUP
, 
MAC_CONFIG_CMD
),

87 0, (*
cmd
), cmd);

88 i‡(
ªt
)

89 
	`IWL_ERR
(
mvm
, "FailedÅo send MAC_CONFIG_CMD (action:%d): %d\n",

90 
	`À32_to_˝u
(
cmd
->
a˘i⁄
), 
ªt
);

91  
ªt
;

92 
	}
}

94 
	$iwl_mvm_mld_mac_˘xt_cmd_°a
(
iwl_mvm
 *
mvm
,

95 
õì80211_vif
 *
vif
,

96 
u32
 
a˘i⁄
, 
boﬁ
 
f‹˚_assoc_off
)

98 
iwl_mac_c⁄fig_cmd
 
cmd
 = {};

99 
u16
 
e§_å™sôi⁄_timeout
;

101 
	`WARN_ON
(
vif
->
ty≥
 !
NL80211_IFTYPE_STATION
);

104 
	`iwl_mvm_mld_mac_˘xt_cmd_comm⁄
(
mvm
, 
vif
, &
cmd
, 
a˘i⁄
);

110 
cmd
.
fûãr_Êags
 |
	`˝u_to_À32
(
MAC_CFG_FILTER_ACCEPT_GRP
);

112 i‡(
vif
->
p2p
)

113 
cmd
.
˛õ¡
.
˘wö
 =

114 
	`iwl_mvm_mac_˘xt_cmd_p2p_°a_gë_›µs_˘wö
(
mvm
, 
vif
);

116 i‡(
vif
->
cfg
.
assoc
 && !
f‹˚_assoc_off
) {

117 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

119 
cmd
.
˛õ¡
.
is_assoc
 = 1;

121 i‡(!
mvmvif
->
auth‹ized
 &&

122 
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

123 
IWL_UCODE_TLV_CAPA_COEX_HIGH_PRIO
))

124 
cmd
.
˛õ¡
.
d©a_pﬁicy
 |=

125 
	`˝u_to_À16
(
COEX_HIGH_PRIORITY_ENABLE
);

128 
cmd
.
˛õ¡
.
is_assoc
 = 0;

133 
cmd
.
fûãr_Êags
 |
	`˝u_to_À32
(
MAC_CFG_FILTER_ACCEPT_BEACON
);

136 
cmd
.
˛õ¡
.
assoc_id
 = 
	`˝u_to_À16
(
vif
->
cfg
.
aid
);

137 i‡(
	`õì80211_vif_is_mld
(
vif
)) {

138 
e§_å™sôi⁄_timeout
 =

139 
	`u16_gë_bôs
(
vif
->
cfg
.
eml_ˇp
,

140 
IEEE80211_EML_CAP_TRANSITION_TIMEOUT
);

142 
cmd
.
˛õ¡
.
e§_å™sôi⁄_timeout
 =

143 
	`mö_t
(
u16
, 
IEEE80211_EML_CAP_TRANSITION_TIMEOUT_128TU
,

144 
e§_å™sôi⁄_timeout
);

145 
cmd
.
˛õ¡
.
medium_sync_dñay
 =

146 
	`˝u_to_À16
(
vif
->
cfg
.
eml_med_sync_dñay
);

149 i‡(
vif
->
¥obe_ªq_ªg
 && vif->
cfg
.
assoc
 && vif->
p2p
)

150 
cmd
.
fûãr_Êags
 |
	`˝u_to_À32
(
MAC_CFG_FILTER_ACCEPT_PROBE_REQ
);

152 i‡(
vif
->
bss_c⁄f
.
he_suµ‹t
 && !
iwlwifi_mod_∑øms
.
dißbÀ_11ax
)

153 
cmd
.
˛õ¡
.
d©a_pﬁicy
 |=

154 
	`˝u_to_À16
(
	`iwl_mvm_mac_˘xt_cmd_°a_gë_twt_pﬁicy
(
mvm
, 
vif
));

156  
	`iwl_mvm_mld_mac_˘xt_£nd_cmd
(
mvm
, &
cmd
);

157 
	}
}

159 
	$iwl_mvm_mld_mac_˘xt_cmd_li°íî
(
iwl_mvm
 *
mvm
,

160 
õì80211_vif
 *
vif
,

161 
u32
 
a˘i⁄
)

163 
iwl_mac_c⁄fig_cmd
 
cmd
 = {};

165 
	`WARN_ON
(
vif
->
ty≥
 !
NL80211_IFTYPE_MONITOR
);

167 
	`iwl_mvm_mld_mac_˘xt_cmd_comm⁄
(
mvm
, 
vif
, &
cmd
, 
a˘i⁄
);

169 
cmd
.
fûãr_Êags
 = 
	`˝u_to_À32
(
MAC_CFG_FILTER_PROMISC
 |

170 
MAC_CFG_FILTER_ACCEPT_CONTROL_AND_MGMT
 |

171 
MAC_CFG_FILTER_ACCEPT_BEACON
 |

172 
MAC_CFG_FILTER_ACCEPT_PROBE_REQ
 |

173 
MAC_CFG_FILTER_ACCEPT_GRP
);

175  
	`iwl_mvm_mld_mac_˘xt_£nd_cmd
(
mvm
, &
cmd
);

176 
	}
}

178 
	$iwl_mvm_mld_mac_˘xt_cmd_ibss
(
iwl_mvm
 *
mvm
,

179 
õì80211_vif
 *
vif
,

180 
u32
 
a˘i⁄
)

182 
iwl_mac_c⁄fig_cmd
 
cmd
 = {};

184 
	`WARN_ON
(
vif
->
ty≥
 !
NL80211_IFTYPE_ADHOC
);

186 
	`iwl_mvm_mld_mac_˘xt_cmd_comm⁄
(
mvm
, 
vif
, &
cmd
, 
a˘i⁄
);

188 
cmd
.
fûãr_Êags
 = 
	`˝u_to_À32
(
MAC_CFG_FILTER_ACCEPT_BEACON
 |

189 
MAC_CFG_FILTER_ACCEPT_PROBE_REQ
 |

190 
MAC_CFG_FILTER_ACCEPT_GRP
);

192  
	`iwl_mvm_mld_mac_˘xt_£nd_cmd
(
mvm
, &
cmd
);

193 
	}
}

195 
	$iwl_mvm_mld_mac_˘xt_cmd_p2p_devi˚
(
iwl_mvm
 *
mvm
,

196 
õì80211_vif
 *
vif
,

197 
u32
 
a˘i⁄
)

199 
iwl_mac_c⁄fig_cmd
 
cmd
 = {};

201 
	`WARN_ON
(
vif
->
ty≥
 !
NL80211_IFTYPE_P2P_DEVICE
);

203 
	`iwl_mvm_mld_mac_˘xt_cmd_comm⁄
(
mvm
, 
vif
, &
cmd
, 
a˘i⁄
);

205 
cmd
.
p2p_dev
.
is_disc_exãnded
 =

206 
	`iwl_mac_˘xt_p2p_dev_has_exãnded_disc
(
mvm
, 
vif
);

212 
cmd
.
fûãr_Êags
 = 
	`˝u_to_À32
(
MAC_CFG_FILTER_ACCEPT_CONTROL_AND_MGMT
);

214  
	`iwl_mvm_mld_mac_˘xt_£nd_cmd
(
mvm
, &
cmd
);

215 
	}
}

217 
	$iwl_mvm_mld_mac_˘xt_cmd_≠_go
(
iwl_mvm
 *
mvm
,

218 
õì80211_vif
 *
vif
,

219 
u32
 
a˘i⁄
)

221 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

222 
iwl_mac_c⁄fig_cmd
 
cmd
 = {};

224 
	`WARN_ON
(
vif
->
ty≥
 !
NL80211_IFTYPE_AP
);

227 
	`iwl_mvm_mld_mac_˘xt_cmd_comm⁄
(
mvm
, 
vif
, &
cmd
, 
a˘i⁄
);

229 
	`iwl_mvm_mac_˘xt_cmd_≠_£t_fûãr_Êags
(
mvm
, 
mvmvif
,

230 &
cmd
.
fûãr_Êags
,

231 
MAC_CFG_FILTER_ACCEPT_PROBE_REQ
,

232 
MAC_CFG_FILTER_ACCEPT_BEACON
);

234  
	`iwl_mvm_mld_mac_˘xt_£nd_cmd
(
mvm
, &
cmd
);

235 
	}
}

237 
	$iwl_mvm_mld_mac_˘x_£nd
(
iwl_mvm
 *
mvm
,

238 
õì80211_vif
 *
vif
,

239 
u32
 
a˘i⁄
, 
boﬁ
 
f‹˚_assoc_off
)

241 
vif
->
ty≥
) {

242 
NL80211_IFTYPE_STATION
:

243  
	`iwl_mvm_mld_mac_˘xt_cmd_°a
(
mvm
, 
vif
, 
a˘i⁄
,

244 
f‹˚_assoc_off
);

245 
NL80211_IFTYPE_AP
:

246  
	`iwl_mvm_mld_mac_˘xt_cmd_≠_go
(
mvm
, 
vif
, 
a˘i⁄
);

247 
NL80211_IFTYPE_MONITOR
:

248  
	`iwl_mvm_mld_mac_˘xt_cmd_li°íî
(
mvm
, 
vif
, 
a˘i⁄
);

249 
NL80211_IFTYPE_P2P_DEVICE
:

250  
	`iwl_mvm_mld_mac_˘xt_cmd_p2p_devi˚
(
mvm
, 
vif
, 
a˘i⁄
);

251 
NL80211_IFTYPE_ADHOC
:

252  
	`iwl_mvm_mld_mac_˘xt_cmd_ibss
(
mvm
, 
vif
, 
a˘i⁄
);

257  -
EOPNOTSUPP
;

258 
	}
}

260 
	$iwl_mvm_mld_mac_˘xt_add
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

262 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

263 
ªt
;

265 i‡(
	`WARN_ON_ONCE
(
vif
->
ty≥
 =
NL80211_IFTYPE_NAN
))

266  -
EOPNOTSUPP
;

268 i‡(
	`WARN_ONCE
(
mvmvif
->
u∂ﬂded
, "Addingáctive MAC %pM/%d\n",

269 
vif
->
addr
, 
	`õì80211_vif_ty≥_p2p
(vif)))

270  -
EIO
;

272 
ªt
 = 
	`iwl_mvm_mld_mac_˘x_£nd
(
mvm
, 
vif
, 
FW_CTXT_ACTION_ADD
,

273 
åue
);

274 i‡(
ªt
)

275  
ªt
;

278 
	`iwl_mvm_£t_œ°_n⁄qos_£q
(
mvm
, 
vif
);

280 
mvmvif
->
u∂ﬂded
 = 
åue
;

282 
	}
}

284 
	$iwl_mvm_mld_mac_˘xt_ch™ged
(
iwl_mvm
 *
mvm
,

285 
õì80211_vif
 *
vif
,

286 
boﬁ
 
f‹˚_assoc_off
)

288 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

290 i‡(
	`WARN_ON_ONCE
(
vif
->
ty≥
 =
NL80211_IFTYPE_NAN
))

291  -
EOPNOTSUPP
;

293 i‡(
	`WARN_ONCE
(!
mvmvif
->
u∂ﬂded
, "Changing inactive MAC %pM/%d\n",

294 
vif
->
addr
, 
	`õì80211_vif_ty≥_p2p
(vif)))

295  -
EIO
;

297  
	`iwl_mvm_mld_mac_˘x_£nd
(
mvm
, 
vif
, 
FW_CTXT_ACTION_MODIFY
,

298 
f‹˚_assoc_off
);

299 
	}
}

301 
	$iwl_mvm_mld_mac_˘xt_ªmove
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

303 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

304 
iwl_mac_c⁄fig_cmd
 
cmd
 = {

305 .
a˘i⁄
 = 
	`˝u_to_À32
(
FW_CTXT_ACTION_REMOVE
),

306 .
id_™d_cﬁ‹
 = 
	`˝u_to_À32
(
mvmvif
->
id
),

308 
ªt
;

310 i‡(
	`WARN_ON_ONCE
(
vif
->
ty≥
 =
NL80211_IFTYPE_NAN
))

311  -
EOPNOTSUPP
;

313 i‡(
	`WARN_ONCE
(!
mvmvif
->
u∂ﬂded
, "Removing inactive MAC %pM/%d\n",

314 
vif
->
addr
, 
	`õì80211_vif_ty≥_p2p
(vif)))

315  -
EIO
;

317 
ªt
 = 
	`iwl_mvm_mld_mac_˘xt_£nd_cmd
(
mvm
, &
cmd
);

318 i‡(
ªt
)

319  
ªt
;

321 
mvmvif
->
u∂ﬂded
 = 
Ál£
;

324 
	}
}

	@mld-mac80211.c

5 
	~"mvm.h
"

7 
	$iwl_mvm_mld_mac_add_öãrÁ˚
(
õì80211_hw
 *
hw
,

8 
õì80211_vif
 *
vif
)

10 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

11 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

12 
ªt
;

13 
i
;

15 
	`muãx_lock
(&
mvm
->
muãx
);

17 
mvmvif
->
mvm
 = mvm;

25 i‡(
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
))

26 
	`f‹_óch_mvm_vif_vÆid_lök
(
mvmvif
, 
i
)

27 
mvmvif
->
lök
[
i
]->
bóc⁄_°©s
.
accu_num_bóc⁄s
 +=

28 
mvmvif
->
lök
[
i
]->
bóc⁄_°©s
.
num_bóc⁄s
;

31 
ªt
 = 
	`iwl_mvm_mac_˘xt_öô
(
mvm
, 
vif
);

32 i‡(
ªt
)

33 
out_u∆ock
;

35 
	`rcu_assign_poöãr
(
mvm
->
vif_id_to_mac
[
mvmvif
->
id
], 
vif
);

37 
mvmvif
->
„©uªs
 |
hw
->
√tdev_„©uªs
;

40 
mvmvif
->
deÊök
.
fw_lök_id
 = 
IWL_MVM_FW_LINK_ID_INVALID
;

41 
mvmvif
->
deÊök
.
a˘ive
 = 0;

43 
mvmvif
->
lök
[0] = &mvmvif->
deÊök
;

45 
ªt
 = 
	`iwl_mvm_mld_mac_˘xt_add
(
mvm
, 
vif
);

46 i‡(
ªt
)

47 
out_u∆ock
;

50 
ªt
 = 
	`iwl_mvm_dißbÀ_bóc⁄_fûãr
(
mvm
, 
vif
);

51 i‡(
ªt
)

52 
out_ªmove_mac
;

54 i‡(!
mvm
->
bf_Ælowed_vif
 &&

55 
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
 && !vif->
p2p
) {

56 
mvm
->
bf_Ælowed_vif
 = 
mvmvif
;

57 
vif
->
drivî_Êags
 |
IEEE80211_VIF_BEACON_FILTER
 |

58 
IEEE80211_VIF_SUPPORTS_CQM_RSSI
;

61 
ªt
 = 
	`iwl_mvm_add_lök
(
mvm
, 
vif
, &vif->
bss_c⁄f
);

62 i‡(
ªt
)

63 
out_‰ì_bf
;

68 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_P2P_DEVICE
)

69 
mvm
->
p2p_devi˚_vif
 = 
vif
;

71 
ªt
 = 
	`iwl_mvm_powî_upd©e_mac
(
mvm
);

72 i‡(
ªt
)

73 
out_‰ì_bf
;

75 
	`iwl_mvm_tcm_add_vif
(
mvm
, 
vif
);

76 
	`INIT_DELAYED_WORK
(&
mvmvif
->
cß_w‹k
,

77 
iwl_mvm_ch™√l_swôch_disc⁄√˘_wk
);

79 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_MONITOR
) {

80 
mvm
->
m⁄ô‹_⁄
 = 
åue
;

81 
	`õì80211_hw_£t
(
mvm
->
hw
, 
RX_INCLUDES_FCS
);

84 i‡(!
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
))

85 
	`iwl_mvm_vif_dbgfs_add_lök
(
mvm
, 
vif
);

87 i‡(!
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
) &&

88 
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
 && !vif->
p2p
 &&

89 !
mvm
->
csme_vif
 && mvm->
mei_ªgi°îed
) {

90 
	`iwl_mei_£t_nic_öfo
(
vif
->
addr
, 
mvm
->
nvm_d©a
->
hw_addr
);

91 
	`iwl_mei_£t_√tdev
(
	`õì80211_vif_to_wdev
(
vif
)->
√tdev
);

92 
mvm
->
csme_vif
 = 
vif
;

95 
out_u∆ock
;

97 
out_‰ì_bf
:

98 i‡(
mvm
->
bf_Ælowed_vif
 =
mvmvif
) {

99 
mvm
->
bf_Ælowed_vif
 = 
NULL
;

100 
vif
->
drivî_Êags
 &~(
IEEE80211_VIF_BEACON_FILTER
 |

101 
IEEE80211_VIF_SUPPORTS_CQM_RSSI
);

103 
out_ªmove_mac
:

104 
mvmvif
->
lök
[0] = 
NULL
;

105 
	`iwl_mvm_mld_mac_˘xt_ªmove
(
mvm
, 
vif
);

106 
out_u∆ock
:

107 
	`muãx_u∆ock
(&
mvm
->
muãx
);

109  
ªt
;

110 
	}
}

112 
	$iwl_mvm_mld_mac_ªmove_öãrÁ˚
(
õì80211_hw
 *
hw
,

113 
õì80211_vif
 *
vif
)

115 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

116 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

117 
iwl_¥obe_ª•_d©a
 *
¥obe_d©a
;

119 
	`iwl_mvm_¥ï¨e_mac_ªmovÆ
(
mvm
, 
vif
);

121 i‡(!(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
 ||

122 
vif
->
ty≥
 =
NL80211_IFTYPE_ADHOC
))

123 
	`iwl_mvm_tcm_rm_vif
(
mvm
, 
vif
);

125 
	`muãx_lock
(&
mvm
->
muãx
);

127 i‡(
vif
 =
mvm
->
csme_vif
) {

128 
	`iwl_mei_£t_√tdev
(
NULL
);

129 
mvm
->
csme_vif
 = 
NULL
;

132 i‡(
mvm
->
bf_Ælowed_vif
 =
mvmvif
) {

133 
mvm
->
bf_Ælowed_vif
 = 
NULL
;

134 
vif
->
drivî_Êags
 &~(
IEEE80211_VIF_BEACON_FILTER
 |

135 
IEEE80211_VIF_SUPPORTS_CQM_RSSI
);

138 i‡(
vif
->
bss_c⁄f
.
·m_ª•⁄dî
)

139 
	`mem£t
(&
mvm
->
·m_ª•_°©s
, 0, (mvm->ftm_resp_stats));

141 
	`iwl_mvm_vif_dbgfs_rm_lök
(
mvm
, 
vif
);

146 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
 ||

147 
vif
->
ty≥
 =
NL80211_IFTYPE_ADHOC
) {

148 #ifde‡
CONFIG_NL80211_TESTMODE


149 i‡(
vif
 =
mvm
->
nﬂ_vif
) {

150 
mvm
->
nﬂ_vif
 = 
NULL
;

151 
mvm
->
nﬂ_duøti⁄
 = 0;

156 
	`iwl_mvm_powî_upd©e_mac
(
mvm
);

163 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_P2P_DEVICE
) {

164 i‡(
mvmvif
->
deÊök
.
phy_˘xt
) {

165 
	`iwl_mvm_phy_˘xt_uƒef
(
mvm
, 
mvmvif
->
deÊök
.
phy_˘xt
);

166 
mvmvif
->
deÊök
.
phy_˘xt
 = 
NULL
;

168 
mvm
->
p2p_devi˚_vif
 = 
NULL
;

169 
	`iwl_mvm_ªmove_lök
(
mvm
, 
vif
, &vif->
bss_c⁄f
);

171 
	`iwl_mvm_dißbÀ_lök
(
mvm
, 
vif
, &vif->
bss_c⁄f
);

174 
	`iwl_mvm_mld_mac_˘xt_ªmove
(
mvm
, 
vif
);

176 
	`RCU_INIT_POINTER
(
mvm
->
vif_id_to_mac
[
mvmvif
->
id
], 
NULL
);

178 
¥obe_d©a
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvmvif
->
deÊök
.
¥obe_ª•_d©a
,

179 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

180 
	`RCU_INIT_POINTER
(
mvmvif
->
deÊök
.
¥obe_ª•_d©a
, 
NULL
);

181 i‡(
¥obe_d©a
)

182 
	`k‰ì_rcu
(
¥obe_d©a
, 
rcu_hód
);

184 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_MONITOR
) {

185 
mvm
->
m⁄ô‹_⁄
 = 
Ál£
;

186 
	`__˛ór_bô
(
IEEE80211_HW_RX_INCLUDES_FCS
, 
mvm
->
hw
->
Êags
);

189 
	`muãx_u∆ock
(&
mvm
->
muãx
);

190 
	}
}

192 
	$iwl_mvm_mld_cou¡_a˘ive_löks
(
õì80211_vif
 *
vif
)

194 
n_a˘ive
 = 0;

195 
i
;

197 
i
 = 0; i < 
IEEE80211_MLD_MAX_NUM_LINKS
; i++) {

198 
õì80211_bss_c⁄f
 *
lök_c⁄f
;

200 
lök_c⁄f
 = 
	`lök_c⁄f_dîe„ªn˚_¥Ÿe˘ed
(
vif
, 
i
);

201 i‡(
lök_c⁄f
 &&

202 
	`rcu_ac˚ss_poöãr
(
lök_c⁄f
->
ch™˘x_c⁄f
))

203 
n_a˘ive
++;

206  
n_a˘ive
;

207 
	}
}

209 
	$iwl_mvm_e§_mode_a˘ive
(
iwl_mvm
 *
mvm
,

210 
õì80211_vif
 *
vif
)

212 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

213 
lök_id
, 
ªt
 = 0;

215 
mvmvif
->
e§_a˘ive
 = 
åue
;

218 
vif
->
drivî_Êags
 |
IEEE80211_VIF_EML_ACTIVE
;

220 
	`iwl_mvm_upd©e_smps_⁄_a˘ive_löks
(
mvm
, 
vif
, 
IWL_MVM_SMPS_REQ_FW
,

221 
IEEE80211_SMPS_OFF
);

223 
	`f‹_óch_mvm_vif_vÆid_lök
(
mvmvif
, 
lök_id
) {

224 
iwl_mvm_vif_lök_öfo
 *
lök
 = 
mvmvif
->lök[
lök_id
];

226 i‡(!
lök
->
phy_˘xt
)

229 
ªt
 = 
	`iwl_mvm_phy_£nd_æc
(
mvm
, 
lök
->
phy_˘xt
, 2, 2);

230 i‡(
ªt
)

233 
lök
->
phy_˘xt
->
æc_dißbÀd
 = 
åue
;

236  
ªt
;

237 
	}
}

240 
	$__iwl_mvm_mld_assign_vif_ch™˘x
(
iwl_mvm
 *
mvm
,

241 
õì80211_vif
 *
vif
,

242 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

243 
õì80211_ch™˘x_c⁄f
 *
˘x
,

244 
boﬁ
 
swôchög_ch™˘x
)

246 
u16
 *
phy_˘xt_id
 = (u16 *)
˘x
->
drv_¥iv
;

247 
iwl_mvm_phy_˘xt
 *
phy_˘xt
 = &
mvm
->
phy_˘xts
[*
phy_˘xt_id
];

248 
n_a˘ive
 = 
	`iwl_mvm_mld_cou¡_a˘ive_löks
(
vif
);

249 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

250 
lök_id
 = 
lök_c⁄f
->link_id;

251 
ªt
;

254 i‡(!
	`rcu_ac˚ss_poöãr
(
lök_c⁄f
->
ch™˘x_c⁄f
))

255 
n_a˘ive
++;

257 i‡(
	`WARN_ON_ONCE
(!
mvmvif
->
lök
[
lök_id
]))

258  -
EINVAL
;

264 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
) {

265 
ªt
 = 
	`iwl_mvm_mld_mac_˘xt_ch™ged
(
mvm
, 
vif
, 
Ál£
);

266 i‡(
ªt
) {

267 
	`IWL_ERR
(
mvm
, "ÁûedÅÿupd©êMAC %pM\n", 
vif
->
addr
);

268  -
EINVAL
;

272 
mvmvif
->
lök
[
lök_id
]->
phy_˘xt
 =Öhy_ctxt;

274 i‡(
	`iwl_mvm_is_e§_suµ‹ãd
(
mvm
->
fwπ
.
å™s
Ë&& 
n_a˘ive
 > 1) {

275 
mvmvif
->
lök
[
lök_id
]->
li°í_lmac
 = 
åue
;

276 
ªt
 = 
	`iwl_mvm_e§_mode_a˘ive
(
mvm
, 
vif
);

277 i‡(
ªt
) {

278 
	`IWL_ERR
(
mvm
, "ÁûedÅÿa˘iv©êESR modê(%d)\n", 
ªt
);

279 
out
;

283 i‡(
swôchög_ch™˘x
) {

285 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
)

286 
mvmvif
->
≠_ibss_a˘ive
 = 
åue
;

290 
ªt
 = 
	`iwl_mvm_lök_ch™ged
(
mvm
, 
vif
, 
lök_c⁄f
, 0, 
Ál£
);

291 i‡(
ªt
)

292 
out
;

304 i‡(
mvmvif
->
≠_°a
 &&

305 !
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
)) {

306 
õì80211_lök_°a
 *
lök_°a
;

308 
	`rcu_ªad_lock
();

309 
lök_°a
 = 
	`rcu_dîe„ªn˚
(
mvmvif
->
≠_°a
->
lök
[
lök_id
]);

311 i‡(!
	`WARN_ON_ONCE
(!
lök_°a
))

312 
	`iwl_mvm_rs_øã_öô
(
mvm
, 
vif
, 
mvmvif
->
≠_°a
,

313 
lök_c⁄f
, 
lök_°a
,

314 
phy_˘xt
->
ch™√l
->
b™d
);

315 
	`rcu_ªad_u∆ock
();

319 
ªt
 = 
	`iwl_mvm_lök_ch™ged
(
mvm
, 
vif
, 
lök_c⁄f
,

320 
LINK_CONTEXT_MODIFY_ACTIVE
 |

321 
LINK_CONTEXT_MODIFY_RATES_INFO
,

322 
åue
);

323 i‡(
ªt
)

324 
out
;

330 
	`iwl_mvm_powî_upd©e_mac
(
mvm
);

332 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_MONITOR
) {

333 
ªt
 = 
	`iwl_mvm_mld_add_¢if_°a
(
mvm
, 
vif
, 
lök_c⁄f
);

334 i‡(
ªt
)

335 
dó˘iv©e
;

340 
dó˘iv©e
:

341 
	`iwl_mvm_lök_ch™ged
(
mvm
, 
vif
, 
lök_c⁄f
, 
LINK_CONTEXT_MODIFY_ACTIVE
,

342 
Ál£
);

343 
out
:

344 
mvmvif
->
lök
[
lök_id
]->
phy_˘xt
 = 
NULL
;

345 
	`iwl_mvm_powî_upd©e_mac
(
mvm
);

346  
ªt
;

347 
	}
}

349 
	$iwl_mvm_mld_assign_vif_ch™˘x
(
õì80211_hw
 *
hw
,

350 
õì80211_vif
 *
vif
,

351 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

352 
õì80211_ch™˘x_c⁄f
 *
˘x
)

354 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

355 
ªt
;

357 
	`muãx_lock
(&
mvm
->
muãx
);

358 
ªt
 = 
	`__iwl_mvm_mld_assign_vif_ch™˘x
(
mvm
, 
vif
, 
lök_c⁄f
, 
˘x
, 
Ál£
);

359 
	`muãx_u∆ock
(&
mvm
->
muãx
);

361  
ªt
;

362 
	}
}

364 
	$iwl_mvm_e§_mode_öa˘ive
(
iwl_mvm
 *
mvm
,

365 
õì80211_vif
 *
vif
)

367 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

368 
õì80211_bss_c⁄f
 *
lök_c⁄f
;

369 
lök_id
, 
ªt
 = 0;

371 
mvmvif
->
e§_a˘ive
 = 
Ál£
;

373 
vif
->
drivî_Êags
 &~
IEEE80211_VIF_EML_ACTIVE
;

375 
	`iwl_mvm_upd©e_smps_⁄_a˘ive_löks
(
mvm
, 
vif
, 
IWL_MVM_SMPS_REQ_FW
,

376 
IEEE80211_SMPS_AUTOMATIC
);

378 
	`f‹_óch_vif_a˘ive_lök
(
vif
, 
lök_c⁄f
, 
lök_id
) {

379 
õì80211_ch™˘x_c⁄f
 *
ch™˘x_c⁄f
;

380 
iwl_mvm_phy_˘xt
 *
phy_˘xt
;

381 
u8
 
°©ic_chaös
, 
dy«mic_chaös
;

383 
mvmvif
->
lök
[
lök_id
]->
li°í_lmac
 = 
Ál£
;

385 
	`rcu_ªad_lock
();

387 
ch™˘x_c⁄f
 = 
	`rcu_dîe„ªn˚
(
lök_c⁄f
->chanctx_conf);

388 
phy_˘xt
 = 
mvmvif
->
lök
[
lök_id
]->phy_ctxt;

390 i‡(!
ch™˘x_c⁄f
 || !
phy_˘xt
) {

391 
	`rcu_ªad_u∆ock
();

395 
phy_˘xt
->
æc_dißbÀd
 = 
Ál£
;

396 
°©ic_chaös
 = 
ch™˘x_c⁄f
->
rx_chaös_°©ic
;

397 
dy«mic_chaös
 = 
ch™˘x_c⁄f
->
rx_chaös_dy«mic
;

399 
	`rcu_ªad_u∆ock
();

401 
ªt
 = 
	`iwl_mvm_phy_£nd_æc
(
mvm
, 
phy_˘xt
, 
°©ic_chaös
,

402 
dy«mic_chaös
);

403 i‡(
ªt
)

407  
ªt
;

408 
	}
}

411 
	$__iwl_mvm_mld_u«ssign_vif_ch™˘x
(
iwl_mvm
 *
mvm
,

412 
õì80211_vif
 *
vif
,

413 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

414 
õì80211_ch™˘x_c⁄f
 *
˘x
,

415 
boﬁ
 
swôchög_ch™˘x
)

418 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

419 
n_a˘ive
 = 
	`iwl_mvm_mld_cou¡_a˘ive_löks
(
vif
);

420 
lök_id
 = 
lök_c⁄f
->link_id;

423 i‡(
	`WARN_ON_ONCE
(!
mvmvif
->
lök
[
lök_id
]))

426 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
 && 
swôchög_ch™˘x
) {

427 
mvmvif
->
cß_cou¡down
 = 
Ál£
;

430 
	`iwl_mvm_modify_Æl_°a_dißbÀ_tx
(
mvm
, 
mvmvif
, 
åue
);

433 
	`rcu_assign_poöãr
(
mvm
->
cß_tx_blocked_vif
, 
vif
);

435 
mvmvif
->
≠_ibss_a˘ive
 = 
Ál£
;

438 
	`iwl_mvm_lök_ch™ged
(
mvm
, 
vif
, 
lök_c⁄f
,

439 
LINK_CONTEXT_MODIFY_ACTIVE
, 
Ál£
);

441 i‡(
	`iwl_mvm_is_e§_suµ‹ãd
(
mvm
->
fwπ
.
å™s
Ë&& 
n_a˘ive
 > 1) {

442 
ªt
 = 
	`iwl_mvm_e§_mode_öa˘ive
(
mvm
, 
vif
);

444 i‡(
ªt
)

445 
	`IWL_ERR
(
mvm
, "failedÅo deactivate ESR mode (%d)\n",

446 
ªt
);

449 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_MONITOR
)

450 
	`iwl_mvm_mld_rm_¢if_°a
(
mvm
, 
vif
);

452 i‡(
swôchög_ch™˘x
)

454 
mvmvif
->
lök
[
lök_id
]->
phy_˘xt
 = 
NULL
;

455 
	`iwl_mvm_powî_upd©e_mac
(
mvm
);

456 
	}
}

458 
	$iwl_mvm_mld_u«ssign_vif_ch™˘x
(
õì80211_hw
 *
hw
,

459 
õì80211_vif
 *
vif
,

460 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

461 
õì80211_ch™˘x_c⁄f
 *
˘x
)

463 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

464 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

466 
	`muãx_lock
(&
mvm
->
muãx
);

467 
	`__iwl_mvm_mld_u«ssign_vif_ch™˘x
(
mvm
, 
vif
, 
lök_c⁄f
, 
˘x
, 
Ál£
);

469 i‡(!
	`õì80211_vif_is_mld
(
vif
Ë&& !
mvmvif
->
≠_°a
 &&

470 !
	`WARN_ON_ONCE
(
vif
->
cfg
.
assoc
)) {

471 
	`iwl_mvm_ªmove_lök
(
mvm
, 
vif
, 
lök_c⁄f
);

472 
	`iwl_mvm_add_lök
(
mvm
, 
vif
, 
lök_c⁄f
);

474 
	`muãx_u∆ock
(&
mvm
->
muãx
);

475 
	}
}

477 
	$iwl_mvm_mld_°¨t_≠_ibss
(
õì80211_hw
 *
hw
,

478 
õì80211_vif
 *
vif
,

479 
õì80211_bss_c⁄f
 *
lök_c⁄f
)

481 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

482 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

483 
ªt
;

485 
	`muãx_lock
(&
mvm
->
muãx
);

487 
ªt
 = 
	`iwl_mvm_mac_˘xt_bóc⁄_ch™ged
(
mvm
, 
vif
, 
lök_c⁄f
);

488 i‡(
ªt
)

489 
out_u∆ock
;

492 
ªt
 = 
	`iwl_mvm_lök_ch™ged
(
mvm
, 
vif
, 
lök_c⁄f
,

493 
LINK_CONTEXT_MODIFY_ALL
 &

494 ~
LINK_CONTEXT_MODIFY_ACTIVE
,

495 
åue
);

496 i‡(
ªt
)

497 
out_u∆ock
;

499 
ªt
 = 
	`iwl_mvm_mld_add_mˇ°_°a
(
mvm
, 
vif
, 
lök_c⁄f
);

500 i‡(
ªt
)

501 
out_u∆ock
;

506 
ªt
 = 
	`iwl_mvm_mld_add_bˇ°_°a
(
mvm
, 
vif
, 
lök_c⁄f
);

507 i‡(
ªt
)

508 
out_rm_mˇ°
;

510 i‡(
	`iwl_mvm_°¨t_≠_ibss_comm⁄
(
hw
, 
vif
, &
ªt
))

511 
out_Áûed
;

514 i‡(
vif
->
p2p
 && 
mvm
->
p2p_devi˚_vif
)

515 
	`iwl_mvm_mld_mac_˘xt_ch™ged
(
mvm
, mvm->
p2p_devi˚_vif
, 
Ál£
);

517 
	`iwl_mvm_bt_c€x_vif_ch™ge
(
mvm
);

520 i‡(
	`iwl_mvm_phy_˘x_cou¡
(
mvm
) > 1)

521 
	`iwl_mvm_ã¨down_tdls_≥îs
(
mvm
);

523 
	`iwl_mvm_·m_ª°¨t_ª•⁄dî
(
mvm
, 
vif
, 
lök_c⁄f
);

525 
out_u∆ock
;

527 
out_Áûed
:

528 
	`iwl_mvm_powî_upd©e_mac
(
mvm
);

529 
mvmvif
->
≠_ibss_a˘ive
 = 
Ál£
;

530 
	`iwl_mvm_mld_rm_bˇ°_°a
(
mvm
, 
vif
, 
lök_c⁄f
);

531 
out_rm_mˇ°
:

532 
	`iwl_mvm_mld_rm_mˇ°_°a
(
mvm
, 
vif
, 
lök_c⁄f
);

533 
out_u∆ock
:

534 
	`muãx_u∆ock
(&
mvm
->
muãx
);

535  
ªt
;

536 
	}
}

538 
	$iwl_mvm_mld_°¨t_≠
(
õì80211_hw
 *
hw
,

539 
õì80211_vif
 *
vif
,

540 
õì80211_bss_c⁄f
 *
lök_c⁄f
)

542  
	`iwl_mvm_mld_°¨t_≠_ibss
(
hw
, 
vif
, 
lök_c⁄f
);

543 
	}
}

545 
	$iwl_mvm_mld_°¨t_ibss
(
õì80211_hw
 *
hw
,

546 
õì80211_vif
 *
vif
)

548  
	`iwl_mvm_mld_°¨t_≠_ibss
(
hw
, 
vif
, &vif->
bss_c⁄f
);

549 
	}
}

551 
	$iwl_mvm_mld_°›_≠_ibss
(
õì80211_hw
 *
hw
,

552 
õì80211_vif
 *
vif
,

553 
õì80211_bss_c⁄f
 *
lök_c⁄f
)

555 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

557 
	`muãx_lock
(&
mvm
->
muãx
);

559 
	`iwl_mvm_°›_≠_ibss_comm⁄
(
mvm
, 
vif
);

562 i‡(
vif
->
p2p
 && 
mvm
->
p2p_devi˚_vif
)

563 
	`iwl_mvm_mld_mac_˘xt_ch™ged
(
mvm
, mvm->
p2p_devi˚_vif
, 
Ál£
);

565 
	`iwl_mvm_·m_ª•⁄dî_˛ór
(
mvm
, 
vif
);

567 
	`iwl_mvm_mld_rm_bˇ°_°a
(
mvm
, 
vif
, 
lök_c⁄f
);

568 
	`iwl_mvm_mld_rm_mˇ°_°a
(
mvm
, 
vif
, 
lök_c⁄f
);

570 
	`iwl_mvm_powî_upd©e_mac
(
mvm
);

571 
	`muãx_u∆ock
(&
mvm
->
muãx
);

572 
	}
}

574 
	$iwl_mvm_mld_°›_≠
(
õì80211_hw
 *
hw
,

575 
õì80211_vif
 *
vif
,

576 
õì80211_bss_c⁄f
 *
lök_c⁄f
)

578 
	`iwl_mvm_mld_°›_≠_ibss
(
hw
, 
vif
, 
lök_c⁄f
);

579 
	}
}

581 
	$iwl_mvm_mld_°›_ibss
(
õì80211_hw
 *
hw
,

582 
õì80211_vif
 *
vif
)

584 
	`iwl_mvm_mld_°›_≠_ibss
(
hw
, 
vif
, &vif->
bss_c⁄f
);

585 
	}
}

587 
	$iwl_mvm_mld_mac_°a_°©e
(
õì80211_hw
 *
hw
,

588 
õì80211_vif
 *
vif
,

589 
õì80211_°a
 *
°a
,

590 
õì80211_°a_°©e
 
ﬁd_°©e
,

591 
õì80211_°a_°©e
 
√w_°©e
)

593 c⁄° 
iwl_mvm_°a_°©e_›s
 
ˇŒbacks
 = {

594 .
add_°a
 = 
iwl_mvm_mld_add_°a
,

595 .
upd©e_°a
 = 
iwl_mvm_mld_upd©e_°a
,

596 .
rm_°a
 = 
iwl_mvm_mld_rm_°a
,

597 .
mac_˘xt_ch™ged
 = 
iwl_mvm_mld_mac_˘xt_ch™ged
,

600  
	`iwl_mvm_mac_°a_°©e_comm⁄
(
hw
, 
vif
, 
°a
, 
ﬁd_°©e
, 
√w_°©e
,

601 &
ˇŒbacks
);

602 
	}
}

604 
	siwl_mvm_lök_£l_d©a
 {

605 
u8
 
	mlök_id
;

606 
∆80211_b™d
 
	mb™d
;

607 
∆80211_ch™_width
 
	mwidth
;

608 
boﬁ
 
	ma˘ive
;

611 
boﬁ
 
	$iwl_mvm_mld_vÆid_lök_∑ú
(
iwl_mvm_lök_£l_d©a
 *
a
,

612 
iwl_mvm_lök_£l_d©a
 *
b
)

614  
a
->
b™d
 !
b
->band;

615 
	}
}

617 
	$iwl_mvm_mld_£À˘_löks
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

618 
boﬁ
 
vÆid_löks_ch™ged
)

620 
iwl_mvm_lök_£l_d©a
 
d©a
[
IEEE80211_MLD_MAX_NUM_LINKS
];

621 
ußbÀ_löks
 = 
	`õì80211_vif_ußbÀ_löks
(
vif
);

622 
u32
 
max_a˘ive_löks
 = 
	`iwl_mvm_max_a˘ive_löks
(
mvm
, 
vif
);

623 
u16
 
√w_a˘ive_löks
;

624 
u8
 
lök_id
, 
n_d©a
 = 0, 
i
, 
j
;

626 i‡(!
IWL_MVM_AUTO_EML_ENABLE
)

629 i‡(!
	`õì80211_vif_is_mld
(
vif
Ë|| 
ußbÀ_löks
 == 1)

635 
	`WARN_ON_ONCE
(
max_a˘ive_löks
 > 2);

640 i‡(
max_a˘ive_löks
 =1 && !
vÆid_löks_ch™ged
)

646 i‡(
	`hweight16
(
vif
->
a˘ive_löks
Ë=
max_a˘ive_löks
)

649 
	`rcu_ªad_lock
();

651 
	`f‹_óch_£t_bô
(
lök_id
, &
ußbÀ_löks
, 
IEEE80211_MLD_MAX_NUM_LINKS
) {

652 
õì80211_bss_c⁄f
 *
lök_c⁄f
 =

653 
	`rcu_dîe„ªn˚
(
vif
->
lök_c⁄f
[
lök_id
]);

655 i‡(
	`WARN_ON_ONCE
(!
lök_c⁄f
))

658 
d©a
[
n_d©a
].
lök_id
 =Üink_id;

659 
d©a
[
n_d©a
].
b™d
 = 
lök_c⁄f
->
ch™ªq
.
›î
.
ch™
->band;

660 
d©a
[
n_d©a
].
width
 = 
lök_c⁄f
->
ch™ªq
.
›î
.width;

661 
d©a
[
n_d©a
].
a˘ive
 = 
vif
->
a˘ive_löks
 & 
	`BIT
(
lök_id
);

662 
n_d©a
++;

665 
	`rcu_ªad_u∆ock
();

668 i‡(
n_d©a
 == 1)

671 
√w_a˘ive_löks
 = 0;

676 i‡(!
vÆid_löks_ch™ged
) {

677 
i
 = 0; i < 
n_d©a
; i++) {

678 i‡(
d©a
[
i
].
a˘ive
)

682 i‡(
	`WARN_ON_ONCE
(
i
 =
n_d©a
))

685 
j
 = 0; j < 
n_d©a
; j++) {

686 i‡(
i
 =
j
)

689 i‡(
	`iwl_mvm_mld_vÆid_lök_∑ú
(&
d©a
[
i
], &d©a[
j
]))

693 i‡(
j
 !
n_d©a
)

694 
√w_a˘ive_löks
 = 
	`BIT
(
d©a
[
i
].
lök_id
) |

695 
	`BIT
(
d©a
[
j
].
lök_id
);

700 
i
 = 0; i < 
n_d©a
; i++) {

701 
j
 = 0; j < 
n_d©a
; j++) {

702 i‡(
i
 =
j
)

705 i‡(
	`iwl_mvm_mld_vÆid_lök_∑ú
(&
d©a
[
i
],

706 &
d©a
[
j
]))

711 i‡(
j
 !
n_d©a
) {

712 
√w_a˘ive_löks
 = 
	`BIT
(
d©a
[
i
].
lök_id
) |

713 
	`BIT
(
d©a
[
j
].
lök_id
);

719 i‡(!
√w_a˘ive_löks
)

722 i‡(
vif
->
a˘ive_löks
 !
√w_a˘ive_löks
)

723 
	`õì80211_£t_a˘ive_löks_async
(
vif
, 
√w_a˘ive_löks
);

724 
	}
}

727 
	$iwl_mvm_mld_lök_öfo_ch™ged_°©i⁄
(
iwl_mvm
 *
mvm
,

728 
õì80211_vif
 *
vif
,

729 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

730 
u64
 
ch™ges
)

732 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

733 
boﬁ
 
has_he
, 
has_eht
;

734 
u32
 
lök_ch™ges
 = 0;

735 
ªt
;

737 i‡(
	`WARN_ON_ONCE
(!
mvmvif
->
lök
[
lök_c⁄f
->
lök_id
]))

740 
has_he
 = 
lök_c⁄f
->
he_suµ‹t
 && !
iwlwifi_mod_∑øms
.
dißbÀ_11ax
;

741 
has_eht
 = 
lök_c⁄f
->
eht_suµ‹t
 && !
iwlwifi_mod_∑øms
.
dißbÀ_11be
;

744 i‡(
ch™ges
 & 
BSS_CHANGED_QOS
 && 
vif
->
cfg
.
assoc
 && 
lök_c⁄f
->
qos
)

745 
lök_ch™ges
 |
LINK_CONTEXT_MODIFY_QOS_PARAMS
;

747 i‡(
ch™ges
 & 
BSS_CHANGED_ERP_SLOT
)

748 
lök_ch™ges
 |
LINK_CONTEXT_MODIFY_RATES_INFO
;

750 i‡(
vif
->
cfg
.
assoc
 && (
has_he
 || 
has_eht
)) {

751 
	`IWL_DEBUG_MAC80211
(
mvm
, "Associated in HE mode\n");

752 
lök_ch™ges
 |
LINK_CONTEXT_MODIFY_HE_PARAMS
;

756 i‡(
vif
->
cfg
.
assoc
)

757 
lök_ch™ges
 |
LINK_CONTEXT_MODIFY_EHT_PARAMS
;

759 i‡(
lök_ch™ges
) {

760 
ªt
 = 
	`iwl_mvm_lök_ch™ged
(
mvm
, 
vif
, 
lök_c⁄f
, 
lök_ch™ges
,

761 
åue
);

762 i‡(
ªt
)

763 
	`IWL_ERR
(
mvm
, "failedÅo updateÜink\n");

766 
ªt
 = 
	`iwl_mvm_mld_mac_˘xt_ch™ged
(
mvm
, 
vif
, 
Ál£
);

767 i‡(
ªt
)

768 
	`IWL_ERR
(
mvm
, "ÁûedÅÿupd©êMAC %pM\n", 
vif
->
addr
);

770 i‡(
ch™ges
 & 
BSS_CHANGED_MLD_VALID_LINKS
)

771 
	`iwl_mvm_mld_£À˘_löks
(
mvm
, 
vif
, 
åue
);

773 
	`mem˝y
(
mvmvif
->
lök
[
lök_c⁄f
->
lök_id
]->
bssid
,Üink_conf->bssid,

774 
ETH_ALEN
);

776 
	`iwl_mvm_bss_öfo_ch™ged_°©i⁄_comm⁄
(
mvm
, 
vif
, 
lök_c⁄f
, 
ch™ges
);

777 
	}
}

779 
boﬁ
 
	$iwl_mvm_mld_vif_have_vÆid_≠_°a
(
iwl_mvm_vif
 *
mvmvif
)

781 
i
;

783 
	`f‹_óch_mvm_vif_vÆid_lök
(
mvmvif
, 
i
) {

784 i‡(
mvmvif
->
lök
[
i
]->
≠_°a_id
 !
IWL_MVM_INVALID_STA
)

785  
åue
;

788  
Ál£
;

789 
	}
}

791 
	$iwl_mvm_mld_vif_dñëe_Æl_°as
(
iwl_mvm
 *
mvm
,

792 
õì80211_vif
 *
vif
)

794 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

795 
i
, 
ªt
;

797 i‡(
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
))

800 
	`f‹_óch_mvm_vif_vÆid_lök
(
mvmvif
, 
i
) {

801 
iwl_mvm_vif_lök_öfo
 *
lök
 = 
mvmvif
->lök[
i
];

803 i‡(!
lök
)

806 
	`iwl_mvm_£c_key_ªmove_≠
(
mvm
, 
vif
, 
lök
, 
i
);

807 
ªt
 = 
	`iwl_mvm_mld_rm_°a_id
(
mvm
, 
lök
->
≠_°a_id
);

808 i‡(
ªt
)

809 
	`IWL_ERR
(
mvm
, "failedÅoÑemove AP station\n");

811 
lök
->
≠_°a_id
 = 
IWL_MVM_INVALID_STA
;

813 
	}
}

815 
	$iwl_mvm_mld_vif_cfg_ch™ged_°©i⁄
(
iwl_mvm
 *
mvm
,

816 
õì80211_vif
 *
vif
,

817 
u64
 
ch™ges
)

819 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

820 
õì80211_bss_c⁄f
 *
lök_c⁄f
;

821 
boﬁ
 
¥Ÿe˘
 = 
Ál£
;

822 
i
;

823 
ªt
;

828 i‡(
ch™ges
 =
BSS_CHANGED_IDLE
)

831 
ªt
 = 
	`iwl_mvm_mld_mac_˘xt_ch™ged
(
mvm
, 
vif
, 
Ál£
);

832 i‡(
ªt
)

833 
	`IWL_ERR
(
mvm
, "ÁûedÅÿupd©êMAC %pM\n", 
vif
->
addr
);

835 
mvmvif
->
assocüãd
 = 
vif
->
cfg
.
assoc
;

837 i‡(
ch™ges
 & 
BSS_CHANGED_ASSOC
) {

838 i‡(
vif
->
cfg
.
assoc
) {

840 
	`iwl_mvm_ªque°_°©i°ics
(
mvm
, 
åue
);

841 
	`iwl_mvm_sf_upd©e
(
mvm
, 
vif
, 
Ál£
);

842 
	`iwl_mvm_powî_vif_assoc
(
mvm
, 
vif
);

844 
	`f‹_óch_mvm_vif_vÆid_lök
(
mvmvif
, 
i
) {

845 
	`mem£t
(&
mvmvif
->
lök
[
i
]->
bóc⁄_°©s
, 0,

846 (
mvmvif
->
lök
[
i
]->
bóc⁄_°©s
));

848 i‡(
vif
->
p2p
) {

849 
	`iwl_mvm_upd©e_smps
(
mvm
, 
vif
,

850 
IWL_MVM_SMPS_REQ_PROT
,

851 
IEEE80211_SMPS_DYNAMIC
, 
i
);

854 
	`rcu_ªad_lock
();

855 
lök_c⁄f
 = 
	`rcu_dîe„ªn˚
(
vif
->lök_c⁄f[
i
]);

856 i‡(
lök_c⁄f
 && !lök_c⁄f->
dtim_≥riod
)

857 
¥Ÿe˘
 = 
åue
;

858 
	`rcu_ªad_u∆ock
();

861 i‡(!
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
) &&

862 
¥Ÿe˘
) {

866 
lök_id
 =

867 
	`ffs
(
vif
->
a˘ive_löks
) - 1;

878 
	`iwl_mvm_¥Ÿe˘_assoc
(
mvm
, 
vif
, 0, 
lök_id
);

881 
	`iwl_mvm_sf_upd©e
(
mvm
, 
vif
, 
Ál£
);

884 
	`iwl_mvm_powî_vif_assoc
(
mvm
, 
vif
);

885 } i‡(
	`iwl_mvm_mld_vif_have_vÆid_≠_°a
(
mvmvif
)) {

886 
	`iwl_mvm_mei_ho°_dißssocüãd
(
mvm
);

891 
ªt
 = 
	`iwl_mvm_sf_upd©e
(
mvm
, 
vif
, 
Ál£
);

892 
	`WARN_ONCE
(
ªt
 &&

893 !
	`ã°_bô
(
IWL_MVM_STATUS_HW_RESTART_REQUESTED
,

894 &
mvm
->
°©us
),

904 
	`iwl_mvm_mld_vif_dñëe_Æl_°as
(
mvm
, 
vif
);

907 
	`iwl_mvm_bss_öfo_ch™ged_°©i⁄_assoc
(
mvm
, 
vif
, 
ch™ges
);

910 i‡(
ch™ges
 & 
BSS_CHANGED_PS
) {

911 
ªt
 = 
	`iwl_mvm_powî_upd©e_mac
(
mvm
);

912 i‡(
ªt
)

913 
	`IWL_ERR
(
mvm
, "failedÅo updateÖower mode\n");

915 
	}
}

918 
	$iwl_mvm_mld_lök_öfo_ch™ged_≠_ibss
(
iwl_mvm
 *
mvm
,

919 
õì80211_vif
 *
vif
,

920 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

921 
u64
 
ch™ges
)

923 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

924 
u32
 
lök_ch™ges
 = 
LINK_CONTEXT_MODIFY_PROTECT_FLAGS
 |

925 
LINK_CONTEXT_MODIFY_QOS_PARAMS
;

928 i‡(!
mvmvif
->
≠_ibss_a˘ive
)

931 i‡(
lök_c⁄f
->
he_suµ‹t
)

932 
lök_ch™ges
 |
LINK_CONTEXT_MODIFY_HE_PARAMS
;

934 i‡(
ch™ges
 & 
BSS_CHANGED_ERP_SLOT
)

935 
lök_ch™ges
 |
LINK_CONTEXT_MODIFY_RATES_INFO
;

937 i‡(
ch™ges
 & (
BSS_CHANGED_ERP_CTS_PROT
 | 
BSS_CHANGED_ERP_SLOT
 |

938 
BSS_CHANGED_HT
 |

939 
BSS_CHANGED_BANDWIDTH
 | 
BSS_CHANGED_QOS
 |

940 
BSS_CHANGED_HE_BSS_COLOR
) &&

941 
	`iwl_mvm_lök_ch™ged
(
mvm
, 
vif
, 
lök_c⁄f
,

942 
lök_ch™ges
, 
åue
))

943 
	`IWL_ERR
(
mvm
, "ÁûedÅÿupd©êMAC %pM\n", 
vif
->
addr
);

946 i‡(
ch™ges
 & 
BSS_CHANGED_BEACON
 &&

947 
	`iwl_mvm_mac_˘xt_bóc⁄_ch™ged
(
mvm
, 
vif
, 
lök_c⁄f
))

948 
	`IWL_WARN
(
mvm
, "Failed updating beacon data\n");

951 i‡(
ch™ges
 & 
BSS_CHANGED_FTM_RESPONDER
) {

952 
ªt
 = 
	`iwl_mvm_·m_°¨t_ª•⁄dî
(
mvm
, 
vif
, 
lök_c⁄f
);

954 i‡(
ªt
)

955 
	`IWL_WARN
(
mvm
, "FailedÅoÉnable FTMÑesponder (%d)\n",

956 
ªt
);

958 
	}
}

960 
	$iwl_mvm_mld_lök_öfo_ch™ged
(
õì80211_hw
 *
hw
,

961 
õì80211_vif
 *
vif
,

962 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

963 
u64
 
ch™ges
)

965 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

967 
	`muãx_lock
(&
mvm
->
muãx
);

969 
vif
->
ty≥
) {

970 
NL80211_IFTYPE_STATION
:

971 
	`iwl_mvm_mld_lök_öfo_ch™ged_°©i⁄
(
mvm
, 
vif
, 
lök_c⁄f
,

972 
ch™ges
);

974 
NL80211_IFTYPE_AP
:

975 
NL80211_IFTYPE_ADHOC
:

976 
	`iwl_mvm_mld_lök_öfo_ch™ged_≠_ibss
(
mvm
, 
vif
, 
lök_c⁄f
,

977 
ch™ges
);

979 
NL80211_IFTYPE_MONITOR
:

980 i‡(
ch™ges
 & 
BSS_CHANGED_MU_GROUPS
)

981 
	`iwl_mvm_upd©e_mu_groups
(
mvm
, 
vif
);

985 
	`WARN_ON_ONCE
(1);

988 i‡(
ch™ges
 & 
BSS_CHANGED_TXPOWER
) {

989 
	`IWL_DEBUG_CALIB
(
mvm
, "Changing TX PowerÅo %d dBm\n",

990 
lök_c⁄f
->
txpowî
);

991 
	`iwl_mvm_£t_tx_powî
(
mvm
, 
vif
, 
lök_c⁄f
->
txpowî
);

994 
	`muãx_u∆ock
(&
mvm
->
muãx
);

995 
	}
}

997 
	$iwl_mvm_mld_vif_cfg_ch™ged
(
õì80211_hw
 *
hw
,

998 
õì80211_vif
 *
vif
,

999 
u64
 
ch™ges
)

1001 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

1003 
	`muãx_lock
(&
mvm
->
muãx
);

1005 i‡(
ch™ges
 & 
BSS_CHANGED_IDLE
 && !
vif
->
cfg
.
idÀ
)

1006 
	`iwl_mvm_sˇn_°›
(
mvm
, 
IWL_MVM_SCAN_SCHED
, 
åue
);

1008 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
)

1009 
	`iwl_mvm_mld_vif_cfg_ch™ged_°©i⁄
(
mvm
, 
vif
, 
ch™ges
);

1011 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1012 
	}
}

1015 
	$iwl_mvm_mld_swôch_vif_ch™˘x
(
õì80211_hw
 *
hw
,

1016 
õì80211_vif_ch™˘x_swôch
 *
vifs
,

1017 
n_vifs
,

1018 
õì80211_ch™˘x_swôch_mode
 
mode
)

1020 c⁄° 
iwl_mvm_swôch_vif_ch™˘x_›s
 
›s
 = {

1021 .
__assign_vif_ch™˘x
 = 
__iwl_mvm_mld_assign_vif_ch™˘x
,

1022 .
__u«ssign_vif_ch™˘x
 = 
__iwl_mvm_mld_u«ssign_vif_ch™˘x
,

1025  
	`iwl_mvm_swôch_vif_ch™˘x_comm⁄
(
hw
, 
vifs
, 
n_vifs
, 
mode
, &
›s
);

1026 
	}
}

1028 
	$iwl_mvm_mld_c⁄fig_iÁ˚_fûãr
(
õì80211_hw
 *
hw
,

1029 
õì80211_vif
 *
vif
,

1030 
fûãr_Êags
,

1031 
ch™ged_Êags
)

1033 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

1036 i‡(!(
ch™ged_Êags
 & 
FIF_PROBE_REQ
))

1040 i‡(
vif
->
ty≥
 !
NL80211_IFTYPE_STATION
 || !vif->
cfg
.
assoc
 ||

1041 !
vif
->
p2p
)

1044 
	`muãx_lock
(&
mvm
->
muãx
);

1045 
	`iwl_mvm_mld_mac_˘xt_ch™ged
(
mvm
, 
vif
, 
Ál£
);

1046 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1047 
	}
}

1050 
	$iwl_mvm_mld_mac_c⁄f_tx
(
õì80211_hw
 *
hw
,

1051 
õì80211_vif
 *
vif
,

1052 
lök_id
, 
u16
 
ac
,

1053 c⁄° 
õì80211_tx_queue_∑øms
 *
∑øms
)

1055 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

1056 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1057 
iwl_mvm_vif_lök_öfo
 *
mvm_lök
 = 
mvmvif
->
lök
[
lök_id
];

1059 i‡(!
mvm_lök
)

1060  -
EINVAL
;

1062 
mvm_lök
->
queue_∑øms
[
ac
] = *
∑øms
;

1067 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_P2P_DEVICE
) {

1068 
ªt
;

1070 
	`muãx_lock
(&
mvm
->
muãx
);

1071 
ªt
 = 
	`iwl_mvm_lök_ch™ged
(
mvm
, 
vif
, &vif->
bss_c⁄f
,

1072 
LINK_CONTEXT_MODIFY_QOS_PARAMS
,

1073 
åue
);

1074 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1075  
ªt
;

1078 
	}
}

1080 
	$iwl_mvm_mld_roc_lök
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

1082 
ªt
;

1084 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1087 
ªt
 = 
	`iwl_mvm_lök_ch™ged
(
mvm
, 
vif
, &vif->
bss_c⁄f
, 0, 
Ál£
);

1088 i‡(
	`WARN
(
ªt
, "FailedÅo set PHY context ID\n"))

1089  
ªt
;

1091 
ªt
 = 
	`iwl_mvm_lök_ch™ged
(
mvm
, 
vif
, &vif->
bss_c⁄f
,

1092 
LINK_CONTEXT_MODIFY_ACTIVE
 |

1093 
LINK_CONTEXT_MODIFY_RATES_INFO
,

1094 
åue
);

1096 i‡(
	`WARN
(
ªt
, "FailedÜinking P2P_DEVICE\n"))

1097  
ªt
;

1102  
	`iwl_mvm_mld_add_bˇ°_°a
(
mvm
, 
vif
, &vif->
bss_c⁄f
);

1103 
	}
}

1105 
	$iwl_mvm_mld_roc
(
õì80211_hw
 *
hw
, 
õì80211_vif
 *
vif
,

1106 
õì80211_ch™√l
 *
ch™√l
, 
duøti⁄
,

1107 
õì80211_roc_ty≥
 
ty≥
)

1109 c⁄° 
iwl_mvm_roc_›s
 
›s
 = {

1110 .
add_aux_°a_f‹_hs20
 = 
iwl_mvm_mld_add_aux_°a
,

1111 .
lök
 = 
iwl_mvm_mld_roc_lök
,

1114  
	`iwl_mvm_roc_comm⁄
(
hw
, 
vif
, 
ch™√l
, 
duøti⁄
, 
ty≥
, &
›s
);

1115 
	}
}

1118 
	$iwl_mvm_mld_ch™ge_vif_löks
(
õì80211_hw
 *
hw
,

1119 
õì80211_vif
 *
vif
,

1120 
u16
 
ﬁd_löks
, u16 
√w_löks
,

1121 
õì80211_bss_c⁄f
 *
ﬁd
[
IEEE80211_MLD_MAX_NUM_LINKS
])

1123 
iwl_mvm_vif_lök_öfo
 *
√w_lök
[
IEEE80211_MLD_MAX_NUM_LINKS
] = {};

1124 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1125 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

1126 
u16
 
ªmoved
 = 
ﬁd_löks
 & ~
√w_löks
;

1127 
u16
 
added
 = 
√w_löks
 & ~
ﬁd_löks
;

1128 
îr
, 
i
;

1130 
i
 = 0; i < 
IEEE80211_MLD_MAX_NUM_LINKS
; i++) {

1131 
r
;

1133 i‡(
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
))

1136 i‡(!(
added
 & 
	`BIT
(
i
)))

1138 
√w_lök
[
i
] = 
	`kzÆloc
((*√w_lök[i]), 
GFP_KERNEL
);

1139 i‡(!
√w_lök
[
i
]) {

1140 
îr
 = -
ENOMEM
;

1141 
‰ì
;

1144 
√w_lök
[
i
]->
bˇ°_°a
.
°a_id
 = 
IWL_MVM_INVALID_STA
;

1145 
√w_lök
[
i
]->
mˇ°_°a
.
°a_id
 = 
IWL_MVM_INVALID_STA
;

1146 
√w_lök
[
i
]->
≠_°a_id
 = 
IWL_MVM_INVALID_STA
;

1147 
√w_lök
[
i
]->
fw_lök_id
 = 
IWL_MVM_FW_LINK_ID_INVALID
;

1149 
r
 = 0;Ñ < 
NUM_IWL_MVM_SMPS_REQ
;Ñ++)

1150 
√w_lök
[
i
]->
smps_ªque°s
[
r
] =

1151 
IEEE80211_SMPS_AUTOMATIC
;

1154 
	`muãx_lock
(&
mvm
->
muãx
);

1156 i‡(
ﬁd_löks
 == 0) {

1157 
îr
 = 
	`iwl_mvm_dißbÀ_lök
(
mvm
, 
vif
, &vif->
bss_c⁄f
);

1158 i‡(
îr
)

1159 
out_îr
;

1160 
mvmvif
->
lök
[0] = 
NULL
;

1163 
i
 = 0; i < 
IEEE80211_MLD_MAX_NUM_LINKS
; i++) {

1164 i‡(
ªmoved
 & 
	`BIT
(
i
)) {

1165 
õì80211_bss_c⁄f
 *
lök_c⁄f
 = 
ﬁd
[
i
];

1167 
îr
 = 
	`iwl_mvm_dißbÀ_lök
(
mvm
, 
vif
, 
lök_c⁄f
);

1168 i‡(
îr
)

1169 
out_îr
;

1170 
	`k‰ì
(
mvmvif
->
lök
[
i
]);

1171 
mvmvif
->
lök
[
i
] = 
NULL
;

1172 } i‡(
added
 & 
	`BIT
(
i
)) {

1173 
õì80211_bss_c⁄f
 *
lök_c⁄f
;

1175 
lök_c⁄f
 = 
	`lök_c⁄f_dîe„ªn˚_¥Ÿe˘ed
(
vif
, 
i
);

1176 i‡(
	`WARN_ON
(!
lök_c⁄f
))

1179 i‡(!
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
,

1180 &
mvm
->
°©us
))

1181 
mvmvif
->
lök
[
i
] = 
√w_lök
[i];

1182 
√w_lök
[
i
] = 
NULL
;

1183 
îr
 = 
	`iwl_mvm_add_lök
(
mvm
, 
vif
, 
lök_c⁄f
);

1184 i‡(
îr
)

1185 
out_îr
;

1189 
îr
 = 0;

1190 i‡(
√w_löks
 == 0) {

1191 
mvmvif
->
lök
[0] = &mvmvif->
deÊök
;

1192 
îr
 = 
	`iwl_mvm_add_lök
(
mvm
, 
vif
, &vif->
bss_c⁄f
);

1195 
out_îr
:

1197 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1199 
‰ì
:

1200 
i
 = 0; i < 
IEEE80211_MLD_MAX_NUM_LINKS
; i++)

1201 
	`k‰ì
(
√w_lök
[
i
]);

1202  
îr
;

1203 
	}
}

1206 
	$iwl_mvm_mld_ch™ge_°a_löks
(
õì80211_hw
 *
hw
,

1207 
õì80211_vif
 *
vif
,

1208 
õì80211_°a
 *
°a
,

1209 
u16
 
ﬁd_löks
, u16 
√w_löks
)

1211 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

1212 
ªt
;

1214 
	`muãx_lock
(&
mvm
->
muãx
);

1215 
ªt
 = 
	`iwl_mvm_mld_upd©e_°a_löks
(
mvm
, 
vif
, 
°a
, 
ﬁd_löks
, 
√w_löks
);

1216 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1218  
ªt
;

1219 
	}
}

1226 
	$iwl_mvm_mld_gë_¥im¨y_lök
(
iwl_mvm
 *
mvm
,

1227 
õì80211_vif
 *
vif
,

1228 
ußbÀ_löks
)

1230 
iwl_mvm_lök_£l_d©a
 
d©a
[
IEEE80211_MLD_MAX_NUM_LINKS
];

1231 
u8
 
lök_id
, 
n_d©a
 = 0;

1233 i‡(!
	`õì80211_vif_is_mld
(
vif
Ë|| !vif->
cfg
.
assoc
)

1236 
	`f‹_óch_£t_bô
(
lök_id
, &
ußbÀ_löks
, 
IEEE80211_MLD_MAX_NUM_LINKS
) {

1237 
õì80211_bss_c⁄f
 *
lök_c⁄f
 =

1238 
	`lök_c⁄f_dîe„ªn˚_¥Ÿe˘ed
(
vif
, 
lök_id
);

1240 i‡(
	`WARN_ON_ONCE
(!
lök_c⁄f
))

1243 
d©a
[
n_d©a
].
lök_id
 =Üink_id;

1244 
d©a
[
n_d©a
].
b™d
 = 
lök_c⁄f
->
ch™ªq
.
›î
.
ch™
->band;

1245 
d©a
[
n_d©a
].
width
 = 
lök_c⁄f
->
ch™ªq
.
›î
.width;

1246 
d©a
[
n_d©a
].
a˘ive
 = 
åue
;

1247 
n_d©a
++;

1250 i‡(
n_d©a
 <= 1)

1254 
	`WARN_ON_ONCE
(
n_d©a
 > 2);

1257 i‡(
d©a
[0].
width
 > data[1].width)

1258  
d©a
[0].
lök_id
;

1259 i‡(
d©a
[0].
width
 < data[1].width)

1260  
d©a
[1].
lök_id
;

1261 i‡(
d©a
[0].
b™d
 >= data[1].band)

1262  
d©a
[0].
lök_id
;

1264  
d©a
[1].
lök_id
;

1265 
	}
}

1271 
boﬁ
 
	$iwl_mvm_ˇn_íãr_e§
(
iwl_mvm
 *
mvm
,

1272 
õì80211_vif
 *
vif
,

1273 
desúed_löks
)

1275 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1276 
¥im¨y_lök
 = 
	`iwl_mvm_mld_gë_¥im¨y_lök
(
mvm
, 
vif
,

1277 
desúed_löks
);

1278 c⁄° 
wùhy_i·y≥_ext_ˇ∑b
 *
ext_ˇ∑
;

1279 
boﬁ
 
ªt
 = 
åue
;

1280 
lök_id
;

1282 i‡(
¥im¨y_lök
 < 0)

1283  
Ál£
;

1285 i‡(!(
vif
->
cfg
.
eml_ˇp
 & 
IEEE80211_EML_CAP_EMLSR_SUPP
))

1286  
Ál£
;

1288 
ext_ˇ∑
 = 
	`cfg80211_gë_i·y≥_ext_ˇ∑
(
mvm
->
hw
->
wùhy
,

1289 
	`õì80211_vif_ty≥_p2p
(
vif
));

1290 i‡(!
ext_ˇ∑
 ||

1291 !(
ext_ˇ∑
->
eml_ˇ∑bûôõs
 & 
IEEE80211_EML_CAP_EMLSR_SUPP
))

1292  
Ál£
;

1294 
	`f‹_óch_£t_bô
(
lök_id
, &
desúed_löks
, 
IEEE80211_MLD_MAX_NUM_LINKS
) {

1295 
õì80211_bss_c⁄f
 *
lök_c⁄f
 =

1296 
	`lök_c⁄f_dîe„ªn˚_¥Ÿe˘ed
(
vif
, 
lök_id
);

1298 i‡(
	`WARN_ON_ONCE
(!
lök_c⁄f
))

1302 i‡(
lök_c⁄f
->
ch™ªq
.
›î
.
ch™
->
b™d
 !
NL80211_BAND_2GHZ
)

1305 
ªt
 = 
	`iwl_mvm_bt_c€x_ˇlcuœã_e§_mode
(
mvm
, 
vif
, 
lök_id
,

1306 
¥im¨y_lök
);

1308 i‡(!
ªt
)

1309 
mvmvif
->
bt_c€x_e§_dißbÀd
 = 
åue
;

1313  
ªt
;

1314 
	}
}

1316 
boﬁ
 
	$iwl_mvm_mld_ˇn_a˘iv©e_löks
(
õì80211_hw
 *
hw
,

1317 
õì80211_vif
 *
vif
,

1318 
u16
 
desúed_löks
)

1320 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

1321 
n_löks
 = 
	`hweight16
(
desúed_löks
);

1322 
boﬁ
 
ªt
 = 
åue
;

1324 i‡(
n_löks
 <= 1)

1325  
åue
;

1327 
	`muãx_lock
(&
mvm
->
muãx
);

1330 i‡(
n_löks
 > 
	`iwl_mvm_max_a˘ive_löks
(
mvm
, 
vif
)) {

1331 
ªt
 = 
Ál£
;

1332 
u∆ock
;

1336 i‡(
	`iwl_mvm_is_e§_suµ‹ãd
(
mvm
->
fwπ
.
å™s
))

1337 
ªt
 = 
	`iwl_mvm_ˇn_íãr_e§
(
mvm
, 
vif
, 
desúed_löks
);

1338 
u∆ock
:

1339 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1340  
ªt
;

1341 
	}
}

1343 
õì80211_√g_âlm_ªs


1344 
	$iwl_mvm_mld_ˇn_√g_âlm
(
õì80211_hw
 *
hw
, 
õì80211_vif
 *
vif
,

1345 
õì80211_√g_âlm
 *
√g_âlm
)

1347 
u16
 
m≠
;

1348 
u8
 
i
;

1351 
m≠
 = 
√g_âlm
->
dow∆ök
[0];

1352 
i
 = 0; i < 
IEEE80211_TTLM_NUM_TIDS
; i++) {

1353 i‡(
√g_âlm
->
dow∆ök
[
i
] !√g_âlm->
u∂ök
[i] ||

1354 
√g_âlm
->
u∂ök
[
i
] !
m≠
)

1355  
NEG_TTLM_RES_REJECT
;

1358  
NEG_TTLM_RES_ACCEPT
;

1359 
	}
}

1361 c⁄° 
õì80211_›s
 
	giwl_mvm_mld_hw_›s
 = {

1362 .
tx
 = 
iwl_mvm_mac_tx
,

1363 .
	gwake_tx_queue
 = 
iwl_mvm_mac_wake_tx_queue
,

1364 .
	gampdu_a˘i⁄
 = 
iwl_mvm_mac_ampdu_a˘i⁄
,

1365 .
	ggë_™ã¬a
 = 
iwl_mvm_›_gë_™ã¬a
,

1366 .
	g£t_™ã¬a
 = 
iwl_mvm_›_£t_™ã¬a
,

1367 .
	g°¨t
 = 
iwl_mvm_mac_°¨t
,

1368 .
	gªc⁄fig_com∂ëe
 = 
iwl_mvm_mac_ªc⁄fig_com∂ëe
,

1369 .
	g°›
 = 
iwl_mvm_mac_°›
,

1370 .
	gadd_öãrÁ˚
 = 
iwl_mvm_mld_mac_add_öãrÁ˚
,

1371 .
	gªmove_öãrÁ˚
 = 
iwl_mvm_mld_mac_ªmove_öãrÁ˚
,

1372 .
	gc⁄fig
 = 
iwl_mvm_mac_c⁄fig
,

1373 .
	g¥ï¨e_mu…iˇ°
 = 
iwl_mvm_¥ï¨e_mu…iˇ°
,

1374 .
	gc⁄figuª_fûãr
 = 
iwl_mvm_c⁄figuª_fûãr
,

1375 .
	gc⁄fig_iÁ˚_fûãr
 = 
iwl_mvm_mld_c⁄fig_iÁ˚_fûãr
,

1376 .
	glök_öfo_ch™ged
 = 
iwl_mvm_mld_lök_öfo_ch™ged
,

1377 .
	gvif_cfg_ch™ged
 = 
iwl_mvm_mld_vif_cfg_ch™ged
,

1378 .
	ghw_sˇn
 = 
iwl_mvm_mac_hw_sˇn
,

1379 .
	gˇn˚l_hw_sˇn
 = 
iwl_mvm_mac_ˇn˚l_hw_sˇn
,

1380 .
	g°a_¥e_rcu_ªmove
 = 
iwl_mvm_°a_¥e_rcu_ªmove
,

1381 .
	g°a_°©e
 = 
iwl_mvm_mld_mac_°a_°©e
,

1382 .
	g°a_nŸify
 = 
iwl_mvm_mac_°a_nŸify
,

1383 .
	gÆlow_buf„ªd_‰ames
 = 
iwl_mvm_mac_Ælow_buf„ªd_‰ames
,

1384 .
	gªÀa£_buf„ªd_‰ames
 = 
iwl_mvm_mac_ªÀa£_buf„ªd_‰ames
,

1385 .
	g£t_πs_thªshﬁd
 = 
iwl_mvm_mac_£t_πs_thªshﬁd
,

1386 .
	g°a_rc_upd©e
 = 
iwl_mvm_°a_rc_upd©e
,

1387 .
	gc⁄f_tx
 = 
iwl_mvm_mld_mac_c⁄f_tx
,

1388 .
	gmgd_¥ï¨e_tx
 = 
iwl_mvm_mac_mgd_¥ï¨e_tx
,

1389 .
	gmgd_com∂ëe_tx
 = 
iwl_mvm_mac_mgd_com∂ëe_tx
,

1390 .
	gmgd_¥Ÿe˘_tdls_discovî
 = 
iwl_mvm_mac_mgd_¥Ÿe˘_tdls_discovî
,

1391 .
	gÊush
 = 
iwl_mvm_mac_Êush
,

1392 .
	gÊush_°a
 = 
iwl_mvm_mac_Êush_°a
,

1393 .
	gsched_sˇn_°¨t
 = 
iwl_mvm_mac_sched_sˇn_°¨t
,

1394 .
	gsched_sˇn_°›
 = 
iwl_mvm_mac_sched_sˇn_°›
,

1395 .
	g£t_key
 = 
iwl_mvm_mac_£t_key
,

1396 .
	gupd©e_tkù_key
 = 
iwl_mvm_mac_upd©e_tkù_key
,

1397 .
	gªmaö_⁄_ch™√l
 = 
iwl_mvm_mld_roc
,

1398 .
	gˇn˚l_ªmaö_⁄_ch™√l
 = 
iwl_mvm_ˇn˚l_roc
,

1399 .
	gadd_ch™˘x
 = 
iwl_mvm_add_ch™˘x
,

1400 .
	gªmove_ch™˘x
 = 
iwl_mvm_ªmove_ch™˘x
,

1401 .
	gch™ge_ch™˘x
 = 
iwl_mvm_ch™ge_ch™˘x
,

1402 .
	gassign_vif_ch™˘x
 = 
iwl_mvm_mld_assign_vif_ch™˘x
,

1403 .
	gu«ssign_vif_ch™˘x
 = 
iwl_mvm_mld_u«ssign_vif_ch™˘x
,

1404 .
	gswôch_vif_ch™˘x
 = 
iwl_mvm_mld_swôch_vif_ch™˘x
,

1406 .
	g°¨t_≠
 = 
iwl_mvm_mld_°¨t_≠
,

1407 .
	g°›_≠
 = 
iwl_mvm_mld_°›_≠
,

1408 .
	gjoö_ibss
 = 
iwl_mvm_mld_°¨t_ibss
,

1409 .
	gÀave_ibss
 = 
iwl_mvm_mld_°›_ibss
,

1411 .
	gtx_œ°_bóc⁄
 = 
iwl_mvm_tx_œ°_bóc⁄
,

1413 .
	gch™√l_swôch
 = 
iwl_mvm_ch™√l_swôch
,

1414 .
	g¥e_ch™√l_swôch
 = 
iwl_mvm_¥e_ch™√l_swôch
,

1415 .
	gpo°_ch™√l_swôch
 = 
iwl_mvm_po°_ch™√l_swôch
,

1416 .
	gab‹t_ch™√l_swôch
 = 
iwl_mvm_ab‹t_ch™√l_swôch
,

1417 .
	gch™√l_swôch_rx_bóc⁄
 = 
iwl_mvm_ch™√l_swôch_rx_bóc⁄
,

1419 .
	gtdls_ch™√l_swôch
 = 
iwl_mvm_tdls_ch™√l_swôch
,

1420 .
	gtdls_ˇn˚l_ch™√l_swôch
 = 
iwl_mvm_tdls_ˇn˚l_ch™√l_swôch
,

1421 .
	gtdls_ªcv_ch™√l_swôch
 = 
iwl_mvm_tdls_ªcv_ch™√l_swôch
,

1423 .
	gevít_ˇŒback
 = 
iwl_mvm_mac_evít_ˇŒback
,

1425 .
	gsync_rx_queues
 = 
iwl_mvm_sync_rx_queues
,

1427 
CFG80211_TESTMODE_CMD
(
iwl_mvm_mac_ã°mode_cmd
)

1429 #ifde‡
CONFIG_PM_SLEEP


1431 .
	gsu•íd
 = 
iwl_mvm_su•íd
,

1432 .
	gªsume
 = 
iwl_mvm_ªsume
,

1433 .
	g£t_wakeup
 = 
iwl_mvm_£t_wakeup
,

1434 .
	g£t_ªkey_d©a
 = 
iwl_mvm_£t_ªkey_d©a
,

1435 #i‡
IS_ENABLED
(
CONFIG_IPV6
)

1436 .
	gùv6_addr_ch™ge
 = 
iwl_mvm_ùv6_addr_ch™ge
,

1438 .
	g£t_deÁu…_uniˇ°_key
 = 
iwl_mvm_£t_deÁu…_uniˇ°_key
,

1440 .
	ggë_survey
 = 
iwl_mvm_mac_gë_survey
,

1441 .
	g°a_°©i°ics
 = 
iwl_mvm_mac_°a_°©i°ics
,

1442 .
	ggë_·m_ª•⁄dî_°©s
 = 
iwl_mvm_mac_gë_·m_ª•⁄dî_°©s
,

1443 .
	g°¨t_pm§
 = 
iwl_mvm_°¨t_pm§
,

1444 .
	gab‹t_pm§
 = 
iwl_mvm_ab‹t_pm§
,

1446 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


1447 .
	gvif_add_debugfs
 = 
iwl_mvm_vif_add_debugfs
,

1448 .
	glök_add_debugfs
 = 
iwl_mvm_lök_add_debugfs
,

1449 .
	glök_°a_add_debugfs
 = 
iwl_mvm_lök_°a_add_debugfs
,

1451 .
	g£t_hw_time°amp
 = 
iwl_mvm_£t_hw_time°amp
,

1453 .
	gch™ge_vif_löks
 = 
iwl_mvm_mld_ch™ge_vif_löks
,

1454 .
	gch™ge_°a_löks
 = 
iwl_mvm_mld_ch™ge_°a_löks
,

1455 .
	gˇn_a˘iv©e_löks
 = 
iwl_mvm_mld_ˇn_a˘iv©e_löks
,

1456 .
	gˇn_√g_âlm
 = 
iwl_mvm_mld_ˇn_√g_âlm
,

	@mld-sta.c

5 
	~"mvm.h
"

6 
	~"time-sync.h
"

7 
	~"°a.h
"

9 
u32
 
	$iwl_mvm_°a_fw_id_mask
(
iwl_mvm
 *
mvm
, 
õì80211_°a
 *
°a
,

10 
fûãr_lök_id
)

12 
iwl_mvm_°a
 *
mvm°a
;

13 
lök_id
;

14 
u32
 
ªsu…
 = 0;

16 i‡(!
°a
)

19 
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

22 i‡(!
°a
->
vÆid_löks
)

23  
	`BIT
(
mvm°a
->
deÊök
.
°a_id
);

26 
lök_id
 = 0;Üök_id < 
	`ARRAY_SIZE
(
mvm°a
->
lök
);Üink_id++) {

27 
iwl_mvm_lök_°a
 *
lök_°a
;

30 i‡(
fûãr_lök_id
 >0 && 
lök_id
 != filter_link_id)

33 
lök_°a
 =

34 
	`rcu_dîe„ªn˚_check
(
mvm°a
->
lök
[
lök_id
],

35 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

36 i‡(!
lök_°a
)

39 
ªsu…
 |
	`BIT
(
lök_°a
->
°a_id
);

42  
ªsu…
;

43 
	}
}

45 
	$iwl_mvm_mld_£nd_°a_cmd
(
iwl_mvm
 *
mvm
,

46 
iwl_mvm_°a_cfg_cmd
 *
cmd
)

48 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
,

49 
	`WIDE_ID
(
MAC_CONF_GROUP
, 
STA_CONFIG_CMD
),

50 0, (*
cmd
), cmd);

51 i‡(
ªt
)

52 
	`IWL_ERR
(
mvm
, "STA_CONFIG_CMD síd faûed,Ñë=0x%x\n", 
ªt
);

53  
ªt
;

54 
	}
}

59 
	$iwl_mvm_mld_add_öt_°a_to_fw
(
iwl_mvm
 *
mvm
,

60 
iwl_mvm_öt_°a
 *
°a
,

61 c⁄° 
u8
 *
addr
, 
lök_id
)

63 
iwl_mvm_°a_cfg_cmd
 
cmd
;

65 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

67 
	`mem£t
(&
cmd
, 0, (cmd));

68 
cmd
.
°a_id
 = 
	`˝u_to_À32
((
u8
)
°a
->sta_id);

70 
cmd
.
lök_id
 = 
	`˝u_to_À32
(link_id);

72 
cmd
.
°©i⁄_ty≥
 = 
	`˝u_to_À32
(
°a
->
ty≥
);

74 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

75 
IWL_UCODE_TLV_CAPA_STA_EXP_MFP_SUPPORT
) &&

76 
°a
->
ty≥
 =
STATION_TYPE_BCAST_MGMT
)

77 
cmd
.
mÂ
 = 
	`˝u_to_À32
(1);

79 i‡(
addr
) {

80 
	`mem˝y
(
cmd
.
≥î_mld_addªss
, 
addr
, 
ETH_ALEN
);

81 
	`mem˝y
(
cmd
.
≥î_lök_addªss
, 
addr
, 
ETH_ALEN
);

84  
	`iwl_mvm_mld_£nd_°a_cmd
(
mvm
, &
cmd
);

85 
	}
}

92 
	$iwl_mvm_mld_rm_°a_‰om_fw
(
iwl_mvm
 *
mvm
, 
u32
 
°a_id
)

94 
iwl_mvm_ªmove_°a_cmd
 
rm_°a_cmd
 = {

95 .
°a_id
 = 
	`˝u_to_À32
(sta_id),

97 
ªt
;

100 i‡(!
	`rcu_ac˚ss_poöãr
(
mvm
->
fw_id_to_mac_id
[
°a_id
])) {

101 
	`IWL_ERR
(
mvm
, "InvÆid sèti⁄ id %d\n", 
°a_id
);

102  -
EINVAL
;

105 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
	`WIDE_ID
(
MAC_CONF_GROUP
, 
STA_REMOVE_CMD
),

106 0, (
rm_°a_cmd
), &rm_sta_cmd);

107 i‡(
ªt
) {

108 
	`IWL_ERR
(
mvm
, "FaûedÅÿªmovê°©i⁄. Id=%d\n", 
°a_id
);

109  
ªt
;

113 
	}
}

115 
	$iwl_mvm_add_aux_°a_to_fw
(
iwl_mvm
 *
mvm
,

116 
iwl_mvm_öt_°a
 *
°a
,

117 
u32
 
lmac_id
)

119 
ªt
;

121 
iwl_mvm_aux_°a_cmd
 
cmd
 = {

122 .
°a_id
 = 
	`˝u_to_À32
(
°a
->sta_id),

123 .
lmac_id
 = 
	`˝u_to_À32
(lmac_id),

126 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
	`WIDE_ID
(
MAC_CONF_GROUP
, 
AUX_STA_CMD
),

127 0, (
cmd
), &cmd);

128 i‡(
ªt
)

129 
	`IWL_ERR
(
mvm
, "FailedÅo send AUX_STA_CMD\n");

130  
ªt
;

131 
	}
}

136 
	$iwl_mvm_mld_add_öt_°a_wôh_queue
(
iwl_mvm
 *
mvm
,

137 
iwl_mvm_öt_°a
 *
°a
,

138 c⁄° 
u8
 *
addr
, 
lök_id
,

139 
u16
 *
queue
, 
u8
 
tid
,

140 *
_wdg_timeout
)

142 
ªt
, 
txq
;

143 
wdg_timeout
 = 
_wdg_timeout
 ? *_wdg_timeout :

144 
mvm
->
å™s
->
å™s_cfg
->
ba£_∑øms
->
wd_timeout
;

146 i‡(
	`WARN_ON_ONCE
(
°a
->
°a_id
 =
IWL_MVM_INVALID_STA
))

147  -
ENOSPC
;

149 i‡(
°a
->
ty≥
 =
STATION_TYPE_AUX
)

150 
ªt
 = 
	`iwl_mvm_add_aux_°a_to_fw
(
mvm
, 
°a
, 
lök_id
);

152 
ªt
 = 
	`iwl_mvm_mld_add_öt_°a_to_fw
(
mvm
, 
°a
, 
addr
, 
lök_id
);

153 i‡(
ªt
)

154  
ªt
;

160 
txq
 = 
	`iwl_mvm_tvqm_íabÀ_txq
(
mvm
, 
NULL
, 
°a
->
°a_id
, 
tid
,

161 
wdg_timeout
);

162 i‡(
txq
 < 0) {

163 
	`iwl_mvm_mld_rm_°a_‰om_fw
(
mvm
, 
°a
->
°a_id
);

164  
txq
;

166 *
queue
 = 
txq
;

169 
	}
}

175 
	$iwl_mvm_mld_add_öt_°a
(
iwl_mvm
 *
mvm
,

176 
iwl_mvm_öt_°a
 *
öt_°a
, 
u16
 *
queue
,

177 
∆80211_i·y≥
 
i·y≥
,

178 
iwl_fw_°a_ty≥
 
°a_ty≥
,

179 
lök_id
, c⁄° 
u8
 *
addr
, u8 
tid
,

180 *
wdg_timeout
)

182 
ªt
;

184 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

187 
ªt
 = 
	`iwl_mvm_Æloˇã_öt_°a
(
mvm
, 
öt_°a
, 0, 
i·y≥
,

188 
°a_ty≥
);

189 i‡(
ªt
)

190  
ªt
;

192 
ªt
 = 
	`iwl_mvm_mld_add_öt_°a_wôh_queue
(
mvm
, 
öt_°a
, 
addr
, 
lök_id
,

193 
queue
, 
tid
, 
wdg_timeout
);

194 i‡(
ªt
) {

195 
	`iwl_mvm_dóŒoc_öt_°a
(
mvm
, 
öt_°a
);

196  
ªt
;

200 
	}
}

206 
	$iwl_mvm_mld_add_bˇ°_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

207 
õì80211_bss_c⁄f
 *
lök_c⁄f
)

209 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

210 
iwl_mvm_vif_lök_öfo
 *
mvm_lök
 =

211 
mvmvif
->
lök
[
lök_c⁄f
->
lök_id
];

212 
iwl_mvm_öt_°a
 *
b°a
 = &
mvm_lök
->
bˇ°_°a
;

213 c⁄° 
u8
 
_baddr
[] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF};

214 c⁄° 
u8
 *
baddr
 = 
_baddr
;

215 
wdg_timeout
 =

216 
	`iwl_mvm_gë_wd_timeout
(
mvm
, 
vif
, 
Ál£
, false);

217 
u16
 *
queue
;

219 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

221 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_ADHOC
)

222 
baddr
 = 
lök_c⁄f
->
bssid
;

224 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
 ||

225 
vif
->
ty≥
 =
NL80211_IFTYPE_ADHOC
) {

226 
queue
 = &
mvm_lök
->
mgmt_queue
;

227 } i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_P2P_DEVICE
) {

228 
queue
 = &
mvm
->
p2p_dev_queue
;

230 
	`WARN
(1, "MissingÑequired TXQ forádding bcast STA\n");

231  -
EINVAL
;

234  
	`iwl_mvm_mld_add_öt_°a
(
mvm
, 
b°a
, 
queue
,

235 
	`õì80211_vif_ty≥_p2p
(
vif
),

236 
STATION_TYPE_BCAST_MGMT
,

237 
mvm_lök
->
fw_lök_id
, 
baddr
,

238 
IWL_MAX_TID_COUNT
, &
wdg_timeout
);

239 
	}
}

245 
	$iwl_mvm_mld_add_mˇ°_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

246 
õì80211_bss_c⁄f
 *
lök_c⁄f
)

248 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

249 
iwl_mvm_vif_lök_öfo
 *
mvm_lök
 =

250 
mvmvif
->
lök
[
lök_c⁄f
->
lök_id
];

251 
iwl_mvm_öt_°a
 *
m°a
 = &
mvm_lök
->
mˇ°_°a
;

252 c⁄° 
u8
 
_maddr
[] = {0x03, 0x00, 0x00, 0x00, 0x00, 0x00};

253 c⁄° 
u8
 *
maddr
 = 
_maddr
;

254 
timeout
 = 
	`iwl_mvm_gë_wd_timeout
(
mvm
, 
vif
, 
Ál£
, false);

256 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

258 i‡(
	`WARN_ON
(
vif
->
ty≥
 !
NL80211_IFTYPE_AP
 &&

259 
vif
->
ty≥
 !
NL80211_IFTYPE_ADHOC
))

260  -
EOPNOTSUPP
;

267 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_ADHOC
)

268 
mvm_lök
->
ˇb_queue
 = 
IWL_MVM_DQA_GCAST_QUEUE
;

270  
	`iwl_mvm_mld_add_öt_°a
(
mvm
, 
m°a
, &
mvm_lök
->
ˇb_queue
,

271 
vif
->
ty≥
, 
STATION_TYPE_MCAST
,

272 
mvm_lök
->
fw_lök_id
, 
maddr
, 0,

273 &
timeout
);

274 
	}
}

279 
	$iwl_mvm_mld_add_¢if_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

280 
õì80211_bss_c⁄f
 *
lök_c⁄f
)

282 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

283 
iwl_mvm_vif_lök_öfo
 *
mvm_lök
 =

284 
mvmvif
->
lök
[
lök_c⁄f
->
lök_id
];

286 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

288  
	`iwl_mvm_mld_add_öt_°a
(
mvm
, &mvm->
¢if_°a
, &mvm->
¢if_queue
,

289 
vif
->
ty≥
, 
STATION_TYPE_BCAST_MGMT
,

290 
mvm_lök
->
fw_lök_id
, 
NULL
,

291 
IWL_MAX_TID_COUNT
, 
NULL
);

292 
	}
}

294 
	$iwl_mvm_mld_add_aux_°a
(
iwl_mvm
 *
mvm
, 
u32
 
lmac_id
)

296 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

301  
	`iwl_mvm_mld_add_öt_°a
(
mvm
, &mvm->
aux_°a
, &mvm->
aux_queue
,

302 
NL80211_IFTYPE_UNSPECIFIED
,

303 
STATION_TYPE_AUX
, 
lmac_id
, 
NULL
,

304 
IWL_MAX_TID_COUNT
, 
NULL
);

305 
	}
}

307 
	$iwl_mvm_mld_dißbÀ_txq
(
iwl_mvm
 *
mvm
, 
u32
 
°a_mask
,

308 
u16
 *
queuïå
, 
u8
 
tid
)

310 
queue
 = *
queuïå
;

311 
ªt
 = 0;

313 i‡(
tid
 =
IWL_MAX_TID_COUNT
)

314 
tid
 = 
IWL_MGMT_TID
;

316 i‡(
mvm
->
°a_ªmove_ªquúes_queue_ªmove
) {

317 
u32
 
cmd_id
 = 
	`WIDE_ID
(
DATA_PATH_GROUP
,

318 
SCD_QUEUE_CONFIG_CMD
);

319 
iwl_scd_queue_cfg_cmd
 
ªmove_cmd
 = {

320 .
›î©i⁄
 = 
	`˝u_to_À32
(
IWL_SCD_QUEUE_REMOVE
),

321 .
u
.
ªmove
.
tid
 = 
	`˝u_to_À32
(tid),

322 .
u
.
ªmove
.
°a_mask
 = 
	`˝u_to_À32
(sta_mask),

325 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
cmd_id
, 0,

326 (
ªmove_cmd
),

327 &
ªmove_cmd
);

330 
	`iwl_å™s_txq_‰ì
(
mvm
->
å™s
, 
queue
);

331 *
queuïå
 = 
IWL_MVM_INVALID_QUEUE
;

333  
ªt
;

334 
	}
}

338 
	$iwl_mvm_mld_rm_öt_°a
(
iwl_mvm
 *
mvm
,

339 
iwl_mvm_öt_°a
 *
öt_°a
,

340 
boﬁ
 
Êush
, 
u8
 
tid
, 
u16
 *
queu±r
)

342 
ªt
;

344 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

346 i‡(
	`WARN_ON_ONCE
(
öt_°a
->
°a_id
 =
IWL_MVM_INVALID_STA
))

347  -
EINVAL
;

349 i‡(
Êush
)

350 
	`iwl_mvm_Êush_°a
(
mvm
, 
öt_°a
->
°a_id
, i¡_°a->
tfd_queue_msk
);

352 
	`iwl_mvm_mld_dißbÀ_txq
(
mvm
, 
	`BIT
(
öt_°a
->
°a_id
), 
queu±r
, 
tid
);

354 
ªt
 = 
	`iwl_mvm_mld_rm_°a_‰om_fw
(
mvm
, 
öt_°a
->
°a_id
);

355 i‡(
ªt
)

356 
	`IWL_WARN
(
mvm
, "Failed sendingÑemove station\n");

358 
	`iwl_mvm_dóŒoc_öt_°a
(
mvm
, 
öt_°a
);

360  
ªt
;

361 
	}
}

363 
	$iwl_mvm_mld_rm_bˇ°_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

364 
õì80211_bss_c⁄f
 *
lök_c⁄f
)

366 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

367 
iwl_mvm_vif_lök_öfo
 *
lök
 = 
mvmvif
->lök[
lök_c⁄f
->
lök_id
];

368 
u16
 *
queuïå
;

370 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

372 i‡(
	`WARN_ON
(!
lök
))

373  -
EIO
;

375 
vif
->
ty≥
) {

376 
NL80211_IFTYPE_AP
:

377 
NL80211_IFTYPE_ADHOC
:

378 
queuïå
 = &
lök
->
mgmt_queue
;

380 
NL80211_IFTYPE_P2P_DEVICE
:

381 
queuïå
 = &
mvm
->
p2p_dev_queue
;

384 
	`WARN
(1, "Can't free bcast queue on vifÅype %d\n",

385 
vif
->
ty≥
);

386  -
EINVAL
;

389  
	`iwl_mvm_mld_rm_öt_°a
(
mvm
, &
lök
->
bˇ°_°a
,

390 
åue
, 
IWL_MAX_TID_COUNT
, 
queuïå
);

391 
	}
}

396 
	$iwl_mvm_mld_rm_mˇ°_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

397 
õì80211_bss_c⁄f
 *
lök_c⁄f
)

399 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

400 
iwl_mvm_vif_lök_öfo
 *
lök
 = 
mvmvif
->lök[
lök_c⁄f
->
lök_id
];

402 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

404 i‡(
	`WARN_ON
(!
lök
))

405  -
EIO
;

407  
	`iwl_mvm_mld_rm_öt_°a
(
mvm
, &
lök
->
mˇ°_°a
, 
åue
, 0,

408 &
lök
->
ˇb_queue
);

409 
	}
}

411 
	$iwl_mvm_mld_rm_¢if_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

413 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

415  
	`iwl_mvm_mld_rm_öt_°a
(
mvm
, &mvm->
¢if_°a
, 
Ál£
,

416 
IWL_MAX_TID_COUNT
, &
mvm
->
¢if_queue
);

417 
	}
}

419 
	$iwl_mvm_mld_rm_aux_°a
(
iwl_mvm
 *
mvm
)

421 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

423  
	`iwl_mvm_mld_rm_öt_°a
(
mvm
, &mvm->
aux_°a
, 
Ál£
,

424 
IWL_MAX_TID_COUNT
, &
mvm
->
aux_queue
);

425 
	}
}

428 
	$iwl_mvm_mld_cfg_°a
(
iwl_mvm
 *
mvm
, 
õì80211_°a
 *
°a
,

429 
õì80211_vif
 *
vif
,

430 
õì80211_lök_°a
 *
lök_°a
,

431 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

432 
iwl_mvm_lök_°a
 *
mvm_lök_°a
)

434 
iwl_mvm_°a
 *
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

435 
iwl_mvm_vif
 *
mvm_vif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

436 
iwl_mvm_vif_lök_öfo
 *
lök_öfo
 =

437 
mvm_vif
->
lök
[
lök_c⁄f
->
lök_id
];

438 
iwl_mvm_°a_cfg_cmd
 
cmd
 = {

439 .
°a_id
 = 
	`˝u_to_À32
(
mvm_lök_°a
->sta_id),

440 .
°©i⁄_ty≥
 = 
	`˝u_to_À32
(
mvm_°a
->
°a_ty≥
),

442 
u32
 
agg_size
 = 0, 
mpdu_dís
 = 0;

445 i‡(
	`WARN_ON
(
lök_öfo
->
fw_lök_id
 =
IWL_MVM_FW_LINK_ID_INVALID
))

446  -
EINVAL
;

448 
cmd
.
lök_id
 = 
	`˝u_to_À32
(
lök_öfo
->
fw_lök_id
);

450 
	`mem˝y
(&
cmd
.
≥î_mld_addªss
, 
°a
->
addr
, 
ETH_ALEN
);

451 
	`mem˝y
(&
cmd
.
≥î_lök_addªss
, 
lök_°a
->
addr
, 
ETH_ALEN
);

453 i‡(
mvm_°a
->
°a_°©e
 >
IEEE80211_STA_ASSOC
)

454 
cmd
.
assoc_id
 = 
	`˝u_to_À32
(
°a
->
aid
);

456 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

457 
IWL_UCODE_TLV_CAPA_STA_EXP_MFP_SUPPORT
) &&

458 (
°a
->
mÂ
 || 
mvm_°a
->
°a_°©e
 < 
IEEE80211_STA_AUTHORIZED
))

459 
cmd
.
mÂ
 = 
	`˝u_to_À32
(1);

461 
lök_°a
->
rx_nss
) {

463 
cmd
.
mimo
 = 
	`˝u_to_À32
(0);

466 
cmd
.
mimo
 = 
	`˝u_to_À32
(1);

470 
°a
->
deÊök
.
smps_mode
) {

471 
IEEE80211_SMPS_AUTOMATIC
:

472 
IEEE80211_SMPS_NUM_MODES
:

473 
	`WARN_ON
(1);

475 
IEEE80211_SMPS_STATIC
:

477 
cmd
.
mimo
 = 
	`˝u_to_À32
(0);

479 
IEEE80211_SMPS_DYNAMIC
:

480 
cmd
.
mimo_¥Ÿe˘i⁄
 = 
	`˝u_to_À32
(1);

482 
IEEE80211_SMPS_OFF
:

487 
mpdu_dís
 = 
	`iwl_mvm_gë_°a_ampdu_dís
(
lök_°a
, 
lök_c⁄f
, &
agg_size
);

488 
cmd
.
tx_ampdu_•acög
 = 
	`˝u_to_À32
(
mpdu_dís
);

489 
cmd
.
tx_ampdu_max_size
 = 
	`˝u_to_À32
(
agg_size
);

491 i‡(
°a
->
wme
) {

492 
cmd
.
•_Àngth
 =

493 
	`˝u_to_À32
(
°a
->
max_•
 ? sta->max_sp * 2 : 128);

494 
cmd
.
u≠sd_acs
 = 
	`˝u_to_À32
(
	`iwl_mvm_gë_°a_u≠sd_acs
(
°a
));

497 i‡(
lök_°a
->
he_ˇp
.
has_he
) {

498 
cmd
.
åig_∫d_Æloc
 =

499 
	`˝u_to_À32
(
lök_c⁄f
->
u‹a_exi°s
 ? 1 : 0);

502 
	`iwl_mvm_£t_°a_pkt_ext
(
mvm
, 
lök_°a
, &
cmd
.
pkt_ext
);

505 
cmd
.
htc_Êags
 = 
	`iwl_mvm_gë_°a_htc_Êags
(
°a
, 
lök_°a
);

507 i‡(
lök_°a
->
he_ˇp
.
he_ˇp_ñem
.
mac_ˇp_öfo
[2] &

508 
IEEE80211_HE_MAC_CAP2_ACK_EN
)

509 
cmd
.
ack_íabÀd
 = 
	`˝u_to_À32
(1);

512  
	`iwl_mvm_mld_£nd_°a_cmd
(
mvm
, &
cmd
);

513 
	}
}

515 
	$iwl_mvm_mld_‰ì_°a_lök
(
iwl_mvm
 *
mvm
,

516 
iwl_mvm_°a
 *
mvm_°a
,

517 
iwl_mvm_lök_°a
 *
mvm_°a_lök
,

518 
lök_id
,

519 
boﬁ
 
is_ö_fw
)

521 
	`RCU_INIT_POINTER
(
mvm
->
fw_id_to_mac_id
[
mvm_°a_lök
->
°a_id
],

522 
is_ö_fw
 ? 
	`ERR_PTR
(-
EINVAL
Ë: 
NULL
);

523 
	`RCU_INIT_POINTER
(
mvm
->
fw_id_to_lök_°a
[
mvm_°a_lök
->
°a_id
], 
NULL
);

524 
	`RCU_INIT_POINTER
(
mvm_°a
->
lök
[
lök_id
], 
NULL
);

526 i‡(
mvm_°a_lök
 !&
mvm_°a
->
deÊök
)

527 
	`k‰ì_rcu
(
mvm_°a_lök
, 
rcu_hód
);

528 
	}
}

530 
	$iwl_mvm_mld_°a_rm_Æl_°a_löks
(
iwl_mvm
 *
mvm
,

531 
iwl_mvm_°a
 *
mvm_°a
)

533 
lök_id
;

535 
lök_id
 = 0;Üök_id < 
	`ARRAY_SIZE
(
mvm_°a
->
lök
);Üink_id++) {

536 
iwl_mvm_lök_°a
 *
lök
 =

537 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm_°a
->
lök
[
lök_id
],

538 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

540 i‡(!
lök
)

543 
	`iwl_mvm_mld_‰ì_°a_lök
(
mvm
, 
mvm_°a
, 
lök
, 
lök_id
, 
Ál£
);

545 
	}
}

547 
	$iwl_mvm_mld_Æloc_°a_lök
(
iwl_mvm
 *
mvm
,

548 
õì80211_vif
 *
vif
,

549 
õì80211_°a
 *
°a
,

550 
lök_id
)

552 
õì80211_lök_°a
 *
lök_°a
 =

553 
	`lök_°a_dîe„ªn˚_¥Ÿe˘ed
(
°a
, 
lök_id
);

554 
iwl_mvm_°a
 *
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

555 
iwl_mvm_lök_°a
 *
lök
;

556 
u32
 
°a_id
 = 
	`iwl_mvm_föd_‰ì_°a_id
(
mvm
,

557 
	`õì80211_vif_ty≥_p2p
(
vif
));

559 i‡(
°a_id
 =
IWL_MVM_INVALID_STA
)

560  -
ENOSPC
;

562 i‡(
	`rcu_ac˚ss_poöãr
(
°a
->
lök
[
lök_id
]Ë=&°a->
deÊök
) {

563 
lök
 = &
mvm_°a
->
deÊök
;

565 
lök
 = 
	`kzÆloc
((*lök), 
GFP_KERNEL
);

566 i‡(!
lök
)

567  -
ENOMEM
;

570 
lök
->
°a_id
 = sta_id;

571 
	`rcu_assign_poöãr
(
mvm_°a
->
lök
[
lök_id
],Üink);

572 
	`rcu_assign_poöãr
(
mvm
->
fw_id_to_mac_id
[
lök
->
°a_id
], 
°a
);

573 
	`rcu_assign_poöãr
(
mvm
->
fw_id_to_lök_°a
[
lök
->
°a_id
],

574 
lök_°a
);

577 
	}
}

580 
	$iwl_mvm_mld_Æloc_°a_löks
(
iwl_mvm
 *
mvm
,

581 
õì80211_vif
 *
vif
,

582 
õì80211_°a
 *
°a
)

584 
iwl_mvm_°a
 *
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

585 
lök_id
;

586 
ªt
;

588 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

590 
lök_id
 = 0;Üök_id < 
	`ARRAY_SIZE
(
°a
->
lök
);Üink_id++) {

591 i‡(!
	`rcu_ac˚ss_poöãr
(
°a
->
lök
[
lök_id
]) ||

592 
mvm_°a
->
lök
[
lök_id
])

595 
ªt
 = 
	`iwl_mvm_mld_Æloc_°a_lök
(
mvm
, 
vif
, 
°a
, 
lök_id
);

596 i‡(
ªt
)

597 
îr
;

602 
îr
:

603 
	`iwl_mvm_mld_°a_rm_Æl_°a_löks
(
mvm
, 
mvm_°a
);

604  
ªt
;

605 
	}
}

607 
	$iwl_mvm_mld_£t_≠_°a_id
(
õì80211_°a
 *
°a
,

608 
iwl_mvm_vif_lök_öfo
 *
vif_lök
,

609 
iwl_mvm_lök_°a
 *
°a_lök
)

611 i‡(!
°a
->
tdls
) {

612 
	`WARN_ON
(
vif_lök
->
≠_°a_id
 !
IWL_MVM_INVALID_STA
);

613 
vif_lök
->
≠_°a_id
 = 
°a_lök
->
°a_id
;

615 
	`WARN_ON
(
vif_lök
->
≠_°a_id
 =
IWL_MVM_INVALID_STA
);

617 
	}
}

622 
	$iwl_mvm_Æloc_°a_a·î_ª°¨t
(
iwl_mvm
 *
mvm
,

623 
õì80211_vif
 *
vif
,

624 
õì80211_°a
 *
°a
)

626 
iwl_mvm_°a
 *
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

627 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

628 
õì80211_lök_°a
 *
lök_°a
;

629 
lök_id
;

631 
ªt
 = -
EINVAL
;

632 
°a_id
;

638 
	`f‹_óch_°a_a˘ive_lök
(
vif
, 
°a
, 
lök_°a
, 
lök_id
) {

639 
iwl_mvm_vif_lök_öfo
 *
mvm_lök
;

640 
õì80211_bss_c⁄f
 *
lök_c⁄f
 =

641 
	`lök_c⁄f_dîe„ªn˚_¥Ÿe˘ed
(
vif
, 
lök_id
);

642 
iwl_mvm_lök_°a
 *
mvm_lök_°a
 =

643 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm_°a
->
lök
[
lök_id
],

644 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

646 i‡(!
lök_c⁄f
)

649 
mvm_lök
 = 
mvmvif
->
lök
[
lök_c⁄f
->
lök_id
];

651 i‡(!
mvm_lök
 || !
mvm_lök_°a
)

654 
°a_id
 = 
mvm_lök_°a
->sta_id;

655 
ªt
 = 
	`iwl_mvm_mld_cfg_°a
(
mvm
, 
°a
, 
vif
, 
lök_°a
,

656 
lök_c⁄f
, 
mvm_lök_°a
);

657 i‡(
ªt
)

658  
ªt
;

660 
	`rcu_assign_poöãr
(
mvm
->
fw_id_to_mac_id
[
°a_id
], 
°a
);

661 
	`rcu_assign_poöãr
(
mvm
->
fw_id_to_lök_°a
[
°a_id
], 
lök_°a
);

662 
ªt
 = 0;

665 
	`iwl_mvm_ªÆloc_queues_a·î_ª°¨t
(
mvm
, 
°a
);

667  
ªt
;

668 
	}
}

670 
	$iwl_mvm_mld_add_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

671 
õì80211_°a
 *
°a
)

673 
iwl_mvm_vif
 *
mvm_vif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

674 
iwl_mvm_°a
 *
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

675 
lök_°a_added_to_fw
 = 0;

676 
õì80211_lök_°a
 *
lök_°a
;

677 
ªt
 = 0;

678 
lök_id
;

680 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

682 i‡(!
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
)) {

683 
ªt
 = 
	`iwl_mvm_mld_Æloc_°a_löks
(
mvm
, 
vif
, 
°a
);

684 i‡(
ªt
)

685  
ªt
;

687 
	`•ö_lock_öô
(&
mvm_°a
->
lock
);

689 
ªt
 = 
	`iwl_mvm_°a_öô
(
mvm
, 
vif
, 
°a
, 
IWL_MVM_INVALID_STA
,

690 
STATION_TYPE_PEER
);

692 
ªt
 = 
	`iwl_mvm_Æloc_°a_a·î_ª°¨t
(
mvm
, 
vif
, 
°a
);

695 i‡(
ªt
)

696 
îr
;

699 
ªt
 = 
	`iwl_mvm_mld_upd©e_°a
(
mvm
, 
vif
, 
°a
);

700 i‡(
ªt
)

701 
îr
;

703 
	`f‹_óch_°a_a˘ive_lök
(
vif
, 
°a
, 
lök_°a
, 
lök_id
) {

704 
õì80211_bss_c⁄f
 *
lök_c⁄f
 =

705 
	`lök_c⁄f_dîe„ªn˚_¥Ÿe˘ed
(
vif
, 
lök_id
);

706 
iwl_mvm_lök_°a
 *
mvm_lök_°a
 =

707 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm_°a
->
lök
[
lök_id
],

708 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

710 i‡(
	`WARN_ON
(!
lök_c⁄f
 || !
mvm_lök_°a
)) {

711 
ªt
 = -
EINVAL
;

712 
îr
;

715 
ªt
 = 
	`iwl_mvm_mld_cfg_°a
(
mvm
, 
°a
, 
vif
, 
lök_°a
, 
lök_c⁄f
,

716 
mvm_lök_°a
);

717 i‡(
ªt
)

718 
îr
;

720 
lök_°a_added_to_fw
 |
	`BIT
(
lök_id
);

722 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
)

723 
	`iwl_mvm_mld_£t_≠_°a_id
(
°a
, 
mvm_vif
->
lök
[
lök_id
],

724 
mvm_lök_°a
);

729 
îr
:

731 
	`f‹_óch_£t_bô
(
lök_id
, &
lök_°a_added_to_fw
,

732 
IEEE80211_MLD_MAX_NUM_LINKS
) {

733 
iwl_mvm_lök_°a
 *
mvm_lök_°a
 =

734 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm_°a
->
lök
[
lök_id
],

735 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

737 
	`iwl_mvm_mld_rm_°a_‰om_fw
(
mvm
, 
mvm_lök_°a
->
°a_id
);

741 
	`iwl_mvm_mld_°a_rm_Æl_°a_löks
(
mvm
, 
mvm_°a
);

742  
ªt
;

743 
	}
}

745 
	$iwl_mvm_mld_upd©e_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

746 
õì80211_°a
 *
°a
)

748 
iwl_mvm_°a
 *
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

749 
õì80211_lök_°a
 *
lök_°a
;

750 
lök_id
;

751 
ªt
 = -
EINVAL
;

753 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

755 
	`f‹_óch_°a_a˘ive_lök
(
vif
, 
°a
, 
lök_°a
, 
lök_id
) {

756 
õì80211_bss_c⁄f
 *
lök_c⁄f
 =

757 
	`lök_c⁄f_dîe„ªn˚_¥Ÿe˘ed
(
vif
, 
lök_id
);

758 
iwl_mvm_lök_°a
 *
mvm_lök_°a
 =

759 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm_°a
->
lök
[
lök_id
],

760 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

762 i‡(
	`WARN_ON
(!
lök_c⁄f
 || !
mvm_lök_°a
))

763  -
EINVAL
;

765 
ªt
 = 
	`iwl_mvm_mld_cfg_°a
(
mvm
, 
°a
, 
vif
, 
lök_°a
, 
lök_c⁄f
,

766 
mvm_lök_°a
);

768 i‡(
ªt
) {

769 
	`IWL_ERR
(
mvm
, "FaûedÅÿupd©ê°®lök %d\n", 
lök_id
);

774  
ªt
;

775 
	}
}

777 
	$iwl_mvm_mld_dißbÀ_°a_queues
(
iwl_mvm
 *
mvm
,

778 
õì80211_vif
 *
vif
,

779 
õì80211_°a
 *
°a
)

781 
iwl_mvm_°a
 *
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

782 
u32
 
°a_mask
 = 
	`iwl_mvm_°a_fw_id_mask
(
mvm
, 
°a
, -1);

783 
i
;

785 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

787 
i
 = 0; i < 
	`ARRAY_SIZE
(
mvm_°a
->
tid_d©a
); i++) {

788 i‡(
mvm_°a
->
tid_d©a
[
i
].
txq_id
 =
IWL_MVM_INVALID_QUEUE
)

791 
	`iwl_mvm_mld_dißbÀ_txq
(
mvm
, 
°a_mask
,

792 &
mvm_°a
->
tid_d©a
[
i
].
txq_id
, i);

793 
mvm_°a
->
tid_d©a
[
i
].
txq_id
 = 
IWL_MVM_INVALID_QUEUE
;

796 
i
 = 0; i < 
	`ARRAY_SIZE
(
°a
->
txq
); i++) {

797 
iwl_mvm_txq
 *
mvmtxq
 =

798 
	`iwl_mvm_txq_‰om_mac80211
(
°a
->
txq
[
i
]);

800 
mvmtxq
->
txq_id
 = 
IWL_MVM_INVALID_QUEUE
;

802 
	}
}

804 
	$iwl_mvm_mld_rm_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

805 
õì80211_°a
 *
°a
)

807 
iwl_mvm_°a
 *
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

808 
õì80211_lök_°a
 *
lök_°a
;

809 
lök_id
;

810 
ªt
;

812 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

815 
	`f‹_óch_°a_a˘ive_lök
(
vif
, 
°a
, 
lök_°a
, 
lök_id
) {

816 
iwl_mvm_lök_°a
 *
mvm_lök_°a
 =

817 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm_°a
->
lök
[
lök_id
],

818 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

820 i‡(
	`WARN_ON
(!
mvm_lök_°a
))

821  -
EINVAL
;

823 
ªt
 = 
	`iwl_mvm_Êush_°a_tids
(
mvm
, 
mvm_lök_°a
->
°a_id
,

825 i‡(
ªt
)

826  
ªt
;

829 
ªt
 = 
	`iwl_mvm_waô_°a_queues_em±y
(
mvm
, 
mvm_°a
);

830 i‡(
ªt
)

831  
ªt
;

833 
	`iwl_mvm_mld_dißbÀ_°a_queues
(
mvm
, 
vif
, 
°a
);

835 
	`f‹_óch_°a_a˘ive_lök
(
vif
, 
°a
, 
lök_°a
, 
lök_id
) {

836 
iwl_mvm_lök_°a
 *
mvm_lök_°a
 =

837 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm_°a
->
lök
[
lök_id
],

838 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

839 
boﬁ
 
°ay_ö_fw
;

841 
°ay_ö_fw
 = 
	`iwl_mvm_°a_dñ
(
mvm
, 
vif
, 
°a
, 
lök_°a
, &
ªt
);

842 i‡(
ªt
)

845 i‡(!
°ay_ö_fw
)

846 
ªt
 = 
	`iwl_mvm_mld_rm_°a_‰om_fw
(
mvm
,

847 
mvm_lök_°a
->
°a_id
);

849 
	`iwl_mvm_mld_‰ì_°a_lök
(
mvm
, 
mvm_°a
, 
mvm_lök_°a
,

850 
lök_id
, 
°ay_ö_fw
);

853  
ªt
;

854 
	}
}

856 
	$iwl_mvm_mld_rm_°a_id
(
iwl_mvm
 *
mvm
, 
u8
 
°a_id
)

858 
ªt
;

860 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

862 i‡(
	`WARN_ON
(
°a_id
 =
IWL_MVM_INVALID_STA
))

865 
ªt
 = 
	`iwl_mvm_mld_rm_°a_‰om_fw
(
mvm
, 
°a_id
);

867 
	`RCU_INIT_POINTER
(
mvm
->
fw_id_to_mac_id
[
°a_id
], 
NULL
);

868 
	`RCU_INIT_POINTER
(
mvm
->
fw_id_to_lök_°a
[
°a_id
], 
NULL
);

869  
ªt
;

870 
	}
}

872 
	$iwl_mvm_mld_°a_modify_dißbÀ_tx
(
iwl_mvm
 *
mvm
,

873 
iwl_mvm_°a
 *
mvm°a
,

874 
boﬁ
 
dißbÀ
)

876 
iwl_mvm_°a_dißbÀ_tx_cmd
 
cmd
;

877 
ªt
;

879 
cmd
.
°a_id
 = 
	`˝u_to_À32
(
mvm°a
->
deÊök
.sta_id);

880 
cmd
.
dißbÀ
 = 
	`˝u_to_À32
(disable);

882 i‡(
	`WARN_ON
(
	`iwl_mvm_has_no_ho°_dißbÀ_tx
(
mvm
)))

885 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
,

886 
	`WIDE_ID
(
MAC_CONF_GROUP
, 
STA_DISABLE_TX_CMD
),

887 
CMD_ASYNC
, (
cmd
), &cmd);

888 i‡(
ªt
)

889 
	`IWL_ERR
(
mvm
,

891 
ªt
);

892 
	}
}

894 
	$iwl_mvm_mld_°a_modify_dißbÀ_tx_≠
(
iwl_mvm
 *
mvm
,

895 
õì80211_°a
 *
°a
,

896 
boﬁ
 
dißbÀ
)

898 
iwl_mvm_°a
 *
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

900 
	`•ö_lock_bh
(&
mvm_°a
->
lock
);

902 i‡(
mvm_°a
->
dißbÀ_tx
 =
dißbÀ
) {

903 
	`•ö_u∆ock_bh
(&
mvm_°a
->
lock
);

907 
	`iwl_mvm_mld_°a_modify_dißbÀ_tx
(
mvm
, 
mvm_°a
, 
dißbÀ
);

909 
	`•ö_u∆ock_bh
(&
mvm_°a
->
lock
);

910 
	}
}

912 
	$iwl_mvm_mld_modify_Æl_°a_dißbÀ_tx
(
iwl_mvm
 *
mvm
,

913 
iwl_mvm_vif
 *
mvmvif
,

914 
boﬁ
 
dißbÀ
)

916 
õì80211_°a
 *
°a
;

917 
iwl_mvm_°a
 *
mvm_°a
;

918 
i
;

920 
	`rcu_ªad_lock
();

923 
i
 = 0; i < 
mvm
->
fw
->
ucode_ˇ∑
.
num_°©i⁄s
; i++) {

924 
°a
 = 
	`rcu_dîe„ªn˚
(
mvm
->
fw_id_to_mac_id
[
i
]);

925 i‡(
	`IS_ERR_OR_NULL
(
°a
))

928 
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

929 i‡(
mvm_°a
->
mac_id_n_cﬁ‹
 !=

930 
	`FW_CMD_ID_AND_COLOR
(
mvmvif
->
id
, mvmvif->
cﬁ‹
))

933 
	`iwl_mvm_mld_°a_modify_dißbÀ_tx
(
mvm
, 
mvm_°a
, 
dißbÀ
);

936 
	`rcu_ªad_u∆ock
();

937 
	}
}

939 
	$iwl_mvm_mld_upd©e_°a_queues
(
iwl_mvm
 *
mvm
,

940 
õì80211_°a
 *
°a
,

941 
u32
 
ﬁd_°a_mask
,

942 
u32
 
√w_°a_mask
)

944 
iwl_mvm_°a
 *
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

945 
iwl_scd_queue_cfg_cmd
 
cmd
 = {

946 .
›î©i⁄
 = 
	`˝u_to_À32
(
IWL_SCD_QUEUE_MODIFY
),

947 .
u
.
modify
.
ﬁd_°a_mask
 = 
	`˝u_to_À32
(old_sta_mask),

948 .
u
.
modify
.
√w_°a_mask
 = 
	`˝u_to_À32
(new_sta_mask),

950 
iwl_ho°_cmd
 
hcmd
 = {

951 .
id
 = 
	`WIDE_ID
(
DATA_PATH_GROUP
, 
SCD_QUEUE_CONFIG_CMD
),

952 .
Àn
[0] = (
cmd
),

953 .
d©a
[0] = &
cmd


955 
tid
;

956 
ªt
;

958 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

960 
tid
 = 0;Åid <
IWL_MAX_TID_COUNT
;Åid++) {

961 
iwl_mvm_tid_d©a
 *
tid_d©a
 = &
mvm_°a
->tid_d©a[
tid
];

962 
txq_id
 = 
tid_d©a
->txq_id;

964 i‡(
txq_id
 =
IWL_MVM_INVALID_QUEUE
)

967 i‡(
tid
 =
IWL_MAX_TID_COUNT
)

968 
cmd
.
u
.
modify
.
tid
 = 
	`˝u_to_À32
(
IWL_MGMT_TID
);

970 
cmd
.
u
.
modify
.
tid
 = 
	`˝u_to_À32
(tid);

972 
ªt
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
hcmd
);

973 i‡(
ªt
)

974  
ªt
;

978 
	}
}

980 
	$iwl_mvm_mld_upd©e_°a_baids
(
iwl_mvm
 *
mvm
,

981 
u32
 
ﬁd_°a_mask
,

982 
u32
 
√w_°a_mask
)

984 
iwl_rx_baid_cfg_cmd
 
cmd
 = {

985 .
a˘i⁄
 = 
	`˝u_to_À32
(
IWL_RX_BAID_ACTION_MODIFY
),

986 .
modify
.
ﬁd_°a_id_mask
 = 
	`˝u_to_À32
(
ﬁd_°a_mask
),

987 .
modify
.
√w_°a_id_mask
 = 
	`˝u_to_À32
(
√w_°a_mask
),

989 
u32
 
cmd_id
 = 
	`WIDE_ID
(
DATA_PATH_GROUP
, 
RX_BAID_ALLOCATION_CONFIG_CMD
);

990 
baid
;

992 
	`BUILD_BUG_ON
((
iwl_rx_baid_cfg_ª•
Ë!(
baid
));

994 
baid
 = 0; baid < 
	`ARRAY_SIZE
(
mvm
->
baid_m≠
); baid++) {

995 
iwl_mvm_baid_d©a
 *
d©a
;

996 
ªt
;

998 
d©a
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm
->
baid_m≠
[
baid
],

999 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

1000 i‡(!
d©a
)

1003 i‡(!(
d©a
->
°a_mask
 & 
ﬁd_°a_mask
))

1006 
	`WARN_ONCE
(
d©a
->
°a_mask
 !
ﬁd_°a_mask
,

1008 
baid
, 
ﬁd_°a_mask
, 
d©a
->
°a_mask
);

1010 
cmd
.
modify
.
tid
 = 
	`˝u_to_À32
(
d©a
->tid);

1012 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
cmd_id
, 0, (
cmd
), &cmd);

1013 
d©a
->
°a_mask
 = 
√w_°a_mask
;

1014 i‡(
ªt
)

1015  
ªt
;

1019 
	}
}

1021 
	$iwl_mvm_mld_upd©e_°a_ªsour˚s
(
iwl_mvm
 *
mvm
,

1022 
õì80211_vif
 *
vif
,

1023 
õì80211_°a
 *
°a
,

1024 
u32
 
ﬁd_°a_mask
,

1025 
u32
 
√w_°a_mask
)

1027 
ªt
;

1029 
ªt
 = 
	`iwl_mvm_mld_upd©e_°a_queues
(
mvm
, 
°a
,

1030 
ﬁd_°a_mask
,

1031 
√w_°a_mask
);

1032 i‡(
ªt
)

1033  
ªt
;

1035 
ªt
 = 
	`iwl_mvm_mld_upd©e_°a_keys
(
mvm
, 
vif
, 
°a
,

1036 
ﬁd_°a_mask
,

1037 
√w_°a_mask
);

1038 i‡(
ªt
)

1039  
ªt
;

1041  
	`iwl_mvm_mld_upd©e_°a_baids
(
mvm
, 
ﬁd_°a_mask
, 
√w_°a_mask
);

1042 
	}
}

1044 
	$iwl_mvm_mld_upd©e_°a_löks
(
iwl_mvm
 *
mvm
,

1045 
õì80211_vif
 *
vif
,

1046 
õì80211_°a
 *
°a
,

1047 
u16
 
ﬁd_löks
, u16 
√w_löks
)

1049 
iwl_mvm_°a
 *
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

1050 
iwl_mvm_vif
 *
mvm_vif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1051 
iwl_mvm_lök_°a
 *
mvm_°a_lök
;

1052 
iwl_mvm_vif_lök_öfo
 *
mvm_vif_lök
;

1053 
löks_to_add
 = ~
ﬁd_löks
 & 
√w_löks
;

1054 
löks_to_ªm
 = 
ﬁd_löks
 & ~
√w_löks
;

1055 
ﬁd_löks_l⁄g
 = 
ﬁd_löks
;

1056 
u32
 
cuºít_°a_mask
 = 0, 
°a_mask_added
 = 0, 
°a_mask_to_ªm
 = 0;

1057 
lök_°a_added_to_fw
 = 0, 
lök_°a_Æloˇãd
 = 0;

1058 
lök_id
;

1059 
ªt
;

1061 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1063 
	`f‹_óch_£t_bô
(
lök_id
, &
ﬁd_löks_l⁄g
,

1064 
IEEE80211_MLD_MAX_NUM_LINKS
) {

1065 
mvm_°a_lök
 =

1066 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm_°a
->
lök
[
lök_id
],

1067 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

1069 i‡(
	`WARN_ON
(!
mvm_°a_lök
)) {

1070 
ªt
 = -
EINVAL
;

1071 
îr
;

1074 
cuºít_°a_mask
 |
	`BIT
(
mvm_°a_lök
->
°a_id
);

1075 i‡(
löks_to_ªm
 & 
	`BIT
(
lök_id
))

1076 
°a_mask_to_ªm
 |
	`BIT
(
mvm_°a_lök
->
°a_id
);

1079 i‡(
°a_mask_to_ªm
) {

1080 
ªt
 = 
	`iwl_mvm_mld_upd©e_°a_ªsour˚s
(
mvm
, 
vif
, 
°a
,

1081 
cuºít_°a_mask
,

1082 
cuºít_°a_mask
 &

1083 ~
°a_mask_to_ªm
);

1084 i‡(
	`WARN_ON
(
ªt
))

1085 
îr
;

1087 
cuºít_°a_mask
 &~
°a_mask_to_ªm
;

1090 
	`f‹_óch_£t_bô
(
lök_id
, &
löks_to_ªm
, 
IEEE80211_MLD_MAX_NUM_LINKS
) {

1091 
mvm_°a_lök
 =

1092 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm_°a
->
lök
[
lök_id
],

1093 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

1094 
mvm_vif_lök
 = 
mvm_vif
->
lök
[
lök_id
];

1096 i‡(
	`WARN_ON
(!
mvm_°a_lök
 || !
mvm_vif_lök
)) {

1097 
ªt
 = -
EINVAL
;

1098 
îr
;

1101 
ªt
 = 
	`iwl_mvm_mld_rm_°a_‰om_fw
(
mvm
, 
mvm_°a_lök
->
°a_id
);

1102 i‡(
	`WARN_ON
(
ªt
))

1103 
îr
;

1105 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
)

1106 
mvm_vif_lök
->
≠_°a_id
 = 
IWL_MVM_INVALID_STA
;

1108 
	`iwl_mvm_mld_‰ì_°a_lök
(
mvm
, 
mvm_°a
, 
mvm_°a_lök
, 
lök_id
,

1109 
Ál£
);

1112 
	`f‹_óch_£t_bô
(
lök_id
, &
löks_to_add
, 
IEEE80211_MLD_MAX_NUM_LINKS
) {

1113 
õì80211_bss_c⁄f
 *
lök_c⁄f
 =

1114 
	`lök_c⁄f_dîe„ªn˚_¥Ÿe˘ed
(
vif
, 
lök_id
);

1115 
õì80211_lök_°a
 *
lök_°a
 =

1116 
	`lök_°a_dîe„ªn˚_¥Ÿe˘ed
(
°a
, 
lök_id
);

1117 
mvm_vif_lök
 = 
mvm_vif
->
lök
[
lök_id
];

1119 i‡(
	`WARN_ON
(!
mvm_vif_lök
 || !
lök_c⁄f
 || !
lök_°a
)) {

1120 
ªt
 = -
EINVAL
;

1121 
îr
;

1124 i‡(
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
)) {

1125 i‡(
	`WARN_ON
(!
mvm_°a
->
lök
[
lök_id
])) {

1126 
ªt
 = -
EINVAL
;

1127 
îr
;

1130 i‡(
	`WARN_ON
(
mvm_°a
->
lök
[
lök_id
])) {

1131 
ªt
 = -
EINVAL
;

1132 
îr
;

1134 
ªt
 = 
	`iwl_mvm_mld_Æloc_°a_lök
(
mvm
, 
vif
, 
°a
,

1135 
lök_id
);

1136 i‡(
	`WARN_ON
(
ªt
))

1137 
îr
;

1140 
lök_°a
->
agg
.
max_rc_amsdu_Àn
 = 1;

1141 
	`õì80211_°a_ªˇlc_aggªg©es
(
°a
);

1143 
mvm_°a_lök
 =

1144 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm_°a
->
lök
[
lök_id
],

1145 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

1147 i‡(
	`WARN_ON
(!
mvm_°a_lök
)) {

1148 
ªt
 = -
EINVAL
;

1149 
îr
;

1152 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
)

1153 
	`iwl_mvm_mld_£t_≠_°a_id
(
°a
, 
mvm_vif_lök
,

1154 
mvm_°a_lök
);

1156 
lök_°a_Æloˇãd
 |
	`BIT
(
lök_id
);

1158 
°a_mask_added
 |
	`BIT
(
mvm_°a_lök
->
°a_id
);

1160 
ªt
 = 
	`iwl_mvm_mld_cfg_°a
(
mvm
, 
°a
, 
vif
, 
lök_°a
, 
lök_c⁄f
,

1161 
mvm_°a_lök
);

1162 i‡(
	`WARN_ON
(
ªt
))

1163 
îr
;

1165 
lök_°a_added_to_fw
 |
	`BIT
(
lök_id
);

1167 
	`iwl_mvm_rs_add_°a_lök
(
mvm
, 
mvm_°a_lök
);

1170 i‡(
°a_mask_added
) {

1171 
ªt
 = 
	`iwl_mvm_mld_upd©e_°a_ªsour˚s
(
mvm
, 
vif
, 
°a
,

1172 
cuºít_°a_mask
,

1173 
cuºít_°a_mask
 |

1174 
°a_mask_added
);

1175 i‡(
	`WARN_ON
(
ªt
))

1176 
îr
;

1181 
îr
:

1183 
	`f‹_óch_£t_bô
(
lök_id
, &
lök_°a_added_to_fw
,

1184 
IEEE80211_MLD_MAX_NUM_LINKS
) {

1185 
mvm_°a_lök
 =

1186 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm_°a
->
lök
[
lök_id
],

1187 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

1189 
	`iwl_mvm_mld_rm_°a_‰om_fw
(
mvm
, 
mvm_°a_lök
->
°a_id
);

1193 
	`f‹_óch_£t_bô
(
lök_id
, &
lök_°a_Æloˇãd
,

1194 
IEEE80211_MLD_MAX_NUM_LINKS
) {

1195 
mvm_°a_lök
 =

1196 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm_°a
->
lök
[
lök_id
],

1197 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

1199 
	`iwl_mvm_mld_‰ì_°a_lök
(
mvm
, 
mvm_°a
, 
mvm_°a_lök
, 
lök_id
,

1200 
Ál£
);

1203  
ªt
;

1204 
	}
}

	@mvm.h

7 #i‚de‡
__IWL_MVM_H__


8 
	#__IWL_MVM_H__


	)

10 
	~<löux/li°.h
>

11 
	~<löux/•ölock.h
>

12 
	~<löux/Àds.h
>

13 
	~<löux/ö6.h
>

15 #ifde‡
CONFIG_THERMAL


16 
	~<löux/thîmÆ.h
>

19 
	~<löux/±p_˛ock_kî√l.h
>

21 
	~<löux/ktime.h
>

23 
	~"iwl-›-mode.h
"

24 
	~"iwl-å™s.h
"

25 
	~"fw/nŸif-waô.h
"

26 
	~"iwl-ì¥om-∑r£.h
"

27 
	~"fw/fûe.h
"

28 
	~"iwl-c⁄fig.h
"

29 
	~"°a.h
"

30 
	~"fw-≠i.h
"

31 
	~"c⁄°™ts.h
"

32 
	~"fw/ru¡ime.h
"

33 
	~"fw/dbg.h
"

34 
	~"fw/a˝i.h
"

35 
	~"mei/iwl-mei.h
"

36 
	~"iwl-nvm-∑r£.h
"

38 
	~<löux/avîage.h
>

40 
	#IWL_MVM_MAX_ADDRESSES
 5

	)

42 
	#IWL_RSSI_OFFSET
 50

	)

43 
	#IWL_MVM_MISSED_BEACONS_SINCE_RX_THOLD
 4

	)

44 
	#IWL_MVM_MISSED_BEACONS_THRESHOLD
 8

	)

45 
	#IWL_MVM_MISSED_BEACONS_THRESHOLD_LONG
 19

	)

48 
	#MSEC_TO_TU
(
_m£c
Ë(_m£c*1000/1024)

	)

54 
	#IWL_MVM_CHANNEL_SWITCH_TIME_GO
 40

	)

60 
	#IWL_MVM_CHANNEL_SWITCH_TIME_CLIENT
 10

	)

66 
	#IWL_MVM_CHANNEL_SWITCH_MARGIN
 4

	)

72 
	#IWL_MVM_CS_UNBLOCK_TX_TIMEOUT
 3

	)

75 
	#IWL_MVM_OFFCHANNEL_QUEUE
 0

	)

78 
	#IWL_MVM_FW_LINK_ID_INVALID
 0xff

	)

80 c⁄° 
õì80211_›s
 
iwl_mvm_hw_›s
;

81 c⁄° 
õì80211_›s
 
iwl_mvm_mld_hw_›s
;

91 
	siwl_mvm_mod_∑øms
 {

92 
boﬁ
 
	möô_dbg
;

93 
	mpowî_scheme
;

95 
iwl_mvm_mod_∑øms
 
iwlmvm_mod_∑øms
;

97 
	siwl_mvm_phy_˘xt
 {

98 
u16
 
	mid
;

99 
u16
 
	mcﬁ‹
;

100 
u32
 
	mªf
;

102 
∆80211_ch™_width
 
	mwidth
;

104 
õì80211_ch™√l
 *
	mch™√l
;

107 
u32
 
	m˚¡î_‰eq1
;

108 
boﬁ
 
	mæc_dißbÀd
;

109 
u32
 
	mch™√l_lﬂd_by_us
;

112 
	siwl_mvm_time_evít_d©a
 {

113 
õì80211_vif
 *
	mvif
;

114 
li°_hód
 
	mli°
;

115 
	míd_jiffõs
;

116 
u32
 
	mduøti⁄
;

117 
boﬁ
 
	mru¬ög
;

118 
u32
 
	muid
;

125 
u32
 
	mid
;

126 
s8
 
	mlök_id
;

137 
	eiwl_powî_scheme
 {

138 
	mIWL_POWER_SCHEME_CAM
 = 1,

139 
	mIWL_POWER_SCHEME_BPS
,

140 
	mIWL_POWER_SCHEME_LP


143 
	#IWL_UAPSD_MAX_SP
 
IEEE80211_WMM_IE_STA_QOSINFO_SP_ALL


	)

145 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


146 
	eiwl_dbgfs_pm_mask
 {

147 
	mMVM_DEBUGFS_PM_KEEP_ALIVE
 = 
BIT
(0),

148 
	mMVM_DEBUGFS_PM_SKIP_OVER_DTIM
 = 
BIT
(1),

149 
	mMVM_DEBUGFS_PM_SKIP_DTIM_PERIODS
 = 
BIT
(2),

150 
	mMVM_DEBUGFS_PM_RX_DATA_TIMEOUT
 = 
BIT
(3),

151 
	mMVM_DEBUGFS_PM_TX_DATA_TIMEOUT
 = 
BIT
(4),

152 
	mMVM_DEBUGFS_PM_LPRX_ENA
 = 
BIT
(6),

153 
	mMVM_DEBUGFS_PM_LPRX_RSSI_THRESHOLD
 = 
BIT
(7),

154 
	mMVM_DEBUGFS_PM_SNOOZE_ENABLE
 = 
BIT
(8),

155 
	mMVM_DEBUGFS_PM_UAPSD_MISBEHAVING
 = 
BIT
(9),

156 
	mMVM_DEBUGFS_PM_USE_PS_POLL
 = 
BIT
(10),

159 
	siwl_dbgfs_pm
 {

160 
u16
 
	mkìp_Æive_£c⁄ds
;

161 
u32
 
	mrx_d©a_timeout
;

162 
u32
 
	mtx_d©a_timeout
;

163 
boﬁ
 
	mskù_ovî_dtim
;

164 
u8
 
	mskù_dtim_≥riods
;

165 
boﬁ
 
	mÕrx_ía
;

166 
u32
 
	mÕrx_rssi_thªshﬁd
;

167 
boﬁ
 
	m¢ooze_ía
;

168 
boﬁ
 
	mu≠sd_misbehavög
;

169 
boﬁ
 
	mu£_ps_pﬁl
;

170 
	mmask
;

175 
	eiwl_dbgfs_bf_mask
 {

176 
	mMVM_DEBUGFS_BF_ENERGY_DELTA
 = 
BIT
(0),

177 
	mMVM_DEBUGFS_BF_ROAMING_ENERGY_DELTA
 = 
BIT
(1),

178 
	mMVM_DEBUGFS_BF_ROAMING_STATE
 = 
BIT
(2),

179 
	mMVM_DEBUGFS_BF_TEMP_THRESHOLD
 = 
BIT
(3),

180 
	mMVM_DEBUGFS_BF_TEMP_FAST_FILTER
 = 
BIT
(4),

181 
	mMVM_DEBUGFS_BF_TEMP_SLOW_FILTER
 = 
BIT
(5),

182 
	mMVM_DEBUGFS_BF_ENABLE_BEACON_FILTER
 = 
BIT
(6),

183 
	mMVM_DEBUGFS_BF_DEBUG_FLAG
 = 
BIT
(7),

184 
	mMVM_DEBUGFS_BF_ESCAPE_TIMER
 = 
BIT
(8),

185 
	mMVM_DEBUGFS_BA_ESCAPE_TIMER
 = 
BIT
(9),

186 
	mMVM_DEBUGFS_BA_ENABLE_BEACON_ABORT
 = 
BIT
(10),

189 
	siwl_dbgfs_bf
 {

190 
u32
 
	mbf_íîgy_dñè
;

191 
u32
 
	mbf_rﬂmög_íîgy_dñè
;

192 
u32
 
	mbf_rﬂmög_°©e
;

193 
u32
 
	mbf_ãmp_thªshﬁd
;

194 
u32
 
	mbf_ãmp_Á°_fûãr
;

195 
u32
 
	mbf_ãmp_¶ow_fûãr
;

196 
u32
 
	mbf_íabÀ_bóc⁄_fûãr
;

197 
u32
 
	mbf_debug_Êag
;

198 
u32
 
	mbf_esˇ≥_timî
;

199 
u32
 
	mba_esˇ≥_timî
;

200 
u32
 
	mba_íabÀ_bóc⁄_ab‹t
;

201 
	mmask
;

205 
	eiwl_mvm_smps_ty≥_ªque°
 {

206 
	mIWL_MVM_SMPS_REQ_BT_COEX
,

207 
	mIWL_MVM_SMPS_REQ_TT
,

208 
	mIWL_MVM_SMPS_REQ_PROT
,

209 
	mIWL_MVM_SMPS_REQ_FW
,

210 
	mNUM_IWL_MVM_SMPS_REQ
,

213 
	eiwl_bt_f‹˚_™t_mode
 {

214 
	mBT_FORCE_ANT_DIS
 = 0,

215 
	mBT_FORCE_ANT_AUTO
,

216 
	mBT_FORCE_ANT_BT
,

217 
	mBT_FORCE_ANT_WIFI
,

219 
	mBT_FORCE_ANT_MAX
,

229 
	eiwl_mvm_low_œãncy_f‹˚
 {

230 
	mLOW_LATENCY_FORCE_UNSET
,

231 
	mLOW_LATENCY_FORCE_ON
,

232 
	mLOW_LATENCY_FORCE_OFF
,

233 
	mNUM_LOW_LATENCY_FORCE


248 
	eiwl_mvm_low_œãncy_ˇu£
 {

249 
	mLOW_LATENCY_TRAFFIC
 = 
BIT
(0),

250 
	mLOW_LATENCY_DEBUGFS
 = 
BIT
(1),

251 
	mLOW_LATENCY_VCMD
 = 
BIT
(2),

252 
	mLOW_LATENCY_VIF_TYPE
 = 
BIT
(3),

253 
	mLOW_LATENCY_DEBUGFS_FORCE_ENABLE
 = 
BIT
(4),

254 
	mLOW_LATENCY_DEBUGFS_FORCE
 = 
BIT
(5),

267 
	siwl_mvm_vif_bf_d©a
 {

268 
boﬁ
 
	mbf_íabÀd
;

269 
boﬁ
 
	mba_íabÀd
;

270 
	mave_bóc⁄_sig«l
;

271 
	mœ°_cqm_evít
;

272 
	mbt_c€x_mö_thﬁd
;

273 
	mbt_c€x_max_thﬁd
;

274 
	mœ°_bt_c€x_evít
;

283 
	siwl_¥obe_ª•_d©a
 {

284 
rcu_hód
 
	mrcu_hód
;

285 
iwl_¥obe_ª•_d©a_nŸif
 
	mnŸif
;

286 
	mnﬂ_Àn
;

313 
	siwl_mvm_vif_lök_öfo
 {

314 
u8
 
	mbssid
[
ETH_ALEN
];

315 
u8
 
	m≠_°a_id
;

316 
u8
 
	mfw_lök_id
;

318 
iwl_mvm_öt_°a
 
	mbˇ°_°a
;

319 
iwl_mvm_öt_°a
 
	mmˇ°_°a
;

322 
u32
 
	mnum_bóc⁄s
, 
	maccu_num_bóc⁄s
;

323 
u8
 
	mavg_sig«l
;

324 } 
	mbóc⁄_°©s
;

326 
õì80211_smps_mode
 
	msmps_ªque°s
[
NUM_IWL_MVM_SMPS_REQ
];

327 
iwl_¥obe_ª•_d©a
 
__rcu
 *
	m¥obe_ª•_d©a
;

329 
õì80211_key_c⁄f
 *
	migtk
;

331 
boﬁ
 
	mhe_ru_2mhz_block
;

332 
boﬁ
 
	ma˘ive
;

333 
boﬁ
 
	mli°í_lmac
;

335 
u16
 
	mˇb_queue
;

339 
iwl_mvm_phy_˘xt
 *
	mphy_˘xt
;

344 
õì80211_tx_queue_∑øms
 
	mqueue_∑øms
[
IEEE80211_NUM_ACS
];

346 
u16
 
	mmgmt_queue
;

383 
	siwl_mvm_vif
 {

384 
iwl_mvm
 *
	mmvm
;

385 
u16
 
	mid
;

386 
u16
 
	mcﬁ‹
;

388 
boﬁ
 
	massocüãd
;

389 
u8
 
	m≠_assoc_°a_cou¡
;

390 
boﬁ
 
	mu∂ﬂded
;

391 
boﬁ
 
	m≠_ibss_a˘ive
;

392 
boﬁ
 
	mpm_íabÀd
;

393 
boﬁ
 
	mm⁄ô‹_a˘ive
;

394 
boﬁ
 
	me§_a˘ive
;

395 
boﬁ
 
	mbt_c€x_e§_dißbÀd
;

397 
u8
 
	mlow_œãncy
: 6;

398 
u8
 
	mlow_œãncy_a˘uÆ
: 1;

400 
u8
 
	mauth‹ized
:1;

401 
boﬁ
 
	mps_dißbÀd
;

403 
u32
 
	m≠_bóc⁄_time
;

404 
iwl_mvm_vif_bf_d©a
 
	mbf_d©a
;

406 #ifde‡
CONFIG_PM


409 
u8
 
	mkck
[
NL80211_KCK_EXT_LEN
];

410 
u8
 
	mkek
[
NL80211_KEK_EXT_LEN
];

411 
size_t
 
	mkek_Àn
;

412 
size_t
 
	mkck_Àn
;

413 
u32
 
	makm
;

414 
__À64
 
	mª∂ay_˘r
;

415 
boﬁ
 
	mvÆid
;

416 } 
	mªkey_d©a
;

418 
	mtx_key_idx
;

420 
boﬁ
 
	m£qno_vÆid
;

421 
u16
 
	m£qno
;

424 #i‡
IS_ENABLED
(
CONFIG_IPV6
)

426 
ö6_addr
 
	mèrgë_ùv6_addrs
[
IWL_PROTO_OFFLOAD_NUM_IPV6_ADDRS_MAX
];

427 
	mã¡©ive_addrs
[
BITS_TO_LONGS
(
IWL_PROTO_OFFLOAD_NUM_IPV6_ADDRS_MAX
)];

428 
	mnum_èrgë_ùv6_addrs
;

431 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


432 
díåy
 *
	mdbgfs_dú
;

433 
díåy
 *
	mdbgfs_¶ök
;

434 
iwl_dbgfs_pm
 
	mdbgfs_pm
;

435 
iwl_dbgfs_bf
 
	mdbgfs_bf
;

436 
iwl_mac_powî_cmd
 
	mmac_pwr_cmd
;

437 
	mdbgfs_quŸa_mö
;

441 
u8
 
	mu≠sd_misbehavög_≠_addr
[
ETH_ALEN
] 
__Æig√d
(2);

442 
dñayed_w‹k
 
	mu≠sd_n⁄agg_dëe˘ed_wk
;

444 
boﬁ
 
	mcß_cou¡down
;

445 
boﬁ
 
	mcß_Áûed
;

446 
boﬁ
 
	mcß_b˙_≥ndög
;

447 
u16
 
	mcß_èrgë_‰eq
;

448 
u16
 
	mcß_cou¡
;

449 
u16
 
	mcß_misbehave
;

450 
dñayed_w‹k
 
	mcß_w‹k
;

452 
iwl_tsf_id
 
	mtsf_id
;

454 
iwl_mvm_time_evít_d©a
 
	mtime_evít_d©a
;

455 
iwl_mvm_time_evít_d©a
 
	mhs_time_evít_d©a
;

458 
√tdev_„©uªs_t
 
	m„©uªs
;

460 
õì80211_°a
 *
	m≠_°a
;

463 
õì80211_key_c⁄f
 *
	m≠_óæy_keys
[4];

466 
õì80211_key_c⁄f
 
__rcu
 *
	mkeys
[2];

467 } 
	mb˙_¥Ÿ
;

469 
iwl_mvm_vif_lök_öfo
 
	mdeÊök
;

470 
iwl_mvm_vif_lök_öfo
 *
	mlök
[
IEEE80211_MLD_MAX_NUM_LINKS
];

473 
	#f‹_óch_mvm_vif_vÆid_lök
(
mvm_vif
, 
lök_id
) \

474 
lök_id
 = 0; \

475 
lök_id
 < 
	`ARRAY_SIZE
((
mvm_vif
)->
lök
); \

476 
lök_id
++) \

477 i‡((
mvm_vif
)->
lök
[
lök_id
])

	)

479 
ölöe
 
iwl_mvm_vif
 *

480 
	$iwl_mvm_vif_‰om_mac80211
(
õì80211_vif
 *
vif
)

482  (*)
vif
->
drv_¥iv
;

483 
	}
}

485 c⁄° 
u8
 
tid_to_mac80211_ac
[];

487 
	#IWL_MVM_SCAN_STOPPING_SHIFT
 8

	)

489 
	eiwl_sˇn_°©us
 {

490 
	mIWL_MVM_SCAN_REGULAR
 = 
BIT
(0),

491 
	mIWL_MVM_SCAN_SCHED
 = 
BIT
(1),

492 
	mIWL_MVM_SCAN_NETDETECT
 = 
BIT
(2),

494 
	mIWL_MVM_SCAN_STOPPING_REGULAR
 = 
BIT
(8),

495 
	mIWL_MVM_SCAN_STOPPING_SCHED
 = 
BIT
(9),

496 
	mIWL_MVM_SCAN_STOPPING_NETDETECT
 = 
BIT
(10),

498 
	mIWL_MVM_SCAN_REGULAR_MASK
 = 
IWL_MVM_SCAN_REGULAR
 |

499 
IWL_MVM_SCAN_STOPPING_REGULAR
,

500 
	mIWL_MVM_SCAN_SCHED_MASK
 = 
IWL_MVM_SCAN_SCHED
 |

501 
IWL_MVM_SCAN_STOPPING_SCHED
,

502 
	mIWL_MVM_SCAN_NETDETECT_MASK
 = 
IWL_MVM_SCAN_NETDETECT
 |

503 
IWL_MVM_SCAN_STOPPING_NETDETECT
,

505 
	mIWL_MVM_SCAN_STOPPING_MASK
 = 0xf‡<< 
IWL_MVM_SCAN_STOPPING_SHIFT
,

506 
	mIWL_MVM_SCAN_MASK
 = 0xff,

509 
	eiwl_mvm_sˇn_ty≥
 {

510 
	mIWL_SCAN_TYPE_NOT_SET
,

511 
	mIWL_SCAN_TYPE_UNASSOC
,

512 
	mIWL_SCAN_TYPE_WILD
,

513 
	mIWL_SCAN_TYPE_MILD
,

514 
	mIWL_SCAN_TYPE_FRAGMENTED
,

515 
	mIWL_SCAN_TYPE_FAST_BALANCE
,

518 
	eiwl_mvm_sched_sˇn_∑ss_Æl_°©es
 {

519 
	mSCHED_SCAN_PASS_ALL_DISABLED
,

520 
	mSCHED_SCAN_PASS_ALL_ENABLED
,

521 
	mSCHED_SCAN_PASS_ALL_FOUND
,

533 
	siwl_mvm_â_mgmt
 {

534 
dñayed_w‹k
 
	m˘_kûl_exô
;

535 
boﬁ
 
	mdy«mic_smps
;

536 
u32
 
	mtx_backoff
;

537 
u32
 
	mmö_backoff
;

538 
iwl_â_∑øms
 
	m∑øms
;

539 
boﬁ
 
	mthrŸée
;

542 #ifde‡
CONFIG_THERMAL


548 
	siwl_mvm_thîmÆ_devi˚
 {

549 
thîmÆ_åù
 
	måùs
[
IWL_MAX_DTS_TRIPS
];

550 
thîmÆ_z⁄e_devi˚
 *
	mtz⁄e
;

558 
	siwl_mvm_coﬁög_devi˚
 {

559 
u32
 
	mcur_°©e
;

560 
thîmÆ_coﬁög_devi˚
 *
	mcdev
;

564 
	#IWL_MVM_NUM_LAST_FRAMES_UCODE_RATES
 8

	)

566 
	siwl_mvm_‰ame_°©s
 {

567 
u32
 
	mÀgacy_‰ames
;

568 
u32
 
	mht_‰ames
;

569 
u32
 
	mvht_‰ames
;

570 
u32
 
	mbw_20_‰ames
;

571 
u32
 
	mbw_40_‰ames
;

572 
u32
 
	mbw_80_‰ames
;

573 
u32
 
	mbw_160_‰ames
;

574 
u32
 
	msgi_‰ames
;

575 
u32
 
	mngi_‰ames
;

576 
u32
 
	msiso_‰ames
;

577 
u32
 
	mmimo2_‰ames
;

578 
u32
 
	magg_‰ames
;

579 
u32
 
	mampdu_cou¡
;

580 
u32
 
	msuc˚ss_‰ames
;

581 
u32
 
	mÁû_‰ames
;

582 
u32
 
	mœ°_øãs
[
IWL_MVM_NUM_LAST_FRAMES_UCODE_RATES
];

583 
	mœ°_‰ame_idx
;

586 
	#IWL_MVM_DEBUG_SET_TEMPERATURE_DISABLE
 0xff

	)

587 
	#IWL_MVM_DEBUG_SET_TEMPERATURE_MIN
 -100

	)

588 
	#IWL_MVM_DEBUG_SET_TEMPERATURE_MAX
 200

	)

590 
	eiwl_mvm_tdls_cs_°©e
 {

591 
	mIWL_MVM_TDLS_SW_IDLE
 = 0,

592 
	mIWL_MVM_TDLS_SW_REQ_SENT
,

593 
	mIWL_MVM_TDLS_SW_RESP_RCVD
,

594 
	mIWL_MVM_TDLS_SW_REQ_RCVD
,

595 
	mIWL_MVM_TDLS_SW_ACTIVE
,

598 
	eiwl_mvm_åaffic_lﬂd
 {

599 
	mIWL_MVM_TRAFFIC_LOW
,

600 
	mIWL_MVM_TRAFFIC_MEDIUM
,

601 
	mIWL_MVM_TRAFFIC_HIGH
,

604 
	$DECLARE_EWMA
(
øã
, 16, 16)

606 
	siwl_mvm_tcm_mac
 {

608 
u32
 
pkts
[
IEEE80211_NUM_ACS
];

609 
u32
 
aútime
;

610 } 
tx
;

612 
u32
 
pkts
[
IEEE80211_NUM_ACS
];

613 
u32
 
aútime
;

614 
u32
 
œ°_ampdu_ªf
;

615 } 
rx
;

618 
u64
 
rx_byãs
;

619 
ewma_øã
 
øã
;

620 
boﬁ
 
dëe˘ed
;

621 } 
u≠sd_n⁄agg_dëe˘
;

622 
boﬁ
 
›íed_rx_ba_£ssi⁄s
;

625 
	siwl_mvm_tcm
 {

626 
dñayed_w‹k
 
w‹k
;

627 
•ölock_t
 
lock
;

628 
ts
;

629 
Œ_ts
;

630 
u≠sd_n⁄agg_ts
;

631 
boﬁ
 
∑u£d
;

632 
iwl_mvm_tcm_mac
 
d©a
[
NUM_MAC_INDEX_DRIVER
];

634 
u32
 
ñ≠£d
;

635 
u32
 
aútime
[
NUM_MAC_INDEX_DRIVER
];

636 
iwl_mvm_åaffic_lﬂd
 
lﬂd
[
NUM_MAC_INDEX_DRIVER
];

637 
iwl_mvm_åaffic_lﬂd
 
b™d_lﬂd
[
NUM_NL80211_BANDS
];

638 
iwl_mvm_åaffic_lﬂd
 
globÆ_lﬂd
;

639 
boﬁ
 
low_œãncy
[
NUM_MAC_INDEX_DRIVER
];

640 
boﬁ
 
ch™ge
[
NUM_MAC_INDEX_DRIVER
];

641 } 
ªsu…
;

656 
	siwl_mvm_ª‹dî_buf„r
 {

657 
u16
 
hód_¢
;

658 
u16
 
num_°‹ed
;

659 
u16
 
buf_size
;

660 
queue
;

661 
u16
 
œ°_amsdu
;

662 
u8
 
œ°_sub_ödex
;

663 
boﬁ
 
vÆid
;

664 
•ölock_t
 
lock
;

665 
iwl_mvm
 *
mvm
;

666 } 
____ˇchñöe_Æig√d_ö_smp
;

672 
	siwl_mvm_ª‹dî_buf_íåy
 {

673 
sk_buff_hód
 
‰ames
;

675 #i‚de‡
__CHECKER__


677 
	`__Æig√d
(
	`roundup_pow_of_two
((
sk_buff_hód
)))

697 
	siwl_mvm_baid_d©a
 {

698 
rcu_hód
Ñcu_head;

699 
u32
 
°a_mask
;

700 
u8
 
tid
;

701 
u8
 
baid
;

702 
u16
 
timeout
;

703 
u16
 
íåõs_≥r_queue
;

704 
œ°_rx
;

705 
timî_li°
 
£ssi⁄_timî
;

706 
iwl_mvm_baid_d©a
 
__rcu
 **
rcu_±r
;

707 
iwl_mvm
 *
mvm
;

708 
iwl_mvm_ª‹dî_buf„r
 
ª‹dî_buf
[
IWL_MAX_RX_HW_QUEUES
];

709 
iwl_mvm_ª‹dî_buf_íåy
 
íåõs
[];

712 
ölöe
 
iwl_mvm_baid_d©a
 *

713 
	$iwl_mvm_baid_d©a_‰om_ª‹dî_buf
(
iwl_mvm_ª‹dî_buf„r
 *
buf
)

715  (*)((
u8
 *)
buf
 -

716 
	`off£tof
(
iwl_mvm_baid_d©a
, 
ª‹dî_buf
) -

717 (*
buf
Ë* buf->
queue
);

718 
	}
}

740 
	eiwl_mvm_queue_°©us
 {

741 
	mIWL_MVM_QUEUE_FREE
,

742 
	mIWL_MVM_QUEUE_RESERVED
,

743 
	mIWL_MVM_QUEUE_READY
,

744 
	mIWL_MVM_QUEUE_SHARED
,

747 
	#IWL_MVM_DQA_QUEUE_TIMEOUT
 (5 * 
HZ
)

	)

748 
	#IWL_MVM_INVALID_QUEUE
 0xFFFF

	)

750 
	#IWL_MVM_NUM_CIPHERS
 10

	)

753 
	siwl_mvm_txq
 {

754 
li°_hód
 
	mli°
;

755 
u16
 
	mtxq_id
;

756 
©omic_t
 
	mtx_ªque°
;

757 
	#IWL_MVM_TXQ_STATE_STOP_FULL
 0

	)

758 
	#IWL_MVM_TXQ_STATE_STOP_REDIRECT
 1

	)

759 
	#IWL_MVM_TXQ_STATE_READY
 2

	)

760 
	m°©e
;

763 
ölöe
 
iwl_mvm_txq
 *

764 
	$iwl_mvm_txq_‰om_mac80211
(
õì80211_txq
 *
txq
)

766  (*)
txq
->
drv_¥iv
;

767 
	}
}

769 
ölöe
 
iwl_mvm_txq
 *

770 
	$iwl_mvm_txq_‰om_tid
(
õì80211_°a
 *
°a
, 
u8
 
tid
)

772 i‡(
tid
 =
IWL_MAX_TID_COUNT
)

773 
tid
 = 
IEEE80211_NUM_TIDS
;

775  (*)
°a
->
txq
[
tid
]->
drv_¥iv
;

776 
	}
}

784 
	siwl_mvm_tvqm_txq_öfo
 {

785 
u8
 
	m°a_id
;

786 
u8
 
	mtxq_tid
;

789 
	siwl_mvm_dqa_txq_öfo
 {

790 
u8
 
	mø_°a_id
;

791 
boﬁ
 
	mª£rved
;

792 
u8
 
	mmac80211_ac
;

793 
u8
 
	mtxq_tid
;

794 
u16
 
	mtid_bôm≠
;

796 
	mœ°_‰ame_time
[
IWL_MAX_TID_COUNT
 + 1];

797 
iwl_mvm_queue_°©us
 
	m°©us
;

800 
	s±p_d©a
 {

801 
±p_˛ock
 *
	m±p_˛ock
;

802 
±p_˛ock_öfo
 
	m±p_˛ock_öfo
;

804 
dñayed_w‹k
 
	mdw‹k
;

807 
u32
 
	mœ°_gp2
;

810 
u32
 
	mwøp_cou¡î
;

813 
u32
 
	msˇÀ_upd©e_gp2
;

816 
u64
 
	msˇÀ_upd©e_adj_time_ns
;

819 
u64
 
	msˇÀd_‰eq
;

822 
s64
 
	mdñè
;

825 
	siwl_time_sync_d©a
 {

826 
sk_buff_hód
 
	m‰ame_li°
;

827 
u8
 
	m≥î_addr
[
ETH_ALEN
];

828 
boﬁ
 
	ma˘ive
;

831 
	siwl_mei_sˇn_fûãr
 {

832 
boﬁ
 
	mis_mei_limôed_sˇn
;

833 
sk_buff_hód
 
	msˇn_ªs
;

834 
w‹k_°ru˘
 
	msˇn_w‹k
;

837 
	siwl_mvm
 {

839 
devi˚
 *
	mdev
;

841 
iwl_å™s
 *
	må™s
;

842 c⁄° 
iwl_fw
 *
	mfw
;

843 c⁄° 
iwl_cfg
 *
	mcfg
;

844 
iwl_phy_db
 *
	mphy_db
;

845 
õì80211_hw
 *
	mhw
;

848 
muãx
 
	mmuãx
;

849 
li°_hód
 
	masync_h™dÀrs_li°
;

850 
•ölock_t
 
	masync_h™dÀrs_lock
;

851 
w‹k_°ru˘
 
	masync_h™dÀrs_wk
;

854 
wùhy_w‹k
 
	masync_h™dÀrs_wùhy_wk
;

856 
w‹k_°ru˘
 
	mroc_d⁄e_wk
;

858 
	möô_°©us
;

860 
	m°©us
;

862 
u32
 
	mqueue_sync_cookõ
;

863 
	mqueue_sync_°©e
;

868 
iwl_mvm_vif
 *
	mbf_Ælowed_vif
;

870 
boﬁ
 
	mhw_ªgi°îed
;

871 
boﬁ
 
	mrfkûl_ß„_öô_d⁄e
;

873 
u8
 
	mcˇ_40mhz_w‹k¨ound
;

875 
u32
 
	mampdu_ªf
;

876 
boﬁ
 
	mampdu_toggÀ
;

878 
iwl_nŸif_waô_d©a
 
	mnŸif_waô
;

881 
mvm_°©i°ics_rx_v3
 
	mrx_°©s_v3
;

882 
mvm_°©i°ics_rx
 
	mrx_°©s
;

886 
u64
 
	mrx_time
;

887 
u64
 
	mtx_time
;

888 
u64
 
	m⁄_time_rf
;

889 
u64
 
	m⁄_time_sˇn
;

890 } 
	mødio_°©s
, 
	maccu_ødio_°©s
;

892 
li°_hód
 
	madd_°ªam_txqs
;

894 
iwl_mvm_dqa_txq_öfo
 
	mqueue_öfo
[
IWL_MAX_HW_QUEUES
];

895 
iwl_mvm_tvqm_txq_öfo
 
	mtvqm_öfo
[
IWL_MAX_TVQM_QUEUES
];

897 
w‹k_°ru˘
 
	madd_°ªam_wk
;

898 
•ölock_t
 
	madd_°ªam_lock
;

900 c⁄° *
	mnvm_fûe_«me
;

901 
iwl_nvm_d©a
 *
	mnvm_d©a
;

902 
iwl_mei_nvm
 *
	mmei_nvm_d©a
;

903 
iwl_mvm_csme_c⁄n_öfo
 
__rcu
 *
	mcsme_c⁄n_öfo
;

904 
boﬁ
 
	mmei_rfkûl_blocked
;

905 
boﬁ
 
	mmei_ªgi°îed
;

906 
w‹k_°ru˘
 
	mßp_c⁄√˘ed_wk
;

912 
iwl_nvm_d©a
 *
	mãmp_nvm_d©a
;

915 
iwl_nvm_£˘i⁄
 
	mnvm_£˘i⁄s
[
NVM_MAX_NUM_SECTIONS
];

917 
iwl_fw_ru¡ime
 
	mfwπ
;

920 
mac_addªss
 
	maddªs£s
[
IWL_MVM_MAX_ADDRESSES
];

923 
iwl_rx_phy_öfo
 
	mœ°_phy_öfo
;

924 
õì80211_°a
 
__rcu
 *
	mfw_id_to_mac_id
[
IWL_MVM_STATION_COUNT_MAX
];

925 
õì80211_lök_°a
 
__rcu
 *
	mfw_id_to_lök_°a
[
IWL_MVM_STATION_COUNT_MAX
];

926 
	mfw_lök_ids_m≠
;

927 
u8
 
	mrx_ba_£ssi⁄s
;

930 
u32
 
	mπs_thªshﬁd
;

933 
	msˇn_°©us
;

934 
size_t
 
	msˇn_cmd_size
;

935 *
	msˇn_cmd
;

936 
iwl_mˇ°_fûãr_cmd
 *
	mmˇ°_fûãr_cmd
;

938 
iwl_mvm_sˇn_ty≥
 
	msˇn_ty≥
;

939 
iwl_mvm_sˇn_ty≥
 
	mhb_sˇn_ty≥
;

941 
iwl_mvm_sched_sˇn_∑ss_Æl_°©es
 
	msched_sˇn_∑ss_Æl
;

942 
dñayed_w‹k
 
	msˇn_timeout_dw‹k
;

945 
	mmax_sˇns
;

948 
u32
 
	msˇn_uid_°©us
[
IWL_MVM_MAX_UMAC_SCANS
];

951 
u64
 
	msˇn_°¨t
;

954 
iwl_mvm_vif
 *
	msˇn_vif
;

955 
u8
 
	msˇn_lök_id
;

958 
u8
 
	msˇn_rx_™t
;

961 
iwl_mvm_öt_°a
 
	maux_°a
;

962 
iwl_mvm_öt_°a
 
	m¢if_°a
;

964 
boﬁ
 
	mœ°_ebs_suc˚ssful
;

966 
u8
 
	msˇn_œ°_™ã¬a_idx
;

967 
u8
 
	mmgmt_œ°_™ã¬a_idx
;

969 
u8
 
	m£t_tx_™t
;

970 
u8
 
	m£t_rx_™t
;

973 
iwl_sf_°©e
 
	msf_°©e
;

979 
díåy
 *
	mdebugfs_dú
;

980 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


981 
u32
 
	mdbgfs_§am_off£t
, 
	mdbgfs_§am_Àn
;

982 
u32
 
	mdbgfs_¥ph_ªg_addr
;

983 
boﬁ
 
	mdißbÀ_powî_off
;

984 
boﬁ
 
	mdißbÀ_powî_off_d3
;

985 
boﬁ
 
	mbóc⁄_öje˘_a˘ive
;

987 
boﬁ
 
	msˇn_ôî_nŸif_íabÀd
;

989 
debugfs_blob_wøµî
 
	mnvm_hw_blob
;

990 
debugfs_blob_wøµî
 
	mnvm_sw_blob
;

991 
debugfs_blob_wøµî
 
	mnvm_ˇlib_blob
;

992 
debugfs_blob_wøµî
 
	mnvm_¥od_blob
;

993 
debugfs_blob_wøµî
 
	mnvm_phy_sku_blob
;

994 
debugfs_blob_wøµî
 
	mnvm_ªg_blob
;

996 
iwl_mvm_‰ame_°©s
 
	mdrv_rx_°©s
;

997 
•ölock_t
 
	mdrv_°©s_lock
;

998 
u16
 
	mdbgfs_rx_phyöfo
;

1001 
iwl_mvm_phy_˘xt
 
	mphy_˘xts
[
NUM_PHY_CTX
];

1003 
li°_hód
 
	mtime_evít_li°
;

1004 
•ölock_t
 
	mtime_evít_lock
;

1010 
	mfw_key_èbÀ
[
BITS_TO_LONGS
(
STA_KEY_MAX_NUM
)];

1011 
u8
 
	mfw_key_dñëed
[
STA_KEY_MAX_NUM
];

1013 
õì80211_vif
 
__rcu
 *
	mvif_id_to_mac
[
NUM_MAC_INDEX_DRIVER
];

1015 
õì80211_bss_c⁄f
 
__rcu
 *
	mlök_id_to_lök_c⁄f
[
IWL_MVM_FW_MAX_LINK_ID
 + 1];

1018 
s8
 
	mfw_ª°¨t
;

1019 
u8
 *
	mîr‹_ªcovîy_buf
;

1021 #ifde‡
CONFIG_IWLWIFI_LEDS


1022 
Àd_˛assdev
 
	mÀd
;

1025 
õì80211_vif
 *
	mp2p_devi˚_vif
;

1027 #ifde‡
CONFIG_PM


1028 
wùhy_wowœn_suµ‹t
 
	mwowœn
;

1029 
	mgtk_ivÀn
, 
	mgtk_icvÀn
, 
	m±k_ivÀn
, 
	m±k_icvÀn
;

1032 
õì80211_sˇn_õs
 
	mnd_õs
;

1033 
cfg80211_m©ch_£t
 *
	mnd_m©ch_£ts
;

1034 
	mn_nd_m©ch_£ts
;

1035 
õì80211_ch™√l
 **
	mnd_ch™√ls
;

1036 
	mn_nd_ch™√ls
;

1037 
boﬁ
 
	m√t_dëe˘
;

1038 
u8
 
	mofÊﬂd_tid
;

1039 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


1040 
boﬁ
 
	md3_wake_syßs£π
;

1041 
boﬁ
 
	md3_ã°_a˘ive
;

1042 
u32
 
	md3_ã°_pme_±r
;

1043 
õì80211_vif
 *
	mkìp_vif
;

1044 
u32
 
	mœ°_√tdëe˘_sˇns
;

1048 
waô_queue_hód_t
 
	mrx_sync_waôq
;

1051 
iwl_bt_c€x_¥ofûe_nŸif
 
	mœ°_bt_nŸif
;

1052 
iwl_bt_c€x_ci_cmd
 
	mœ°_bt_ci_cmd
;

1054 
u8
 
	mbt_tx_¥io
;

1055 
iwl_bt_f‹˚_™t_mode
 
	mbt_f‹˚_™t_mode
;

1058 
li°_hód
 
	maux_roc_ã_li°
;

1061 
iwl_mvm_â_mgmt
 
	mthîmÆ_thrŸée
;

1062 #ifde‡
CONFIG_THERMAL


1063 
iwl_mvm_thîmÆ_devi˚
 
	mtz_devi˚
;

1064 
iwl_mvm_coﬁög_devi˚
 
	mcoﬁög_dev
;

1067 
s32
 
	mãm≥øtuª
;

1073 
boﬁ
 
	mãm≥øtuª_ã°
;

1075 
boﬁ
 
	mfw_°©ic_smps_ªque°
;

1077 
	mbt_c€x_œ°_tcm_ts
;

1078 
iwl_mvm_tcm
 
	mtcm
;

1080 
u8
 
	mu≠sd_nﬂgg_bssid_wrôe_idx
;

1081 
mac_addªss
 
	mu≠sd_nﬂgg_bssids
[
IWL_MVM_UAPSD_NOAGG_BSSIDS_NUM
]

1082 
__Æig√d
(2);

1084 
iwl_time_quŸa_cmd
 
	mœ°_quŸa_cmd
;

1086 #ifde‡
CONFIG_NL80211_TESTMODE


1087 
u32
 
	mnﬂ_duøti⁄
;

1088 
õì80211_vif
 *
	mnﬂ_vif
;

1092 
u16
 
	maux_queue
;

1093 
u16
 
	m¢if_queue
;

1094 
u16
 
	m¥obe_queue
;

1095 
u16
 
	mp2p_dev_queue
;

1098 
u8
 
	mps_dißbÀd
;

1100 
u32
 
	mext_˛ock_vÆid
;

1103 
õì80211_vif
 *
	mcsme_vif
;

1104 
õì80211_vif
 
__rcu
 *
	mcß_vif
;

1105 
õì80211_vif
 
__rcu
 *
	mcß_tx_blocked_vif
;

1106 
u8
 
	mcß_tx_block_b˙_timeout
;

1109 
u32
 
	m≠_œ°_bóc⁄_gp2
;

1112 
boﬁ
 
	mibss_m™agî
;

1114 
boﬁ
 
	mœr_ªgdom_£t
;

1115 
iwl_mcc_sour˚
 
	mmcc_§c
;

1119 
dñayed_w‹k
 
	mdw‹k
;

1120 
iwl_mvm_tdls_cs_°©e
 
	m°©e
;

1126 
u8
 
	mcur_°a_id
;

1130 
u8
 
	m°a_id
;

1131 
u8
 
	m›_˛ass
;

1132 
boﬁ
 
	möôüt‹
;

1133 
cfg80211_ch™_def
 
	mch™def
;

1134 
sk_buff
 *
	mskb
;

1135 
u32
 
	mch_sw_tm_õ
;

1138 
u32
 
	m£¡_time°amp
;

1139 } 
	m≥î
;

1140 } 
	mtdls_cs
;

1143 
u32
 
	mcùhîs
[
IWL_MVM_NUM_CIPHERS
];

1145 
cfg80211_·m_ª•⁄dî_°©s
 
	m·m_ª•_°©s
;

1147 
cfg80211_pm§_ªque°
 *
	mªq
;

1148 
wúñess_dev
 *
	mªq_wdev
;

1149 
li°_hód
 
	mloc_li°
;

1150 
	mª•⁄£s
[
IWL_MVM_TOF_MAX_APS
];

1152 
li°_hód
 
	mª•
;

1153 } 
	msmoŸh
;

1154 
li°_hód
 
	m∑¢_li°
;

1155 } 
	m·m_öôüt‹
;

1157 
li°_hód
 
	mª•_∑¢_li°
;

1159 
±p_d©a
 
	m±p_d©a
;

1162 
u8
 
	mønge_ª•
;

1163 } 
	mcmd_vî
;

1165 
õì80211_vif
 *
	m«n_vif
;

1166 
iwl_mvm_baid_d©a
 
__rcu
 *
	mbaid_m≠
[
IWL_MAX_BAID
];

1172 
boﬁ
 
	mdr›_b˙_≠_mode
;

1174 
dñayed_w‹k
 
	mcs_tx_unblock_dw‹k
;

1177 
boﬁ
 
	mm⁄ô‹_⁄
;

1182 
u8
 
	mm⁄ô‹_p80
;

1185 
__À16
 
	mcur_aid
;

1186 
u8
 
	mcur_bssid
[
ETH_ALEN
];

1188 #ifde‡
CONFIG_ACPI


1189 
iwl_phy_•ecific_cfg
 
	mphy_fûãrs
;

1192 
	mœ°_6ghz_∑ssive_sˇn_jiffõs
;

1193 
	mœ°_ª£t_‹_ªsume_time_jiffõs
;

1195 
boﬁ
 
	m°a_ªmove_ªquúes_queue_ªmove
;

1196 
boﬁ
 
	mmld_≠i_is_u£d
;

1198 
boﬁ
 
	m∂dr_sync
;

1200 
iwl_time_sync_d©a
 
	mtime_sync
;

1202 
iwl_mei_sˇn_fûãr
 
	mmei_sˇn_fûãr
;

1204 
boﬁ
 
	m°©i°ics_˛ór
;

1208 
	#IWL_OP_MODE_GET_MVM
(
_iwl_›_mode
) \

1209 ((
iwl_mvm
 *)(
_iwl_›_mode
)->
›_mode_•ecific
)

	)

1211 
	#IWL_MAC80211_GET_MVM
(
_hw
) \

1212 
	`IWL_OP_MODE_GET_MVM
((
iwl_›_mode
 *)((
_hw
)->
¥iv
))

	)

1229 
	eiwl_mvm_°©us
 {

1230 
	mIWL_MVM_STATUS_HW_RFKILL
,

1231 
	mIWL_MVM_STATUS_HW_CTKILL
,

1232 
	mIWL_MVM_STATUS_ROC_RUNNING
,

1233 
	mIWL_MVM_STATUS_HW_RESTART_REQUESTED
,

1234 
	mIWL_MVM_STATUS_IN_HW_RESTART
,

1235 
	mIWL_MVM_STATUS_ROC_AUX_RUNNING
,

1236 
	mIWL_MVM_STATUS_FIRMWARE_RUNNING
,

1237 
	mIWL_MVM_STATUS_IN_D3
,

1238 
	mIWL_MVM_STATUS_SUPPRESS_ERROR_LOG_ONCE
,

1239 
	mIWL_MVM_STATUS_STARTING
,

1242 
	siwl_mvm_csme_c⁄n_öfo
 {

1243 
rcu_hód
 
	mrcu_hód
;

1244 
iwl_mei_c⁄n_öfo
 
	mc⁄n_öfo
;

1248 
	eiwl_mvm_öô_°©us
 {

1249 
	mIWL_MVM_INIT_STATUS_THERMAL_INIT_COMPLETE
 = 
BIT
(0),

1250 
	mIWL_MVM_INIT_STATUS_LEDS_INIT_COMPLETE
 = 
BIT
(1),

1253 
ölöe
 
boﬁ
 
	$iwl_mvm_is_ødio_kûÀd
(
iwl_mvm
 *
mvm
)

1255  
	`ã°_bô
(
IWL_MVM_STATUS_HW_RFKILL
, &
mvm
->
°©us
) ||

1256 
	`ã°_bô
(
IWL_MVM_STATUS_HW_CTKILL
, &
mvm
->
°©us
);

1257 
	}
}

1259 
ölöe
 
boﬁ
 
	$iwl_mvm_is_ødio_hw_kûÀd
(
iwl_mvm
 *
mvm
)

1261  
	`ã°_bô
(
IWL_MVM_STATUS_HW_RFKILL
, &
mvm
->
°©us
);

1262 
	}
}

1264 
ölöe
 
boﬁ
 
	$iwl_mvm_fúmw¨e_ru¬ög
(
iwl_mvm
 *
mvm
)

1266  
	`ã°_bô
(
IWL_MVM_STATUS_FIRMWARE_RUNNING
, &
mvm
->
°©us
);

1267 
	}
}

1272 
ölöe
 
iwl_mvm_°a
 *

1273 
	$iwl_mvm_°a_‰om_°aid_rcu
(
iwl_mvm
 *
mvm
, 
u8
 
°a_id
)

1275 
õì80211_°a
 *
°a
;

1277 i‡(
°a_id
 >
mvm
->
fw
->
ucode_ˇ∑
.
num_°©i⁄s
)

1278  
NULL
;

1280 
°a
 = 
	`rcu_dîe„ªn˚
(
mvm
->
fw_id_to_mac_id
[
°a_id
]);

1283 i‡(
	`IS_ERR_OR_NULL
(
°a
))

1284  
NULL
;

1286  
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

1287 
	}
}

1289 
ölöe
 
iwl_mvm_°a
 *

1290 
	$iwl_mvm_°a_‰om_°aid_¥Ÿe˘ed
(
iwl_mvm
 *
mvm
, 
u8
 
°a_id
)

1292 
õì80211_°a
 *
°a
;

1294 i‡(
°a_id
 >
mvm
->
fw
->
ucode_ˇ∑
.
num_°©i⁄s
)

1295  
NULL
;

1297 
°a
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm
->
fw_id_to_mac_id
[
°a_id
],

1298 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

1301 i‡(
	`IS_ERR_OR_NULL
(
°a
))

1302  
NULL
;

1304  
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

1305 
	}
}

1307 
ölöe
 
õì80211_vif
 *

1308 
	$iwl_mvm_rcu_dîe„ªn˚_vif_id
(
iwl_mvm
 *
mvm
, 
u8
 
vif_id
, 
boﬁ
 
rcu
)

1310 i‡(
	`WARN_ON
(
vif_id
 >
	`ARRAY_SIZE
(
mvm
->
vif_id_to_mac
)))

1311  
NULL
;

1313 i‡(
rcu
)

1314  
	`rcu_dîe„ªn˚
(
mvm
->
vif_id_to_mac
[
vif_id
]);

1316  
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm
->
vif_id_to_mac
[
vif_id
],

1317 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

1318 
	}
}

1320 
ölöe
 
õì80211_bss_c⁄f
 *

1321 
	$iwl_mvm_rcu_fw_lök_id_to_lök_c⁄f
(
iwl_mvm
 *
mvm
, 
u8
 
lök_id
, 
boﬁ
 
rcu
)

1323 i‡(
	`WARN_ON
(
lök_id
 >
	`ARRAY_SIZE
(
mvm
->
lök_id_to_lök_c⁄f
)))

1324  
NULL
;

1326 i‡(
rcu
)

1327  
	`rcu_dîe„ªn˚
(
mvm
->
lök_id_to_lök_c⁄f
[
lök_id
]);

1329  
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm
->
lök_id_to_lök_c⁄f
[
lök_id
],

1330 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

1331 
	}
}

1333 
ölöe
 
boﬁ
 
	$iwl_mvm_is_ad≠tive_dwñl_suµ‹ãd
(
iwl_mvm
 *
mvm
)

1335  
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

1336 
IWL_UCODE_TLV_API_ADAPTIVE_DWELL
);

1337 
	}
}

1339 
ölöe
 
boﬁ
 
	$iwl_mvm_is_ad≠tive_dwñl_v2_suµ‹ãd
(
iwl_mvm
 *
mvm
)

1341  
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

1342 
IWL_UCODE_TLV_API_ADAPTIVE_DWELL_V2
);

1343 
	}
}

1345 
ölöe
 
boﬁ
 
	$iwl_mvm_is_adwñl_hb_≠_num_suµ‹ãd
(
iwl_mvm
 *
mvm
)

1347  
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

1348 
IWL_UCODE_TLV_API_ADWELL_HB_DEF_N_AP
);

1349 
	}
}

1351 
ölöe
 
boﬁ
 
	$iwl_mvm_is_o˚_suµ‹ãd
(
iwl_mvm
 *
mvm
)

1354  
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_API_OCE
);

1355 
	}
}

1357 
ölöe
 
boﬁ
 
	$iwl_mvm_is_‰ag_ebs_suµ‹ãd
(
iwl_mvm
 *
mvm
)

1359  
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_API_FRAG_EBS
);

1360 
	}
}

1362 
ölöe
 
boﬁ
 
	$iwl_mvm_is_sh‹t_bóc⁄_nŸif_suµ‹ãd
(
iwl_mvm
 *
mvm
)

1364  
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

1365 
IWL_UCODE_TLV_API_SHORT_BEACON_NOTIF
);

1366 
	}
}

1368 
ölöe
 
boﬁ
 
	$iwl_mvm_is_dqa_d©a_queue
(
iwl_mvm
 *
mvm
, 
u8
 
queue
)

1370  (
queue
 >
IWL_MVM_DQA_MIN_DATA_QUEUE
) &&

1371 (
queue
 <
IWL_MVM_DQA_MAX_DATA_QUEUE
);

1372 
	}
}

1374 
ölöe
 
boﬁ
 
	$iwl_mvm_is_dqa_mgmt_queue
(
iwl_mvm
 *
mvm
, 
u8
 
queue
)

1376  (
queue
 >
IWL_MVM_DQA_MIN_MGMT_QUEUE
) &&

1377 (
queue
 <
IWL_MVM_DQA_MAX_MGMT_QUEUE
);

1378 
	}
}

1380 
ölöe
 
boﬁ
 
	$iwl_mvm_is_œr_suµ‹ãd
(
iwl_mvm
 *
mvm
)

1382 
boﬁ
 
nvm_œr
 = 
mvm
->
nvm_d©a
->
œr_íabÀd
;

1383 
boﬁ
 
év_œr
 = 
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

1384 
IWL_UCODE_TLV_CAPA_LAR_SUPPORT
);

1390 i‡(
mvm
->
cfg
->
nvm_ty≥
 =
IWL_NVM_EXT
)

1391  
nvm_œr
 && 
év_œr
;

1393  
év_œr
;

1394 
	}
}

1396 
ölöe
 
boﬁ
 
	$iwl_mvm_is_wifi_mcc_suµ‹ãd
(
iwl_mvm
 *
mvm
)

1398  
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

1399 
IWL_UCODE_TLV_API_WIFI_MCC_UPDATE
) ||

1400 
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

1401 
IWL_UCODE_TLV_CAPA_LAR_MULTI_MCC
);

1402 
	}
}

1404 
ölöe
 
boﬁ
 
	$iwl_mvm_bt_is_ºc_suµ‹ãd
(
iwl_mvm
 *
mvm
)

1406  
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

1407 
IWL_UCODE_TLV_CAPA_BT_COEX_RRC
) &&

1408 
IWL_MVM_BT_COEX_RRC
;

1409 
	}
}

1411 
ölöe
 
boﬁ
 
	$iwl_mvm_is_csum_suµ‹ãd
(
iwl_mvm
 *
mvm
)

1413  
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

1414 
IWL_UCODE_TLV_CAPA_CSUM_SUPPORT
) &&

1415 !
IWL_MVM_HW_CSUM_DISABLE
;

1416 
	}
}

1418 
ölöe
 
boﬁ
 
	$iwl_mvm_is_m∂ut_suµ‹ãd
(
iwl_mvm
 *
mvm
)

1420  
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

1421 
IWL_UCODE_TLV_CAPA_BT_MPLUT_SUPPORT
) &&

1422 
IWL_MVM_BT_COEX_MPLUT
;

1423 
	}
}

1425 
ölöe


1426 
boﬁ
 
	$iwl_mvm_is_p2p_scm_u≠sd_suµ‹ãd
(
iwl_mvm
 *
mvm
)

1428  
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

1429 
IWL_UCODE_TLV_CAPA_P2P_SCM_UAPSD
) &&

1430 !(
iwlwifi_mod_∑øms
.
u≠sd_dißbÀ
 &

1431 
IWL_DISABLE_UAPSD_P2P_CLIENT
);

1432 
	}
}

1434 
ölöe
 
boﬁ
 
	$iwl_mvm_has_√w_rx_≠i
(
iwl_mvm
 *
mvm
)

1436  
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

1437 
IWL_UCODE_TLV_CAPA_MULTI_QUEUE_RX_SUPPORT
);

1438 
	}
}

1440 
ölöe
 
boﬁ
 
	$iwl_mvm_has_mld_≠i
(c⁄° 
iwl_fw
 *
fw
)

1442  
	`fw_has_ˇ∑
(&
fw
->
ucode_ˇ∑
,

1443 
IWL_UCODE_TLV_CAPA_MLD_API_SUPPORT
);

1444 
	}
}

1446 
ölöe
 
boﬁ
 
	$iwl_mvm_has_√w_°©i⁄_≠i
(c⁄° 
iwl_fw
 *
fw
)

1448  
	`iwl_mvm_has_mld_≠i
(
fw
) ||

1449 
	`iwl_fw_lookup_cmd_vî
(
fw
, 
ADD_STA
, 0) >= 12;

1450 
	}
}

1452 
ölöe
 
boﬁ
 
	$iwl_mvm_has_√w_tx_≠i
(
iwl_mvm
 *
mvm
)

1455  
mvm
->
å™s
->
å™s_cfg
->
gí2
;

1456 
	}
}

1458 
ölöe
 
boﬁ
 
	$iwl_mvm_has_unifõd_ucode
(
iwl_mvm
 *
mvm
)

1461  
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 >
IWL_DEVICE_FAMILY_22000
;

1462 
	}
}

1464 
ölöe
 
boﬁ
 
	$iwl_mvm_is_cdb_suµ‹ãd
(
iwl_mvm
 *
mvm
)

1475  
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

1476 
IWL_UCODE_TLV_CAPA_CDB_SUPPORT
);

1477 
	}
}

1479 
ölöe
 
boﬁ
 
	$iwl_mvm_cdb_sˇn_≠i
(
iwl_mvm
 *
mvm
)

1486  
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 >
IWL_DEVICE_FAMILY_22000
;

1487 
	}
}

1489 
ölöe
 
boﬁ
 
	$iwl_mvm_is_sˇn_ext_ch™_suµ‹ãd
(
iwl_mvm
 *
mvm
)

1491  
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

1492 
IWL_UCODE_TLV_API_SCAN_EXT_CHAN_VER
);

1493 
	}
}

1496 
ölöe
 
boﬁ
 
	$iwl_mvm_is_ªdu˚d_c⁄fig_sˇn_suµ‹ãd
(
iwl_mvm
 *
mvm
)

1498  
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

1499 
IWL_UCODE_TLV_API_REDUCED_SCAN_CONFIG
);

1500 
	}
}

1502 
ölöe
 
boﬁ
 
	$iwl_mvm_is_b™d_ö_rx_suµ‹ãd
(
iwl_mvm
 *
mvm
)

1504  
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

1505 
IWL_UCODE_TLV_API_BAND_IN_RX_DATA
);

1506 
	}
}

1508 
ölöe
 
boﬁ
 
	$iwl_mvm_has_√w_rx_°©s_≠i
(
iwl_mvm
 *
mvm
)

1510  
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

1511 
IWL_UCODE_TLV_API_NEW_RX_STATS
);

1512 
	}
}

1514 
ölöe
 
boﬁ
 
	$iwl_mvm_has_quŸa_low_œãncy
(
iwl_mvm
 *
mvm
)

1516  
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

1517 
IWL_UCODE_TLV_API_QUOTA_LOW_LATENCY
);

1518 
	}
}

1520 
ölöe
 
boﬁ
 
	$iwl_mvm_has_no_ho°_dißbÀ_tx
(
iwl_mvm
 *
mvm
)

1522  
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

1523 
IWL_UCODE_TLV_API_NO_HOST_DISABLE_TX
);

1524 
	}
}

1526 
ölöe
 
boﬁ
 
	$iwl_mvm_has_éc_ofÊﬂd
(c⁄° 
iwl_mvm
 *
mvm
)

1528  
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

1529 
IWL_UCODE_TLV_CAPA_TLC_OFFLOAD
);

1530 
	}
}

1532 
ölöe
 
agg_tx_°©us
 *

1533 
	$iwl_mvm_gë_agg_°©us
(
iwl_mvm
 *
mvm
, *
tx_ª•
)

1535 i‡(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
))

1536  &((
iwl_mvm_tx_ª•
 *)
tx_ª•
)->
°©us
;

1538  ((
iwl_mvm_tx_ª•_v3
 *)
tx_ª•
)->
°©us
;

1539 
	}
}

1541 
ölöe
 
boﬁ
 
	$iwl_mvm_is_â_ö_fw
(
iwl_mvm
 *
mvm
)

1547  
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

1548 
IWL_UCODE_TLV_CAPA_CT_KILL_BY_FW
) &&

1549 
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

1550 
IWL_UCODE_TLV_CAPA_TEMP_THS_REPORT_SUPPORT
);

1551 
	}
}

1553 
ölöe
 
boﬁ
 
	$iwl_mvm_is_˘dp_suµ‹ãd
(
iwl_mvm
 *
mvm
)

1555  
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

1556 
IWL_UCODE_TLV_CAPA_CTDP_SUPPORT
);

1557 
	}
}

1559 
ölöe
 
boﬁ
 
	$iwl_mvm_is_e§_suµ‹ãd
(
iwl_å™s
 *
å™s
)

1561 i‡((
	`CSR_HW_RFID_TYPE
(
å™s
->
hw_rf_id
Ë=
IWL_CFG_RF_TYPE_FM
) &&

1562 !
	`CSR_HW_RFID_IS_CDB
(
å™s
->
hw_rf_id
))

1564  
	`CSR_HW_RFID_STEP
(
å™s
->
hw_rf_id
);

1566  
Ál£
;

1567 
	}
}

1569 
ölöe
 
	$iwl_mvm_max_a˘ive_löks
(
iwl_mvm
 *
mvm
,

1570 
õì80211_vif
 *
vif
)

1572 
iwl_å™s
 *
å™s
 = 
mvm
->
fwπ
.trans;

1573 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1575 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1577 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
)

1578  
mvm
->
fw
->
ucode_ˇ∑
.
num_bóc⁄s
;

1580 i‡((
	`iwl_mvm_is_e§_suµ‹ãd
(
å™s
) &&

1581 !
mvmvif
->
bt_c€x_e§_dißbÀd
) ||

1582 ((
	`CSR_HW_RFID_TYPE
(
å™s
->
hw_rf_id
Ë=
IWL_CFG_RF_TYPE_FM
 &&

1583 
	`CSR_HW_RFID_IS_CDB
(
å™s
->
hw_rf_id
))))

1584  
IWL_MVM_FW_MAX_ACTIVE_LINKS_NUM
;

1587 
	}
}

1589 c⁄° 
u8
 
iwl_mvm_ac_to_tx_fifo
[];

1590 c⁄° 
u8
 
iwl_mvm_ac_to_gí2_tx_fifo
[];

1591 c⁄° 
u8
 
iwl_mvm_ac_to_bz_tx_fifo
[];

1593 
ölöe
 
u8
 
	$iwl_mvm_mac_ac_to_tx_fifo
(
iwl_mvm
 *
mvm
,

1594 
õì80211_ac_numbîs
 
ac
)

1596 i‡(
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 >
IWL_DEVICE_FAMILY_BZ
)

1597  
iwl_mvm_ac_to_bz_tx_fifo
[
ac
];

1598 i‡(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
))

1599  
iwl_mvm_ac_to_gí2_tx_fifo
[
ac
];

1600  
iwl_mvm_ac_to_tx_fifo
[
ac
];

1601 
	}
}

1603 
	siwl_øã_öfo
 {

1604 
u8
 
	m∂˝
;

1605 
u8
 
	m∂˝_siso
;

1606 
u8
 
	m∂˝_mimo2
;

1607 
u8
 
	m∂˝_mimo3
;

1608 
u8
 
	mõì
;

1611 
__iwl_mvm_mac_°›
(
iwl_mvm
 *
mvm
);

1612 
__iwl_mvm_mac_°¨t
(
iwl_mvm
 *
mvm
);

1618 
iwl_run_öô_mvm_ucode
(
iwl_mvm
 *
mvm
);

1621 
iwl_mvm_Àgacy_hw_idx_to_mac80211_idx
(
u32
 
øã_n_Êags
,

1622 
∆80211_b™d
 
b™d
);

1623 
iwl_mvm_Àgacy_øã_to_mac80211_idx
(
u32
 
øã_n_Êags
,

1624 
∆80211_b™d
 
b™d
);

1625 
iwl_mvm_hwøã_to_tx_øã
(
u32
 
øã_n_Êags
,

1626 
∆80211_b™d
 
b™d
,

1627 
õì80211_tx_øã
 *
r
);

1628 
iwl_mvm_hwøã_to_tx_øã_v1
(
u32
 
øã_n_Êags
,

1629 
∆80211_b™d
 
b™d
,

1630 
õì80211_tx_øã
 *
r
);

1631 
u8
 
iwl_mvm_mac80211_idx_to_hwøã
(c⁄° 
iwl_fw
 *
fw
, 
øã_idx
);

1632 
u8
 
iwl_mvm_mac80211_ac_to_ucode_ac
(
õì80211_ac_numbîs
 
ac
);

1633 
boﬁ
 
iwl_mvm_is_nic_ack_íabÀd
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
);

1635 
ölöe
 
	$iwl_mvm_dump_nic_îr‹_log
(
iwl_mvm
 *
mvm
)

1637 
	`iwl_fwπ_dump_îr‹_logs
(&
mvm
->
fwπ
);

1638 
	}
}

1640 
u8
 
fú°_™ã¬a
(u8 
mask
);

1641 
u8
 
iwl_mvm_√xt_™ã¬a
(
iwl_mvm
 *
mvm
, u8 
vÆid
, u8 
œ°_idx
);

1642 
iwl_mvm_gë_sync_time
(
iwl_mvm
 *
mvm
, 
˛ock_ty≥
, 
u32
 *
gp2
,

1643 
u64
 *
boŸtime
, 
ktime_t
 *
ªÆtime
);

1644 
u32
 
iwl_mvm_gë_sy°ime
(
iwl_mvm
 *
mvm
);

1647 
__mu°_check
 
iwl_mvm_£nd_cmd
(
iwl_mvm
 *
mvm
,

1648 
iwl_ho°_cmd
 *
cmd
);

1649 
__mu°_check
 
iwl_mvm_£nd_cmd_pdu
(
iwl_mvm
 *
mvm
, 
u32
 
id
,

1650 
u32
 
Êags
, 
u16
 
Àn
, c⁄° *
d©a
);

1651 
__mu°_check
 
iwl_mvm_£nd_cmd_°©us
(
iwl_mvm
 *
mvm
,

1652 
iwl_ho°_cmd
 *
cmd
,

1653 
u32
 *
°©us
);

1654 
__mu°_check
 
iwl_mvm_£nd_cmd_pdu_°©us
(
iwl_mvm
 *
mvm
, 
u32
 
id
,

1655 
u16
 
Àn
, c⁄° *
d©a
,

1656 
u32
 *
°©us
);

1657 
iwl_mvm_tx_skb_°a
(
iwl_mvm
 *
mvm
, 
sk_buff
 *
skb
,

1658 
õì80211_°a
 *
°a
);

1659 
iwl_mvm_tx_skb_n⁄_°a
(
iwl_mvm
 *
mvm
, 
sk_buff
 *
skb
);

1660 
iwl_mvm_£t_tx_cmd
(
iwl_mvm
 *
mvm
, 
sk_buff
 *
skb
,

1661 
iwl_tx_cmd
 *
tx_cmd
,

1662 
õì80211_tx_öfo
 *
öfo
, 
u8
 
°a_id
);

1663 
iwl_mvm_£t_tx_cmd_øã
(
iwl_mvm
 *
mvm
, 
iwl_tx_cmd
 *
tx_cmd
,

1664 
õì80211_tx_öfo
 *
öfo
,

1665 
õì80211_°a
 *
°a
, 
__À16
 
fc
);

1666 
iwl_mvm_mac_ôxq_xmô
(
õì80211_hw
 *
hw
, 
õì80211_txq
 *
txq
);

1667 
iwl_mvm_max_amsdu_size
(
iwl_mvm
 *
mvm
,

1668 
õì80211_°a
 *
°a
,

1669 
tid
);

1671 #ifde‡
CONFIG_IWLWIFI_DEBUG


1672 c⁄° *
iwl_mvm_gë_tx_Áû_ªas⁄
(
u32
 
°©us
);

1674 
ölöe
 c⁄° *
	$iwl_mvm_gë_tx_Áû_ªas⁄
(
u32
 
°©us
Ë{  ""; 
	}
}

1676 
iwl_mvm_Êush_tx_∑th
(
iwl_mvm
 *
mvm
, 
u32
 
tfd_msk
);

1677 
iwl_mvm_Êush_°a
(
iwl_mvm
 *
mvm
, 
u32
 
°a_id
, u32 
tfd_queue_mask
);

1678 
iwl_mvm_Êush_°a_tids
(
iwl_mvm
 *
mvm
, 
u32
 
°a_id
, 
u16
 
tids
);

1681 
__À32
 
iwl_mvm_gë_°a_htc_Êags
(
õì80211_°a
 *
°a
,

1682 
õì80211_lök_°a
 *
lök_°a
);

1683 
u8
 
iwl_mvm_gë_°a_u≠sd_acs
(
õì80211_°a
 *
°a
);

1684 
u32
 
iwl_mvm_gë_°a_ampdu_dís
(
õì80211_lök_°a
 *
lök_°a
,

1685 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

1686 
u32
 *
_agg_size
);

1687 
iwl_mvm_£t_°a_pkt_ext
(
iwl_mvm
 *
mvm
,

1688 
õì80211_lök_°a
 *
lök_°a
,

1689 
iwl_he_pkt_ext_v2
 *
pkt_ext
);

1691 
iwl_mvm_async_h™dÀrs_purge
(
iwl_mvm
 *
mvm
);

1693 
ölöe
 
	$iwl_mvm_£t_tx_cmd_ccmp
(
õì80211_tx_öfo
 *
öfo
,

1694 
iwl_tx_cmd
 *
tx_cmd
)

1696 
õì80211_key_c⁄f
 *
keyc⁄f
 = 
öfo
->
c⁄åﬁ
.
hw_key
;

1698 
tx_cmd
->
£c_˘l
 = 
TX_CMD_SEC_CCM
;

1699 
	`mem˝y
(
tx_cmd
->
key
, 
keyc⁄f
->key, keyc⁄f->
keyÀn
);

1700 
	}
}

1702 
ölöe
 
	$iwl_mvm_waô_f‹_async_h™dÀrs
(
iwl_mvm
 *
mvm
)

1704 
	`Êush_w‹k
(&
mvm
->
async_h™dÀrs_wk
);

1705 
	}
}

1708 
iwl_mvm_h™dÀ_rx_sy°em_›î_°©s
(
iwl_mvm
 *
mvm
,

1709 
iwl_rx_cmd_buf„r
 *
rxb
);

1710 
iwl_mvm_h™dÀ_rx_sy°em_›î_∑π1_°©s
(
iwl_mvm
 *
mvm
,

1711 
iwl_rx_cmd_buf„r
 *
rxb
);

1712 
ölöe
 

1713 
	$iwl_mvm_h™dÀ_rx_sy°em_íd_°©s_nŸif
(
iwl_mvm
 *
mvm
,

1714 
iwl_rx_cmd_buf„r
 *
rxb
)

1716 
	}
}

1718 
iwl_mvm_h™dÀ_rx_°©i°ics
(
iwl_mvm
 *
mvm
,

1719 
iwl_rx_∑ckë
 *
pkt
);

1720 
iwl_mvm_rx_°©i°ics
(
iwl_mvm
 *
mvm
,

1721 
iwl_rx_cmd_buf„r
 *
rxb
);

1722 
iwl_mvm_ªque°_°©i°ics
(
iwl_mvm
 *
mvm
, 
boﬁ
 
˛ór
);

1723 
iwl_mvm_accu_ødio_°©s
(
iwl_mvm
 *
mvm
);

1726 
iwl_nvm_öô
(
iwl_mvm
 *
mvm
);

1727 
iwl_mvm_lﬂd_nvm_to_nic
(
iwl_mvm
 *
mvm
);

1729 
ölöe
 
u8
 
	$iwl_mvm_gë_vÆid_tx_™t
(
iwl_mvm
 *
mvm
)

1731 
u8
 
tx_™t
 = 
mvm
->
fw
->
vÆid_tx_™t
;

1733 i‡(
mvm
->
nvm_d©a
 && mvm->nvm_d©a->
vÆid_tx_™t
)

1734 
tx_™t
 &
mvm
->
nvm_d©a
->
vÆid_tx_™t
;

1736 i‡(
mvm
->
£t_tx_™t
)

1737 
tx_™t
 &
mvm
->
£t_tx_™t
;

1739  
tx_™t
;

1740 
	}
}

1742 
ölöe
 
u8
 
	$iwl_mvm_gë_vÆid_rx_™t
(
iwl_mvm
 *
mvm
)

1744 
u8
 
rx_™t
 = 
mvm
->
fw
->
vÆid_tx_™t
;

1746 i‡(
mvm
->
nvm_d©a
 && mvm->nvm_d©a->
vÆid_rx_™t
)

1747 
rx_™t
 &
mvm
->
nvm_d©a
->
vÆid_tx_™t
;

1749 i‡(
mvm
->
£t_rx_™t
)

1750 
rx_™t
 &
mvm
->
£t_rx_™t
;

1752  
rx_™t
;

1754 
	}
}

1756 
ölöe
 
	$iwl_mvm_toggÀ_tx_™t
(
iwl_mvm
 *
mvm
, 
u8
 *
™t
)

1758 *
™t
 = 
	`iwl_mvm_√xt_™ã¬a
(
mvm
, 
	`iwl_mvm_gë_vÆid_tx_™t
(mvm), *ant);

1759 
	}
}

1761 
ölöe
 
u32
 
	$iwl_mvm_gë_phy_c⁄fig
(
iwl_mvm
 *
mvm
)

1763 
u32
 
phy_c⁄fig
 = ~(
FW_PHY_CFG_TX_CHAIN
 |

1764 
FW_PHY_CFG_RX_CHAIN
);

1765 
u32
 
vÆid_rx_™t
 = 
	`iwl_mvm_gë_vÆid_rx_™t
(
mvm
);

1766 
u32
 
vÆid_tx_™t
 = 
	`iwl_mvm_gë_vÆid_tx_™t
(
mvm
);

1768 
phy_c⁄fig
 |
vÆid_tx_™t
 << 
FW_PHY_CFG_TX_CHAIN_POS
 |

1769 
vÆid_rx_™t
 << 
FW_PHY_CFG_RX_CHAIN_POS
;

1771  
mvm
->
fw
->
phy_c⁄fig
 &Öhy_config;

1772 
	}
}

1774 
iwl_mvm_up
(
iwl_mvm
 *
mvm
);

1775 
iwl_mvm_lﬂd_d3_fw
(
iwl_mvm
 *
mvm
);

1777 
iwl_mvm_mac_£tup_ªgi°î
(
iwl_mvm
 *
mvm
);

1783 
iwl_mvm_rx_mq
(
iwl_›_mode
 *
›_mode
,

1784 
«pi_°ru˘
 *
«pi
,

1785 
iwl_rx_cmd_buf„r
 *
rxb
);

1786 
iwl_mvm_rx_rx_phy_cmd
(
iwl_mvm
 *
mvm
, 
iwl_rx_cmd_buf„r
 *
rxb
);

1787 
iwl_mvm_rx_rx_mpdu
(
iwl_mvm
 *
mvm
, 
«pi_°ru˘
 *
«pi
,

1788 
iwl_rx_cmd_buf„r
 *
rxb
);

1789 
iwl_mvm_rx_mpdu_mq
(
iwl_mvm
 *
mvm
, 
«pi_°ru˘
 *
«pi
,

1790 
iwl_rx_cmd_buf„r
 *
rxb
, 
queue
);

1791 
iwl_mvm_rx_m⁄ô‹_no_d©a
(
iwl_mvm
 *
mvm
, 
«pi_°ru˘
 *
«pi
,

1792 
iwl_rx_cmd_buf„r
 *
rxb
, 
queue
);

1793 
iwl_mvm_rx_‰ame_ªÀa£
(
iwl_mvm
 *
mvm
, 
«pi_°ru˘
 *
«pi
,

1794 
iwl_rx_cmd_buf„r
 *
rxb
, 
queue
);

1795 
iwl_mvm_rx_b¨_‰ame_ªÀa£
(
iwl_mvm
 *
mvm
, 
«pi_°ru˘
 *
«pi
,

1796 
iwl_rx_cmd_buf„r
 *
rxb
, 
queue
);

1797 
iwl_mvm_rx_queue_nŸif
(
iwl_mvm
 *
mvm
, 
«pi_°ru˘
 *
«pi
,

1798 
iwl_rx_cmd_buf„r
 *
rxb
, 
queue
);

1799 
iwl_mvm_rx_tx_cmd
(
iwl_mvm
 *
mvm
, 
iwl_rx_cmd_buf„r
 *
rxb
);

1800 
iwl_mvm_mfu_as£π_dump_nŸif
(
iwl_mvm
 *
mvm
,

1801 
iwl_rx_cmd_buf„r
 *
rxb
);

1802 
iwl_mvm_£nd_ªcovîy_cmd
(
iwl_mvm
 *
mvm
, 
u32
 
Êags
);

1803 
iwl_mvm_rx_ba_nŸif
(
iwl_mvm
 *
mvm
, 
iwl_rx_cmd_buf„r
 *
rxb
);

1804 
iwl_mvm_rx_™t_cou∂ög_nŸif
(
iwl_mvm
 *
mvm
,

1805 
iwl_rx_cmd_buf„r
 *
rxb
);

1806 
iwl_mvm_rx_fw_îr‹
(
iwl_mvm
 *
mvm
, 
iwl_rx_cmd_buf„r
 *
rxb
);

1807 
iwl_mvm_rx_mfu¨t_nŸif
(
iwl_mvm
 *
mvm
,

1808 
iwl_rx_cmd_buf„r
 *
rxb
);

1809 
iwl_mvm_rx_sh¨ed_mem_cfg_nŸif
(
iwl_mvm
 *
mvm
,

1810 
iwl_rx_cmd_buf„r
 *
rxb
);

1813 
iwl_mvm_phy_˘xt
 *
iwl_mvm_gë_‰ì_phy_˘xt
(
iwl_mvm
 *
mvm
);

1814 
iwl_mvm_phy_˘xt_add
(
iwl_mvm
 *
mvm
, 
iwl_mvm_phy_˘xt
 *
˘xt
,

1815 c⁄° 
cfg80211_ch™_def
 *
ch™def
,

1816 c⁄° 
cfg80211_ch™_def
 *
≠
,

1817 
u8
 
chaös_°©ic
, u8 
chaös_dy«mic
);

1818 
iwl_mvm_phy_˘xt_ch™ged
(
iwl_mvm
 *
mvm
, 
iwl_mvm_phy_˘xt
 *
˘xt
,

1819 c⁄° 
cfg80211_ch™_def
 *
ch™def
,

1820 c⁄° 
cfg80211_ch™_def
 *
≠
,

1821 
u8
 
chaös_°©ic
, u8 
chaös_dy«mic
);

1822 
iwl_mvm_phy_˘xt_ªf
(
iwl_mvm
 *
mvm
,

1823 
iwl_mvm_phy_˘xt
 *
˘xt
);

1824 
iwl_mvm_phy_˘xt_uƒef
(
iwl_mvm
 *
mvm
,

1825 
iwl_mvm_phy_˘xt
 *
˘xt
);

1826 
iwl_mvm_phy_˘x_cou¡
(
iwl_mvm
 *
mvm
);

1827 
u8
 
iwl_mvm_gë_ch™√l_width
(c⁄° 
cfg80211_ch™_def
 *
ch™def
);

1828 
u8
 
iwl_mvm_gë_˘æ_pos
(c⁄° 
cfg80211_ch™_def
 *
ch™def
);

1829 
iwl_mvm_phy_£nd_æc
(
iwl_mvm
 *
mvm
, 
iwl_mvm_phy_˘xt
 *
˘xt
,

1830 
u8
 
chaös_°©ic
, u8 
chaös_dy«mic
);

1834 
iwl_mvm_¥ï¨e_mac_ªmovÆ
(
iwl_mvm
 *
mvm
,

1835 
õì80211_vif
 *
vif
);

1836 
iwl_mvm_£t_fw_basic_øãs
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

1837 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

1838 
__À32
 *
cck_øãs
, __À32 *
ofdm_øãs
);

1839 
iwl_mvm_£t_fw_¥Ÿe˘i⁄_Êags
(
iwl_mvm
 *
mvm
,

1840 
õì80211_vif
 *
vif
,

1841 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

1842 
__À32
 *
¥Ÿe˘i⁄_Êags
, 
u32
 
ht_Êag
,

1843 
u32
 
tgg_Êag
);

1844 
iwl_mvm_£t_fw_qos_∑øms
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

1845 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

1846 
iwl_ac_qos
 *
ac
, 
__À32
 *
qos_Êags
);

1847 
boﬁ
 
iwl_mvm_£t_fw_mu_edˇ_∑øms
(
iwl_mvm
 *
mvm
,

1848 c⁄° 
iwl_mvm_vif_lök_öfo
 *
lök_öfo
,

1849 
iwl_he_backoff_c⁄f
 *
åig_ba£d_txf
);

1850 
iwl_mvm_£t_fw_dtim_tbâ
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

1851 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

1852 
__À64
 *
dtim_tsf
, 
__À32
 *
dtim_time
,

1853 
__À32
 *
assoc_bóc⁄_¨rive_time
);

1854 
__À32
 
iwl_mac_˘xt_p2p_dev_has_exãnded_disc
(
iwl_mvm
 *
mvm
,

1855 
õì80211_vif
 *
vif
);

1856 
iwl_mvm_mac_˘xt_cmd_≠_£t_fûãr_Êags
(
iwl_mvm
 *
mvm
,

1857 
iwl_mvm_vif
 *
mvmvif
,

1858 
__À32
 *
fûãr_Êags
,

1859 
ac˚±_¥obe_ªq_Êag
,

1860 
ac˚±_bóc⁄_Êag
);

1861 
iwl_mvm_gë_mac_ty≥
(
õì80211_vif
 *
vif
);

1862 
__À32
 
iwl_mvm_mac_˘xt_cmd_p2p_°a_gë_›µs_˘wö
(
iwl_mvm
 *
mvm
,

1863 
õì80211_vif
 *
vif
);

1864 
u32
 
iwl_mvm_mac_˘xt_cmd_°a_gë_twt_pﬁicy
(
iwl_mvm
 *
mvm
,

1865 
õì80211_vif
 *
vif
);

1866 
iwl_mvm_mld_mac_˘xt_add
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
);

1867 
iwl_mvm_mld_mac_˘xt_ch™ged
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

1868 
boﬁ
 
f‹˚_assoc_off
);

1869 
iwl_mvm_mld_mac_˘xt_ªmove
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
);

1870 
iwl_mvm_mac_˘xt_öô
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
);

1871 
iwl_mvm_mac_˘xt_add
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
);

1872 
iwl_mvm_mac_˘xt_ch™ged
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

1873 
boﬁ
 
f‹˚_assoc_off
, c⁄° 
u8
 *
bssid_ovîride
);

1874 
iwl_mvm_mac_˘xt_ªmove
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
);

1875 
iwl_mvm_mac_˘xt_bóc⁄_ch™ged
(
iwl_mvm
 *
mvm
,

1876 
õì80211_vif
 *
vif
,

1877 
õì80211_bss_c⁄f
 *
lök_c⁄f
);

1878 
iwl_mvm_mac_˘xt_£nd_bóc⁄_cmd
(
iwl_mvm
 *
mvm
,

1879 
sk_buff
 *
bóc⁄
,

1880 *
d©a
, 
Àn
);

1881 
u8
 
iwl_mvm_mac_˘xt_gë_bóc⁄_øã
(
iwl_mvm
 *
mvm
,

1882 
õì80211_tx_öfo
 *
öfo
,

1883 
õì80211_vif
 *
vif
);

1884 
u8
 
iwl_mvm_mac_˘xt_gë_lowe°_øã
(
iwl_mvm
 *
mvm
,

1885 
õì80211_tx_öfo
 *
öfo
,

1886 
õì80211_vif
 *
vif
);

1887 
u16
 
iwl_mvm_mac_˘xt_gë_bóc⁄_Êags
(c⁄° 
iwl_fw
 *
fw
,

1888 
u8
 
øã_idx
);

1889 
iwl_mvm_mac_˘xt_£t_tim
(
iwl_mvm
 *
mvm
,

1890 
__À32
 *
tim_ödex
, __À32 *
tim_size
,

1891 
u8
 *
bóc⁄
, 
u32
 
‰ame_size
);

1892 
iwl_mvm_rx_bóc⁄_nŸif
(
iwl_mvm
 *
mvm
,

1893 
iwl_rx_cmd_buf„r
 *
rxb
);

1894 
iwl_mvm_rx_mis£d_bóc⁄s_nŸif
(
iwl_mvm
 *
mvm
,

1895 
iwl_rx_cmd_buf„r
 *
rxb
);

1896 
iwl_mvm_rx_°‹ed_bóc⁄_nŸif
(
iwl_mvm
 *
mvm
,

1897 
iwl_rx_cmd_buf„r
 *
rxb
);

1898 
iwl_mvm_mu_mimo_gΩ_nŸif
(
iwl_mvm
 *
mvm
,

1899 
iwl_rx_cmd_buf„r
 *
rxb
);

1900 
iwl_mvm_°a_pm_nŸif
(
iwl_mvm
 *
mvm
, 
iwl_rx_cmd_buf„r
 *
rxb
);

1901 
iwl_mvm_wödow_°©us_nŸif
(
iwl_mvm
 *
mvm
,

1902 
iwl_rx_cmd_buf„r
 *
rxb
);

1903 
iwl_mvm_mac_˘xt_ªˇlc_tsf_id
(
iwl_mvm
 *
mvm
,

1904 
õì80211_vif
 *
vif
);

1905 
iwl_mvm_¥obe_ª•_d©a_nŸif
(
iwl_mvm
 *
mvm
,

1906 
iwl_rx_cmd_buf„r
 *
rxb
);

1907 
iwl_mvm_rx_mis£d_v≠_nŸif
(
iwl_mvm
 *
mvm
,

1908 
iwl_rx_cmd_buf„r
 *
rxb
);

1909 
iwl_mvm_ch™√l_swôch_°¨t_nŸif
(
iwl_mvm
 *
mvm
,

1910 
iwl_rx_cmd_buf„r
 *
rxb
);

1911 
iwl_mvm_ch™√l_swôch_îr‹_nŸif
(
iwl_mvm
 *
mvm
,

1912 
iwl_rx_cmd_buf„r
 *
rxb
);

1914 
iwl_mvm_bödög_add_vif
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
);

1915 
iwl_mvm_bödög_ªmove_vif
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
);

1916 
u32
 
iwl_mvm_gë_lmac_id
(
iwl_mvm
 *
mvm
, 
∆80211_b™d
 
b™d
);

1919 
iwl_mvm_£t_lök_m≠pög
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

1920 
õì80211_bss_c⁄f
 *
lök_c⁄f
);

1921 
iwl_mvm_add_lök
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

1922 
õì80211_bss_c⁄f
 *
lök_c⁄f
);

1923 
iwl_mvm_lök_ch™ged
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

1924 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

1925 
u32
 
ch™ges
, 
boﬁ
 
a˘ive
);

1926 
iwl_mvm_un£t_lök_m≠pög
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

1927 
õì80211_bss_c⁄f
 *
lök_c⁄f
);

1928 
iwl_mvm_ªmove_lök
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

1929 
õì80211_bss_c⁄f
 *
lök_c⁄f
);

1930 
iwl_mvm_dißbÀ_lök
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

1931 
õì80211_bss_c⁄f
 *
lök_c⁄f
);

1934 
boﬁ
 
iwl_mvm_°¨t_≠_ibss_comm⁄
(
õì80211_hw
 *
hw
,

1935 
õì80211_vif
 *
vif
, *
ªt
);

1936 
iwl_mvm_°›_≠_ibss_comm⁄
(
iwl_mvm
 *
mvm
,

1937 
õì80211_vif
 *
vif
);

1940 
iwl_mvm_bss_öfo_ch™ged_°©i⁄_comm⁄
(
iwl_mvm
 *
mvm
,

1941 
õì80211_vif
 *
vif
,

1942 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

1943 
u64
 
ch™ges
);

1944 
iwl_mvm_bss_öfo_ch™ged_°©i⁄_assoc
(
iwl_mvm
 *
mvm
,

1945 
õì80211_vif
 *
vif
,

1946 
u64
 
ch™ges
);

1962 
	siwl_mvm_roc_›s
 {

1963 (*
	madd_aux_°a_f‹_hs20
)(
iwl_mvm
 *
	mmvm
, 
u32
 
	mlmac_id
);

1964 (*
	mlök
)(
iwl_mvm
 *
	mmvm
, 
õì80211_vif
 *
	mvif
);

1967 
iwl_mvm_roc_comm⁄
(
õì80211_hw
 *
hw
, 
õì80211_vif
 *
vif
,

1968 
õì80211_ch™√l
 *
ch™√l
, 
duøti⁄
,

1969 
õì80211_roc_ty≥
 
ty≥
,

1970 c⁄° 
iwl_mvm_roc_›s
 *
›s
);

1971 
iwl_mvm_ˇn˚l_roc
(
õì80211_hw
 *
hw
,

1972 
õì80211_vif
 *
vif
);

1974 
iwl_mvm_¥Ÿe˘_assoc
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

1975 
u32
 
duøti⁄_ovîride
, 
lök_id
);

1978 
ölöe
 
size_t
 
	$iwl_mvm_quŸa_cmd_size
(
iwl_mvm
 *
mvm
)

1980  
	`iwl_mvm_has_quŸa_low_œãncy
(
mvm
) ?

1981 (
iwl_time_quŸa_cmd
) :

1982 (
iwl_time_quŸa_cmd_v1
);

1983 
	}
}

1985 
ölöe
 
iwl_time_quŸa_d©a


1986 *
	$iwl_mvm_quŸa_cmd_gë_quŸa
(
iwl_mvm
 *
mvm
,

1987 
iwl_time_quŸa_cmd
 *
cmd
,

1988 
i
)

1990 
iwl_time_quŸa_d©a_v1
 *
quŸas
;

1992 i‡(
	`iwl_mvm_has_quŸa_low_œãncy
(
mvm
))

1993  &
cmd
->
quŸas
[
i
];

1995 
quŸas
 = (
iwl_time_quŸa_d©a_v1
 *)
cmd
->quotas;

1996  (
iwl_time_quŸa_d©a
 *)&
quŸas
[
i
];

1997 
	}
}

1999 
iwl_mvm_upd©e_quŸas
(
iwl_mvm
 *
mvm
, 
boﬁ
 
f‹˚_u∂ﬂd
,

2000 
õì80211_vif
 *
dißbÀd_vif
);

2003 
iwl_mvm_ªg_sˇn_°¨t
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

2004 
cfg80211_sˇn_ªque°
 *
ªq
,

2005 
õì80211_sˇn_õs
 *
õs
);

2006 
size_t
 
iwl_mvm_sˇn_size
(
iwl_mvm
 *
mvm
);

2007 
iwl_mvm_sˇn_°›
(
iwl_mvm
 *
mvm
, 
ty≥
, 
boﬁ
 
nŸify
);

2008 
iwl_mvm_max_sˇn_õ_Àn
(
iwl_mvm
 *
mvm
);

2009 
iwl_mvm_ªp‹t_sˇn_ab‹ãd
(
iwl_mvm
 *
mvm
);

2010 
iwl_mvm_sˇn_timeout_wk
(
w‹k_°ru˘
 *
w‹k
);

2013 
iwl_mvm_rx_lmac_sˇn_com∂ëe_nŸif
(
iwl_mvm
 *
mvm
,

2014 
iwl_rx_cmd_buf„r
 *
rxb
);

2015 
iwl_mvm_rx_lmac_sˇn_ôî_com∂ëe_nŸif
(
iwl_mvm
 *
mvm
,

2016 
iwl_rx_cmd_buf„r
 *
rxb
);

2017 
iwl_mvm_sched_sˇn_°¨t
(
iwl_mvm
 *
mvm
,

2018 
õì80211_vif
 *
vif
,

2019 
cfg80211_sched_sˇn_ªque°
 *
ªq
,

2020 
õì80211_sˇn_õs
 *
õs
,

2021 
ty≥
);

2022 
iwl_mvm_rx_sˇn_m©ch_found
(
iwl_mvm
 *
mvm
,

2023 
iwl_rx_cmd_buf„r
 *
rxb
);

2026 
iwl_mvm_c⁄fig_sˇn
(
iwl_mvm
 *
mvm
);

2027 
iwl_mvm_rx_umac_sˇn_com∂ëe_nŸif
(
iwl_mvm
 *
mvm
,

2028 
iwl_rx_cmd_buf„r
 *
rxb
);

2029 
iwl_mvm_rx_umac_sˇn_ôî_com∂ëe_nŸif
(
iwl_mvm
 *
mvm
,

2030 
iwl_rx_cmd_buf„r
 *
rxb
);

2033 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


2034 
iwl_mvm_dbgfs_ªgi°î
(
iwl_mvm
 *
mvm
);

2035 
iwl_mvm_vif_add_debugfs
(
õì80211_hw
 *
hw
, 
õì80211_vif
 *
vif
);

2036 
iwl_mvm_vif_dbgfs_add_lök
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
);

2037 
iwl_mvm_vif_dbgfs_rm_lök
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
);

2039 
ölöe
 
	$iwl_mvm_dbgfs_ªgi°î
(
iwl_mvm
 *
mvm
)

2041 
	}
}

2042 
ölöe
 

2043 
	$iwl_mvm_vif_dbgfs_add_lök
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

2045 
	}
}

2046 
ölöe
 

2047 
	$iwl_mvm_vif_dbgfs_rm_lök
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

2049 
	}
}

2053 
iwl_mvm_£nd_lq_cmd
(
iwl_mvm
 *
mvm
, 
iwl_lq_cmd
 *
lq
);

2054 
iwl_mvm_upd©e_‰ame_°©s
(
iwl_mvm
 *
mvm
, 
u32
 
øã
, 
boﬁ
 
agg
);

2055 
rs_¥ëty_¥öt_øã_v1
(*
buf
, 
bufsz
, c⁄° 
u32
 
øã
);

2056 
rs_upd©e_œ°_rssi
(
iwl_mvm
 *
mvm
,

2057 
iwl_mvm_°a
 *
mvm°a
,

2058 
õì80211_rx_°©us
 *
rx_°©us
);

2061 
iwl_mvm_powî_upd©e_devi˚
(
iwl_mvm
 *
mvm
);

2062 
iwl_mvm_powî_upd©e_mac
(
iwl_mvm
 *
mvm
);

2063 
iwl_mvm_powî_upd©e_ps
(
iwl_mvm
 *
mvm
);

2064 
iwl_mvm_powî_mac_dbgfs_ªad
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

2065 *
buf
, 
bufsz
);

2067 
iwl_mvm_powî_vif_assoc
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
);

2068 
iwl_mvm_powî_u≠sd_misbehavög_≠_nŸif
(
iwl_mvm
 *
mvm
,

2069 
iwl_rx_cmd_buf„r
 *
rxb
);

2071 #ifde‡
CONFIG_IWLWIFI_LEDS


2072 
iwl_mvm_Àds_öô
(
iwl_mvm
 *
mvm
);

2073 
iwl_mvm_Àds_exô
(
iwl_mvm
 *
mvm
);

2074 
iwl_mvm_Àds_sync
(
iwl_mvm
 *
mvm
);

2076 
ölöe
 
	$iwl_mvm_Àds_öô
(
iwl_mvm
 *
mvm
)

2079 
	}
}

2080 
ölöe
 
	$iwl_mvm_Àds_exô
(
iwl_mvm
 *
mvm
)

2082 
	}
}

2083 
ölöe
 
	$iwl_mvm_Àds_sync
(
iwl_mvm
 *
mvm
)

2085 
	}
}

2089 
iwl_mvm_su•íd
(
õì80211_hw
 *
hw
, 
cfg80211_wowœn
 *
wowœn
);

2090 
iwl_mvm_ªsume
(
õì80211_hw
 *
hw
);

2091 
iwl_mvm_£t_wakeup
(
õì80211_hw
 *
hw
, 
boﬁ
 
íabÀd
);

2092 
iwl_mvm_£t_ªkey_d©a
(
õì80211_hw
 *
hw
,

2093 
õì80211_vif
 *
vif
,

2094 
cfg80211_gtk_ªkey_d©a
 *
d©a
);

2095 
iwl_mvm_ùv6_addr_ch™ge
(
õì80211_hw
 *
hw
,

2096 
õì80211_vif
 *
vif
,

2097 
öë6_dev
 *
idev
);

2098 
iwl_mvm_£t_deÁu…_uniˇ°_key
(
õì80211_hw
 *
hw
,

2099 
õì80211_vif
 *
vif
, 
idx
);

2100 c⁄° 
fûe_›î©i⁄s
 
iwl_dbgfs_d3_ã°_›s
;

2101 #ifde‡
CONFIG_PM


2102 
iwl_mvm_£t_œ°_n⁄qos_£q
(
iwl_mvm
 *
mvm
,

2103 
õì80211_vif
 *
vif
);

2105 
ölöe
 

2106 
	$iwl_mvm_£t_œ°_n⁄qos_£q
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

2108 
	}
}

2110 
iwl_mvm_£t_wowœn_qos_£q
(
iwl_mvm_°a
 *
mvm_≠_°a
,

2111 
iwl_wowœn_c⁄fig_cmd
 *
cmd
);

2112 
iwl_mvm_£nd_¥Ÿo_ofÊﬂd
(
iwl_mvm
 *
mvm
,

2113 
õì80211_vif
 *
vif
,

2114 
boﬁ
 
dißbÀ_ofÊﬂdög
,

2115 
boﬁ
 
ofÊﬂd_ns
,

2116 
u32
 
cmd_Êags
);

2119 
iwl_mvm_£nd_bt_öô_c⁄f
(
iwl_mvm
 *
mvm
);

2120 
iwl_mvm_rx_bt_c€x_nŸif
(
iwl_mvm
 *
mvm
,

2121 
iwl_rx_cmd_buf„r
 *
rxb
);

2122 
iwl_mvm_bt_rssi_evít
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

2123 
õì80211_rssi_evít_d©a
);

2124 
iwl_mvm_bt_c€x_vif_ch™ge
(
iwl_mvm
 *
mvm
);

2125 
u16
 
iwl_mvm_c€x_agg_time_limô
(
iwl_mvm
 *
mvm
,

2126 
õì80211_°a
 *
°a
);

2127 
boﬁ
 
iwl_mvm_bt_c€x_is_mimo_Ælowed
(
iwl_mvm
 *
mvm
,

2128 
õì80211_°a
 *
°a
);

2129 
boﬁ
 
iwl_mvm_bt_c€x_is_™t_avaû
(
iwl_mvm
 *
mvm
, 
u8
 
™t
);

2130 
boﬁ
 
iwl_mvm_bt_c€x_is_sh¨ed_™t_avaû
(
iwl_mvm
 *
mvm
);

2131 
boﬁ
 
iwl_mvm_bt_c€x_is_çc_Ælowed
(
iwl_mvm
 *
mvm
,

2132 
∆80211_b™d
 
b™d
);

2133 
u8
 
iwl_mvm_bt_c€x_gë_sögÀ_™t_msk
(
iwl_mvm
 *
mvm
, u8 
íabÀd_™ts
);

2134 
u8
 
iwl_mvm_bt_c€x_tx_¥io
(
iwl_mvm
 *
mvm
, 
õì80211_hdr
 *
hdr
,

2135 
õì80211_tx_öfo
 *
öfo
, 
u8
 
ac
);

2136 
boﬁ
 
iwl_mvm_bt_c€x_ˇlcuœã_e§_mode
(
iwl_mvm
 *
mvm
,

2137 
õì80211_vif
 *
vif
,

2138 
lök_id
, 
¥im¨y_lök
);

2139 
iwl_mvm_bt_c€x_upd©e_vif_e§
(
iwl_mvm
 *
mvm
,

2140 
õì80211_vif
 *
vif
,

2141 
lök_id
);

2144 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


2146 
iwl_mvm_bóc⁄_fûãr_debugfs_∑ømëîs
(
õì80211_vif
 *
vif
,

2147 
iwl_bóc⁄_fûãr_cmd
 *
cmd
);

2149 
ölöe
 

2150 
	$iwl_mvm_bóc⁄_fûãr_debugfs_∑ømëîs
(
õì80211_vif
 *
vif
,

2151 
iwl_bóc⁄_fûãr_cmd
 *
cmd
)

2152 {
	}
}

2154 
iwl_mvm_íabÀ_bóc⁄_fûãr
(
iwl_mvm
 *
mvm
,

2155 
õì80211_vif
 *
vif
);

2156 
iwl_mvm_dißbÀ_bóc⁄_fûãr
(
iwl_mvm
 *
mvm
,

2157 
õì80211_vif
 *
vif
);

2159 
iwl_mvm_upd©e_smps
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

2160 
iwl_mvm_smps_ty≥_ªque°
 
ªq_ty≥
,

2161 
õì80211_smps_mode
 
smps_ªque°
,

2162 
lök_id
);

2164 
iwl_mvm_upd©e_smps_⁄_a˘ive_löks
(
iwl_mvm
 *
mvm
,

2165 
õì80211_vif
 *
vif
,

2166 
iwl_mvm_smps_ty≥_ªque°
 
ªq_ty≥
,

2167 
õì80211_smps_mode
 
smps_ªque°
);

2168 
boﬁ
 
iwl_mvm_rx_divîsôy_Ælowed
(
iwl_mvm
 *
mvm
,

2169 
iwl_mvm_phy_˘xt
 *
˘xt
);

2170 
iwl_mvm_upd©e_lök_smps
(
õì80211_vif
 *
vif
,

2171 
õì80211_bss_c⁄f
 *
lök_c⁄f
);

2174 
iwl_mvm_upd©e_low_œãncy
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

2175 
boﬁ
 
low_œãncy
,

2176 
iwl_mvm_low_œãncy_ˇu£
 
ˇu£
);

2178 
boﬁ
 
iwl_mvm_low_œãncy
(
iwl_mvm
 *
mvm
);

2179 
boﬁ
 
iwl_mvm_low_œãncy_b™d
(
iwl_mvm
 *
mvm
, 
∆80211_b™d
 
b™d
);

2180 
iwl_mvm_£nd_low_œãncy_cmd
(
iwl_mvm
 *
mvm
, 
boﬁ
 
low_œãncy
,

2181 
u16
 
mac_id
);

2184 
ölöe
 
boﬁ
 
	$iwl_mvm_vif_low_œãncy
(
iwl_mvm_vif
 *
mvmvif
)

2196  
mvmvif
->
low_œãncy_a˘uÆ
;

2197 
	}
}

2199 
ölöe


2200 
	$iwl_mvm_vif_£t_low_œãncy
(
iwl_mvm_vif
 *
mvmvif
, 
boﬁ
 
£t
,

2201 
iwl_mvm_low_œãncy_ˇu£
 
ˇu£
)

2203 
u8
 
√w_°©e
;

2205 i‡(
£t
)

2206 
mvmvif
->
low_œãncy
 |
ˇu£
;

2208 
mvmvif
->
low_œãncy
 &~
ˇu£
;

2214 i‡(
mvmvif
->
low_œãncy
 & 
LOW_LATENCY_DEBUGFS_FORCE_ENABLE
 &&

2215 
ˇu£
 !
LOW_LATENCY_DEBUGFS_FORCE_ENABLE
)

2218 i‡(
ˇu£
 =
LOW_LATENCY_DEBUGFS_FORCE_ENABLE
 && 
£t
)

2222 
√w_°©e
 = !!(
mvmvif
->
low_œãncy
 &

2223 
LOW_LATENCY_DEBUGFS_FORCE
);

2228 
√w_°©e
 = !!(
mvmvif
->
low_œãncy
 &

2229 ~(
LOW_LATENCY_DEBUGFS_FORCE_ENABLE
 |

2230 
LOW_LATENCY_DEBUGFS_FORCE
));

2232 
mvmvif
->
low_œãncy_a˘uÆ
 = 
√w_°©e
;

2233 
	}
}

2238 
ölöe
 
u32
 
	$iwl_mvm_ÊushabÀ_queues
(
iwl_mvm
 *
mvm
)

2240  ((
	`BIT
(
mvm
->
å™s
->
å™s_cfg
->
ba£_∑øms
->
num_of_queues
) - 1) &

2241 ~
	`BIT
(
IWL_MVM_DQA_CMD_QUEUE
));

2242 
	}
}

2244 
iwl_mvm_°›_devi˚
(
iwl_mvm
 *
mvm
);

2247 
iwl_mvm_â_tx_backoff
(
iwl_mvm
 *
mvm
, 
u32
 
backoff
);

2248 
iwl_mvm_ãmp_nŸif
(
iwl_mvm
 *
mvm
,

2249 
iwl_rx_cmd_buf„r
 *
rxb
);

2250 
iwl_mvm_â_h™dÀr
(
iwl_mvm
 *
mvm
);

2251 
iwl_mvm_thîmÆ_öôülize
(
iwl_mvm
 *
mvm
, 
u32
 
mö_backoff
);

2252 
iwl_mvm_thîmÆ_exô
(
iwl_mvm
 *
mvm
);

2253 
iwl_mvm_£t_hw_˘kûl_°©e
(
iwl_mvm
 *
mvm
, 
boﬁ
 
°©e
);

2254 
iwl_mvm_gë_ãmp
(
iwl_mvm
 *
mvm
, 
s32
 *
ãmp
);

2255 
iwl_mvm_˘_kûl_nŸif
(
iwl_mvm
 *
mvm
, 
iwl_rx_cmd_buf„r
 *
rxb
);

2256 
iwl_mvm_íãr_˘kûl
(
iwl_mvm
 *
mvm
);

2257 
iwl_mvm_£nd_ãmp_ªp‹t_ths_cmd
(
iwl_mvm
 *
mvm
);

2258 
iwl_mvm_˘dp_comm™d
(
iwl_mvm
 *
mvm
, 
u32
 
›
, u32 
budgë
);

2260 #i‡
IS_ENABLED
(
CONFIG_IWLMEI
)

2263 
iwl_mvm_víd‹_cmds_ªgi°î
(
iwl_mvm
 *
mvm
);

2267 
ölöe
 
	$iwl_mvm_víd‹_cmds_ªgi°î
(
iwl_mvm
 *
mvm
Ë{
	}
}

2272 
iwl_mcc_upd©e_ª•_v8
 *

2273 
iwl_mvm_upd©e_mcc
(
iwl_mvm
 *
mvm
, c⁄° *
Æpha2
,

2274 
iwl_mcc_sour˚
 
§c_id
);

2275 
iwl_mvm_öô_mcc
(
iwl_mvm
 *
mvm
);

2276 
iwl_mvm_rx_chub_upd©e_mcc
(
iwl_mvm
 *
mvm
,

2277 
iwl_rx_cmd_buf„r
 *
rxb
);

2278 
õì80211_ªgdomaö
 *
iwl_mvm_gë_ªgdomaö
(
wùhy
 *wiphy,

2279 c⁄° *
Æpha2
,

2280 
iwl_mcc_sour˚
 
§c_id
,

2281 
boﬁ
 *
ch™ged
);

2282 
õì80211_ªgdomaö
 *
iwl_mvm_gë_cuºít_ªgdomaö
(
iwl_mvm
 *
mvm
,

2283 
boﬁ
 *
ch™ged
);

2284 
iwl_mvm_öô_fw_ªgd
(
iwl_mvm
 *
mvm
, 
boﬁ
 
f‹˚_ªgd_sync
);

2285 
iwl_mvm_upd©e_ch™ged_ªgdom
(
iwl_mvm
 *
mvm
);

2288 
iwl_mvm_sf_upd©e
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

2289 
boﬁ
 
added_vif
);

2292 
iwl_mvm_·m_°¨t_ª•⁄dî
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

2293 
õì80211_bss_c⁄f
 *
bss_c⁄f
);

2294 
iwl_mvm_·m_ª°¨t_ª•⁄dî
(
iwl_mvm
 *
mvm
,

2295 
õì80211_vif
 *
vif
,

2296 
õì80211_bss_c⁄f
 *
bss_c⁄f
);

2297 
iwl_mvm_·m_ª•⁄dî_°©s
(
iwl_mvm
 *
mvm
,

2298 
iwl_rx_cmd_buf„r
 *
rxb
);

2299 
iwl_mvm_·m_ª•_ªmove_∑¢_°a
(
iwl_mvm
 *
mvm
,

2300 
õì80211_vif
 *
vif
, 
u8
 *
addr
);

2301 
iwl_mvm_·m_ª•odî_add_∑¢_°a
(
iwl_mvm
 *
mvm
,

2302 
õì80211_vif
 *
vif
,

2303 
u8
 *
addr
, 
u32
 
cùhî
, u8 *
tk
, u32 
tk_Àn
,

2304 
u8
 *
h…k
, 
u32
 
h…k_Àn
);

2305 
iwl_mvm_·m_ª•⁄dî_˛ór
(
iwl_mvm
 *
mvm
,

2306 
õì80211_vif
 *
vif
);

2309 
iwl_mvm_·m_ª°¨t
(
iwl_mvm
 *
mvm
);

2310 
iwl_mvm_·m_ønge_ª•
(
iwl_mvm
 *
mvm
,

2311 
iwl_rx_cmd_buf„r
 *
rxb
);

2312 
iwl_mvm_·m_lc_nŸif
(
iwl_mvm
 *
mvm
,

2313 
iwl_rx_cmd_buf„r
 *
rxb
);

2314 
iwl_mvm_·m_°¨t
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

2315 
cfg80211_pm§_ªque°
 *
ªque°
);

2316 
iwl_mvm_·m_ab‹t
(
iwl_mvm
 *
mvm
, 
cfg80211_pm§_ªque°
 *
ªq
);

2317 
iwl_mvm_·m_öôüt‹_smoŸh_c⁄fig
(
iwl_mvm
 *
mvm
);

2318 
iwl_mvm_·m_öôüt‹_smoŸh_°›
(
iwl_mvm
 *
mvm
);

2319 
iwl_mvm_·m_add_∑¢_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

2320 
u8
 *
addr
, 
u32
 
cùhî
, u8 *
tk
, u32 
tk_Àn
,

2321 
u8
 *
h…k
, 
u32
 
h…k_Àn
);

2322 
iwl_mvm_·m_ªmove_∑¢_°a
(
iwl_mvm
 *
mvm
, 
u8
 *
addr
);

2330 
	#IWL_MVM_TDLS_FW_TID
 4

	)

2332 
iwl_mvm_tdls_°a_cou¡
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
);

2333 
iwl_mvm_ã¨down_tdls_≥îs
(
iwl_mvm
 *
mvm
);

2334 
iwl_mvm_ªˇlc_tdls_°©e
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

2335 
boﬁ
 
°a_added
);

2336 
iwl_mvm_mac_mgd_¥Ÿe˘_tdls_discovî
(
õì80211_hw
 *
hw
,

2337 
õì80211_vif
 *
vif
,

2338 
lök_id
);

2339 
iwl_mvm_tdls_ch™√l_swôch
(
õì80211_hw
 *
hw
,

2340 
õì80211_vif
 *
vif
,

2341 
õì80211_°a
 *
°a
, 
u8
 
›î_˛ass
,

2342 
cfg80211_ch™_def
 *
ch™def
,

2343 
sk_buff
 *
tm∂_skb
, 
u32
 
ch_sw_tm_õ
);

2344 
iwl_mvm_tdls_ªcv_ch™√l_swôch
(
õì80211_hw
 *
hw
,

2345 
õì80211_vif
 *
vif
,

2346 
õì80211_tdls_ch_sw_∑øms
 *
∑øms
);

2347 
iwl_mvm_tdls_ˇn˚l_ch™√l_swôch
(
õì80211_hw
 *
hw
,

2348 
õì80211_vif
 *
vif
,

2349 
õì80211_°a
 *
°a
);

2350 
iwl_mvm_rx_tdls_nŸif
(
iwl_mvm
 *
mvm
, 
iwl_rx_cmd_buf„r
 *
rxb
);

2351 
iwl_mvm_tdls_ch_swôch_w‹k
(
w‹k_°ru˘
 *
w‹k
);

2353 
iwl_mvm_sync_rx_queues_öã∫Æ
(
iwl_mvm
 *
mvm
,

2354 
iwl_mvm_rxq_nŸif_ty≥
 
ty≥
,

2355 
boﬁ
 
sync
,

2356 c⁄° *
d©a
, 
u32
 
size
);

2357 
õì80211_vif
 *
iwl_mvm_gë_bss_vif
(
iwl_mvm
 *
mvm
);

2358 
õì80211_vif
 *
iwl_mvm_gë_vif_by_macid
(
iwl_mvm
 *
mvm
, 
u32
 
macid
);

2359 
boﬁ
 
iwl_mvm_is_vif_assoc
(
iwl_mvm
 *
mvm
);

2361 
	#MVM_TCM_PERIOD_MSEC
 500

	)

2362 
	#MVM_TCM_PERIOD
 (
HZ
 * 
MVM_TCM_PERIOD_MSEC
 / 1000)

	)

2363 
	#MVM_LL_PERIOD
 (10 * 
HZ
)

	)

2364 
iwl_mvm_tcm_w‹k
(
w‹k_°ru˘
 *
w‹k
);

2365 
iwl_mvm_ªˇlc_tcm
(
iwl_mvm
 *
mvm
);

2366 
iwl_mvm_∑u£_tcm
(
iwl_mvm
 *
mvm
, 
boﬁ
 
wôh_ˇn˚l
);

2367 
iwl_mvm_ªsume_tcm
(
iwl_mvm
 *
mvm
);

2368 
iwl_mvm_tcm_add_vif
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
);

2369 
iwl_mvm_tcm_rm_vif
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
);

2370 
u8
 
iwl_mvm_tcm_lﬂd_≥r˚¡age
(
u32
 
aútime
, u32 
ñ≠£d
);

2372 
iwl_mvm_nic_ª°¨t
(
iwl_mvm
 *
mvm
, 
boﬁ
 
fw_îr‹
);

2373 
iwl_mvm_gë_wd_timeout
(
iwl_mvm
 *
mvm
,

2374 
õì80211_vif
 *
vif
,

2375 
boﬁ
 
tdls
, boﬁ 
cmd_q
);

2376 
iwl_mvm_c⁄√˘i⁄_loss
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

2377 c⁄° *
îrmsg
);

2378 
iwl_mvm_evít_‰ame_timeout_ˇŒback
(
iwl_mvm
 *
mvm
,

2379 
õì80211_vif
 *
vif
,

2380 c⁄° 
õì80211_°a
 *
°a
,

2381 
u16
 
tid
);

2382 
iwl_mvm_mei_sˇn_fûãr_öô
(
iwl_mei_sˇn_fûãr
 *
mei_sˇn_fûãr
);

2384 
iwl_mvm_±p_öô
(
iwl_mvm
 *
mvm
);

2385 
iwl_mvm_±p_ªmove
(
iwl_mvm
 *
mvm
);

2386 
u64
 
iwl_mvm_±p_gë_adj_time
(
iwl_mvm
 *
mvm
, u64 
ba£_time
);

2387 
iwl_mvm_ßr_£À˘_¥ofûe
(
iwl_mvm
 *
mvm
, 
¥of_a
, 
¥of_b
);

2388 
iwl_mvm_gë_ßr_geo_¥ofûe
(
iwl_mvm
 *
mvm
);

2389 
iwl_mvm_µag_£nd_cmd
(
iwl_mvm
 *
mvm
);

2390 
iwl_mvm_gë_bios_èbÀs
(
iwl_mvm
 *
mvm
);

2391 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


2392 
iwl_mvm_lök_°a_add_debugfs
(
õì80211_hw
 *
hw
,

2393 
õì80211_vif
 *
vif
,

2394 
õì80211_lök_°a
 *
lök_°a
,

2395 
díåy
 *
dú
);

2396 
iwl_mvm_lök_add_debugfs
(
õì80211_hw
 *
hw
,

2397 
õì80211_vif
 *
vif
,

2398 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

2399 
díåy
 *
dú
);

2403 
iwl_mvm_£c_key_add
(
iwl_mvm
 *
mvm
,

2404 
õì80211_vif
 *
vif
,

2405 
õì80211_°a
 *
°a
,

2406 
õì80211_key_c⁄f
 *
keyc⁄f
);

2407 
iwl_mvm_£c_key_dñ
(
iwl_mvm
 *
mvm
,

2408 
õì80211_vif
 *
vif
,

2409 
õì80211_°a
 *
°a
,

2410 
õì80211_key_c⁄f
 *
keyc⁄f
);

2411 
iwl_mvm_£c_key_dñ_∑¢
(
iwl_mvm
 *
mvm
,

2412 
õì80211_vif
 *
vif
,

2413 
u32
 
°a_mask
,

2414 
õì80211_key_c⁄f
 *
keyc⁄f
);

2415 
iwl_mvm_£c_key_ªmove_≠
(
iwl_mvm
 *
mvm
,

2416 
õì80211_vif
 *
vif
,

2417 
iwl_mvm_vif_lök_öfo
 *
lök
,

2418 
lök_id
);

2419 
iwl_mvm_mld_upd©e_°a_keys
(
iwl_mvm
 *
mvm
,

2420 
õì80211_vif
 *
vif
,

2421 
õì80211_°a
 *
°a
,

2422 
u32
 
ﬁd_°a_mask
,

2423 
u32
 
√w_°a_mask
);

2424 
iwl_mvm_mld_£nd_key
(
iwl_mvm
 *
mvm
, 
u32
 
°a_mask
, u32 
key_Êags
,

2425 
õì80211_key_c⁄f
 *
keyc⁄f
);

2426 
u32
 
iwl_mvm_gë_£c_Êags
(
iwl_mvm
 *
mvm
,

2427 
õì80211_vif
 *
vif
,

2428 
õì80211_°a
 *
°a
,

2429 
õì80211_key_c⁄f
 *
keyc⁄f
);

2431 
boﬁ
 
iwl_rfi_suµ‹ãd
(
iwl_mvm
 *
mvm
);

2432 
iwl_rfi_£nd_c⁄fig_cmd
(
iwl_mvm
 *
mvm
,

2433 
iwl_rfi_lut_íåy
 *
rfi_èbÀ
);

2434 
iwl_rfi_‰eq_èbÀ_ª•_cmd
 *
iwl_rfi_gë_‰eq_èbÀ
(
iwl_mvm
 *
mvm
);

2435 
iwl_rfi_dó˘iv©e_nŸif_h™dÀr
(
iwl_mvm
 *
mvm
,

2436 
iwl_rx_cmd_buf„r
 *
rxb
);

2438 
ölöe
 
u8
 
	$iwl_mvm_phy_b™d_‰om_∆80211
(
∆80211_b™d
 
b™d
)

2440 
b™d
) {

2441 
NL80211_BAND_2GHZ
:

2442  
PHY_BAND_24
;

2443 
NL80211_BAND_5GHZ
:

2444  
PHY_BAND_5
;

2445 
NL80211_BAND_6GHZ
:

2446  
PHY_BAND_6
;

2448 
	`WARN_ONCE
(1, "Unsuµ‹ãd b™d (%u)\n", 
b™d
);

2449  
PHY_BAND_5
;

2451 
	}
}

2454 
iwl_mvm_ch™√l_swôch_disc⁄√˘_wk
(
w‹k_°ru˘
 *
wk
);

2455 
iwl_mvm_po°_ch™√l_swôch
(
õì80211_hw
 *
hw
,

2456 
õì80211_vif
 *
vif
,

2457 
õì80211_bss_c⁄f
 *
lök
);

2473 
	siwl_mvm_swôch_vif_ch™˘x_›s
 {

2474 (*
	m__assign_vif_ch™˘x
)(
iwl_mvm
 *
	mmvm
,

2475 
õì80211_vif
 *
	mvif
,

2476 
õì80211_bss_c⁄f
 *
	mlök_c⁄f
,

2477 
õì80211_ch™˘x_c⁄f
 *
	m˘x
,

2478 
boﬁ
 
	mswôchög_ch™˘x
);

2479 (*
	m__u«ssign_vif_ch™˘x
)(
iwl_mvm
 *
	mmvm
,

2480 
õì80211_vif
 *
	mvif
,

2481 
õì80211_bss_c⁄f
 *
	mlök_c⁄f
,

2482 
õì80211_ch™˘x_c⁄f
 *
	m˘x
,

2483 
boﬁ
 
	mswôchög_ch™˘x
);

2487 
iwl_mvm_swôch_vif_ch™˘x_comm⁄
(
õì80211_hw
 *
hw
,

2488 
õì80211_vif_ch™˘x_swôch
 *
vifs
,

2489 
n_vifs
,

2490 
õì80211_ch™˘x_swôch_mode
 
mode
,

2491 c⁄° 
iwl_mvm_swôch_vif_ch™˘x_›s
 *
›s
);

2494 
ölöe
 
boﬁ
 
	$iwl_mvm_has_u…ø_hb_ch™√l
(
iwl_mvm
 *
mvm
)

2496  
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

2497 
IWL_UCODE_TLV_CAPA_ULTRA_HB_CHANNELS
);

2498 
	}
}

2500 
ölöe
 *
	$iwl_mvm_ch™_öfo_cmd_èû
(
iwl_mvm
 *
mvm
,

2501 
iwl_fw_ch™√l_öfo
 *
ci
)

2503  (
u8
 *)
ci
 + (
	`iwl_mvm_has_u…ø_hb_ch™√l
(
mvm
) ?

2504 (
iwl_fw_ch™√l_öfo
) :

2505 (
iwl_fw_ch™√l_öfo_v1
));

2506 
	}
}

2508 
ölöe
 
size_t
 
	$iwl_mvm_ch™_öfo_∑ddög
(
iwl_mvm
 *
mvm
)

2510  
	`iwl_mvm_has_u…ø_hb_ch™√l
(
mvm
) ? 0 :

2511 (
iwl_fw_ch™√l_öfo
) -

2512 (
iwl_fw_ch™√l_öfo_v1
);

2513 
	}
}

2515 
ölöe
 
	$iwl_mvm_£t_ch™_öfo
(
iwl_mvm
 *
mvm
,

2516 
iwl_fw_ch™√l_öfo
 *
ci
,

2517 
u32
 
ch™
, 
u8
 
b™d
, u8 
width
,

2518 
u8
 
˘æ_pos
)

2520 i‡(
	`iwl_mvm_has_u…ø_hb_ch™√l
(
mvm
)) {

2521 
ci
->
ch™√l
 = 
	`˝u_to_À32
(
ch™
);

2522 
ci
->
b™d
 = band;

2523 
ci
->
width
 = width;

2524 
ci
->
˘æ_pos
 = ctrl_pos;

2526 
iwl_fw_ch™√l_öfo_v1
 *
ci_v1
 =

2527 (
iwl_fw_ch™√l_öfo_v1
 *)
ci
;

2529 
ci_v1
->
ch™√l
 = 
ch™
;

2530 
ci_v1
->
b™d
 = band;

2531 
ci_v1
->
width
 = width;

2532 
ci_v1
->
˘æ_pos
 = ctrl_pos;

2534 
	}
}

2536 
ölöe
 

2537 
	$iwl_mvm_£t_ch™_öfo_ch™def
(
iwl_mvm
 *
mvm
,

2538 
iwl_fw_ch™√l_öfo
 *
ci
,

2539 c⁄° 
cfg80211_ch™_def
 *
ch™def
)

2541 
∆80211_b™d
 
b™d
 = 
ch™def
->
ch™
->band;

2543 
	`iwl_mvm_£t_ch™_öfo
(
mvm
, 
ci
, 
ch™def
->
ch™
->
hw_vÆue
,

2544 
	`iwl_mvm_phy_b™d_‰om_∆80211
(
b™d
),

2545 
	`iwl_mvm_gë_ch™√l_width
(
ch™def
),

2546 
	`iwl_mvm_gë_˘æ_pos
(
ch™def
));

2547 
	}
}

2549 
ölöe
 
	$iwl_umac_sˇn_gë_max_¥ofûes
(c⁄° 
iwl_fw
 *
fw
)

2551 
u8
 
vî
 = 
	`iwl_fw_lookup_cmd_vî
(
fw
, 
SCAN_OFFLOAD_UPDATE_PROFILES_CMD
,

2552 
IWL_FW_CMD_VER_UNKNOWN
);

2553  (
vî
 =
IWL_FW_CMD_VER_UNKNOWN
 || ver < 3) ?

2554 
IWL_SCAN_MAX_PROFILES
 : 
IWL_SCAN_MAX_PROFILES_V2
;

2555 
	}
}

2557 
ölöe


2558 
iwl_loˇti⁄_cùhî
 
	$iwl_mvm_cùhî_to_loˇti⁄_cùhî
(
u32
 
cùhî
)

2560 
cùhî
) {

2561 
WLAN_CIPHER_SUITE_CCMP
:

2562  
IWL_LOCATION_CIPHER_CCMP_128
;

2563 
WLAN_CIPHER_SUITE_GCMP
:

2564  
IWL_LOCATION_CIPHER_GCMP_128
;

2565 
WLAN_CIPHER_SUITE_GCMP_256
:

2566  
IWL_LOCATION_CIPHER_GCMP_256
;

2568  
IWL_LOCATION_CIPHER_INVALID
;

2570 
	}
}

2572 
iwl_mvm_csme_c⁄n_öfo
 *
iwl_mvm_gë_csme_c⁄n_öfo
(
iwl_mvm
 *
mvm
);

2573 
ölöe
 
	$iwl_mvm_mei_gë_ow√rshù
(
iwl_mvm
 *
mvm
)

2575 i‡(
mvm
->
mei_ªgi°îed
)

2576  
	`iwl_mei_gë_ow√rshù
();

2578 
	}
}

2580 
ölöe
 
	$iwl_mvm_mei_tx_c›y_to_csme
(
iwl_mvm
 *
mvm
,

2581 
sk_buff
 *
skb
,

2582 
ivÀn
)

2584 i‡(
mvm
->
mei_ªgi°îed
)

2585 
	`iwl_mei_tx_c›y_to_csme
(
skb
, 
ivÀn
);

2586 
	}
}

2588 
ölöe
 
	$iwl_mvm_mei_ho°_dißssocüãd
(
iwl_mvm
 *
mvm
)

2590 i‡(
mvm
->
mei_ªgi°îed
)

2591 
	`iwl_mei_ho°_dißssocüãd
();

2592 
	}
}

2594 
ölöe
 
	$iwl_mvm_mei_devi˚_°©e
(
iwl_mvm
 *
mvm
, 
boﬁ
 
up
)

2596 i‡(
mvm
->
mei_ªgi°îed
)

2597 
	`iwl_mei_devi˚_°©e
(
up
);

2598 
	}
}

2600 
ölöe
 
	$iwl_mvm_mei_£t_sw_rfkûl_°©e
(
iwl_mvm
 *
mvm
)

2602 
boﬁ
 
sw_rfkûl
 =

2603 
mvm
->
hw_ªgi°îed
 ? 
	`rfkûl_so·_blocked
(mvm->
hw
->
wùhy
->
rfkûl
Ë: 
Ál£
;

2605 i‡(
mvm
->
mei_ªgi°îed
)

2606 
	`iwl_mei_£t_rfkûl_°©e
(
	`iwl_mvm_is_ødio_kûÀd
(
mvm
),

2607 
sw_rfkûl
);

2608 
	}
}

2610 
ölöe
 
boﬁ
 
	$iwl_mvm_mei_fûãr_sˇn
(
iwl_mvm
 *
mvm
,

2611 
sk_buff
 *
skb
)

2613 
õì80211_mgmt
 *
mgmt
 = (*)
skb
->
d©a
;

2615 i‡(
mvm
->
mei_sˇn_fûãr
.
is_mei_limôed_sˇn
 &&

2616 (
	`õì80211_is_¥obe_ª•
(
mgmt
->
‰ame_c⁄åﬁ
) ||

2617 
	`õì80211_is_bóc⁄
(
mgmt
->
‰ame_c⁄åﬁ
))) {

2618 
	`skb_queue_èû
(&
mvm
->
mei_sˇn_fûãr
.
sˇn_ªs
, 
skb
);

2619 
	`scheduÀ_w‹k
(&
mvm
->
mei_sˇn_fûãr
.
sˇn_w‹k
);

2620  
åue
;

2623  
Ál£
;

2624 
	}
}

2626 
iwl_mvm_£nd_rﬂmög_f‹biddí_evít
(
iwl_mvm
 *
mvm
,

2627 
õì80211_vif
 *
vif
,

2628 
boﬁ
 
f‹biddí
);

2631 
iwl_mvm_mac_tx
(
õì80211_hw
 *
hw
,

2632 
õì80211_tx_c⁄åﬁ
 *
c⁄åﬁ
, 
sk_buff
 *
skb
);

2633 
iwl_mvm_mac_wake_tx_queue
(
õì80211_hw
 *
hw
,

2634 
õì80211_txq
 *
txq
);

2636 
iwl_mvm_mac_ampdu_a˘i⁄
(
õì80211_hw
 *
hw
,

2637 
õì80211_vif
 *
vif
,

2638 
õì80211_ampdu_∑øms
 *
∑øms
);

2639 
iwl_mvm_›_gë_™ã¬a
(
õì80211_hw
 *
hw
, 
u32
 *
tx_™t
, u32 *
rx_™t
);

2640 
iwl_mvm_›_£t_™ã¬a
(
õì80211_hw
 *
hw
, 
u32
 
tx_™t
, u32 
rx_™t
);

2641 
iwl_mvm_mac_°¨t
(
õì80211_hw
 *
hw
);

2642 
iwl_mvm_mac_ªc⁄fig_com∂ëe
(
õì80211_hw
 *
hw
,

2643 
õì80211_ªc⁄fig_ty≥
 
ªc⁄fig_ty≥
);

2644 
iwl_mvm_mac_°›
(
õì80211_hw
 *
hw
);

2645 
ölöe
 
	$iwl_mvm_mac_c⁄fig
(
õì80211_hw
 *
hw
, 
u32
 
ch™ged
)

2648 
	}
}

2650 
u64
 
iwl_mvm_¥ï¨e_mu…iˇ°
(
õì80211_hw
 *
hw
,

2651 
√tdev_hw_addr_li°
 *
mc_li°
);

2653 
iwl_mvm_c⁄figuª_fûãr
(
õì80211_hw
 *
hw
,

2654 
ch™ged_Êags
,

2655 *
tŸÆ_Êags
, 
u64
 
mu…iˇ°
);

2656 
iwl_mvm_mac_hw_sˇn
(
õì80211_hw
 *
hw
, 
õì80211_vif
 *
vif
,

2657 
õì80211_sˇn_ªque°
 *
hw_ªq
);

2658 
iwl_mvm_mac_ˇn˚l_hw_sˇn
(
õì80211_hw
 *
hw
,

2659 
õì80211_vif
 *
vif
);

2660 
iwl_mvm_°a_¥e_rcu_ªmove
(
õì80211_hw
 *
hw
,

2661 
õì80211_vif
 *
vif
,

2662 
õì80211_°a
 *
°a
);

2663 
iwl_mvm_mac_°a_nŸify
(
õì80211_hw
 *
hw
, 
õì80211_vif
 *
vif
,

2664 
°a_nŸify_cmd
 
cmd
,

2665 
õì80211_°a
 *
°a
);

2667 
iwl_mvm_mac_Ælow_buf„ªd_‰ames
(
õì80211_hw
 *
hw
,

2668 
õì80211_°a
 *
°a
, 
u16
 
tids
,

2669 
num_‰ames
,

2670 
õì80211_‰ame_ªÀa£_ty≥
 
ªas⁄
,

2671 
boﬁ
 
m‹e_d©a
);

2673 
iwl_mvm_mac_ªÀa£_buf„ªd_‰ames
(
õì80211_hw
 *
hw
,

2674 
õì80211_°a
 *
°a
, 
u16
 
tids
,

2675 
num_‰ames
,

2676 
õì80211_‰ame_ªÀa£_ty≥
 
ªas⁄
,

2677 
boﬁ
 
m‹e_d©a
);

2678 
iwl_mvm_mac_£t_πs_thªshﬁd
(
õì80211_hw
 *
hw
, 
u32
 
vÆue
);

2679 
iwl_mvm_°a_rc_upd©e
(
õì80211_hw
 *
hw
, 
õì80211_vif
 *
vif
,

2680 
õì80211_°a
 *
°a
, 
u32
 
ch™ged
);

2681 
iwl_mvm_mac_mgd_¥ï¨e_tx
(
õì80211_hw
 *
hw
,

2682 
õì80211_vif
 *
vif
,

2683 
õì80211_¥ï_tx_öfo
 *
öfo
);

2684 
iwl_mvm_mac_mgd_com∂ëe_tx
(
õì80211_hw
 *
hw
,

2685 
õì80211_vif
 *
vif
,

2686 
õì80211_¥ï_tx_öfo
 *
öfo
);

2687 
iwl_mvm_mac_Êush
(
õì80211_hw
 *
hw
, 
õì80211_vif
 *
vif
,

2688 
u32
 
queues
, 
boﬁ
 
dr›
);

2689 
iwl_mvm_mac_Êush_°a
(
õì80211_hw
 *
hw
, 
õì80211_vif
 *
vif
,

2690 
õì80211_°a
 *
°a
);

2691 
iwl_mvm_mac_sched_sˇn_°¨t
(
õì80211_hw
 *
hw
,

2692 
õì80211_vif
 *
vif
,

2693 
cfg80211_sched_sˇn_ªque°
 *
ªq
,

2694 
õì80211_sˇn_õs
 *
õs
);

2695 
iwl_mvm_mac_sched_sˇn_°›
(
õì80211_hw
 *
hw
,

2696 
õì80211_vif
 *
vif
);

2697 
iwl_mvm_mac_£t_key
(
õì80211_hw
 *
hw
, 
£t_key_cmd
 
cmd
,

2698 
õì80211_vif
 *
vif
, 
õì80211_°a
 *
°a
,

2699 
õì80211_key_c⁄f
 *
key
);

2700 
iwl_mvm_mac_upd©e_tkù_key
(
õì80211_hw
 *
hw
,

2701 
õì80211_vif
 *
vif
,

2702 
õì80211_key_c⁄f
 *
keyc⁄f
,

2703 
õì80211_°a
 *
°a
,

2704 
u32
 
iv32
, 
u16
 *
pha£1key
);

2705 
iwl_mvm_add_ch™˘x
(
õì80211_hw
 *
hw
,

2706 
õì80211_ch™˘x_c⁄f
 *
˘x
);

2707 
iwl_mvm_ªmove_ch™˘x
(
õì80211_hw
 *
hw
,

2708 
õì80211_ch™˘x_c⁄f
 *
˘x
);

2709 
iwl_mvm_ch™ge_ch™˘x
(
õì80211_hw
 *
hw
,

2710 
õì80211_ch™˘x_c⁄f
 *
˘x
, 
u32
 
ch™ged
);

2711 
iwl_mvm_tx_œ°_bóc⁄
(
õì80211_hw
 *
hw
);

2712 
iwl_mvm_ch™√l_swôch
(
õì80211_hw
 *
hw
, 
õì80211_vif
 *
vif
,

2713 
õì80211_ch™√l_swôch
 *
chsw
);

2714 
iwl_mvm_¥e_ch™√l_swôch
(
õì80211_hw
 *
hw
,

2715 
õì80211_vif
 *
vif
,

2716 
õì80211_ch™√l_swôch
 *
chsw
);

2717 
iwl_mvm_ab‹t_ch™√l_swôch
(
õì80211_hw
 *
hw
,

2718 
õì80211_vif
 *
vif
,

2719 
õì80211_bss_c⁄f
 *
lök_c⁄f
);

2720 
iwl_mvm_ch™√l_swôch_rx_bóc⁄
(
õì80211_hw
 *
hw
,

2721 
õì80211_vif
 *
vif
,

2722 
õì80211_ch™√l_swôch
 *
chsw
);

2723 
iwl_mvm_mac_evít_ˇŒback
(
õì80211_hw
 *
hw
,

2724 
õì80211_vif
 *
vif
,

2725 c⁄° 
õì80211_evít
 *
evít
);

2726 
iwl_mvm_sync_rx_queues
(
õì80211_hw
 *
hw
);

2727 
iwl_mvm_mac_ã°mode_cmd
(
õì80211_hw
 *
hw
,

2728 
õì80211_vif
 *
vif
,

2729 *
d©a
, 
Àn
);

2730 
iwl_mvm_mac_gë_survey
(
õì80211_hw
 *
hw
, 
idx
,

2731 
survey_öfo
 *
survey
);

2732 
iwl_mvm_mac_°a_°©i°ics
(
õì80211_hw
 *
hw
,

2733 
õì80211_vif
 *
vif
,

2734 
õì80211_°a
 *
°a
,

2735 
°©i⁄_öfo
 *
söfo
);

2737 
iwl_mvm_mac_gë_·m_ª•⁄dî_°©s
(
õì80211_hw
 *
hw
,

2738 
õì80211_vif
 *
vif
,

2739 
cfg80211_·m_ª•⁄dî_°©s
 *
°©s
);

2740 
iwl_mvm_°¨t_pm§
(
õì80211_hw
 *
hw
, 
õì80211_vif
 *
vif
,

2741 
cfg80211_pm§_ªque°
 *
ªque°
);

2742 
iwl_mvm_ab‹t_pm§
(
õì80211_hw
 *
hw
, 
õì80211_vif
 *
vif
,

2743 
cfg80211_pm§_ªque°
 *
ªque°
);

2745 
boﬁ
 
iwl_mvm_have_löks_ßme_ch™√l
(
iwl_mvm_vif
 *
vif1
,

2746 
iwl_mvm_vif
 *
vif2
);

2747 
boﬁ
 
iwl_mvm_vif_is_a˘ive
(
iwl_mvm_vif
 *
mvmvif
);

2748 
iwl_mvm_£t_tx_powî
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

2749 
s16
 
tx_powî
);

2750 
iwl_mvm_£t_hw_time°amp
(
õì80211_hw
 *
hw
,

2751 
õì80211_vif
 *
vif
,

2752 
cfg80211_£t_hw_time°amp
 *
hwts
);

2753 
iwl_mvm_upd©e_mu_groups
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
);

2754 
boﬁ
 
iwl_mvm_íabÀ_fûs
(
iwl_mvm
 *
mvm
,

2755 
õì80211_ch™˘x_c⁄f
 *
˘x
);

2756 
iwl_mvm_mld_£À˘_löks
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

2757 
boﬁ
 
vÆid_löks_ch™ged
);

2758 
iwl_mvm_mld_gë_¥im¨y_lök
(
iwl_mvm
 *
mvm
,

2759 
õì80211_vif
 *
vif
,

2760 
ußbÀ_löks
);

2762 
boﬁ
 
iwl_mvm_is_·m_ª•⁄dî_ch™˘x
(
iwl_mvm
 *
mvm
,

2763 
õì80211_ch™˘x_c⁄f
 *
˘x
);

2765 
ölöe
 
cfg80211_ch™_def
 *

2766 
	$iwl_mvm_ch™˘x_def
(
iwl_mvm
 *
mvm
, 
õì80211_ch™˘x_c⁄f
 *
˘x
)

2768 
boﬁ
 
u£_def
 = 
	`iwl_mvm_is_·m_ª•⁄dî_ch™˘x
(
mvm
, 
˘x
) ||

2769 
	`iwl_mvm_íabÀ_fûs
(
mvm
, 
˘x
);

2771  
u£_def
 ? &
˘x
->
def
 : &˘x->
mö_def
;

2772 
	}
}

2774 
iwl_mvm_roc_duøti⁄_™d_dñay
(
õì80211_vif
 *
vif
,

2775 
u32
 
duøti⁄_ms
,

2776 
u32
 *
duøti⁄_tu
,

2777 
u32
 *
dñay
);

2778 
iwl_mvm_roc_add_cmd
(
iwl_mvm
 *
mvm
,

2779 
õì80211_ch™√l
 *
ch™√l
,

2780 
õì80211_vif
 *
vif
,

2781 
duøti⁄
, 
u32
 
a˘ivôy
);

	@nvm.c

7 
	~<löux/fúmw¨e.h
>

8 
	~<löux/π√éök.h
>

9 
	~"iwl-å™s.h
"

10 
	~"iwl-c§.h
"

11 
	~"mvm.h
"

12 
	~"iwl-ì¥om-∑r£.h
"

13 
	~"iwl-ì¥om-ªad.h
"

14 
	~"iwl-nvm-∑r£.h
"

15 
	~"iwl-¥ph.h
"

16 
	~"fw/a˝i.h
"

19 
	#IWL_NVM_DEFAULT_CHUNK_SIZE
 (2 * 1024)

	)

21 
	#NVM_WRITE_OPCODE
 1

	)

22 
	#NVM_READ_OPCODE
 0

	)

26 
	mREAD_NVM_CHUNK_SUCCEED
 = 0,

27 
	mREAD_NVM_CHUNK_NOT_VALID_ADDRESS
 = 1

34 
	$iwl_nvm_wrôe_chunk
(
iwl_mvm
 *
mvm
, 
u16
 
£˘i⁄
,

35 
u16
 
off£t
, u16 
Àngth
, c⁄° 
u8
 *
d©a
)

37 
iwl_nvm_ac˚ss_cmd
 
nvm_ac˚ss_cmd
 = {

38 .
off£t
 = 
	`˝u_to_À16
(offset),

39 .
Àngth
 = 
	`˝u_to_À16
(length),

40 .
ty≥
 = 
	`˝u_to_À16
(
£˘i⁄
),

41 .
›_code
 = 
NVM_WRITE_OPCODE
,

43 
iwl_ho°_cmd
 
cmd
 = {

44 .
id
 = 
NVM_ACCESS_CMD
,

45 .
Àn
 = { (
iwl_nvm_ac˚ss_cmd
), 
Àngth
 },

46 .
Êags
 = 
CMD_WANT_SKB
 | 
CMD_SEND_IN_RFKILL
,

47 .
d©a
 = { &
nvm_ac˚ss_cmd
, data },

49 .
d©aÊags
 = { 0, 
IWL_HCMD_DFL_DUP
 },

51 
iwl_rx_∑ckë
 *
pkt
;

52 
iwl_nvm_ac˚ss_ª•
 *
nvm_ª•
;

53 
ªt
;

55 
ªt
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
cmd
);

56 i‡(
ªt
)

57  
ªt
;

59 
pkt
 = 
cmd
.
ª•_pkt
;

61 
nvm_ª•
 = (*)
pkt
->
d©a
;

62 i‡(
	`À16_to_˝u
(
nvm_ª•
->
°©us
Ë!
READ_NVM_CHUNK_SUCCEED
) {

63 
	`IWL_ERR
(
mvm
,

65 
£˘i⁄
, 
	`À16_to_˝u
(
nvm_ª•
->
°©us
));

66 
ªt
 = -
EIO
;

69 
	`iwl_‰ì_ª•
(&
cmd
);

70  
ªt
;

71 
	}
}

73 
	$iwl_nvm_ªad_chunk
(
iwl_mvm
 *
mvm
, 
u16
 
£˘i⁄
,

74 
u16
 
off£t
, u16 
Àngth
, 
u8
 *
d©a
)

76 
iwl_nvm_ac˚ss_cmd
 
nvm_ac˚ss_cmd
 = {

77 .
off£t
 = 
	`˝u_to_À16
(offset),

78 .
Àngth
 = 
	`˝u_to_À16
(length),

79 .
ty≥
 = 
	`˝u_to_À16
(
£˘i⁄
),

80 .
›_code
 = 
NVM_READ_OPCODE
,

82 
iwl_nvm_ac˚ss_ª•
 *
nvm_ª•
;

83 
iwl_rx_∑ckë
 *
pkt
;

84 
iwl_ho°_cmd
 
cmd
 = {

85 .
id
 = 
NVM_ACCESS_CMD
,

86 .
Êags
 = 
CMD_WANT_SKB
 | 
CMD_SEND_IN_RFKILL
,

87 .
d©a
 = { &
nvm_ac˚ss_cmd
, },

89 
ªt
, 
byãs_ªad
, 
off£t_ªad
;

90 
u8
 *
ª•_d©a
;

92 
cmd
.
Àn
[0] = (
iwl_nvm_ac˚ss_cmd
);

94 
ªt
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
cmd
);

95 i‡(
ªt
)

96  
ªt
;

98 
pkt
 = 
cmd
.
ª•_pkt
;

101 
nvm_ª•
 = (*)
pkt
->
d©a
;

102 
ªt
 = 
	`À16_to_˝u
(
nvm_ª•
->
°©us
);

103 
byãs_ªad
 = 
	`À16_to_˝u
(
nvm_ª•
->
Àngth
);

104 
off£t_ªad
 = 
	`À16_to_˝u
(
nvm_ª•
->
off£t
);

105 
ª•_d©a
 = 
nvm_ª•
->
d©a
;

106 i‡(
ªt
) {

107 i‡((
off£t
 != 0) &&

108 (
ªt
 =
READ_NVM_CHUNK_NOT_VALID_ADDRESS
)) {

117 
	`IWL_DEBUG_EEPROM
(
mvm
->
å™s
->
dev
,

119 
off£t
);

120 
ªt
 = 0;

122 
	`IWL_DEBUG_EEPROM
(
mvm
->
å™s
->
dev
,

124 
ªt
, 
mvm
->
å™s
->
«me
);

125 
ªt
 = -
ENODATA
;

127 
exô
;

130 i‡(
off£t_ªad
 !
off£t
) {

131 
	`IWL_ERR
(
mvm
, "NVM ACCESSÑesponse with invalid offset %d\n",

132 
off£t_ªad
);

133 
ªt
 = -
EINVAL
;

134 
exô
;

138 
	`mem˝y
(
d©a
 + 
off£t
, 
ª•_d©a
, 
byãs_ªad
);

139 
ªt
 = 
byãs_ªad
;

141 
exô
:

142 
	`iwl_‰ì_ª•
(&
cmd
);

143  
ªt
;

144 
	}
}

146 
	$iwl_nvm_wrôe_£˘i⁄
(
iwl_mvm
 *
mvm
, 
u16
 
£˘i⁄
,

147 c⁄° 
u8
 *
d©a
, 
u16
 
Àngth
)

149 
off£t
 = 0;

153 
off£t
 < 
Àngth
) {

154 
chunk_size
, 
ªt
;

156 
chunk_size
 = 
	`mö
(
IWL_NVM_DEFAULT_CHUNK_SIZE
,

157 
Àngth
 - 
off£t
);

159 
ªt
 = 
	`iwl_nvm_wrôe_chunk
(
mvm
, 
£˘i⁄
, 
off£t
,

160 
chunk_size
, 
d©a
 + 
off£t
);

161 i‡(
ªt
 < 0)

162  
ªt
;

164 
off£t
 +
chunk_size
;

168 
	}
}

180 
	$iwl_nvm_ªad_£˘i⁄
(
iwl_mvm
 *
mvm
, 
u16
 
£˘i⁄
,

181 
u8
 *
d©a
, 
u32
 
size_ªad
)

183 
u16
 
Àngth
, 
off£t
 = 0;

184 
ªt
;

187 
Àngth
 = 
IWL_NVM_DEFAULT_CHUNK_SIZE
;

189 
ªt
 = 
Àngth
;

192 
ªt
 =
Àngth
) {

194 i‡((
size_ªad
 + 
off£t
 + 
Àngth
) >

195 
mvm
->
å™s
->
å™s_cfg
->
ba£_∑øms
->
ì¥om_size
) {

196 
	`IWL_ERR
(
mvm
, "EEPROM size isÅoo small for NVM\n");

197  -
ENOBUFS
;

200 
ªt
 = 
	`iwl_nvm_ªad_chunk
(
mvm
, 
£˘i⁄
, 
off£t
, 
Àngth
, 
d©a
);

201 i‡(
ªt
 < 0) {

202 
	`IWL_DEBUG_EEPROM
(
mvm
->
å™s
->
dev
,

204 
£˘i⁄
, 
off£t
, 
Àngth
);

205  
ªt
;

207 
off£t
 +
ªt
;

210 
	`iwl_nvm_fixups
(
mvm
->
å™s
->
hw_id
, 
£˘i⁄
, 
d©a
, 
off£t
);

212 
	`IWL_DEBUG_EEPROM
(
mvm
->
å™s
->
dev
,

213 "NVM se˘i⁄ %dÑód com∂ëed\n", 
£˘i⁄
);

214  
off£t
;

215 
	}
}

217 
iwl_nvm_d©a
 *

218 
	$iwl_∑r£_nvm_£˘i⁄s
(
iwl_mvm
 *
mvm
)

220 
iwl_nvm_£˘i⁄
 *
£˘i⁄s
 = 
mvm
->
nvm_£˘i⁄s
;

221 c⁄° 
__be16
 *
hw
;

222 c⁄° 
__À16
 *
sw
, *
ˇlib
, *
ªguœt‹y
, *
mac_ovîride
, *
phy_sku
;

223 
u8
 
tx_™t
 = 
mvm
->
fw
->
vÆid_tx_™t
;

224 
u8
 
rx_™t
 = 
mvm
->
fw
->
vÆid_rx_™t
;

225 
ªguœt‹y_ty≥
;

228 i‡(
mvm
->
å™s
->
cfg
->
nvm_ty≥
 =
IWL_NVM
) {

229 i‡(!
mvm
->
nvm_£˘i⁄s
[
NVM_SECTION_TYPE_SW
].
d©a
 ||

230 !
mvm
->
nvm_£˘i⁄s
[mvm->
cfg
->
nvm_hw_£˘i⁄_num
].
d©a
) {

231 
	`IWL_ERR
(
mvm
, "Can'tÖarseÉmpty OTP/NVM sections\n");

232  
NULL
;

235 i‡(
mvm
->
å™s
->
cfg
->
nvm_ty≥
 =
IWL_NVM_SDP
)

236 
ªguœt‹y_ty≥
 = 
NVM_SECTION_TYPE_REGULATORY_SDP
;

238 
ªguœt‹y_ty≥
 = 
NVM_SECTION_TYPE_REGULATORY
;

241 i‡(!
mvm
->
nvm_£˘i⁄s
[
NVM_SECTION_TYPE_SW
].
d©a
 ||

242 !
mvm
->
nvm_£˘i⁄s
[
ªguœt‹y_ty≥
].
d©a
) {

243 
	`IWL_ERR
(
mvm
,

245  
NULL
;

248 i‡(!
mvm
->
nvm_£˘i⁄s
[mvm->
cfg
->
nvm_hw_£˘i⁄_num
].
d©a
 &&

249 !
mvm
->
nvm_£˘i⁄s
[
NVM_SECTION_TYPE_MAC_OVERRIDE
].
d©a
) {

250 
	`IWL_ERR
(
mvm
,

252  
NULL
;

256 i‡(
mvm
->
å™s
->
cfg
->
nvm_ty≥
 =
IWL_NVM_EXT
 &&

257 !
mvm
->
nvm_£˘i⁄s
[
NVM_SECTION_TYPE_PHY_SKU
].
d©a
) {

258 
	`IWL_ERR
(
mvm
,

260  
NULL
;

264 
hw
 = (c⁄° 
__be16
 *)
£˘i⁄s
[
mvm
->
cfg
->
nvm_hw_£˘i⁄_num
].
d©a
;

265 
sw
 = (c⁄° 
__À16
 *)
£˘i⁄s
[
NVM_SECTION_TYPE_SW
].
d©a
;

266 
ˇlib
 = (c⁄° 
__À16
 *)
£˘i⁄s
[
NVM_SECTION_TYPE_CALIBRATION
].
d©a
;

267 
mac_ovîride
 =

268 (c⁄° 
__À16
 *)
£˘i⁄s
[
NVM_SECTION_TYPE_MAC_OVERRIDE
].
d©a
;

269 
phy_sku
 = (c⁄° 
__À16
 *)
£˘i⁄s
[
NVM_SECTION_TYPE_PHY_SKU
].
d©a
;

271 
ªguœt‹y
 = 
mvm
->
å™s
->
cfg
->
nvm_ty≥
 =
IWL_NVM_SDP
 ?

272 (c⁄° 
__À16
 *)
£˘i⁄s
[
NVM_SECTION_TYPE_REGULATORY_SDP
].
d©a
 :

273 (c⁄° 
__À16
 *)
£˘i⁄s
[
NVM_SECTION_TYPE_REGULATORY
].
d©a
;

275 i‡(
mvm
->
£t_tx_™t
)

276 
tx_™t
 &
mvm
->
£t_tx_™t
;

278 i‡(
mvm
->
£t_rx_™t
)

279 
rx_™t
 &
mvm
->
£t_rx_™t
;

281  
	`iwl_∑r£_nvm_d©a
(
mvm
->
å™s
, mvm->
cfg
, mvm->
fw
, 
hw
, 
sw
, 
ˇlib
,

282 
ªguœt‹y
, 
mac_ovîride
, 
phy_sku
,

283 
tx_™t
, 
rx_™t
);

284 
	}
}

287 
	$iwl_mvm_lﬂd_nvm_to_nic
(
iwl_mvm
 *
mvm
)

289 
i
, 
ªt
 = 0;

290 
iwl_nvm_£˘i⁄
 *
£˘i⁄s
 = 
mvm
->
nvm_£˘i⁄s
;

292 
	`IWL_DEBUG_EEPROM
(
mvm
->
å™s
->
dev
, "'WriteÅo NVM\n");

294 
i
 = 0; i < 
	`ARRAY_SIZE
(
mvm
->
nvm_£˘i⁄s
); i++) {

295 i‡(!
mvm
->
nvm_£˘i⁄s
[
i
].
d©a
 || !mvm->nvm_£˘i⁄s[i].
Àngth
)

297 
ªt
 = 
	`iwl_nvm_wrôe_£˘i⁄
(
mvm
, 
i
, 
£˘i⁄s
[i].
d©a
,

298 
£˘i⁄s
[
i
].
Àngth
);

299 i‡(
ªt
 < 0) {

300 
	`IWL_ERR
(
mvm
, "iwl_mvm_£nd_cmd faûed: %d\n", 
ªt
);

304  
ªt
;

305 
	}
}

307 
	$iwl_nvm_öô
(
iwl_mvm
 *
mvm
)

309 
ªt
, 
£˘i⁄
;

310 
u32
 
size_ªad
 = 0;

311 
u8
 *
nvm_buf„r
, *
ãmp
;

312 c⁄° *
nvm_fûe_C
 = 
mvm
->
cfg
->
deÁu…_nvm_fûe_C_°ï
;

314 i‡(
	`WARN_ON_ONCE
(
mvm
->
cfg
->
nvm_hw_£˘i⁄_num
 >
NVM_MAX_NUM_SECTIONS
))

315  -
EINVAL
;

319 
	`IWL_DEBUG_EEPROM
(
mvm
->
å™s
->
dev
, "Read from NVM\n");

321 
nvm_buf„r
 = 
	`kmÆloc
(
mvm
->
å™s
->
å™s_cfg
->
ba£_∑øms
->
ì¥om_size
,

322 
GFP_KERNEL
);

323 i‡(!
nvm_buf„r
)

324  -
ENOMEM
;

325 
£˘i⁄
 = 0; se˘i⁄ < 
NVM_MAX_NUM_SECTIONS
; section++) {

327 
ªt
 = 
	`iwl_nvm_ªad_£˘i⁄
(
mvm
, 
£˘i⁄
, 
nvm_buf„r
,

328 
size_ªad
);

329 i‡(
ªt
 =-
ENODATA
) {

330 
ªt
 = 0;

333 i‡(
ªt
 < 0)

335 
size_ªad
 +
ªt
;

336 
ãmp
 = 
	`kmemdup
(
nvm_buf„r
, 
ªt
, 
GFP_KERNEL
);

337 i‡(!
ãmp
) {

338 
ªt
 = -
ENOMEM
;

342 
	`iwl_nvm_fixups
(
mvm
->
å™s
->
hw_id
, 
£˘i⁄
, 
ãmp
, 
ªt
);

344 
mvm
->
nvm_£˘i⁄s
[
£˘i⁄
].
d©a
 = 
ãmp
;

345 
mvm
->
nvm_£˘i⁄s
[
£˘i⁄
].
Àngth
 = 
ªt
;

347 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


348 
£˘i⁄
) {

349 
NVM_SECTION_TYPE_SW
:

350 
mvm
->
nvm_sw_blob
.
d©a
 = 
ãmp
;

351 
mvm
->
nvm_sw_blob
.
size
 = 
ªt
;

353 
NVM_SECTION_TYPE_CALIBRATION
:

354 
mvm
->
nvm_ˇlib_blob
.
d©a
 = 
ãmp
;

355 
mvm
->
nvm_ˇlib_blob
.
size
 = 
ªt
;

357 
NVM_SECTION_TYPE_PRODUCTION
:

358 
mvm
->
nvm_¥od_blob
.
d©a
 = 
ãmp
;

359 
mvm
->
nvm_¥od_blob
.
size
 = 
ªt
;

361 
NVM_SECTION_TYPE_PHY_SKU
:

362 
mvm
->
nvm_phy_sku_blob
.
d©a
 = 
ãmp
;

363 
mvm
->
nvm_phy_sku_blob
.
size
 = 
ªt
;

365 
NVM_SECTION_TYPE_REGULATORY_SDP
:

366 
NVM_SECTION_TYPE_REGULATORY
:

367 
mvm
->
nvm_ªg_blob
.
d©a
 = 
ãmp
;

368 
mvm
->
nvm_ªg_blob
.
size
 = 
ªt
;

371 i‡(
£˘i⁄
 =
mvm
->
cfg
->
nvm_hw_£˘i⁄_num
) {

372 
mvm
->
nvm_hw_blob
.
d©a
 = 
ãmp
;

373 
mvm
->
nvm_hw_blob
.
size
 = 
ªt
;

379 i‡(!
size_ªad
)

380 
	`IWL_ERR
(
mvm
, "OTP is blank\n");

381 
	`k‰ì
(
nvm_buf„r
);

384 i‡(
mvm
->
nvm_fûe_«me
) {

386 
ªt
 = 
	`iwl_ªad_exã∫Æ_nvm
(
mvm
->
å™s
, mvm->
nvm_fûe_«me
,

387 
mvm
->
nvm_£˘i⁄s
);

388 i‡(
ªt
) {

389 
mvm
->
nvm_fûe_«me
 = 
nvm_fûe_C
;

391 i‡((
ªt
 =-
EFAULT
 ||Ñë =-
ENOENT
) &&

392 
mvm
->
nvm_fûe_«me
) {

394 
ªt
 = 
	`iwl_ªad_exã∫Æ_nvm
(
mvm
->
å™s
,

395 
mvm
->
nvm_fûe_«me
,

396 
mvm
->
nvm_£˘i⁄s
);

397 i‡(
ªt
)

398  
ªt
;

400  
ªt
;

406 
mvm
->
nvm_d©a
 = 
	`iwl_∑r£_nvm_£˘i⁄s
(mvm);

407 i‡(!
mvm
->
nvm_d©a
)

408  -
ENODATA
;

409 
	`IWL_DEBUG_EEPROM
(
mvm
->
å™s
->
dev
, "nvm version = %x\n",

410 
mvm
->
nvm_d©a
->
nvm_vîsi⁄
);

412  
ªt
 < 0 ?Ñet : 0;

413 
	}
}

415 
iwl_mcc_upd©e_ª•_v8
 *

416 
	$iwl_mvm_upd©e_mcc
(
iwl_mvm
 *
mvm
, c⁄° *
Æpha2
,

417 
iwl_mcc_sour˚
 
§c_id
)

419 
iwl_mcc_upd©e_cmd
 
mcc_upd©e_cmd
 = {

420 .
mcc
 = 
	`˝u_to_À16
(
Æpha2
[0] << 8 |álpha2[1]),

421 .
sour˚_id
 = (
u8
)
§c_id
,

423 
iwl_mcc_upd©e_ª•_v8
 *
ª•_˝
;

424 
iwl_rx_∑ckë
 *
pkt
;

425 
iwl_ho°_cmd
 
cmd
 = {

426 .
id
 = 
MCC_UPDATE_CMD
,

427 .
Êags
 = 
CMD_WANT_SKB
 | 
CMD_SEND_IN_RFKILL
,

428 .
d©a
 = { &
mcc_upd©e_cmd
 },

431 
ªt
, 
ª•_vî
;

432 
u32
 
°©us
;

433 
ª•_Àn
, 
n_ch™√ls
;

434 
u16
 
mcc
;

436 i‡(
	`WARN_ON_ONCE
(!
	`iwl_mvm_is_œr_suµ‹ãd
(
mvm
)))

437  
	`ERR_PTR
(-
EOPNOTSUPP
);

439 
cmd
.
Àn
[0] = (
iwl_mcc_upd©e_cmd
);

441 
	`IWL_DEBUG_LAR
(
mvm
, "send MCC updateÅo FW with '%c%c' src = %d\n",

442 
Æpha2
[0],áÕha2[1], 
§c_id
);

444 
ªt
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
cmd
);

445 i‡(
ªt
)

446  
	`ERR_PTR
(
ªt
);

448 
pkt
 = 
cmd
.
ª•_pkt
;

450 
ª•_vî
 = 
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
IWL_ALWAYS_LONG_GROUP
,

451 
MCC_UPDATE_CMD
, 0);

454 i‡(
ª•_vî
 >= 8) {

455 
iwl_mcc_upd©e_ª•_v8
 *
mcc_ª•_v8
 = (*)
pkt
->
d©a
;

457 
n_ch™√ls
 = 
	`__À32_to_˝u
(
mcc_ª•_v8
->n_channels);

458 i‡(
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
) !=

459 
	`°ru˘_size
(
mcc_ª•_v8
, 
ch™√ls
, 
n_ch™√ls
)) {

460 
ª•_˝
 = 
	`ERR_PTR
(-
EINVAL
);

461 
exô
;

463 
ª•_Àn
 = 
	`°ru˘_size
(
ª•_˝
, 
ch™√ls
, 
n_ch™√ls
);

464 
ª•_˝
 = 
	`kzÆloc
(
ª•_Àn
, 
GFP_KERNEL
);

465 i‡(!
ª•_˝
) {

466 
ª•_˝
 = 
	`ERR_PTR
(-
ENOMEM
);

467 
exô
;

469 
ª•_˝
->
°©us
 = 
mcc_ª•_v8
->status;

470 
ª•_˝
->
mcc
 = 
mcc_ª•_v8
->mcc;

471 
ª•_˝
->
ˇp
 = 
mcc_ª•_v8
->cap;

472 
ª•_˝
->
sour˚_id
 = 
mcc_ª•_v8
->source_id;

473 
ª•_˝
->
time
 = 
mcc_ª•_v8
->time;

474 
ª•_˝
->
geo_öfo
 = 
mcc_ª•_v8
->geo_info;

475 
ª•_˝
->
n_ch™√ls
 = 
mcc_ª•_v8
->n_channels;

476 
	`mem˝y
(
ª•_˝
->
ch™√ls
, 
mcc_ª•_v8
->channels,

477 
n_ch™√ls
 * (
__À32
));

478 } i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

479 
IWL_UCODE_TLV_CAPA_MCC_UPDATE_11AX_SUPPORT
)) {

480 
iwl_mcc_upd©e_ª•_v4
 *
mcc_ª•_v4
 = (*)
pkt
->
d©a
;

482 
n_ch™√ls
 = 
	`__À32_to_˝u
(
mcc_ª•_v4
->n_channels);

483 i‡(
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
) !=

484 
	`°ru˘_size
(
mcc_ª•_v4
, 
ch™√ls
, 
n_ch™√ls
)) {

485 
ª•_˝
 = 
	`ERR_PTR
(-
EINVAL
);

486 
exô
;

488 
ª•_Àn
 = 
	`°ru˘_size
(
ª•_˝
, 
ch™√ls
, 
n_ch™√ls
);

489 
ª•_˝
 = 
	`kzÆloc
(
ª•_Àn
, 
GFP_KERNEL
);

490 i‡(!
ª•_˝
) {

491 
ª•_˝
 = 
	`ERR_PTR
(-
ENOMEM
);

492 
exô
;

495 
ª•_˝
->
°©us
 = 
mcc_ª•_v4
->status;

496 
ª•_˝
->
mcc
 = 
mcc_ª•_v4
->mcc;

497 
ª•_˝
->
ˇp
 = 
	`˝u_to_À32
(
	`À16_to_˝u
(
mcc_ª•_v4
->cap));

498 
ª•_˝
->
sour˚_id
 = 
mcc_ª•_v4
->source_id;

499 
ª•_˝
->
time
 = 
mcc_ª•_v4
->time;

500 
ª•_˝
->
geo_öfo
 = 
mcc_ª•_v4
->geo_info;

501 
ª•_˝
->
n_ch™√ls
 = 
mcc_ª•_v4
->n_channels;

502 
	`mem˝y
(
ª•_˝
->
ch™√ls
, 
mcc_ª•_v4
->channels,

503 
n_ch™√ls
 * (
__À32
));

505 
iwl_mcc_upd©e_ª•_v3
 *
mcc_ª•_v3
 = (*)
pkt
->
d©a
;

507 
n_ch™√ls
 = 
	`__À32_to_˝u
(
mcc_ª•_v3
->n_channels);

508 i‡(
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
) !=

509 
	`°ru˘_size
(
mcc_ª•_v3
, 
ch™√ls
, 
n_ch™√ls
)) {

510 
ª•_˝
 = 
	`ERR_PTR
(-
EINVAL
);

511 
exô
;

513 
ª•_Àn
 = 
	`°ru˘_size
(
ª•_˝
, 
ch™√ls
, 
n_ch™√ls
);

514 
ª•_˝
 = 
	`kzÆloc
(
ª•_Àn
, 
GFP_KERNEL
);

515 i‡(!
ª•_˝
) {

516 
ª•_˝
 = 
	`ERR_PTR
(-
ENOMEM
);

517 
exô
;

520 
ª•_˝
->
°©us
 = 
mcc_ª•_v3
->status;

521 
ª•_˝
->
mcc
 = 
mcc_ª•_v3
->mcc;

522 
ª•_˝
->
ˇp
 = 
	`˝u_to_À32
(
mcc_ª•_v3
->cap);

523 
ª•_˝
->
sour˚_id
 = 
mcc_ª•_v3
->source_id;

524 
ª•_˝
->
time
 = 
mcc_ª•_v3
->time;

525 
ª•_˝
->
geo_öfo
 = 
mcc_ª•_v3
->geo_info;

526 
ª•_˝
->
n_ch™√ls
 = 
mcc_ª•_v3
->n_channels;

527 
	`mem˝y
(
ª•_˝
->
ch™√ls
, 
mcc_ª•_v3
->channels,

528 
n_ch™√ls
 * (
__À32
));

531 
°©us
 = 
	`À32_to_˝u
(
ª•_˝
->status);

533 
mcc
 = 
	`À16_to_˝u
(
ª•_˝
->mcc);

536 i‡(
mcc
 == 0) {

537 
mcc
 = 0x3030;

538 
ª•_˝
->
mcc
 = 
	`˝u_to_À16
(mcc);

541 
	`IWL_DEBUG_LAR
(
mvm
,

543 
°©us
, 
mcc
, mc¯>> 8, mc¯& 0xff, 
n_ch™√ls
);

545 
exô
:

546 
	`iwl_‰ì_ª•
(&
cmd
);

547  
ª•_˝
;

548 
	}
}

550 
	$iwl_mvm_öô_mcc
(
iwl_mvm
 *
mvm
)

552 
boﬁ
 
év_œr
;

553 
boﬁ
 
nvm_œr
;

554 
ªtvÆ
;

555 
õì80211_ªgdomaö
 *
ªgd
;

556 
mcc
[3];

558 i‡(
mvm
->
cfg
->
nvm_ty≥
 =
IWL_NVM_EXT
) {

559 
év_œr
 = 
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

560 
IWL_UCODE_TLV_CAPA_LAR_SUPPORT
);

561 
nvm_œr
 = 
mvm
->
nvm_d©a
->
œr_íabÀd
;

562 i‡(
év_œr
 !
nvm_œr
)

563 
	`IWL_INFO
(
mvm
,

565 
év_œr
 ? "enabled" : "disabled",

566 
nvm_œr
 ? "enabled" : "disabled");

569 i‡(!
	`iwl_mvm_is_œr_suµ‹ãd
(
mvm
))

576 
ªtvÆ
 = 
	`iwl_mvm_öô_fw_ªgd
(
mvm
, 
åue
);

577 i‡(
ªtvÆ
 !-
ENOENT
)

578  
ªtvÆ
;

586 
mvm
->
œr_ªgdom_£t
 = 
Ál£
;

588 
ªgd
 = 
	`iwl_mvm_gë_cuºít_ªgdomaö
(
mvm
, 
NULL
);

589 i‡(
	`IS_ERR_OR_NULL
(
ªgd
))

590  -
EIO
;

592 i‡(
	`iwl_mvm_is_wifi_mcc_suµ‹ãd
(
mvm
) &&

593 !
	`iwl_bios_gë_mcc
(&
mvm
->
fwπ
, 
mcc
)) {

594 
	`k‰ì
(
ªgd
);

595 
ªgd
 = 
	`iwl_mvm_gë_ªgdomaö
(
mvm
->
hw
->
wùhy
, 
mcc
,

596 
MCC_SOURCE_BIOS
, 
NULL
);

597 i‡(
	`IS_ERR_OR_NULL
(
ªgd
))

598  -
EIO
;

601 
ªtvÆ
 = 
	`ªguœt‹y_£t_wùhy_ªgd_sync
(
mvm
->
hw
->
wùhy
, 
ªgd
);

602 
	`k‰ì
(
ªgd
);

603  
ªtvÆ
;

604 
	}
}

606 
	$iwl_mvm_rx_chub_upd©e_mcc
(
iwl_mvm
 *
mvm
,

607 
iwl_rx_cmd_buf„r
 *
rxb
)

609 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

610 
iwl_mcc_chub_nŸif
 *
nŸif
 = (*)
pkt
->
d©a
;

611 
iwl_mcc_sour˚
 
§c
;

612 
mcc
[3];

613 
õì80211_ªgdomaö
 *
ªgd
;

614 
wgds_tbl_idx
;

616 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

618 i‡(
	`iwl_mvm_is_vif_assoc
(
mvm
Ë&& 
nŸif
->
sour˚_id
 =
MCC_SOURCE_WIFI
) {

619 
	`IWL_DEBUG_LAR
(
mvm
, "Ignore mcc update whileássociated\n");

623 i‡(
	`WARN_ON_ONCE
(!
	`iwl_mvm_is_œr_suµ‹ãd
(
mvm
)))

626 
mcc
[0] = 
	`À16_to_˝u
(
nŸif
->mcc) >> 8;

627 
mcc
[1] = 
	`À16_to_˝u
(
nŸif
->mcc) & 0xff;

628 
mcc
[2] = '\0';

629 
§c
 = 
nŸif
->
sour˚_id
;

631 
	`IWL_DEBUG_LAR
(
mvm
,

633 
mcc
, 
§c
);

634 
ªgd
 = 
	`iwl_mvm_gë_ªgdomaö
(
mvm
->
hw
->
wùhy
, 
mcc
, 
§c
, 
NULL
);

635 i‡(
	`IS_ERR_OR_NULL
(
ªgd
))

638 
wgds_tbl_idx
 = 
	`iwl_mvm_gë_ßr_geo_¥ofûe
(
mvm
);

639 i‡(
wgds_tbl_idx
 < 1)

640 
	`IWL_DEBUG_INFO
(
mvm
,

642 
wgds_tbl_idx
);

644 
	`IWL_DEBUG_INFO
(
mvm
, "SAR WGDS: geoÖrofile %d is configured\n",

645 
wgds_tbl_idx
);

647 
	`ªguœt‹y_£t_wùhy_ªgd
(
mvm
->
hw
->
wùhy
, 
ªgd
);

648 
	`k‰ì
(
ªgd
);

649 
	}
}

	@offloading.c

7 
	~<√t/ùv6.h
>

8 
	~<√t/addrc⁄f.h
>

9 
	~<löux/bô›s.h
>

10 
	~"mvm.h
"

12 
	$iwl_mvm_£t_wowœn_qos_£q
(
iwl_mvm_°a
 *
mvm_≠_°a
,

13 
iwl_wowœn_c⁄fig_cmd
 *
cmd
)

15 
i
;

22 
i
 = 0; i < 
IWL_MAX_TID_COUNT
; i++) {

23 
u16
 
£q
 = 
mvm_≠_°a
->
tid_d©a
[
i
].
£q_numbî
;

24 
£q
 -= 0x10;

25 
cmd
->
qos_£q
[
i
] = 
	`˝u_to_À16
(
£q
);

27 
	}
}

29 
	$iwl_mvm_£nd_¥Ÿo_ofÊﬂd
(
iwl_mvm
 *
mvm
,

30 
õì80211_vif
 *
vif
,

31 
boﬁ
 
dißbÀ_ofÊﬂdög
,

32 
boﬁ
 
ofÊﬂd_ns
,

33 
u32
 
cmd_Êags
)

36 
iwl_¥Ÿo_ofÊﬂd_cmd_v1
 
v1
;

37 
iwl_¥Ÿo_ofÊﬂd_cmd_v2
 
v2
;

38 
iwl_¥Ÿo_ofÊﬂd_cmd_v3_smÆl
 
v3s
;

39 
iwl_¥Ÿo_ofÊﬂd_cmd_v4
 
v4
;

40 } 
cmd
 = {};

41 
iwl_ho°_cmd
 
hcmd
 = {

42 .
id
 = 
PROT_OFFLOAD_CONFIG_CMD
,

43 .
Êags
 = 
cmd_Êags
,

44 .
d©a
[0] = &
cmd
,

45 .
d©aÊags
[0] = 
IWL_HCMD_DFL_DUP
,

47 
iwl_¥Ÿo_ofÊﬂd_cmd_comm⁄
 *
comm⁄
;

48 
u32
 
íabÀd
 = 0, 
size
;

49 
u32
 
ˇ∑_Êags
 = 
mvm
->
fw
->
ucode_ˇ∑
.
Êags
;

50 
vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
hcmd
.
id
, 0);

52 #i‡
	`IS_ENABLED
(
CONFIG_IPV6
)

53 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

54 
i
;

61 
boﬁ
 
skù_ã¡©ive
 = 
ofÊﬂd_ns
;

63 i‡(
ˇ∑_Êags
 & 
IWL_UCODE_TLV_FLAGS_NEW_NSOFFL_SMALL
 ||

64 
ˇ∑_Êags
 & 
IWL_UCODE_TLV_FLAGS_NEW_NSOFFL_LARGE
) {

65 
iwl_ns_c⁄fig
 *
nsc
;

66 
iwl_èrg_addr
 *
addrs
;

67 
n_nsc
, 
n_addrs
;

68 
c
;

69 
num_skù≥d
 = 0;

71 i‡(
ˇ∑_Êags
 & 
IWL_UCODE_TLV_FLAGS_NEW_NSOFFL_SMALL
) {

72 
nsc
 = 
cmd
.
v3s
.
ns_c⁄fig
;

73 
n_nsc
 = 
IWL_PROTO_OFFLOAD_NUM_NS_CONFIG_V3S
;

74 
addrs
 = 
cmd
.
v3s
.
èrg_addrs
;

75 
n_addrs
 = 
IWL_PROTO_OFFLOAD_NUM_IPV6_ADDRS_V3S
;

77 
nsc
 = 
cmd
.
v4
.
ns_c⁄fig
;

78 
n_nsc
 = 
IWL_PROTO_OFFLOAD_NUM_NS_CONFIG_V3L
;

79 
addrs
 = 
cmd
.
v4
.
èrg_addrs
;

80 
n_addrs
 = 
IWL_PROTO_OFFLOAD_NUM_IPV6_ADDRS_V3L
;

88 
i
 = 0, 
c
 = 0;

89 
i
 < 
mvmvif
->
num_èrgë_ùv6_addrs
 &&

90 
i
 < 
n_addrs
 && 
c
 < 
n_nsc
; i++) {

91 
ö6_addr
 
sﬁicôed_addr
;

92 
j
;

94 i‡(
skù_ã¡©ive
 &&

95 
	`ã°_bô
(
i
, 
mvmvif
->
ã¡©ive_addrs
)) {

96 
num_skù≥d
++;

100 
	`addrc⁄f_addr_sﬁi˘_mu…
(&
mvmvif
->
èrgë_ùv6_addrs
[
i
],

101 &
sﬁicôed_addr
);

102 
j
 = 0; j < 
c
; j++)

103 i‡(
	`ùv6_addr_cmp
(&
nsc
[
j
].
de°_ùv6_addr
,

104 &
sﬁicôed_addr
) == 0)

106 i‡(
j
 =
c
)

107 
c
++;

108 
addrs
[
i
].
addr
 = 
mvmvif
->
èrgë_ùv6_addrs
[i];

109 
addrs
[
i
].
c⁄fig_num
 = 
	`˝u_to_À32
(
j
);

110 
nsc
[
j
].
de°_ùv6_addr
 = 
sﬁicôed_addr
;

111 
	`mem˝y
(
nsc
[
j
].
èrgë_mac_addr
, 
vif
->
addr
, 
ETH_ALEN
);

114 i‡(
mvmvif
->
num_èrgë_ùv6_addrs
 - 
num_skù≥d
)

115 
íabÀd
 |
IWL_D3_PROTO_IPV6_VALID
;

117 i‡(
ˇ∑_Êags
 & 
IWL_UCODE_TLV_FLAGS_NEW_NSOFFL_SMALL
)

118 
cmd
.
v3s
.
num_vÆid_ùv6_addrs
 =

119 
	`˝u_to_À32
(
i
 - 
num_skù≥d
);

121 
cmd
.
v4
.
num_vÆid_ùv6_addrs
 =

122 
	`˝u_to_À32
(
i
 - 
num_skù≥d
);

123 } i‡(
ˇ∑_Êags
 & 
IWL_UCODE_TLV_FLAGS_D3_6_IPV6_ADDRS
) {

124 
boﬁ
 
found
 = 
Ál£
;

126 
	`BUILD_BUG_ON
((
cmd
.
v2
.
èrgë_ùv6_addr
[0]) !=

127 (
mvmvif
->
èrgë_ùv6_addrs
[0]));

129 
i
 = 0; i < 
	`mö
(
mvmvif
->
num_èrgë_ùv6_addrs
,

130 
IWL_PROTO_OFFLOAD_NUM_IPV6_ADDRS_V2
); 
i
++) {

131 i‡(
skù_ã¡©ive
 &&

132 
	`ã°_bô
(
i
, 
mvmvif
->
ã¡©ive_addrs
))

135 
	`mem˝y
(
cmd
.
v2
.
èrgë_ùv6_addr
[
i
],

136 &
mvmvif
->
èrgë_ùv6_addrs
[
i
],

137 (
cmd
.
v2
.
èrgë_ùv6_addr
[
i
]));

139 
found
 = 
åue
;

141 i‡(
found
) {

142 
íabÀd
 |
IWL_D3_PROTO_IPV6_VALID
;

143 
	`mem˝y
(
cmd
.
v2
.
ndp_mac_addr
, 
vif
->
addr
, 
ETH_ALEN
);

146 
boﬁ
 
found
 = 
Ál£
;

147 
	`BUILD_BUG_ON
((
cmd
.
v1
.
èrgë_ùv6_addr
[0]) !=

148 (
mvmvif
->
èrgë_ùv6_addrs
[0]));

150 
i
 = 0; i < 
	`mö
(
mvmvif
->
num_èrgë_ùv6_addrs
,

151 
IWL_PROTO_OFFLOAD_NUM_IPV6_ADDRS_V1
); 
i
++) {

152 i‡(
skù_ã¡©ive
 &&

153 
	`ã°_bô
(
i
, 
mvmvif
->
ã¡©ive_addrs
))

156 
	`mem˝y
(
cmd
.
v1
.
èrgë_ùv6_addr
[
i
],

157 &
mvmvif
->
èrgë_ùv6_addrs
[
i
],

158 (
cmd
.
v1
.
èrgë_ùv6_addr
[
i
]));

160 
found
 = 
åue
;

163 i‡(
found
) {

164 
íabÀd
 |
IWL_D3_PROTO_IPV6_VALID
;

165 
	`mem˝y
(
cmd
.
v1
.
ndp_mac_addr
, 
vif
->
addr
, 
ETH_ALEN
);

169 i‡(
ofÊﬂd_ns
 && (
íabÀd
 & 
IWL_D3_PROTO_IPV6_VALID
))

170 
íabÀd
 |
IWL_D3_PROTO_OFFLOAD_NS
;

172 i‡(
ˇ∑_Êags
 & 
IWL_UCODE_TLV_FLAGS_NEW_NSOFFL_SMALL
) {

173 
comm⁄
 = &
cmd
.
v3s
.common;

174 
size
 = (
cmd
.
v3s
);

175 } i‡(
ˇ∑_Êags
 & 
IWL_UCODE_TLV_FLAGS_NEW_NSOFFL_LARGE
) {

176 
comm⁄
 = &
cmd
.
v4
.common;

177 
size
 = (
cmd
.
v4
);

178 i‡(
vî
 < 4) {

184 
size
 -(
cmd
.
v4
.
°a_id
);

185 
hcmd
.
d©a
[0] = 
comm⁄
;

187 } i‡(
ˇ∑_Êags
 & 
IWL_UCODE_TLV_FLAGS_D3_6_IPV6_ADDRS
) {

188 
comm⁄
 = &
cmd
.
v2
.common;

189 
size
 = (
cmd
.
v2
);

191 
comm⁄
 = &
cmd
.
v1
.common;

192 
size
 = (
cmd
.
v1
);

195 i‡(
vif
->
cfg
.
¨p_addr_˙t
) {

196 
íabÀd
 |
IWL_D3_PROTO_OFFLOAD_ARP
 | 
IWL_D3_PROTO_IPV4_VALID
;

197 
comm⁄
->
ho°_ùv4_addr
 = 
vif
->
cfg
.
¨p_addr_li°
[0];

198 
	`mem˝y
(
comm⁄
->
¨p_mac_addr
, 
vif
->
addr
, 
ETH_ALEN
);

201 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

202 
IWL_UCODE_TLV_CAPA_OFFLOAD_BTM_SUPPORT
))

203 
íabÀd
 |
IWL_D3_PROTO_OFFLOAD_BTM
;

205 i‡(!
dißbÀ_ofÊﬂdög
)

206 
comm⁄
->
íabÀd
 = 
	`˝u_to_À32
(enabled);

208 
hcmd
.
Àn
[0] = 
size
;

209  
	`iwl_mvm_£nd_cmd
(
mvm
, &
hcmd
);

210 
	}
}

	@ops.c

7 
	~<löux/moduÀ.h
>

8 
	~<löux/π√éök.h
>

9 
	~<löux/vmÆloc.h
>

10 
	~<√t/mac80211.h
>

12 
	~"fw/nŸif-waô.h
"

13 
	~"iwl-å™s.h
"

14 
	~"iwl-›-mode.h
"

15 
	~"fw/img.h
"

16 
	~"iwl-debug.h
"

17 
	~"iwl-drv.h
"

18 
	~"iwl-mod∑øms.h
"

19 
	~"mvm.h
"

20 
	~"iwl-phy-db.h
"

21 
	~"iwl-ì¥om-∑r£.h
"

22 
	~"iwl-c§.h
"

23 
	~"iwl-io.h
"

24 
	~"iwl-¥ph.h
"

25 
	~"rs.h
"

26 
	~"fw/≠i/sˇn.h
"

27 
	~"fw/≠i/rfi.h
"

28 
	~"time-evít.h
"

29 
	~"fw-≠i.h
"

30 
	~"fw/a˝i.h
"

31 
	~"fw/uefi.h
"

32 
	~"time-sync.h
"

34 
	#DRV_DESCRIPTION
 "Thê√w I¡ñ(RËwúñes†AGN drivî f‹ Löux"

	)

35 
MODULE_DESCRIPTION
(
DRV_DESCRIPTION
);

36 
MODULE_LICENSE
("GPL");

37 
MODULE_IMPORT_NS
(
IWLWIFI
);

39 c⁄° 
iwl_›_mode_›s
 
	giwl_mvm_›s
;

40 c⁄° 
iwl_›_mode_›s
 
	giwl_mvm_›s_mq
;

42 
iwl_mvm_mod_∑øms
 
	giwlmvm_mod_∑øms
 = {

43 .
powî_scheme
 = 
IWL_POWER_SCHEME_BPS
,

47 
moduÀ_∑øm_«med
(
öô_dbg
, 
iwlmvm_mod_∑øms
.öô_dbg, 
boﬁ
, 0444);

48 
MODULE_PARM_DESC
(
öô_dbg
,

50 
moduÀ_∑øm_«med
(
powî_scheme
, 
iwlmvm_mod_∑øms
.power_scheme, , 0444);

51 
MODULE_PARM_DESC
(
powî_scheme
,

57 
__öô
 
	$iwl_mvm_öô
()

59 
ªt
;

61 
ªt
 = 
	`iwl_mvm_øã_c⁄åﬁ_ªgi°î
();

62 i‡(
ªt
) {

63 
	`¥_îr
("U«bÀÅÿªgi°îÑ©êc⁄åﬁálg‹ôhm: %d\n", 
ªt
);

64  
ªt
;

67 
ªt
 = 
	`iwl_›mode_ªgi°î
("iwlmvm", &
iwl_mvm_›s
);

68 i‡(
ªt
)

69 
	`¥_îr
("U«bÀÅÿªgi°î MVM op_mode: %d\n", 
ªt
);

71  
ªt
;

72 
	}
}

73 
moduÀ_öô
(
iwl_mvm_öô
);

75 
__exô
 
	$iwl_mvm_exô
()

77 
	`iwl_›mode_dîegi°î
("iwlmvm");

78 
	`iwl_mvm_øã_c⁄åﬁ_uƒegi°î
();

79 
	}
}

80 
moduÀ_exô
(
iwl_mvm_exô
);

82 
	$iwl_mvm_nic_c⁄fig
(
iwl_›_mode
 *
›_mode
)

84 
iwl_mvm
 *
mvm
 = 
	`IWL_OP_MODE_GET_MVM
(
›_mode
);

85 
u8
 
ødio_cfg_ty≥
, 
ødio_cfg_°ï
, 
ødio_cfg_dash
;

86 
u32
 
ªg_vÆ
;

87 
u32
 
phy_c⁄fig
 = 
	`iwl_mvm_gë_phy_c⁄fig
(
mvm
);

89 
ødio_cfg_ty≥
 = (
phy_c⁄fig
 & 
FW_PHY_CFG_RADIO_TYPE
) >>

90 
FW_PHY_CFG_RADIO_TYPE_POS
;

91 
ødio_cfg_°ï
 = (
phy_c⁄fig
 & 
FW_PHY_CFG_RADIO_STEP
) >>

92 
FW_PHY_CFG_RADIO_STEP_POS
;

93 
ødio_cfg_dash
 = (
phy_c⁄fig
 & 
FW_PHY_CFG_RADIO_DASH
) >>

94 
FW_PHY_CFG_RADIO_DASH_POS
;

96 
	`IWL_DEBUG_INFO
(
mvm
, "Radiÿty≥=0x%x-0x%x-0x%x\n", 
ødio_cfg_ty≥
,

97 
ødio_cfg_°ï
, 
ødio_cfg_dash
);

99 i‡(
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 >
IWL_DEVICE_FAMILY_AX210
)

103 
ªg_vÆ
 = 
	`CSR_HW_REV_STEP_DASH
(
mvm
->
å™s
->
hw_ªv
);

106 
ªg_vÆ
 |
ødio_cfg_ty≥
 << 
CSR_HW_IF_CONFIG_REG_POS_PHY_TYPE
;

107 
ªg_vÆ
 |
ødio_cfg_°ï
 << 
CSR_HW_IF_CONFIG_REG_POS_PHY_STEP
;

108 
ªg_vÆ
 |
ødio_cfg_dash
 << 
CSR_HW_IF_CONFIG_REG_POS_PHY_DASH
;

110 
	`WARN_ON
((
ødio_cfg_ty≥
 << 
CSR_HW_IF_CONFIG_REG_POS_PHY_TYPE
) &

111 ~
CSR_HW_IF_CONFIG_REG_MSK_PHY_TYPE
);

121 i‡(
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 < 
IWL_DEVICE_FAMILY_8000
)

122 
ªg_vÆ
 |
CSR_HW_IF_CONFIG_REG_BIT_RADIO_SI
;

124 i‡(
	`iwl_fw_dbg_is_d3_debug_íabÀd
(&
mvm
->
fwπ
))

125 
ªg_vÆ
 |
CSR_HW_IF_CONFIG_REG_D3_DEBUG
;

127 
	`iwl_å™s_£t_bôs_mask
(
mvm
->
å™s
, 
CSR_HW_IF_CONFIG_REG
,

128 
CSR_HW_IF_CONFIG_REG_MSK_MAC_STEP_DASH
 |

129 
CSR_HW_IF_CONFIG_REG_MSK_PHY_TYPE
 |

130 
CSR_HW_IF_CONFIG_REG_MSK_PHY_STEP
 |

131 
CSR_HW_IF_CONFIG_REG_MSK_PHY_DASH
 |

132 
CSR_HW_IF_CONFIG_REG_BIT_RADIO_SI
 |

133 
CSR_HW_IF_CONFIG_REG_BIT_MAC_SI
 |

134 
CSR_HW_IF_CONFIG_REG_D3_DEBUG
,

135 
ªg_vÆ
);

142 i‡(!
mvm
->
å™s
->
cfg
->
≠mg_nŸ_suµ‹ãd
)

143 
	`iwl_£t_bôs_mask_¥ph
(
mvm
->
å™s
, 
APMG_PS_CTRL_REG
,

144 
APMG_PS_CTRL_EARLY_PWR_OFF_RESET_DIS
,

145 ~
APMG_PS_CTRL_EARLY_PWR_OFF_RESET_DIS
);

146 
	}
}

148 
	$iwl_mvm_rx_m⁄ô‹_nŸif
(
iwl_mvm
 *
mvm
,

149 
iwl_rx_cmd_buf„r
 *
rxb
)

151 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

152 
iwl_d©≠©h_m⁄ô‹_nŸif
 *
nŸif
 = (*)
pkt
->
d©a
;

153 
õì80211_suµ‹ãd_b™d
 *
sb™d
;

154 c⁄° 
õì80211_°a_he_ˇp
 *
he_ˇp
;

155 
õì80211_vif
 *
vif
;

157 i‡(
nŸif
->
ty≥
 !
	`˝u_to_À32
(
IWL_DP_MON_NOTIF_TYPE_EXT_CCA
))

160 
vif
 = 
	`iwl_mvm_gë_vif_by_macid
(
mvm
, 
nŸif
->
mac_id
);

161 i‡(!
vif
 || vif->
ty≥
 !
NL80211_IFTYPE_STATION
)

164 i‡(!
vif
->
bss_c⁄f
.
ch™ªq
.
›î
.
ch™
 ||

165 
vif
->
bss_c⁄f
.
ch™ªq
.
›î
.
ch™
->
b™d
 !
NL80211_BAND_2GHZ
 ||

166 
vif
->
bss_c⁄f
.
ch™ªq
.
›î
.
width
 < 
NL80211_CHAN_WIDTH_40
)

169 i‡(!
vif
->
cfg
.
assoc
)

173 i‡(
mvm
->
cˇ_40mhz_w‹k¨ound
)

180 
mvm
->
cˇ_40mhz_w‹k¨ound
 = 2;

189 
sb™d
 = 
mvm
->
hw
->
wùhy
->
b™ds
[
NL80211_BAND_2GHZ
];

191 
	`WARN_ON
(!
sb™d
->
ht_ˇp
.
ht_suµ‹ãd
);

192 
	`WARN_ON
(!(
sb™d
->
ht_ˇp
.
ˇp
 & 
IEEE80211_HT_CAP_SUP_WIDTH_20_40
));

193 
sb™d
->
ht_ˇp
.
ˇp
 &~
IEEE80211_HT_CAP_SUP_WIDTH_20_40
;

195 
he_ˇp
 = 
	`õì80211_gë_he_i·y≥_ˇp_vif
(
sb™d
, 
vif
);

197 i‡(
he_ˇp
) {

199 
õì80211_°a_he_ˇp
 *
he
 = (*)(
uöçå_t
)
he_ˇp
;

201 
	`WARN_ON
(!
he
->
has_he
);

202 
	`WARN_ON
(!(
he
->
he_ˇp_ñem
.
phy_ˇp_öfo
[0] &

203 
IEEE80211_HE_PHY_CAP0_CHANNEL_WIDTH_SET_40MHZ_IN_2G
));

204 
he
->
he_ˇp_ñem
.
phy_ˇp_öfo
[0] &=

205 ~
IEEE80211_HE_PHY_CAP0_CHANNEL_WIDTH_SET_40MHZ_IN_2G
;

208 
	`õì80211_disc⁄√˘
(
vif
, 
åue
);

209 
	}
}

211 
	$iwl_mvm_upd©e_lök_smps
(
õì80211_vif
 *
vif
,

212 
õì80211_bss_c⁄f
 *
lök_c⁄f
)

214 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

215 
iwl_mvm
 *
mvm
 = 
mvmvif
->mvm;

216 
õì80211_smps_mode
 
mode
 = 
IEEE80211_SMPS_AUTOMATIC
;

218 i‡(!
lök_c⁄f
)

221 i‡(
mvm
->
fw_°©ic_smps_ªque°
 &&

222 
lök_c⁄f
->
ch™ªq
.
›î
.
width
 =
NL80211_CHAN_WIDTH_160
 &&

223 
lök_c⁄f
->
he_suµ‹t
)

224 
mode
 = 
IEEE80211_SMPS_STATIC
;

226 
	`iwl_mvm_upd©e_smps
(
mvm
, 
vif
, 
IWL_MVM_SMPS_REQ_FW
, 
mode
,

227 
lök_c⁄f
->
lök_id
);

228 
	}
}

230 
	$iwl_mvm_ötf_duÆ_chaö_ªq
(*
d©a
, 
u8
 *
mac
,

231 
õì80211_vif
 *
vif
)

233 
õì80211_bss_c⁄f
 *
lök_c⁄f
;

234 
lök_id
;

236 
	`rcu_ªad_lock
();

238 
	`f‹_óch_vif_a˘ive_lök
(
vif
, 
lök_c⁄f
, 
lök_id
)

239 
	`iwl_mvm_upd©e_lök_smps
(
vif
, 
lök_c⁄f
);

241 
	`rcu_ªad_u∆ock
();

242 
	}
}

244 
	$iwl_mvm_rx_thîmÆ_duÆ_chaö_ªq
(
iwl_mvm
 *
mvm
,

245 
iwl_rx_cmd_buf„r
 *
rxb
)

247 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

248 
iwl_thîmÆ_duÆ_chaö_ªque°
 *
ªq
 = (*)
pkt
->
d©a
;

254 
mvm
->
fw_°©ic_smps_ªque°
 =

255 
ªq
->
evít
 =
	`˝u_to_À32
(
THERMAL_DUAL_CHAIN_REQ_DISABLE
);

256 
	`õì80211_ôî©e_öãrÁ˚s
(
mvm
->
hw
,

257 
IEEE80211_IFACE_SKIP_SDATA_NOT_IN_DRIVER
,

258 
iwl_mvm_ötf_duÆ_chaö_ªq
, 
NULL
);

259 
	}
}

274 
	eiwl_rx_h™dÀr_c⁄ãxt
 {

275 
	mRX_HANDLER_SYNC
,

276 
	mRX_HANDLER_ASYNC_LOCKED
,

277 
	mRX_HANDLER_ASYNC_UNLOCKED
,

278 
	mRX_HANDLER_ASYNC_LOCKED_WIPHY
,

288 
	siwl_rx_h™dÀrs
 {

289 
u16
 
	mcmd_id
, 
	mmö_size
;

290 
iwl_rx_h™dÀr_c⁄ãxt
 
	mc⁄ãxt
;

291 (*
	m‚
)(
iwl_mvm
 *
	mmvm
, 
iwl_rx_cmd_buf„r
 *
	mrxb
);

294 
	#RX_HANDLER_NO_SIZE
(
_cmd_id
, 
_‚
, 
_c⁄ãxt
) \

295 { .
cmd_id
 = 
_cmd_id
, .
‚
 = 
_‚
, .
c⁄ãxt
 = 
_c⁄ãxt
, }

	)

296 
	#RX_HANDLER_GRP_NO_SIZE
(
_gΩ
, 
_cmd
, 
_‚
, 
_c⁄ãxt
) \

297 { .
cmd_id
 = 
	`WIDE_ID
(
_gΩ
, 
_cmd
), .
‚
 = 
_‚
, .
c⁄ãxt
 = 
_c⁄ãxt
, }

	)

298 
	#RX_HANDLER
(
_cmd_id
, 
_‚
, 
_c⁄ãxt
, 
_°ru˘
) \

299 { .
cmd_id
 = 
_cmd_id
, .
‚
 = 
_‚
, \

300 .
c⁄ãxt
 = 
_c⁄ãxt
, .
mö_size
 = (
_°ru˘
), }

	)

301 
	#RX_HANDLER_GRP
(
_gΩ
, 
_cmd
, 
_‚
, 
_c⁄ãxt
, 
_°ru˘
) \

302 { .
cmd_id
 = 
	`WIDE_ID
(
_gΩ
, 
_cmd
), .
‚
 = 
_‚
, \

303 .
c⁄ãxt
 = 
_c⁄ãxt
, .
mö_size
 = (
_°ru˘
), }

	)

312 c⁄° 
iwl_rx_h™dÀrs
 
	giwl_mvm_rx_h™dÀrs
[] = {

313 
RX_HANDLER
(
TX_CMD
, 
iwl_mvm_rx_tx_cmd
, 
RX_HANDLER_SYNC
,

314 
iwl_mvm_tx_ª•
),

315 
RX_HANDLER
(
BA_NOTIF
, 
iwl_mvm_rx_ba_nŸif
, 
RX_HANDLER_SYNC
,

316 
iwl_mvm_ba_nŸif
),

318 
RX_HANDLER_GRP
(
DATA_PATH_GROUP
, 
TLC_MNG_UPDATE_NOTIF
,

319 
iwl_mvm_éc_upd©e_nŸif
, 
RX_HANDLER_SYNC
,

320 
iwl_éc_upd©e_nŸif
),

322 
RX_HANDLER
(
BT_PROFILE_NOTIFICATION
, 
iwl_mvm_rx_bt_c€x_nŸif
,

323 
RX_HANDLER_ASYNC_LOCKED_WIPHY
,

324 
iwl_bt_c€x_¥ofûe_nŸif
),

325 
RX_HANDLER_NO_SIZE
(
BEACON_NOTIFICATION
, 
iwl_mvm_rx_bóc⁄_nŸif
,

326 
RX_HANDLER_ASYNC_LOCKED
),

327 
RX_HANDLER_NO_SIZE
(
STATISTICS_NOTIFICATION
, 
iwl_mvm_rx_°©i°ics
,

328 
RX_HANDLER_ASYNC_LOCKED
),

330 
RX_HANDLER_GRP
(
STATISTICS_GROUP
, 
STATISTICS_OPER_NOTIF
,

331 
iwl_mvm_h™dÀ_rx_sy°em_›î_°©s
,

332 
RX_HANDLER_ASYNC_LOCKED_WIPHY
,

333 
iwl_sy°em_°©i°ics_nŸif_›î
),

334 
RX_HANDLER_GRP
(
STATISTICS_GROUP
, 
STATISTICS_OPER_PART1_NOTIF
,

335 
iwl_mvm_h™dÀ_rx_sy°em_›î_∑π1_°©s
,

336 
RX_HANDLER_ASYNC_LOCKED
,

337 
iwl_sy°em_°©i°ics_∑π1_nŸif_›î
),

338 
RX_HANDLER_GRP
(
SYSTEM_GROUP
, 
SYSTEM_STATISTICS_END_NOTIF
,

339 
iwl_mvm_h™dÀ_rx_sy°em_íd_°©s_nŸif
,

340 
RX_HANDLER_ASYNC_LOCKED
,

341 
iwl_sy°em_°©i°ics_íd_nŸif
),

343 
RX_HANDLER
(
BA_WINDOW_STATUS_NOTIFICATION_ID
,

344 
iwl_mvm_wödow_°©us_nŸif
, 
RX_HANDLER_SYNC
,

345 
iwl_ba_wödow_°©us_nŸif
),

347 
RX_HANDLER
(
TIME_EVENT_NOTIFICATION
, 
iwl_mvm_rx_time_evít_nŸif
,

348 
RX_HANDLER_SYNC
, 
iwl_time_evít_nŸif
),

349 
RX_HANDLER_GRP
(
MAC_CONF_GROUP
, 
SESSION_PROTECTION_NOTIF
,

350 
iwl_mvm_rx_£ssi⁄_¥Ÿe˘_nŸif
, 
RX_HANDLER_SYNC
,

351 
iwl_mvm_£ssi⁄_¥Ÿ_nŸif
),

352 
RX_HANDLER
(
MCC_CHUB_UPDATE_CMD
, 
iwl_mvm_rx_chub_upd©e_mcc
,

353 
RX_HANDLER_ASYNC_LOCKED
, 
iwl_mcc_chub_nŸif
),

355 
RX_HANDLER
(
EOSP_NOTIFICATION
, 
iwl_mvm_rx_eo•_nŸif
, 
RX_HANDLER_SYNC
,

356 
iwl_mvm_eo•_nŸifiˇti⁄
),

358 
RX_HANDLER
(
SCAN_ITERATION_COMPLETE
,

359 
iwl_mvm_rx_lmac_sˇn_ôî_com∂ëe_nŸif
, 
RX_HANDLER_SYNC
,

360 
iwl_lmac_sˇn_com∂ëe_nŸif
),

361 
RX_HANDLER
(
SCAN_OFFLOAD_COMPLETE
,

362 
iwl_mvm_rx_lmac_sˇn_com∂ëe_nŸif
,

363 
RX_HANDLER_ASYNC_LOCKED
, 
iwl_≥riodic_sˇn_com∂ëe
),

364 
RX_HANDLER_NO_SIZE
(
MATCH_FOUND_NOTIFICATION
,

365 
iwl_mvm_rx_sˇn_m©ch_found
,

366 
RX_HANDLER_SYNC
),

367 
RX_HANDLER
(
SCAN_COMPLETE_UMAC
, 
iwl_mvm_rx_umac_sˇn_com∂ëe_nŸif
,

368 
RX_HANDLER_ASYNC_LOCKED
, 
iwl_umac_sˇn_com∂ëe
),

369 
RX_HANDLER
(
SCAN_ITERATION_COMPLETE_UMAC
,

370 
iwl_mvm_rx_umac_sˇn_ôî_com∂ëe_nŸif
, 
RX_HANDLER_SYNC
,

371 
iwl_umac_sˇn_ôî_com∂ëe_nŸif
),

373 
RX_HANDLER
(
MISSED_BEACONS_NOTIFICATION
, 
iwl_mvm_rx_mis£d_bóc⁄s_nŸif
,

374 
RX_HANDLER_SYNC
, 
iwl_mis£d_bóc⁄s_nŸif
),

376 
RX_HANDLER
(
REPLY_ERROR
, 
iwl_mvm_rx_fw_îr‹
, 
RX_HANDLER_SYNC
,

377 
iwl_îr‹_ª•
),

378 
RX_HANDLER
(
PSM_UAPSD_AP_MISBEHAVING_NOTIFICATION
,

379 
iwl_mvm_powî_u≠sd_misbehavög_≠_nŸif
, 
RX_HANDLER_SYNC
,

380 
iwl_u≠sd_misbehavög_≠_nŸif
),

381 
RX_HANDLER_NO_SIZE
(
DTS_MEASUREMENT_NOTIFICATION
, 
iwl_mvm_ãmp_nŸif
,

382 
RX_HANDLER_ASYNC_LOCKED
),

383 
RX_HANDLER_GRP_NO_SIZE
(
PHY_OPS_GROUP
, 
DTS_MEASUREMENT_NOTIF_WIDE
,

384 
iwl_mvm_ãmp_nŸif
, 
RX_HANDLER_ASYNC_UNLOCKED
),

385 
RX_HANDLER_GRP
(
PHY_OPS_GROUP
, 
CT_KILL_NOTIFICATION
,

386 
iwl_mvm_˘_kûl_nŸif
, 
RX_HANDLER_SYNC
,

387 
˘_kûl_nŸif
),

389 
RX_HANDLER
(
TDLS_CHANNEL_SWITCH_NOTIFICATION
, 
iwl_mvm_rx_tdls_nŸif
,

390 
RX_HANDLER_ASYNC_LOCKED
,

391 
iwl_tdls_ch™√l_swôch_nŸif
),

392 
RX_HANDLER
(
MFUART_LOAD_NOTIFICATION
, 
iwl_mvm_rx_mfu¨t_nŸif
,

393 
RX_HANDLER_SYNC
, 
iwl_mfu¨t_lﬂd_nŸif_v1
),

394 
RX_HANDLER_GRP
(
LOCATION_GROUP
, 
TOF_RESPONDER_STATS
,

395 
iwl_mvm_·m_ª•⁄dî_°©s
, 
RX_HANDLER_ASYNC_LOCKED
,

396 
iwl_·m_ª•⁄dî_°©s
),

398 
RX_HANDLER_GRP_NO_SIZE
(
LOCATION_GROUP
, 
TOF_RANGE_RESPONSE_NOTIF
,

399 
iwl_mvm_·m_ønge_ª•
, 
RX_HANDLER_ASYNC_LOCKED
),

400 
RX_HANDLER_GRP_NO_SIZE
(
LOCATION_GROUP
, 
TOF_LC_NOTIF
,

401 
iwl_mvm_·m_lc_nŸif
, 
RX_HANDLER_ASYNC_LOCKED
),

403 
RX_HANDLER_GRP
(
DEBUG_GROUP
, 
MFU_ASSERT_DUMP_NTF
,

404 
iwl_mvm_mfu_as£π_dump_nŸif
, 
RX_HANDLER_SYNC
,

405 
iwl_mfu_as£π_dump_nŸif
),

406 
RX_HANDLER_GRP
(
PROT_OFFLOAD_GROUP
, 
STORED_BEACON_NTF
,

407 
iwl_mvm_rx_°‹ed_bóc⁄_nŸif
, 
RX_HANDLER_SYNC
,

408 
iwl_°‹ed_bóc⁄_nŸif_v2
),

409 
RX_HANDLER_GRP
(
DATA_PATH_GROUP
, 
MU_GROUP_MGMT_NOTIF
,

410 
iwl_mvm_mu_mimo_gΩ_nŸif
, 
RX_HANDLER_SYNC
,

411 
iwl_mu_group_mgmt_nŸif
),

412 
RX_HANDLER_GRP
(
DATA_PATH_GROUP
, 
STA_PM_NOTIF
,

413 
iwl_mvm_°a_pm_nŸif
, 
RX_HANDLER_SYNC
,

414 
iwl_mvm_pm_°©e_nŸifiˇti⁄
),

415 
RX_HANDLER_GRP
(
MAC_CONF_GROUP
, 
PROBE_RESPONSE_DATA_NOTIF
,

416 
iwl_mvm_¥obe_ª•_d©a_nŸif
,

417 
RX_HANDLER_ASYNC_LOCKED
,

418 
iwl_¥obe_ª•_d©a_nŸif
),

419 
RX_HANDLER_GRP
(
MAC_CONF_GROUP
, 
CHANNEL_SWITCH_START_NOTIF
,

420 
iwl_mvm_ch™√l_swôch_°¨t_nŸif
,

421 
RX_HANDLER_SYNC
, 
iwl_ch™√l_swôch_°¨t_nŸif
),

422 
RX_HANDLER_GRP
(
MAC_CONF_GROUP
, 
CHANNEL_SWITCH_ERROR_NOTIF
,

423 
iwl_mvm_ch™√l_swôch_îr‹_nŸif
,

424 
RX_HANDLER_ASYNC_UNLOCKED
,

425 
iwl_ch™√l_swôch_îr‹_nŸif
),

426 
RX_HANDLER_GRP
(
DATA_PATH_GROUP
, 
MONITOR_NOTIF
,

427 
iwl_mvm_rx_m⁄ô‹_nŸif
, 
RX_HANDLER_ASYNC_LOCKED
,

428 
iwl_d©≠©h_m⁄ô‹_nŸif
),

430 
RX_HANDLER_GRP
(
DATA_PATH_GROUP
, 
THERMAL_DUAL_CHAIN_REQUEST
,

431 
iwl_mvm_rx_thîmÆ_duÆ_chaö_ªq
,

432 
RX_HANDLER_ASYNC_LOCKED
,

433 
iwl_thîmÆ_duÆ_chaö_ªque°
),

435 
RX_HANDLER_GRP
(
SYSTEM_GROUP
, 
RFI_DEACTIVATE_NOTIF
,

436 
iwl_rfi_dó˘iv©e_nŸif_h™dÀr
, 
RX_HANDLER_ASYNC_UNLOCKED
,

437 
iwl_rfi_dó˘iv©e_nŸif
),

439 
RX_HANDLER_GRP
(
LEGACY_GROUP
,

440 
WNM_80211V_TIMING_MEASUREMENT_NOTIFICATION
,

441 
iwl_mvm_time_sync_msmt_evít
, 
RX_HANDLER_SYNC
,

442 
iwl_time_msmt_nŸify
),

443 
RX_HANDLER_GRP
(
LEGACY_GROUP
,

444 
WNM_80211V_TIMING_MEASUREMENT_CONFIRM_NOTIFICATION
,

445 
iwl_mvm_time_sync_msmt_c⁄fúm_evít
, 
RX_HANDLER_SYNC
,

446 
iwl_time_msmt_cfm_nŸify
),

447 
RX_HANDLER_GRP
(
MAC_CONF_GROUP
, 
ROC_NOTIF
,

448 
iwl_mvm_rx_roc_nŸif
, 
RX_HANDLER_SYNC
,

449 
iwl_roc_nŸif
),

451 #unde‡
RX_HANDLER


452 #unde‡
RX_HANDLER_GRP


457 c⁄° 
iwl_hcmd_«mes
 
	giwl_mvm_Àgacy_«mes
[] = {

458 
HCMD_NAME
(
UCODE_ALIVE_NTFY
),

459 
HCMD_NAME
(
REPLY_ERROR
),

460 
HCMD_NAME
(
ECHO_CMD
),

461 
HCMD_NAME
(
INIT_COMPLETE_NOTIF
),

462 
HCMD_NAME
(
PHY_CONTEXT_CMD
),

463 
HCMD_NAME
(
DBG_CFG
),

464 
HCMD_NAME
(
SCAN_CFG_CMD
),

465 
HCMD_NAME
(
SCAN_REQ_UMAC
),

466 
HCMD_NAME
(
SCAN_ABORT_UMAC
),

467 
HCMD_NAME
(
SCAN_COMPLETE_UMAC
),

468 
HCMD_NAME
(
BA_WINDOW_STATUS_NOTIFICATION_ID
),

469 
HCMD_NAME
(
ADD_STA_KEY
),

470 
HCMD_NAME
(
ADD_STA
),

471 
HCMD_NAME
(
REMOVE_STA
),

472 
HCMD_NAME
(
TX_CMD
),

473 
HCMD_NAME
(
SCD_QUEUE_CFG
),

474 
HCMD_NAME
(
TXPATH_FLUSH
),

475 
HCMD_NAME
(
MGMT_MCAST_KEY
),

476 
HCMD_NAME
(
WEP_KEY
),

477 
HCMD_NAME
(
SHARED_MEM_CFG
),

478 
HCMD_NAME
(
TDLS_CHANNEL_SWITCH_CMD
),

479 
HCMD_NAME
(
MAC_CONTEXT_CMD
),

480 
HCMD_NAME
(
TIME_EVENT_CMD
),

481 
HCMD_NAME
(
TIME_EVENT_NOTIFICATION
),

482 
HCMD_NAME
(
BINDING_CONTEXT_CMD
),

483 
HCMD_NAME
(
TIME_QUOTA_CMD
),

484 
HCMD_NAME
(
NON_QOS_TX_COUNTER_CMD
),

485 
HCMD_NAME
(
LEDS_CMD
),

486 
HCMD_NAME
(
LQ_CMD
),

487 
HCMD_NAME
(
FW_PAGING_BLOCK_CMD
),

488 
HCMD_NAME
(
SCAN_OFFLOAD_REQUEST_CMD
),

489 
HCMD_NAME
(
SCAN_OFFLOAD_ABORT_CMD
),

490 
HCMD_NAME
(
HOT_SPOT_CMD
),

491 
HCMD_NAME
(
SCAN_OFFLOAD_PROFILES_QUERY_CMD
),

492 
HCMD_NAME
(
BT_COEX_UPDATE_REDUCED_TXP
),

493 
HCMD_NAME
(
BT_COEX_CI
),

494 
HCMD_NAME
(
WNM_80211V_TIMING_MEASUREMENT_NOTIFICATION
),

495 
HCMD_NAME
(
WNM_80211V_TIMING_MEASUREMENT_CONFIRM_NOTIFICATION
),

496 
HCMD_NAME
(
PHY_CONFIGURATION_CMD
),

497 
HCMD_NAME
(
CALIB_RES_NOTIF_PHY_DB
),

498 
HCMD_NAME
(
PHY_DB_CMD
),

499 
HCMD_NAME
(
SCAN_OFFLOAD_COMPLETE
),

500 
HCMD_NAME
(
SCAN_OFFLOAD_UPDATE_PROFILES_CMD
),

501 
HCMD_NAME
(
POWER_TABLE_CMD
),

502 
HCMD_NAME
(
PSM_UAPSD_AP_MISBEHAVING_NOTIFICATION
),

503 
HCMD_NAME
(
REPLY_THERMAL_MNG_BACKOFF
),

504 
HCMD_NAME
(
NVM_ACCESS_CMD
),

505 
HCMD_NAME
(
BEACON_NOTIFICATION
),

506 
HCMD_NAME
(
BEACON_TEMPLATE_CMD
),

507 
HCMD_NAME
(
TX_ANT_CONFIGURATION_CMD
),

508 
HCMD_NAME
(
BT_CONFIG
),

509 
HCMD_NAME
(
STATISTICS_CMD
),

510 
HCMD_NAME
(
STATISTICS_NOTIFICATION
),

511 
HCMD_NAME
(
EOSP_NOTIFICATION
),

512 
HCMD_NAME
(
REDUCE_TX_POWER_CMD
),

513 
HCMD_NAME
(
MISSED_BEACONS_NOTIFICATION
),

514 
HCMD_NAME
(
TDLS_CONFIG_CMD
),

515 
HCMD_NAME
(
MAC_PM_POWER_TABLE
),

516 
HCMD_NAME
(
TDLS_CHANNEL_SWITCH_NOTIFICATION
),

517 
HCMD_NAME
(
MFUART_LOAD_NOTIFICATION
),

518 
HCMD_NAME
(
RSS_CONFIG_CMD
),

519 
HCMD_NAME
(
SCAN_ITERATION_COMPLETE_UMAC
),

520 
HCMD_NAME
(
REPLY_RX_PHY_CMD
),

521 
HCMD_NAME
(
REPLY_RX_MPDU_CMD
),

522 
HCMD_NAME
(
BAR_FRAME_RELEASE
),

523 
HCMD_NAME
(
FRAME_RELEASE
),

524 
HCMD_NAME
(
BA_NOTIF
),

525 
HCMD_NAME
(
MCC_UPDATE_CMD
),

526 
HCMD_NAME
(
MCC_CHUB_UPDATE_CMD
),

527 
HCMD_NAME
(
MARKER_CMD
),

528 
HCMD_NAME
(
BT_PROFILE_NOTIFICATION
),

529 
HCMD_NAME
(
MCAST_FILTER_CMD
),

530 
HCMD_NAME
(
REPLY_SF_CFG_CMD
),

531 
HCMD_NAME
(
REPLY_BEACON_FILTERING_CMD
),

532 
HCMD_NAME
(
D3_CONFIG_CMD
),

533 
HCMD_NAME
(
PROT_OFFLOAD_CONFIG_CMD
),

534 
HCMD_NAME
(
MATCH_FOUND_NOTIFICATION
),

535 
HCMD_NAME
(
DTS_MEASUREMENT_NOTIFICATION
),

536 
HCMD_NAME
(
WOWLAN_PATTERNS
),

537 
HCMD_NAME
(
WOWLAN_CONFIGURATION
),

538 
HCMD_NAME
(
WOWLAN_TSC_RSC_PARAM
),

539 
HCMD_NAME
(
WOWLAN_TKIP_PARAM
),

540 
HCMD_NAME
(
WOWLAN_KEK_KCK_MATERIAL
),

541 
HCMD_NAME
(
WOWLAN_GET_STATUSES
),

542 
HCMD_NAME
(
SCAN_ITERATION_COMPLETE
),

543 
HCMD_NAME
(
D0I3_END_CMD
),

544 
HCMD_NAME
(
LTR_CONFIG
),

545 
HCMD_NAME
(
LDBG_CONFIG_CMD
),

551 c⁄° 
iwl_hcmd_«mes
 
	giwl_mvm_sy°em_«mes
[] = {

552 
HCMD_NAME
(
SHARED_MEM_CFG_CMD
),

553 
HCMD_NAME
(
INIT_EXTENDED_CFG_CMD
),

554 
HCMD_NAME
(
FW_ERROR_RECOVERY_CMD
),

555 
HCMD_NAME
(
RFI_CONFIG_CMD
),

556 
HCMD_NAME
(
RFI_GET_FREQ_TABLE_CMD
),

557 
HCMD_NAME
(
SYSTEM_FEATURES_CONTROL_CMD
),

558 
HCMD_NAME
(
SYSTEM_STATISTICS_CMD
),

559 
HCMD_NAME
(
SYSTEM_STATISTICS_END_NOTIF
),

560 
HCMD_NAME
(
RFI_DEACTIVATE_NOTIF
),

566 c⁄° 
iwl_hcmd_«mes
 
	giwl_mvm_mac_c⁄f_«mes
[] = {

567 
HCMD_NAME
(
CHANNEL_SWITCH_TIME_EVENT_CMD
),

568 
HCMD_NAME
(
SESSION_PROTECTION_CMD
),

569 
HCMD_NAME
(
MAC_CONFIG_CMD
),

570 
HCMD_NAME
(
LINK_CONFIG_CMD
),

571 
HCMD_NAME
(
STA_CONFIG_CMD
),

572 
HCMD_NAME
(
AUX_STA_CMD
),

573 
HCMD_NAME
(
STA_REMOVE_CMD
),

574 
HCMD_NAME
(
STA_DISABLE_TX_CMD
),

575 
HCMD_NAME
(
ROC_CMD
),

576 
HCMD_NAME
(
ROC_NOTIF
),

577 
HCMD_NAME
(
SESSION_PROTECTION_NOTIF
),

578 
HCMD_NAME
(
CHANNEL_SWITCH_START_NOTIF
),

584 c⁄° 
iwl_hcmd_«mes
 
	giwl_mvm_phy_«mes
[] = {

585 
HCMD_NAME
(
CMD_DTS_MEASUREMENT_TRIGGER_WIDE
),

586 
HCMD_NAME
(
CTDP_CONFIG_CMD
),

587 
HCMD_NAME
(
TEMP_REPORTING_THRESHOLDS_CMD
),

588 
HCMD_NAME
(
PER_CHAIN_LIMIT_OFFSET_CMD
),

589 
HCMD_NAME
(
CT_KILL_NOTIFICATION
),

590 
HCMD_NAME
(
DTS_MEASUREMENT_NOTIF_WIDE
),

596 c⁄° 
iwl_hcmd_«mes
 
	giwl_mvm_d©a_∑th_«mes
[] = {

597 
HCMD_NAME
(
DQA_ENABLE_CMD
),

598 
HCMD_NAME
(
UPDATE_MU_GROUPS_CMD
),

599 
HCMD_NAME
(
TRIGGER_RX_QUEUES_NOTIF_CMD
),

600 
HCMD_NAME
(
STA_HE_CTXT_CMD
),

601 
HCMD_NAME
(
RLC_CONFIG_CMD
),

602 
HCMD_NAME
(
RFH_QUEUE_CONFIG_CMD
),

603 
HCMD_NAME
(
TLC_MNG_CONFIG_CMD
),

604 
HCMD_NAME
(
CHEST_COLLECTOR_FILTER_CONFIG_CMD
),

605 
HCMD_NAME
(
SCD_QUEUE_CONFIG_CMD
),

606 
HCMD_NAME
(
SEC_KEY_CMD
),

607 
HCMD_NAME
(
MONITOR_NOTIF
),

608 
HCMD_NAME
(
THERMAL_DUAL_CHAIN_REQUEST
),

609 
HCMD_NAME
(
STA_PM_NOTIF
),

610 
HCMD_NAME
(
MU_GROUP_MGMT_NOTIF
),

611 
HCMD_NAME
(
RX_QUEUES_NOTIFICATION
),

617 c⁄° 
iwl_hcmd_«mes
 
	giwl_mvm_°©i°ics_«mes
[] = {

618 
HCMD_NAME
(
STATISTICS_OPER_NOTIF
),

619 
HCMD_NAME
(
STATISTICS_OPER_PART1_NOTIF
),

625 c⁄° 
iwl_hcmd_«mes
 
	giwl_mvm_sˇn_«mes
[] = {

626 
HCMD_NAME
(
OFFLOAD_MATCH_INFO_NOTIF
),

632 c⁄° 
iwl_hcmd_«mes
 
	giwl_mvm_loˇti⁄_«mes
[] = {

633 
HCMD_NAME
(
TOF_RANGE_REQ_CMD
),

634 
HCMD_NAME
(
TOF_CONFIG_CMD
),

635 
HCMD_NAME
(
TOF_RANGE_ABORT_CMD
),

636 
HCMD_NAME
(
TOF_RANGE_REQ_EXT_CMD
),

637 
HCMD_NAME
(
TOF_RESPONDER_CONFIG_CMD
),

638 
HCMD_NAME
(
TOF_RESPONDER_DYN_CONFIG_CMD
),

639 
HCMD_NAME
(
TOF_LC_NOTIF
),

640 
HCMD_NAME
(
TOF_RESPONDER_STATS
),

641 
HCMD_NAME
(
TOF_MCSI_DEBUG_NOTIF
),

642 
HCMD_NAME
(
TOF_RANGE_RESPONSE_NOTIF
),

648 c⁄° 
iwl_hcmd_«mes
 
	giwl_mvm_¥Ÿ_ofÊﬂd_«mes
[] = {

649 
HCMD_NAME
(
WOWLAN_WAKE_PKT_NOTIFICATION
),

650 
HCMD_NAME
(
WOWLAN_INFO_NOTIFICATION
),

651 
HCMD_NAME
(
D3_END_NOTIFICATION
),

652 
HCMD_NAME
(
STORED_BEACON_NTF
),

658 c⁄° 
iwl_hcmd_«mes
 
	giwl_mvm_ªguœt‹y_™d_nvm_«mes
[] = {

659 
HCMD_NAME
(
NVM_ACCESS_COMPLETE
),

660 
HCMD_NAME
(
NVM_GET_INFO
),

661 
HCMD_NAME
(
TAS_CONFIG
),

664 c⁄° 
iwl_hcmd_¨r
 
	giwl_mvm_groups
[] = {

665 [
LEGACY_GROUP
] = 
HCMD_ARR
(
iwl_mvm_Àgacy_«mes
),

666 [
LONG_GROUP
] = 
HCMD_ARR
(
iwl_mvm_Àgacy_«mes
),

667 [
SYSTEM_GROUP
] = 
HCMD_ARR
(
iwl_mvm_sy°em_«mes
),

668 [
MAC_CONF_GROUP
] = 
HCMD_ARR
(
iwl_mvm_mac_c⁄f_«mes
),

669 [
PHY_OPS_GROUP
] = 
HCMD_ARR
(
iwl_mvm_phy_«mes
),

670 [
DATA_PATH_GROUP
] = 
HCMD_ARR
(
iwl_mvm_d©a_∑th_«mes
),

671 [
SCAN_GROUP
] = 
HCMD_ARR
(
iwl_mvm_sˇn_«mes
),

672 [
LOCATION_GROUP
] = 
HCMD_ARR
(
iwl_mvm_loˇti⁄_«mes
),

673 [
PROT_OFFLOAD_GROUP
] = 
HCMD_ARR
(
iwl_mvm_¥Ÿ_ofÊﬂd_«mes
),

674 [
REGULATORY_AND_NVM_GROUP
] =

675 
HCMD_ARR
(
iwl_mvm_ªguœt‹y_™d_nvm_«mes
),

676 [
STATISTICS_GROUP
] = 
HCMD_ARR
(
iwl_mvm_°©i°ics_«mes
),

680 
iwl_mvm_async_h™dÀrs_wk
(
w‹k_°ru˘
 *
wk
);

681 
iwl_mvm_async_h™dÀrs_wùhy_wk
(
wùhy
 *wiphy,

682 
wùhy_w‹k
 *
w‹k
);

684 
u32
 
	$iwl_mvm_mö_backoff
(
iwl_mvm
 *
mvm
)

686 c⁄° 
iwl_pwr_tx_backoff
 *
backoff
 = 
mvm
->
cfg
->
pwr_tx_backoffs
;

687 
u64
 
dÊt_pwr_limô
;

689 i‡(!
backoff
)

692 
	`iwl_bios_gë_pwr_limô
(&
mvm
->
fwπ
, &
dÊt_pwr_limô
);

694 
backoff
->
pwr
) {

695 i‡(
dÊt_pwr_limô
 >
backoff
->
pwr
)

696  
backoff
->backoff;

698 
backoff
++;

702 
	}
}

704 
	$iwl_mvm_tx_unblock_dw‹k
(
w‹k_°ru˘
 *
w‹k
)

706 
iwl_mvm
 *
mvm
 =

707 
	`c⁄èöî_of
(
w‹k
, 
iwl_mvm
, 
cs_tx_unblock_dw‹k
.work);

708 
õì80211_vif
 *
tx_blocked_vif
;

709 
iwl_mvm_vif
 *
mvmvif
;

711 
	`muãx_lock
(&
mvm
->
muãx
);

713 
tx_blocked_vif
 =

714 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm
->
cß_tx_blocked_vif
,

715 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

717 i‡(!
tx_blocked_vif
)

718 
u∆ock
;

720 
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
tx_blocked_vif
);

721 
	`iwl_mvm_modify_Æl_°a_dißbÀ_tx
(
mvm
, 
mvmvif
, 
Ál£
);

722 
	`RCU_INIT_POINTER
(
mvm
->
cß_tx_blocked_vif
, 
NULL
);

723 
u∆ock
:

724 
	`muãx_u∆ock
(&
mvm
->
muãx
);

725 
	}
}

727 
	$iwl_mvm_fwπ_dump_°¨t
(*
˘x
)

729 
iwl_mvm
 *
mvm
 = 
˘x
;

731 
	`muãx_lock
(&
mvm
->
muãx
);

732 
	}
}

734 
	$iwl_mvm_fwπ_dump_íd
(*
˘x
)

736 
iwl_mvm
 *
mvm
 = 
˘x
;

738 
	`muãx_u∆ock
(&
mvm
->
muãx
);

739 
	}
}

741 
boﬁ
 
	$iwl_mvm_fwπ_fw_ru¬ög
(*
˘x
)

743  
	`iwl_mvm_fúmw¨e_ru¬ög
(
˘x
);

744 
	}
}

746 
	$iwl_mvm_fwπ_£nd_hcmd
(*
˘x
, 
iwl_ho°_cmd
 *
ho°_cmd
)

748 
iwl_mvm
 *
mvm
 = (iwl_mvm *)
˘x
;

749 
ªt
;

751 
	`muãx_lock
(&
mvm
->
muãx
);

752 
ªt
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, 
ho°_cmd
);

753 
	`muãx_u∆ock
(&
mvm
->
muãx
);

755  
ªt
;

756 
	}
}

758 
boﬁ
 
	$iwl_mvm_d3_debug_íabÀ
(*
˘x
)

760  
IWL_MVM_D3_DEBUG
;

761 
	}
}

763 c⁄° 
iwl_fw_ru¡ime_›s
 
	giwl_mvm_fwπ_›s
 = {

764 .
dump_°¨t
 = 
iwl_mvm_fwπ_dump_°¨t
,

765 .
	gdump_íd
 = 
iwl_mvm_fwπ_dump_íd
,

766 .
	gfw_ru¬ög
 = 
iwl_mvm_fwπ_fw_ru¬ög
,

767 .
	g£nd_hcmd
 = 
iwl_mvm_fwπ_£nd_hcmd
,

768 .
	gd3_debug_íabÀ
 = 
iwl_mvm_d3_debug_íabÀ
,

771 
	$iwl_mvm_°¨t_gë_nvm
(
iwl_mvm
 *
mvm
)

773 
iwl_å™s
 *
å™s
 = 
mvm
->trans;

774 
ªt
;

776 i‡(
å™s
->
csme_own
) {

777 i‡(
	`WARN
(!
mvm
->
mei_ªgi°îed
,

779 
gë_nvm_‰om_fw
;

781 
mvm
->
mei_nvm_d©a
 = 
	`iwl_mei_gë_nvm
();

782 i‡(
mvm
->
mei_nvm_d©a
) {

788 
mvm
->
nvm_d©a
 =

789 
	`iwl_∑r£_mei_nvm_d©a
(
å™s
,Åøns->
cfg
,

790 
mvm
->
mei_nvm_d©a
,

791 
mvm
->
fw
,

792 
mvm
->
£t_tx_™t
,

793 
mvm
->
£t_rx_™t
);

797 
	`IWL_ERR
(
mvm
,

801 
gë_nvm_‰om_fw
:

802 
	`π∆_lock
();

803 
	`wùhy_lock
(
mvm
->
hw
->
wùhy
);

804 
	`muãx_lock
(&
mvm
->
muãx
);

806 
ªt
 = 
	`iwl_å™s_°¨t_hw
(
mvm
->
å™s
);

807 i‡(
ªt
) {

808 
	`muãx_u∆ock
(&
mvm
->
muãx
);

809 
	`wùhy_u∆ock
(
mvm
->
hw
->
wùhy
);

810 
	`π∆_u∆ock
();

811  
ªt
;

814 
ªt
 = 
	`iwl_run_öô_mvm_ucode
(
mvm
);

815 i‡(
ªt
 &&Ñë !-
ERFKILL
)

816 
	`iwl_fw_dbg_îr‹_cﬁÀ˘
(&
mvm
->
fwπ
, 
FW_DBG_TRIGGER_DRIVER
);

817 i‡(!
ªt
 && 
	`iwl_mvm_is_œr_suµ‹ãd
(
mvm
)) {

818 
mvm
->
hw
->
wùhy
->
ªguœt‹y_Êags
 |
REGULATORY_WIPHY_SELF_MANAGED
;

819 
ªt
 = 
	`iwl_mvm_öô_mcc
(
mvm
);

822 i‡(!
iwlmvm_mod_∑øms
.
öô_dbg
 || !
ªt
)

823 
	`iwl_mvm_°›_devi˚
(
mvm
);

825 
	`muãx_u∆ock
(&
mvm
->
muãx
);

826 
	`wùhy_u∆ock
(
mvm
->
hw
->
wùhy
);

827 
	`π∆_u∆ock
();

829 i‡(
ªt
)

830 
	`IWL_ERR
(
mvm
, "FaûedÅÿru¿INIT ucode: %d\n", 
ªt
);

833 
mvm
->
∂dr_sync
 = 
Ál£
;

835  
ªt
;

836 
	}
}

838 
	$iwl_mvm_°¨t_po°_nvm
(
iwl_mvm
 *
mvm
)

840 
iwl_mvm_csme_c⁄n_öfo
 *
csme_c⁄n_öfo
 
__maybe_unu£d
;

841 
ªt
;

843 
	`iwl_mvm_toggÀ_tx_™t
(
mvm
, &mvm->
mgmt_œ°_™ã¬a_idx
);

845 
ªt
 = 
	`iwl_mvm_mac_£tup_ªgi°î
(
mvm
);

846 i‡(
ªt
)

847  
ªt
;

849 
mvm
->
hw_ªgi°îed
 = 
åue
;

851 
	`iwl_mvm_dbgfs_ªgi°î
(
mvm
);

853 
	`wùhy_rfkûl_£t_hw_°©e_ªas⁄
(
mvm
->
hw
->
wùhy
,

854 
mvm
->
mei_rfkûl_blocked
,

855 
RFKILL_HARD_BLOCK_NOT_OWNER
);

857 
	`iwl_mvm_mei_£t_sw_rfkûl_°©e
(
mvm
);

860 
	}
}

862 
	siwl_mvm_‰ob_txf_d©a
 {

863 
u8
 *
	mbuf
;

864 
size_t
 
	mbuÊí
;

867 
	$iwl_mvm_‰ob_txf_key_ôî
(
õì80211_hw
 *
hw
,

868 
õì80211_vif
 *
vif
,

869 
õì80211_°a
 *
°a
,

870 
õì80211_key_c⁄f
 *
key
,

871 *
d©a
)

873 
iwl_mvm_‰ob_txf_d©a
 *
txf
 = 
d©a
;

874 
u8
 
keyÀn
, 
m©ch
, 
m©chíd
;

875 
u8
 *
keyd©a
;

876 
size_t
 
i
;

878 
key
->
cùhî
) {

879 
WLAN_CIPHER_SUITE_CCMP
:

880 
keyd©a
 = 
key
->key;

881 
keyÀn
 = 
key
->keylen;

883 
WLAN_CIPHER_SUITE_WEP40
:

884 
WLAN_CIPHER_SUITE_WEP104
:

885 
WLAN_CIPHER_SUITE_TKIP
:

892 
	`mem£t
(
txf
->
buf
, 0xBB,Åxf->
buÊí
);

899 
m©ch
 = 0;

900 
i
 = 0; i < 
txf
->
buÊí
; i++) {

901 i‡(
txf
->
buf
[
i
] !
keyd©a
[
m©ch
]) {

902 
m©ch
 = 0;

905 
m©ch
++;

906 i‡(
m©ch
 =
keyÀn
) {

907 
	`mem£t
(
txf
->
buf
 + 
i
 - 
keyÀn
, 0xAA, keylen);

908 
m©ch
 = 0;

913 
m©chíd
 = 
m©ch
;

914 
i
 = 0; 
m©ch
 && i < 
keyÀn
 - match; i++) {

915 i‡(
txf
->
buf
[
i
] !
keyd©a
[
m©ch
])

917 
m©ch
++;

918 i‡(
m©ch
 =
keyÀn
) {

919 
	`mem£t
(
txf
->
buf
, 0xAA, 
i
 + 1);

920 
	`mem£t
(
txf
->
buf
 +Åxf->
buÊí
 - 
m©chíd
, 0xAA,

921 
m©chíd
);

925 
	}
}

927 
	$iwl_mvm_‰ob_txf
(*
˘x
, *
buf
, 
size_t
 
buÊí
)

929 
iwl_mvm_‰ob_txf_d©a
 
txf
 = {

930 .
buf
 = buf,

931 .
buÊí
 = buflen,

933 
iwl_mvm
 *
mvm
 = 
˘x
;

936 i‡(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
))

939 
	`rcu_ªad_lock
();

940 
	`õì80211_ôî_keys_rcu
(
mvm
->
hw
, 
NULL
, 
iwl_mvm_‰ob_txf_key_ôî
, &
txf
);

941 
	`rcu_ªad_u∆ock
();

942 
	}
}

944 
	$iwl_mvm_‰ob_hcmd
(*
˘x
, *
hcmd
, 
size_t
 
Àn
)

947 
iwl_cmd_hódî_wide
 *
hdr
 = 
hcmd
;

948 
‰ob_°¨t
 = (*
hdr
), 
‰ob_íd
 = 0;

950 i‡(
Àn
 < (
hdr
))

954 i‡(
hdr
->
group_id
 !
LONG_GROUP
)

957 
hdr
->
cmd
) {

958 
WEP_KEY
:

959 
WOWLAN_TKIP_PARAM
:

960 
WOWLAN_KEK_KCK_MATERIAL
:

961 
ADD_STA_KEY
:

966 
‰ob_íd
 = 
INT_MAX
;

968 
MGMT_MCAST_KEY
:

969 
‰ob_°¨t
 = 
	`off£tof
(
iwl_mvm_mgmt_mˇ°_key_cmd
, 
igtk
);

970 
	`BUILD_BUG_ON
(
	`off£tof
(
iwl_mvm_mgmt_mˇ°_key_cmd
, 
igtk
) !=

971 
	`off£tof
(
iwl_mvm_mgmt_mˇ°_key_cmd_v1
, 
igtk
));

973 
‰ob_íd
 = 
	`off£to„nd
(
iwl_mvm_mgmt_mˇ°_key_cmd
, 
igtk
);

974 
	`BUILD_BUG_ON
(
	`off£tof
(
iwl_mvm_mgmt_mˇ°_key_cmd
, 
igtk
) <

975 
	`off£tof
(
iwl_mvm_mgmt_mˇ°_key_cmd_v1
, 
igtk
));

979 i‡(
‰ob_°¨t
 >
‰ob_íd
)

982 i‡(
‰ob_íd
 > 
Àn
)

983 
‰ob_íd
 = 
Àn
;

985 
	`mem£t
((
u8
 *)
hcmd
 + 
‰ob_°¨t
, 0xAA, 
‰ob_íd
 - frob_start);

986 
	}
}

988 
	$iwl_mvm_‰ob_mem
(*
˘x
, 
u32
 
mem_addr
, *
mem
, 
size_t
 
buÊí
)

990 c⁄° 
iwl_dump_ex˛ude
 *
ex˛
;

991 
iwl_mvm
 *
mvm
 = 
˘x
;

992 
i
;

994 
mvm
->
fwπ
.
cur_fw_img
) {

995 
IWL_UCODE_INIT
:

999 
IWL_UCODE_REGULAR
:

1000 
IWL_UCODE_REGULAR_USNIFFER
:

1001 
ex˛
 = 
mvm
->
fw
->
dump_ex˛
;

1003 
IWL_UCODE_WOWLAN
:

1004 
ex˛
 = 
mvm
->
fw
->
dump_ex˛_wowœn
;

1008 
	`BUILD_BUG_ON
((
mvm
->
fw
->
dump_ex˛
) !=

1009 (
mvm
->
fw
->
dump_ex˛_wowœn
));

1011 
i
 = 0; i < 
	`ARRAY_SIZE
(
mvm
->
fw
->
dump_ex˛
); i++) {

1012 
u32
 
°¨t
, 
íd
;

1014 i‡(!
ex˛
[
i
].
addr
 || !ex˛[i].
size
)

1017 
°¨t
 = 
ex˛
[
i
].
addr
;

1018 
íd
 = 
°¨t
 + 
ex˛
[
i
].
size
;

1020 i‡(
íd
 <
mem_addr
 || 
°¨t
 >mem_add∏+ 
buÊí
)

1023 i‡(
°¨t
 < 
mem_addr
)

1024 
°¨t
 = 
mem_addr
;

1026 i‡(
íd
 > 
mem_addr
 + 
buÊí
)

1027 
íd
 = 
mem_addr
 + 
buÊí
;

1029 
	`mem£t
((
u8
 *)
mem
 + 
°¨t
 - 
mem_addr
, 0xAA, 
íd
 - start);

1031 
	}
}

1033 c⁄° 
iwl_dump_ßnôize_›s
 
	giwl_mvm_ßnôize_›s
 = {

1034 .
‰ob_txf
 = 
iwl_mvm_‰ob_txf
,

1035 .
	g‰ob_hcmd
 = 
iwl_mvm_‰ob_hcmd
,

1036 .
	g‰ob_mem
 = 
iwl_mvm_‰ob_mem
,

1039 
	$iwl_mvm_me_c⁄n_°©us
(*
¥iv
, c⁄° 
iwl_mei_c⁄n_öfo
 *
c⁄n_öfo
)

1041 
iwl_mvm
 *
mvm
 = 
¥iv
;

1042 
iwl_mvm_csme_c⁄n_öfo
 *
¥ev_c⁄n_öfo
, *
cuº_c⁄n_öfo
;

1048 
¥ev_c⁄n_öfo
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm
->
csme_c⁄n_öfo
, 
åue
);

1050 
cuº_c⁄n_öfo
 = 
	`kzÆloc
((*cuº_c⁄n_öfo), 
GFP_KERNEL
);

1051 i‡(!
cuº_c⁄n_öfo
)

1054 
cuº_c⁄n_öfo
->
c⁄n_öfo
 = *conn_info;

1056 
	`rcu_assign_poöãr
(
mvm
->
csme_c⁄n_öfo
, 
cuº_c⁄n_öfo
);

1058 i‡(
¥ev_c⁄n_öfo
)

1059 
	`k‰ì_rcu
(
¥ev_c⁄n_öfo
, 
rcu_hód
);

1060 
	}
}

1062 
	$iwl_mvm_mei_rfkûl
(*
¥iv
, 
boﬁ
 
blocked
,

1063 
boﬁ
 
csme_èkög_ow√rshù
)

1065 
iwl_mvm
 *
mvm
 = 
¥iv
;

1067 i‡(
blocked
 && !
csme_èkög_ow√rshù
)

1070 
mvm
->
mei_rfkûl_blocked
 = 
blocked
;

1071 i‡(!
mvm
->
hw_ªgi°îed
)

1074 
	`wùhy_rfkûl_£t_hw_°©e_ªas⁄
(
mvm
->
hw
->
wùhy
,

1075 
mvm
->
mei_rfkûl_blocked
,

1076 
RFKILL_HARD_BLOCK_NOT_OWNER
);

1077 
	}
}

1079 
	$iwl_mvm_mei_rﬂmög_f‹biddí
(*
¥iv
, 
boﬁ
 
f‹biddí
)

1081 
iwl_mvm
 *
mvm
 = 
¥iv
;

1083 i‡(!
mvm
->
hw_ªgi°îed
 || !mvm->
csme_vif
)

1086 
	`iwl_mvm_£nd_rﬂmög_f‹biddí_evít
(
mvm
, mvm->
csme_vif
, 
f‹biddí
);

1087 
	}
}

1089 
	$iwl_mvm_ßp_c⁄√˘ed_wk
(
w‹k_°ru˘
 *
wk
)

1091 
iwl_mvm
 *
mvm
 =

1092 
	`c⁄èöî_of
(
wk
, 
iwl_mvm
, 
ßp_c⁄√˘ed_wk
);

1093 
ªt
;

1095 
ªt
 = 
	`iwl_mvm_°¨t_gë_nvm
(
mvm
);

1096 i‡(
ªt
)

1097 
out_‰ì
;

1099 
ªt
 = 
	`iwl_mvm_°¨t_po°_nvm
(
mvm
);

1100 i‡(
ªt
)

1101 
out_‰ì
;

1105 
out_‰ì
:

1106 
	`IWL_ERR
(
mvm
, "Couldn't get started...\n");

1107 
	`iwl_mei_°¨t_uƒegi°î
();

1108 
	`iwl_mei_uƒegi°î_com∂ëe
();

1109 
	`iwl_fw_Êush_dumps
(&
mvm
->
fwπ
);

1110 
	`iwl_mvm_thîmÆ_exô
(
mvm
);

1111 
	`iwl_fw_ru¡ime_‰ì
(&
mvm
->
fwπ
);

1112 
	`iwl_phy_db_‰ì
(
mvm
->
phy_db
);

1113 
	`k‰ì
(
mvm
->
sˇn_cmd
);

1114 
	`iwl_å™s_›_mode_Àave
(
mvm
->
å™s
);

1115 
	`k‰ì
(
mvm
->
nvm_d©a
);

1116 
	`k‰ì
(
mvm
->
mei_nvm_d©a
);

1118 
	`õì80211_‰ì_hw
(
mvm
->
hw
);

1119 
	}
}

1121 
	$iwl_mvm_mei_ßp_c⁄√˘ed
(*
¥iv
)

1123 
iwl_mvm
 *
mvm
 = 
¥iv
;

1125 i‡(!
mvm
->
hw_ªgi°îed
)

1126 
	`scheduÀ_w‹k
(&
mvm
->
ßp_c⁄√˘ed_wk
);

1127 
	}
}

1129 
	$iwl_mvm_mei_nic_°ﬁí
(*
¥iv
)

1131 
iwl_mvm
 *
mvm
 = 
¥iv
;

1133 
	`π∆_lock
();

1134 
	`cfg80211_shutdown_Æl_öãrÁ˚s
(
mvm
->
hw
->
wùhy
);

1135 
	`π∆_u∆ock
();

1136 
	}
}

1138 c⁄° 
iwl_mei_›s
 
	gmei_›s
 = {

1139 .
me_c⁄n_°©us
 = 
iwl_mvm_me_c⁄n_°©us
,

1140 .
	grfkûl
 = 
iwl_mvm_mei_rfkûl
,

1141 .
	grﬂmög_f‹biddí
 = 
iwl_mvm_mei_rﬂmög_f‹biddí
,

1142 .
	gßp_c⁄√˘ed
 = 
iwl_mvm_mei_ßp_c⁄√˘ed
,

1143 .
	gnic_°ﬁí
 = 
iwl_mvm_mei_nic_°ﬁí
,

1146 
iwl_›_mode
 *

1147 
	$iwl_›_mode_mvm_°¨t
(
iwl_å™s
 *
å™s
, c⁄° 
iwl_cfg
 *
cfg
,

1148 c⁄° 
iwl_fw
 *
fw
, 
díåy
 *
dbgfs_dú
)

1150 
õì80211_hw
 *
hw
;

1151 
iwl_›_mode
 *
›_mode
;

1152 
iwl_mvm
 *
mvm
;

1153 
iwl_å™s_c⁄fig
 
å™s_cfg
 = {};

1154 c⁄° 
u8
 
no_ª˛aim_cmds
[] = {

1155 
TX_CMD
,

1157 
u32
 
max_agg
;

1158 
size_t
 
sˇn_size
;

1159 
u32
 
mö_backoff
;

1160 
iwl_mvm_csme_c⁄n_öfo
 *
csme_c⁄n_öfo
 
__maybe_unu£d
;

1167 
	`BUILD_BUG_ON
(
	`ARRAY_SIZE
(
mvm
->
fw_id_to_mac_id
) !=

1168 
IWL_MVM_STATION_COUNT_MAX
);

1173 
hw
 = 
	`õì80211_Æloc_hw
((
iwl_›_mode
) +

1174 (
iwl_mvm
),

1175 
	`iwl_mvm_has_mld_≠i
(
fw
Ë? &
iwl_mvm_mld_hw_›s
 :

1176 &
iwl_mvm_hw_›s
);

1177 i‡(!
hw
)

1178  
NULL
;

1180 i‡(
å™s
->
å™s_cfg
->
devi˚_Ámûy
 >
IWL_DEVICE_FAMILY_BZ
)

1181 
max_agg
 = 512;

1183 
max_agg
 = 
IEEE80211_MAX_AMPDU_BUF_HE
;

1185 
hw
->
max_rx_aggªg©i⁄_sub‰ames
 = 
max_agg
;

1187 i‡(
cfg
->
max_tx_agg_size
)

1188 
hw
->
max_tx_aggªg©i⁄_sub‰ames
 = 
cfg
->
max_tx_agg_size
;

1190 
hw
->
max_tx_aggªg©i⁄_sub‰ames
 = 
max_agg
;

1192 
›_mode
 = 
hw
->
¥iv
;

1194 
mvm
 = 
	`IWL_OP_MODE_GET_MVM
(
›_mode
);

1195 
mvm
->
dev
 = 
å™s
->dev;

1196 
mvm
->
å™s
 =Årans;

1197 
mvm
->
cfg
 = cfg;

1198 
mvm
->
fw
 = fw;

1199 
mvm
->
hw
 = hw;

1201 
	`iwl_fw_ru¡ime_öô
(&
mvm
->
fwπ
, 
å™s
, 
fw
, &
iwl_mvm_fwπ_›s
, mvm,

1202 &
iwl_mvm_ßnôize_›s
, 
mvm
, 
dbgfs_dú
);

1204 
	`iwl_mvm_gë_bios_èbÀs
(
mvm
);

1205 
	`iwl_uefi_gë_sgom_èbÀ
(
å™s
, &
mvm
->
fwπ
);

1206 
	`iwl_uefi_gë_°ï_èbÀ
(
å™s
);

1208 
mvm
->
öô_°©us
 = 0;

1210 i‡(
	`iwl_mvm_has_√w_rx_≠i
(
mvm
)) {

1211 
›_mode
->
›s
 = &
iwl_mvm_›s_mq
;

1212 
å™s
->
rx_mpdu_cmd_hdr_size
 =

1213 (
å™s
->
å™s_cfg
->
devi˚_Ámûy
 >=

1214 
IWL_DEVICE_FAMILY_AX210
) ?

1215 (
iwl_rx_mpdu_desc
) :

1216 
IWL_RX_DESC_SIZE_V1
;

1218 
›_mode
->
›s
 = &
iwl_mvm_›s
;

1219 
å™s
->
rx_mpdu_cmd_hdr_size
 =

1220 (
iwl_rx_mpdu_ªs_°¨t
);

1222 i‡(
	`WARN_ON
(
å™s
->
num_rx_queues
 > 1))

1223 
out_‰ì
;

1226 
mvm
->
fw_ª°¨t
 = 
iwlwifi_mod_∑øms
.fw_restart ? -1 : 0;

1228 i‡(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)) {

1238 
mvm
->
aux_queue
 = 
IWL_MVM_INVALID_QUEUE
;

1239 
mvm
->
¢if_queue
 = 
IWL_MVM_INVALID_QUEUE
;

1240 
mvm
->
¥obe_queue
 = 
IWL_MVM_INVALID_QUEUE
;

1241 
mvm
->
p2p_dev_queue
 = 
IWL_MVM_INVALID_QUEUE
;

1243 
mvm
->
aux_queue
 = 
IWL_MVM_DQA_AUX_QUEUE
;

1244 
mvm
->
¢if_queue
 = 
IWL_MVM_DQA_INJECT_MONITOR_QUEUE
;

1245 
mvm
->
¥obe_queue
 = 
IWL_MVM_DQA_AP_PROBE_RESP_QUEUE
;

1246 
mvm
->
p2p_dev_queue
 = 
IWL_MVM_DQA_P2P_DEVICE_QUEUE
;

1249 
mvm
->
sf_°©e
 = 
SF_UNINIT
;

1250 i‡(
	`iwl_mvm_has_unifõd_ucode
(
mvm
))

1251 
	`iwl_fw_£t_cuºít_image
(&
mvm
->
fwπ
, 
IWL_UCODE_REGULAR
);

1253 
	`iwl_fw_£t_cuºít_image
(&
mvm
->
fwπ
, 
IWL_UCODE_INIT
);

1254 
mvm
->
dr›_b˙_≠_mode
 = 
åue
;

1256 
	`muãx_öô
(&
mvm
->
muãx
);

1257 
	`•ö_lock_öô
(&
mvm
->
async_h™dÀrs_lock
);

1258 
	`INIT_LIST_HEAD
(&
mvm
->
time_evít_li°
);

1259 
	`INIT_LIST_HEAD
(&
mvm
->
aux_roc_ã_li°
);

1260 
	`INIT_LIST_HEAD
(&
mvm
->
async_h™dÀrs_li°
);

1261 
	`•ö_lock_öô
(&
mvm
->
time_evít_lock
);

1262 
	`INIT_LIST_HEAD
(&
mvm
->
·m_öôüt‹
.
loc_li°
);

1263 
	`INIT_LIST_HEAD
(&
mvm
->
·m_öôüt‹
.
∑¢_li°
);

1264 
	`INIT_LIST_HEAD
(&
mvm
->
ª•_∑¢_li°
);

1266 
	`INIT_WORK
(&
mvm
->
async_h™dÀrs_wk
, 
iwl_mvm_async_h™dÀrs_wk
);

1267 
	`INIT_WORK
(&
mvm
->
roc_d⁄e_wk
, 
iwl_mvm_roc_d⁄e_wk
);

1268 
	`INIT_WORK
(&
mvm
->
ßp_c⁄√˘ed_wk
, 
iwl_mvm_ßp_c⁄√˘ed_wk
);

1269 
	`INIT_DELAYED_WORK
(&
mvm
->
tdls_cs
.
dw‹k
, 
iwl_mvm_tdls_ch_swôch_w‹k
);

1270 
	`INIT_DELAYED_WORK
(&
mvm
->
sˇn_timeout_dw‹k
, 
iwl_mvm_sˇn_timeout_wk
);

1271 
	`INIT_WORK
(&
mvm
->
add_°ªam_wk
, 
iwl_mvm_add_√w_dqa_°ªam_wk
);

1272 
	`INIT_LIST_HEAD
(&
mvm
->
add_°ªam_txqs
);

1273 
	`•ö_lock_öô
(&
mvm
->
add_°ªam_lock
);

1275 
	`wùhy_w‹k_öô
(&
mvm
->
async_h™dÀrs_wùhy_wk
,

1276 
iwl_mvm_async_h™dÀrs_wùhy_wk
);

1277 
	`öô_waôqueue_hód
(&
mvm
->
rx_sync_waôq
);

1279 
mvm
->
queue_sync_°©e
 = 0;

1281 
	`SET_IEEE80211_DEV
(
mvm
->
hw
, mvm->
å™s
->
dev
);

1283 
	`•ö_lock_öô
(&
mvm
->
tcm
.
lock
);

1284 
	`INIT_DELAYED_WORK
(&
mvm
->
tcm
.
w‹k
, 
iwl_mvm_tcm_w‹k
);

1285 
mvm
->
tcm
.
ts
 = 
jiffõs
;

1286 
mvm
->
tcm
.
Œ_ts
 = 
jiffõs
;

1287 
mvm
->
tcm
.
u≠sd_n⁄agg_ts
 = 
jiffõs
;

1289 
	`INIT_DELAYED_WORK
(&
mvm
->
cs_tx_unblock_dw‹k
, 
iwl_mvm_tx_unblock_dw‹k
);

1291 
mvm
->
cmd_vî
.
ønge_ª•
 =

1292 
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
LOCATION_GROUP
,

1293 
TOF_RANGE_RESPONSE_NOTIF
, 5);

1295 i‡(
	`WARN_ON_ONCE
(
mvm
->
cmd_vî
.
ønge_ª•
 > 9))

1296 
out_‰ì
;

1302 
å™s_cfg
.
›_mode
 = op_mode;

1303 
å™s_cfg
.
no_ª˛aim_cmds
 =Ço_reclaim_cmds;

1304 
å™s_cfg
.
n_no_ª˛aim_cmds
 = 
	`ARRAY_SIZE
(
no_ª˛aim_cmds
);

1306 
iwlwifi_mod_∑øms
.
amsdu_size
) {

1307 
IWL_AMSDU_DEF
:

1308 
å™s_cfg
.
rx_buf_size
 = 
IWL_AMSDU_4K
;

1310 
IWL_AMSDU_4K
:

1311 
å™s_cfg
.
rx_buf_size
 = 
IWL_AMSDU_4K
;

1313 
IWL_AMSDU_8K
:

1314 
å™s_cfg
.
rx_buf_size
 = 
IWL_AMSDU_8K
;

1316 
IWL_AMSDU_12K
:

1317 
å™s_cfg
.
rx_buf_size
 = 
IWL_AMSDU_12K
;

1320 
	`¥_îr
("%s: Unsuµ‹ãdámsdu_size: %d\n", 
KBUILD_MODNAME
,

1321 
iwlwifi_mod_∑øms
.
amsdu_size
);

1322 
å™s_cfg
.
rx_buf_size
 = 
IWL_AMSDU_4K
;

1325 
å™s
->
wide_cmd_hódî
 = 
åue
;

1326 
å™s_cfg
.
bc_èbÀ_dw‹d
 =

1327 
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 < 
IWL_DEVICE_FAMILY_AX210
;

1329 
å™s_cfg
.
comm™d_groups
 = 
iwl_mvm_groups
;

1330 
å™s_cfg
.
comm™d_groups_size
 = 
	`ARRAY_SIZE
(
iwl_mvm_groups
);

1332 
å™s_cfg
.
cmd_queue
 = 
IWL_MVM_DQA_CMD_QUEUE
;

1333 
å™s_cfg
.
cmd_fifo
 = 
IWL_MVM_TX_FIFO_CMD
;

1334 
å™s_cfg
.
scd_£t_a˘ive
 = 
åue
;

1336 
å™s_cfg
.
cb_d©a_offs
 = 
	`off£tof
(
õì80211_tx_öfo
,

1337 
drivî_d©a
[2]);

1340 
å™s_cfg
.
cmd_q_wdg_timeout
 =

1341 
	`iwl_mvm_gë_wd_timeout
(
mvm
, 
NULL
, 
Ál£
, 
åue
);

1343 
	`¢¥ötf
(
mvm
->
hw
->
wùhy
->
fw_vîsi⁄
,

1344 (
mvm
->
hw
->
wùhy
->
fw_vîsi⁄
),

1345 "%.31s", 
fw
->
fw_vîsi⁄
);

1347 
å™s_cfg
.
fw_ª£t_h™dshake
 = 
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

1348 
IWL_UCODE_TLV_CAPA_FW_RESET_HANDSHAKE
);

1350 
å™s_cfg
.
queue_Æloc_cmd_vî
 =

1351 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
,

1352 
	`WIDE_ID
(
DATA_PATH_GROUP
,

1353 
SCD_QUEUE_CONFIG_CMD
),

1355 
mvm
->
°a_ªmove_ªquúes_queue_ªmove
 =

1356 
å™s_cfg
.
queue_Æloc_cmd_vî
 > 0;

1358 
mvm
->
mld_≠i_is_u£d
 = 
	`iwl_mvm_has_mld_≠i
(mvm->
fw
);

1361 
	`iwl_å™s_c⁄figuª
(
mvm
->
å™s
, &
å™s_cfg
);

1363 
å™s
->
rx_mpdu_cmd
 = 
REPLY_RX_MPDU_CMD
;

1364 
å™s
->
dbg
.
de°_év
 = 
mvm
->
fw
->dbg.dest_tlv;

1365 
å™s
->
dbg
.
n_de°_ªg
 = 
mvm
->
fw
->dbg.n_dest_reg;

1366 
	`mem˝y
(
å™s
->
dbg
.
c⁄f_év
, 
mvm
->
fw
->dbg.conf_tlv,

1367 (
å™s
->
dbg
.
c⁄f_év
));

1368 
å™s
->
dbg
.
åiggî_év
 = 
mvm
->
fw
->dbg.trigger_tlv;

1370 
å™s
->
iml
 = 
mvm
->
fw
->iml;

1371 
å™s
->
iml_Àn
 = 
mvm
->
fw
->iml_len;

1374 
	`iwl_nŸifiˇti⁄_waô_öô
(&
mvm
->
nŸif_waô
);

1377 
mvm
->
phy_db
 = 
	`iwl_phy_db_öô
(
å™s
);

1378 i‡(!
mvm
->
phy_db
) {

1379 
	`IWL_ERR
(
mvm
, "Cannot initÖhy_db\n");

1380 
out_‰ì
;

1383 
	`IWL_INFO
(
mvm
, "Detected %s, REV=0x%X\n",

1384 
mvm
->
å™s
->
«me
, mvm->å™s->
hw_ªv
);

1386 i‡(
iwlwifi_mod_∑øms
.
nvm_fûe
)

1387 
mvm
->
nvm_fûe_«me
 = 
iwlwifi_mod_∑øms
.
nvm_fûe
;

1389 
	`IWL_DEBUG_EEPROM
(
mvm
->
å™s
->
dev
,

1392 
sˇn_size
 = 
	`iwl_mvm_sˇn_size
(
mvm
);

1394 
mvm
->
sˇn_cmd
 = 
	`kmÆloc
(
sˇn_size
, 
GFP_KERNEL
);

1395 i‡(!
mvm
->
sˇn_cmd
)

1396 
out_‰ì
;

1397 
mvm
->
sˇn_cmd_size
 = 
sˇn_size
;

1400 
mvm
->
aux_°a
.
°a_id
 = 
IWL_MVM_INVALID_STA
;

1401 
mvm
->
¢if_°a
.
°a_id
 = 
IWL_MVM_INVALID_STA
;

1404 
mvm
->
œ°_ebs_suc˚ssful
 = 
åue
;

1406 
mö_backoff
 = 
	`iwl_mvm_mö_backoff
(
mvm
);

1407 
	`iwl_mvm_thîmÆ_öôülize
(
mvm
, 
mö_backoff
);

1409 i‡(!
	`iwl_mvm_has_√w_rx_°©s_≠i
(
mvm
))

1410 
	`mem£t
(&
mvm
->
rx_°©s_v3
, 0,

1411 (
mvm_°©i°ics_rx_v3
));

1413 
	`mem£t
(&
mvm
->
rx_°©s
, 0, (
mvm_°©i°ics_rx
));

1415 
	`iwl_mvm_·m_öôüt‹_smoŸh_c⁄fig
(
mvm
);

1417 
	`iwl_mvm_öô_time_sync
(&
mvm
->
time_sync
);

1419 
mvm
->
debugfs_dú
 = 
dbgfs_dú
;

1421 
mvm
->
mei_ªgi°îed
 = !
	`iwl_mei_ªgi°î
(mvm, &
mei_›s
);

1423 
	`iwl_mvm_mei_sˇn_fûãr_öô
(&
mvm
->
mei_sˇn_fûãr
);

1425 i‡(
	`iwl_mvm_°¨t_gë_nvm
(
mvm
)) {

1431 i‡(
å™s
->
csme_own
 && 
mvm
->
mei_ªgi°îed
)

1432  
›_mode
;

1434 
out_thîmÆ_exô
;

1438 i‡(
	`iwl_mvm_°¨t_po°_nvm
(
mvm
))

1439 
out_thîmÆ_exô
;

1441  
›_mode
;

1443 
out_thîmÆ_exô
:

1444 
	`iwl_mvm_thîmÆ_exô
(
mvm
);

1445 i‡(
mvm
->
mei_ªgi°îed
) {

1446 
	`iwl_mei_°¨t_uƒegi°î
();

1447 
	`iwl_mei_uƒegi°î_com∂ëe
();

1449 
out_‰ì
:

1450 
	`iwl_fw_Êush_dumps
(&
mvm
->
fwπ
);

1451 
	`iwl_fw_ru¡ime_‰ì
(&
mvm
->
fwπ
);

1453 i‡(
iwlmvm_mod_∑øms
.
öô_dbg
)

1454  
›_mode
;

1455 
	`iwl_phy_db_‰ì
(
mvm
->
phy_db
);

1456 
	`k‰ì
(
mvm
->
sˇn_cmd
);

1457 
	`iwl_å™s_›_mode_Àave
(
å™s
);

1459 
	`õì80211_‰ì_hw
(
mvm
->
hw
);

1460  
NULL
;

1461 
	}
}

1463 
	$iwl_mvm_°›_devi˚
(
iwl_mvm
 *
mvm
)

1465 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1467 
	`iwl_fw_ˇn˚l_time°amp
(&
mvm
->
fwπ
);

1469 
	`˛ór_bô
(
IWL_MVM_STATUS_FIRMWARE_RUNNING
, &
mvm
->
°©us
);

1471 
	`iwl_fw_dbg_°›_sync
(&
mvm
->
fwπ
);

1472 
	`iwl_å™s_°›_devi˚
(
mvm
->
å™s
);

1473 
	`iwl_‰ì_fw_∑gög
(&
mvm
->
fwπ
);

1474 
	`iwl_fw_dump_c⁄f_˛ór
(&
mvm
->
fwπ
);

1475 
	`iwl_mvm_mei_devi˚_°©e
(
mvm
, 
Ál£
);

1476 
	}
}

1478 
	$iwl_›_mode_mvm_°›
(
iwl_›_mode
 *
›_mode
)

1480 
iwl_mvm
 *
mvm
 = 
	`IWL_OP_MODE_GET_MVM
(
›_mode
);

1481 
i
;

1483 i‡(
mvm
->
mei_ªgi°îed
) {

1484 
	`π∆_lock
();

1485 
	`iwl_mei_£t_√tdev
(
NULL
);

1486 
	`π∆_u∆ock
();

1487 
	`iwl_mei_°¨t_uƒegi°î
();

1494 
	`ˇn˚l_w‹k_sync
(&
mvm
->
ßp_c⁄√˘ed_wk
);

1496 
	`iwl_mvm_Àds_exô
(
mvm
);

1498 
	`iwl_mvm_thîmÆ_exô
(
mvm
);

1508 i‡(
mvm
->
hw_ªgi°îed
)

1509 
	`õì80211_uƒegi°î_hw
(
mvm
->
hw
);

1511 
	`k‰ì
(
mvm
->
sˇn_cmd
);

1512 
	`k‰ì
(
mvm
->
mˇ°_fûãr_cmd
);

1513 
mvm
->
mˇ°_fûãr_cmd
 = 
NULL
;

1515 
	`k‰ì
(
mvm
->
îr‹_ªcovîy_buf
);

1516 
mvm
->
îr‹_ªcovîy_buf
 = 
NULL
;

1518 
	`iwl_mvm_±p_ªmove
(
mvm
);

1520 
	`iwl_å™s_›_mode_Àave
(
mvm
->
å™s
);

1522 
	`iwl_phy_db_‰ì
(
mvm
->
phy_db
);

1523 
mvm
->
phy_db
 = 
NULL
;

1525 
	`k‰ì
(
mvm
->
nvm_d©a
);

1526 
	`k‰ì
(
mvm
->
mei_nvm_d©a
);

1527 
	`k‰ì
(
	`rcu_ac˚ss_poöãr
(
mvm
->
csme_c⁄n_öfo
));

1528 
	`k‰ì
(
mvm
->
ãmp_nvm_d©a
);

1529 
i
 = 0; i < 
NVM_MAX_NUM_SECTIONS
; i++)

1530 
	`k‰ì
(
mvm
->
nvm_£˘i⁄s
[
i
].
d©a
);

1532 
	`ˇn˚l_dñayed_w‹k_sync
(&
mvm
->
tcm
.
w‹k
);

1534 
	`iwl_fw_ru¡ime_‰ì
(&
mvm
->
fwπ
);

1535 
	`muãx_de°roy
(&
mvm
->
muãx
);

1537 i‡(
mvm
->
mei_ªgi°îed
)

1538 
	`iwl_mei_uƒegi°î_com∂ëe
();

1540 
	`õì80211_‰ì_hw
(
mvm
->
hw
);

1541 
	}
}

1543 
	siwl_async_h™dÀr_íåy
 {

1544 
li°_hód
 
	mli°
;

1545 
iwl_rx_cmd_buf„r
 
	mrxb
;

1546 
iwl_rx_h™dÀr_c⁄ãxt
 
	mc⁄ãxt
;

1547 (*
	m‚
)(
iwl_mvm
 *
	mmvm
, 
iwl_rx_cmd_buf„r
 *
	mrxb
);

1550 
	$iwl_mvm_async_h™dÀrs_purge
(
iwl_mvm
 *
mvm
)

1552 
iwl_async_h™dÀr_íåy
 *
íåy
, *
tmp
;

1554 
	`•ö_lock_bh
(&
mvm
->
async_h™dÀrs_lock
);

1555 
	`li°_f‹_óch_íåy_ß„
(
íåy
, 
tmp
, &
mvm
->
async_h™dÀrs_li°
, 
li°
) {

1556 
	`iwl_‰ì_rxb
(&
íåy
->
rxb
);

1557 
	`li°_dñ
(&
íåy
->
li°
);

1558 
	`k‰ì
(
íåy
);

1560 
	`•ö_u∆ock_bh
(&
mvm
->
async_h™dÀrs_lock
);

1561 
	}
}

1567 
	$iwl_mvm_async_h™dÀrs_by_c⁄ãxt
(
iwl_mvm
 *
mvm
,

1568 
u8
 
c⁄ãxts
)

1570 
iwl_async_h™dÀr_íåy
 *
íåy
, *
tmp
;

1571 
	`LIST_HEAD
(
loˇl_li°
);

1578 
	`•ö_lock_bh
(&
mvm
->
async_h™dÀrs_lock
);

1579 
	`li°_f‹_óch_íåy_ß„
(
íåy
, 
tmp
, &
mvm
->
async_h™dÀrs_li°
, 
li°
) {

1580 i‡(!(
	`BIT
(
íåy
->
c⁄ãxt
Ë& 
c⁄ãxts
))

1582 
	`li°_dñ
(&
íåy
->
li°
);

1583 
	`li°_add_èû
(&
íåy
->
li°
, &
loˇl_li°
);

1585 
	`•ö_u∆ock_bh
(&
mvm
->
async_h™dÀrs_lock
);

1587 
	`li°_f‹_óch_íåy_ß„
(
íåy
, 
tmp
, &
loˇl_li°
, 
li°
) {

1588 i‡(
íåy
->
c⁄ãxt
 !
RX_HANDLER_ASYNC_UNLOCKED
)

1589 
	`muãx_lock
(&
mvm
->
muãx
);

1590 
íåy
->
	`‚
(
mvm
, &íåy->
rxb
);

1591 
	`iwl_‰ì_rxb
(&
íåy
->
rxb
);

1592 
	`li°_dñ
(&
íåy
->
li°
);

1593 i‡(
íåy
->
c⁄ãxt
 !
RX_HANDLER_ASYNC_UNLOCKED
)

1594 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1595 
	`k‰ì
(
íåy
);

1597 
	}
}

1599 
	$iwl_mvm_async_h™dÀrs_wùhy_wk
(
wùhy
 *wiphy,

1600 
wùhy_w‹k
 *
wk
)

1602 
iwl_mvm
 *
mvm
 =

1603 
	`c⁄èöî_of
(
wk
, 
iwl_mvm
, 
async_h™dÀrs_wùhy_wk
);

1604 
u8
 
c⁄ãxts
 = 
	`BIT
(
RX_HANDLER_ASYNC_LOCKED_WIPHY
);

1606 
	`iwl_mvm_async_h™dÀrs_by_c⁄ãxt
(
mvm
, 
c⁄ãxts
);

1607 
	}
}

1609 
	$iwl_mvm_async_h™dÀrs_wk
(
w‹k_°ru˘
 *
wk
)

1611 
iwl_mvm
 *
mvm
 =

1612 
	`c⁄èöî_of
(
wk
, 
iwl_mvm
, 
async_h™dÀrs_wk
);

1613 
u8
 
c⁄ãxts
 = 
	`BIT
(
RX_HANDLER_ASYNC_LOCKED
) |

1614 
	`BIT
(
RX_HANDLER_ASYNC_UNLOCKED
);

1616 
	`iwl_mvm_async_h™dÀrs_by_c⁄ãxt
(
mvm
, 
c⁄ãxts
);

1617 
	}
}

1619 
ölöe
 
	$iwl_mvm_rx_check_åiggî
(
iwl_mvm
 *
mvm
,

1620 
iwl_rx_∑ckë
 *
pkt
)

1622 
iwl_fw_dbg_åiggî_év
 *
åig
;

1623 
iwl_fw_dbg_åiggî_cmd
 *
cmds_åig
;

1624 
i
;

1626 
åig
 = 
	`iwl_fw_dbg_åiggî_⁄
(&
mvm
->
fwπ
, 
NULL
,

1627 
FW_DBG_TRIGGER_FW_NOTIF
);

1628 i‡(!
åig
)

1631 
cmds_åig
 = (*)
åig
->
d©a
;

1633 
i
 = 0; i < 
	`ARRAY_SIZE
(
cmds_åig
->
cmds
); i++) {

1635 i‡(!
cmds_åig
->
cmds
[
i
].
cmd_id
)

1638 i‡(
cmds_åig
->
cmds
[
i
].
cmd_id
 !
pkt
->
hdr
.
cmd
 ||

1639 
cmds_åig
->
cmds
[
i
].
group_id
 !
pkt
->
hdr
.group_id)

1642 
	`iwl_fw_dbg_cﬁÀ˘_åig
(&
mvm
->
fwπ
, 
åig
,

1644 
pkt
->
hdr
.
group_id
,Ökt->hdr.
cmd
);

1647 
	}
}

1649 
	$iwl_mvm_rx_comm⁄
(
iwl_mvm
 *
mvm
,

1650 
iwl_rx_cmd_buf„r
 *
rxb
,

1651 
iwl_rx_∑ckë
 *
pkt
)

1653 
pkt_Àn
 = 
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
);

1654 
i
;

1655 
iwl_dbg_év_ç_d©a
 
ç_d©a
 = { .
fw_pkt
 = 
pkt
 };

1657 
	`iwl_dbg_év_time_poöt
(&
mvm
->
fwπ
,

1658 
IWL_FW_INI_TIME_POINT_FW_RSP_OR_NOTIF
, &
ç_d©a
);

1659 
	`iwl_mvm_rx_check_åiggî
(
mvm
, 
pkt
);

1666 
	`iwl_nŸifiˇti⁄_waô_nŸify
(&
mvm
->
nŸif_waô
, 
pkt
);

1668 
i
 = 0; i < 
	`ARRAY_SIZE
(
iwl_mvm_rx_h™dÀrs
); i++) {

1669 c⁄° 
iwl_rx_h™dÀrs
 *
rx_h
 = &
iwl_mvm_rx_h™dÀrs
[
i
];

1670 
iwl_async_h™dÀr_íåy
 *
íåy
;

1672 i‡(
rx_h
->
cmd_id
 !
	`WIDE_ID
(
pkt
->
hdr
.
group_id
,Ökt->hdr.
cmd
))

1675 i‡(
	`IWL_FW_CHECK
(
mvm
, 
pkt_Àn
 < 
rx_h
->
mö_size
,

1677 
rx_h
->
cmd_id
, 
pkt_Àn
,Ñx_h->
mö_size
))

1680 i‡(
rx_h
->
c⁄ãxt
 =
RX_HANDLER_SYNC
) {

1681 
rx_h
->
	`‚
(
mvm
, 
rxb
);

1685 
íåy
 = 
	`kzÆloc
((*íåy), 
GFP_ATOMIC
);

1687 i‡(!
íåy
)

1690 
íåy
->
rxb
.
_∑ge
 = 
	`rxb_°ól_∑ge
(rxb);

1691 
íåy
->
rxb
.
_off£t
 =Ñxb->_offset;

1692 
íåy
->
rxb
.
_rx_∑ge_‹dî
 =Ñxb->_rx_page_order;

1693 
íåy
->
‚
 = 
rx_h
->fn;

1694 
íåy
->
c⁄ãxt
 = 
rx_h
->context;

1695 
	`•ö_lock
(&
mvm
->
async_h™dÀrs_lock
);

1696 
	`li°_add_èû
(&
íåy
->
li°
, &
mvm
->
async_h™dÀrs_li°
);

1697 
	`•ö_u∆ock
(&
mvm
->
async_h™dÀrs_lock
);

1698 i‡(
rx_h
->
c⁄ãxt
 =
RX_HANDLER_ASYNC_LOCKED_WIPHY
)

1699 
	`wùhy_w‹k_queue
(
mvm
->
hw
->
wùhy
,

1700 &
mvm
->
async_h™dÀrs_wùhy_wk
);

1702 
	`scheduÀ_w‹k
(&
mvm
->
async_h™dÀrs_wk
);

1705 
	}
}

1707 
	$iwl_mvm_rx
(
iwl_›_mode
 *
›_mode
,

1708 
«pi_°ru˘
 *
«pi
,

1709 
iwl_rx_cmd_buf„r
 *
rxb
)

1711 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

1712 
iwl_mvm
 *
mvm
 = 
	`IWL_OP_MODE_GET_MVM
(
›_mode
);

1713 
u16
 
cmd
 = 
	`WIDE_ID
(
pkt
->
hdr
.
group_id
,Ökt->hdr.cmd);

1715 i‡(
	`likñy
(
cmd
 =
	`WIDE_ID
(
LEGACY_GROUP
, 
REPLY_RX_MPDU_CMD
)))

1716 
	`iwl_mvm_rx_rx_mpdu
(
mvm
, 
«pi
, 
rxb
);

1717 i‡(
cmd
 =
	`WIDE_ID
(
LEGACY_GROUP
, 
REPLY_RX_PHY_CMD
))

1718 
	`iwl_mvm_rx_rx_phy_cmd
(
mvm
, 
rxb
);

1720 
	`iwl_mvm_rx_comm⁄
(
mvm
, 
rxb
, 
pkt
);

1721 
	}
}

1723 
	$iwl_mvm_rx_mq
(
iwl_›_mode
 *
›_mode
,

1724 
«pi_°ru˘
 *
«pi
,

1725 
iwl_rx_cmd_buf„r
 *
rxb
)

1727 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

1728 
iwl_mvm
 *
mvm
 = 
	`IWL_OP_MODE_GET_MVM
(
›_mode
);

1729 
u16
 
cmd
 = 
	`WIDE_ID
(
pkt
->
hdr
.
group_id
,Ökt->hdr.cmd);

1731 i‡(
	`likñy
(
cmd
 =
	`WIDE_ID
(
LEGACY_GROUP
, 
REPLY_RX_MPDU_CMD
)))

1732 
	`iwl_mvm_rx_mpdu_mq
(
mvm
, 
«pi
, 
rxb
, 0);

1733 i‡(
	`u∆ikñy
(
cmd
 =
	`WIDE_ID
(
DATA_PATH_GROUP
,

1734 
RX_QUEUES_NOTIFICATION
)))

1735 
	`iwl_mvm_rx_queue_nŸif
(
mvm
, 
«pi
, 
rxb
, 0);

1736 i‡(
cmd
 =
	`WIDE_ID
(
LEGACY_GROUP
, 
FRAME_RELEASE
))

1737 
	`iwl_mvm_rx_‰ame_ªÀa£
(
mvm
, 
«pi
, 
rxb
, 0);

1738 i‡(
cmd
 =
	`WIDE_ID
(
LEGACY_GROUP
, 
BAR_FRAME_RELEASE
))

1739 
	`iwl_mvm_rx_b¨_‰ame_ªÀa£
(
mvm
, 
«pi
, 
rxb
, 0);

1740 i‡(
cmd
 =
	`WIDE_ID
(
DATA_PATH_GROUP
, 
RX_NO_DATA_NOTIF
))

1741 
	`iwl_mvm_rx_m⁄ô‹_no_d©a
(
mvm
, 
«pi
, 
rxb
, 0);

1743 
	`iwl_mvm_rx_comm⁄
(
mvm
, 
rxb
, 
pkt
);

1744 
	}
}

1746 
	$iwl_mvm_is_°©ic_queue
(
iwl_mvm
 *
mvm
, 
queue
)

1748  
queue
 =
mvm
->
aux_queue
 || queuê=mvm->
¥obe_queue
 ||

1749 
queue
 =
mvm
->
p2p_dev_queue
 || queuê=mvm->
¢if_queue
;

1750 
	}
}

1752 
	$iwl_mvm_queue_°©e_ch™ge
(
iwl_›_mode
 *
›_mode
,

1753 
hw_queue
, 
boﬁ
 
°¨t
)

1755 
iwl_mvm
 *
mvm
 = 
	`IWL_OP_MODE_GET_MVM
(
›_mode
);

1756 
õì80211_°a
 *
°a
;

1757 
õì80211_txq
 *
txq
;

1758 
iwl_mvm_txq
 *
mvmtxq
;

1759 
i
;

1760 
tid_bôm≠
;

1761 
iwl_mvm_°a
 *
mvm°a
;

1762 
u8
 
°a_id
;

1764 
°a_id
 = 
	`iwl_mvm_has_√w_tx_≠i
(
mvm
) ?

1765 
mvm
->
tvqm_öfo
[
hw_queue
].
°a_id
 :

1766 
mvm
->
queue_öfo
[
hw_queue
].
ø_°a_id
;

1768 i‡(
	`WARN_ON_ONCE
(
°a_id
 >
mvm
->
fw
->
ucode_ˇ∑
.
num_°©i⁄s
))

1771 
	`rcu_ªad_lock
();

1773 
°a
 = 
	`rcu_dîe„ªn˚
(
mvm
->
fw_id_to_mac_id
[
°a_id
]);

1774 i‡(
	`IS_ERR_OR_NULL
(
°a
))

1775 
out
;

1776 
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

1778 i‡(
	`iwl_mvm_is_°©ic_queue
(
mvm
, 
hw_queue
)) {

1779 i‡(!
°¨t
)

1780 
	`õì80211_°›_queues
(
mvm
->
hw
);

1781 i‡(
mvm°a
->
°a_°©e
 !
IEEE80211_STA_NOTEXIST
)

1782 
	`õì80211_wake_queues
(
mvm
->
hw
);

1784 
out
;

1787 i‡(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)) {

1788 
tid
 = 
mvm
->
tvqm_öfo
[
hw_queue
].
txq_tid
;

1790 
tid_bôm≠
 = 
	`BIT
(
tid
);

1792 
tid_bôm≠
 = 
mvm
->
queue_öfo
[
hw_queue
].tid_bitmap;

1795 
	`f‹_óch_£t_bô
(
i
, &
tid_bôm≠
, 
IWL_MAX_TID_COUNT
 + 1) {

1796 
tid
 = 
i
;

1798 i‡(
tid
 =
IWL_MAX_TID_COUNT
)

1799 
tid
 = 
IEEE80211_NUM_TIDS
;

1801 
txq
 = 
°a
->txq[
tid
];

1802 
mvmtxq
 = 
	`iwl_mvm_txq_‰om_mac80211
(
txq
);

1803 i‡(
°¨t
)

1804 
	`˛ór_bô
(
IWL_MVM_TXQ_STATE_STOP_FULL
, &
mvmtxq
->
°©e
);

1806 
	`£t_bô
(
IWL_MVM_TXQ_STATE_STOP_FULL
, &
mvmtxq
->
°©e
);

1808 i‡(
°¨t
 && 
mvm°a
->
°a_°©e
 !
IEEE80211_STA_NOTEXIST
) {

1809 
	`loˇl_bh_dißbÀ
();

1810 
	`iwl_mvm_mac_ôxq_xmô
(
mvm
->
hw
, 
txq
);

1811 
	`loˇl_bh_íabÀ
();

1815 
out
:

1816 
	`rcu_ªad_u∆ock
();

1817 
	}
}

1819 
	$iwl_mvm_°›_sw_queue
(
iwl_›_mode
 *
›_mode
, 
hw_queue
)

1821 
	`iwl_mvm_queue_°©e_ch™ge
(
›_mode
, 
hw_queue
, 
Ál£
);

1822 
	}
}

1824 
	$iwl_mvm_wake_sw_queue
(
iwl_›_mode
 *
›_mode
, 
hw_queue
)

1826 
	`iwl_mvm_queue_°©e_ch™ge
(
›_mode
, 
hw_queue
, 
åue
);

1827 
	}
}

1829 
	$iwl_mvm_£t_rfkûl_°©e
(
iwl_mvm
 *
mvm
)

1831 
	`wùhy_rfkûl_£t_hw_°©e
(
mvm
->
hw
->
wùhy
,

1832 
	`iwl_mvm_is_ødio_kûÀd
(
mvm
));

1833 
	}
}

1835 
	$iwl_mvm_£t_hw_˘kûl_°©e
(
iwl_mvm
 *
mvm
, 
boﬁ
 
°©e
)

1837 i‡(
°©e
)

1838 
	`£t_bô
(
IWL_MVM_STATUS_HW_CTKILL
, &
mvm
->
°©us
);

1840 
	`˛ór_bô
(
IWL_MVM_STATUS_HW_CTKILL
, &
mvm
->
°©us
);

1842 
	`iwl_mvm_£t_rfkûl_°©e
(
mvm
);

1843 
	}
}

1845 
iwl_mvm_csme_c⁄n_öfo
 *
	$iwl_mvm_gë_csme_c⁄n_öfo
(
iwl_mvm
 *
mvm
)

1847  
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm
->
csme_c⁄n_öfo
,

1848 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

1849 
	}
}

1851 
boﬁ
 
	$iwl_mvm_£t_hw_rfkûl_°©e
(
iwl_›_mode
 *
›_mode
, 
boﬁ
 
°©e
)

1853 
iwl_mvm
 *
mvm
 = 
	`IWL_OP_MODE_GET_MVM
(
›_mode
);

1854 
boﬁ
 
rfkûl_ß„_öô_d⁄e
 = 
	`READ_ONCE
(
mvm
->rfkill_safe_init_done);

1855 
boﬁ
 
unifõd
 = 
	`iwl_mvm_has_unifõd_ucode
(
mvm
);

1857 i‡(
°©e
) {

1858 
	`£t_bô
(
IWL_MVM_STATUS_HW_RFKILL
, &
mvm
->
°©us
);

1859 
	`wake_up
(&
mvm
->
rx_sync_waôq
);

1861 
	`˛ór_bô
(
IWL_MVM_STATUS_HW_RFKILL
, &
mvm
->
°©us
);

1864 
	`iwl_mvm_£t_rfkûl_°©e
(
mvm
);

1867 i‡(
rfkûl_ß„_öô_d⁄e
)

1868 
	`iwl_ab‹t_nŸifiˇti⁄_waôs
(&
mvm
->
nŸif_waô
);

1874 i‡(
unifõd
)

1875  
Ál£
;

1881  
°©e
 && 
rfkûl_ß„_öô_d⁄e
;

1882 
	}
}

1884 
	$iwl_mvm_‰ì_skb
(
iwl_›_mode
 *
›_mode
, 
sk_buff
 *
skb
)

1886 
iwl_mvm
 *
mvm
 = 
	`IWL_OP_MODE_GET_MVM
(
›_mode
);

1887 
õì80211_tx_öfo
 *
öfo
;

1889 
öfo
 = 
	`IEEE80211_SKB_CB
(
skb
);

1890 
	`iwl_å™s_‰ì_tx_cmd
(
mvm
->
å™s
, 
öfo
->
drivî_d©a
[1]);

1891 
	`õì80211_‰ì_txskb
(
mvm
->
hw
, 
skb
);

1892 
	}
}

1894 
	siwl_mvm_ª¥obe
 {

1895 
devi˚
 *
	mdev
;

1896 
w‹k_°ru˘
 
	mw‹k
;

1899 
	$iwl_mvm_ª¥obe_wk
(
w‹k_°ru˘
 *
wk
)

1901 
iwl_mvm_ª¥obe
 *
ª¥obe
;

1903 
ª¥obe
 = 
	`c⁄èöî_of
(
wk
, 
iwl_mvm_ª¥obe
, 
w‹k
);

1904 i‡(
	`devi˚_ª¥obe
(
ª¥obe
->
dev
))

1905 
	`dev_îr
(
ª¥obe
->
dev
, "reprobe failed!\n");

1906 
	`put_devi˚
(
ª¥obe
->
dev
);

1907 
	`k‰ì
(
ª¥obe
);

1908 
	`moduÀ_put
(
THIS_MODULE
);

1909 
	}
}

1911 
	$iwl_mvm_nic_ª°¨t
(
iwl_mvm
 *
mvm
, 
boﬁ
 
fw_îr‹
)

1913 
	`iwl_ab‹t_nŸifiˇti⁄_waôs
(&
mvm
->
nŸif_waô
);

1914 
	`iwl_dbg_év_dñ_timîs
(
mvm
->
å™s
);

1926 
	`iwl_mvm_ªp‹t_sˇn_ab‹ãd
(
mvm
);

1934 i‡(!
mvm
->
fw_ª°¨t
 && 
fw_îr‹
) {

1935 
	`iwl_fw_îr‹_cﬁÀ˘
(&
mvm
->
fwπ
, 
Ál£
);

1936 } i‡(
	`ã°_bô
(
IWL_MVM_STATUS_STARTING
,

1937 &
mvm
->
°©us
)) {

1938 
	`IWL_ERR
(
mvm
, "Starting mac,Ñetry will beÅriggeredányway\n");

1939 } i‡(
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
)) {

1940 
iwl_mvm_ª¥obe
 *
ª¥obe
;

1942 
	`IWL_ERR
(
mvm
,

1950 i‡(!
	`åy_moduÀ_gë
(
THIS_MODULE
)) {

1951 
	`IWL_ERR
(
mvm
, "Module is being unloaded -ábort\n");

1955 
ª¥obe
 = 
	`kzÆloc
((*ª¥obe), 
GFP_ATOMIC
);

1956 i‡(!
ª¥obe
) {

1957 
	`moduÀ_put
(
THIS_MODULE
);

1960 
ª¥obe
->
dev
 = 
	`gë_devi˚
(
mvm
->
å™s
->dev);

1961 
	`INIT_WORK
(&
ª¥obe
->
w‹k
, 
iwl_mvm_ª¥obe_wk
);

1962 
	`scheduÀ_w‹k
(&
ª¥obe
->
w‹k
);

1963 } i‡(
	`ã°_bô
(
IWL_MVM_STATUS_HW_RESTART_REQUESTED
,

1964 &
mvm
->
°©us
)) {

1965 
	`IWL_ERR
(
mvm
, "HWÑestartálreadyÑequested, butÇot started\n");

1966 } i‡(
mvm
->
fwπ
.
cur_fw_img
 =
IWL_UCODE_REGULAR
 &&

1967 
mvm
->
hw_ªgi°îed
 &&

1968 !
	`ã°_bô
(
STATUS_TRANS_DEAD
, &
mvm
->
å™s
->
°©us
)) {

1973 
	`£t_bô
(
IWL_MVM_STATUS_HW_RESTART_REQUESTED
, &
mvm
->
°©us
);

1975 i‡(
mvm
->
fw
->
ucode_ˇ∑
.
îr‹_log_size
) {

1976 
u32
 
§c_size
 = 
mvm
->
fw
->
ucode_ˇ∑
.
îr‹_log_size
;

1977 
u32
 
§c_addr
 = 
mvm
->
fw
->
ucode_ˇ∑
.
îr‹_log_addr
;

1978 
u8
 *
ªcovî_buf
 = 
	`kzÆloc
(
§c_size
, 
GFP_ATOMIC
);

1980 i‡(
ªcovî_buf
) {

1981 
mvm
->
îr‹_ªcovîy_buf
 = 
ªcovî_buf
;

1982 
	`iwl_å™s_ªad_mem_byãs
(
mvm
->
å™s
,

1983 
§c_addr
,

1984 
ªcovî_buf
,

1985 
§c_size
);

1989 
	`iwl_fw_îr‹_cﬁÀ˘
(&
mvm
->
fwπ
, 
Ál£
);

1991 i‡(
fw_îr‹
 && 
mvm
->
fw_ª°¨t
 > 0) {

1992 
mvm
->
fw_ª°¨t
--;

1993 
	`õì80211_ª°¨t_hw
(
mvm
->
hw
);

1994 } i‡(
mvm
->
fwπ
.
å™s
->
dbg
.
ª°¨t_ªquúed
) {

1995 
	`IWL_DEBUG_INFO
(
mvm
, "FWÑestartÑequestedáfter debug collection\n");

1996 
mvm
->
fwπ
.
å™s
->
dbg
.
ª°¨t_ªquúed
 = 
Ál£
;

1997 
	`õì80211_ª°¨t_hw
(
mvm
->
hw
);

1998 } i‡(
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 <
IWL_DEVICE_FAMILY_8000
) {

1999 
	`õì80211_ª°¨t_hw
(
mvm
->
hw
);

2002 
	}
}

2004 
	$iwl_mvm_nic_îr‹
(
iwl_›_mode
 *
›_mode
, 
boﬁ
 
sync
)

2006 
iwl_mvm
 *
mvm
 = 
	`IWL_OP_MODE_GET_MVM
(
›_mode
);

2008 i‡(!
	`ã°_bô
(
STATUS_TRANS_DEAD
, &
mvm
->
å™s
->
°©us
) &&

2009 !
	`ã°_™d_˛ór_bô
(
IWL_MVM_STATUS_SUPPRESS_ERROR_LOG_ONCE
,

2010 &
mvm
->
°©us
))

2011 
	`iwl_mvm_dump_nic_îr‹_log
(
mvm
);

2013 i‡(
sync
) {

2014 
	`iwl_fw_îr‹_cﬁÀ˘
(&
mvm
->
fwπ
, 
åue
);

2028 i‡(!
	`ã°_bô
(
IWL_MVM_STATUS_FIRMWARE_RUNNING
, &
mvm
->
°©us
))

2031 
	`iwl_mvm_nic_ª°¨t
(
mvm
, 
Ál£
);

2032 
	}
}

2034 
	$iwl_mvm_cmd_queue_fuŒ
(
iwl_›_mode
 *
›_mode
)

2036 
iwl_mvm
 *
mvm
 = 
	`IWL_OP_MODE_GET_MVM
(
›_mode
);

2038 
	`WARN_ON
(1);

2039 
	`iwl_mvm_nic_ª°¨t
(
mvm
, 
åue
);

2040 
	}
}

2042 
	$iwl_›_mode_mvm_time_poöt
(
iwl_›_mode
 *
›_mode
,

2043 
iwl_fw_öi_time_poöt
 
ç_id
,

2044 
iwl_dbg_év_ç_d©a
 *
ç_d©a
)

2046 
iwl_mvm
 *
mvm
 = 
	`IWL_OP_MODE_GET_MVM
(
›_mode
);

2048 
	`iwl_dbg_év_time_poöt
(&
mvm
->
fwπ
, 
ç_id
, 
ç_d©a
);

2049 
	}
}

2051 
	#IWL_MVM_COMMON_OPS
 \

2053 .
queue_fuŒ
 = 
iwl_mvm_°›_sw_queue
, \

2054 .
queue_nŸ_fuŒ
 = 
iwl_mvm_wake_sw_queue
, \

2055 .
hw_rf_kûl
 = 
iwl_mvm_£t_hw_rfkûl_°©e
, \

2056 .
‰ì_skb
 = 
iwl_mvm_‰ì_skb
, \

2057 .
nic_îr‹
 = 
iwl_mvm_nic_îr‹
, \

2058 .
cmd_queue_fuŒ
 = 
iwl_mvm_cmd_queue_fuŒ
, \

2059 .
nic_c⁄fig
 = 
iwl_mvm_nic_c⁄fig
, \

2061 .
°¨t
 = 
iwl_›_mode_mvm_°¨t
, \

2062 .
°›
 = 
iwl_›_mode_mvm_°›
, \

2063 .
time_poöt
 = 
iwl_›_mode_mvm_time_poöt


	)

2065 c⁄° 
iwl_›_mode_›s
 
	giwl_mvm_›s
 = {

2066 
IWL_MVM_COMMON_OPS
,

2067 .
rx
 = 
iwl_mvm_rx
,

2070 
	$iwl_mvm_rx_mq_rss
(
iwl_›_mode
 *
›_mode
,

2071 
«pi_°ru˘
 *
«pi
,

2072 
iwl_rx_cmd_buf„r
 *
rxb
,

2073 
queue
)

2075 
iwl_mvm
 *
mvm
 = 
	`IWL_OP_MODE_GET_MVM
(
›_mode
);

2076 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

2077 
u16
 
cmd
 = 
	`WIDE_ID
(
pkt
->
hdr
.
group_id
,Ökt->hdr.cmd);

2079 i‡(
	`u∆ikñy
(
queue
 >
mvm
->
å™s
->
num_rx_queues
))

2082 i‡(
	`u∆ikñy
(
cmd
 =
	`WIDE_ID
(
LEGACY_GROUP
, 
FRAME_RELEASE
)))

2083 
	`iwl_mvm_rx_‰ame_ªÀa£
(
mvm
, 
«pi
, 
rxb
, 
queue
);

2084 i‡(
	`u∆ikñy
(
cmd
 =
	`WIDE_ID
(
DATA_PATH_GROUP
,

2085 
RX_QUEUES_NOTIFICATION
)))

2086 
	`iwl_mvm_rx_queue_nŸif
(
mvm
, 
«pi
, 
rxb
, 
queue
);

2087 i‡(
	`likñy
(
cmd
 =
	`WIDE_ID
(
LEGACY_GROUP
, 
REPLY_RX_MPDU_CMD
)))

2088 
	`iwl_mvm_rx_mpdu_mq
(
mvm
, 
«pi
, 
rxb
, 
queue
);

2089 
	}
}

2091 c⁄° 
iwl_›_mode_›s
 
	giwl_mvm_›s_mq
 = {

2092 
IWL_MVM_COMMON_OPS
,

2093 .
rx
 = 
iwl_mvm_rx_mq
,

2094 .
	grx_rss
 = 
iwl_mvm_rx_mq_rss
,

	@phy-ctxt.c

7 
	~<√t/mac80211.h
>

8 
	~"fw-≠i.h
"

9 
	~"mvm.h
"

12 
u8
 
	$iwl_mvm_gë_ch™√l_width
(c⁄° 
cfg80211_ch™_def
 *
ch™def
)

14 
ch™def
->
width
) {

15 
NL80211_CHAN_WIDTH_20_NOHT
:

16 
NL80211_CHAN_WIDTH_20
:

17  
IWL_PHY_CHANNEL_MODE20
;

18 
NL80211_CHAN_WIDTH_40
:

19  
IWL_PHY_CHANNEL_MODE40
;

20 
NL80211_CHAN_WIDTH_80
:

21  
IWL_PHY_CHANNEL_MODE80
;

22 
NL80211_CHAN_WIDTH_160
:

23  
IWL_PHY_CHANNEL_MODE160
;

24 
NL80211_CHAN_WIDTH_320
:

25  
IWL_PHY_CHANNEL_MODE320
;

27 
	`WARN
(1, "InvÆid ch™√»width=%u", 
ch™def
->
width
);

28  
IWL_PHY_CHANNEL_MODE20
;

30 
	}
}

36 
u8
 
	$iwl_mvm_gë_˘æ_pos
(c⁄° 
cfg80211_ch™_def
 *
ch™def
)

38 
offs
 = 
ch™def
->
ch™
->
˚¡î_‰eq
 - ch™def->
˚¡î_‰eq1
;

39 
abs_offs
 = 
	`abs
(
offs
);

40 
u8
 
ªt
;

42 i‡(
offs
 == 0) {

52 
ªt
 = (
abs_offs
 - 10) / 20;

58 
ªt
 = (ªà& 
IWL_PHY_CTRL_POS_OFFS_MSK
) |

59 ((
ªt
 & 
	`BIT
(2)) << 1);

61 
ªt
 |(
offs
 > 0Ë* 
IWL_PHY_CTRL_POS_ABOVE
;

63  
ªt
;

64 
	}
}

69 
	$iwl_mvm_phy_˘xt_cmd_hdr
(
iwl_mvm_phy_˘xt
 *
˘xt
,

70 
iwl_phy_c⁄ãxt_cmd
 *
cmd
,

71 
u32
 
a˘i⁄
)

73 
cmd
->
id_™d_cﬁ‹
 = 
	`˝u_to_À32
(
	`FW_CMD_ID_AND_COLOR
(
˘xt
->
id
,

74 
˘xt
->
cﬁ‹
));

75 
cmd
->
a˘i⁄
 = 
	`˝u_to_À32
(action);

76 
	}
}

78 
	$iwl_mvm_phy_˘xt_£t_rxchaö
(
iwl_mvm
 *
mvm
,

79 
iwl_mvm_phy_˘xt
 *
˘xt
,

80 
__À32
 *
rxchaö_öfo
,

81 
u8
 
chaös_°©ic
,

82 
u8
 
chaös_dy«mic
)

84 
u8
 
a˘ive_˙t
, 
idÀ_˙t
;

87 
idÀ_˙t
 = 
chaös_°©ic
;

88 
a˘ive_˙t
 = 
chaös_dy«mic
;

97 i‡(
a˘ive_˙t
 =1 && 
	`iwl_mvm_rx_divîsôy_Ælowed
(
mvm
, 
˘xt
)) {

98 
idÀ_˙t
 = 2;

99 
a˘ive_˙t
 = 2;

102 *
rxchaö_öfo
 = 
	`˝u_to_À32
(
	`iwl_mvm_gë_vÆid_rx_™t
(
mvm
) <<

103 
PHY_RX_CHAIN_VALID_POS
);

104 *
rxchaö_öfo
 |
	`˝u_to_À32
(
idÀ_˙t
 << 
PHY_RX_CHAIN_CNT_POS
);

105 *
rxchaö_öfo
 |
	`˝u_to_À32
(
a˘ive_˙t
 <<

106 
PHY_RX_CHAIN_MIMO_CNT_POS
);

107 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


108 i‡(
	`u∆ikñy
(
mvm
->
dbgfs_rx_phyöfo
))

109 *
rxchaö_öfo
 = 
	`˝u_to_À32
(
mvm
->
dbgfs_rx_phyöfo
);

111 
	}
}

116 
	$iwl_mvm_phy_˘xt_cmd_d©a_v1
(
iwl_mvm
 *
mvm
,

117 
iwl_mvm_phy_˘xt
 *
˘xt
,

118 
iwl_phy_c⁄ãxt_cmd_v1
 *
cmd
,

119 c⁄° 
cfg80211_ch™_def
 *
ch™def
,

120 
u8
 
chaös_°©ic
, u8 
chaös_dy«mic
)

122 
iwl_phy_c⁄ãxt_cmd_èû
 *
èû
 =

123 
	`iwl_mvm_ch™_öfo_cmd_èû
(
mvm
, &
cmd
->
ci
);

126 
	`iwl_mvm_£t_ch™_öfo_ch™def
(
mvm
, &
cmd
->
ci
, 
ch™def
);

128 
	`iwl_mvm_phy_˘xt_£t_rxchaö
(
mvm
, 
˘xt
, &
èû
->
rxchaö_öfo
,

129 
chaös_°©ic
, 
chaös_dy«mic
);

131 
èû
->
txchaö_öfo
 = 
	`˝u_to_À32
(
	`iwl_mvm_gë_vÆid_tx_™t
(
mvm
));

132 
	}
}

137 
	$iwl_mvm_phy_˘xt_cmd_d©a
(
iwl_mvm
 *
mvm
,

138 
iwl_mvm_phy_˘xt
 *
˘xt
,

139 
iwl_phy_c⁄ãxt_cmd
 *
cmd
,

140 c⁄° 
cfg80211_ch™_def
 *
ch™def
,

141 
u8
 
chaös_°©ic
, u8 
chaös_dy«mic
)

143 
cmd
->
lmac_id
 = 
	`˝u_to_À32
(
	`iwl_mvm_gë_lmac_id
(
mvm
,

144 
ch™def
->
ch™
->
b™d
));

147 
	`iwl_mvm_£t_ch™_öfo_ch™def
(
mvm
, &
cmd
->
ci
, 
ch™def
);

150 i‡(
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
	`WIDE_ID
(
DATA_PATH_GROUP
, 
RLC_CONFIG_CMD
), 0) < 2)

151 
	`iwl_mvm_phy_˘xt_£t_rxchaö
(
mvm
, 
˘xt
, &
cmd
->
rxchaö_öfo
,

152 
chaös_°©ic
, 
chaös_dy«mic
);

153 
	}
}

155 
	$iwl_mvm_phy_£nd_æc
(
iwl_mvm
 *
mvm
, 
iwl_mvm_phy_˘xt
 *
˘xt
,

156 
u8
 
chaös_°©ic
, u8 
chaös_dy«mic
)

158 
iwl_æc_c⁄fig_cmd
 
cmd
 = {

159 .
phy_id
 = 
	`˝u_to_À32
(
˘xt
->
id
),

162 i‡(
˘xt
->
æc_dißbÀd
)

165 i‡(
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
	`WIDE_ID
(
DATA_PATH_GROUP
,

166 
RLC_CONFIG_CMD
), 0) < 2)

169 
	`BUILD_BUG_ON
(
IWL_RLC_CHAIN_INFO_DRIVER_FORCE
 !=

170 
PHY_RX_CHAIN_DRIVER_FORCE_MSK
);

171 
	`BUILD_BUG_ON
(
IWL_RLC_CHAIN_INFO_VALID
 !=

172 
PHY_RX_CHAIN_VALID_MSK
);

173 
	`BUILD_BUG_ON
(
IWL_RLC_CHAIN_INFO_FORCE
 !=

174 
PHY_RX_CHAIN_FORCE_SEL_MSK
);

175 
	`BUILD_BUG_ON
(
IWL_RLC_CHAIN_INFO_FORCE_MIMO
 !=

176 
PHY_RX_CHAIN_FORCE_MIMO_SEL_MSK
);

177 
	`BUILD_BUG_ON
(
IWL_RLC_CHAIN_INFO_COUNT
 !
PHY_RX_CHAIN_CNT_MSK
);

178 
	`BUILD_BUG_ON
(
IWL_RLC_CHAIN_INFO_MIMO_COUNT
 !=

179 
PHY_RX_CHAIN_MIMO_CNT_MSK
);

181 
	`iwl_mvm_phy_˘xt_£t_rxchaö
(
mvm
, 
˘xt
, &
cmd
.
æc
.
rx_chaö_öfo
,

182 
chaös_°©ic
, 
chaös_dy«mic
);

184 
	`IWL_DEBUG_FW
(
mvm
, "Send RLC command:Öhy=%d,Ñx_chain_info=0x%x\n",

185 
˘xt
->
id
, 
cmd
.
æc
.
rx_chaö_öfo
);

187  
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
	`iwl_cmd_id
(
RLC_CONFIG_CMD
,

188 
DATA_PATH_GROUP
, 2),

189 0, (
cmd
), &cmd);

190 
	}
}

198 
	$iwl_mvm_phy_˘xt_≠∂y
(
iwl_mvm
 *
mvm
,

199 
iwl_mvm_phy_˘xt
 *
˘xt
,

200 c⁄° 
cfg80211_ch™_def
 *
ch™def
,

201 c⁄° 
cfg80211_ch™_def
 *
≠
,

202 
u8
 
chaös_°©ic
, u8 
chaös_dy«mic
,

203 
u32
 
a˘i⁄
)

205 
ªt
;

206 
vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
PHY_CONTEXT_CMD
, 1);

208 i‡(
vî
 < 5 || !
≠
 || !≠->
ch™
)

209 
≠
 = 
NULL
;

211 i‡(
vî
 >= 3 && ver <= 6) {

212 
iwl_phy_c⁄ãxt_cmd
 
cmd
 = {};

215 
	`iwl_mvm_phy_˘xt_cmd_hdr
(
˘xt
, &
cmd
, 
a˘i⁄
);

218 
	`iwl_mvm_phy_˘xt_cmd_d©a
(
mvm
, 
˘xt
, &
cmd
, 
ch™def
,

219 
chaös_°©ic
,

220 
chaös_dy«mic
);

222 i‡(
≠
) {

223 
cmd
.
sbb_b™dwidth
 = 
	`iwl_mvm_gë_ch™√l_width
(
≠
);

224 
cmd
.
sbb_˘æ_ch™√l_loc
 = 
	`iwl_mvm_gë_˘æ_pos
(
≠
);

227 i‡(
vî
 == 6)

228 
cmd
.
pun˘uª_mask
 = 
	`˝u_to_À16
(
ch™def
->
pun˘uªd
);

230 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
PHY_CONTEXT_CMD
,

231 0, (
cmd
), &cmd);

232 } i‡(
vî
 < 3) {

233 
iwl_phy_c⁄ãxt_cmd_v1
 
cmd
 = {};

234 
u16
 
Àn
 = (
cmd
Ë- 
	`iwl_mvm_ch™_öfo_∑ddög
(
mvm
);

237 
	`iwl_mvm_phy_˘xt_cmd_hdr
(
˘xt
,

238 (
iwl_phy_c⁄ãxt_cmd
 *)&
cmd
,

239 
a˘i⁄
);

242 
	`iwl_mvm_phy_˘xt_cmd_d©a_v1
(
mvm
, 
˘xt
, &
cmd
, 
ch™def
,

243 
chaös_°©ic
,

244 
chaös_dy«mic
);

245 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
PHY_CONTEXT_CMD
,

246 0, 
Àn
, &
cmd
);

248 
	`IWL_ERR
(
mvm
, "PHY ctxàcmdÉº‹ vî %dÇŸ suµ‹ãd\n", 
vî
);

249  -
EOPNOTSUPP
;

253 i‡(
ªt
) {

254 
	`IWL_ERR
(
mvm
, "PHY ctxàcmdÉº‹.Ñë=%d\n", 
ªt
);

255  
ªt
;

258 i‡(
a˘i⁄
 !
FW_CTXT_ACTION_REMOVE
)

259  
	`iwl_mvm_phy_£nd_æc
(
mvm
, 
˘xt
, 
chaös_°©ic
,

260 
chaös_dy«mic
);

263 
	}
}

268 
	$iwl_mvm_phy_˘xt_add
(
iwl_mvm
 *
mvm
, 
iwl_mvm_phy_˘xt
 *
˘xt
,

269 c⁄° 
cfg80211_ch™_def
 *
ch™def
,

270 c⁄° 
cfg80211_ch™_def
 *
≠
,

271 
u8
 
chaös_°©ic
, u8 
chaös_dy«mic
)

273 
ªt
;

275 
	`WARN_ON
(!
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
) &&

276 
˘xt
->
ªf
);

277 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

279 
˘xt
->
ch™√l
 = 
ch™def
->
ch™
;

280 
˘xt
->
width
 = 
ch™def
->width;

281 
˘xt
->
˚¡î_‰eq1
 = 
ch™def
->center_freq1;

283 
ªt
 = 
	`iwl_mvm_phy_˘xt_≠∂y
(
mvm
, 
˘xt
, 
ch™def
, 
≠
,

284 
chaös_°©ic
, 
chaös_dy«mic
,

285 
FW_CTXT_ACTION_ADD
);

287 i‡(
ªt
)

288  
ªt
;

290 
˘xt
->
ªf
++;

293 
	}
}

299 
	$iwl_mvm_phy_˘xt_ªf
(
iwl_mvm
 *
mvm
, 
iwl_mvm_phy_˘xt
 *
˘xt
)

301 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

306 
	`WARN_ON
(!
˘xt
->
ªf
);

307 
˘xt
->
ªf
++;

308 
	}
}

315 
	$iwl_mvm_phy_˘xt_ch™ged
(
iwl_mvm
 *
mvm
, 
iwl_mvm_phy_˘xt
 *
˘xt
,

316 c⁄° 
cfg80211_ch™_def
 *
ch™def
,

317 c⁄° 
cfg80211_ch™_def
 *
≠
,

318 
u8
 
chaös_°©ic
, u8 
chaös_dy«mic
)

320 
iwl_˘xt_a˘i⁄
 
a˘i⁄
 = 
FW_CTXT_ACTION_MODIFY
;

322 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

324 i‡(
	`WARN_ON_ONCE
(!
˘xt
->
ªf
))

325  -
EINVAL
;

327 i‡(
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
	`WIDE_ID
(
DATA_PATH_GROUP
,

328 
RLC_CONFIG_CMD
), 0) >= 2 &&

329 
˘xt
->
ch™√l
 =
ch™def
->
ch™
 &&

330 
˘xt
->
width
 =
ch™def
->width &&

331 
˘xt
->
˚¡î_‰eq1
 =
ch™def
->center_freq1)

332  
	`iwl_mvm_phy_£nd_æc
(
mvm
, 
˘xt
, 
chaös_°©ic
,

333 
chaös_dy«mic
);

335 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

336 
IWL_UCODE_TLV_CAPA_BINDING_CDB_SUPPORT
) &&

337 
˘xt
->
ch™√l
->
b™d
 !
ch™def
->
ch™
->band) {

338 
ªt
;

341 
ªt
 = 
	`iwl_mvm_phy_˘xt_≠∂y
(
mvm
, 
˘xt
, 
ch™def
, 
NULL
,

342 
chaös_°©ic
, 
chaös_dy«mic
,

343 
FW_CTXT_ACTION_REMOVE
);

344 i‡(
ªt
)

345  
ªt
;

348 
a˘i⁄
 = 
FW_CTXT_ACTION_ADD
;

351 
˘xt
->
ch™√l
 = 
ch™def
->
ch™
;

352 
˘xt
->
width
 = 
ch™def
->width;

353 
˘xt
->
˚¡î_‰eq1
 = 
ch™def
->center_freq1;

355  
	`iwl_mvm_phy_˘xt_≠∂y
(
mvm
, 
˘xt
, 
ch™def
, 
≠
,

356 
chaös_°©ic
, 
chaös_dy«mic
,

357 
a˘i⁄
);

358 
	}
}

360 
	$iwl_mvm_phy_˘xt_uƒef
(
iwl_mvm
 *
mvm
, 
iwl_mvm_phy_˘xt
 *
˘xt
)

362 
cfg80211_ch™_def
 
ch™def
;

363 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

365 i‡(
	`WARN_ON_ONCE
(!
˘xt
))

368 
˘xt
->
ªf
--;

370 i‡(
˘xt
->
ªf
)

373 
	`cfg80211_ch™def_¸óã
(&
ch™def
, 
˘xt
->
ch™√l
, 
NL80211_CHAN_NO_HT
);

375 
	`iwl_mvm_phy_˘xt_≠∂y
(
mvm
, 
˘xt
, &
ch™def
, 
NULL
, 1, 1,

376 
FW_CTXT_ACTION_REMOVE
);

377 
	}
}

379 
	$iwl_mvm_bödög_ôî©‹
(*
_d©a
, 
u8
 *
mac
,

380 
õì80211_vif
 *
vif
)

382 *
d©a
 = 
_d©a
;

383 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

385 i‡(!
mvmvif
->
deÊök
.
phy_˘xt
)

388 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
 ||

389 
vif
->
ty≥
 =
NL80211_IFTYPE_AP
)

390 
	`__£t_bô
(
mvmvif
->
deÊök
.
phy_˘xt
->
id
, 
d©a
);

391 
	}
}

393 
	$iwl_mvm_phy_˘x_cou¡
(
iwl_mvm
 *
mvm
)

395 
phy_˘xt_cou¡î
 = 0;

397 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s_©omic
(
mvm
->
hw
,

398 
IEEE80211_IFACE_ITER_NORMAL
,

399 
iwl_mvm_bödög_ôî©‹
,

400 &
phy_˘xt_cou¡î
);

402  
	`hweight8
(
phy_˘xt_cou¡î
);

403 
	}
}

	@power.c

7 
	~<löux/kî√l.h
>

8 
	~<löux/moduÀ.h
>

9 
	~<löux/¶ab.h
>

10 
	~<löux/ëhîdevi˚.h
>

12 
	~<√t/mac80211.h
>

14 
	~"iwl-debug.h
"

15 
	~"mvm.h
"

16 
	~"iwl-mod∑øms.h
"

17 
	~"fw/≠i/powî.h
"

19 
	#POWER_KEEP_ALIVE_PERIOD_SEC
 25

	)

22 
	$iwl_mvm_bóc⁄_fûãr_£nd_cmd
(
iwl_mvm
 *
mvm
,

23 
iwl_bóc⁄_fûãr_cmd
 *
cmd
)

25 
u16
 
Àn
;

27 
	`IWL_DEBUG_POWER
(
mvm
, "ba_enable_beacon_abort is: %d\n",

28 
	`À32_to_˝u
(
cmd
->
ba_íabÀ_bóc⁄_ab‹t
));

29 
	`IWL_DEBUG_POWER
(
mvm
, "ba_escape_timer is: %d\n",

30 
	`À32_to_˝u
(
cmd
->
ba_esˇ≥_timî
));

31 
	`IWL_DEBUG_POWER
(
mvm
, "bf_debug_flag is: %d\n",

32 
	`À32_to_˝u
(
cmd
->
bf_debug_Êag
));

33 
	`IWL_DEBUG_POWER
(
mvm
, "bf_enable_beacon_filter is: %d\n",

34 
	`À32_to_˝u
(
cmd
->
bf_íabÀ_bóc⁄_fûãr
));

35 
	`IWL_DEBUG_POWER
(
mvm
, "bf_energy_delta is: %d\n",

36 
	`À32_to_˝u
(
cmd
->
bf_íîgy_dñè
));

37 
	`IWL_DEBUG_POWER
(
mvm
, "bf_escape_timer is: %d\n",

38 
	`À32_to_˝u
(
cmd
->
bf_esˇ≥_timî
));

39 
	`IWL_DEBUG_POWER
(
mvm
, "bf_roaming_energy_delta is: %d\n",

40 
	`À32_to_˝u
(
cmd
->
bf_rﬂmög_íîgy_dñè
));

41 
	`IWL_DEBUG_POWER
(
mvm
, "bf_roaming_state is: %d\n",

42 
	`À32_to_˝u
(
cmd
->
bf_rﬂmög_°©e
));

43 
	`IWL_DEBUG_POWER
(
mvm
, "bf_temp_threshold is: %d\n",

44 
	`À32_to_˝u
(
cmd
->
bf_ãmp_thªshﬁd
));

45 
	`IWL_DEBUG_POWER
(
mvm
, "bf_temp_fast_filter is: %d\n",

46 
	`À32_to_˝u
(
cmd
->
bf_ãmp_Á°_fûãr
));

47 
	`IWL_DEBUG_POWER
(
mvm
, "bf_temp_slow_filter is: %d\n",

48 
	`À32_to_˝u
(
cmd
->
bf_ãmp_¶ow_fûãr
));

49 
	`IWL_DEBUG_POWER
(
mvm
, "bf_threshold_absolute_low is: %d, %d\n",

50 
	`À32_to_˝u
(
cmd
->
bf_thªshﬁd_absﬁuã_low
[0]),

51 
	`À32_to_˝u
(
cmd
->
bf_thªshﬁd_absﬁuã_low
[1]));

53 
	`IWL_DEBUG_POWER
(
mvm
, "bf_threshold_absolute_high is: %d, %d\n",

54 
	`À32_to_˝u
(
cmd
->
bf_thªshﬁd_absﬁuã_high
[0]),

55 
	`À32_to_˝u
(
cmd
->
bf_thªshﬁd_absﬁuã_high
[1]));

57 i‡(
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

58 
IWL_UCODE_TLV_API_BEACON_FILTER_V4
))

59 
Àn
 = (
iwl_bóc⁄_fûãr_cmd
);

61 
Àn
 = 
	`off£tof
(
iwl_bóc⁄_fûãr_cmd
,

62 
bf_thªshﬁd_absﬁuã_low
);

64  
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
REPLY_BEACON_FILTERING_CMD
, 0,

65 
Àn
, 
cmd
);

66 
	}
}

69 
	$iwl_mvm_bóc⁄_fûãr_£t_cqm_∑øms
(
iwl_mvm
 *
mvm
,

70 
õì80211_vif
 *
vif
,

71 
iwl_bóc⁄_fûãr_cmd
 *
cmd
)

73 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

75 i‡(
vif
->
bss_c⁄f
.
cqm_rssi_thﬁd
) {

76 
cmd
->
bf_íîgy_dñè
 =

77 
	`˝u_to_À32
(
vif
->
bss_c⁄f
.
cqm_rssi_hy°
);

79 
cmd
->
bf_rﬂmög_°©e
 =

80 
	`˝u_to_À32
(-
vif
->
bss_c⁄f
.
cqm_rssi_thﬁd
);

82 
cmd
->
ba_íabÀ_bóc⁄_ab‹t
 = 
	`˝u_to_À32
(
mvmvif
->
bf_d©a
.
ba_íabÀd
);

83 
	}
}

85 
	$iwl_mvm_powî_log
(
iwl_mvm
 *
mvm
,

86 
iwl_mac_powî_cmd
 *
cmd
)

88 
	`IWL_DEBUG_POWER
(
mvm
,

90 
cmd
->
id_™d_cﬁ‹
, 
iwlmvm_mod_∑øms
.
powî_scheme
,

91 
	`À16_to_˝u
(
cmd
->
Êags
));

92 
	`IWL_DEBUG_POWER
(
mvm
, "Keepálive = %u sec\n",

93 
	`À16_to_˝u
(
cmd
->
kìp_Æive_£c⁄ds
));

95 i‡(!(
cmd
->
Êags
 & 
	`˝u_to_À16
(
POWER_FLAGS_POWER_MANAGEMENT_ENA_MSK
))) {

96 
	`IWL_DEBUG_POWER
(
mvm
, "DisableÖower management\n");

100 
	`IWL_DEBUG_POWER
(
mvm
, "RxÅimeout = %u usec\n",

101 
	`À32_to_˝u
(
cmd
->
rx_d©a_timeout
));

102 
	`IWL_DEBUG_POWER
(
mvm
, "TxÅimeout = %u usec\n",

103 
	`À32_to_˝u
(
cmd
->
tx_d©a_timeout
));

104 i‡(
cmd
->
Êags
 & 
	`˝u_to_À16
(
POWER_FLAGS_SKIP_OVER_DTIM_MSK
))

105 
	`IWL_DEBUG_POWER
(
mvm
, "DTIMÖeriodsÅo skip = %u\n",

106 
cmd
->
skù_dtim_≥riods
);

107 i‡(
cmd
->
Êags
 & 
	`˝u_to_À16
(
POWER_FLAGS_LPRX_ENA_MSK
))

108 
	`IWL_DEBUG_POWER
(
mvm
, "LP RX RSSIÅhreshold = %u\n",

109 
cmd
->
Õrx_rssi_thªshﬁd
);

110 i‡(
cmd
->
Êags
 & 
	`˝u_to_À16
(
POWER_FLAGS_ADVANCE_PM_ENA_MSK
)) {

111 
	`IWL_DEBUG_POWER
(
mvm
, "uAPSDÉnabled\n");

112 
	`IWL_DEBUG_POWER
(
mvm
, "RxÅimeout (uAPSD) = %u usec\n",

113 
	`À32_to_˝u
(
cmd
->
rx_d©a_timeout_u≠sd
));

114 
	`IWL_DEBUG_POWER
(
mvm
, "TxÅimeout (uAPSD) = %u usec\n",

115 
	`À32_to_˝u
(
cmd
->
tx_d©a_timeout_u≠sd
));

116 
	`IWL_DEBUG_POWER
(
mvm
, "QNDP TID = %d\n", 
cmd
->
qndp_tid
);

117 
	`IWL_DEBUG_POWER
(
mvm
, "AC†Êag†0x%x\n", 
cmd
->
u≠sd_ac_Êags
);

118 
	`IWL_DEBUG_POWER
(
mvm
, "Max SP = %d\n", 
cmd
->
u≠sd_max_•
);

120 
	}
}

122 
	$iwl_mvm_powî_c⁄figuª_u≠sd
(
iwl_mvm
 *
mvm
,

123 
õì80211_vif
 *
vif
,

124 
iwl_mac_powî_cmd
 *
cmd
)

126 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

127 
õì80211_ac_numbîs
 
ac
;

128 
boﬁ
 
tid_found
 = 
Ál£
;

130 i‡(
	`ã°_bô
(
IWL_MVM_STATUS_IN_D3
, &
mvm
->
°©us
) ||

131 
cmd
->
Êags
 & 
	`˝u_to_À16
(
POWER_FLAGS_SNOOZE_ENA_MSK
)) {

132 
cmd
->
rx_d©a_timeout_u≠sd
 =

133 
	`˝u_to_À32
(
IWL_MVM_WOWLAN_PS_RX_DATA_TIMEOUT
);

134 
cmd
->
tx_d©a_timeout_u≠sd
 =

135 
	`˝u_to_À32
(
IWL_MVM_WOWLAN_PS_TX_DATA_TIMEOUT
);

137 
cmd
->
rx_d©a_timeout_u≠sd
 =

138 
	`˝u_to_À32
(
IWL_MVM_UAPSD_RX_DATA_TIMEOUT
);

139 
cmd
->
tx_d©a_timeout_u≠sd
 =

140 
	`˝u_to_À32
(
IWL_MVM_UAPSD_TX_DATA_TIMEOUT
);

143 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


145 i‡(
mvmvif
->
dbgfs_pm
.
u£_ps_pﬁl
) {

146 
cmd
->
Êags
 |
	`˝u_to_À16
(
POWER_FLAGS_ADVANCE_PM_ENA_MSK
);

151 
ac
 = 
IEEE80211_AC_VO
;á¯<
IEEE80211_AC_BK
;ác++) {

152 i‡(!
mvmvif
->
deÊök
.
queue_∑øms
[
ac
].
u≠sd
)

155 i‡(!
	`ã°_bô
(
IWL_MVM_STATUS_IN_D3
, &
mvm
->
°©us
))

156 
cmd
->
Êags
 |=

157 
	`˝u_to_À16
(
POWER_FLAGS_ADVANCE_PM_ENA_MSK
);

159 
cmd
->
u≠sd_ac_Êags
 |
	`BIT
(
ac
);

162 i‡(!
tid_found
 && !
mvmvif
->
deÊök
.
queue_∑øms
[
ac
].
acm
) {

163 
tid_found
 = 
åue
;

164 
ac
) {

165 
IEEE80211_AC_VO
:

166 
cmd
->
qndp_tid
 = 6;

168 
IEEE80211_AC_VI
:

169 
cmd
->
qndp_tid
 = 5;

171 
IEEE80211_AC_BE
:

172 
cmd
->
qndp_tid
 = 0;

174 
IEEE80211_AC_BK
:

175 
cmd
->
qndp_tid
 = 1;

181 
cmd
->
Êags
 |
	`˝u_to_À16
(
POWER_FLAGS_UAPSD_MISBEHAVING_ENA_MSK
);

183 i‡(
cmd
->
u≠sd_ac_Êags
 =(
	`BIT
(
IEEE80211_AC_VO
) |

184 
	`BIT
(
IEEE80211_AC_VI
) |

185 
	`BIT
(
IEEE80211_AC_BE
) |

186 
	`BIT
(
IEEE80211_AC_BK
))) {

187 
cmd
->
Êags
 |
	`˝u_to_À16
(
POWER_FLAGS_SNOOZE_ENA_MSK
);

188 
cmd
->
¢ooze_öãrvÆ
 = 
	`˝u_to_À16
(
IWL_MVM_PS_SNOOZE_INTERVAL
);

189 
cmd
->
¢ooze_wödow
 =

190 
	`ã°_bô
(
IWL_MVM_STATUS_IN_D3
, &
mvm
->
°©us
) ?

191 
	`˝u_to_À16
(
IWL_MVM_WOWLAN_PS_SNOOZE_WINDOW
) :

192 
	`˝u_to_À16
(
IWL_MVM_PS_SNOOZE_WINDOW
);

195 
cmd
->
u≠sd_max_•
 = 
mvm
->
hw
->
u≠sd_max_•_Àn
;

197 i‡(
cmd
->
Êags
 & 
	`˝u_to_À16
(
POWER_FLAGS_SNOOZE_ENA_MSK
)) {

198 
cmd
->
hóvy_tx_thld_∑ckës
 =

199 
IWL_MVM_PS_SNOOZE_HEAVY_TX_THLD_PACKETS
;

200 
cmd
->
hóvy_rx_thld_∑ckës
 =

201 
IWL_MVM_PS_SNOOZE_HEAVY_RX_THLD_PACKETS
;

203 
cmd
->
hóvy_tx_thld_∑ckës
 =

204 
IWL_MVM_PS_HEAVY_TX_THLD_PACKETS
;

205 
cmd
->
hóvy_rx_thld_∑ckës
 =

206 
IWL_MVM_PS_HEAVY_RX_THLD_PACKETS
;

208 
cmd
->
hóvy_tx_thld_≥r˚¡age
 =

209 
IWL_MVM_PS_HEAVY_TX_THLD_PERCENT
;

210 
cmd
->
hóvy_rx_thld_≥r˚¡age
 =

211 
IWL_MVM_PS_HEAVY_RX_THLD_PERCENT
;

212 
	}
}

214 
	$iwl_mvm_p2p_°™dÆ⁄e_ôî©‹
(*
_d©a
, 
u8
 *
mac
,

215 
õì80211_vif
 *
vif
)

217 
boﬁ
 *
is_p2p_°™dÆ⁄e
 = 
_d©a
;

219 
	`õì80211_vif_ty≥_p2p
(
vif
)) {

220 
NL80211_IFTYPE_P2P_GO
:

221 
NL80211_IFTYPE_AP
:

222 *
is_p2p_°™dÆ⁄e
 = 
Ál£
;

224 
NL80211_IFTYPE_STATION
:

225 i‡(
vif
->
cfg
.
assoc
)

226 *
is_p2p_°™dÆ⁄e
 = 
Ál£
;

232 
	}
}

234 
boﬁ
 
	$iwl_mvm_powî_Ælow_u≠sd
(
iwl_mvm
 *
mvm
,

235 
õì80211_vif
 *
vif
)

237 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

239 i‡(
	`ëhî_addr_equÆ
(
mvmvif
->
u≠sd_misbehavög_≠_addr
,

240 
vif
->
cfg
.
≠_addr
))

241  
Ál£
;

247 i‡(
vif
->
p2p
 &&

248 (
vif
->
bss_c⁄f
.
p2p_nﬂ_©å
.
›µs_˘wödow
 &

249 
IEEE80211_P2P_OPPPS_ENABLE_BIT
))

250  
Ál£
;

256 i‡(
	`iwl_mvm_phy_˘x_cou¡
(
mvm
) >= 2)

257  
Ál£
;

259 i‡(
vif
->
p2p
) {

261 
boﬁ
 
is_p2p_°™dÆ⁄e
 = 
åue
;

263 i‡(!
	`iwl_mvm_is_p2p_scm_u≠sd_suµ‹ãd
(
mvm
))

264  
Ál£
;

266 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s_©omic
(
mvm
->
hw
,

267 
IEEE80211_IFACE_ITER_NORMAL
,

268 
iwl_mvm_p2p_°™dÆ⁄e_ôî©‹
,

269 &
is_p2p_°™dÆ⁄e
);

271 i‡(!
is_p2p_°™dÆ⁄e
)

272  
Ál£
;

275  
åue
;

276 
	}
}

278 
boﬁ
 
	$iwl_mvm_powî_is_ød¨
(
õì80211_vif
 *
vif
)

280 
õì80211_ch™˘x_c⁄f
 *
ch™˘x_c⁄f
;

281 
õì80211_bss_c⁄f
 *
lök_c⁄f
;

282 
boﬁ
 
ød¨_dëe˘
 = 
Ál£
;

283 
lök_id
;

285 
	`rcu_ªad_lock
();

286 
	`f‹_óch_vif_a˘ive_lök
(
vif
, 
lök_c⁄f
, 
lök_id
) {

287 
ch™˘x_c⁄f
 = 
	`rcu_dîe„ªn˚
(
lök_c⁄f
->chanctx_conf);

289 i‡(!
ch™˘x_c⁄f
)

292 
ød¨_dëe˘
 = !!(
ch™˘x_c⁄f
->
def
.
ch™
->
Êags
 &

293 
IEEE80211_CHAN_RADAR
);

294 i‡(
ød¨_dëe˘
)

295 
out
;

298 
out
:

299 
	`rcu_ªad_u∆ock
();

300  
ød¨_dëe˘
;

301 
	}
}

303 
	$iwl_mvm_powî_c⁄fig_skù_dtim
(
iwl_mvm
 *
mvm
,

304 
õì80211_vif
 *
vif
,

305 
iwl_mac_powî_cmd
 *
cmd
)

307 
dtim≥r
 = 
vif
->
bss_c⁄f
.
dtim_≥riod
 ?: 1;

308 
skù
;

311 
cmd
->
skù_dtim_≥riods
 = 0;

312 
cmd
->
Êags
 &~
	`˝u_to_À16
(
POWER_FLAGS_SKIP_OVER_DTIM_MSK
);

314 i‡(
	`iwl_mvm_powî_is_ød¨
(
vif
))

317 i‡(
dtim≥r
 >= 10)

320 i‡(!
	`ã°_bô
(
IWL_MVM_STATUS_IN_D3
, &
mvm
->
°©us
)) {

321 i‡(
iwlmvm_mod_∑øms
.
powî_scheme
 !
IWL_POWER_SCHEME_LP
)

323 
skù
 = 2;

325 
dtim≥r_tu
 = 
dtim≥r
 * 
vif
->
bss_c⁄f
.
bóc⁄_öt
;

327 i‡(
	`WARN_ON
(!
dtim≥r_tu
))

330 
skù
 = 
	`max_t
(
u8
, 1, 900 / 
dtim≥r_tu
);

333 
cmd
->
skù_dtim_≥riods
 = 
skù
;

334 
cmd
->
Êags
 |
	`˝u_to_À16
(
POWER_FLAGS_SKIP_OVER_DTIM_MSK
);

335 
	}
}

337 
	$iwl_mvm_powî_buûd_cmd
(
iwl_mvm
 *
mvm
,

338 
õì80211_vif
 *
vif
,

339 
iwl_mac_powî_cmd
 *
cmd
)

341 
dtim≥r
, 
bi
;

342 
kìp_Æive
;

343 
iwl_mvm_vif
 *
mvmvif
 
__maybe_unu£d
 =

344 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

346 
cmd
->
id_™d_cﬁ‹
 = 
	`˝u_to_À32
(
	`FW_CMD_ID_AND_COLOR
(
mvmvif
->
id
,

347 
mvmvif
->
cﬁ‹
));

348 
dtim≥r
 = 
vif
->
bss_c⁄f
.
dtim_≥riod
;

349 
bi
 = 
vif
->
bss_c⁄f
.
bóc⁄_öt
;

357 
kìp_Æive
 = 
	`DIV_ROUND_UP
(
	`õì80211_tu_to_u£c
(3 * 
dtim≥r
 * 
bi
),

358 
USEC_PER_SEC
);

359 
kìp_Æive
 = 
	`max
(kìp_Æive, 
POWER_KEEP_ALIVE_PERIOD_SEC
);

360 
cmd
->
kìp_Æive_£c⁄ds
 = 
	`˝u_to_À16
(
kìp_Æive
);

362 i‡(
mvm
->
ps_dißbÀd
)

365 
cmd
->
Êags
 |
	`˝u_to_À16
(
POWER_FLAGS_POWER_SAVE_ENA_MSK
);

367 i‡(!
vif
->
cfg
.
ps
 || !
mvmvif
->
pm_íabÀd
)

370 i‡(
	`iwl_mvm_vif_low_œãncy
(
mvmvif
Ë&& 
vif
->
p2p
 &&

371 (!
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

372 
IWL_UCODE_TLV_CAPA_SHORT_PM_TIMEOUTS
) ||

373 !
IWL_MVM_P2P_LOWLATENCY_PS_ENABLE
))

376 
cmd
->
Êags
 |
	`˝u_to_À16
(
POWER_FLAGS_POWER_MANAGEMENT_ENA_MSK
);

378 i‡(
vif
->
bss_c⁄f
.
bóc⁄_øã
 &&

379 (
vif
->
bss_c⁄f
.
bóc⁄_øã
->
bôøã
 == 10 ||

380 
vif
->
bss_c⁄f
.
bóc⁄_øã
->
bôøã
 == 60)) {

381 
cmd
->
Êags
 |
	`˝u_to_À16
(
POWER_FLAGS_LPRX_ENA_MSK
);

382 
cmd
->
Õrx_rssi_thªshﬁd
 = 
POWER_LPRX_RSSI_THRESHOLD
;

385 
	`iwl_mvm_powî_c⁄fig_skù_dtim
(
mvm
, 
vif
, 
cmd
);

387 i‡(
	`ã°_bô
(
IWL_MVM_STATUS_IN_D3
, &
mvm
->
°©us
)) {

388 
cmd
->
rx_d©a_timeout
 =

389 
	`˝u_to_À32
(
IWL_MVM_WOWLAN_PS_RX_DATA_TIMEOUT
);

390 
cmd
->
tx_d©a_timeout
 =

391 
	`˝u_to_À32
(
IWL_MVM_WOWLAN_PS_TX_DATA_TIMEOUT
);

392 } i‡(
	`iwl_mvm_vif_low_œãncy
(
mvmvif
Ë&& 
vif
->
p2p
 &&

393 
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

394 
IWL_UCODE_TLV_CAPA_SHORT_PM_TIMEOUTS
)) {

395 
cmd
->
tx_d©a_timeout
 =

396 
	`˝u_to_À32
(
IWL_MVM_SHORT_PS_TX_DATA_TIMEOUT
);

397 
cmd
->
rx_d©a_timeout
 =

398 
	`˝u_to_À32
(
IWL_MVM_SHORT_PS_RX_DATA_TIMEOUT
);

400 
cmd
->
rx_d©a_timeout
 =

401 
	`˝u_to_À32
(
IWL_MVM_DEFAULT_PS_RX_DATA_TIMEOUT
);

402 
cmd
->
tx_d©a_timeout
 =

403 
	`˝u_to_À32
(
IWL_MVM_DEFAULT_PS_TX_DATA_TIMEOUT
);

406 i‡(
	`iwl_mvm_powî_Ælow_u≠sd
(
mvm
, 
vif
))

407 
	`iwl_mvm_powî_c⁄figuª_u≠sd
(
mvm
, 
vif
, 
cmd
);

409 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


410 i‡(
mvmvif
->
dbgfs_pm
.
mask
 & 
MVM_DEBUGFS_PM_KEEP_ALIVE
)

411 
cmd
->
kìp_Æive_£c⁄ds
 =

412 
	`˝u_to_À16
(
mvmvif
->
dbgfs_pm
.
kìp_Æive_£c⁄ds
);

413 i‡(
mvmvif
->
dbgfs_pm
.
mask
 & 
MVM_DEBUGFS_PM_SKIP_OVER_DTIM
) {

414 i‡(
mvmvif
->
dbgfs_pm
.
skù_ovî_dtim
)

415 
cmd
->
Êags
 |=

416 
	`˝u_to_À16
(
POWER_FLAGS_SKIP_OVER_DTIM_MSK
);

418 
cmd
->
Êags
 &=

419 
	`˝u_to_À16
(~
POWER_FLAGS_SKIP_OVER_DTIM_MSK
);

421 i‡(
mvmvif
->
dbgfs_pm
.
mask
 & 
MVM_DEBUGFS_PM_RX_DATA_TIMEOUT
)

422 
cmd
->
rx_d©a_timeout
 =

423 
	`˝u_to_À32
(
mvmvif
->
dbgfs_pm
.
rx_d©a_timeout
);

424 i‡(
mvmvif
->
dbgfs_pm
.
mask
 & 
MVM_DEBUGFS_PM_TX_DATA_TIMEOUT
)

425 
cmd
->
tx_d©a_timeout
 =

426 
	`˝u_to_À32
(
mvmvif
->
dbgfs_pm
.
tx_d©a_timeout
);

427 i‡(
mvmvif
->
dbgfs_pm
.
mask
 & 
MVM_DEBUGFS_PM_SKIP_DTIM_PERIODS
)

428 
cmd
->
skù_dtim_≥riods
 = 
mvmvif
->
dbgfs_pm
.skip_dtim_periods;

429 i‡(
mvmvif
->
dbgfs_pm
.
mask
 & 
MVM_DEBUGFS_PM_LPRX_ENA
) {

430 i‡(
mvmvif
->
dbgfs_pm
.
Õrx_ía
)

431 
cmd
->
Êags
 |
	`˝u_to_À16
(
POWER_FLAGS_LPRX_ENA_MSK
);

433 
cmd
->
Êags
 &
	`˝u_to_À16
(~
POWER_FLAGS_LPRX_ENA_MSK
);

435 i‡(
mvmvif
->
dbgfs_pm
.
mask
 & 
MVM_DEBUGFS_PM_LPRX_RSSI_THRESHOLD
)

436 
cmd
->
Õrx_rssi_thªshﬁd
 = 
mvmvif
->
dbgfs_pm
.lprx_rssi_threshold;

437 i‡(
mvmvif
->
dbgfs_pm
.
mask
 & 
MVM_DEBUGFS_PM_SNOOZE_ENABLE
) {

438 i‡(
mvmvif
->
dbgfs_pm
.
¢ooze_ía
)

439 
cmd
->
Êags
 |=

440 
	`˝u_to_À16
(
POWER_FLAGS_SNOOZE_ENA_MSK
);

442 
cmd
->
Êags
 &=

443 
	`˝u_to_À16
(~
POWER_FLAGS_SNOOZE_ENA_MSK
);

445 i‡(
mvmvif
->
dbgfs_pm
.
mask
 & 
MVM_DEBUGFS_PM_UAPSD_MISBEHAVING
) {

446 
u16
 
Êag
 = 
POWER_FLAGS_UAPSD_MISBEHAVING_ENA_MSK
;

447 i‡(
mvmvif
->
dbgfs_pm
.
u≠sd_misbehavög
)

448 
cmd
->
Êags
 |
	`˝u_to_À16
(
Êag
);

450 
cmd
->
Êags
 &
	`˝u_to_À16
(
Êag
);

453 
	}
}

455 
	$iwl_mvm_powî_£nd_cmd
(
iwl_mvm
 *
mvm
,

456 
õì80211_vif
 *
vif
)

458 
iwl_mac_powî_cmd
 
cmd
 = {};

460 
	`iwl_mvm_powî_buûd_cmd
(
mvm
, 
vif
, &
cmd
);

461 
	`iwl_mvm_powî_log
(
mvm
, &
cmd
);

462 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


463 
	`mem˝y
(&
	`iwl_mvm_vif_‰om_mac80211
(
vif
)->
mac_pwr_cmd
, &
cmd
, (cmd));

466  
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
MAC_PM_POWER_TABLE
, 0,

467 (
cmd
), &cmd);

468 
	}
}

470 
	$iwl_mvm_powî_upd©e_devi˚
(
iwl_mvm
 *
mvm
)

472 
iwl_devi˚_powî_cmd
 
cmd
 = {

473 .
Êags
 = 0,

476 i‡(
iwlmvm_mod_∑øms
.
powî_scheme
 =
IWL_POWER_SCHEME_CAM
)

477 
mvm
->
ps_dißbÀd
 = 
åue
;

479 i‡(!
mvm
->
ps_dißbÀd
)

480 
cmd
.
Êags
 |
	`˝u_to_À16
(
DEVICE_POWER_FLAGS_POWER_SAVE_ENA_MSK
);

482 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


483 i‡(
	`ã°_bô
(
IWL_MVM_STATUS_IN_D3
, &
mvm
->
°©us
) ?

484 
mvm
->
dißbÀ_powî_off_d3
 : mvm->
dißbÀ_powî_off
)

485 
cmd
.
Êags
 &=

486 
	`˝u_to_À16
(~
DEVICE_POWER_FLAGS_POWER_SAVE_ENA_MSK
);

488 i‡(
mvm
->
ext_˛ock_vÆid
)

489 
cmd
.
Êags
 |
	`˝u_to_À16
(
DEVICE_POWER_FLAGS_32K_CLK_VALID_MSK
);

491 i‡(
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
POWER_TABLE_CMD
, 0) >= 7 &&

492 
	`ã°_bô
(
IWL_MVM_STATUS_IN_D3
, &
mvm
->
°©us
))

493 
cmd
.
Êags
 |=

494 
	`˝u_to_À16
(
DEVICE_POWER_FLAGS_NO_SLEEP_TILL_D3_MSK
);

496 
	`IWL_DEBUG_POWER
(
mvm
,

498 
cmd
.
Êags
);

500  
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
POWER_TABLE_CMD
, 0, (
cmd
),

501 &
cmd
);

502 
	}
}

504 
	$iwl_mvm_powî_vif_assoc
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

506 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

508 i‡(!
	`ëhî_addr_equÆ
(
mvmvif
->
u≠sd_misbehavög_≠_addr
,

509 
vif
->
cfg
.
≠_addr
))

510 
	`ëh_zîo_addr
(
mvmvif
->
u≠sd_misbehavög_≠_addr
);

511 
	}
}

513 
	$iwl_mvm_powî_u≠sd_misbehav_≠_ôî©‹
(*
_d©a
, 
u8
 *
mac
,

514 
õì80211_vif
 *
vif
)

516 
u8
 *
≠_°a_id
 = 
_d©a
;

517 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

518 
õì80211_bss_c⁄f
 *
lök_c⁄f
;

519 
lök_id
;

521 
	`rcu_ªad_lock
();

522 
	`f‹_óch_vif_a˘ive_lök
(
vif
, 
lök_c⁄f
, 
lök_id
) {

523 
iwl_mvm_vif_lök_öfo
 *
lök_öfo
 = 
mvmvif
->
lök
[
lök_id
];

528 i‡(
lök_öfo
->
≠_°a_id
 == *ap_sta_id) {

529 
	`ëhî_addr_c›y
(
mvmvif
->
u≠sd_misbehavög_≠_addr
,

530 
vif
->
cfg
.
≠_addr
);

534 
	`rcu_ªad_u∆ock
();

535 
	}
}

537 
	$iwl_mvm_powî_u≠sd_misbehavög_≠_nŸif
(
iwl_mvm
 *
mvm
,

538 
iwl_rx_cmd_buf„r
 *
rxb
)

540 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

541 
iwl_u≠sd_misbehavög_≠_nŸif
 *
nŸif
 = (*)
pkt
->
d©a
;

542 
u8
 
≠_°a_id
 = 
	`À32_to_˝u
(
nŸif
->
°a_id
);

544 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s_©omic
(

545 
mvm
->
hw
, 
IEEE80211_IFACE_ITER_NORMAL
,

546 
iwl_mvm_powî_u≠sd_misbehav_≠_ôî©‹
, &
≠_°a_id
);

547 
	}
}

549 
	siwl_powî_vifs
 {

550 
iwl_mvm
 *
	mmvm
;

551 
õì80211_vif
 *
	mbss_vif
;

552 
õì80211_vif
 *
	mp2p_vif
;

553 
õì80211_vif
 *
	m≠_vif
;

554 
õì80211_vif
 *
	mm⁄ô‹_vif
;

555 
boﬁ
 
	mp2p_a˘ive
;

556 
boﬁ
 
	mbss_a˘ive
;

557 
boﬁ
 
	m≠_a˘ive
;

558 
boﬁ
 
	mm⁄ô‹_a˘ive
;

561 
	$iwl_mvm_powî_dißbÀ_pm_ôî©‹
(*
_d©a
, 
u8
* 
mac
,

562 
õì80211_vif
 *
vif
)

564 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

566 
mvmvif
->
pm_íabÀd
 = 
Ál£
;

567 
	}
}

569 
	$iwl_mvm_powî_ps_dißbÀd_ôî©‹
(*
_d©a
, 
u8
* 
mac
,

570 
õì80211_vif
 *
vif
)

572 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

573 
boﬁ
 *
dißbÀ_ps
 = 
_d©a
;

575 i‡(
	`iwl_mvm_vif_is_a˘ive
(
mvmvif
))

576 *
dißbÀ_ps
 |
mvmvif
->
ps_dißbÀd
;

577 
	}
}

579 
	$iwl_mvm_powî_gë_vifs_ôî©‹
(*
_d©a
, 
u8
 *
mac
,

580 
õì80211_vif
 *
vif
)

582 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

583 
iwl_powî_vifs
 *
powî_ôî©‹
 = 
_d©a
;

584 
boﬁ
 
a˘ive
;

586 i‡(!
mvmvif
->
u∂ﬂded
)

589 
a˘ive
 = 
	`iwl_mvm_vif_is_a˘ive
(
mvmvif
);

591 
	`õì80211_vif_ty≥_p2p
(
vif
)) {

592 
NL80211_IFTYPE_P2P_DEVICE
:

595 
NL80211_IFTYPE_P2P_GO
:

596 
NL80211_IFTYPE_AP
:

598 
	`WARN_ON
(
powî_ôî©‹
->
≠_vif
);

599 
powî_ôî©‹
->
≠_vif
 = 
vif
;

600 i‡(
a˘ive
)

601 
powî_ôî©‹
->
≠_a˘ive
 = 
åue
;

604 
NL80211_IFTYPE_MONITOR
:

606 
	`WARN_ON
(
powî_ôî©‹
->
m⁄ô‹_vif
);

607 
powî_ôî©‹
->
m⁄ô‹_vif
 = 
vif
;

608 i‡(
a˘ive
)

609 
powî_ôî©‹
->
m⁄ô‹_a˘ive
 = 
åue
;

612 
NL80211_IFTYPE_P2P_CLIENT
:

614 
	`WARN_ON
(
powî_ôî©‹
->
p2p_vif
);

615 
powî_ôî©‹
->
p2p_vif
 = 
vif
;

616 i‡(
a˘ive
)

617 
powî_ôî©‹
->
p2p_a˘ive
 = 
åue
;

620 
NL80211_IFTYPE_STATION
:

621 
powî_ôî©‹
->
bss_vif
 = 
vif
;

622 i‡(
a˘ive
)

623 
powî_ôî©‹
->
bss_a˘ive
 = 
åue
;

629 
	}
}

631 
	$iwl_mvm_powî_£t_pm
(
iwl_mvm
 *
mvm
,

632 
iwl_powî_vifs
 *
vifs
)

634 
iwl_mvm_vif
 *
bss_mvmvif
 = 
NULL
;

635 
iwl_mvm_vif
 *
p2p_mvmvif
 = 
NULL
;

636 
iwl_mvm_vif
 *
≠_mvmvif
 = 
NULL
;

637 
boﬁ
 
˛õ¡_ßme_ch™√l
 = 
Ál£
;

638 
boﬁ
 
≠_ßme_ch™√l
 = 
Ál£
;

640 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

643 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s_©omic
(
mvm
->
hw
,

644 
IEEE80211_IFACE_ITER_NORMAL
,

645 
iwl_mvm_powî_dißbÀ_pm_ôî©‹
,

646 
NULL
);

648 i‡(
vifs
->
bss_vif
)

649 
bss_mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vifs
->
bss_vif
);

651 i‡(
vifs
->
p2p_vif
)

652 
p2p_mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vifs
->
p2p_vif
);

654 i‡(
vifs
->
≠_vif
)

655 
≠_mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vifs
->
≠_vif
);

658 i‡(
	`iwl_mvm_tdls_°a_cou¡
(
mvm
, 
NULL
))

662 i‡(
bss_mvmvif
 && 
vifs
->
bss_a˘ive
 && !vifs->
p2p_a˘ive
 &&

663 !
vifs
->
≠_a˘ive
) {

664 
bss_mvmvif
->
pm_íabÀd
 = 
åue
;

669 i‡(
p2p_mvmvif
 && 
vifs
->
p2p_a˘ive
 && !vifs->
bss_a˘ive
 &&

670 !
vifs
->
≠_a˘ive
) {

671 
p2p_mvmvif
->
pm_íabÀd
 = 
åue
;

675 i‡(
p2p_mvmvif
 && 
bss_mvmvif
 && 
vifs
->
bss_a˘ive
 && vifs->
p2p_a˘ive
)

676 
˛õ¡_ßme_ch™√l
 =

677 
	`iwl_mvm_have_löks_ßme_ch™√l
(
bss_mvmvif
, 
p2p_mvmvif
);

679 i‡(
bss_mvmvif
 && 
≠_mvmvif
 && 
vifs
->
bss_a˘ive
 && vifs->
≠_a˘ive
)

680 
≠_ßme_ch™√l
 =

681 
	`iwl_mvm_have_löks_ßme_ch™√l
(
bss_mvmvif
, 
≠_mvmvif
);

684 i‡(!(
˛õ¡_ßme_ch™√l
 || 
≠_ßme_ch™√l
)) {

685 i‡(
bss_mvmvif
 && 
vifs
->
bss_a˘ive
)

686 
bss_mvmvif
->
pm_íabÀd
 = 
åue
;

687 i‡(
p2p_mvmvif
 && 
vifs
->
p2p_a˘ive
)

688 
p2p_mvmvif
->
pm_íabÀd
 = 
åue
;

696 i‡(
˛õ¡_ßme_ch™√l
 && !
vifs
->
≠_a˘ive
) {

698 
bss_mvmvif
->
pm_íabÀd
 = 
åue
;

699 
p2p_mvmvif
->
pm_íabÀd
 = 
åue
;

701 
	}
}

703 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


704 
	$iwl_mvm_powî_mac_dbgfs_ªad
(
iwl_mvm
 *
mvm
,

705 
õì80211_vif
 *
vif
, *
buf
,

706 
bufsz
)

708 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

709 
iwl_mac_powî_cmd
 
cmd
 = {};

710 
pos
 = 0;

712 
	`muãx_lock
(&
mvm
->
muãx
);

713 
	`mem˝y
(&
cmd
, &
mvmvif
->
mac_pwr_cmd
, (cmd));

714 
	`muãx_u∆ock
(&
mvm
->
muãx
);

716 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "power_scheme = %d\n",

717 
iwlmvm_mod_∑øms
.
powî_scheme
);

718 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "flags = 0x%x\n",

719 
	`À16_to_˝u
(
cmd
.
Êags
));

720 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "keep_alive = %d\n",

721 
	`À16_to_˝u
(
cmd
.
kìp_Æive_£c⁄ds
));

723 i‡(!(
cmd
.
Êags
 & 
	`˝u_to_À16
(
POWER_FLAGS_POWER_MANAGEMENT_ENA_MSK
)))

724  
pos
;

726 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "skip_over_dtim = %d\n",

727 (
cmd
.
Êags
 &

728 
	`˝u_to_À16
(
POWER_FLAGS_SKIP_OVER_DTIM_MSK
)) ? 1 : 0);

729 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "skip_dtim_periods = %d\n",

730 
cmd
.
skù_dtim_≥riods
);

731 i‡(!(
cmd
.
Êags
 & 
	`˝u_to_À16
(
POWER_FLAGS_ADVANCE_PM_ENA_MSK
))) {

732 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "rx_data_timeout = %d\n",

733 
	`À32_to_˝u
(
cmd
.
rx_d©a_timeout
));

734 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "tx_data_timeout = %d\n",

735 
	`À32_to_˝u
(
cmd
.
tx_d©a_timeout
));

737 i‡(
cmd
.
Êags
 & 
	`˝u_to_À16
(
POWER_FLAGS_LPRX_ENA_MSK
))

738 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos,

740 
cmd
.
Õrx_rssi_thªshﬁd
);

742 i‡(!(
cmd
.
Êags
 & 
	`˝u_to_À16
(
POWER_FLAGS_ADVANCE_PM_ENA_MSK
)))

743  
pos
;

745 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "rx_data_timeout_uapsd = %d\n",

746 
	`À32_to_˝u
(
cmd
.
rx_d©a_timeout_u≠sd
));

747 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "tx_data_timeout_uapsd = %d\n",

748 
	`À32_to_˝u
(
cmd
.
tx_d©a_timeout_u≠sd
));

749 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "qndp_tid = %d\n", 
cmd
.
qndp_tid
);

750 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "uapsd_ac_flags = 0x%x\n",

751 
cmd
.
u≠sd_ac_Êags
);

752 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "uapsd_max_sp = %d\n",

753 
cmd
.
u≠sd_max_•
);

754 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "heavy_tx_thld_packets = %d\n",

755 
cmd
.
hóvy_tx_thld_∑ckës
);

756 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "heavy_rx_thld_packets = %d\n",

757 
cmd
.
hóvy_rx_thld_∑ckës
);

758 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "heavy_tx_thld_percentage = %d\n",

759 
cmd
.
hóvy_tx_thld_≥r˚¡age
);

760 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "heavy_rx_thld_percentage = %d\n",

761 
cmd
.
hóvy_rx_thld_≥r˚¡age
);

762 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "uapsd_misbehaving_enable = %d\n",

763 (
cmd
.
Êags
 &

764 
	`˝u_to_À16
(
POWER_FLAGS_UAPSD_MISBEHAVING_ENA_MSK
)) ?

767 i‡(!(
cmd
.
Êags
 & 
	`˝u_to_À16
(
POWER_FLAGS_SNOOZE_ENA_MSK
)))

768  
pos
;

770 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "snooze_interval = %d\n",

771 
cmd
.
¢ooze_öãrvÆ
);

772 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "snooze_window = %d\n",

773 
cmd
.
¢ooze_wödow
);

775  
pos
;

776 
	}
}

779 
	$iwl_mvm_bóc⁄_fûãr_debugfs_∑ømëîs
(
õì80211_vif
 *
vif
,

780 
iwl_bóc⁄_fûãr_cmd
 *
cmd
)

782 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

783 
iwl_dbgfs_bf
 *
dbgfs_bf
 = &
mvmvif
->dbgfs_bf;

785 i‡(
dbgfs_bf
->
mask
 & 
MVM_DEBUGFS_BF_ENERGY_DELTA
)

786 
cmd
->
bf_íîgy_dñè
 = 
	`˝u_to_À32
(
dbgfs_bf
->bf_energy_delta);

787 i‡(
dbgfs_bf
->
mask
 & 
MVM_DEBUGFS_BF_ROAMING_ENERGY_DELTA
)

788 
cmd
->
bf_rﬂmög_íîgy_dñè
 =

789 
	`˝u_to_À32
(
dbgfs_bf
->
bf_rﬂmög_íîgy_dñè
);

790 i‡(
dbgfs_bf
->
mask
 & 
MVM_DEBUGFS_BF_ROAMING_STATE
)

791 
cmd
->
bf_rﬂmög_°©e
 = 
	`˝u_to_À32
(
dbgfs_bf
->bf_roaming_state);

792 i‡(
dbgfs_bf
->
mask
 & 
MVM_DEBUGFS_BF_TEMP_THRESHOLD
)

793 
cmd
->
bf_ãmp_thªshﬁd
 =

794 
	`˝u_to_À32
(
dbgfs_bf
->
bf_ãmp_thªshﬁd
);

795 i‡(
dbgfs_bf
->
mask
 & 
MVM_DEBUGFS_BF_TEMP_FAST_FILTER
)

796 
cmd
->
bf_ãmp_Á°_fûãr
 =

797 
	`˝u_to_À32
(
dbgfs_bf
->
bf_ãmp_Á°_fûãr
);

798 i‡(
dbgfs_bf
->
mask
 & 
MVM_DEBUGFS_BF_TEMP_SLOW_FILTER
)

799 
cmd
->
bf_ãmp_¶ow_fûãr
 =

800 
	`˝u_to_À32
(
dbgfs_bf
->
bf_ãmp_¶ow_fûãr
);

801 i‡(
dbgfs_bf
->
mask
 & 
MVM_DEBUGFS_BF_DEBUG_FLAG
)

802 
cmd
->
bf_debug_Êag
 = 
	`˝u_to_À32
(
dbgfs_bf
->bf_debug_flag);

803 i‡(
dbgfs_bf
->
mask
 & 
MVM_DEBUGFS_BF_ESCAPE_TIMER
)

804 
cmd
->
bf_esˇ≥_timî
 = 
	`˝u_to_À32
(
dbgfs_bf
->bf_escape_timer);

805 i‡(
dbgfs_bf
->
mask
 & 
MVM_DEBUGFS_BA_ESCAPE_TIMER
)

806 
cmd
->
ba_esˇ≥_timî
 = 
	`˝u_to_À32
(
dbgfs_bf
->ba_escape_timer);

807 i‡(
dbgfs_bf
->
mask
 & 
MVM_DEBUGFS_BA_ENABLE_BEACON_ABORT
)

808 
cmd
->
ba_íabÀ_bóc⁄_ab‹t
 =

809 
	`˝u_to_À32
(
dbgfs_bf
->
ba_íabÀ_bóc⁄_ab‹t
);

810 
	}
}

813 
	$_iwl_mvm_íabÀ_bóc⁄_fûãr
(
iwl_mvm
 *
mvm
,

814 
õì80211_vif
 *
vif
,

815 
iwl_bóc⁄_fûãr_cmd
 *
cmd
)

817 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

818 
ªt
;

820 i‡(
mvmvif
 !
mvm
->
bf_Ælowed_vif
 || !
vif
->
bss_c⁄f
.
dtim_≥riod
 ||

821 
vif
->
ty≥
 !
NL80211_IFTYPE_STATION
 || vif->
p2p
)

824 
	`iwl_mvm_bóc⁄_fûãr_£t_cqm_∑øms
(
mvm
, 
vif
, 
cmd
);

825 
	`iwl_mvm_bóc⁄_fûãr_debugfs_∑ømëîs
(
vif
, 
cmd
);

826 
ªt
 = 
	`iwl_mvm_bóc⁄_fûãr_£nd_cmd
(
mvm
, 
cmd
);

828 i‡(!
ªt
)

829 
mvmvif
->
bf_d©a
.
bf_íabÀd
 = 
åue
;

831  
ªt
;

832 
	}
}

834 
	$iwl_mvm_íabÀ_bóc⁄_fûãr
(
iwl_mvm
 *
mvm
,

835 
õì80211_vif
 *
vif
)

837 
iwl_bóc⁄_fûãr_cmd
 
cmd
 = {

838 
IWL_BF_CMD_CONFIG_DEFAULTS
,

839 .
bf_íabÀ_bóc⁄_fûãr
 = 
	`˝u_to_À32
(1),

842  
	`_iwl_mvm_íabÀ_bóc⁄_fûãr
(
mvm
, 
vif
, &
cmd
);

843 
	}
}

845 
	$_iwl_mvm_dißbÀ_bóc⁄_fûãr
(
iwl_mvm
 *
mvm
,

846 
õì80211_vif
 *
vif
)

848 
iwl_bóc⁄_fûãr_cmd
 
cmd
 = {};

849 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

850 
ªt
;

852 i‡(
vif
->
ty≥
 !
NL80211_IFTYPE_STATION
 || vif->
p2p
)

855 
ªt
 = 
	`iwl_mvm_bóc⁄_fûãr_£nd_cmd
(
mvm
, &
cmd
);

857 i‡(!
ªt
)

858 
mvmvif
->
bf_d©a
.
bf_íabÀd
 = 
Ál£
;

860  
ªt
;

861 
	}
}

863 
	$iwl_mvm_dißbÀ_bóc⁄_fûãr
(
iwl_mvm
 *
mvm
,

864 
õì80211_vif
 *
vif
)

866  
	`_iwl_mvm_dißbÀ_bóc⁄_fûãr
(
mvm
, 
vif
);

867 
	}
}

869 
	$iwl_mvm_powî_£t_ps
(
iwl_mvm
 *
mvm
)

871 
boﬁ
 
dißbÀ_ps
;

872 
ªt
;

875 
dißbÀ_ps
 = (
iwlmvm_mod_∑øms
.
powî_scheme
 =
IWL_POWER_SCHEME_CAM
);

877 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s_©omic
(
mvm
->
hw
,

878 
IEEE80211_IFACE_ITER_NORMAL
,

879 
iwl_mvm_powî_ps_dißbÀd_ôî©‹
,

880 &
dißbÀ_ps
);

883 i‡(
mvm
->
ps_dißbÀd
 !
dißbÀ_ps
) {

884 
boﬁ
 
ﬁd_ps_dißbÀd
 = 
mvm
->
ps_dißbÀd
;

886 
mvm
->
ps_dißbÀd
 = 
dißbÀ_ps
;

887 
ªt
 = 
	`iwl_mvm_powî_upd©e_devi˚
(
mvm
);

888 i‡(
ªt
) {

889 
mvm
->
ps_dißbÀd
 = 
ﬁd_ps_dißbÀd
;

890  
ªt
;

895 
	}
}

897 
	$iwl_mvm_powî_£t_ba
(
iwl_mvm
 *
mvm
,

898 
õì80211_vif
 *
vif
)

900 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

901 
iwl_bóc⁄_fûãr_cmd
 
cmd
 = {

902 
IWL_BF_CMD_CONFIG_DEFAULTS
,

903 .
bf_íabÀ_bóc⁄_fûãr
 = 
	`˝u_to_À32
(1),

906 i‡(!
mvmvif
->
bf_d©a
.
bf_íabÀd
)

909 i‡(
	`ã°_bô
(
IWL_MVM_STATUS_IN_D3
, &
mvm
->
°©us
))

910 
cmd
.
ba_esˇ≥_timî
 = 
	`˝u_to_À32
(
IWL_BA_ESCAPE_TIMER_D3
);

912 
mvmvif
->
bf_d©a
.
ba_íabÀd
 = !(!mvmvif->
pm_íabÀd
 ||

913 
mvm
->
ps_dißbÀd
 ||

914 !
vif
->
cfg
.
ps
 ||

915 
	`iwl_mvm_vif_low_œãncy
(
mvmvif
));

917  
	`_iwl_mvm_íabÀ_bóc⁄_fûãr
(
mvm
, 
vif
, &
cmd
);

918 
	}
}

920 
	$iwl_mvm_powî_upd©e_ps
(
iwl_mvm
 *
mvm
)

922 
iwl_powî_vifs
 
vifs
 = {

923 .
mvm
 = mvm,

925 
ªt
;

927 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

930 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s_©omic
(
mvm
->
hw
,

931 
IEEE80211_IFACE_ITER_NORMAL
,

932 
iwl_mvm_powî_gë_vifs_ôî©‹
, &
vifs
);

934 
ªt
 = 
	`iwl_mvm_powî_£t_ps
(
mvm
);

935 i‡(
ªt
)

936  
ªt
;

938 i‡(
vifs
.
bss_vif
)

939  
	`iwl_mvm_powî_£t_ba
(
mvm
, 
vifs
.
bss_vif
);

942 
	}
}

944 
	$iwl_mvm_powî_upd©e_mac
(
iwl_mvm
 *
mvm
)

946 
iwl_powî_vifs
 
vifs
 = {

947 .
mvm
 = mvm,

949 
ªt
;

951 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

954 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s_©omic
(
mvm
->
hw
,

955 
IEEE80211_IFACE_ITER_NORMAL
,

956 
iwl_mvm_powî_gë_vifs_ôî©‹
, &
vifs
);

958 
	`iwl_mvm_powî_£t_pm
(
mvm
, &
vifs
);

960 
ªt
 = 
	`iwl_mvm_powî_£t_ps
(
mvm
);

961 i‡(
ªt
)

962  
ªt
;

964 i‡(
vifs
.
bss_vif
) {

965 
ªt
 = 
	`iwl_mvm_powî_£nd_cmd
(
mvm
, 
vifs
.
bss_vif
);

966 i‡(
ªt
)

967  
ªt
;

970 i‡(
vifs
.
p2p_vif
) {

971 
ªt
 = 
	`iwl_mvm_powî_£nd_cmd
(
mvm
, 
vifs
.
p2p_vif
);

972 i‡(
ªt
)

973  
ªt
;

976 i‡(
vifs
.
bss_vif
)

977  
	`iwl_mvm_powî_£t_ba
(
mvm
, 
vifs
.
bss_vif
);

980 
	}
}

	@ptp.c

6 
	~"mvm.h
"

7 
	~"iwl-debug.h
"

8 
	~<löux/timekìpög.h
>

9 
	~<löux/m©h64.h
>

11 
	#IWL_PTP_GP2_WRAP
 0x100000000ULL

	)

12 
	#IWL_PTP_WRAP_TIME
 (3600 * 
HZ
)

	)

18 
	#SCALE_FACTOR
 65536000000ULL

	)

19 
	#IWL_PTP_WRAP_THRESHOLD_USEC
 (5000)

	)

21 
	#IWL_PTP_GET_CROSS_TS_NUM
 5

	)

23 
	$iwl_mvm_±p_upd©e_√w_ªad
(
iwl_mvm
 *
mvm
, 
u32
 
gp2
)

28 i‡(
gp2
 < 
mvm
->
±p_d©a
.
œ°_gp2
 &&

29 
mvm
->
±p_d©a
.
œ°_gp2
 - 
gp2
 < 
IWL_PTP_WRAP_THRESHOLD_USEC
) {

30 
	`IWL_DEBUG_INFO
(
mvm
,

32 
gp2
, 
mvm
->
±p_d©a
.
œ°_gp2
);

36 i‡(
gp2
 < 
mvm
->
±p_d©a
.
œ°_gp2
) {

37 
mvm
->
±p_d©a
.
wøp_cou¡î
++;

38 
	`IWL_DEBUG_INFO
(
mvm
,

40 
mvm
->
±p_d©a
.
wøp_cou¡î
);

43 
mvm
->
±p_d©a
.
œ°_gp2
 = 
gp2
;

44 
	`scheduÀ_dñayed_w‹k
(&
mvm
->
±p_d©a
.
dw‹k
, 
IWL_PTP_WRAP_TIME
);

45 
	}
}

47 
u64
 
	$iwl_mvm_±p_gë_adj_time
(
iwl_mvm
 *
mvm
, 
u64
 
ba£_time_ns
)

49 
±p_d©a
 *
d©a
 = &
mvm
->ptp_data;

50 
u64
 
œ°_gp2_ns
 = 
mvm
->
±p_d©a
.
sˇÀ_upd©e_gp2
 * 
NSEC_PER_USEC
;

51 
u64
 
ªs
;

52 
u64
 
diff
;

54 
	`iwl_mvm_±p_upd©e_√w_ªad
(
mvm
,

55 
	`div64_u64
(
ba£_time_ns
, 
NSEC_PER_USEC
));

57 
	`IWL_DEBUG_INFO
(
mvm
, "base_time_ns=%llu, wrap_counter=%u\n",

58 ()
ba£_time_ns
, 
d©a
->
wøp_cou¡î
);

60 
ba£_time_ns
 = base_time_ns +

61 (
d©a
->
wøp_cou¡î
 * 
IWL_PTP_GP2_WRAP
 * 
NSEC_PER_USEC
);

66 i‡(
ba£_time_ns
 < 
œ°_gp2_ns
) {

67 
	`IWL_DEBUG_INFO
(
mvm
, "Time before scale update - ignore\n");

71 
diff
 = 
ba£_time_ns
 - 
œ°_gp2_ns
;

72 
	`IWL_DEBUG_INFO
(
mvm
, "dif‡ns=%Œu\n", ()
diff
);

74 
diff
 = 
	`mul_u64_u64_div_u64
(diff, 
d©a
->
sˇÀd_‰eq
,

75 
SCALE_FACTOR
);

76 
	`IWL_DEBUG_INFO
(
mvm
, "sˇÀd dif‡ns=%Œu\n", ()
diff
);

78 
ªs
 = 
d©a
->
sˇÀ_upd©e_adj_time_ns
 + d©a->
dñè
 + 
diff
;

80 
	`IWL_DEBUG_INFO
(
mvm
, "base=%llu delta=%lldádj=%llu\n",

81 ()
ba£_time_ns
, ()
d©a
->
dñè
,

82 ()
ªs
);

83  
ªs
;

84 
	}
}

87 
	$iwl_mvm_gë_¸os°ime°amp_fw
(
iwl_mvm
 *
mvm
, 
u32
 *
gp2
, 
u64
 *
sys_time
)

89 
iwl_syn˚d_time_cmd
 
syn˚d_time_cmd
 = {

90 .
›î©i⁄
 = 
	`˝u_to_À32
(
IWL_SYNCED_TIME_OPERATION_READ_BOTH
)

92 
iwl_ho°_cmd
 
cmd
 = {

93 .
id
 = 
	`WIDE_ID
(
DATA_PATH_GROUP
, 
WNM_PLATFORM_PTM_REQUEST_CMD
),

94 .
Êags
 = 
CMD_WANT_SKB
,

95 .
d©a
[0] = &
syn˚d_time_cmd
,

96 .
Àn
[0] = (
syn˚d_time_cmd
),

98 
iwl_syn˚d_time_r•
 *
ª•
;

99 
iwl_rx_∑ckë
 *
pkt
;

100 
ªt
;

101 
u64
 
gp2_10ns
;

103 
ªt
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
cmd
);

104 i‡(
ªt
)

105  
ªt
;

107 
pkt
 = 
cmd
.
ª•_pkt
;

109 i‡(
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
Ë!(*
ª•
)) {

110 
	`IWL_ERR
(
mvm
, "PTP: Invalid commandÑesponse\n");

111 
	`iwl_‰ì_ª•
(&
cmd
);

112  -
EIO
;

115 
ª•
 = (*)
pkt
->
d©a
;

117 
gp2_10ns
 = (
u64
)
	`À32_to_˝u
(
ª•
->
gp2_time°amp_hi
) << 32 |

118 
	`À32_to_˝u
(
ª•
->
gp2_time°amp_lo
);

119 *
gp2
 = 
	`div_u64
(
gp2_10ns
, 100);

121 *
sys_time
 = (
u64
)
	`À32_to_˝u
(
ª•
->
∂©f‹m_time°amp_hi
) << 32 |

122 
	`À32_to_˝u
(
ª•
->
∂©f‹m_time°amp_lo
);

124  
ªt
;

125 
	}
}

127 
	$iwl_mvm_phc_gë_¸os°ime°amp_lo›
(
iwl_mvm
 *
mvm
,

128 
ktime_t
 *
sys_time
, 
u32
 *
gp2
)

130 
u64
 
diff
 = 0, 
√w_diff
;

131 
u64
 
tmp_sys_time
;

132 
u32
 
tmp_gp2
;

133 
i
;

135 
i
 = 0; i < 
IWL_PTP_GET_CROSS_TS_NUM
; i++) {

136 
	`iwl_mvm_gë_sync_time
(
mvm
, 
CLOCK_REALTIME
, &
tmp_gp2
, 
NULL
,

137 &
tmp_sys_time
);

138 
√w_diff
 = 
tmp_sys_time
 - ((
u64
)
tmp_gp2
 * 
NSEC_PER_USEC
);

139 i‡(!
diff
 || 
√w_diff
 < diff) {

140 *
sys_time
 = 
tmp_sys_time
;

141 *
gp2
 = 
tmp_gp2
;

142 
diff
 = 
√w_diff
;

143 
	`IWL_DEBUG_INFO
(
mvm
, "PTP:ÇewÅimes: gp2=%u sys=%lld\n",

144 *
gp2
, *
sys_time
);

147 
	}
}

150 
	$iwl_mvm_phc_gë_¸os°ime°amp
(
±p_˛ock_öfo
 *
±p
,

151 
sy°em_devi˚_¸os°°amp
 *
xt°amp
)

153 
iwl_mvm
 *
mvm
 = 
	`c⁄èöî_of
(
±p
, iwl_mvm,

154 
±p_d©a
.
±p_˛ock_öfo
);

155 
ªt
 = 0;

157 
u32
 
gp2
;

159 
s64
 
gp2_ns
;

161 
ktime_t
 
sys_time
;

163 
	`mem£t
(
xt°amp
, 0, (
sy°em_devi˚_¸os°°amp
));

165 i‡(!
mvm
->
±p_d©a
.
±p_˛ock
) {

166 
	`IWL_ERR
(
mvm
, "No PHC clockÑegistered\n");

167  -
ENODEV
;

170 
	`muãx_lock
(&
mvm
->
muãx
);

171 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_CAPA_SYNCED_TIME
)) {

172 
ªt
 = 
	`iwl_mvm_gë_¸os°ime°amp_fw
(
mvm
, &
gp2
, &
sys_time
);

174 i‡(
ªt
)

175 
out
;

177 
	`iwl_mvm_phc_gë_¸os°ime°amp_lo›
(
mvm
, &
sys_time
, &
gp2
);

180 
gp2_ns
 = 
	`iwl_mvm_±p_gë_adj_time
(
mvm
, (
u64
)
gp2
 * 
NSEC_PER_USEC
);

182 
	`IWL_INFO
(
mvm
, "Got Sync Time: GP2:%u,Üast_GP2: %u, GP2_ns: %lld, sys_time: %lld\n",

183 
gp2
, 
mvm
->
±p_d©a
.
œ°_gp2
, 
gp2_ns
, (
s64
)
sys_time
);

186 
xt°amp
->
devi˚
 = (
ktime_t
)
gp2_ns
;

187 
xt°amp
->
sys_ªÆtime
 = 
sys_time
;

189 
out
:

190 
	`muãx_u∆ock
(&
mvm
->
muãx
);

191  
ªt
;

192 
	}
}

194 
	$iwl_mvm_±p_w‹k
(
w‹k_°ru˘
 *
wk
)

196 
iwl_mvm
 *
mvm
 = 
	`c⁄èöî_of
(
wk
, iwl_mvm,

197 
±p_d©a
.
dw‹k
.
w‹k
);

198 
u32
 
gp2
;

200 
	`muãx_lock
(&
mvm
->
muãx
);

201 
gp2
 = 
	`iwl_mvm_gë_sy°ime
(
mvm
);

202 
	`iwl_mvm_±p_upd©e_√w_ªad
(
mvm
, 
gp2
);

203 
	`muãx_u∆ock
(&
mvm
->
muãx
);

204 
	}
}

206 
	$iwl_mvm_±p_gëtime
(
±p_˛ock_öfo
 *
±p
,

207 
time•ec64
 *
ts
)

209 
iwl_mvm
 *
mvm
 = 
	`c⁄èöî_of
(
±p
, iwl_mvm,

210 
±p_d©a
.
±p_˛ock_öfo
);

211 
u64
 
gp2
;

212 
u64
 
ns
;

214 
	`muãx_lock
(&
mvm
->
muãx
);

215 
gp2
 = 
	`iwl_mvm_gë_sy°ime
(
mvm
);

216 
ns
 = 
	`iwl_mvm_±p_gë_adj_time
(
mvm
, 
gp2
 * 
NSEC_PER_USEC
);

217 
	`muãx_u∆ock
(&
mvm
->
muãx
);

219 *
ts
 = 
	`ns_to_time•ec64
(
ns
);

221 
	}
}

223 
	$iwl_mvm_±p_adjtime
(
±p_˛ock_öfo
 *
±p
, 
s64
 
dñè
)

225 
iwl_mvm
 *
mvm
 = 
	`c⁄èöî_of
(
±p
, iwl_mvm,

226 
±p_d©a
.
±p_˛ock_öfo
);

227 
±p_d©a
 *
d©a
 = 
	`c⁄èöî_of
(
±p
, ptp_data,

228 
±p_˛ock_öfo
);

230 
	`muãx_lock
(&
mvm
->
muãx
);

231 
d©a
->
dñè
 += delta;

232 
	`IWL_DEBUG_INFO
(
mvm
, "dñè=%Œd,Çew dñè=%Œd\n", ()
dñè
,

233 ()
d©a
->
dñè
);

234 
	`muãx_u∆ock
(&
mvm
->
muãx
);

236 
	}
}

238 
	$iwl_mvm_±p_adjföe
(
±p_˛ock_öfo
 *
±p
, 
sˇÀd_µm
)

240 
iwl_mvm
 *
mvm
 = 
	`c⁄èöî_of
(
±p
, iwl_mvm,

241 
±p_d©a
.
±p_˛ock_öfo
);

242 
±p_d©a
 *
d©a
 = &
mvm
->ptp_data;

243 
u32
 
gp2
;

245 
	`muãx_lock
(&
mvm
->
muãx
);

251 
gp2
 = 
	`iwl_mvm_gë_sy°ime
(
mvm
);

252 
d©a
->
sˇÀ_upd©e_adj_time_ns
 =

253 
	`iwl_mvm_±p_gë_adj_time
(
mvm
, 
gp2
 * 
NSEC_PER_USEC
);

254 
d©a
->
sˇÀ_upd©e_gp2
 = 
gp2
;

255 
d©a
->
wøp_cou¡î
 = 0;

256 
d©a
->
dñè
 = 0;

258 
d©a
->
sˇÀd_‰eq
 = 
SCALE_FACTOR
 + 
sˇÀd_µm
;

259 
	`IWL_DEBUG_INFO
(
mvm
, "adjfine: scaled_ppm=%ldÇew=%llu\n",

260 
sˇÀd_µm
, ()
d©a
->
sˇÀd_‰eq
);

262 
	`muãx_u∆ock
(&
mvm
->
muãx
);

264 
	}
}

271 
	$iwl_mvm_±p_öô
(
iwl_mvm
 *
mvm
)

274 i‡(
	`WARN_ON
(
mvm
->
±p_d©a
.
±p_˛ock
))

277 
mvm
->
±p_d©a
.
±p_˛ock_öfo
.
ow√r
 = 
THIS_MODULE
;

278 
mvm
->
±p_d©a
.
±p_˛ock_öfo
.
max_adj
 = 0x7fffffff;

279 
mvm
->
±p_d©a
.
±p_˛ock_öfo
.
gë¸os°°amp
 =

280 
iwl_mvm_phc_gë_¸os°ime°amp
;

281 
mvm
->
±p_d©a
.
±p_˛ock_öfo
.
adjföe
 = 
iwl_mvm_±p_adjföe
;

282 
mvm
->
±p_d©a
.
±p_˛ock_öfo
.
adjtime
 = 
iwl_mvm_±p_adjtime
;

283 
mvm
->
±p_d©a
.
±p_˛ock_öfo
.
gëtime64
 = 
iwl_mvm_±p_gëtime
;

284 
mvm
->
±p_d©a
.
sˇÀd_‰eq
 = 
SCALE_FACTOR
;

287 
	`¢¥ötf
(
mvm
->
±p_d©a
.
±p_˛ock_öfo
.
«me
,

288 (
mvm
->
±p_d©a
.
±p_˛ock_öfo
.
«me
),

291 
	`INIT_DELAYED_WORK
(&
mvm
->
±p_d©a
.
dw‹k
, 
iwl_mvm_±p_w‹k
);

293 
mvm
->
±p_d©a
.
±p_˛ock
 =

294 
	`±p_˛ock_ªgi°î
(&
mvm
->
±p_d©a
.
±p_˛ock_öfo
, mvm->
dev
);

296 i‡(
	`IS_ERR
(
mvm
->
±p_d©a
.
±p_˛ock
)) {

297 
	`IWL_ERR
(
mvm
, "FailedÅoÑegister PHC clock (%ld)\n",

298 
	`PTR_ERR
(
mvm
->
±p_d©a
.
±p_˛ock
));

299 
mvm
->
±p_d©a
.
±p_˛ock
 = 
NULL
;

300 } i‡(
mvm
->
±p_d©a
.
±p_˛ock
) {

301 
	`IWL_INFO
(
mvm
, "Registered PHC clock: %s, with index: %d\n",

302 
mvm
->
±p_d©a
.
±p_˛ock_öfo
.
«me
,

303 
	`±p_˛ock_ödex
(
mvm
->
±p_d©a
.
±p_˛ock
));

305 
	}
}

312 
	$iwl_mvm_±p_ªmove
(
iwl_mvm
 *
mvm
)

314 i‡(
mvm
->
±p_d©a
.
±p_˛ock
) {

315 
	`IWL_INFO
(
mvm
, "Unregistering PHC clock: %s, with index: %d\n",

316 
mvm
->
±p_d©a
.
±p_˛ock_öfo
.
«me
,

317 
	`±p_˛ock_ödex
(
mvm
->
±p_d©a
.
±p_˛ock
));

319 
	`±p_˛ock_uƒegi°î
(
mvm
->
±p_d©a
.
±p_˛ock
);

320 
mvm
->
±p_d©a
.
±p_˛ock
 = 
NULL
;

321 
	`mem£t
(&
mvm
->
±p_d©a
.
±p_˛ock_öfo
, 0,

322 (
mvm
->
±p_d©a
.
±p_˛ock_öfo
));

323 
mvm
->
±p_d©a
.
œ°_gp2
 = 0;

324 
	`ˇn˚l_dñayed_w‹k_sync
(&
mvm
->
±p_d©a
.
dw‹k
);

326 
	}
}

	@quota.c

7 
	~<√t/mac80211.h
>

8 
	~"fw-≠i.h
"

9 
	~"mvm.h
"

11 
	#QUOTA_100
 
IWL_MVM_MAX_QUOTA


	)

12 
	#QUOTA_LOWLAT_MIN
 ((
QUOTA_100
 * 
IWL_MVM_LOWLAT_QUOTA_MIN_PERCENT
Ë/ 100)

	)

14 
	siwl_mvm_quŸa_ôî©‹_d©a
 {

15 
	mn_öãrÁ˚s
[
MAX_BINDINGS
];

16 
	mcﬁ‹s
[
MAX_BINDINGS
];

17 
	mlow_œãncy
[
MAX_BINDINGS
];

18 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


19 
	mdbgfs_mö
[
MAX_BINDINGS
];

21 
	mn_low_œãncy_bödögs
;

22 
õì80211_vif
 *
	mdißbÀd_vif
;

25 
	$iwl_mvm_quŸa_ôî©‹
(*
_d©a
, 
u8
 *
mac
,

26 
õì80211_vif
 *
vif
)

28 
iwl_mvm_quŸa_ôî©‹_d©a
 *
d©a
 = 
_d©a
;

29 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

30 
u16
 
id
;

33 i‡(
vif
 =
d©a
->
dißbÀd_vif
)

36 i‡(!
mvmvif
->
deÊök
.
phy_˘xt
)

40 
id
 = 
mvmvif
->
deÊök
.
phy_˘xt
->id;

43 
	`BUILD_BUG_ON
(
NUM_PHY_CTX
 > 
MAX_BINDINGS
);

45 i‡(
	`WARN_ON_ONCE
(
id
 >
MAX_BINDINGS
))

48 
vif
->
ty≥
) {

49 
NL80211_IFTYPE_STATION
:

50 i‡(
vif
->
cfg
.
assoc
)

53 
NL80211_IFTYPE_AP
:

54 
NL80211_IFTYPE_ADHOC
:

55 i‡(
mvmvif
->
≠_ibss_a˘ive
)

58 
NL80211_IFTYPE_MONITOR
:

59 i‡(
mvmvif
->
m⁄ô‹_a˘ive
)

62 
NL80211_IFTYPE_P2P_DEVICE
:

65 
	`WARN_ON_ONCE
(1);

69 i‡(
d©a
->
cﬁ‹s
[
id
] < 0)

70 
d©a
->
cﬁ‹s
[
id
] = 
mvmvif
->
deÊök
.
phy_˘xt
->
cﬁ‹
;

72 
	`WARN_ON_ONCE
(
d©a
->
cﬁ‹s
[
id
] !=

73 
mvmvif
->
deÊök
.
phy_˘xt
->
cﬁ‹
);

75 
d©a
->
n_öãrÁ˚s
[
id
]++;

77 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


78 i‡(
mvmvif
->
dbgfs_quŸa_mö
)

79 
d©a
->
dbgfs_mö
[
id
] = 
	`max
(data->dbgfs_min[id],

80 
mvmvif
->
dbgfs_quŸa_mö
);

83 i‡(
	`iwl_mvm_vif_low_œãncy
(
mvmvif
Ë&& !
d©a
->
low_œãncy
[
id
]) {

84 
d©a
->
n_low_œãncy_bödögs
++;

85 
d©a
->
low_œãncy
[
id
] = 
åue
;

87 
	}
}

89 
	$iwl_mvm_adju°_quŸa_f‹_nﬂ
(
iwl_mvm
 *
mvm
,

90 
iwl_time_quŸa_cmd
 *
cmd
)

92 #ifde‡
CONFIG_NL80211_TESTMODE


93 
iwl_mvm_vif
 *
mvmvif
;

94 
i
, 
phy_id
 = -1, 
bóc⁄_öt
 = 0;

96 i‡(!
mvm
->
nﬂ_duøti⁄
 || !mvm->
nﬂ_vif
)

99 
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
mvm
->
nﬂ_vif
);

100 i‡(!
mvmvif
->
≠_ibss_a˘ive
)

103 
phy_id
 = 
mvmvif
->
deÊök
.
phy_˘xt
->
id
;

104 
bóc⁄_öt
 = 
mvm
->
nﬂ_vif
->
bss_c⁄f
.beacon_int;

106 
i
 = 0; i < 
MAX_BINDINGS
; i++) {

107 
iwl_time_quŸa_d©a
 *
d©a
 =

108 
	`iwl_mvm_quŸa_cmd_gë_quŸa
(
mvm
, 
cmd
,

109 
i
);

110 
u32
 
id_n_c
 = 
	`À32_to_˝u
(
d©a
->
id_™d_cﬁ‹
);

111 
u32
 
id
 = (
id_n_c
 & 
FW_CTXT_ID_MSK
Ë>> 
FW_CTXT_ID_POS
;

112 
u32
 
quŸa
 = 
	`À32_to_˝u
(
d©a
->quota);

114 i‡(
id
 !
phy_id
)

117 
quŸa
 *(
bóc⁄_öt
 - 
mvm
->
nﬂ_duøti⁄
);

118 
quŸa
 /
bóc⁄_öt
;

120 
	`IWL_DEBUG_QUOTA
(
mvm
, "quota:ádjust for NoA from %dÅo %d\n",

121 
	`À32_to_˝u
(
d©a
->
quŸa
), quota);

123 
d©a
->
quŸa
 = 
	`˝u_to_À32
(quota);

126 
	}
}

128 
	$iwl_mvm_upd©e_quŸas
(
iwl_mvm
 *
mvm
,

129 
boﬁ
 
f‹˚_upd©e
,

130 
õì80211_vif
 *
dißbÀd_vif
)

132 
iwl_time_quŸa_cmd
 
cmd
 = {};

133 
i
, 
idx
, 
îr
, 
num_a˘ive_macs
, 
quŸa
, 
quŸa_ªm
, 
n_n⁄_lowœt
;

134 
iwl_mvm_quŸa_ôî©‹_d©a
 
d©a
 = {

135 .
n_öãrÁ˚s
 = {},

136 .
cﬁ‹s
 = { -1, -1, -1, -1 },

137 .
dißbÀd_vif
 = disabled_vif,

139 
iwl_time_quŸa_cmd
 *
œ°
 = &
mvm
->
œ°_quŸa_cmd
;

140 
iwl_time_quŸa_d©a
 *
qd©a
, *
œ°_d©a
;

141 
boﬁ
 
£nd
 = 
Ál£
;

143 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

145 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

146 
IWL_UCODE_TLV_CAPA_DYNAMIC_QUOTA
))

150 i‡(
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
))

154 
	`BUILD_BUG_ON
(
MAX_BINDINGS
 != 4);

156 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s_©omic
(

157 
mvm
->
hw
, 
IEEE80211_IFACE_ITER_NORMAL
,

158 
iwl_mvm_quŸa_ôî©‹
, &
d©a
);

165 
num_a˘ive_macs
 = 0;

166 
i
 = 0; i < 
MAX_BINDINGS
; i++) {

167 
qd©a
 = 
	`iwl_mvm_quŸa_cmd_gë_quŸa
(
mvm
, &
cmd
, 
i
);

168 
qd©a
->
id_™d_cﬁ‹
 = 
	`˝u_to_À32
(
FW_CTXT_INVALID
);

169 
num_a˘ive_macs
 +
d©a
.
n_öãrÁ˚s
[
i
];

172 
n_n⁄_lowœt
 = 
num_a˘ive_macs
;

174 i‡(
d©a
.
n_low_œãncy_bödögs
 == 1) {

175 
i
 = 0; i < 
MAX_BINDINGS
; i++) {

176 i‡(
d©a
.
low_œãncy
[
i
]) {

177 
n_n⁄_lowœt
 -
d©a
.
n_öãrÁ˚s
[
i
];

183 i‡(
d©a
.
n_low_œãncy_bödögs
 =1 && 
n_n⁄_lowœt
) {

190 
quŸa
 = (
QUOTA_100
 - 
QUOTA_LOWLAT_MIN
Ë/ 
n_n⁄_lowœt
;

191 
quŸa_ªm
 = 
QUOTA_100
 - 
n_n⁄_lowœt
 * 
quŸa
 -

192 
QUOTA_LOWLAT_MIN
;

193 
	`IWL_DEBUG_QUOTA
(
mvm
,

195 
quŸa
);

196 } i‡(
num_a˘ive_macs
) {

202 
quŸa
 = 
QUOTA_100
 / 
num_a˘ive_macs
;

203 
quŸa_ªm
 = 
QUOTA_100
 % 
num_a˘ive_macs
;

204 
	`IWL_DEBUG_QUOTA
(
mvm
,

206 
quŸa
);

209 
quŸa
 = 0;

210 
quŸa_ªm
 = 0;

213 
idx
 = 0, 
i
 = 0; i < 
MAX_BINDINGS
; i++) {

214 i‡(
d©a
.
cﬁ‹s
[
i
] < 0)

217 
qd©a
 = 
	`iwl_mvm_quŸa_cmd_gë_quŸa
(
mvm
, &
cmd
, 
idx
);

219 
qd©a
->
id_™d_cﬁ‹
 =

220 
	`˝u_to_À32
(
	`FW_CMD_ID_AND_COLOR
(
i
, 
d©a
.
cﬁ‹s
[i]));

222 i‡(
d©a
.
n_öãrÁ˚s
[
i
] <= 0)

223 
qd©a
->
quŸa
 = 
	`˝u_to_À32
(0);

224 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


225 i‡(
d©a
.
dbgfs_mö
[
i
])

226 
qd©a
->
quŸa
 =

227 
	`˝u_to_À32
(
d©a
.
dbgfs_mö
[
i
] * 
QUOTA_100
 / 100);

229 i‡(
d©a
.
n_low_œãncy_bödögs
 =1 && 
n_n⁄_lowœt
 &&

230 
d©a
.
low_œãncy
[
i
])

237 
qd©a
->
quŸa
 = 
	`˝u_to_À32
(
QUOTA_LOWLAT_MIN
);

239 
qd©a
->
quŸa
 =

240 
	`˝u_to_À32
(
quŸa
 * 
d©a
.
n_öãrÁ˚s
[
i
]);

242 
	`WARN_ONCE
(
	`À32_to_˝u
(
qd©a
->
quŸa
Ë> 
QUOTA_100
,

244 
idx
, 
	`À32_to_˝u
(
qd©a
->
quŸa
), 
QUOTA_100
);

246 
qd©a
->
max_duøti⁄
 = 
	`˝u_to_À32
(0);

248 
idx
++;

252 
i
 = 0; i < 
MAX_BINDINGS
; i++) {

253 
qd©a
 = 
	`iwl_mvm_quŸa_cmd_gë_quŸa
(
mvm
, &
cmd
, 
i
);

254 i‡(
	`À32_to_˝u
(
qd©a
->
quŸa
) != 0) {

255 
	`À32_add_˝u
(&
qd©a
->
quŸa
, 
quŸa_ªm
);

256 
	`IWL_DEBUG_QUOTA
(
mvm
,

258 
quŸa_ªm
, 
i
);

263 
	`iwl_mvm_adju°_quŸa_f‹_nﬂ
(
mvm
, &
cmd
);

266 
i
 = 0; i < 
MAX_BINDINGS
; i++) {

267 
qd©a
 = 
	`iwl_mvm_quŸa_cmd_gë_quŸa
(
mvm
, &
cmd
, 
i
);

268 
œ°_d©a
 = 
	`iwl_mvm_quŸa_cmd_gë_quŸa
(
mvm
, 
œ°
, 
i
);

269 i‡(
qd©a
->
id_™d_cﬁ‹
 !
œ°_d©a
->id_and_color)

270 
£nd
 = 
åue
;

271 i‡(
qd©a
->
max_duøti⁄
 !
œ°_d©a
->max_duration)

272 
£nd
 = 
åue
;

273 i‡(
	`abs
(()
	`À32_to_˝u
(
qd©a
->
quŸa
) -

274 ()
	`À32_to_˝u
(
œ°_d©a
->
quŸa
))

275 > 
IWL_MVM_QUOTA_THRESHOLD
)

276 
£nd
 = 
åue
;

277 i‡(
qd©a
->
id_™d_cﬁ‹
 =
	`˝u_to_À32
(
FW_CTXT_INVALID
))

279 
	`WARN_ONCE
(
qd©a
->
quŸa
 == 0,

280 "zîÿquŸ®⁄ bödög %d\n", 
i
);

283 i‡(!
£nd
 && !
f‹˚_upd©e
) {

291 
îr
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
TIME_QUOTA_CMD
, 0,

292 
	`iwl_mvm_quŸa_cmd_size
(
mvm
), &
cmd
);

294 i‡(
îr
)

295 
	`IWL_ERR
(
mvm
, "FaûedÅÿ£nd quŸa: %d\n", 
îr
);

297 
mvm
->
œ°_quŸa_cmd
 = 
cmd
;

298  
îr
;

299 
	}
}

	@rfi.c

6 
	~"mvm.h
"

7 
	~"fw/≠i/comm™ds.h
"

8 
	~"fw/≠i/phy-˘xt.h
"

14 c⁄° 
iwl_rfi_lut_íåy
 
	giwl_rfi_èbÀ
[
IWL_RFI_LUT_SIZE
] = {

16 {
˝u_to_À16
(160), {50, 58, 60, 62, 64, 52, 54, 56},

17 {
PHY_BAND_5
, PHY_BAND_5, PHY_BAND_5, PHY_BAND_5, PHY_BAND_5,

18 
PHY_BAND_5
, PHY_BAND_5, PHY_BAND_5,}},

21 {
˝u_to_À16
(176), {149, 151, 153, 157, 159, 161, 165, 163, 167, 169,

23 {
PHY_BAND_5
, PHY_BAND_5, PHY_BAND_5, PHY_BAND_5, PHY_BAND_5,

24 
PHY_BAND_5
, PHY_BAND_5, PHY_BAND_5, PHY_BAND_5, PHY_BAND_5,

25 
PHY_BAND_5
, PHY_BAND_5, PHY_BAND_5,}},

28 {
˝u_to_À16
(192), {79, 81, 83, 85, 87, 89, 91, 93},

29 {
PHY_BAND_6
, PHY_BAND_6, PHY_BAND_6, PHY_BAND_6, PHY_BAND_6,

30 
PHY_BAND_6
, PHY_BAND_6, PHY_BAND_6,}},

33 {
˝u_to_À16
(223), {114, 116, 118, 120, 122, 106, 110, 124, 126},

34 {
PHY_BAND_5
, PHY_BAND_5, PHY_BAND_5, PHY_BAND_5, PHY_BAND_5,

35 
PHY_BAND_5
, PHY_BAND_5, PHY_BAND_5, PHY_BAND_5,}},

38 {
˝u_to_À16
(240), {114, 151, 155, 157, 159, 161, 165},

39 {
PHY_BAND_5
, PHY_BAND_5, PHY_BAND_5, PHY_BAND_5, PHY_BAND_5,

40 
PHY_BAND_5
, PHY_BAND_5,}},

43 {
˝u_to_À16
(256), {79, 83, 85, 87, 89, 91, 93,},

44 {
PHY_BAND_6
, PHY_BAND_6, PHY_BAND_6, PHY_BAND_6, PHY_BAND_6,

45 
PHY_BAND_6
, PHY_BAND_6,}},

48 {
˝u_to_À16
(264), {111, 119, 123, 125, 129, 131, 133, 135, 143,},

49 {
PHY_BAND_6
, PHY_BAND_6, PHY_BAND_6, PHY_BAND_6, PHY_BAND_6,

50 
PHY_BAND_6
, PHY_BAND_6, PHY_BAND_6, PHY_BAND_6,}},

53 {
˝u_to_À16
(312), {36, 38, 40, 42, 44, 46, 50,},

54 {
PHY_BAND_5
, PHY_BAND_5, PHY_BAND_5, PHY_BAND_5, PHY_BAND_5,

55 
PHY_BAND_5
, PHY_BAND_5,}},

58 {
˝u_to_À16
(336), {106, 110, 112, 114, 116, 118, 120, 122},

59 {
PHY_BAND_5
, PHY_BAND_5, PHY_BAND_5, PHY_BAND_5, PHY_BAND_5,

60 
PHY_BAND_5
, PHY_BAND_5, PHY_BAND_5,}},

63 {
˝u_to_À16
(360), {3, 5, 7, 9, 11, 13, 15,},

64 {
PHY_BAND_6
, PHY_BAND_6, PHY_BAND_6, PHY_BAND_6, PHY_BAND_6,

65 
PHY_BAND_6
, PHY_BAND_6,}},

68 {
˝u_to_À16
(384), {79, 83, 85, 87, 89, 91, 93,},

69 {
PHY_BAND_6
, PHY_BAND_6, PHY_BAND_6, PHY_BAND_6, PHY_BAND_6,

70 
PHY_BAND_6
, PHY_BAND_6,}},

73 
boﬁ
 
	$iwl_rfi_suµ‹ãd
(
iwl_mvm
 *
mvm
)

80  
Ál£
;

81 
	}
}

83 
	$iwl_rfi_£nd_c⁄fig_cmd
(
iwl_mvm
 *
mvm
, 
iwl_rfi_lut_íåy
 *
rfi_èbÀ
)

85 
ªt
;

86 
iwl_rfi_c⁄fig_cmd
 
cmd
;

87 
iwl_ho°_cmd
 
hcmd
 = {

88 .
id
 = 
	`WIDE_ID
(
SYSTEM_GROUP
, 
RFI_CONFIG_CMD
),

89 .
d©aÊags
[0] = 
IWL_HCMD_DFL_DUP
,

90 .
d©a
[0] = &
cmd
,

91 .
Àn
[0] = (
cmd
),

94 i‡(!
	`iwl_rfi_suµ‹ãd
(
mvm
))

95  -
EOPNOTSUPP
;

97 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

100 i‡(!
rfi_èbÀ
) {

101 
	`mem˝y
(
cmd
.
èbÀ
, 
iwl_rfi_èbÀ
, (cmd.table));

103 
	`mem˝y
(
cmd
.
èbÀ
, 
rfi_èbÀ
, (cmd.table));

105 
cmd
.
€m
 = 1;

108 
ªt
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
hcmd
);

110 i‡(
ªt
)

111 
	`IWL_ERR
(
mvm
, "FaûedÅÿ£nd RFI c⁄fig cmd %d\n", 
ªt
);

113  
ªt
;

114 
	}
}

116 
iwl_rfi_‰eq_èbÀ_ª•_cmd
 *
	$iwl_rfi_gë_‰eq_èbÀ
(
iwl_mvm
 *
mvm
)

118 
iwl_rfi_‰eq_èbÀ_ª•_cmd
 *
ª•
;

119 
ª•_size
 = (*
ª•
);

120 
ªt
;

121 
iwl_ho°_cmd
 
cmd
 = {

122 .
id
 = 
	`WIDE_ID
(
SYSTEM_GROUP
, 
RFI_GET_FREQ_TABLE_CMD
),

123 .
Êags
 = 
CMD_WANT_SKB
,

126 i‡(!
	`iwl_rfi_suµ‹ãd
(
mvm
))

127  
	`ERR_PTR
(-
EOPNOTSUPP
);

129 
	`muãx_lock
(&
mvm
->
muãx
);

130 
ªt
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
cmd
);

131 
	`muãx_u∆ock
(&
mvm
->
muãx
);

132 i‡(
ªt
)

133  
	`ERR_PTR
(
ªt
);

135 i‡(
	`WARN_ON_ONCE
(
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
cmd
.
ª•_pkt
) !=

136 
ª•_size
)) {

137 
	`iwl_‰ì_ª•
(&
cmd
);

138  
	`ERR_PTR
(-
EIO
);

141 
ª•
 = 
	`kmemdup
(
cmd
.
ª•_pkt
->
d©a
, 
ª•_size
, 
GFP_KERNEL
);

142 
	`iwl_‰ì_ª•
(&
cmd
);

144 i‡(!
ª•
)

145  
	`ERR_PTR
(-
ENOMEM
);

147  
ª•
;

148 
	}
}

150 
	$iwl_rfi_dó˘iv©e_nŸif_h™dÀr
(
iwl_mvm
 *
mvm
,

151 
iwl_rx_cmd_buf„r
 *
rxb
)

153 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

154 
iwl_rfi_dó˘iv©e_nŸif
 *
nŸif
 = (*)
pkt
->
d©a
;

156 
	`IWL_INFO
(
mvm
, "RFIm i†dó˘iv©ed,Ñós⁄ = %d\n", 
nŸif
->
ªas⁄
);

157 
	}
}

	@rs-fw.c

6 
	~"rs.h
"

7 
	~"fw-≠i.h
"

8 
	~"°a.h
"

9 
	~"iwl-›-mode.h
"

10 
	~"mvm.h
"

12 
u8
 
	$rs_fw_bw_‰om_°a_bw
(c⁄° 
õì80211_lök_°a
 *
lök_°a
)

14 
lök_°a
->
b™dwidth
) {

15 
IEEE80211_STA_RX_BW_320
:

16  
IWL_TLC_MNG_CH_WIDTH_320MHZ
;

17 
IEEE80211_STA_RX_BW_160
:

18  
IWL_TLC_MNG_CH_WIDTH_160MHZ
;

19 
IEEE80211_STA_RX_BW_80
:

20  
IWL_TLC_MNG_CH_WIDTH_80MHZ
;

21 
IEEE80211_STA_RX_BW_40
:

22  
IWL_TLC_MNG_CH_WIDTH_40MHZ
;

23 
IEEE80211_STA_RX_BW_20
:

25  
IWL_TLC_MNG_CH_WIDTH_20MHZ
;

27 
	}
}

29 
u8
 
	$rs_fw_£t_a˘ive_chaös
(
u8
 
chaös
)

31 
u8
 
fw_chaös
 = 0;

33 i‡(
chaös
 & 
ANT_A
)

34 
fw_chaös
 |
IWL_TLC_MNG_CHAIN_A_MSK
;

35 i‡(
chaös
 & 
ANT_B
)

36 
fw_chaös
 |
IWL_TLC_MNG_CHAIN_B_MSK
;

38  
fw_chaös
;

39 
	}
}

41 
u8
 
	$rs_fw_sgi_cw_suµ‹t
(
õì80211_lök_°a
 *
lök_°a
)

43 
õì80211_°a_ht_ˇp
 *
ht_ˇp
 = &
lök_°a
->ht_cap;

44 
õì80211_°a_vht_ˇp
 *
vht_ˇp
 = &
lök_°a
->vht_cap;

45 
õì80211_°a_he_ˇp
 *
he_ˇp
 = &
lök_°a
->he_cap;

46 
u8
 
suµ
 = 0;

48 i‡(
he_ˇp
->
has_he
)

51 i‡(
ht_ˇp
->
ˇp
 & 
IEEE80211_HT_CAP_SGI_20
)

52 
suµ
 |
	`BIT
(
IWL_TLC_MNG_CH_WIDTH_20MHZ
);

53 i‡(
ht_ˇp
->
ˇp
 & 
IEEE80211_HT_CAP_SGI_40
)

54 
suµ
 |
	`BIT
(
IWL_TLC_MNG_CH_WIDTH_40MHZ
);

55 i‡(
vht_ˇp
->
ˇp
 & 
IEEE80211_VHT_CAP_SHORT_GI_80
)

56 
suµ
 |
	`BIT
(
IWL_TLC_MNG_CH_WIDTH_80MHZ
);

57 i‡(
vht_ˇp
->
ˇp
 & 
IEEE80211_VHT_CAP_SHORT_GI_160
)

58 
suµ
 |
	`BIT
(
IWL_TLC_MNG_CH_WIDTH_160MHZ
);

60  
suµ
;

61 
	}
}

63 
u16
 
	$rs_fw_gë_c⁄fig_Êags
(
iwl_mvm
 *
mvm
,

64 
õì80211_vif
 *
vif
,

65 
õì80211_lök_°a
 *
lök_°a
,

66 c⁄° 
õì80211_°a_he_ˇp
 *
sb™d_he_ˇp
)

68 
õì80211_°a_ht_ˇp
 *
ht_ˇp
 = &
lök_°a
->ht_cap;

69 
õì80211_°a_vht_ˇp
 *
vht_ˇp
 = &
lök_°a
->vht_cap;

70 
õì80211_°a_he_ˇp
 *
he_ˇp
 = &
lök_°a
->he_cap;

71 
boﬁ
 
vht_ía
 = 
vht_ˇp
->
vht_suµ‹ãd
;

72 
u16
 
Êags
 = 0;

75 i‡(
mvm
->
cfg
->
ht_∑øms
->
°bc
 &&

76 (
	`num_of_™t
(
	`iwl_mvm_gë_vÆid_tx_™t
(
mvm
)) > 1)) {

77 i‡(
he_ˇp
->
has_he
 && he_ˇp->
he_ˇp_ñem
.
phy_ˇp_öfo
[2] &

78 
IEEE80211_HE_PHY_CAP2_STBC_RX_UNDER_80MHZ
)

79 
Êags
 |
IWL_TLC_MNG_CFG_FLAGS_STBC_MSK
;

80 i‡(
vht_ˇp
->
ˇp
 & 
IEEE80211_VHT_CAP_RXSTBC_MASK
)

81 
Êags
 |
IWL_TLC_MNG_CFG_FLAGS_STBC_MSK
;

82 i‡(
ht_ˇp
->
ˇp
 & 
IEEE80211_HT_CAP_RX_STBC
)

83 
Êags
 |
IWL_TLC_MNG_CFG_FLAGS_STBC_MSK
;

86 i‡(
mvm
->
cfg
->
ht_∑øms
->
ldpc
 &&

87 ((
ht_ˇp
->
ˇp
 & 
IEEE80211_HT_CAP_LDPC_CODING
) ||

88 (
vht_ía
 && (
vht_ˇp
->
ˇp
 & 
IEEE80211_VHT_CAP_RXLDPC
))))

89 
Êags
 |
IWL_TLC_MNG_CFG_FLAGS_LDPC_MSK
;

92 i‡(
he_ˇp
->
has_he
 && (he_ˇp->
he_ˇp_ñem
.
phy_ˇp_öfo
[1] &

93 
IEEE80211_HE_PHY_CAP1_LDPC_CODING_IN_PAYLOAD
))

94 
Êags
 |
IWL_TLC_MNG_CFG_FLAGS_LDPC_MSK
;

96 i‡(
sb™d_he_ˇp
 &&

97 !(
sb™d_he_ˇp
->
he_ˇp_ñem
.
phy_ˇp_öfo
[1] &

98 
IEEE80211_HE_PHY_CAP1_LDPC_CODING_IN_PAYLOAD
))

99 
Êags
 &~
IWL_TLC_MNG_CFG_FLAGS_LDPC_MSK
;

101 i‡(
he_ˇp
->
has_he
 &&

102 (
he_ˇp
->
he_ˇp_ñem
.
phy_ˇp_öfo
[3] &

103 
IEEE80211_HE_PHY_CAP3_DCM_MAX_CONST_RX_MASK
 &&

104 
sb™d_he_ˇp
 &&

105 
sb™d_he_ˇp
->
he_ˇp_ñem
.
phy_ˇp_öfo
[3] &

106 
IEEE80211_HE_PHY_CAP3_DCM_MAX_CONST_TX_MASK
))

107 
Êags
 |
IWL_TLC_MNG_CFG_FLAGS_HE_DCM_NSS_1_MSK
;

109  
Êags
;

110 
	}
}

113 
	$rs_fw_vht_highe°_rx_mcs_ödex
(c⁄° 
õì80211_°a_vht_ˇp
 *
vht_ˇp
,

114 
nss
)

116 
u16
 
rx_mcs
 = 
	`À16_to_˝u
(
vht_ˇp
->
vht_mcs
.
rx_mcs_m≠
) &

117 (0x3 << (2 * (
nss
 - 1)));

118 
rx_mcs
 >>(2 * (
nss
 - 1));

120 
rx_mcs
) {

121 
IEEE80211_VHT_MCS_SUPPORT_0_7
:

122  
IWL_TLC_MNG_HT_RATE_MCS7
;

123 
IEEE80211_VHT_MCS_SUPPORT_0_8
:

124  
IWL_TLC_MNG_HT_RATE_MCS8
;

125 
IEEE80211_VHT_MCS_SUPPORT_0_9
:

126  
IWL_TLC_MNG_HT_RATE_MCS9
;

128 
	`WARN_ON_ONCE
(1);

133 
	}
}

136 
	$rs_fw_vht_£t_íabÀd_øãs
(c⁄° 
õì80211_lök_°a
 *
lök_°a
,

137 c⁄° 
õì80211_°a_vht_ˇp
 *
vht_ˇp
,

138 
iwl_éc_c⁄fig_cmd_v4
 *
cmd
)

140 
u16
 
suµ
;

141 
i
, 
highe°_mcs
;

142 
u8
 
max_nss
 = 
lök_°a
->
rx_nss
;

143 
õì80211_vht_ˇp
 
õì_vht_ˇp
 = {

144 .
vht_ˇp_öfo
 = 
	`˝u_to_À32
(
vht_ˇp
->
ˇp
),

145 .
suµ_mcs
 = 
vht_ˇp
->
vht_mcs
,

149 i‡(
lök_°a
->
smps_mode
 =
IEEE80211_SMPS_STATIC
)

150 
max_nss
 = 1;

152 
i
 = 0; i < 
max_nss
 && i < 
IWL_TLC_NSS_MAX
; i++) {

153 
nss
 = 
i
 + 1;

155 
highe°_mcs
 = 
	`rs_fw_vht_highe°_rx_mcs_ödex
(
vht_ˇp
, 
nss
);

156 i‡(!
highe°_mcs
)

159 
suµ
 = 
	`BIT
(
highe°_mcs
 + 1) - 1;

160 i‡(
lök_°a
->
b™dwidth
 =
IEEE80211_STA_RX_BW_20
)

161 
suµ
 &~
	`BIT
(
IWL_TLC_MNG_HT_RATE_MCS9
);

163 
cmd
->
ht_øãs
[
i
][
IWL_TLC_MCS_PER_BW_80
] = 
	`˝u_to_À16
(
suµ
);

169 i‡(
lök_°a
->
b™dwidth
 =
IEEE80211_STA_RX_BW_160
 &&

170 
	`õì80211_gë_vht_max_nss
(&
õì_vht_ˇp
,

171 
IEEE80211_VHT_CHANWIDTH_160MHZ
,

172 0, 
åue
, 
nss
) >=Çss)

173 
cmd
->
ht_øãs
[
i
][
IWL_TLC_MCS_PER_BW_160
] =

174 
cmd
->
ht_øãs
[
i
][
IWL_TLC_MCS_PER_BW_80
];

176 
	}
}

178 
u16
 
	$rs_fw_he_õì80211_mcs_to_rs_mcs
(
u16
 
mcs
)

180 
mcs
) {

181 
IEEE80211_HE_MCS_SUPPORT_0_7
:

182  
	`BIT
(
IWL_TLC_MNG_HT_RATE_MCS7
 + 1) - 1;

183 
IEEE80211_HE_MCS_SUPPORT_0_9
:

184  
	`BIT
(
IWL_TLC_MNG_HT_RATE_MCS9
 + 1) - 1;

185 
IEEE80211_HE_MCS_SUPPORT_0_11
:

186  
	`BIT
(
IWL_TLC_MNG_HT_RATE_MCS11
 + 1) - 1;

187 
IEEE80211_HE_MCS_NOT_SUPPORTED
:

191 
	`WARN
(1, "övÆid HE MCS %d\n", 
mcs
);

193 
	}
}

196 
	$rs_fw_he_£t_íabÀd_øãs
(c⁄° 
õì80211_lök_°a
 *
lök_°a
,

197 c⁄° 
õì80211_°a_he_ˇp
 *
sb™d_he_ˇp
,

198 
iwl_éc_c⁄fig_cmd_v4
 *
cmd
)

200 c⁄° 
õì80211_°a_he_ˇp
 *
he_ˇp
 = &
lök_°a
->he_cap;

201 
u16
 
mcs_160
 = 
	`À16_to_˝u
(
he_ˇp
->
he_mcs_nss_suµ
.
rx_mcs_160
);

202 
u16
 
mcs_80
 = 
	`À16_to_˝u
(
he_ˇp
->
he_mcs_nss_suµ
.
rx_mcs_80
);

203 
u16
 
tx_mcs_80
 = 
	`À16_to_˝u
(
sb™d_he_ˇp
->
he_mcs_nss_suµ
.tx_mcs_80);

204 
u16
 
tx_mcs_160
 = 
	`À16_to_˝u
(
sb™d_he_ˇp
->
he_mcs_nss_suµ
.tx_mcs_160);

205 
i
;

206 
u8
 
nss
 = 
lök_°a
->
rx_nss
;

209 i‡(
lök_°a
->
smps_mode
 =
IEEE80211_SMPS_STATIC
)

210 
nss
 = 1;

212 
i
 = 0; i < 
nss
 && i < 
IWL_TLC_NSS_MAX
; i++) {

213 
u16
 
_mcs_160
 = (
mcs_160
 >> (2 * 
i
)) & 0x3;

214 
u16
 
_mcs_80
 = (
mcs_80
 >> (2 * 
i
)) & 0x3;

215 
u16
 
_tx_mcs_160
 = (
tx_mcs_160
 >> (2 * 
i
)) & 0x3;

216 
u16
 
_tx_mcs_80
 = (
tx_mcs_80
 >> (2 * 
i
)) & 0x3;

219 i‡(
_mcs_80
 =
IEEE80211_HE_MCS_NOT_SUPPORTED
 ||

220 
_tx_mcs_80
 =
IEEE80211_HE_MCS_NOT_SUPPORTED
) {

221 
_mcs_80
 = 
IEEE80211_HE_MCS_NOT_SUPPORTED
;

222 
_tx_mcs_80
 = 
IEEE80211_HE_MCS_NOT_SUPPORTED
;

224 i‡(
_mcs_80
 > 
_tx_mcs_80
)

225 
_mcs_80
 = 
_tx_mcs_80
;

226 
cmd
->
ht_øãs
[
i
][
IWL_TLC_MCS_PER_BW_80
] =

227 
	`˝u_to_À16
(
	`rs_fw_he_õì80211_mcs_to_rs_mcs
(
_mcs_80
));

230 i‡(
_mcs_160
 =
IEEE80211_HE_MCS_NOT_SUPPORTED
 ||

231 
_tx_mcs_160
 =
IEEE80211_HE_MCS_NOT_SUPPORTED
) {

232 
_mcs_160
 = 
IEEE80211_HE_MCS_NOT_SUPPORTED
;

233 
_tx_mcs_160
 = 
IEEE80211_HE_MCS_NOT_SUPPORTED
;

235 i‡(
_mcs_160
 > 
_tx_mcs_160
)

236 
_mcs_160
 = 
_tx_mcs_160
;

237 
cmd
->
ht_øãs
[
i
][
IWL_TLC_MCS_PER_BW_160
] =

238 
	`˝u_to_À16
(
	`rs_fw_he_õì80211_mcs_to_rs_mcs
(
_mcs_160
));

240 
	}
}

242 
u8
 
	$rs_fw_eht_max_nss
(
u8
 
rx_nss
, u8 
tx_nss
)

244 
u8
 
tx
 = 
	`u8_gë_bôs
(
tx_nss
, 
IEEE80211_EHT_MCS_NSS_TX
);

245 
u8
 
rx
 = 
	`u8_gë_bôs
(
rx_nss
, 
IEEE80211_EHT_MCS_NSS_RX
);

249  
	`mö
(
tx
, 
rx
);

250 
	}
}

252 
	#MAX_NSS_MCS
(
mcs_num
, 
rx
, 
tx
) \

253 
	`rs_fw_eht_max_nss
((
rx
)->
rx_tx_mcs
 ##
mcs_num
## 
_max_nss
, \

254 (
tx
)->
rx_tx_mcs
 ##
mcs_num
## 
_max_nss
)

	)

256 
	$rs_fw_£t_eht_mcs_nss
(
__À16
 
ht_øãs
[][3],

257 
IWL_TLC_MCS_PER_BW
 
bw
,

258 
u8
 
max_nss
, 
u16
 
mcs_msk
)

260 i‡(
max_nss
 >= 2)

261 
ht_øãs
[
IWL_TLC_NSS_2
][
bw
] |
	`˝u_to_À16
(
mcs_msk
);

263 i‡(
max_nss
 >= 1)

264 
ht_øãs
[
IWL_TLC_NSS_1
][
bw
] |
	`˝u_to_À16
(
mcs_msk
);

265 
	}
}

268 
õì80211_eht_mcs_nss_suµ_bw
 *

269 
	$rs_fw_rs_mcs2eht_mcs
(
IWL_TLC_MCS_PER_BW
 
bw
,

270 c⁄° 
õì80211_eht_mcs_nss_suµ
 *
eht_mcs
)

272 
bw
) {

273 
IWL_TLC_MCS_PER_BW_80
:

274  &
eht_mcs
->
bw
.
_80
;

275 
IWL_TLC_MCS_PER_BW_160
:

276  &
eht_mcs
->
bw
.
_160
;

277 
IWL_TLC_MCS_PER_BW_320
:

278  &
eht_mcs
->
bw
.
_320
;

280  
NULL
;

282 
	}
}

285 
	$rs_fw_eht_£t_íabÀd_øãs
(
õì80211_vif
 *
vif
,

286 c⁄° 
õì80211_lök_°a
 *
lök_°a
,

287 c⁄° 
õì80211_°a_he_ˇp
 *
sb™d_he_ˇp
,

288 c⁄° 
õì80211_°a_eht_ˇp
 *
sb™d_eht_ˇp
,

289 
iwl_éc_c⁄fig_cmd_v4
 *
cmd
)

292 c⁄° 
õì80211_eht_mcs_nss_suµ
 *
eht_rx_mcs
 =

293 &
lök_°a
->
eht_ˇp
.
eht_mcs_nss_suµ
;

295 c⁄° 
õì80211_eht_mcs_nss_suµ
 *
eht_tx_mcs
 =

296 &
sb™d_eht_ˇp
->
eht_mcs_nss_suµ
;

298 
IWL_TLC_MCS_PER_BW
 
bw
;

299 
õì80211_eht_mcs_nss_suµ_20mhz_⁄ly
 
mcs_rx_20
;

300 
õì80211_eht_mcs_nss_suµ_20mhz_⁄ly
 
mcs_tx_20
;

303 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
 &&

304 !(
lök_°a
->
he_ˇp
.
he_ˇp_ñem
.
phy_ˇp_öfo
[0] &

305 
IEEE80211_HE_PHY_CAP0_CHANNEL_WIDTH_SET_MASK_ALL
)) {

306 
mcs_rx_20
 = 
eht_rx_mcs
->
⁄ly_20mhz
;

308 
mcs_rx_20
.
rx_tx_mcs7_max_nss
 = 
eht_rx_mcs
->
bw
.
_80
.
rx_tx_mcs9_max_nss
;

309 
mcs_rx_20
.
rx_tx_mcs9_max_nss
 = 
eht_rx_mcs
->
bw
.
_80
.rx_tx_mcs9_max_nss;

310 
mcs_rx_20
.
rx_tx_mcs11_max_nss
 = 
eht_rx_mcs
->
bw
.
_80
.rx_tx_mcs11_max_nss;

311 
mcs_rx_20
.
rx_tx_mcs13_max_nss
 = 
eht_rx_mcs
->
bw
.
_80
.rx_tx_mcs13_max_nss;

315 i‡(!(
sb™d_he_ˇp
->
he_ˇp_ñem
.
phy_ˇp_öfo
[0] &

316 
IEEE80211_HE_PHY_CAP0_CHANNEL_WIDTH_SET_MASK_ALL
)) {

317 
mcs_tx_20
 = 
eht_tx_mcs
->
⁄ly_20mhz
;

319 
mcs_tx_20
.
rx_tx_mcs7_max_nss
 = 
eht_tx_mcs
->
bw
.
_80
.
rx_tx_mcs9_max_nss
;

320 
mcs_tx_20
.
rx_tx_mcs9_max_nss
 = 
eht_tx_mcs
->
bw
.
_80
.rx_tx_mcs9_max_nss;

321 
mcs_tx_20
.
rx_tx_mcs11_max_nss
 = 
eht_tx_mcs
->
bw
.
_80
.rx_tx_mcs11_max_nss;

322 
mcs_tx_20
.
rx_tx_mcs13_max_nss
 = 
eht_tx_mcs
->
bw
.
_80
.rx_tx_mcs13_max_nss;

326 
bw
 = 
IWL_TLC_MCS_PER_BW_80
;

327 
	`rs_fw_£t_eht_mcs_nss
(
cmd
->
ht_øãs
, 
bw
,

328 
	`MAX_NSS_MCS
(7, &
mcs_rx_20
, &
mcs_tx_20
), 
	`GENMASK
(7, 0));

329 
	`rs_fw_£t_eht_mcs_nss
(
cmd
->
ht_øãs
, 
bw
,

330 
	`MAX_NSS_MCS
(9, &
mcs_rx_20
, &
mcs_tx_20
), 
	`GENMASK
(9, 8));

331 
	`rs_fw_£t_eht_mcs_nss
(
cmd
->
ht_øãs
, 
bw
,

332 
	`MAX_NSS_MCS
(11, &
mcs_rx_20
, &
mcs_tx_20
), 
	`GENMASK
(11, 10));

333 
	`rs_fw_£t_eht_mcs_nss
(
cmd
->
ht_øãs
, 
bw
,

334 
	`MAX_NSS_MCS
(13, &
mcs_rx_20
, &
mcs_tx_20
), 
	`GENMASK
(13, 12));

337 
bw
 = 
IWL_TLC_MCS_PER_BW_160
; bw <
IWL_TLC_MCS_PER_BW_320
; bw++) {

338 c⁄° 
õì80211_eht_mcs_nss_suµ_bw
 *
mcs_rx
 =

339 
	`rs_fw_rs_mcs2eht_mcs
(
bw
, 
eht_rx_mcs
);

340 c⁄° 
õì80211_eht_mcs_nss_suµ_bw
 *
mcs_tx
 =

341 
	`rs_fw_rs_mcs2eht_mcs
(
bw
, 
eht_tx_mcs
);

344 i‡(!
mcs_rx
 || !
mcs_tx
)

348 i‡(
cmd
->
max_ch_width
 < (
bw
 + 
IWL_TLC_MNG_CH_WIDTH_80MHZ
))

351 
	`rs_fw_£t_eht_mcs_nss
(
cmd
->
ht_øãs
, 
bw
,

352 
	`MAX_NSS_MCS
(9, 
mcs_rx
, 
mcs_tx
), 
	`GENMASK
(9, 0));

353 
	`rs_fw_£t_eht_mcs_nss
(
cmd
->
ht_øãs
, 
bw
,

354 
	`MAX_NSS_MCS
(11, 
mcs_rx
, 
mcs_tx
), 
	`GENMASK
(11, 10));

355 
	`rs_fw_£t_eht_mcs_nss
(
cmd
->
ht_øãs
, 
bw
,

356 
	`MAX_NSS_MCS
(13, 
mcs_rx
, 
mcs_tx
), 
	`GENMASK
(13, 12));

360 i‡(
lök_°a
->
smps_mode
 =
IEEE80211_SMPS_STATIC
 ||

361 
lök_°a
->
rx_nss
 < 2)

362 
	`mem£t
(
cmd
->
ht_øãs
[
IWL_TLC_NSS_2
], 0,

363 (
cmd
->
ht_øãs
[
IWL_TLC_NSS_2
]));

364 
	}
}

366 
	$rs_fw_£t_suµ_øãs
(
õì80211_vif
 *
vif
,

367 
õì80211_lök_°a
 *
lök_°a
,

368 
õì80211_suµ‹ãd_b™d
 *
sb™d
,

369 c⁄° 
õì80211_°a_he_ˇp
 *
sb™d_he_ˇp
,

370 c⁄° 
õì80211_°a_eht_ˇp
 *
sb™d_eht_ˇp
,

371 
iwl_éc_c⁄fig_cmd_v4
 *
cmd
)

373 
i
;

374 
u16
 
suµ
 = 0;

375 
tmp
;

376 c⁄° 
õì80211_°a_ht_ˇp
 *
ht_ˇp
 = &
lök_°a
->ht_cap;

377 c⁄° 
õì80211_°a_vht_ˇp
 *
vht_ˇp
 = &
lök_°a
->vht_cap;

378 c⁄° 
õì80211_°a_he_ˇp
 *
he_ˇp
 = &
lök_°a
->he_cap;

381 
tmp
 = 
lök_°a
->
suµ_øãs
[
sb™d
->
b™d
];

382 
	`f‹_óch_£t_bô
(
i
, &
tmp
, 
BITS_PER_LONG
)

383 
suµ
 |
	`BIT
(
sb™d
->
bôøãs
[
i
].
hw_vÆue
);

385 
cmd
->
n⁄_ht_øãs
 = 
	`˝u_to_À16
(
suµ
);

386 
cmd
->
mode
 = 
IWL_TLC_MNG_MODE_NON_HT
;

389 i‡(
lök_°a
->
eht_ˇp
.
has_eht
 && 
sb™d_he_ˇp
 && 
sb™d_eht_ˇp
) {

390 
cmd
->
mode
 = 
IWL_TLC_MNG_MODE_EHT
;

391 
	`rs_fw_eht_£t_íabÀd_øãs
(
vif
, 
lök_°a
, 
sb™d_he_ˇp
,

392 
sb™d_eht_ˇp
, 
cmd
);

393 } i‡(
he_ˇp
->
has_he
 && 
sb™d_he_ˇp
) {

394 
cmd
->
mode
 = 
IWL_TLC_MNG_MODE_HE
;

395 
	`rs_fw_he_£t_íabÀd_øãs
(
lök_°a
, 
sb™d_he_ˇp
, 
cmd
);

396 } i‡(
vht_ˇp
->
vht_suµ‹ãd
) {

397 
cmd
->
mode
 = 
IWL_TLC_MNG_MODE_VHT
;

398 
	`rs_fw_vht_£t_íabÀd_øãs
(
lök_°a
, 
vht_ˇp
, 
cmd
);

399 } i‡(
ht_ˇp
->
ht_suµ‹ãd
) {

400 
cmd
->
mode
 = 
IWL_TLC_MNG_MODE_HT
;

401 
cmd
->
ht_øãs
[
IWL_TLC_NSS_1
][
IWL_TLC_MCS_PER_BW_80
] =

402 
	`˝u_to_À16
(
ht_ˇp
->
mcs
.
rx_mask
[0]);

405 i‡(
lök_°a
->
smps_mode
 =
IEEE80211_SMPS_STATIC
)

406 
cmd
->
ht_øãs
[
IWL_TLC_NSS_2
][
IWL_TLC_MCS_PER_BW_80
] =

409 
cmd
->
ht_øãs
[
IWL_TLC_NSS_2
][
IWL_TLC_MCS_PER_BW_80
] =

410 
	`˝u_to_À16
(
ht_ˇp
->
mcs
.
rx_mask
[1]);

412 
	}
}

414 
	$iwl_mvm_éc_upd©e_nŸif
(
iwl_mvm
 *
mvm
,

415 
iwl_rx_cmd_buf„r
 *
rxb
)

417 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

418 
iwl_éc_upd©e_nŸif
 *
nŸif
;

419 
õì80211_°a
 *
°a
;

420 
õì80211_lök_°a
 *
lök_°a
;

421 
iwl_mvm_°a
 *
mvm°a
;

422 
iwl_mvm_lök_°a
 *
mvm_lök_°a
;

423 
iwl_lq_°a_rs_fw
 *
lq_°a
;

424 
u32
 
Êags
;

426 
	`rcu_ªad_lock
();

428 
nŸif
 = (*)
pkt
->
d©a
;

429 
lök_°a
 = 
	`rcu_dîe„ªn˚
(
mvm
->
fw_id_to_lök_°a
[
nŸif
->
°a_id
]);

430 
°a
 = 
	`rcu_dîe„ªn˚
(
mvm
->
fw_id_to_mac_id
[
nŸif
->
°a_id
]);

431 i‡(
	`IS_ERR_OR_NULL
(
°a
Ë|| !
lök_°a
) {

435 
	`IWL_DEBUG_RATE
(
mvm
,

437 
nŸif
->
°a_id
);

438 
out
;

441 
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

443 i‡(!
mvm°a
) {

444 
	`IWL_ERR
(
mvm
, "Invalid sta id (%d) in FW TLCÇotification\n",

445 
nŸif
->
°a_id
);

446 
out
;

449 
Êags
 = 
	`À32_to_˝u
(
nŸif
->flags);

451 
mvm_lök_°a
 = 
	`rcu_dîe„ªn˚
(
mvm°a
->
lök
[
lök_°a
->
lök_id
]);

452 i‡(!
mvm_lök_°a
) {

453 
	`IWL_DEBUG_RATE
(
mvm
,

455 
lök_°a
->
lök_id
, 
nŸif
->
°a_id
);

456 
out
;

458 
lq_°a
 = &
mvm_lök_°a
->lq_°a.
rs_fw
;

460 i‡(
Êags
 & 
IWL_TLC_NOTIF_FLAG_RATE
) {

461 
¥ëty_øã
[100];

463 i‡(
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
DATA_PATH_GROUP
,

464 
TLC_MNG_UPDATE_NOTIF
, 0) < 3) {

465 
	`rs_¥ëty_¥öt_øã_v1
(
¥ëty_øã
,

466 (
¥ëty_øã
),

467 
	`À32_to_˝u
(
nŸif
->
øã
));

468 
	`IWL_DEBUG_RATE
(
mvm
,

470 
¥ëty_øã
);

471 
lq_°a
->
œ°_øã_n_Êags
 =

472 
	`iwl_√w_øã_‰om_v1
(
	`À32_to_˝u
(
nŸif
->
øã
));

474 
lq_°a
->
œ°_øã_n_Êags
 = 
	`À32_to_˝u
(
nŸif
->
øã
);

476 
	`rs_¥ëty_¥öt_øã
(
¥ëty_øã
, (pretty_rate),

477 
lq_°a
->
œ°_øã_n_Êags
);

478 
	`IWL_DEBUG_RATE
(
mvm
, "√wÑ©e: %s\n", 
¥ëty_øã
);

481 i‡(
Êags
 & 
IWL_TLC_NOTIF_FLAG_AMSDU
 && !
mvm_lök_°a
->
‹ig_amsdu_Àn
) {

482 
u32
 
íabÀd
 = 
	`À32_to_˝u
(
nŸif
->
amsdu_íabÀd
);

483 
u16
 
size
 = 
	`À32_to_˝u
(
nŸif
->
amsdu_size
);

484 
i
;

486 i‡(
size
 < 2000) {

487 
size
 = 0;

488 
íabÀd
 = 0;

491 i‡(
lök_°a
->
agg
.
max_amsdu_Àn
 < 
size
) {

497 
	`WARN_ON
(
mvm_lök_°a
->
‹ig_amsdu_Àn
 < 
size
);

498 
out
;

501 
mvm°a
->
amsdu_íabÀd
 = 
íabÀd
;

502 
mvm°a
->
max_amsdu_Àn
 = 
size
;

503 
lök_°a
->
agg
.
max_rc_amsdu_Àn
 = 
mvm°a
->
max_amsdu_Àn
;

505 
i
 = 0; i < 
IWL_MAX_TID_COUNT
; i++) {

506 i‡(
mvm°a
->
amsdu_íabÀd
 & 
	`BIT
(
i
))

507 
lök_°a
->
agg
.
max_tid_amsdu_Àn
[
i
] =

508 
	`iwl_mvm_max_amsdu_size
(
mvm
, 
°a
, 
i
);

514 
lök_°a
->
agg
.
max_tid_amsdu_Àn
[
i
] = 1;

517 
	`IWL_DEBUG_RATE
(
mvm
,

519 
	`À32_to_˝u
(
nŸif
->
amsdu_size
), 
size
,

520 
mvm°a
->
amsdu_íabÀd
);

522 
out
:

523 
	`rcu_ªad_u∆ock
();

524 
	}
}

526 
u16
 
	$rs_fw_gë_max_amsdu_Àn
(
õì80211_°a
 *
°a
,

527 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

528 
õì80211_lök_°a
 *
lök_°a
)

530 c⁄° 
õì80211_°a_vht_ˇp
 *
vht_ˇp
 = &
lök_°a
->vht_cap;

531 c⁄° 
õì80211_°a_ht_ˇp
 *
ht_ˇp
 = &
lök_°a
->ht_cap;

532 c⁄° 
õì80211_°a_eht_ˇp
 *
eht_ˇp
 = &
lök_°a
->eht_cap;

534 i‡(
	`WARN_ON_ONCE
(!
lök_c⁄f
->
ch™ªq
.
›î
.
ch™
))

535  
IEEE80211_MAX_MPDU_LEN_VHT_3895
;

537 i‡(
lök_c⁄f
->
ch™ªq
.
›î
.
ch™
->
b™d
 =
NL80211_BAND_6GHZ
) {

538 
	`À16_gë_bôs
(
lök_°a
->
he_6ghz_ˇ∑
.
ˇ∑
,

539 
IEEE80211_HE_6GHZ_CAP_MAX_MPDU_LEN
)) {

540 
IEEE80211_VHT_CAP_MAX_MPDU_LENGTH_11454
:

541  
IEEE80211_MAX_MPDU_LEN_VHT_11454
;

542 
IEEE80211_VHT_CAP_MAX_MPDU_LENGTH_7991
:

543  
IEEE80211_MAX_MPDU_LEN_VHT_7991
;

545  
IEEE80211_MAX_MPDU_LEN_VHT_3895
;

547 } i‡(
lök_c⁄f
->
ch™ªq
.
›î
.
ch™
->
b™d
 =
NL80211_BAND_2GHZ
 &&

548 
eht_ˇp
->
has_eht
) {

549 
	`u8_gë_bôs
(
eht_ˇp
->
eht_ˇp_ñem
.
mac_ˇp_öfo
[0],

550 
IEEE80211_EHT_MAC_CAP0_MAX_MPDU_LEN_MASK
)) {

551 
IEEE80211_EHT_MAC_CAP0_MAX_MPDU_LEN_11454
:

552  
IEEE80211_MAX_MPDU_LEN_VHT_11454
;

553 
IEEE80211_EHT_MAC_CAP0_MAX_MPDU_LEN_7991
:

554  
IEEE80211_MAX_MPDU_LEN_VHT_7991
;

556  
IEEE80211_MAX_MPDU_LEN_VHT_3895
;

558 } i‡(
vht_ˇp
->
vht_suµ‹ãd
) {

559 
vht_ˇp
->
ˇp
 & 
IEEE80211_VHT_CAP_MAX_MPDU_MASK
) {

560 
IEEE80211_VHT_CAP_MAX_MPDU_LENGTH_11454
:

561  
IEEE80211_MAX_MPDU_LEN_VHT_11454
;

562 
IEEE80211_VHT_CAP_MAX_MPDU_LENGTH_7991
:

563  
IEEE80211_MAX_MPDU_LEN_VHT_7991
;

565  
IEEE80211_MAX_MPDU_LEN_VHT_3895
;

567 } i‡(
ht_ˇp
->
ht_suµ‹ãd
) {

568 i‡(
ht_ˇp
->
ˇp
 & 
IEEE80211_HT_CAP_MAX_AMSDU
)

574  
IEEE80211_MAX_MPDU_LEN_HT_BA
;

576  
IEEE80211_MAX_MPDU_LEN_HT_3839
;

581 
	}
}

583 
	$iwl_mvm_rs_fw_øã_öô
(
iwl_mvm
 *
mvm
,

584 
õì80211_vif
 *
vif
,

585 
õì80211_°a
 *
°a
,

586 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

587 
õì80211_lök_°a
 *
lök_°a
,

588 
∆80211_b™d
 
b™d
)

590 
õì80211_hw
 *
hw
 = 
mvm
->hw;

591 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

592 
u32
 
cmd_id
 = 
	`WIDE_ID
(
DATA_PATH_GROUP
, 
TLC_MNG_CONFIG_CMD
);

593 
õì80211_suµ‹ãd_b™d
 *
sb™d
 = 
hw
->
wùhy
->
b™ds
[
b™d
];

594 
u16
 
max_amsdu_Àn
 = 
	`rs_fw_gë_max_amsdu_Àn
(
°a
, 
lök_c⁄f
, 
lök_°a
);

595 c⁄° 
õì80211_°a_he_ˇp
 *
sb™d_he_ˇp
 =

596 
	`õì80211_gë_he_i·y≥_ˇp_vif
(
sb™d
, 
vif
);

597 c⁄° 
õì80211_°a_eht_ˇp
 *
sb™d_eht_ˇp
 =

598 
	`õì80211_gë_eht_i·y≥_ˇp_vif
(
sb™d
, 
vif
);

599 
iwl_mvm_lök_°a
 *
mvm_lök_°a
;

600 
iwl_lq_°a_rs_fw
 *
lq_°a
;

601 
iwl_éc_c⁄fig_cmd_v4
 
cfg_cmd
 = {

602 .
max_ch_width
 = 
mvm°a
->
auth‹ized
 ?

603 
	`rs_fw_bw_‰om_°a_bw
(
lök_°a
Ë: 
IWL_TLC_MNG_CH_WIDTH_20MHZ
,

604 .
Êags
 = 
	`˝u_to_À16
(
	`rs_fw_gë_c⁄fig_Êags
(
mvm
, 
vif
, 
lök_°a
,

605 
sb™d_he_ˇp
)),

606 .
chaös
 = 
	`rs_fw_£t_a˘ive_chaös
(
	`iwl_mvm_gë_vÆid_tx_™t
(
mvm
)),

607 .
sgi_ch_width_suµ
 = 
	`rs_fw_sgi_cw_suµ‹t
(
lök_°a
),

608 .
max_mpdu_Àn
 = 
	`iwl_mvm_is_csum_suµ‹ãd
(
mvm
) ?

609 
	`˝u_to_À16
(
max_amsdu_Àn
) : 0,

611 
lök_id
 = 
lök_c⁄f
->link_id;

612 
cmd_vî
;

613 
ªt
;

618 i‡(
	`CSR_HW_REV_TYPE
(
mvm
->
å™s
->
hw_ªv
Ë=
IWL_CFG_MAC_TYPE_GL
 &&

619 
sb™d_eht_ˇp
 &&

620 
sb™d_eht_ˇp
->
eht_ˇp_ñem
.
phy_ˇp_öfo
[5] &

621 
IEEE80211_EHT_PHY_CAP5_SUPP_EXTRA_EHT_LTF
 &&

622 
lök_°a
->
eht_ˇp
.
has_eht
 &&

623 
lök_°a
->
eht_ˇp
.
eht_ˇp_ñem
.
phy_ˇp_öfo
[5] &

624 
IEEE80211_EHT_PHY_CAP5_SUPP_EXTRA_EHT_LTF
) {

625 
	`IWL_DEBUG_RATE
(
mvm
, "Set support for Extra EHT LTF\n");

626 
cfg_cmd
.
Êags
 |=

627 
	`˝u_to_À16
(
IWL_TLC_MNG_CFG_FLAGS_EHT_EXTRA_LTF_MSK
);

630 
	`rcu_ªad_lock
();

631 
mvm_lök_°a
 = 
	`rcu_dîe„ªn˚
(
mvm°a
->
lök
[
lök_id
]);

632 i‡(
	`WARN_ON_ONCE
(!
mvm_lök_°a
)) {

633 
	`rcu_ªad_u∆ock
();

637 
cfg_cmd
.
°a_id
 = 
mvm_lök_°a
->sta_id;

639 
lq_°a
 = &
mvm_lök_°a
->lq_°a.
rs_fw
;

640 
	`mem£t
(
lq_°a
, 0, 
	`off£tof
(
	`ty≥of
(*lq_°a), 
≥rs
));

642 
	`rcu_ªad_u∆ock
();

644 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


645 
	`iwl_mvm_ª£t_‰ame_°©s
(
mvm
);

647 
	`rs_fw_£t_suµ_øãs
(
vif
, 
lök_°a
, 
sb™d
,

648 
sb™d_he_ˇp
, 
sb™d_eht_ˇp
,

649 &
cfg_cmd
);

655 
°a
->
deÊök
.
agg
.
max_amsdu_Àn
 = max_amsdu_len;

657 
cmd_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
,

658 
	`WIDE_ID
(
DATA_PATH_GROUP
,

659 
TLC_MNG_CONFIG_CMD
),

661 
	`IWL_DEBUG_RATE
(
mvm
, "TLC CONFIG CMD, sta_id=%d, max_ch_width=%d, mode=%d\n",

662 
cfg_cmd
.
°a_id
, cfg_cmd.
max_ch_width
, cfg_cmd.
mode
);

663 
	`IWL_DEBUG_RATE
(
mvm
, "TLC CONFIG CMD, chains=0x%X, ch_wid_supp=%d, flags=0x%X\n",

664 
cfg_cmd
.
chaös
, cfg_cmd.
sgi_ch_width_suµ
, cfg_cmd.
Êags
);

665 
	`IWL_DEBUG_RATE
(
mvm
, "TLC CONFIG CMD, mpdu_len=%d,Ço_ht_rate=0x%X,Åx_op=%d\n",

666 
cfg_cmd
.
max_mpdu_Àn
, cfg_cmd.
n⁄_ht_øãs
, cfg_cmd.
max_tx_›
);

667 
	`IWL_DEBUG_RATE
(
mvm
, "TLC CONFIG CMD, ht_rate[0][0]=0x%X, ht_rate[1][0]=0x%X\n",

668 
cfg_cmd
.
ht_øãs
[0][0], cfg_cmd.ht_rates[1][0]);

669 
	`IWL_DEBUG_RATE
(
mvm
, "TLC CONFIG CMD, ht_rate[0][1]=0x%X, ht_rate[1][1]=0x%X\n",

670 
cfg_cmd
.
ht_øãs
[0][1], cfg_cmd.ht_rates[1][1]);

671 
	`IWL_DEBUG_RATE
(
mvm
, "TLC CONFIG CMD, ht_rate[0][2]=0x%X, ht_rate[1][2]=0x%X\n",

672 
cfg_cmd
.
ht_øãs
[0][2], cfg_cmd.ht_rates[1][2]);

673 i‡(
cmd_vî
 == 4) {

674 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
cmd_id
, 
CMD_ASYNC
,

675 (
cfg_cmd
), &cfg_cmd);

676 } i‡(
cmd_vî
 < 4) {

677 
iwl_éc_c⁄fig_cmd_v3
 
cfg_cmd_v3
 = {

678 .
°a_id
 = 
cfg_cmd
.sta_id,

679 .
max_ch_width
 = 
cfg_cmd
.max_ch_width,

680 .
mode
 = 
cfg_cmd
.mode,

681 .
chaös
 = 
cfg_cmd
.chains,

682 .
amsdu
 = !!
cfg_cmd
.
max_mpdu_Àn
,

683 .
Êags
 = 
cfg_cmd
.flags,

684 .
n⁄_ht_øãs
 = 
cfg_cmd
.non_ht_rates,

685 .
ht_øãs
[0][0] = 
cfg_cmd
.ht_rates[0][0],

686 .
ht_øãs
[0][1] = 
cfg_cmd
.ht_rates[0][1],

687 .
ht_øãs
[1][0] = 
cfg_cmd
.ht_rates[1][0],

688 .
ht_øãs
[1][1] = 
cfg_cmd
.ht_rates[1][1],

689 .
sgi_ch_width_suµ
 = 
cfg_cmd
.sgi_ch_width_supp,

690 .
max_mpdu_Àn
 = 
cfg_cmd
.max_mpdu_len,

693 
u16
 
cmd_size
 = (
cfg_cmd_v3
);

696 i‡(
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
,

697 
	`WIDE_ID
(
DATA_PATH_GROUP
,

698 
TLC_MNG_CONFIG_CMD
), 0) < 3)

699 
cmd_size
 -= 4;

701 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
cmd_id
, 
CMD_ASYNC
, 
cmd_size
,

702 &
cfg_cmd_v3
);

704 
ªt
 = -
EINVAL
;

707 i‡(
ªt
)

708 
	`IWL_ERR
(
mvm
, "FaûedÅÿ£ndÑ©êsˇÀ c⁄fig (%d)\n", 
ªt
);

709 
	}
}

711 
	$rs_fw_tx_¥Ÿe˘i⁄
(
iwl_mvm
 *
mvm
, 
iwl_mvm_°a
 *
mvm°a
,

712 
boﬁ
 
íabÀ
)

715 
	`IWL_DEBUG_RATE
(
mvm
, "txÖrotection -Çot implemented yet.\n");

717 
	}
}

719 
	$iwl_mvm_rs_add_°a_lök
(
iwl_mvm
 *
mvm
,

720 
iwl_mvm_lök_°a
 *
lök_°a
)

722 
iwl_lq_°a_rs_fw
 *
lq_°a
;

724 
lq_°a
 = &
lök_°a
->lq_°a.
rs_fw
;

726 
lq_°a
->
≥rs
.
drv
 = 
mvm
;

727 
lq_°a
->
≥rs
.
°a_id
 = 
lök_°a
->sta_id;

728 
lq_°a
->
≥rs
.
chaös
 = 0;

729 
	`mem£t
(
lq_°a
->
≥rs
.
chaö_sig«l
, 0,

730 (
lq_°a
->
≥rs
.
chaö_sig«l
));

731 
lq_°a
->
≥rs
.
œ°_rssi
 = 
S8_MIN
;

732 
lq_°a
->
œ°_øã_n_Êags
 = 0;

734 #ifde‡
CONFIG_MAC80211_DEBUGFS


735 
lq_°a
->
≥rs
.
dbg_fixed_øã
 = 0;

737 
	}
}

739 
	$iwl_mvm_rs_add_°a
(
iwl_mvm
 *
mvm
, 
iwl_mvm_°a
 *
mvm°a
)

741 
lök_id
;

743 
	`IWL_DEBUG_RATE
(
mvm
, "create stationÑate scale window\n");

745 
lök_id
 = 0;Üök_id < 
	`ARRAY_SIZE
(
mvm°a
->
lök
);Üink_id++) {

746 
iwl_mvm_lök_°a
 *
lök
 =

747 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm°a
->
lök
[
lök_id
],

748 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

749 i‡(!
lök
)

752 
	`iwl_mvm_rs_add_°a_lök
(
mvm
, 
lök
);

754 
	}
}

	@rs.c

8 
	~<löux/kî√l.h
>

9 
	~<löux/skbuff.h
>

10 
	~<löux/¶ab.h
>

11 
	~<√t/mac80211.h
>

13 
	~<löux/√tdevi˚.h
>

14 
	~<löux/ëhîdevi˚.h
>

15 
	~<löux/dñay.h
>

17 
	~<löux/w‹kqueue.h
>

18 
	~"rs.h
"

19 
	~"fw-≠i.h
"

20 
	~"°a.h
"

21 
	~"iwl-›-mode.h
"

22 
	~"mvm.h
"

23 
	~"debugfs.h
"

25 
	#IWL_RATE_MAX_WINDOW
 62

	)

30 
	#RS_PERCENT
(
x
Ë(128 * x)

	)

32 
u8
 
	grs_ht_to_Àgacy
[] = {

33 [
IWL_RATE_MCS_0_INDEX
] = 
IWL_RATE_6M_INDEX
,

34 [
IWL_RATE_MCS_1_INDEX
] = 
IWL_RATE_9M_INDEX
,

35 [
IWL_RATE_MCS_2_INDEX
] = 
IWL_RATE_12M_INDEX
,

36 [
IWL_RATE_MCS_3_INDEX
] = 
IWL_RATE_18M_INDEX
,

37 [
IWL_RATE_MCS_4_INDEX
] = 
IWL_RATE_24M_INDEX
,

38 [
IWL_RATE_MCS_5_INDEX
] = 
IWL_RATE_36M_INDEX
,

39 [
IWL_RATE_MCS_6_INDEX
] = 
IWL_RATE_48M_INDEX
,

40 [
IWL_RATE_MCS_7_INDEX
] = 
IWL_RATE_54M_INDEX
,

41 [
IWL_RATE_MCS_8_INDEX
] = 
IWL_RATE_54M_INDEX
,

42 [
IWL_RATE_MCS_9_INDEX
] = 
IWL_RATE_54M_INDEX
,

45 c⁄° 
u8
 
	g™t_toggÀ_lookup
[] = {

46 [
ANT_NONE
] = ANT_NONE,

47 [
ANT_A
] = 
ANT_B
,

48 [
ANT_B
] = 
ANT_A
,

49 [
ANT_AB
] = ANT_AB,

52 
	#IWL_DECLARE_RATE_INFO
(
r
, 
s
, 
Ω
, 
∫
) \

53 [
IWL_RATE_
##
r
##
M_INDEX
] = { IWL_RATE_##r##
M_PLCP
, \

54 
IWL_RATE_HT_SISO_MCS_
##
s
##
_PLCP
, \

55 
IWL_RATE_HT_MIMO2_MCS_
##
s
##
_PLCP
, \

56 
IWL_RATE_VHT_SISO_MCS_
##
s
##
_PLCP
, \

57 
IWL_RATE_VHT_MIMO2_MCS_
##
s
##
_PLCP
,\

58 
IWL_RATE_
##
Ω
##
M_INDEX
, \

59 
IWL_RATE_
##
∫
##
M_INDEX
 }

	)

61 
	#IWL_DECLARE_MCS_RATE
(
s
) \

62 [
IWL_RATE_MCS_
##
s
##
_INDEX
] = { 
IWL_RATE_INVM_PLCP
, \

63 
IWL_RATE_HT_SISO_MCS_
##
s
##
_PLCP
, \

64 
IWL_RATE_HT_MIMO2_MCS_
##
s
##
_PLCP
, \

65 
IWL_RATE_VHT_SISO_MCS_
##
s
##
_PLCP
, \

66 
IWL_RATE_VHT_MIMO2_MCS_
##
s
##
_PLCP
, \

67 
IWL_RATE_INVM_INDEX
, \

68 
IWL_RATE_INVM_INDEX
 }

	)

78 c⁄° 
iwl_rs_øã_öfo
 
	giwl_øãs
[
IWL_RATE_COUNT
] = {

79 
IWL_DECLARE_RATE_INFO
(1, 
INV
, INV, 2),

80 
IWL_DECLARE_RATE_INFO
(2, 
INV
, 1, 5),

81 
IWL_DECLARE_RATE_INFO
(5, 
INV
, 2, 11),

82 
IWL_DECLARE_RATE_INFO
(11, 
INV
, 9, 12),

83 
IWL_DECLARE_RATE_INFO
(6, 0, 5, 11),

84 
IWL_DECLARE_RATE_INFO
(9, 
INV
, 6, 11),

85 
IWL_DECLARE_RATE_INFO
(12, 1, 11, 18),

86 
IWL_DECLARE_RATE_INFO
(18, 2, 12, 24),

87 
IWL_DECLARE_RATE_INFO
(24, 3, 18, 36),

88 
IWL_DECLARE_RATE_INFO
(36, 4, 24, 48),

89 
IWL_DECLARE_RATE_INFO
(48, 5, 36, 54),

90 
IWL_DECLARE_RATE_INFO
(54, 6, 48, 
INV
),

91 
IWL_DECLARE_MCS_RATE
(7),

92 
IWL_DECLARE_MCS_RATE
(8),

93 
IWL_DECLARE_MCS_RATE
(9),

96 
	ers_a˘i⁄
 {

97 
	mRS_ACTION_STAY
 = 0,

98 
	mRS_ACTION_DOWNSCALE
 = -1,

99 
	mRS_ACTION_UPSCALE
 = 1,

102 
	ers_cﬁumn_mode
 {

103 
	mRS_INVALID
 = 0,

104 
	mRS_LEGACY
,

105 
	mRS_SISO
,

106 
	mRS_MIMO2
,

109 
	#MAX_NEXT_COLUMNS
 7

	)

110 
	#MAX_COLUMN_CHECKS
 3

	)

112 
	grs_tx_cﬁumn
;

114 
	$boﬁ
 (*
	tÆlow_cﬁumn_func_t
Ë(
	tiwl_mvm
 *
	tmvm
,

115 
	tõì80211_°a
 *
	t°a
,

116 
	trs_øã
 *
	tøã
,

117 c⁄° 
	trs_tx_cﬁumn
 *
	t√xt_cﬁ
);

119 
	srs_tx_cﬁumn
 {

120 
rs_cﬁumn_mode
 
mode
;

121 
u8
 
™t
;

122 
boﬁ
 
sgi
;

123 
rs_cﬁumn
 
√xt_cﬁumns
[
MAX_NEXT_COLUMNS
];

124 
Ælow_cﬁumn_func_t
 
checks
[
MAX_COLUMN_CHECKS
];

127 
boﬁ
 
	$rs_™t_Ælow
(
iwl_mvm
 *
mvm
, 
õì80211_°a
 *
°a
,

128 
rs_øã
 *
øã
,

129 c⁄° 
rs_tx_cﬁumn
 *
√xt_cﬁ
)

131  
	`iwl_mvm_bt_c€x_is_™t_avaû
(
mvm
, 
√xt_cﬁ
->
™t
);

132 
	}
}

134 
boﬁ
 
	$rs_mimo_Ælow
(
iwl_mvm
 *
mvm
, 
õì80211_°a
 *
°a
,

135 
rs_øã
 *
øã
,

136 c⁄° 
rs_tx_cﬁumn
 *
√xt_cﬁ
)

138 i‡(!
°a
->
deÊök
.
ht_ˇp
.
ht_suµ‹ãd
)

139  
Ál£
;

141 i‡(
°a
->
deÊök
.
smps_mode
 =
IEEE80211_SMPS_STATIC
)

142  
Ál£
;

144 i‡(
	`num_of_™t
(
	`iwl_mvm_gë_vÆid_tx_™t
(
mvm
)) < 2)

145  
Ál£
;

147 i‡(!
	`iwl_mvm_bt_c€x_is_mimo_Ælowed
(
mvm
, 
°a
))

148  
Ál£
;

150 i‡(
mvm
->
nvm_d©a
->
sku_ˇp_mimo_dißbÀd
)

151  
Ál£
;

153  
åue
;

154 
	}
}

156 
boﬁ
 
	$rs_siso_Ælow
(
iwl_mvm
 *
mvm
, 
õì80211_°a
 *
°a
,

157 
rs_øã
 *
øã
,

158 c⁄° 
rs_tx_cﬁumn
 *
√xt_cﬁ
)

160 i‡(!
°a
->
deÊök
.
ht_ˇp
.
ht_suµ‹ãd
)

161  
Ál£
;

163  
åue
;

164 
	}
}

166 
boﬁ
 
	$rs_sgi_Ælow
(
iwl_mvm
 *
mvm
, 
õì80211_°a
 *
°a
,

167 
rs_øã
 *
øã
,

168 c⁄° 
rs_tx_cﬁumn
 *
√xt_cﬁ
)

170 
õì80211_°a_ht_ˇp
 *
ht_ˇp
 = &
°a
->
deÊök
.ht_cap;

171 
õì80211_°a_vht_ˇp
 *
vht_ˇp
 = &
°a
->
deÊök
.vht_cap;

173 i‡(
	`is_ht20
(
øã
Ë&& (
ht_ˇp
->
ˇp
 &

174 
IEEE80211_HT_CAP_SGI_20
))

175  
åue
;

176 i‡(
	`is_ht40
(
øã
Ë&& (
ht_ˇp
->
ˇp
 &

177 
IEEE80211_HT_CAP_SGI_40
))

178  
åue
;

179 i‡(
	`is_ht80
(
øã
Ë&& (
vht_ˇp
->
ˇp
 &

180 
IEEE80211_VHT_CAP_SHORT_GI_80
))

181  
åue
;

182 i‡(
	`is_ht160
(
øã
Ë&& (
vht_ˇp
->
ˇp
 &

183 
IEEE80211_VHT_CAP_SHORT_GI_160
))

184  
åue
;

186  
Ál£
;

187 
	}
}

189 c⁄° 
rs_tx_cﬁumn
 
	grs_tx_cﬁumns
[] = {

190 [
RS_COLUMN_LEGACY_ANT_A
] = {

191 .
mode
 = 
RS_LEGACY
,

192 .
	g™t
 = 
ANT_A
,

193 .
	g√xt_cﬁumns
 = {

194 
RS_COLUMN_LEGACY_ANT_B
,

195 
RS_COLUMN_SISO_ANT_A
,

196 
RS_COLUMN_MIMO2
,

197 
RS_COLUMN_INVALID
,

198 
RS_COLUMN_INVALID
,

199 
RS_COLUMN_INVALID
,

200 
RS_COLUMN_INVALID
,

202 .
	gchecks
 = {

203 
rs_™t_Ælow
,

206 [
RS_COLUMN_LEGACY_ANT_B
] = {

207 .
mode
 = 
RS_LEGACY
,

208 .
	g™t
 = 
ANT_B
,

209 .
	g√xt_cﬁumns
 = {

210 
RS_COLUMN_LEGACY_ANT_A
,

211 
RS_COLUMN_SISO_ANT_B
,

212 
RS_COLUMN_MIMO2
,

213 
RS_COLUMN_INVALID
,

214 
RS_COLUMN_INVALID
,

215 
RS_COLUMN_INVALID
,

216 
RS_COLUMN_INVALID
,

218 .
	gchecks
 = {

219 
rs_™t_Ælow
,

222 [
RS_COLUMN_SISO_ANT_A
] = {

223 .
mode
 = 
RS_SISO
,

224 .
	g™t
 = 
ANT_A
,

225 .
	g√xt_cﬁumns
 = {

226 
RS_COLUMN_SISO_ANT_B
,

227 
RS_COLUMN_MIMO2
,

228 
RS_COLUMN_SISO_ANT_A_SGI
,

229 
RS_COLUMN_LEGACY_ANT_A
,

230 
RS_COLUMN_LEGACY_ANT_B
,

231 
RS_COLUMN_INVALID
,

232 
RS_COLUMN_INVALID
,

234 .
	gchecks
 = {

235 
rs_siso_Ælow
,

236 
rs_™t_Ælow
,

239 [
RS_COLUMN_SISO_ANT_B
] = {

240 .
mode
 = 
RS_SISO
,

241 .
	g™t
 = 
ANT_B
,

242 .
	g√xt_cﬁumns
 = {

243 
RS_COLUMN_SISO_ANT_A
,

244 
RS_COLUMN_MIMO2
,

245 
RS_COLUMN_SISO_ANT_B_SGI
,

246 
RS_COLUMN_LEGACY_ANT_A
,

247 
RS_COLUMN_LEGACY_ANT_B
,

248 
RS_COLUMN_INVALID
,

249 
RS_COLUMN_INVALID
,

251 .
	gchecks
 = {

252 
rs_siso_Ælow
,

253 
rs_™t_Ælow
,

256 [
RS_COLUMN_SISO_ANT_A_SGI
] = {

257 .
mode
 = 
RS_SISO
,

258 .
	g™t
 = 
ANT_A
,

259 .
	gsgi
 = 
åue
,

260 .
	g√xt_cﬁumns
 = {

261 
RS_COLUMN_SISO_ANT_B_SGI
,

262 
RS_COLUMN_MIMO2_SGI
,

263 
RS_COLUMN_SISO_ANT_A
,

264 
RS_COLUMN_LEGACY_ANT_A
,

265 
RS_COLUMN_LEGACY_ANT_B
,

266 
RS_COLUMN_INVALID
,

267 
RS_COLUMN_INVALID
,

269 .
	gchecks
 = {

270 
rs_siso_Ælow
,

271 
rs_™t_Ælow
,

272 
rs_sgi_Ælow
,

275 [
RS_COLUMN_SISO_ANT_B_SGI
] = {

276 .
mode
 = 
RS_SISO
,

277 .
	g™t
 = 
ANT_B
,

278 .
	gsgi
 = 
åue
,

279 .
	g√xt_cﬁumns
 = {

280 
RS_COLUMN_SISO_ANT_A_SGI
,

281 
RS_COLUMN_MIMO2_SGI
,

282 
RS_COLUMN_SISO_ANT_B
,

283 
RS_COLUMN_LEGACY_ANT_A
,

284 
RS_COLUMN_LEGACY_ANT_B
,

285 
RS_COLUMN_INVALID
,

286 
RS_COLUMN_INVALID
,

288 .
	gchecks
 = {

289 
rs_siso_Ælow
,

290 
rs_™t_Ælow
,

291 
rs_sgi_Ælow
,

294 [
RS_COLUMN_MIMO2
] = {

295 .
mode
 = 
RS_MIMO2
,

296 .
	g™t
 = 
ANT_AB
,

297 .
	g√xt_cﬁumns
 = {

298 
RS_COLUMN_SISO_ANT_A
,

299 
RS_COLUMN_MIMO2_SGI
,

300 
RS_COLUMN_LEGACY_ANT_A
,

301 
RS_COLUMN_LEGACY_ANT_B
,

302 
RS_COLUMN_INVALID
,

303 
RS_COLUMN_INVALID
,

304 
RS_COLUMN_INVALID
,

306 .
	gchecks
 = {

307 
rs_mimo_Ælow
,

310 [
RS_COLUMN_MIMO2_SGI
] = {

311 .
mode
 = 
RS_MIMO2
,

312 .
	g™t
 = 
ANT_AB
,

313 .
	gsgi
 = 
åue
,

314 .
	g√xt_cﬁumns
 = {

315 
RS_COLUMN_SISO_ANT_A_SGI
,

316 
RS_COLUMN_MIMO2
,

317 
RS_COLUMN_LEGACY_ANT_A
,

318 
RS_COLUMN_LEGACY_ANT_B
,

319 
RS_COLUMN_INVALID
,

320 
RS_COLUMN_INVALID
,

321 
RS_COLUMN_INVALID
,

323 .
	gchecks
 = {

324 
rs_mimo_Ælow
,

325 
rs_sgi_Ælow
,

330 
ölöe
 
u8
 
	$rs_exåa˘_øã
(
u32
 
øã_n_Êags
)

333  (
u8
)(
øã_n_Êags
 & 
RATE_LEGACY_RATE_MSK_V1
);

334 
	}
}

336 
	$iwl_hwøã_to_∂˝_idx
(
u32
 
øã_n_Êags
)

338 
idx
 = 0;

340 i‡(
øã_n_Êags
 & 
RATE_MCS_HT_MSK_V1
) {

341 
idx
 = 
øã_n_Êags
 & 
RATE_HT_MCS_RATE_CODE_MSK_V1
;

342 
idx
 +
IWL_RATE_MCS_0_INDEX
;

345 i‡(
idx
 >
IWL_RATE_9M_INDEX
)

346 
idx
 += 1;

347 i‡((
idx
 >
IWL_FIRST_HT_RATE
Ë&& (idx <
IWL_LAST_HT_RATE
))

348  
idx
;

349 } i‡(
øã_n_Êags
 & 
RATE_MCS_VHT_MSK_V1
 ||

350 
øã_n_Êags
 & 
RATE_MCS_HE_MSK_V1
) {

351 
idx
 = 
øã_n_Êags
 & 
RATE_VHT_MCS_RATE_CODE_MSK
;

352 
idx
 +
IWL_RATE_MCS_0_INDEX
;

355 i‡(
idx
 >
IWL_RATE_9M_INDEX
)

356 
idx
++;

357 i‡((
idx
 >
IWL_FIRST_VHT_RATE
Ë&& (idx <
IWL_LAST_VHT_RATE
))

358  
idx
;

359 i‡((
øã_n_Êags
 & 
RATE_MCS_HE_MSK_V1
) &&

360 
idx
 <
IWL_LAST_HE_RATE
)

361  
idx
;

365 
u8
 
Àgacy_øã
 = 
	`rs_exåa˘_øã
(
øã_n_Êags
);

366 
idx
 = 0; idx < 
	`ARRAY_SIZE
(
iwl_øãs
); idx++)

367 i‡(
iwl_øãs
[
idx
].
∂˝
 =
Àgacy_øã
)

368  
idx
;

371  
IWL_RATE_INVALID
;

372 
	}
}

374 
rs_øã_sˇÀ_≥rf‹m
(
iwl_mvm
 *
mvm
,

375 
õì80211_°a
 *
°a
,

376 
iwl_lq_°a
 *
lq_°a
,

377 
tid
, 
boﬁ
 
ndp
);

378 
rs_fûl_lq_cmd
(
iwl_mvm
 *
mvm
,

379 
õì80211_°a
 *
°a
,

380 
iwl_lq_°a
 *
lq_°a
,

381 c⁄° 
rs_øã
 *
öôül_øã
);

382 
rs_°ay_ö_èbÀ
(
iwl_lq_°a
 *
lq_°a
, 
boﬁ
 
f‹˚_£¨ch
);

394 c⁄° 
u16
 
	gex≥˘ed_çt_Àgacy
[
IWL_RATE_COUNT
] = {

401 c⁄° 
u16
 
	gex≥˘ed_çt_siso_20MHz
[4][
IWL_RATE_COUNT
] = {

408 c⁄° 
u16
 
	gex≥˘ed_çt_siso_40MHz
[4][
IWL_RATE_COUNT
] = {

415 c⁄° 
u16
 
	gex≥˘ed_çt_siso_80MHz
[4][
IWL_RATE_COUNT
] = {

422 c⁄° 
u16
 
	gex≥˘ed_çt_siso_160MHz
[4][
IWL_RATE_COUNT
] = {

429 c⁄° 
u16
 
	gex≥˘ed_çt_mimo2_20MHz
[4][
IWL_RATE_COUNT
] = {

436 c⁄° 
u16
 
	gex≥˘ed_çt_mimo2_40MHz
[4][
IWL_RATE_COUNT
] = {

443 c⁄° 
u16
 
	gex≥˘ed_çt_mimo2_80MHz
[4][
IWL_RATE_COUNT
] = {

450 c⁄° 
u16
 
	gex≥˘ed_çt_mimo2_160MHz
[4][
IWL_RATE_COUNT
] = {

457 c⁄° *
	$rs_¥ëty_lq_ty≥
(
iwl_èbÀ_ty≥
 
ty≥
)

459 c⁄° * c⁄° 
lq_ty≥s
[] = {

460 [
LQ_NONE
] = "NONE",

461 [
LQ_LEGACY_A
] = "LEGACY_A",

462 [
LQ_LEGACY_G
] = "LEGACY_G",

463 [
LQ_HT_SISO
] = "HT SISO",

464 [
LQ_HT_MIMO2
] = "HT MIMO",

465 [
LQ_VHT_SISO
] = "VHT SISO",

466 [
LQ_VHT_MIMO2
] = "VHT MIMO",

467 [
LQ_HE_SISO
] = "HE SISO",

468 [
LQ_HE_MIMO2
] = "HE MIMO",

471 i‡(
ty≥
 < 
LQ_NONE
 ||Åy≥ >
LQ_MAX
)

474  
lq_ty≥s
[
ty≥
];

475 
	}
}

477 *
	$rs_¥ëty_øã
(c⁄° 
rs_øã
 *
øã
)

479 
buf
[40];

480 c⁄° * c⁄° 
Àgacy_øãs
[] = {

481 [
IWL_RATE_1M_INDEX
] = "1M",

482 [
IWL_RATE_2M_INDEX
] = "2M",

483 [
IWL_RATE_5M_INDEX
] = "5.5M",

484 [
IWL_RATE_11M_INDEX
] = "11M",

485 [
IWL_RATE_6M_INDEX
] = "6M",

486 [
IWL_RATE_9M_INDEX
] = "9M",

487 [
IWL_RATE_12M_INDEX
] = "12M",

488 [
IWL_RATE_18M_INDEX
] = "18M",

489 [
IWL_RATE_24M_INDEX
] = "24M",

490 [
IWL_RATE_36M_INDEX
] = "36M",

491 [
IWL_RATE_48M_INDEX
] = "48M",

492 [
IWL_RATE_54M_INDEX
] = "54M",

494 c⁄° *c⁄° 
ht_vht_øãs
[] = {

495 [
IWL_RATE_MCS_0_INDEX
] = "MCS0",

496 [
IWL_RATE_MCS_1_INDEX
] = "MCS1",

497 [
IWL_RATE_MCS_2_INDEX
] = "MCS2",

498 [
IWL_RATE_MCS_3_INDEX
] = "MCS3",

499 [
IWL_RATE_MCS_4_INDEX
] = "MCS4",

500 [
IWL_RATE_MCS_5_INDEX
] = "MCS5",

501 [
IWL_RATE_MCS_6_INDEX
] = "MCS6",

502 [
IWL_RATE_MCS_7_INDEX
] = "MCS7",

503 [
IWL_RATE_MCS_8_INDEX
] = "MCS8",

504 [
IWL_RATE_MCS_9_INDEX
] = "MCS9",

506 c⁄° *
øã_°r
;

508 i‡(
	`is_ty≥_Àgacy
(
øã
->
ty≥
Ë&& (øã->
ödex
 <
IWL_RATE_54M_INDEX
))

509 
øã_°r
 = 
Àgacy_øãs
[
øã
->
ödex
];

510 i‡((
	`is_ty≥_ht
(
øã
->
ty≥
Ë|| 
	`is_ty≥_vht
(rate->type)) &&

511 (
øã
->
ödex
 >
IWL_RATE_MCS_0_INDEX
) &&

512 (
øã
->
ödex
 <
IWL_RATE_MCS_9_INDEX
))

513 
øã_°r
 = 
ht_vht_øãs
[
øã
->
ödex
];

515 
øã_°r
 = 
NULL
;

517 
	`•rötf
(
buf
, "(%s|%s|%s)", 
	`rs_¥ëty_lq_ty≥
(
øã
->
ty≥
),

518 
	`iwl_rs_¥ëty_™t
(
øã
->
™t
), 
øã_°r
 ?: "BAD_RATE");

519  
buf
;

520 
	}
}

522 
ölöe
 
	$rs_dump_øã
(
iwl_mvm
 *
mvm
, c⁄° 
rs_øã
 *
øã
,

523 c⁄° *
¥efix
)

525 
	`IWL_DEBUG_RATE
(
mvm
,

527 
¥efix
, 
	`rs_¥ëty_øã
(
øã
),Ñ©e->
bw
,

528 
øã
->
sgi
,Ñ©e->
ldpc
,Ñ©e->
°bc
);

529 
	}
}

531 
	$rs_øã_sˇÀ_˛ór_wödow
(
iwl_øã_sˇÀ_d©a
 *
wödow
)

533 
wödow
->
d©a
 = 0;

534 
wödow
->
suc˚ss_cou¡î
 = 0;

535 
wödow
->
suc˚ss_øtio
 = 
IWL_INVALID_VALUE
;

536 
wödow
->
cou¡î
 = 0;

537 
wödow
->
avîage_çt
 = 
IWL_INVALID_VALUE
;

538 
	}
}

540 
	$rs_øã_sˇÀ_˛ór_tbl_wödows
(
iwl_mvm
 *
mvm
,

541 
iwl_sˇÀ_tbl_öfo
 *
tbl
)

543 
i
;

545 
	`IWL_DEBUG_RATE
(
mvm
, "Clearing up window stats\n");

546 
i
 = 0; i < 
IWL_RATE_COUNT
; i++)

547 
	`rs_øã_sˇÀ_˛ór_wödow
(&
tbl
->
wö
[
i
]);

549 
i
 = 0; i < 
	`ARRAY_SIZE
(
tbl
->
çc_wö
); i++)

550 
	`rs_øã_sˇÀ_˛ór_wödow
(&
tbl
->
çc_wö
[
i
]);

551 
	}
}

553 
ölöe
 
u8
 
	$rs_is_vÆid_™t
(
u8
 
vÆid_™ã¬a
, u8 
™t_ty≥
)

555  (
™t_ty≥
 & 
vÆid_™ã¬a
) ==ánt_type;

556 
	}
}

558 
	$rs_é_tu∫_⁄_agg_f‹_tid
(
iwl_mvm
 *
mvm
,

559 
iwl_lq_°a
 *
lq_d©a
, 
u8
 
tid
,

560 
õì80211_°a
 *
°a
)

562 
ªt
;

564 
	`IWL_DEBUG_HT
(
mvm
, "Starting Txágg: STA: %pMÅid: %d\n",

565 
°a
->
addr
, 
tid
);

568 
ªt
 = 
	`õì80211_°¨t_tx_ba_£ssi⁄
(
°a
, 
tid
, 0);

569 i‡(
ªt
 =-
EAGAIN
) {

575 
	`IWL_ERR
(
mvm
, "Fail start Txágg onÅid: %d\n",

576 
tid
);

577 
	`õì80211_°›_tx_ba_£ssi⁄
(
°a
, 
tid
);

579  
ªt
;

580 
	}
}

582 
	$rs_é_tu∫_⁄_agg
(
iwl_mvm
 *
mvm
, 
iwl_mvm_°a
 *
mvm°a
,

583 
u8
 
tid
, 
iwl_lq_°a
 *
lq_°a
,

584 
õì80211_°a
 *
°a
)

586 
iwl_mvm_tid_d©a
 *
tid_d©a
;

592 i‡(
	`WARN_ON_ONCE
(
tid
 > 
IWL_MAX_TID_COUNT
)) {

593 
	`IWL_ERR
(
mvm
, "tidÉxceeds max TID count: %d/%d\n",

594 
tid
, 
IWL_MAX_TID_COUNT
);

596 } i‡(
tid
 =
IWL_MAX_TID_COUNT
) {

600 
tid_d©a
 = &
mvm°a
->tid_d©a[
tid
];

601 i‡(
mvm°a
->
°a_°©e
 >
IEEE80211_STA_AUTHORIZED
 &&

602 
tid_d©a
->
°©e
 =
IWL_AGG_OFF
 &&

603 (
lq_°a
->
tx_agg_tid_í
 & 
	`BIT
(
tid
)) &&

604 
tid_d©a
->
tx_cou¡_œ°
 >
IWL_MVM_RS_AGG_START_THRESHOLD
) {

605 
	`IWL_DEBUG_RATE
(
mvm
, "åyÅÿaggªg©êtid %d\n", 
tid
);

606 i‡(
	`rs_é_tu∫_⁄_agg_f‹_tid
(
mvm
, 
lq_°a
, 
tid
, 
°a
) == 0)

607 
tid_d©a
->
°©e
 = 
IWL_AGG_QUEUED
;

609 
	}
}

611 
ölöe
 
	$gë_num_of_™t_‰om_øã
(
u32
 
øã_n_Êags
)

613  !!(
øã_n_Êags
 & 
RATE_MCS_ANT_A_MSK
) +

614 !!(
øã_n_Êags
 & 
RATE_MCS_ANT_B_MSK
);

615 
	}
}

621 
s32
 
	$gë_ex≥˘ed_çt
(
iwl_sˇÀ_tbl_öfo
 *
tbl
, 
rs_ödex
)

623 i‡(
tbl
->
ex≥˘ed_çt
)

624  
tbl
->
ex≥˘ed_çt
[
rs_ödex
];

626 
	}
}

635 
	$_rs_cﬁÀ˘_tx_d©a
(
iwl_mvm
 *
mvm
,

636 
iwl_sˇÀ_tbl_öfo
 *
tbl
,

637 
sˇÀ_ödex
, 
©ãm±s
, 
suc˚s£s
,

638 
iwl_øã_sˇÀ_d©a
 *
wödow
)

640 c⁄° 
u64
 
mask
 = (((u64)1Ë<< (
IWL_RATE_MAX_WINDOW
 - 1));

641 
s32
 
Áû_cou¡
, 
çt
;

644 
çt
 = 
	`gë_ex≥˘ed_çt
(
tbl
, 
sˇÀ_ödex
);

654 
©ãm±s
 > 0) {

655 i‡(
wödow
->
cou¡î
 >
IWL_RATE_MAX_WINDOW
) {

657 
wödow
->
cou¡î
 = 
IWL_RATE_MAX_WINDOW
 - 1;

659 i‡(
wödow
->
d©a
 & 
mask
) {

660 
wödow
->
d©a
 &~
mask
;

661 
wödow
->
suc˚ss_cou¡î
--;

666 
wödow
->
cou¡î
++;

669 
wödow
->
d©a
 <<= 1;

672 i‡(
suc˚s£s
 > 0) {

673 
wödow
->
suc˚ss_cou¡î
++;

674 
wödow
->
d©a
 |= 0x1;

675 
suc˚s£s
--;

678 
©ãm±s
--;

682 i‡(
wödow
->
cou¡î
 > 0)

683 
wödow
->
suc˚ss_øtio
 = 128 * (100 * wödow->
suc˚ss_cou¡î
)

684 / 
wödow
->
cou¡î
;

686 
wödow
->
suc˚ss_øtio
 = 
IWL_INVALID_VALUE
;

688 
Áû_cou¡
 = 
wödow
->
cou¡î
 - wödow->
suc˚ss_cou¡î
;

691 i‡((
Áû_cou¡
 >
IWL_MVM_RS_RATE_MIN_FAILURE_TH
) ||

692 (
wödow
->
suc˚ss_cou¡î
 >
IWL_MVM_RS_RATE_MIN_SUCCESS_TH
))

693 
wödow
->
avîage_çt
 = (wödow->
suc˚ss_øtio
 * 
çt
 + 64) / 128;

695 
wödow
->
avîage_çt
 = 
IWL_INVALID_VALUE
;

698 
	}
}

700 
	$rs_cﬁÀ˘_çc_d©a
(
iwl_mvm
 *
mvm
,

701 
iwl_lq_°a
 *
lq_°a
,

702 
iwl_sˇÀ_tbl_öfo
 *
tbl
,

703 
sˇÀ_ödex
, 
©ãm±s
, 
suc˚s£s
,

704 
u8
 
ªdu˚d_txp
)

706 
iwl_øã_sˇÀ_d©a
 *
wödow
 = 
NULL
;

708 i‡(
	`WARN_ON_ONCE
(
ªdu˚d_txp
 > 
TPC_MAX_REDUCTION
))

709  -
EINVAL
;

711 
wödow
 = &
tbl
->
çc_wö
[
ªdu˚d_txp
];

712  
	`_rs_cﬁÀ˘_tx_d©a
(
mvm
, 
tbl
, 
sˇÀ_ödex
, 
©ãm±s
, 
suc˚s£s
,

713 
wödow
);

714 
	}
}

716 
	$rs_upd©e_tid_çt_°©s
(
iwl_mvm
 *
mvm
,

717 
iwl_mvm_°a
 *
mvm°a
,

718 
u8
 
tid
, 
suc˚s£s
)

720 
iwl_mvm_tid_d©a
 *
tid_d©a
;

722 i‡(
tid
 >
IWL_MAX_TID_COUNT
)

725 
tid_d©a
 = &
mvm°a
->tid_d©a[
tid
];

733 i‡(
tid_d©a
->
°©e
 !
IWL_AGG_OFF
)

736 i‡(
	`time_is_bef‹e_jiffõs
(
tid_d©a
->
çt_mós_°¨t
 + 
HZ
) ||

737 (
tid_d©a
->
tx_cou¡
 >
IWL_MVM_RS_AGG_START_THRESHOLD
)) {

738 
tid_d©a
->
tx_cou¡_œ°
 =Åid_d©a->
tx_cou¡
;

739 
tid_d©a
->
tx_cou¡
 = 0;

740 
tid_d©a
->
çt_mós_°¨t
 = 
jiffõs
;

742 
tid_d©a
->
tx_cou¡
 +
suc˚s£s
;

744 
	}
}

746 
	$rs_cﬁÀ˘_éc_d©a
(
iwl_mvm
 *
mvm
,

747 
iwl_mvm_°a
 *
mvm°a
, 
u8
 
tid
,

748 
iwl_sˇÀ_tbl_öfo
 *
tbl
,

749 
sˇÀ_ödex
, 
©ãm±s
, 
suc˚s£s
)

751 
iwl_øã_sˇÀ_d©a
 *
wödow
 = 
NULL
;

753 i‡(
sˇÀ_ödex
 < 0 || sˇÀ_ödex >
IWL_RATE_COUNT
)

754  -
EINVAL
;

756 i‡(
tbl
->
cﬁumn
 !
RS_COLUMN_INVALID
) {

757 
lq_°a_≥rs
 *
≥rs
 = &
mvm°a
->
deÊök
.
lq_°a
.
rs_drv
.pers;

759 
≥rs
->
tx_°©s
[
tbl
->
cﬁumn
][
sˇÀ_ödex
].
tŸÆ
 +
©ãm±s
;

760 
≥rs
->
tx_°©s
[
tbl
->
cﬁumn
][
sˇÀ_ödex
].
suc˚ss
 +
suc˚s£s
;

763 
	`rs_upd©e_tid_çt_°©s
(
mvm
, 
mvm°a
, 
tid
, 
suc˚s£s
);

766 
wödow
 = &(
tbl
->
wö
[
sˇÀ_ödex
]);

767  
	`_rs_cﬁÀ˘_tx_d©a
(
mvm
, 
tbl
, 
sˇÀ_ödex
, 
©ãm±s
, 
suc˚s£s
,

768 
wödow
);

769 
	}
}

772 
u32
 
	$ucode_øã_‰om_rs_øã
(
iwl_mvm
 *
mvm
,

773 
rs_øã
 *
øã
)

775 
u32
 
ucode_øã
 = 0;

776 
ödex
 = 
øã
->index;

778 
ucode_øã
 |((
øã
->
™t
 << 
RATE_MCS_ANT_POS
) &

779 
RATE_MCS_ANT_AB_MSK
);

781 i‡(
	`is_Àgacy
(
øã
)) {

782 
ucode_øã
 |
iwl_øãs
[
ödex
].
∂˝
;

783 i‡(
ödex
 >
IWL_FIRST_CCK_RATE
 && index <
IWL_LAST_CCK_RATE
)

784 
ucode_øã
 |
RATE_MCS_CCK_MSK_V1
;

785  
ucode_øã
;

792 
ucode_øã
 |
RATE_MCS_RTS_REQUIRED_MSK
;

794 i‡(
	`is_ht
(
øã
)) {

795 i‡(
ödex
 < 
IWL_FIRST_HT_RATE
 || index > 
IWL_LAST_HT_RATE
) {

796 
	`IWL_ERR
(
mvm
, "InvÆid HTÑ©êödex %d\n", 
ödex
);

797 
ödex
 = 
IWL_LAST_HT_RATE
;

799 
ucode_øã
 |
RATE_MCS_HT_MSK_V1
;

801 i‡(
	`is_ht_siso
(
øã
))

802 
ucode_øã
 |
iwl_øãs
[
ödex
].
∂˝_ht_siso
;

803 i‡(
	`is_ht_mimo2
(
øã
))

804 
ucode_øã
 |
iwl_øãs
[
ödex
].
∂˝_ht_mimo2
;

806 
	`WARN_ON_ONCE
(1);

807 } i‡(
	`is_vht
(
øã
)) {

808 i‡(
ödex
 < 
IWL_FIRST_VHT_RATE
 || index > 
IWL_LAST_VHT_RATE
) {

809 
	`IWL_ERR
(
mvm
, "InvÆid VHTÑ©êödex %d\n", 
ödex
);

810 
ödex
 = 
IWL_LAST_VHT_RATE
;

812 
ucode_øã
 |
RATE_MCS_VHT_MSK_V1
;

813 i‡(
	`is_vht_siso
(
øã
))

814 
ucode_øã
 |
iwl_øãs
[
ödex
].
∂˝_vht_siso
;

815 i‡(
	`is_vht_mimo2
(
øã
))

816 
ucode_øã
 |
iwl_øãs
[
ödex
].
∂˝_vht_mimo2
;

818 
	`WARN_ON_ONCE
(1);

821 
	`IWL_ERR
(
mvm
, "InvÆidÑ©e->ty≥ %d\n", 
øã
->
ty≥
);

824 i‡(
	`is_siso
(
øã
Ë&&Ñ©e->
°bc
) {

826 
ucode_øã
 |
RATE_MCS_ANT_AB_MSK
;

827 
ucode_øã
 |
RATE_MCS_STBC_MSK
;

830 
ucode_øã
 |
øã
->
bw
;

831 i‡(
øã
->
sgi
)

832 
ucode_øã
 |
RATE_MCS_SGI_MSK_V1
;

833 i‡(
øã
->
ldpc
)

834 
ucode_øã
 |
RATE_MCS_LDPC_MSK_V1
;

836  
ucode_øã
;

837 
	}
}

840 
	$rs_øã_‰om_ucode_øã
(c⁄° 
u32
 
ucode_øã
,

841 
∆80211_b™d
 
b™d
,

842 
rs_øã
 *
øã
)

844 
u32
 
™t_msk
 = 
ucode_øã
 & 
RATE_MCS_ANT_AB_MSK
;

845 
u8
 
num_of_™t
 = 
	`gë_num_of_™t_‰om_øã
(
ucode_øã
);

846 
u8
 
nss
;

848 
	`mem£t
(
øã
, 0, (*rate));

849 
øã
->
ödex
 = 
	`iwl_hwøã_to_∂˝_idx
(
ucode_øã
);

851 i‡(
øã
->
ödex
 =
IWL_RATE_INVALID
)

852  -
EINVAL
;

854 
øã
->
™t
 = (
™t_msk
 >> 
RATE_MCS_ANT_POS
);

857 i‡(!(
ucode_øã
 & 
RATE_MCS_HT_MSK_V1
) &&

858 !(
ucode_øã
 & 
RATE_MCS_VHT_MSK_V1
) &&

859 !(
ucode_øã
 & 
RATE_MCS_HE_MSK_V1
)) {

860 i‡(
num_of_™t
 == 1) {

861 i‡(
b™d
 =
NL80211_BAND_5GHZ
)

862 
øã
->
ty≥
 = 
LQ_LEGACY_A
;

864 
øã
->
ty≥
 = 
LQ_LEGACY_G
;

871 i‡(
ucode_øã
 & 
RATE_MCS_SGI_MSK_V1
)

872 
øã
->
sgi
 = 
åue
;

873 i‡(
ucode_øã
 & 
RATE_MCS_LDPC_MSK_V1
)

874 
øã
->
ldpc
 = 
åue
;

875 i‡(
ucode_øã
 & 
RATE_MCS_STBC_MSK
)

876 
øã
->
°bc
 = 
åue
;

877 i‡(
ucode_øã
 & 
RATE_MCS_BF_MSK
)

878 
øã
->
b„r
 = 
åue
;

880 
øã
->
bw
 = 
ucode_øã
 & 
RATE_MCS_CHAN_WIDTH_MSK_V1
;

882 i‡(
ucode_øã
 & 
RATE_MCS_HT_MSK_V1
) {

883 
nss
 = ((
ucode_øã
 & 
RATE_HT_MCS_NSS_MSK_V1
) >>

884 
RATE_HT_MCS_NSS_POS_V1
) + 1;

886 i‡(
nss
 == 1) {

887 
øã
->
ty≥
 = 
LQ_HT_SISO
;

888 
	`WARN_ONCE
(!
øã
->
°bc
 && !øã->
b„r
 && 
num_of_™t
 != 1,

890 
øã
->
°bc
,Ñ©e->
b„r
);

891 } i‡(
nss
 == 2) {

892 
øã
->
ty≥
 = 
LQ_HT_MIMO2
;

893 
	`WARN_ON_ONCE
(
num_of_™t
 != 2);

895 
	`WARN_ON_ONCE
(1);

897 } i‡(
ucode_øã
 & 
RATE_MCS_VHT_MSK_V1
) {

898 
nss
 = 
	`FIELD_GET
(
RATE_MCS_NSS_MSK
, 
ucode_øã
) + 1;

900 i‡(
nss
 == 1) {

901 
øã
->
ty≥
 = 
LQ_VHT_SISO
;

902 
	`WARN_ONCE
(!
øã
->
°bc
 && !øã->
b„r
 && 
num_of_™t
 != 1,

904 
øã
->
°bc
,Ñ©e->
b„r
);

905 } i‡(
nss
 == 2) {

906 
øã
->
ty≥
 = 
LQ_VHT_MIMO2
;

907 
	`WARN_ON_ONCE
(
num_of_™t
 != 2);

909 
	`WARN_ON_ONCE
(1);

911 } i‡(
ucode_øã
 & 
RATE_MCS_HE_MSK_V1
) {

912 
nss
 = 
	`FIELD_GET
(
RATE_MCS_NSS_MSK
, 
ucode_øã
) + 1;

914 i‡(
nss
 == 1) {

915 
øã
->
ty≥
 = 
LQ_HE_SISO
;

916 
	`WARN_ONCE
(!
øã
->
°bc
 && !øã->
b„r
 && 
num_of_™t
 != 1,

917 "°b¯%d b„∏%d", 
øã
->
°bc
,Ñ©e->
b„r
);

918 } i‡(
nss
 == 2) {

919 
øã
->
ty≥
 = 
LQ_HE_MIMO2
;

920 
	`WARN_ON_ONCE
(
num_of_™t
 != 2);

922 
	`WARN_ON_ONCE
(1);

926 
	`WARN_ON_ONCE
(
øã
->
bw
 =
RATE_MCS_CHAN_WIDTH_80
 &&

927 !
	`is_he
(
øã
Ë&& !
	`is_vht
(rate));

930 
	}
}

934 
	$rs_toggÀ_™ã¬a
(
u32
 
vÆid_™t
, 
rs_øã
 *
øã
)

936 
u8
 
√w_™t_ty≥
;

938 i‡(!
	`rs_is_vÆid_™t
(
vÆid_™t
, 
øã
->
™t
))

941 
√w_™t_ty≥
 = 
™t_toggÀ_lookup
[
øã
->
™t
];

943 (
√w_™t_ty≥
 !
øã
->
™t
) &&

944 !
	`rs_is_vÆid_™t
(
vÆid_™t
, 
√w_™t_ty≥
))

945 
√w_™t_ty≥
 = 
™t_toggÀ_lookup
[new_ant_type];

947 i‡(
√w_™t_ty≥
 =
øã
->
™t
)

950 
øã
->
™t
 = 
√w_™t_ty≥
;

953 
	}
}

955 
u16
 
	$rs_gë_suµ‹ãd_øãs
(
iwl_lq_°a
 *
lq_°a
,

956 
rs_øã
 *
øã
)

958 i‡(
	`is_Àgacy
(
øã
))

959  
lq_°a
->
a˘ive_Àgacy_øã
;

960 i‡(
	`is_siso
(
øã
))

961  
lq_°a
->
a˘ive_siso_øã
;

962 i‡(
	`is_mimo2
(
øã
))

963  
lq_°a
->
a˘ive_mimo2_øã
;

965 
	`WARN_ON_ONCE
(1);

967 
	}
}

969 
u16
 
	$rs_gë_adja˚¡_øã
(
iwl_mvm
 *
mvm
, 
u8
 
ödex
, 
u16
 
øã_mask
,

970 
øã_ty≥
)

972 
u8
 
high
 = 
IWL_RATE_INVALID
;

973 
u8
 
low
 = 
IWL_RATE_INVALID
;

977 i‡(
	`is_ty≥_a_b™d
(
øã_ty≥
Ë|| !
	`is_ty≥_Àgacy
(rate_type)) {

978 
i
;

979 
u32
 
mask
;

982 
i
 = 
ödex
 - 1;

983 i‡(
i
 >= 0)

984 
mask
 = 
	`BIT
(
i
);

985 ; 
i
 >0; i--, 
mask
 >>= 1) {

986 i‡(
øã_mask
 & 
mask
) {

987 
low
 = 
i
;

993 
i
 = 
ödex
 + 1;

994 
mask
 = (1 << 
i
); i < 
IWL_RATE_COUNT
; i++, mask <<= 1) {

995 i‡(
øã_mask
 & 
mask
) {

996 
high
 = 
i
;

1001  (
high
 << 8Ë| 
low
;

1004 
low
 = 
ödex
;

1005 
low
 !
IWL_RATE_INVALID
) {

1006 
low
 = 
iwl_øãs
[low].
¥ev_rs
;

1007 i‡(
low
 =
IWL_RATE_INVALID
)

1009 i‡(
øã_mask
 & (1 << 
low
))

1013 
high
 = 
ödex
;

1014 
high
 !
IWL_RATE_INVALID
) {

1015 
high
 = 
iwl_øãs
[high].
√xt_rs
;

1016 i‡(
high
 =
IWL_RATE_INVALID
)

1018 i‡(
øã_mask
 & (1 << 
high
))

1022  (
high
 << 8Ë| 
low
;

1023 
	}
}

1025 
ölöe
 
boﬁ
 
	$rs_øã_suµ‹ãd
(
iwl_lq_°a
 *
lq_°a
,

1026 
rs_øã
 *
øã
)

1028  
	`BIT
(
øã
->
ödex
Ë& 
	`rs_gë_suµ‹ãd_øãs
(
lq_°a
,Ñate);

1029 
	}
}

1034 
boﬁ
 
	$rs_gë_lowî_øã_ö_cﬁumn
(
iwl_lq_°a
 *
lq_°a
,

1035 
rs_øã
 *
øã
)

1037 
u8
 
low
;

1038 
u16
 
high_low
;

1039 
u16
 
øã_mask
;

1040 
iwl_mvm
 *
mvm
 = 
lq_°a
->
≥rs
.
drv
;

1042 
øã_mask
 = 
	`rs_gë_suµ‹ãd_øãs
(
lq_°a
, 
øã
);

1043 
high_low
 = 
	`rs_gë_adja˚¡_øã
(
mvm
, 
øã
->
ödex
, 
øã_mask
,

1044 
øã
->
ty≥
);

1045 
low
 = 
high_low
 & 0xff;

1048 i‡(
low
 =
IWL_RATE_INVALID
)

1049  
åue
;

1051 
øã
->
ödex
 = 
low
;

1052  
Ál£
;

1053 
	}
}

1056 
	$rs_gë_lowî_øã_down_cﬁumn
(
iwl_lq_°a
 *
lq_°a
,

1057 
rs_øã
 *
øã
)

1059 
iwl_mvm
 *
mvm
 = 
lq_°a
->
≥rs
.
drv
;

1061 i‡(
	`is_Àgacy
(
øã
)) {

1064 } i‡(
	`is_siso
(
øã
)) {

1066 i‡(
lq_°a
->
b™d
 =
NL80211_BAND_5GHZ
)

1067 
øã
->
ty≥
 = 
LQ_LEGACY_A
;

1069 
øã
->
ty≥
 = 
LQ_LEGACY_G
;

1071 
øã
->
bw
 = 
RATE_MCS_CHAN_WIDTH_20
;

1073 i‡(
	`WARN_ON_ONCE
(
øã
->
ödex
 < 
IWL_RATE_MCS_0_INDEX
))

1074 
øã
->
ödex
 = 
rs_ht_to_Àgacy
[
IWL_RATE_MCS_0_INDEX
];

1075 i‡(
	`WARN_ON_ONCE
(
øã
->
ödex
 > 
IWL_RATE_MCS_9_INDEX
))

1076 
øã
->
ödex
 = 
rs_ht_to_Àgacy
[
IWL_RATE_MCS_9_INDEX
];

1078 
øã
->
ödex
 = 
rs_ht_to_Àgacy
[rate->index];

1080 
øã
->
ldpc
 = 
Ál£
;

1083 
øã
->
ty≥
 = 
	`is_vht_mimo2
(rate) ?

1084 
LQ_VHT_SISO
 : 
LQ_HT_SISO
;

1087 i‡(
	`num_of_™t
(
øã
->
™t
) > 1)

1088 
øã
->
™t
 = 
	`fú°_™ã¬a
(
	`iwl_mvm_gë_vÆid_tx_™t
(
mvm
));

1091 
øã
->
sgi
 = 
Ál£
;

1093 i‡(!
	`rs_øã_suµ‹ãd
(
lq_°a
, 
øã
))

1094 
	`rs_gë_lowî_øã_ö_cﬁumn
(
lq_°a
, 
øã
);

1095 
	}
}

1098 
ölöe
 
boﬁ
 
	$rs_øã_cﬁumn_m©ch
(
rs_øã
 *
a
,

1099 
rs_øã
 *
b
)

1101 
boﬁ
 
™t_m©ch
;

1103 i‡(
a
->
°bc
 ||á->
b„r
)

1104 
™t_m©ch
 = (
b
->
™t
 =
ANT_A
 || b->™à=
ANT_B
);

1106 
™t_m©ch
 = (
a
->
™t
 =
b
->ant);

1108  (
a
->
ty≥
 =
b
->ty≥Ë&& (a->
bw
 =b->bwË&& (a->
sgi
 == b->sgi)

1109 && 
™t_m©ch
;

1110 
	}
}

1112 
ölöe
 
rs_cﬁumn
 
	$rs_gë_cﬁumn_‰om_øã
(
rs_øã
 *
øã
)

1114 i‡(
	`is_Àgacy
(
øã
)) {

1115 i‡(
øã
->
™t
 =
ANT_A
)

1116  
RS_COLUMN_LEGACY_ANT_A
;

1118 i‡(
øã
->
™t
 =
ANT_B
)

1119  
RS_COLUMN_LEGACY_ANT_B
;

1121 
îr
;

1124 i‡(
	`is_siso
(
øã
)) {

1125 i‡(
øã
->
™t
 =
ANT_A
 ||Ñ©e->
°bc
 ||Ñ©e->
b„r
)

1126  
øã
->
sgi
 ? 
RS_COLUMN_SISO_ANT_A_SGI
 :

1127 
RS_COLUMN_SISO_ANT_A
;

1129 i‡(
øã
->
™t
 =
ANT_B
)

1130  
øã
->
sgi
 ? 
RS_COLUMN_SISO_ANT_B_SGI
 :

1131 
RS_COLUMN_SISO_ANT_B
;

1133 
îr
;

1136 i‡(
	`is_mimo
(
øã
))

1137  
øã
->
sgi
 ? 
RS_COLUMN_MIMO2_SGI
 : 
RS_COLUMN_MIMO2
;

1139 
îr
:

1140  
RS_COLUMN_INVALID
;

1141 
	}
}

1143 
u8
 
	$rs_gë_tid
(
õì80211_hdr
 *
hdr
)

1145 
u8
 
tid
 = 
IWL_MAX_TID_COUNT
;

1147 i‡(
	`õì80211_is_d©a_qos
(
hdr
->
‰ame_c⁄åﬁ
)) {

1148 
u8
 *
qc
 = 
	`õì80211_gë_qos_˘l
(
hdr
);

1149 
tid
 = 
qc
[0] & 0xf;

1152 i‡(
	`u∆ikñy
(
tid
 > 
IWL_MAX_TID_COUNT
))

1153 
tid
 = 
IWL_MAX_TID_COUNT
;

1155  
tid
;

1156 
	}
}

1161 
	$rs_drv_mac80211_tx_°©us
(*
mvm_r
,

1162 
õì80211_suµ‹ãd_b™d
 *
sb™d
,

1163 
õì80211_°a
 *
°a
, *
¥iv_°a
,

1164 
sk_buff
 *
skb
)

1166 
õì80211_hdr
 *
hdr
 = (õì80211_hd∏*)
skb
->
d©a
;

1167 
iwl_›_mode
 *
›_mode
 = 
mvm_r
;

1168 
iwl_mvm
 *
mvm
 = 
	`IWL_OP_MODE_GET_MVM
(
›_mode
);

1169 
õì80211_tx_öfo
 *
öfo
 = 
	`IEEE80211_SKB_CB
(
skb
);

1170 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

1172 i‡(!
mvm°a
->
vif
)

1175 i‡(!
	`õì80211_is_d©a
(
hdr
->
‰ame_c⁄åﬁ
) ||

1176 
öfo
->
Êags
 & 
IEEE80211_TX_CTL_NO_ACK
)

1179 
	`iwl_mvm_rs_tx_°©us
(
mvm
, 
°a
, 
	`rs_gë_tid
(
hdr
), 
öfo
,

1180 
	`õì80211_is_qos_nuŒfunc
(
hdr
->
‰ame_c⁄åﬁ
));

1181 
	}
}

1191 
	$rs_£t_°ay_ö_èbÀ
(
iwl_mvm
 *
mvm
, 
u8
 
is_Àgacy
,

1192 
iwl_lq_°a
 *
lq_°a
)

1194 
	`IWL_DEBUG_RATE
(
mvm
, "MovingÅo RS_STATE_STAY_IN_COLUMN\n");

1195 
lq_°a
->
rs_°©e
 = 
RS_STATE_STAY_IN_COLUMN
;

1196 i‡(
is_Àgacy
) {

1197 
lq_°a
->
èbÀ_cou¡_limô
 = 
IWL_MVM_RS_LEGACY_TABLE_COUNT
;

1198 
lq_°a
->
max_Áûuª_limô
 = 
IWL_MVM_RS_LEGACY_FAILURE_LIMIT
;

1199 
lq_°a
->
max_suc˚ss_limô
 = 
IWL_MVM_RS_LEGACY_SUCCESS_LIMIT
;

1201 
lq_°a
->
èbÀ_cou¡_limô
 = 
IWL_MVM_RS_NON_LEGACY_TABLE_COUNT
;

1202 
lq_°a
->
max_Áûuª_limô
 = 
IWL_MVM_RS_NON_LEGACY_FAILURE_LIMIT
;

1203 
lq_°a
->
max_suc˚ss_limô
 = 
IWL_MVM_RS_NON_LEGACY_SUCCESS_LIMIT
;

1205 
lq_°a
->
èbÀ_cou¡
 = 0;

1206 
lq_°a
->
tŸÆ_Áûed
 = 0;

1207 
lq_°a
->
tŸÆ_suc˚ss
 = 0;

1208 
lq_°a
->
Êush_timî
 = 
jiffõs
;

1209 
lq_°a
->
visôed_cﬁumns
 = 0;

1210 
	}
}

1212 
ölöe
 
	$rs_gë_max_øã_‰om_mask
(
øã_mask
)

1214 i‡(
øã_mask
)

1215  
	`föd_œ°_bô
(&
øã_mask
, 
BITS_PER_LONG
);

1216  
IWL_RATE_INVALID
;

1217 
	}
}

1219 
	$rs_gë_max_Ælowed_øã
(
iwl_lq_°a
 *
lq_°a
,

1220 c⁄° 
rs_tx_cﬁumn
 *
cﬁumn
)

1222 
cﬁumn
->
mode
) {

1223 
RS_LEGACY
:

1224  
lq_°a
->
max_Àgacy_øã_idx
;

1225 
RS_SISO
:

1226  
lq_°a
->
max_siso_øã_idx
;

1227 
RS_MIMO2
:

1228  
lq_°a
->
max_mimo2_øã_idx
;

1230 
	`WARN_ON_ONCE
(1);

1233  
lq_°a
->
max_Àgacy_øã_idx
;

1234 
	}
}

1236 c⁄° 
u16
 *
	$rs_gë_ex≥˘ed_çt_èbÀ
(
iwl_lq_°a
 *
lq_°a
,

1237 c⁄° 
rs_tx_cﬁumn
 *
cﬁumn
,

1238 
u32
 
bw
)

1241 c⁄° 
	`u16
 (*
ht_tbl_poöãr
)[
IWL_RATE_COUNT
];

1243 i‡(
	`WARN_ON_ONCE
(
cﬁumn
->
mode
 !
RS_LEGACY
 &&

1244 
cﬁumn
->
mode
 !
RS_SISO
 &&

1245 
cﬁumn
->
mode
 !
RS_MIMO2
))

1246  
ex≥˘ed_çt_Àgacy
;

1249 i‡(
cﬁumn
->
mode
 =
RS_LEGACY
)

1250  
ex≥˘ed_çt_Àgacy
;

1252 
ht_tbl_poöãr
 = 
ex≥˘ed_çt_mimo2_20MHz
;

1256 i‡(
cﬁumn
->
mode
 =
RS_SISO
) {

1257 
bw
) {

1258 
RATE_MCS_CHAN_WIDTH_20
:

1259 
ht_tbl_poöãr
 = 
ex≥˘ed_çt_siso_20MHz
;

1261 
RATE_MCS_CHAN_WIDTH_40
:

1262 
ht_tbl_poöãr
 = 
ex≥˘ed_çt_siso_40MHz
;

1264 
RATE_MCS_CHAN_WIDTH_80
:

1265 
ht_tbl_poöãr
 = 
ex≥˘ed_çt_siso_80MHz
;

1267 
RATE_MCS_CHAN_WIDTH_160
:

1268 
ht_tbl_poöãr
 = 
ex≥˘ed_çt_siso_160MHz
;

1271 
	`WARN_ON_ONCE
(1);

1273 } i‡(
cﬁumn
->
mode
 =
RS_MIMO2
) {

1274 
bw
) {

1275 
RATE_MCS_CHAN_WIDTH_20
:

1276 
ht_tbl_poöãr
 = 
ex≥˘ed_çt_mimo2_20MHz
;

1278 
RATE_MCS_CHAN_WIDTH_40
:

1279 
ht_tbl_poöãr
 = 
ex≥˘ed_çt_mimo2_40MHz
;

1281 
RATE_MCS_CHAN_WIDTH_80
:

1282 
ht_tbl_poöãr
 = 
ex≥˘ed_çt_mimo2_80MHz
;

1284 
RATE_MCS_CHAN_WIDTH_160
:

1285 
ht_tbl_poöãr
 = 
ex≥˘ed_çt_mimo2_160MHz
;

1288 
	`WARN_ON_ONCE
(1);

1291 
	`WARN_ON_ONCE
(1);

1294 i‡(!
cﬁumn
->
sgi
 && !
lq_°a
->
is_agg
)

1295  
ht_tbl_poöãr
[0];

1296 i‡(
cﬁumn
->
sgi
 && !
lq_°a
->
is_agg
)

1297  
ht_tbl_poöãr
[1];

1298 i‡(!
cﬁumn
->
sgi
 && 
lq_°a
->
is_agg
)

1299  
ht_tbl_poöãr
[2];

1301  
ht_tbl_poöãr
[3];

1302 
	}
}

1304 
	$rs_£t_ex≥˘ed_çt_èbÀ
(
iwl_lq_°a
 *
lq_°a
,

1305 
iwl_sˇÀ_tbl_öfo
 *
tbl
)

1307 
rs_øã
 *
øã
 = &
tbl
->rate;

1308 c⁄° 
rs_tx_cﬁumn
 *
cﬁumn
 = &
rs_tx_cﬁumns
[
tbl
->column];

1310 
tbl
->
ex≥˘ed_çt
 = 
	`rs_gë_ex≥˘ed_çt_èbÀ
(
lq_°a
, 
cﬁumn
, 
øã
->
bw
);

1311 
	}
}

1320 
ölöe
 
u8
 
	$rs_£¨ch_tbl
(
u8
 
a˘ive_tbl
)

1322  (
a˘ive_tbl
 ^ 1) & 1;

1323 
	}
}

1325 
s32
 
	$rs_gë_be°_øã
(
iwl_mvm
 *
mvm
,

1326 
iwl_lq_°a
 *
lq_°a
,

1327 
iwl_sˇÀ_tbl_öfo
 *
tbl
,

1328 
øã_mask
, 
s8
 
ödex
)

1330 
iwl_sˇÀ_tbl_öfo
 *
a˘ive_tbl
 =

1331 &(
lq_°a
->
lq_öfo
[lq_°a->
a˘ive_tbl
]);

1332 
s32
 
suc˚ss_øtio
 = 
a˘ive_tbl
->
wö
[
ödex
].success_ratio;

1333 
u16
 
ex≥˘ed_cuºít_çt
 = 
a˘ive_tbl
->
ex≥˘ed_çt
[
ödex
];

1334 c⁄° 
u16
 *
çt_tbl
 = 
tbl
->
ex≥˘ed_çt
;

1335 
u16
 
high_low
;

1336 
u32
 
èrgë_çt
;

1337 
øã_idx
;

1339 i‡(
suc˚ss_øtio
 >
	`RS_PERCENT
(
IWL_MVM_RS_SR_NO_DECREASE
)) {

1340 
èrgë_çt
 = 100 * 
ex≥˘ed_cuºít_çt
;

1341 
	`IWL_DEBUG_RATE
(
mvm
,

1343 
suc˚ss_øtio
, 
èrgë_çt
);

1345 
èrgë_çt
 = 
lq_°a
->
œ°_çt
;

1346 
	`IWL_DEBUG_RATE
(
mvm
,

1348 
suc˚ss_øtio
, 
èrgë_çt
);

1351 
øã_idx
 = 
	`föd_fú°_bô
(&
øã_mask
, 
BITS_PER_LONG
);

1353 
øã_idx
 !
IWL_RATE_INVALID
) {

1354 i‡(
èrgë_çt
 < (100 * 
çt_tbl
[
øã_idx
]))

1357 
high_low
 = 
	`rs_gë_adja˚¡_øã
(
mvm
, 
øã_idx
, 
øã_mask
,

1358 
tbl
->
øã
.
ty≥
);

1360 
øã_idx
 = (
high_low
 >> 8) & 0xff;

1363 
	`IWL_DEBUG_RATE
(
mvm
, "BestÑate found %dÅarget_tp %dÉxpected_new %d\n",

1364 
øã_idx
, 
èrgë_çt
,

1365 
øã_idx
 !
IWL_RATE_INVALID
 ?

1366 100 * 
çt_tbl
[
øã_idx
] : 
IWL_INVALID_VALUE
);

1368  
øã_idx
;

1369 
	}
}

1371 
u32
 
	$rs_bw_‰om_°a_bw
(
õì80211_°a
 *
°a
)

1373 
õì80211_°a_vht_ˇp
 *
°a_vht_ˇp
 = &
°a
->
deÊök
.
vht_ˇp
;

1374 
õì80211_vht_ˇp
 
vht_ˇp
 = {

1375 .
vht_ˇp_öfo
 = 
	`˝u_to_À32
(
°a_vht_ˇp
->
ˇp
),

1376 .
suµ_mcs
 = 
°a_vht_ˇp
->
vht_mcs
,

1379 
°a
->
deÊök
.
b™dwidth
) {

1380 
IEEE80211_STA_RX_BW_160
:

1389 i‡(
	`õì80211_gë_vht_max_nss
(&
vht_ˇp
,

1390 
IEEE80211_VHT_CHANWIDTH_160MHZ
,

1391 0, 
åue
,

1392 
°a
->
deÊök
.
rx_nss
) < sta->deflink.rx_nss)

1393  
RATE_MCS_CHAN_WIDTH_80
;

1394  
RATE_MCS_CHAN_WIDTH_160
;

1395 
IEEE80211_STA_RX_BW_80
:

1396  
RATE_MCS_CHAN_WIDTH_80
;

1397 
IEEE80211_STA_RX_BW_40
:

1398  
RATE_MCS_CHAN_WIDTH_40
;

1399 
IEEE80211_STA_RX_BW_20
:

1401  
RATE_MCS_CHAN_WIDTH_20
;

1403 
	}
}

1412 
	$rs_°ay_ö_èbÀ
(
iwl_lq_°a
 *
lq_°a
, 
boﬁ
 
f‹˚_£¨ch
)

1414 
iwl_sˇÀ_tbl_öfo
 *
tbl
;

1415 
a˘ive_tbl
;

1416 
Êush_öãrvÆ_∑s£d
 = 0;

1417 
iwl_mvm
 *
mvm
;

1419 
mvm
 = 
lq_°a
->
≥rs
.
drv
;

1420 
a˘ive_tbl
 = 
lq_°a
->active_tbl;

1422 
tbl
 = &(
lq_°a
->
lq_öfo
[
a˘ive_tbl
]);

1425 i‡(
lq_°a
->
rs_°©e
 =
RS_STATE_STAY_IN_COLUMN
) {

1427 i‡(
lq_°a
->
Êush_timî
)

1428 
Êush_öãrvÆ_∑s£d
 =

1429 
	`time_a·î
(
jiffõs
,

1430 ()(
lq_°a
->
Êush_timî
 +

1431 (
IWL_MVM_RS_STAY_IN_COLUMN_TIMEOUT
 * 
HZ
)));

1441 i‡(
f‹˚_£¨ch
 ||

1442 (
lq_°a
->
tŸÆ_Áûed
 >Üq_°a->
max_Áûuª_limô
) ||

1443 (
lq_°a
->
tŸÆ_suc˚ss
 >Üq_°a->
max_suc˚ss_limô
) ||

1444 ((!
lq_°a
->
£¨ch_bëãr_tbl
) &&

1445 (
lq_°a
->
Êush_timî
Ë&& (
Êush_öãrvÆ_∑s£d
))) {

1446 
	`IWL_DEBUG_RATE
(
mvm
,

1448 
lq_°a
->
tŸÆ_Áûed
,

1449 
lq_°a
->
tŸÆ_suc˚ss
,

1450 
Êush_öãrvÆ_∑s£d
);

1453 
lq_°a
->
rs_°©e
 = 
RS_STATE_SEARCH_CYCLE_STARTED
;

1454 
	`IWL_DEBUG_RATE
(
mvm
,

1456 
lq_°a
->
tŸÆ_Áûed
 = 0;

1457 
lq_°a
->
tŸÆ_suc˚ss
 = 0;

1458 
lq_°a
->
Êush_timî
 = 0;

1460 
lq_°a
->
visôed_cﬁumns
 = 
	`BIT
(
tbl
->
cﬁumn
);

1468 
lq_°a
->
èbÀ_cou¡
++;

1469 i‡(
lq_°a
->
èbÀ_cou¡
 >=

1470 
lq_°a
->
èbÀ_cou¡_limô
) {

1471 
lq_°a
->
èbÀ_cou¡
 = 0;

1473 
	`IWL_DEBUG_RATE
(
mvm
,

1475 
	`rs_øã_sˇÀ_˛ór_tbl_wödows
(
mvm
, 
tbl
);

1482 i‡(
lq_°a
->
rs_°©e
 =
RS_STATE_SEARCH_CYCLE_STARTED
) {

1483 
	`rs_øã_sˇÀ_˛ór_tbl_wödows
(
mvm
, 
tbl
);

1486 
	}
}

1488 
	$rs_£t_amsdu_Àn
(
iwl_mvm
 *
mvm
, 
õì80211_°a
 *
°a
,

1489 
iwl_sˇÀ_tbl_öfo
 *
tbl
,

1490 
rs_a˘i⁄
 
sˇÀ_a˘i⁄
)

1492 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

1493 
õì80211_bss_c⁄f
 *
bss_c⁄f
 = &
mvm°a
->
vif
->bss_conf;

1494 
i
;

1496 
°a
->
deÊök
.
agg
.
max_amsdu_Àn
 =

1497 
	`rs_fw_gë_max_amsdu_Àn
(
°a
, 
bss_c⁄f
, &°a->
deÊök
);

1503 i‡((!
	`is_vht
(&
tbl
->
øã
Ë&& !
	`is_ht
(&tbl->rate)) ||

1504 
tbl
->
øã
.
ödex
 < 
IWL_RATE_MCS_5_INDEX
 ||

1505 
sˇÀ_a˘i⁄
 =
RS_ACTION_DOWNSCALE
)

1506 
mvm°a
->
amsdu_íabÀd
 = 0;

1508 
mvm°a
->
amsdu_íabÀd
 = 0xFFFF;

1510 i‡(
bss_c⁄f
->
he_suµ‹t
 &&

1511 !
iwlwifi_mod_∑øms
.
dißbÀ_11ax
)

1512 
mvm°a
->
max_amsdu_Àn
 = 
°a
->
deÊök
.
agg
.max_amsdu_len;

1514 
mvm°a
->
max_amsdu_Àn
 =

1515 
	`mö_t
(, 
°a
->
deÊök
.
agg
.
max_amsdu_Àn
, 8500);

1517 
°a
->
deÊök
.
agg
.
max_rc_amsdu_Àn
 = 
mvm°a
->
max_amsdu_Àn
;

1519 
i
 = 0; i < 
IWL_MAX_TID_COUNT
; i++) {

1520 i‡(
mvm°a
->
amsdu_íabÀd
)

1521 
°a
->
deÊök
.
agg
.
max_tid_amsdu_Àn
[
i
] =

1522 
	`iwl_mvm_max_amsdu_size
(
mvm
, 
°a
, 
i
);

1528 
°a
->
deÊök
.
agg
.
max_tid_amsdu_Àn
[
i
] = 1;

1530 
	}
}

1535 
	$rs_upd©e_øã_tbl
(
iwl_mvm
 *
mvm
,

1536 
õì80211_°a
 *
°a
,

1537 
iwl_lq_°a
 *
lq_°a
,

1538 
iwl_sˇÀ_tbl_öfo
 *
tbl
)

1540 
	`rs_fûl_lq_cmd
(
mvm
, 
°a
, 
lq_°a
, &
tbl
->
øã
);

1541 
	`iwl_mvm_£nd_lq_cmd
(
mvm
, &
lq_°a
->
lq
);

1542 
	}
}

1544 
boﬁ
 
	$rs_twók_øã_tbl
(
iwl_mvm
 *
mvm
,

1545 
õì80211_°a
 *
°a
,

1546 
iwl_lq_°a
 *
lq_°a
,

1547 
iwl_sˇÀ_tbl_öfo
 *
tbl
,

1548 
rs_a˘i⁄
 
sˇÀ_a˘i⁄
)

1550 i‡(
	`rs_bw_‰om_°a_bw
(
°a
Ë!
RATE_MCS_CHAN_WIDTH_80
)

1551  
Ál£
;

1553 i‡(!
	`is_vht_siso
(&
tbl
->
øã
))

1554  
Ál£
;

1556 i‡((
tbl
->
øã
.
bw
 =
RATE_MCS_CHAN_WIDTH_80
) &&

1557 (
tbl
->
øã
.
ödex
 =
IWL_RATE_MCS_0_INDEX
) &&

1558 (
sˇÀ_a˘i⁄
 =
RS_ACTION_DOWNSCALE
)) {

1559 
tbl
->
øã
.
bw
 = 
RATE_MCS_CHAN_WIDTH_20
;

1560 
tbl
->
øã
.
ödex
 = 
IWL_RATE_MCS_4_INDEX
;

1561 
	`IWL_DEBUG_RATE
(
mvm
, "Switch 80Mhz SISO MCS0 -> 20Mhz MCS4\n");

1562 
twóked
;

1570 i‡((
tbl
->
øã
.
bw
 =
RATE_MCS_CHAN_WIDTH_20
) &&

1571 (((
tbl
->
øã
.
ödex
 =
IWL_RATE_MCS_5_INDEX
) &&

1572 (
sˇÀ_a˘i⁄
 =
RS_ACTION_STAY
)) ||

1573 ((
tbl
->
øã
.
ödex
 > 
IWL_RATE_MCS_5_INDEX
) &&

1574 (
sˇÀ_a˘i⁄
 =
RS_ACTION_UPSCALE
)))) {

1575 
tbl
->
øã
.
bw
 = 
RATE_MCS_CHAN_WIDTH_80
;

1576 
tbl
->
øã
.
ödex
 = 
IWL_RATE_MCS_1_INDEX
;

1577 
	`IWL_DEBUG_RATE
(
mvm
, "Switch 20Mhz SISO MCS5 -> 80Mhz MCS1\n");

1578 
twóked
;

1581  
Ál£
;

1583 
twóked
:

1584 
	`rs_£t_ex≥˘ed_çt_èbÀ
(
lq_°a
, 
tbl
);

1585 
	`rs_øã_sˇÀ_˛ór_tbl_wödows
(
mvm
, 
tbl
);

1586  
åue
;

1587 
	}
}

1589 
rs_cﬁumn
 
	$rs_gë_√xt_cﬁumn
(
iwl_mvm
 *
mvm
,

1590 
iwl_lq_°a
 *
lq_°a
,

1591 
õì80211_°a
 *
°a
,

1592 
iwl_sˇÀ_tbl_öfo
 *
tbl
)

1594 
i
, 
j
, 
max_øã
;

1595 
rs_cﬁumn
 
√xt_cﬁ_id
;

1596 c⁄° 
rs_tx_cﬁumn
 *
cuº_cﬁ
 = &
rs_tx_cﬁumns
[
tbl
->
cﬁumn
];

1597 c⁄° 
rs_tx_cﬁumn
 *
√xt_cﬁ
;

1598 
Ælow_cﬁumn_func_t
 
Ælow_func
;

1599 
u8
 
vÆid_™ts
 = 
	`iwl_mvm_gë_vÆid_tx_™t
(
mvm
);

1600 c⁄° 
u16
 *
ex≥˘ed_çt_tbl
;

1601 
u16
 
çt
, 
max_ex≥˘ed_çt
;

1603 
i
 = 0; i < 
MAX_NEXT_COLUMNS
; i++) {

1604 
√xt_cﬁ_id
 = 
cuº_cﬁ
->
√xt_cﬁumns
[
i
];

1606 i‡(
√xt_cﬁ_id
 =
RS_COLUMN_INVALID
)

1609 i‡(
lq_°a
->
visôed_cﬁumns
 & 
	`BIT
(
√xt_cﬁ_id
)) {

1610 
	`IWL_DEBUG_RATE
(
mvm
, "Skipálready visited column %d\n",

1611 
√xt_cﬁ_id
);

1615 
√xt_cﬁ
 = &
rs_tx_cﬁumns
[
√xt_cﬁ_id
];

1617 i‡(!
	`rs_is_vÆid_™t
(
vÆid_™ts
, 
√xt_cﬁ
->
™t
)) {

1618 
	`IWL_DEBUG_RATE
(
mvm
,

1620 
√xt_cﬁ_id
, 
vÆid_™ts
, 
√xt_cﬁ
->
™t
);

1624 
j
 = 0; j < 
MAX_COLUMN_CHECKS
; j++) {

1625 
Ælow_func
 = 
√xt_cﬁ
->
checks
[
j
];

1626 i‡(
Ælow_func
 && !
	`Ælow_func
(
mvm
, 
°a
, &
tbl
->
øã
,

1627 
√xt_cﬁ
))

1631 i‡(
j
 !
MAX_COLUMN_CHECKS
) {

1632 
	`IWL_DEBUG_RATE
(
mvm
,

1634 
√xt_cﬁ_id
, 
j
);

1639 
çt
 = 
lq_°a
->
œ°_çt
 / 100;

1640 
ex≥˘ed_çt_tbl
 = 
	`rs_gë_ex≥˘ed_çt_èbÀ
(
lq_°a
, 
√xt_cﬁ
,

1641 
	`rs_bw_‰om_°a_bw
(
°a
));

1642 i‡(
	`WARN_ON_ONCE
(!
ex≥˘ed_çt_tbl
))

1645 
max_øã
 = 
	`rs_gë_max_Ælowed_øã
(
lq_°a
, 
√xt_cﬁ
);

1646 i‡(
max_øã
 =
IWL_RATE_INVALID
) {

1647 
	`IWL_DEBUG_RATE
(
mvm
,

1649 
√xt_cﬁ_id
);

1653 
max_ex≥˘ed_çt
 = 
ex≥˘ed_çt_tbl
[
max_øã
];

1654 i‡(
çt
 >
max_ex≥˘ed_çt
) {

1655 
	`IWL_DEBUG_RATE
(
mvm
,

1657 
√xt_cﬁ_id
, 
max_ex≥˘ed_çt
, 
çt
);

1661 
	`IWL_DEBUG_RATE
(
mvm
,

1663 
√xt_cﬁ_id
, 
max_ex≥˘ed_çt
, 
çt
);

1667 i‡(
i
 =
MAX_NEXT_COLUMNS
)

1668  
RS_COLUMN_INVALID
;

1670  
√xt_cﬁ_id
;

1671 
	}
}

1673 
	$rs_swôch_to_cﬁumn
(
iwl_mvm
 *
mvm
,

1674 
iwl_lq_°a
 *
lq_°a
,

1675 
õì80211_°a
 *
°a
,

1676 
rs_cﬁumn
 
cﬁ_id
)

1678 
iwl_sˇÀ_tbl_öfo
 *
tbl
 = &
lq_°a
->
lq_öfo
[lq_°a->
a˘ive_tbl
];

1679 
iwl_sˇÀ_tbl_öfo
 *
£¨ch_tbl
 =

1680 &
lq_°a
->
lq_öfo
[
	`rs_£¨ch_tbl
÷q_°a->
a˘ive_tbl
)];

1681 
rs_øã
 *
øã
 = &
£¨ch_tbl
->rate;

1682 c⁄° 
rs_tx_cﬁumn
 *
cﬁumn
 = &
rs_tx_cﬁumns
[
cﬁ_id
];

1683 c⁄° 
rs_tx_cﬁumn
 *
cuº_cﬁumn
 = &
rs_tx_cﬁumns
[
tbl
->
cﬁumn
];

1684 
øã_mask
 = 0;

1685 
u32
 
øã_idx
 = 0;

1687 
	`mem˝y
(
£¨ch_tbl
, 
tbl
, 
	`off£tof
(
iwl_sˇÀ_tbl_öfo
, 
wö
));

1689 
øã
->
sgi
 = 
cﬁumn
->sgi;

1690 
øã
->
™t
 = 
cﬁumn
->ant;

1692 i‡(
cﬁumn
->
mode
 =
RS_LEGACY
) {

1693 i‡(
lq_°a
->
b™d
 =
NL80211_BAND_5GHZ
)

1694 
øã
->
ty≥
 = 
LQ_LEGACY_A
;

1696 
øã
->
ty≥
 = 
LQ_LEGACY_G
;

1698 
øã
->
bw
 = 
RATE_MCS_CHAN_WIDTH_20
;

1699 
øã
->
ldpc
 = 
Ál£
;

1700 
øã_mask
 = 
lq_°a
->
a˘ive_Àgacy_øã
;

1701 } i‡(
cﬁumn
->
mode
 =
RS_SISO
) {

1702 
øã
->
ty≥
 = 
lq_°a
->
is_vht
 ? 
LQ_VHT_SISO
 : 
LQ_HT_SISO
;

1703 
øã_mask
 = 
lq_°a
->
a˘ive_siso_øã
;

1704 } i‡(
cﬁumn
->
mode
 =
RS_MIMO2
) {

1705 
øã
->
ty≥
 = 
lq_°a
->
is_vht
 ? 
LQ_VHT_MIMO2
 : 
LQ_HT_MIMO2
;

1706 
øã_mask
 = 
lq_°a
->
a˘ive_mimo2_øã
;

1708 
	`WARN_ONCE
(1, "Bad column mode");

1711 i‡(
cﬁumn
->
mode
 !
RS_LEGACY
) {

1712 
øã
->
bw
 = 
	`rs_bw_‰om_°a_bw
(
°a
);

1713 
øã
->
ldpc
 = 
lq_°a
->ldpc;

1716 
£¨ch_tbl
->
cﬁumn
 = 
cﬁ_id
;

1717 
	`rs_£t_ex≥˘ed_çt_èbÀ
(
lq_°a
, 
£¨ch_tbl
);

1719 
lq_°a
->
visôed_cﬁumns
 |
	`BIT
(
cﬁ_id
);

1724 i‡(
cuº_cﬁumn
->
mode
 !
cﬁumn
->mode) {

1725 
øã_idx
 = 
	`rs_gë_be°_øã
(
mvm
, 
lq_°a
, 
£¨ch_tbl
,

1726 
øã_mask
, 
øã
->
ödex
);

1728 i‡((
øã_idx
 =
IWL_RATE_INVALID
) ||

1729 !(
	`BIT
(
øã_idx
Ë& 
øã_mask
)) {

1730 
	`IWL_DEBUG_RATE
(
mvm
,

1733 
øã_idx
, 
øã_mask
);

1735 
îr
;

1738 
øã
->
ödex
 = 
øã_idx
;

1741 
	`IWL_DEBUG_RATE
(
mvm
, "SwitchedÅo column %d: Index %d\n",

1742 
cﬁ_id
, 
øã
->
ödex
);

1746 
îr
:

1747 
øã
->
ty≥
 = 
LQ_NONE
;

1749 
	}
}

1751 
rs_a˘i⁄
 
	$rs_gë_øã_a˘i⁄
(
iwl_mvm
 *
mvm
,

1752 
iwl_sˇÀ_tbl_öfo
 *
tbl
,

1753 
s32
 
§
, 
low
, 
high
,

1754 
cuºít_çt
,

1755 
low_çt
, 
high_çt
)

1757 
rs_a˘i⁄
 
a˘i⁄
 = 
RS_ACTION_STAY
;

1759 i‡((
§
 <
	`RS_PERCENT
(
IWL_MVM_RS_SR_FORCE_DECREASE
)) ||

1760 (
cuºít_çt
 == 0)) {

1761 
	`IWL_DEBUG_RATE
(
mvm
,

1763  
RS_ACTION_DOWNSCALE
;

1766 i‡((
low_çt
 =
IWL_INVALID_VALUE
) &&

1767 (
high_çt
 =
IWL_INVALID_VALUE
) &&

1768 (
high
 !
IWL_RATE_INVALID
)) {

1769 
	`IWL_DEBUG_RATE
(
mvm
,

1771  
RS_ACTION_UPSCALE
;

1774 i‡((
high_çt
 =
IWL_INVALID_VALUE
) &&

1775 (
high
 !
IWL_RATE_INVALID
) &&

1776 (
low_çt
 !
IWL_INVALID_VALUE
) &&

1777 (
low_çt
 < 
cuºít_çt
)) {

1778 
	`IWL_DEBUG_RATE
(
mvm
,

1780  
RS_ACTION_UPSCALE
;

1783 i‡((
high_çt
 !
IWL_INVALID_VALUE
) &&

1784 (
high_çt
 > 
cuºít_çt
)) {

1785 
	`IWL_DEBUG_RATE
(
mvm
,

1787  
RS_ACTION_UPSCALE
;

1790 i‡((
low_çt
 !
IWL_INVALID_VALUE
) &&

1791 (
high_çt
 !
IWL_INVALID_VALUE
) &&

1792 (
low_çt
 < 
cuºít_çt
) &&

1793 (
high_çt
 < 
cuºít_çt
)) {

1794 
	`IWL_DEBUG_RATE
(
mvm
,

1796  
RS_ACTION_STAY
;

1799 i‡((
low_çt
 !
IWL_INVALID_VALUE
) &&

1800 (
low_çt
 > 
cuºít_çt
)) {

1801 
	`IWL_DEBUG_RATE
(
mvm
,

1803 
a˘i⁄
 = 
RS_ACTION_DOWNSCALE
;

1804 
out
;

1807 i‡((
low_çt
 =
IWL_INVALID_VALUE
) &&

1808 (
low
 !
IWL_RATE_INVALID
)) {

1809 
	`IWL_DEBUG_RATE
(
mvm
,

1811 
a˘i⁄
 = 
RS_ACTION_DOWNSCALE
;

1812 
out
;

1815 
	`IWL_DEBUG_RATE
(
mvm
, "MaintainÑate\n");

1817 
out
:

1818 i‡((
a˘i⁄
 =
RS_ACTION_DOWNSCALE
Ë&& (
low
 !
IWL_RATE_INVALID
)) {

1819 i‡(
§
 >
	`RS_PERCENT
(
IWL_MVM_RS_SR_NO_DECREASE
)) {

1820 
	`IWL_DEBUG_RATE
(
mvm
,

1822 
a˘i⁄
 = 
RS_ACTION_STAY
;

1823 } i‡(
cuºít_çt
 > (100 * 
tbl
->
ex≥˘ed_çt
[
low
])) {

1824 
	`IWL_DEBUG_RATE
(
mvm
,

1826 
a˘i⁄
 = 
RS_ACTION_STAY
;

1828 
	`IWL_DEBUG_RATE
(
mvm
, "DecreaseÑate\n");

1832  
a˘i⁄
;

1833 
	}
}

1835 
boﬁ
 
	$rs_°bc_Ælow
(
iwl_mvm
 *
mvm
, 
õì80211_°a
 *
°a
,

1836 
iwl_lq_°a
 *
lq_°a
)

1841 i‡(!
lq_°a
->
°bc_ˇ∑bÀ
)

1842  
Ál£
;

1844 i‡(!
	`iwl_mvm_bt_c€x_is_mimo_Ælowed
(
mvm
, 
°a
))

1845  
Ál£
;

1847  
åue
;

1848 
	}
}

1850 
	$rs_gë_adja˚¡_txp
(
iwl_mvm
 *
mvm
, 
ödex
,

1851 *
wókî
, *
°r⁄gî
)

1853 *
wókî
 = 
ödex
 + 
IWL_MVM_RS_TPC_TX_POWER_STEP
;

1854 i‡(*
wókî
 > 
TPC_MAX_REDUCTION
)

1855 *
wókî
 = 
TPC_INVALID
;

1857 *
°r⁄gî
 = 
ödex
 - 
IWL_MVM_RS_TPC_TX_POWER_STEP
;

1858 i‡(*
°r⁄gî
 < 0)

1859 *
°r⁄gî
 = 
TPC_INVALID
;

1860 
	}
}

1862 
boﬁ
 
	$rs_çc_Ælowed
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

1863 
rs_øã
 *
øã
, 
∆80211_b™d
 
b™d
)

1865 
ödex
 = 
øã
->index;

1866 
boﬁ
 
ˇm
 = (
iwlmvm_mod_∑øms
.
powî_scheme
 =
IWL_POWER_SCHEME_CAM
);

1867 
boﬁ
 
°a_ps_dißbÀd
 = (
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
 &&

1868 !
vif
->
cfg
.
ps
);

1870 
	`IWL_DEBUG_RATE
(
mvm
, "cam: %d sta_ps_disabled %d\n",

1871 
ˇm
, 
°a_ps_dißbÀd
);

1876 i‡((
ˇm
 || 
°a_ps_dißbÀd
) &&

1877 !
	`iwl_mvm_bt_c€x_is_çc_Ælowed
(
mvm
, 
b™d
))

1878  
Ál£
;

1880 
	`IWL_DEBUG_RATE
(
mvm
, "checkÑ©e,ÅabÀÅy≥: %d\n", 
øã
->
ty≥
);

1881 i‡(
	`is_Àgacy
(
øã
))

1882  
ödex
 =
IWL_RATE_54M_INDEX
;

1883 i‡(
	`is_ht
(
øã
))

1884  
ödex
 =
IWL_RATE_MCS_7_INDEX
;

1885 i‡(
	`is_vht
(
øã
))

1886  
ödex
 =
IWL_RATE_MCS_9_INDEX
;

1888 
	`WARN_ON_ONCE
(1);

1889  
Ál£
;

1890 
	}
}

1892 
	eçc_a˘i⁄
 {

1893 
	mTPC_ACTION_STAY
,

1894 
	mTPC_ACTION_DECREASE
,

1895 
	mTPC_ACTION_INCREASE
,

1896 
	mTPC_ACTION_NO_RESTIRCTION
,

1899 
çc_a˘i⁄
 
	$rs_gë_çc_a˘i⁄
(
iwl_mvm
 *
mvm
,

1900 
s32
 
§
, 
wók
, 
°r⁄g
,

1901 
cuºít_çt
,

1902 
wók_çt
, 
°r⁄g_çt
)

1905 i‡(
cuºít_çt
 =
IWL_INVALID_VALUE
) {

1906 
	`IWL_DEBUG_RATE
(
mvm
, "no currentÅpt. stay.\n");

1907  
TPC_ACTION_STAY
;

1911 i‡(
§
 <
	`RS_PERCENT
(
IWL_MVM_RS_TPC_SR_FORCE_INCREASE
) ||

1912 
cuºít_çt
 == 0) {

1913 
	`IWL_DEBUG_RATE
(
mvm
, "increaseÅxp because of weak SR\n");

1914  
TPC_ACTION_NO_RESTIRCTION
;

1918 i‡(
§
 >
	`RS_PERCENT
(
IWL_MVM_RS_TPC_SR_NO_INCREASE
) &&

1919 
wók
 !
TPC_INVALID
) {

1920 i‡(
wók_çt
 =
IWL_INVALID_VALUE
 &&

1921 (
°r⁄g_çt
 =
IWL_INVALID_VALUE
 ||

1922 
cuºít_çt
 >
°r⁄g_çt
)) {

1923 
	`IWL_DEBUG_RATE
(
mvm
,

1925  
TPC_ACTION_DECREASE
;

1928 i‡(
wók_çt
 > 
cuºít_çt
) {

1929 
	`IWL_DEBUG_RATE
(
mvm
,

1931  
TPC_ACTION_DECREASE
;

1936 i‡(
§
 < 
	`RS_PERCENT
(
IWL_MVM_RS_TPC_SR_NO_INCREASE
) &&

1937 
°r⁄g
 !
TPC_INVALID
) {

1938 i‡(
wók_çt
 =
IWL_INVALID_VALUE
 &&

1939 
°r⁄g_çt
 !
IWL_INVALID_VALUE
 &&

1940 
cuºít_çt
 < 
°r⁄g_çt
) {

1941 
	`IWL_DEBUG_RATE
(
mvm
,

1943  
TPC_ACTION_INCREASE
;

1946 i‡(
wók_çt
 < 
cuºít_çt
 &&

1947 (
°r⁄g_çt
 =
IWL_INVALID_VALUE
 ||

1948 
°r⁄g_çt
 > 
cuºít_çt
)) {

1949 
	`IWL_DEBUG_RATE
(
mvm
,

1951  
TPC_ACTION_INCREASE
;

1955 
	`IWL_DEBUG_RATE
(
mvm
, "noÇeedÅo increase or decreaseÅxp - stay\n");

1956  
TPC_ACTION_STAY
;

1957 
	}
}

1959 
boﬁ
 
	$rs_çc_≥rf‹m
(
iwl_mvm
 *
mvm
,

1960 
õì80211_°a
 *
°a
,

1961 
iwl_lq_°a
 *
lq_°a
,

1962 
iwl_sˇÀ_tbl_öfo
 *
tbl
)

1964 
iwl_mvm_°a
 *
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

1965 
õì80211_vif
 *
vif
 = 
mvm_°a
->vif;

1966 
õì80211_ch™˘x_c⁄f
 *
ch™˘x_c⁄f
;

1967 
∆80211_b™d
 
b™d
;

1968 
iwl_øã_sˇÀ_d©a
 *
wödow
;

1969 
rs_øã
 *
øã
 = &
tbl
->rate;

1970 
çc_a˘i⁄
 
a˘i⁄
;

1971 
s32
 
§
;

1972 
u8
 
cur
 = 
lq_°a
->
lq
.
ªdu˚d_çc
;

1973 
cuºít_çt
;

1974 
wók
, 
°r⁄g
;

1975 
wók_çt
 = 
IWL_INVALID_VALUE
, 
°r⁄g_çt
 = IWL_INVALID_VALUE;

1977 #ifde‡
CONFIG_MAC80211_DEBUGFS


1978 i‡(
lq_°a
->
≥rs
.
dbg_fixed_txp_ªdu˘i⁄
 <
TPC_MAX_REDUCTION
) {

1979 
	`IWL_DEBUG_RATE
(
mvm
, "fixedÅpc: %d\n",

1980 
lq_°a
->
≥rs
.
dbg_fixed_txp_ªdu˘i⁄
);

1981 
lq_°a
->
lq
.
ªdu˚d_çc
 =Üq_°a->
≥rs
.
dbg_fixed_txp_ªdu˘i⁄
;

1982  
cur
 !
lq_°a
->
≥rs
.
dbg_fixed_txp_ªdu˘i⁄
;

1986 
	`rcu_ªad_lock
();

1987 
ch™˘x_c⁄f
 = 
	`rcu_dîe„ªn˚
(
vif
->
bss_c⁄f
.chanctx_conf);

1988 i‡(
	`WARN_ON
(!
ch™˘x_c⁄f
))

1989 
b™d
 = 
NUM_NL80211_BANDS
;

1991 
b™d
 = 
ch™˘x_c⁄f
->
def
.
ch™
->band;

1992 
	`rcu_ªad_u∆ock
();

1994 i‡(!
	`rs_çc_Ælowed
(
mvm
, 
vif
, 
øã
, 
b™d
)) {

1995 
	`IWL_DEBUG_RATE
(
mvm
,

1997 
lq_°a
->
lq
.
ªdu˚d_çc
 = 
TPC_NO_REDUCTION
;

1998  
cur
 !
TPC_NO_REDUCTION
;

2001 
	`rs_gë_adja˚¡_txp
(
mvm
, 
cur
, &
wók
, &
°r⁄g
);

2004 
wödow
 = 
tbl
->
çc_wö
;

2005 
§
 = 
wödow
[
cur
].
suc˚ss_øtio
;

2006 
cuºít_çt
 = 
wödow
[
cur
].
avîage_çt
;

2007 i‡(
wók
 !
TPC_INVALID
)

2008 
wók_çt
 = 
wödow
[
wók
].
avîage_çt
;

2009 i‡(
°r⁄g
 !
TPC_INVALID
)

2010 
°r⁄g_çt
 = 
wödow
[
°r⁄g
].
avîage_çt
;

2012 
	`IWL_DEBUG_RATE
(
mvm
,

2014 
cur
, 
cuºít_çt
, 
§
, 
wók
, 
°r⁄g
,

2015 
wók_çt
, 
°r⁄g_çt
);

2017 
a˘i⁄
 = 
	`rs_gë_çc_a˘i⁄
(
mvm
, 
§
, 
wók
, 
°r⁄g
,

2018 
cuºít_çt
, 
wók_çt
, 
°r⁄g_çt
);

2021 i‡(
wók
 =
TPC_INVALID
 && 
a˘i⁄
 =
TPC_ACTION_DECREASE
) {

2022 
	`IWL_DEBUG_RATE
(
mvm
, "already inÜowestÅxp, stay\n");

2023 
a˘i⁄
 = 
TPC_ACTION_STAY
;

2024 } i‡(
°r⁄g
 =
TPC_INVALID
 &&

2025 (
a˘i⁄
 =
TPC_ACTION_INCREASE
 ||

2026 
a˘i⁄
 =
TPC_ACTION_NO_RESTIRCTION
)) {

2027 
	`IWL_DEBUG_RATE
(
mvm
, "already in highestÅxp, stay\n");

2028 
a˘i⁄
 = 
TPC_ACTION_STAY
;

2031 
a˘i⁄
) {

2032 
TPC_ACTION_DECREASE
:

2033 
lq_°a
->
lq
.
ªdu˚d_çc
 = 
wók
;

2034  
åue
;

2035 
TPC_ACTION_INCREASE
:

2036 
lq_°a
->
lq
.
ªdu˚d_çc
 = 
°r⁄g
;

2037  
åue
;

2038 
TPC_ACTION_NO_RESTIRCTION
:

2039 
lq_°a
->
lq
.
ªdu˚d_çc
 = 
TPC_NO_REDUCTION
;

2040  
åue
;

2041 
TPC_ACTION_STAY
:

2045  
Ál£
;

2046 
	}
}

2051 
	$rs_øã_sˇÀ_≥rf‹m
(
iwl_mvm
 *
mvm
,

2052 
õì80211_°a
 *
°a
,

2053 
iwl_lq_°a
 *
lq_°a
,

2054 
tid
, 
boﬁ
 
ndp
)

2056 
low
 = 
IWL_RATE_INVALID
;

2057 
high
 = 
IWL_RATE_INVALID
;

2058 
ödex
;

2059 
iwl_øã_sˇÀ_d©a
 *
wödow
 = 
NULL
;

2060 
cuºít_çt
 = 
IWL_INVALID_VALUE
;

2061 
low_çt
 = 
IWL_INVALID_VALUE
;

2062 
high_çt
 = 
IWL_INVALID_VALUE
;

2063 
u32
 
Áû_cou¡
;

2064 
rs_a˘i⁄
 
sˇÀ_a˘i⁄
 = 
RS_ACTION_STAY
;

2065 
u16
 
øã_mask
;

2066 
u8
 
upd©e_lq
 = 0;

2067 
iwl_sˇÀ_tbl_öfo
 *
tbl
, *
tbl1
;

2068 
u8
 
a˘ive_tbl
 = 0;

2069 
u8
 
d⁄e_£¨ch
 = 0;

2070 
u16
 
high_low
;

2071 
s32
 
§
;

2072 
u8
 
¥ev_agg
 = 
lq_°a
->
is_agg
;

2073 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

2074 
rs_øã
 *
øã
;

2076 
lq_°a
->
is_agg
 = !!
mvm°a
->
agg_tids
;

2083 i‡(!
lq_°a
->
£¨ch_bëãr_tbl
)

2084 
a˘ive_tbl
 = 
lq_°a
->active_tbl;

2086 
a˘ive_tbl
 = 
	`rs_£¨ch_tbl
(
lq_°a
->active_tbl);

2088 
tbl
 = &(
lq_°a
->
lq_öfo
[
a˘ive_tbl
]);

2089 
øã
 = &
tbl
->rate;

2091 i‡(
¥ev_agg
 !
lq_°a
->
is_agg
) {

2092 
	`IWL_DEBUG_RATE
(
mvm
,

2094 
¥ev_agg
, 
lq_°a
->
is_agg
);

2095 
	`rs_£t_ex≥˘ed_çt_èbÀ
(
lq_°a
, 
tbl
);

2096 
	`rs_øã_sˇÀ_˛ór_tbl_wödows
(
mvm
, 
tbl
);

2100 
ödex
 = 
øã
->index;

2103 
øã_mask
 = 
	`rs_gë_suµ‹ãd_øãs
(
lq_°a
, 
øã
);

2105 i‡(!(
	`BIT
(
ödex
Ë& 
øã_mask
)) {

2106 
	`IWL_ERR
(
mvm
, "Current Rate isÇot valid\n");

2107 i‡(
lq_°a
->
£¨ch_bëãr_tbl
) {

2109 
øã
->
ty≥
 = 
LQ_NONE
;

2110 
lq_°a
->
£¨ch_bëãr_tbl
 = 0;

2111 
tbl
 = &(
lq_°a
->
lq_öfo
[lq_°a->
a˘ive_tbl
]);

2112 
	`rs_upd©e_øã_tbl
(
mvm
, 
°a
, 
lq_°a
, 
tbl
);

2118 i‡(!
tbl
->
ex≥˘ed_çt
) {

2119 
	`IWL_ERR
(
mvm
, "tbl->expected_tpt is NULL\n");

2124 
wödow
 = &(
tbl
->
wö
[
ödex
]);

2133 
Áû_cou¡
 = 
wödow
->
cou¡î
 - wödow->
suc˚ss_cou¡î
;

2134 i‡((
Áû_cou¡
 < 
IWL_MVM_RS_RATE_MIN_FAILURE_TH
) &&

2135 (
wödow
->
suc˚ss_cou¡î
 < 
IWL_MVM_RS_RATE_MIN_SUCCESS_TH
)) {

2136 
	`IWL_DEBUG_RATE
(
mvm
,

2138 
	`rs_¥ëty_øã
(
øã
),

2139 
wödow
->
suc˚ss_cou¡î
, wödow->
cou¡î
);

2142 
wödow
->
avîage_çt
 = 
IWL_INVALID_VALUE
;

2146 
	`rs_°ay_ö_èbÀ
(
lq_°a
, 
Ál£
);

2152 i‡(
lq_°a
->
£¨ch_bëãr_tbl
) {

2156 i‡(
wödow
->
avîage_çt
 > 
lq_°a
->
œ°_çt
) {

2157 
	`IWL_DEBUG_RATE
(
mvm
,

2160 
wödow
->
suc˚ss_øtio
,

2161 
wödow
->
avîage_çt
,

2162 
lq_°a
->
œ°_çt
);

2165 
lq_°a
->
a˘ive_tbl
 =áctive_tbl;

2166 
cuºít_çt
 = 
wödow
->
avîage_çt
;

2169 
	`IWL_DEBUG_RATE
(
mvm
,

2172 
wödow
->
suc˚ss_øtio
,

2173 
wödow
->
avîage_çt
,

2174 
lq_°a
->
œ°_çt
);

2177 
øã
->
ty≥
 = 
LQ_NONE
;

2180 
a˘ive_tbl
 = 
lq_°a
->active_tbl;

2181 
tbl
 = &(
lq_°a
->
lq_öfo
[
a˘ive_tbl
]);

2184 
ödex
 = 
tbl
->
øã
.index;

2185 
cuºít_çt
 = 
lq_°a
->
œ°_çt
;

2188 
upd©e_lq
 = 1;

2193 
lq_°a
->
£¨ch_bëãr_tbl
 = 0;

2194 
d⁄e_£¨ch
 = 1;

2195 
lq_upd©e
;

2200 
high_low
 = 
	`rs_gë_adja˚¡_øã
(
mvm
, 
ödex
, 
øã_mask
, 
øã
->
ty≥
);

2201 
low
 = 
high_low
 & 0xff;

2202 
high
 = (
high_low
 >> 8) & 0xff;

2206 
§
 = 
wödow
->
suc˚ss_øtio
;

2209 
cuºít_çt
 = 
wödow
->
avîage_çt
;

2210 i‡(
low
 !
IWL_RATE_INVALID
)

2211 
low_çt
 = 
tbl
->
wö
[
low
].
avîage_çt
;

2212 i‡(
high
 !
IWL_RATE_INVALID
)

2213 
high_çt
 = 
tbl
->
wö
[
high
].
avîage_çt
;

2215 
	`IWL_DEBUG_RATE
(
mvm
,

2217 
	`rs_¥ëty_øã
(
øã
), 
cuºít_çt
, 
§
,

2218 
low
, 
high
, 
low_çt
, 
high_çt
);

2220 
sˇÀ_a˘i⁄
 = 
	`rs_gë_øã_a˘i⁄
(
mvm
, 
tbl
, 
§
, 
low
, 
high
,

2221 
cuºít_çt
, 
low_çt
, 
high_çt
);

2224 i‡(
	`is_mimo
(
øã
) &&

2225 !
	`iwl_mvm_bt_c€x_is_mimo_Ælowed
(
mvm
, 
°a
)) {

2226 
	`IWL_DEBUG_RATE
(
mvm
,

2228 
	`rs_°ay_ö_èbÀ
(
lq_°a
, 
åue
);

2229 
lq_upd©e
;

2232 
sˇÀ_a˘i⁄
) {

2233 
RS_ACTION_DOWNSCALE
:

2235 i‡(
low
 !
IWL_RATE_INVALID
) {

2236 
upd©e_lq
 = 1;

2237 
ödex
 = 
low
;

2239 
	`IWL_DEBUG_RATE
(
mvm
,

2244 
RS_ACTION_UPSCALE
:

2246 i‡(
high
 !
IWL_RATE_INVALID
) {

2247 
upd©e_lq
 = 1;

2248 
ödex
 = 
high
;

2250 
	`IWL_DEBUG_RATE
(
mvm
,

2255 
RS_ACTION_STAY
:

2257 i‡(
lq_°a
->
rs_°©e
 =
RS_STATE_STAY_IN_COLUMN
)

2258 
upd©e_lq
 = 
	`rs_çc_≥rf‹m
(
mvm
, 
°a
, 
lq_°a
, 
tbl
);

2264 
lq_upd©e
:

2266 i‡(
upd©e_lq
) {

2267 
tbl
->
øã
.
ödex
 = index;

2268 i‡(
IWL_MVM_RS_80_20_FAR_RANGE_TWEAK
)

2269 
	`rs_twók_øã_tbl
(
mvm
, 
°a
, 
lq_°a
, 
tbl
, 
sˇÀ_a˘i⁄
);

2270 
	`rs_£t_amsdu_Àn
(
mvm
, 
°a
, 
tbl
, 
sˇÀ_a˘i⁄
);

2271 
	`rs_upd©e_øã_tbl
(
mvm
, 
°a
, 
lq_°a
, 
tbl
);

2274 
	`rs_°ay_ö_èbÀ
(
lq_°a
, 
Ál£
);

2282 i‡(!
upd©e_lq
 && !
d⁄e_£¨ch
 &&

2283 
lq_°a
->
rs_°©e
 =
RS_STATE_SEARCH_CYCLE_STARTED


2284 && 
wödow
->
cou¡î
) {

2285 
rs_cﬁumn
 
√xt_cﬁumn
;

2288 
lq_°a
->
œ°_çt
 = 
cuºít_çt
;

2290 
	`IWL_DEBUG_RATE
(
mvm
,

2292 
upd©e_lq
, 
d⁄e_£¨ch
, 
lq_°a
->
rs_°©e
,

2293 
wödow
->
cou¡î
);

2295 
√xt_cﬁumn
 = 
	`rs_gë_√xt_cﬁumn
(
mvm
, 
lq_°a
, 
°a
, 
tbl
);

2296 i‡(
√xt_cﬁumn
 !
RS_COLUMN_INVALID
) {

2297 
ªt
 = 
	`rs_swôch_to_cﬁumn
(
mvm
, 
lq_°a
, 
°a
,

2298 
√xt_cﬁumn
);

2299 i‡(!
ªt
)

2300 
lq_°a
->
£¨ch_bëãr_tbl
 = 1;

2302 
	`IWL_DEBUG_RATE
(
mvm
,

2304 
lq_°a
->
rs_°©e
 = 
RS_STATE_SEARCH_CYCLE_ENDED
;

2308 i‡(
lq_°a
->
£¨ch_bëãr_tbl
) {

2310 
tbl
 = &
lq_°a
->
lq_öfo
[
	`rs_£¨ch_tbl
÷q_°a->
a˘ive_tbl
)];

2311 
	`rs_øã_sˇÀ_˛ór_tbl_wödows
(
mvm
, 
tbl
);

2314 
ödex
 = 
tbl
->
øã
.index;

2316 
	`rs_dump_øã
(
mvm
, &
tbl
->
øã
,

2318 
	`rs_upd©e_øã_tbl
(
mvm
, 
°a
, 
lq_°a
, 
tbl
);

2320 
d⁄e_£¨ch
 = 1;

2324 i‡(!
ndp
)

2325 
	`rs_é_tu∫_⁄_agg
(
mvm
, 
mvm°a
, 
tid
, 
lq_°a
, 
°a
);

2327 i‡(
d⁄e_£¨ch
 && 
lq_°a
->
rs_°©e
 =
RS_STATE_SEARCH_CYCLE_ENDED
) {

2328 
tbl1
 = &(
lq_°a
->
lq_öfo
[lq_°a->
a˘ive_tbl
]);

2329 
	`rs_£t_°ay_ö_èbÀ
(
mvm
, 
	`is_Àgacy
(&
tbl1
->
øã
), 
lq_°a
);

2331 
	}
}

2333 
	srs_öô_øã_öfo
 {

2334 
s8
 
	mrssi
;

2335 
u8
 
	møã_idx
;

2338 c⁄° 
rs_öô_øã_öfo
 
	grs_›timÆ_øãs_24ghz_Àgacy
[] = {

2339 { -60, 
IWL_RATE_54M_INDEX
 },

2340 { -64, 
IWL_RATE_48M_INDEX
 },

2341 { -68, 
IWL_RATE_36M_INDEX
 },

2342 { -80, 
IWL_RATE_24M_INDEX
 },

2343 { -84, 
IWL_RATE_18M_INDEX
 },

2344 { -85, 
IWL_RATE_12M_INDEX
 },

2345 { -86, 
IWL_RATE_11M_INDEX
 },

2346 { -88, 
IWL_RATE_5M_INDEX
 },

2347 { -90, 
IWL_RATE_2M_INDEX
 },

2348 { 
S8_MIN
, 
IWL_RATE_1M_INDEX
 },

2351 c⁄° 
rs_öô_øã_öfo
 
	grs_›timÆ_øãs_5ghz_Àgacy
[] = {

2352 { -60, 
IWL_RATE_54M_INDEX
 },

2353 { -64, 
IWL_RATE_48M_INDEX
 },

2354 { -72, 
IWL_RATE_36M_INDEX
 },

2355 { -80, 
IWL_RATE_24M_INDEX
 },

2356 { -84, 
IWL_RATE_18M_INDEX
 },

2357 { -85, 
IWL_RATE_12M_INDEX
 },

2358 { -87, 
IWL_RATE_9M_INDEX
 },

2359 { 
S8_MIN
, 
IWL_RATE_6M_INDEX
 },

2362 c⁄° 
rs_öô_øã_öfo
 
	grs_›timÆ_øãs_ht
[] = {

2363 { -60, 
IWL_RATE_MCS_7_INDEX
 },

2364 { -64, 
IWL_RATE_MCS_6_INDEX
 },

2365 { -68, 
IWL_RATE_MCS_5_INDEX
 },

2366 { -72, 
IWL_RATE_MCS_4_INDEX
 },

2367 { -80, 
IWL_RATE_MCS_3_INDEX
 },

2368 { -84, 
IWL_RATE_MCS_2_INDEX
 },

2369 { -85, 
IWL_RATE_MCS_1_INDEX
 },

2370 { 
S8_MIN
, 
IWL_RATE_MCS_0_INDEX
},

2376 c⁄° 
rs_öô_øã_öfo
 
	grs_›timÆ_øãs_vht_20mhz
[] = {

2377 { -60, 
IWL_RATE_MCS_8_INDEX
 },

2378 { -64, 
IWL_RATE_MCS_7_INDEX
 },

2379 { -68, 
IWL_RATE_MCS_6_INDEX
 },

2380 { -72, 
IWL_RATE_MCS_5_INDEX
 },

2381 { -80, 
IWL_RATE_MCS_4_INDEX
 },

2382 { -84, 
IWL_RATE_MCS_3_INDEX
 },

2383 { -85, 
IWL_RATE_MCS_2_INDEX
 },

2384 { -87, 
IWL_RATE_MCS_1_INDEX
 },

2385 { 
S8_MIN
, 
IWL_RATE_MCS_0_INDEX
},

2388 c⁄° 
rs_öô_øã_öfo
 
	grs_›timÆ_øãs_vht
[] = {

2389 { -60, 
IWL_RATE_MCS_9_INDEX
 },

2390 { -64, 
IWL_RATE_MCS_8_INDEX
 },

2391 { -68, 
IWL_RATE_MCS_7_INDEX
 },

2392 { -72, 
IWL_RATE_MCS_6_INDEX
 },

2393 { -80, 
IWL_RATE_MCS_5_INDEX
 },

2394 { -84, 
IWL_RATE_MCS_4_INDEX
 },

2395 { -85, 
IWL_RATE_MCS_3_INDEX
 },

2396 { -87, 
IWL_RATE_MCS_2_INDEX
 },

2397 { -88, 
IWL_RATE_MCS_1_INDEX
 },

2398 { 
S8_MIN
, 
IWL_RATE_MCS_0_INDEX
 },

2401 
	#IWL_RS_LOW_RSSI_THRESHOLD
 (-76Ë

	)

2407 
	$rs_öô_›timÆ_øã
(
iwl_mvm
 *
mvm
,

2408 
õì80211_°a
 *
°a
,

2409 
iwl_lq_°a
 *
lq_°a
)

2411 
rs_øã
 *
øã
 = &
lq_°a
->
›timÆ_øã
;

2413 i‡(
lq_°a
->
max_mimo2_øã_idx
 !
IWL_RATE_INVALID
)

2414 
øã
->
ty≥
 = 
lq_°a
->
is_vht
 ? 
LQ_VHT_MIMO2
 : 
LQ_HT_MIMO2
;

2415 i‡(
lq_°a
->
max_siso_øã_idx
 !
IWL_RATE_INVALID
)

2416 
øã
->
ty≥
 = 
lq_°a
->
is_vht
 ? 
LQ_VHT_SISO
 : 
LQ_HT_SISO
;

2417 i‡(
lq_°a
->
b™d
 =
NL80211_BAND_5GHZ
)

2418 
øã
->
ty≥
 = 
LQ_LEGACY_A
;

2420 
øã
->
ty≥
 = 
LQ_LEGACY_G
;

2422 
øã
->
bw
 = 
	`rs_bw_‰om_°a_bw
(
°a
);

2423 
øã
->
sgi
 = 
	`rs_sgi_Ælow
(
mvm
, 
°a
,Ñ©e, 
NULL
);

2427 i‡(
	`is_mimo
(
øã
)) {

2428 
lq_°a
->
›timÆ_øã_mask
 =Üq_°a->
a˘ive_mimo2_øã
;

2429 } i‡(
	`is_siso
(
øã
)) {

2430 
lq_°a
->
›timÆ_øã_mask
 =Üq_°a->
a˘ive_siso_øã
;

2432 
lq_°a
->
›timÆ_øã_mask
 =Üq_°a->
a˘ive_Àgacy_øã
;

2434 i‡(
lq_°a
->
b™d
 =
NL80211_BAND_5GHZ
) {

2435 
lq_°a
->
›timÆ_øãs
 = 
rs_›timÆ_øãs_5ghz_Àgacy
;

2436 
lq_°a
->
›timÆ_√¡rõs
 =

2437 
	`ARRAY_SIZE
(
rs_›timÆ_øãs_5ghz_Àgacy
);

2439 
lq_°a
->
›timÆ_øãs
 = 
rs_›timÆ_øãs_24ghz_Àgacy
;

2440 
lq_°a
->
›timÆ_√¡rõs
 =

2441 
	`ARRAY_SIZE
(
rs_›timÆ_øãs_24ghz_Àgacy
);

2445 i‡(
	`is_vht
(
øã
)) {

2446 i‡(
øã
->
bw
 =
RATE_MCS_CHAN_WIDTH_20
) {

2447 
lq_°a
->
›timÆ_øãs
 = 
rs_›timÆ_øãs_vht_20mhz
;

2448 
lq_°a
->
›timÆ_√¡rõs
 =

2449 
	`ARRAY_SIZE
(
rs_›timÆ_øãs_vht_20mhz
);

2451 
lq_°a
->
›timÆ_øãs
 = 
rs_›timÆ_øãs_vht
;

2452 
lq_°a
->
›timÆ_√¡rõs
 =

2453 
	`ARRAY_SIZE
(
rs_›timÆ_øãs_vht
);

2455 } i‡(
	`is_ht
(
øã
)) {

2456 
lq_°a
->
›timÆ_øãs
 = 
rs_›timÆ_øãs_ht
;

2457 
lq_°a
->
›timÆ_√¡rõs
 = 
	`ARRAY_SIZE
(
rs_›timÆ_øãs_ht
);

2459 
	}
}

2462 
rs_øã
 *
	$rs_gë_›timÆ_øã
(
iwl_mvm
 *
mvm
,

2463 
iwl_lq_°a
 *
lq_°a
)

2465 
rs_øã
 *
øã
 = &
lq_°a
->
›timÆ_øã
;

2466 
i
;

2468 
øã
->
ödex
 = 
	`föd_fú°_bô
(&
lq_°a
->
›timÆ_øã_mask
,

2469 
BITS_PER_LONG
);

2471 
i
 = 0; i < 
lq_°a
->
›timÆ_√¡rõs
; i++) {

2472 
øã_idx
 = 
lq_°a
->
›timÆ_øãs
[
i
].rate_idx;

2474 i‡((
lq_°a
->
≥rs
.
œ°_rssi
 >lq_°a->
›timÆ_øãs
[
i
].
rssi
) &&

2475 (
	`BIT
(
øã_idx
Ë& 
lq_°a
->
›timÆ_øã_mask
)) {

2476 
øã
->
ödex
 = 
øã_idx
;

2481  
øã
;

2482 
	}
}

2487 
	$rs_gë_öôül_øã
(
iwl_mvm
 *
mvm
,

2488 
õì80211_°a
 *
°a
,

2489 
iwl_lq_°a
 *
lq_°a
,

2490 
∆80211_b™d
 
b™d
,

2491 
rs_øã
 *
øã
)

2493 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

2494 
i
, 
√¡rõs
;

2495 
a˘ive_øã
;

2496 
s8
 
be°_rssi
 = 
S8_MIN
;

2497 
u8
 
be°_™t
 = 
ANT_NONE
;

2498 
u8
 
vÆid_tx_™t
 = 
	`iwl_mvm_gë_vÆid_tx_™t
(
mvm
);

2499 c⁄° 
rs_öô_øã_öfo
 *
öôül_øãs
;

2501 
i
 = 0; i < 
	`ARRAY_SIZE
(
lq_°a
->
≥rs
.
chaö_sig«l
); i++) {

2502 i‡(!(
lq_°a
->
≥rs
.
chaös
 & 
	`BIT
(
i
)))

2505 i‡(
lq_°a
->
≥rs
.
chaö_sig«l
[
i
] > 
be°_rssi
) {

2506 
be°_rssi
 = 
lq_°a
->
≥rs
.
chaö_sig«l
[
i
];

2507 
be°_™t
 = 
	`BIT
(
i
);

2511 
	`IWL_DEBUG_RATE
(
mvm
, "Best ANT: %s Best RSSI: %d\n",

2512 
	`iwl_rs_¥ëty_™t
(
be°_™t
), 
be°_rssi
);

2514 i‡(
be°_™t
 !
ANT_A
 && be°_™à!
ANT_B
)

2515 
øã
->
™t
 = 
	`fú°_™ã¬a
(
vÆid_tx_™t
);

2517 
øã
->
™t
 = 
be°_™t
;

2519 
øã
->
sgi
 = 
Ál£
;

2520 
øã
->
ldpc
 = 
Ál£
;

2521 
øã
->
bw
 = 
RATE_MCS_CHAN_WIDTH_20
;

2523 
øã
->
ödex
 = 
	`föd_fú°_bô
(&
lq_°a
->
a˘ive_Àgacy_øã
,

2524 
BITS_PER_LONG
);

2526 i‡(
b™d
 =
NL80211_BAND_5GHZ
) {

2527 
øã
->
ty≥
 = 
LQ_LEGACY_A
;

2528 
öôül_øãs
 = 
rs_›timÆ_øãs_5ghz_Àgacy
;

2529 
√¡rõs
 = 
	`ARRAY_SIZE
(
rs_›timÆ_øãs_5ghz_Àgacy
);

2531 
øã
->
ty≥
 = 
LQ_LEGACY_G
;

2532 
öôül_øãs
 = 
rs_›timÆ_øãs_24ghz_Àgacy
;

2533 
√¡rõs
 = 
	`ARRAY_SIZE
(
rs_›timÆ_øãs_24ghz_Àgacy
);

2536 i‡(!
IWL_MVM_RS_RSSI_BASED_INIT_RATE
)

2537 
out
;

2544 i‡(
°a
->
deÊök
.
vht_ˇp
.
vht_suµ‹ãd
 &&

2545 
be°_rssi
 > 
IWL_RS_LOW_RSSI_THRESHOLD
) {

2555 
u32
 
bw
 = 
mvm°a
->
°a_°©e
 < 
IEEE80211_STA_AUTHORIZED
 ?

2556 
RATE_MCS_CHAN_WIDTH_20
 : 
	`rs_bw_‰om_°a_bw
(
°a
);

2558 
bw
) {

2559 
RATE_MCS_CHAN_WIDTH_40
:

2560 
RATE_MCS_CHAN_WIDTH_80
:

2561 
RATE_MCS_CHAN_WIDTH_160
:

2562 
öôül_øãs
 = 
rs_›timÆ_øãs_vht
;

2563 
√¡rõs
 = 
	`ARRAY_SIZE
(
rs_›timÆ_øãs_vht
);

2565 
RATE_MCS_CHAN_WIDTH_20
:

2566 
öôül_øãs
 = 
rs_›timÆ_øãs_vht_20mhz
;

2567 
√¡rõs
 = 
	`ARRAY_SIZE
(
rs_›timÆ_øãs_vht_20mhz
);

2570 
	`IWL_ERR
(
mvm
, "Invalid BW %d\n",

2571 
°a
->
deÊök
.
b™dwidth
);

2572 
out
;

2575 
a˘ive_øã
 = 
lq_°a
->
a˘ive_siso_øã
;

2576 
øã
->
ty≥
 = 
LQ_VHT_SISO
;

2577 
øã
->
bw
 = bw;

2578 } i‡(
°a
->
deÊök
.
ht_ˇp
.
ht_suµ‹ãd
 &&

2579 
be°_rssi
 > 
IWL_RS_LOW_RSSI_THRESHOLD
) {

2580 
öôül_øãs
 = 
rs_›timÆ_øãs_ht
;

2581 
√¡rõs
 = 
	`ARRAY_SIZE
(
rs_›timÆ_øãs_ht
);

2582 
a˘ive_øã
 = 
lq_°a
->
a˘ive_siso_øã
;

2583 
øã
->
ty≥
 = 
LQ_HT_SISO
;

2585 
a˘ive_øã
 = 
lq_°a
->
a˘ive_Àgacy_øã
;

2588 
i
 = 0; i < 
√¡rõs
; i++) {

2589 
øã_idx
 = 
öôül_øãs
[
i
].rate_idx;

2591 i‡((
be°_rssi
 >
öôül_øãs
[
i
].
rssi
) &&

2592 (
	`BIT
(
øã_idx
Ë& 
a˘ive_øã
)) {

2593 
øã
->
ödex
 = 
øã_idx
;

2598 
out
:

2599 
	`rs_dump_øã
(
mvm
, 
øã
, "INITIAL");

2600 
	}
}

2603 
	$rs_upd©e_œ°_rssi
(
iwl_mvm
 *
mvm
,

2604 
iwl_mvm_°a
 *
mvm°a
,

2605 
õì80211_rx_°©us
 *
rx_°©us
)

2607 
iwl_lq_°a
 *
lq_°a
 = &
mvm°a
->
deÊök
.lq_°a.
rs_drv
;

2608 
i
;

2610 
lq_°a
->
≥rs
.
chaös
 = 
rx_°©us
->chains;

2611 
lq_°a
->
≥rs
.
chaö_sig«l
[0] = 
rx_°©us
->chain_signal[0];

2612 
lq_°a
->
≥rs
.
chaö_sig«l
[1] = 
rx_°©us
->chain_signal[1];

2613 
lq_°a
->
≥rs
.
œ°_rssi
 = 
S8_MIN
;

2615 
i
 = 0; i < 
	`ARRAY_SIZE
(
lq_°a
->
≥rs
.
chaö_sig«l
); i++) {

2616 i‡(!(
lq_°a
->
≥rs
.
chaös
 & 
	`BIT
(
i
)))

2619 i‡(
lq_°a
->
≥rs
.
chaö_sig«l
[
i
] >Üq_°a->≥rs.
œ°_rssi
)

2620 
lq_°a
->
≥rs
.
œ°_rssi
 =Üq_°a->≥rs.
chaö_sig«l
[
i
];

2622 
	}
}

2638 
	$rs_öôülize_lq
(
iwl_mvm
 *
mvm
,

2639 
õì80211_°a
 *
°a
,

2640 
iwl_lq_°a
 *
lq_°a
,

2641 
∆80211_b™d
 
b™d
)

2643 
iwl_sˇÀ_tbl_öfo
 *
tbl
;

2644 
rs_øã
 *
øã
;

2645 
u8
 
a˘ive_tbl
 = 0;

2647 i‡(!
°a
 || !
lq_°a
)

2650 i‡(!
lq_°a
->
£¨ch_bëãr_tbl
)

2651 
a˘ive_tbl
 = 
lq_°a
->active_tbl;

2653 
a˘ive_tbl
 = 
	`rs_£¨ch_tbl
(
lq_°a
->active_tbl);

2655 
tbl
 = &(
lq_°a
->
lq_öfo
[
a˘ive_tbl
]);

2656 
øã
 = &
tbl
->rate;

2658 
	`rs_gë_öôül_øã
(
mvm
, 
°a
, 
lq_°a
, 
b™d
, 
øã
);

2659 
	`rs_öô_›timÆ_øã
(
mvm
, 
°a
, 
lq_°a
);

2661 
	`WARN_ONCE
(
øã
->
™t
 !
ANT_A
 &&Ñ©e->™à!
ANT_B
,

2663 
øã
->
™t
, 
lq_°a
->
≥rs
.
chaös
, 
mvm
->
fw
->
vÆid_tx_™t
,

2664 
mvm
->
nvm_d©a
 ? mvm->nvm_d©a->
vÆid_tx_™t
 : 
ANT_INVALID
);

2666 
tbl
->
cﬁumn
 = 
	`rs_gë_cﬁumn_‰om_øã
(
øã
);

2668 
	`rs_£t_ex≥˘ed_çt_èbÀ
(
lq_°a
, 
tbl
);

2669 
	`rs_fûl_lq_cmd
(
mvm
, 
°a
, 
lq_°a
, 
øã
);

2671 
	`iwl_mvm_£nd_lq_cmd
(
mvm
, &
lq_°a
->
lq
);

2672 
	}
}

2674 
	$rs_drv_gë_øã
(*
mvm_r
, 
õì80211_°a
 *
°a
,

2675 *
mvm_°a
,

2676 
õì80211_tx_øã_c⁄åﬁ
 *
txrc
)

2678 
iwl_›_mode
 *
›_mode
 = 
mvm_r
;

2679 
iwl_mvm
 *
mvm
 
__maybe_unu£d
 = 
	`IWL_OP_MODE_GET_MVM
(
›_mode
);

2680 
sk_buff
 *
skb
 = 
txrc
->skb;

2681 
õì80211_tx_öfo
 *
öfo
 = 
	`IEEE80211_SKB_CB
(
skb
);

2682 
iwl_lq_°a
 *
lq_°a
;

2683 
rs_øã
 *
›timÆ_øã
;

2684 
u32
 
œ°_ucode_øã
;

2686 i‡(
°a
 && !
	`iwl_mvm_°a_‰om_mac80211
(°a)->
vif
) {

2690 
mvm_°a
 = 
NULL
;

2693 i‡(!
mvm_°a
)

2696 
lq_°a
 = 
mvm_°a
;

2698 
	`•ö_lock_bh
(&
lq_°a
->
≥rs
.
lock
);

2699 
	`iwl_mvm_hwøã_to_tx_øã_v1
(
lq_°a
->
œ°_øã_n_Êags
,

2700 
öfo
->
b™d
, &öfo->
c⁄åﬁ
.
øãs
[0]);

2701 
öfo
->
c⁄åﬁ
.
øãs
[0].
cou¡
 = 1;

2706 i‡(
lq_°a
->
rs_°©e
 !
RS_STATE_STAY_IN_COLUMN
) {

2707 
›timÆ_øã
 = 
	`rs_gë_›timÆ_øã
(
mvm
, 
lq_°a
);

2708 
œ°_ucode_øã
 = 
	`ucode_øã_‰om_rs_øã
(
mvm
,

2709 
›timÆ_øã
);

2710 
	`iwl_mvm_hwøã_to_tx_øã_v1
(
œ°_ucode_øã
, 
öfo
->
b™d
,

2711 &
txrc
->
ªp‹ãd_øã
);

2713 
	`•ö_u∆ock_bh
(&
lq_°a
->
≥rs
.
lock
);

2714 
	}
}

2716 *
	$rs_drv_Æloc_°a
(*
mvm_øã
, 
õì80211_°a
 *
°a
,

2717 
gÂ_t
 
gÂ
)

2719 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

2720 
iwl_›_mode
 *
›_mode
 = (iwl_›_modê*)
mvm_øã
;

2721 
iwl_mvm
 *
mvm
 = 
	`IWL_OP_MODE_GET_MVM
(
›_mode
);

2722 
iwl_lq_°a
 *
lq_°a
 = &
mvm°a
->
deÊök
.lq_°a.
rs_drv
;

2724 
	`IWL_DEBUG_RATE
(
mvm
, "create stationÑate scale window\n");

2726 
lq_°a
->
≥rs
.
drv
 = 
mvm
;

2727 #ifde‡
CONFIG_MAC80211_DEBUGFS


2728 
lq_°a
->
≥rs
.
dbg_fixed_øã
 = 0;

2729 
lq_°a
->
≥rs
.
dbg_fixed_txp_ªdu˘i⁄
 = 
TPC_INVALID
;

2730 
lq_°a
->
≥rs
.
ss_f‹˚
 = 
RS_SS_FORCE_NONE
;

2732 
lq_°a
->
≥rs
.
chaös
 = 0;

2733 
	`mem£t
(
lq_°a
->
≥rs
.
chaö_sig«l
, 0, (lq_sta->pers.chain_signal));

2734 
lq_°a
->
≥rs
.
œ°_rssi
 = 
S8_MIN
;

2736  
lq_°a
;

2737 
	}
}

2739 
	$rs_vht_highe°_rx_mcs_ödex
(
õì80211_°a_vht_ˇp
 *
vht_ˇp
,

2740 
nss
)

2742 
u16
 
rx_mcs
 = 
	`À16_to_˝u
(
vht_ˇp
->
vht_mcs
.
rx_mcs_m≠
) &

2743 (0x3 << (2 * (
nss
 - 1)));

2744 
rx_mcs
 >>(2 * (
nss
 - 1));

2746 i‡(
rx_mcs
 =
IEEE80211_VHT_MCS_SUPPORT_0_7
)

2747  
IWL_RATE_MCS_7_INDEX
;

2748 i‡(
rx_mcs
 =
IEEE80211_VHT_MCS_SUPPORT_0_8
)

2749  
IWL_RATE_MCS_8_INDEX
;

2750 i‡(
rx_mcs
 =
IEEE80211_VHT_MCS_SUPPORT_0_9
)

2751  
IWL_RATE_MCS_9_INDEX
;

2753 
	`WARN_ON_ONCE
(
rx_mcs
 !
IEEE80211_VHT_MCS_NOT_SUPPORTED
);

2755 
	}
}

2757 
	$rs_vht_£t_íabÀd_øãs
(
õì80211_°a
 *
°a
,

2758 
õì80211_°a_vht_ˇp
 *
vht_ˇp
,

2759 
iwl_lq_°a
 *
lq_°a
)

2761 
i
;

2762 
highe°_mcs
 = 
	`rs_vht_highe°_rx_mcs_ödex
(
vht_ˇp
, 1);

2764 i‡(
highe°_mcs
 >
IWL_RATE_MCS_0_INDEX
) {

2765 
i
 = 
IWL_RATE_MCS_0_INDEX
; i <
highe°_mcs
; i++) {

2766 i‡(
i
 =
IWL_RATE_9M_INDEX
)

2770 i‡(
i
 =
IWL_RATE_MCS_9_INDEX
 &&

2771 
°a
->
deÊök
.
b™dwidth
 =
IEEE80211_STA_RX_BW_20
)

2774 
lq_°a
->
a˘ive_siso_øã
 |
	`BIT
(
i
);

2778 i‡(
°a
->
deÊök
.
rx_nss
 < 2)

2781 
highe°_mcs
 = 
	`rs_vht_highe°_rx_mcs_ödex
(
vht_ˇp
, 2);

2782 i‡(
highe°_mcs
 >
IWL_RATE_MCS_0_INDEX
) {

2783 
i
 = 
IWL_RATE_MCS_0_INDEX
; i <
highe°_mcs
; i++) {

2784 i‡(
i
 =
IWL_RATE_9M_INDEX
)

2788 i‡(
i
 =
IWL_RATE_MCS_9_INDEX
 &&

2789 
°a
->
deÊök
.
b™dwidth
 =
IEEE80211_STA_RX_BW_20
)

2792 
lq_°a
->
a˘ive_mimo2_øã
 |
	`BIT
(
i
);

2795 
	}
}

2797 
	$rs_ht_öô
(
iwl_mvm
 *
mvm
,

2798 
õì80211_°a
 *
°a
,

2799 
iwl_lq_°a
 *
lq_°a
,

2800 
õì80211_°a_ht_ˇp
 *
ht_ˇp
)

2806 
lq_°a
->
a˘ive_siso_øã
 = 
ht_ˇp
->
mcs
.
rx_mask
[0] << 1;

2807 
lq_°a
->
a˘ive_siso_øã
 |
ht_ˇp
->
mcs
.
rx_mask
[0] & 0x1;

2808 
lq_°a
->
a˘ive_siso_øã
 &~((
u16
)0x2);

2809 
lq_°a
->
a˘ive_siso_øã
 <<
IWL_FIRST_OFDM_RATE
;

2811 
lq_°a
->
a˘ive_mimo2_øã
 = 
ht_ˇp
->
mcs
.
rx_mask
[1] << 1;

2812 
lq_°a
->
a˘ive_mimo2_øã
 |
ht_ˇp
->
mcs
.
rx_mask
[1] & 0x1;

2813 
lq_°a
->
a˘ive_mimo2_øã
 &~((
u16
)0x2);

2814 
lq_°a
->
a˘ive_mimo2_øã
 <<
IWL_FIRST_OFDM_RATE
;

2816 i‡(
mvm
->
cfg
->
ht_∑øms
->
ldpc
 &&

2817 (
ht_ˇp
->
ˇp
 & 
IEEE80211_HT_CAP_LDPC_CODING
))

2818 
lq_°a
->
ldpc
 = 
åue
;

2820 i‡(
mvm
->
cfg
->
ht_∑øms
->
°bc
 &&

2821 (
	`num_of_™t
(
	`iwl_mvm_gë_vÆid_tx_™t
(
mvm
)) > 1) &&

2822 (
ht_ˇp
->
ˇp
 & 
IEEE80211_HT_CAP_RX_STBC
))

2823 
lq_°a
->
°bc_ˇ∑bÀ
 = 
åue
;

2825 
lq_°a
->
is_vht
 = 
Ál£
;

2826 
	}
}

2828 
	$rs_vht_öô
(
iwl_mvm
 *
mvm
,

2829 
õì80211_°a
 *
°a
,

2830 
iwl_lq_°a
 *
lq_°a
,

2831 
õì80211_°a_vht_ˇp
 *
vht_ˇp
)

2833 
	`rs_vht_£t_íabÀd_øãs
(
°a
, 
vht_ˇp
, 
lq_°a
);

2835 i‡(
mvm
->
cfg
->
ht_∑øms
->
ldpc
 &&

2836 (
vht_ˇp
->
ˇp
 & 
IEEE80211_VHT_CAP_RXLDPC
))

2837 
lq_°a
->
ldpc
 = 
åue
;

2839 i‡(
mvm
->
cfg
->
ht_∑øms
->
°bc
 &&

2840 (
	`num_of_™t
(
	`iwl_mvm_gë_vÆid_tx_™t
(
mvm
)) > 1) &&

2841 (
vht_ˇp
->
ˇp
 & 
IEEE80211_VHT_CAP_RXSTBC_MASK
))

2842 
lq_°a
->
°bc_ˇ∑bÀ
 = 
åue
;

2844 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_CAPA_BEAMFORMER
) &&

2845 (
	`num_of_™t
(
	`iwl_mvm_gë_vÆid_tx_™t
(
mvm
)) > 1) &&

2846 (
vht_ˇp
->
ˇp
 & 
IEEE80211_VHT_CAP_SU_BEAMFORMEE_CAPABLE
))

2847 
lq_°a
->
b„r_ˇ∑bÀ
 = 
åue
;

2849 
lq_°a
->
is_vht
 = 
åue
;

2850 
	}
}

2852 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


2853 
	$iwl_mvm_ª£t_‰ame_°©s
(
iwl_mvm
 *
mvm
)

2855 
	`•ö_lock_bh
(&
mvm
->
drv_°©s_lock
);

2856 
	`mem£t
(&
mvm
->
drv_rx_°©s
, 0, (mvm->drv_rx_stats));

2857 
	`•ö_u∆ock_bh
(&
mvm
->
drv_°©s_lock
);

2858 
	}
}

2860 
	$iwl_mvm_upd©e_‰ame_°©s
(
iwl_mvm
 *
mvm
, 
u32
 
øã
, 
boﬁ
 
agg
)

2862 
u8
 
nss
 = 0;

2864 
	`•ö_lock
(&
mvm
->
drv_°©s_lock
);

2866 i‡(
agg
)

2867 
mvm
->
drv_rx_°©s
.
agg_‰ames
++;

2869 
mvm
->
drv_rx_°©s
.
suc˚ss_‰ames
++;

2871 
øã
 & 
RATE_MCS_CHAN_WIDTH_MSK_V1
) {

2872 
RATE_MCS_CHAN_WIDTH_20
:

2873 
mvm
->
drv_rx_°©s
.
bw_20_‰ames
++;

2875 
RATE_MCS_CHAN_WIDTH_40
:

2876 
mvm
->
drv_rx_°©s
.
bw_40_‰ames
++;

2878 
RATE_MCS_CHAN_WIDTH_80
:

2879 
mvm
->
drv_rx_°©s
.
bw_80_‰ames
++;

2881 
RATE_MCS_CHAN_WIDTH_160
:

2882 
mvm
->
drv_rx_°©s
.
bw_160_‰ames
++;

2885 
	`WARN_ONCE
(1, "bad BW.Ñ©ê0x%x", 
øã
);

2888 i‡(
øã
 & 
RATE_MCS_HT_MSK_V1
) {

2889 
mvm
->
drv_rx_°©s
.
ht_‰ames
++;

2890 
nss
 = ((
øã
 & 
RATE_HT_MCS_NSS_MSK_V1
Ë>> 
RATE_HT_MCS_NSS_POS_V1
) + 1;

2891 } i‡(
øã
 & 
RATE_MCS_VHT_MSK_V1
) {

2892 
mvm
->
drv_rx_°©s
.
vht_‰ames
++;

2893 
nss
 = 
	`FIELD_GET
(
RATE_MCS_NSS_MSK
, 
øã
) + 1;

2895 
mvm
->
drv_rx_°©s
.
Àgacy_‰ames
++;

2898 i‡(
nss
 == 1)

2899 
mvm
->
drv_rx_°©s
.
siso_‰ames
++;

2900 i‡(
nss
 == 2)

2901 
mvm
->
drv_rx_°©s
.
mimo2_‰ames
++;

2903 i‡(
øã
 & 
RATE_MCS_SGI_MSK_V1
)

2904 
mvm
->
drv_rx_°©s
.
sgi_‰ames
++;

2906 
mvm
->
drv_rx_°©s
.
ngi_‰ames
++;

2908 
mvm
->
drv_rx_°©s
.
œ°_øãs
[mvm->drv_rx_°©s.
œ°_‰ame_idx
] = 
øã
;

2909 
mvm
->
drv_rx_°©s
.
œ°_‰ame_idx
 =

2910 (
mvm
->
drv_rx_°©s
.
œ°_‰ame_idx
 + 1) %

2911 
	`ARRAY_SIZE
(
mvm
->
drv_rx_°©s
.
œ°_øãs
);

2913 
	`•ö_u∆ock
(&
mvm
->
drv_°©s_lock
);

2914 
	}
}

2920 
	$rs_drv_øã_öô
(
iwl_mvm
 *
mvm
, 
õì80211_°a
 *
°a
,

2921 
∆80211_b™d
 
b™d
)

2923 
i
, 
j
;

2924 
õì80211_hw
 *
hw
 = 
mvm
->hw;

2925 
õì80211_°a_ht_ˇp
 *
ht_ˇp
 = &
°a
->
deÊök
.ht_cap;

2926 
õì80211_°a_vht_ˇp
 *
vht_ˇp
 = &
°a
->
deÊök
.vht_cap;

2927 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

2928 
iwl_lq_°a
 *
lq_°a
 = &
mvm°a
->
deÊök
.lq_°a.
rs_drv
;

2929 
õì80211_suµ‹ãd_b™d
 *
sb™d
;

2930 
suµ
;

2932 
	`lockdï_as£π_hñd
(&
mvm°a
->
deÊök
.
lq_°a
.
rs_drv
.
≥rs
.
lock
);

2935 
	`mem£t
(
lq_°a
, 0, 
	`off£tof
(
	`ty≥of
(*lq_°a), 
≥rs
));

2937 
sb™d
 = 
hw
->
wùhy
->
b™ds
[
b™d
];

2939 
lq_°a
->
lq
.
°a_id
 = 
mvm°a
->
deÊök
.sta_id;

2940 
mvm°a
->
amsdu_íabÀd
 = 0;

2941 
mvm°a
->
max_amsdu_Àn
 = 
°a
->
cur
->max_amsdu_len;

2943 
j
 = 0; j < 
LQ_SIZE
; j++)

2944 
	`rs_øã_sˇÀ_˛ór_tbl_wödows
(
mvm
, &
lq_°a
->
lq_öfo
[
j
]);

2946 
lq_°a
->
Êush_timî
 = 0;

2947 
lq_°a
->
œ°_tx
 = 
jiffõs
;

2949 
	`IWL_DEBUG_RATE
(
mvm
,

2951 
mvm°a
->
deÊök
.
°a_id
);

2957 
lq_°a
->
mis£d_øã_cou¡î
 = 
IWL_MVM_RS_MISSED_RATE_MAX
;

2958 
lq_°a
->
b™d
 = 
sb™d
->band;

2962 
suµ
 = 
°a
->
deÊök
.
suµ_øãs
[
sb™d
->
b™d
];

2963 
lq_°a
->
a˘ive_Àgacy_øã
 = 0;

2964 
	`f‹_óch_£t_bô
(
i
, &
suµ
, 
BITS_PER_LONG
)

2965 
lq_°a
->
a˘ive_Àgacy_øã
 |
	`BIT
(
sb™d
->
bôøãs
[
i
].
hw_vÆue
);

2968 i‡(!
vht_ˇp
 || !vht_ˇp->
vht_suµ‹ãd
)

2969 
	`rs_ht_öô
(
mvm
, 
°a
, 
lq_°a
, 
ht_ˇp
);

2971 
	`rs_vht_öô
(
mvm
, 
°a
, 
lq_°a
, 
vht_ˇp
);

2973 
lq_°a
->
max_Àgacy_øã_idx
 =

2974 
	`rs_gë_max_øã_‰om_mask
(
lq_°a
->
a˘ive_Àgacy_øã
);

2975 
lq_°a
->
max_siso_øã_idx
 =

2976 
	`rs_gë_max_øã_‰om_mask
(
lq_°a
->
a˘ive_siso_øã
);

2977 
lq_°a
->
max_mimo2_øã_idx
 =

2978 
	`rs_gë_max_øã_‰om_mask
(
lq_°a
->
a˘ive_mimo2_øã
);

2980 
	`IWL_DEBUG_RATE
(
mvm
,

2982 
lq_°a
->
a˘ive_Àgacy_øã
,

2983 
lq_°a
->
a˘ive_siso_øã
,

2984 
lq_°a
->
a˘ive_mimo2_øã
,

2985 
lq_°a
->
is_vht
,Üq_°a->
ldpc
,Üq_°a->
°bc_ˇ∑bÀ
,

2986 
lq_°a
->
b„r_ˇ∑bÀ
);

2987 
	`IWL_DEBUG_RATE
(
mvm
, "MAX RATE: LEGACY=%d SISO=%d MIMO2=%d\n",

2988 
lq_°a
->
max_Àgacy_øã_idx
,

2989 
lq_°a
->
max_siso_øã_idx
,

2990 
lq_°a
->
max_mimo2_øã_idx
);

2993 
lq_°a
->
lq
.
sögÀ_°ªam_™t_msk
 =

2994 
	`iwl_mvm_bt_c€x_gë_sögÀ_™t_msk
(
mvm
, 
	`iwl_mvm_gë_vÆid_tx_™t
(mvm));

2995 
lq_°a
->
lq
.
duÆ_°ªam_™t_msk
 = 
ANT_AB
;

2998 
lq_°a
->
tx_agg_tid_í
 = 
IWL_AGG_ALL_TID
;

2999 
lq_°a
->
is_agg
 = 0;

3000 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


3001 
	`iwl_mvm_ª£t_‰ame_°©s
(
mvm
);

3003 
	`rs_öôülize_lq
(
mvm
, 
°a
, 
lq_°a
, 
b™d
);

3004 
	}
}

3006 
	$rs_drv_øã_upd©e
(*
mvm_r
,

3007 
õì80211_suµ‹ãd_b™d
 *
sb™d
,

3008 
cfg80211_ch™_def
 *
ch™def
,

3009 
õì80211_°a
 *
°a
,

3010 *
¥iv_°a
, 
u32
 
ch™ged
)

3012 
iwl_›_mode
 *
›_mode
 = 
mvm_r
;

3013 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

3014 
iwl_mvm
 *
mvm
 
__maybe_unu£d
 = 
	`IWL_OP_MODE_GET_MVM
(
›_mode
);

3015 
u8
 
tid
;

3017 i‡(!
mvm°a
->
vif
)

3021 
tid
 = 0;Åid < 
IWL_MAX_TID_COUNT
;Åid++)

3022 
	`õì80211_°›_tx_ba_£ssi⁄
(
°a
, 
tid
);

3024 
	`iwl_mvm_rs_øã_öô
(
mvm
, 
mvm°a
->
vif
, 
°a
,

3025 &
mvm°a
->
vif
->
bss_c⁄f
, &
°a
->
deÊök
,

3026 
sb™d
->
b™d
);

3027 
	}
}

3029 
	$__iwl_mvm_rs_tx_°©us
(
iwl_mvm
 *
mvm
,

3030 
õì80211_°a
 *
°a
,

3031 
tid
, 
õì80211_tx_öfo
 *
öfo
,

3032 
boﬁ
 
ndp
)

3034 
Àgacy_suc˚ss
;

3035 
ªåõs
;

3036 
i
;

3037 
iwl_lq_cmd
 *
èbÀ
;

3038 
u32
 
lq_hwøã
;

3039 
rs_øã
 
lq_øã
, 
tx_ª•_øã
;

3040 
iwl_sˇÀ_tbl_öfo
 *
cuº_tbl
, *
Ÿhî_tbl
, *
tmp_tbl
;

3041 
u32
 
éc_öfo
 = (
uöçå_t
)
öfo
->
°©us
.
°©us_drivî_d©a
[0];

3042 
u8
 
ªdu˚d_txp
 = 
éc_öfo
 & 
RS_DRV_DATA_TXP_MSK
;

3043 
u8
 
lq_cﬁ‹
 = 
	`RS_DRV_DATA_LQ_COLOR_GET
(
éc_öfo
);

3044 
u32
 
tx_ª•_hwøã
 = (
uöçå_t
)
öfo
->
°©us
.
°©us_drivî_d©a
[1];

3045 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

3046 
iwl_lq_°a
 *
lq_°a
 = &
mvm°a
->
deÊök
.lq_°a.
rs_drv
;

3048 i‡(!
lq_°a
->
≥rs
.
drv
) {

3049 
	`IWL_DEBUG_RATE
(
mvm
, "Rate scalingÇot initialized yet.\n");

3054 i‡((
öfo
->
Êags
 & 
IEEE80211_TX_CTL_AMPDU
) &&

3055 !(
öfo
->
Êags
 & 
IEEE80211_TX_STAT_AMPDU
))

3058 i‡(
	`rs_øã_‰om_ucode_øã
(
tx_ª•_hwøã
, 
öfo
->
b™d
,

3059 &
tx_ª•_øã
)) {

3060 
	`WARN_ON_ONCE
(1);

3064 #ifde‡
CONFIG_MAC80211_DEBUGFS


3068 i‡(
lq_°a
->
≥rs
.
dbg_fixed_øã
) {

3069 
ödex
 = 
tx_ª•_øã
.index;

3070 
rs_cﬁumn
 
cﬁumn
;

3071 
©ãm±s
, 
suc˚ss
;

3073 
cﬁumn
 = 
	`rs_gë_cﬁumn_‰om_øã
(&
tx_ª•_øã
);

3074 i‡(
	`WARN_ONCE
(
cﬁumn
 =
RS_COLUMN_INVALID
,

3076 
tx_ª•_hwøã
))

3079 i‡(
öfo
->
Êags
 & 
IEEE80211_TX_STAT_AMPDU
) {

3080 
©ãm±s
 = 
öfo
->
°©us
.
ampdu_Àn
;

3081 
suc˚ss
 = 
öfo
->
°©us
.
ampdu_ack_Àn
;

3083 
©ãm±s
 = 
öfo
->
°©us
.
øãs
[0].
cou¡
;

3084 
suc˚ss
 = !!(
öfo
->
Êags
 & 
IEEE80211_TX_STAT_ACK
);

3087 
lq_°a
->
≥rs
.
tx_°©s
[
cﬁumn
][
ödex
].
tŸÆ
 +
©ãm±s
;

3088 
lq_°a
->
≥rs
.
tx_°©s
[
cﬁumn
][
ödex
].
suc˚ss
 += success;

3090 
	`IWL_DEBUG_RATE
(
mvm
, "FixedÑate 0x%x success %dáttempts %d\n",

3091 
tx_ª•_hwøã
, 
suc˚ss
, 
©ãm±s
);

3096 i‡(
	`time_a·î
(
jiffõs
,

3097 ()(
lq_°a
->
œ°_tx
 +

3098 (
IWL_MVM_RS_IDLE_TIMEOUT
 * 
HZ
)))) {

3099 
	`IWL_DEBUG_RATE
(
mvm
, "Tx idle forÅooÜong.ÑeinitÑs\n");

3103 
	`rs_drv_øã_öô
(
mvm
, 
°a
, 
öfo
->
b™d
);

3106 
lq_°a
->
œ°_tx
 = 
jiffõs
;

3115 
èbÀ
 = &
lq_°a
->
lq
;

3116 
lq_hwøã
 = 
	`À32_to_˝u
(
èbÀ
->
rs_èbÀ
[0]);

3117 i‡(
	`rs_øã_‰om_ucode_øã
(
lq_hwøã
, 
öfo
->
b™d
, &
lq_øã
)) {

3118 
	`WARN_ON_ONCE
(1);

3123 i‡(
lq_cﬁ‹
 !
	`LQ_FLAG_COLOR_GET
(
èbÀ
->
Êags
)) {

3124 
	`IWL_DEBUG_RATE
(
mvm
,

3126 
lq_cﬁ‹
, 
	`LQ_FLAG_COLOR_GET
(
èbÀ
->
Êags
));

3132 
lq_°a
->
mis£d_øã_cou¡î
++;

3133 i‡(
lq_°a
->
mis£d_øã_cou¡î
 > 
IWL_MVM_RS_MISSED_RATE_MAX
) {

3134 
lq_°a
->
mis£d_øã_cou¡î
 = 0;

3135 
	`IWL_DEBUG_RATE
(
mvm
,

3137 
lq_°a
->
rs_°©e
);

3138 
	`iwl_mvm_£nd_lq_cmd
(
mvm
, &
lq_°a
->
lq
);

3145 
lq_°a
->
mis£d_øã_cou¡î
 = 0;

3147 i‡(!
lq_°a
->
£¨ch_bëãr_tbl
) {

3148 
cuº_tbl
 = &
lq_°a
->
lq_öfo
[lq_°a->
a˘ive_tbl
];

3149 
Ÿhî_tbl
 = &
lq_°a
->
lq_öfo
[
	`rs_£¨ch_tbl
÷q_°a->
a˘ive_tbl
)];

3151 
cuº_tbl
 = &
lq_°a
->
lq_öfo
[
	`rs_£¨ch_tbl
÷q_°a->
a˘ive_tbl
)];

3152 
Ÿhî_tbl
 = &
lq_°a
->
lq_öfo
[lq_°a->
a˘ive_tbl
];

3155 i‡(
	`WARN_ON_ONCE
(!
	`rs_øã_cﬁumn_m©ch
(&
lq_øã
, &
cuº_tbl
->
øã
))) {

3156 
	`IWL_DEBUG_RATE
(
mvm
,

3158 
tmp_tbl
 = &
lq_°a
->
lq_öfo
[lq_°a->
a˘ive_tbl
];

3159 
	`rs_dump_øã
(
mvm
, &
tmp_tbl
->
øã
, "ACTIVE");

3160 
tmp_tbl
 = &
lq_°a
->
lq_öfo
[
	`rs_£¨ch_tbl
÷q_°a->
a˘ive_tbl
)];

3161 
	`rs_dump_øã
(
mvm
, &
tmp_tbl
->
øã
, "SEARCH");

3162 
	`rs_dump_øã
(
mvm
, &
lq_øã
, "ACTUAL");

3167 
	`rs_°ay_ö_èbÀ
(
lq_°a
, 
åue
);

3168 
d⁄e
;

3177 i‡(
öfo
->
Êags
 & 
IEEE80211_TX_STAT_AMPDU
) {

3178 
	`rs_cﬁÀ˘_çc_d©a
(
mvm
, 
lq_°a
, 
cuº_tbl
, 
tx_ª•_øã
.
ödex
,

3179 
öfo
->
°©us
.
ampdu_Àn
,

3180 
öfo
->
°©us
.
ampdu_ack_Àn
,

3181 
ªdu˚d_txp
);

3196 i‡(
öfo
->
°©us
.
ampdu_ack_Àn
 == 0)

3197 
öfo
->
°©us
.
ampdu_Àn
 = 1;

3199 
	`rs_cﬁÀ˘_éc_d©a
(
mvm
, 
mvm°a
, 
tid
, 
cuº_tbl
,

3200 
tx_ª•_øã
.
ödex
,

3201 
öfo
->
°©us
.
ampdu_Àn
,

3202 
öfo
->
°©us
.
ampdu_ack_Àn
);

3205 i‡(
lq_°a
->
rs_°©e
 =
RS_STATE_STAY_IN_COLUMN
) {

3206 
lq_°a
->
tŸÆ_suc˚ss
 +
öfo
->
°©us
.
ampdu_ack_Àn
;

3207 
lq_°a
->
tŸÆ_Áûed
 +(
öfo
->
°©us
.
ampdu_Àn
 -

3208 
öfo
->
°©us
.
ampdu_ack_Àn
);

3212 
ªåõs
 = 
öfo
->
°©us
.
øãs
[0].
cou¡
 - 1;

3214 
ªåõs
 = 
	`mö
(retries, 15);

3217 
Àgacy_suc˚ss
 = !!(
öfo
->
Êags
 & 
IEEE80211_TX_STAT_ACK
);

3219 
i
 = 0; i <
ªåõs
; ++i) {

3220 
lq_hwøã
 = 
	`À32_to_˝u
(
èbÀ
->
rs_èbÀ
[
i
]);

3221 i‡(
	`rs_øã_‰om_ucode_øã
(
lq_hwøã
, 
öfo
->
b™d
,

3222 &
lq_øã
)) {

3223 
	`WARN_ON_ONCE
(1);

3230 i‡(
	`rs_øã_cﬁumn_m©ch
(&
lq_øã
, &
cuº_tbl
->
øã
))

3231 
tmp_tbl
 = 
cuº_tbl
;

3232 i‡(
	`rs_øã_cﬁumn_m©ch
(&
lq_øã
,

3233 &
Ÿhî_tbl
->
øã
))

3234 
tmp_tbl
 = 
Ÿhî_tbl
;

3238 
	`rs_cﬁÀ˘_çc_d©a
(
mvm
, 
lq_°a
, 
tmp_tbl
,

3239 
tx_ª•_øã
.
ödex
, 1,

3240 
i
 < 
ªåõs
 ? 0 : 
Àgacy_suc˚ss
,

3241 
ªdu˚d_txp
);

3242 
	`rs_cﬁÀ˘_éc_d©a
(
mvm
, 
mvm°a
, 
tid
, 
tmp_tbl
,

3243 
tx_ª•_øã
.
ödex
, 1,

3244 
i
 < 
ªåõs
 ? 0 : 
Àgacy_suc˚ss
);

3248 i‡(
lq_°a
->
rs_°©e
 =
RS_STATE_STAY_IN_COLUMN
) {

3249 
lq_°a
->
tŸÆ_suc˚ss
 +
Àgacy_suc˚ss
;

3250 
lq_°a
->
tŸÆ_Áûed
 +
ªåõs
 + (1 - 
Àgacy_suc˚ss
);

3254 
lq_°a
->
œ°_øã_n_Êags
 = 
lq_hwøã
;

3255 
	`IWL_DEBUG_RATE
(
mvm
, "ªdu˚dÅxpowî: %d\n", 
ªdu˚d_txp
);

3256 
d⁄e
:

3258 i‡(
°a
->
deÊök
.
suµ_øãs
[
öfo
->
b™d
])

3259 
	`rs_øã_sˇÀ_≥rf‹m
(
mvm
, 
°a
, 
lq_°a
, 
tid
, 
ndp
);

3260 
	}
}

3262 
	$iwl_mvm_rs_tx_°©us
(
iwl_mvm
 *
mvm
, 
õì80211_°a
 *
°a
,

3263 
tid
, 
õì80211_tx_öfo
 *
öfo
, 
boﬁ
 
ndp
)

3265 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

3270 i‡(!
	`•ö_åylock_bh
(&
mvm°a
->
deÊök
.
lq_°a
.
rs_drv
.
≥rs
.
lock
))

3273 
	`__iwl_mvm_rs_tx_°©us
(
mvm
, 
°a
, 
tid
, 
öfo
, 
ndp
);

3274 
	`•ö_u∆ock_bh
(&
mvm°a
->
deÊök
.
lq_°a
.
rs_drv
.
≥rs
.
lock
);

3275 
	}
}

3277 #ifde‡
CONFIG_MAC80211_DEBUGFS


3278 
	$rs_buûd_øãs_èbÀ_‰om_fixed
(
iwl_mvm
 *
mvm
,

3279 
iwl_lq_cmd
 *
lq_cmd
,

3280 
∆80211_b™d
 
b™d
,

3281 
u32
 
ucode_øã
)

3283 
rs_øã
 
øã
;

3284 
i
;

3285 
num_øãs
 = 
	`ARRAY_SIZE
(
lq_cmd
->
rs_èbÀ
);

3286 
__À32
 
ucode_øã_À32
 = 
	`˝u_to_À32
(
ucode_øã
);

3287 
u8
 
™t
 = (
ucode_øã
 & 
RATE_MCS_ANT_AB_MSK
Ë>> 
RATE_MCS_ANT_POS
;

3289 
i
 = 0; i < 
num_øãs
; i++)

3290 
lq_cmd
->
rs_èbÀ
[
i
] = 
ucode_øã_À32
;

3292 i‡(
	`rs_øã_‰om_ucode_øã
(
ucode_øã
, 
b™d
, &
øã
)) {

3293 
	`WARN_ON_ONCE
(1);

3297 i‡(
	`is_mimo
(&
øã
))

3298 
lq_cmd
->
mimo_dñim
 = 
num_øãs
 - 1;

3300 
lq_cmd
->
mimo_dñim
 = 0;

3302 
lq_cmd
->
ªdu˚d_çc
 = 0;

3304 i‡(
	`num_of_™t
(
™t
) == 1)

3305 
lq_cmd
->
sögÀ_°ªam_™t_msk
 = 
™t
;

3307 i‡(!
mvm
->
å™s
->
å™s_cfg
->
gí2
)

3308 
lq_cmd
->
agg_‰ame_˙t_limô
 = 
LINK_QUAL_AGG_FRAME_LIMIT_DEF
;

3310 
lq_cmd
->
agg_‰ame_˙t_limô
 =

3311 
LINK_QUAL_AGG_FRAME_LIMIT_GEN2_DEF
;

3312 
	}
}

3315 
	$rs_fûl_øãs_f‹_cﬁumn
(
iwl_mvm
 *
mvm
,

3316 
iwl_lq_°a
 *
lq_°a
,

3317 
rs_øã
 *
øã
,

3318 
__À32
 *
rs_èbÀ
, *
rs_èbÀ_ödex
,

3319 
num_øãs
, 
num_ªåõs
,

3320 
u8
 
vÆid_tx_™t
, 
boﬁ
 
toggÀ_™t
)

3322 
i
, 
j
;

3323 
__À32
 
ucode_øã
;

3324 
boﬁ
 
bŸtom_ªached
 = 
Ál£
;

3325 
¥ev_øã_idx
 = 
øã
->
ödex
;

3326 
íd
 = 
LINK_QUAL_MAX_RETRY_NUM
;

3327 
ödex
 = *
rs_èbÀ_ödex
;

3329 
i
 = 0; i < 
num_øãs
 && 
ödex
 < 
íd
; i++) {

3330 
j
 = 0; j < 
num_ªåõs
 && 
ödex
 < 
íd
; j++, index++) {

3331 
ucode_øã
 = 
	`˝u_to_À32
(
	`ucode_øã_‰om_rs_øã
(
mvm
,

3332 
øã
));

3333 
rs_èbÀ
[
ödex
] = 
ucode_øã
;

3334 i‡(
toggÀ_™t
)

3335 
	`rs_toggÀ_™ã¬a
(
vÆid_tx_™t
, 
øã
);

3338 
¥ev_øã_idx
 = 
øã
->
ödex
;

3339 
bŸtom_ªached
 = 
	`rs_gë_lowî_øã_ö_cﬁumn
(
lq_°a
, 
øã
);

3340 i‡(
bŸtom_ªached
 && !
	`is_Àgacy
(
øã
))

3344 i‡(!
bŸtom_ªached
 && !
	`is_Àgacy
(
øã
))

3345 
øã
->
ödex
 = 
¥ev_øã_idx
;

3347 *
rs_èbÀ_ödex
 = 
ödex
;

3348 
	}
}

3370 
	$rs_buûd_øãs_èbÀ
(
iwl_mvm
 *
mvm
,

3371 
õì80211_°a
 *
°a
,

3372 
iwl_lq_°a
 *
lq_°a
,

3373 c⁄° 
rs_øã
 *
öôül_øã
)

3375 
rs_øã
 
øã
;

3376 
num_øãs
, 
num_ªåõs
, 
ödex
 = 0;

3377 
u8
 
vÆid_tx_™t
 = 0;

3378 
iwl_lq_cmd
 *
lq_cmd
 = &
lq_°a
->
lq
;

3379 
boﬁ
 
toggÀ_™t
 = 
Ál£
;

3380 
u32
 
cﬁ‹
;

3382 
	`mem˝y
(&
øã
, 
öôül_øã
, (rate));

3384 
vÆid_tx_™t
 = 
	`iwl_mvm_gë_vÆid_tx_™t
(
mvm
);

3387 i‡(!
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_API_LQ_SS_PARAMS
) &&

3388 
	`rs_°bc_Ælow
(
mvm
, 
°a
, 
lq_°a
))

3389 
øã
.
°bc
 = 
åue
;

3391 i‡(
	`is_siso
(&
øã
)) {

3392 
num_øãs
 = 
IWL_MVM_RS_INITIAL_SISO_NUM_RATES
;

3393 
num_ªåõs
 = 
IWL_MVM_RS_HT_VHT_RETRIES_PER_RATE
;

3394 } i‡(
	`is_mimo
(&
øã
)) {

3395 
num_øãs
 = 
IWL_MVM_RS_INITIAL_MIMO_NUM_RATES
;

3396 
num_ªåõs
 = 
IWL_MVM_RS_HT_VHT_RETRIES_PER_RATE
;

3398 
num_øãs
 = 
IWL_MVM_RS_INITIAL_LEGACY_NUM_RATES
;

3399 
num_ªåõs
 = 
IWL_MVM_RS_INITIAL_LEGACY_RETRIES
;

3400 
toggÀ_™t
 = 
åue
;

3403 
	`rs_fûl_øãs_f‹_cﬁumn
(
mvm
, 
lq_°a
, &
øã
, 
lq_cmd
->
rs_èbÀ
, &
ödex
,

3404 
num_øãs
, 
num_ªåõs
, 
vÆid_tx_™t
,

3405 
toggÀ_™t
);

3407 
	`rs_gë_lowî_øã_down_cﬁumn
(
lq_°a
, &
øã
);

3409 i‡(
	`is_siso
(&
øã
)) {

3410 
num_øãs
 = 
IWL_MVM_RS_SECONDARY_SISO_NUM_RATES
;

3411 
num_ªåõs
 = 
IWL_MVM_RS_SECONDARY_SISO_RETRIES
;

3412 
lq_cmd
->
mimo_dñim
 = 
ödex
;

3413 } i‡(
	`is_Àgacy
(&
øã
)) {

3414 
num_øãs
 = 
IWL_MVM_RS_SECONDARY_LEGACY_NUM_RATES
;

3415 
num_ªåõs
 = 
IWL_MVM_RS_SECONDARY_LEGACY_RETRIES
;

3417 
	`WARN_ON_ONCE
(1);

3420 
toggÀ_™t
 = 
åue
;

3422 
	`rs_fûl_øãs_f‹_cﬁumn
(
mvm
, 
lq_°a
, &
øã
, 
lq_cmd
->
rs_èbÀ
, &
ödex
,

3423 
num_øãs
, 
num_ªåõs
, 
vÆid_tx_™t
,

3424 
toggÀ_™t
);

3426 
	`rs_gë_lowî_øã_down_cﬁumn
(
lq_°a
, &
øã
);

3428 
num_øãs
 = 
IWL_MVM_RS_SECONDARY_LEGACY_NUM_RATES
;

3429 
num_ªåõs
 = 
IWL_MVM_RS_SECONDARY_LEGACY_RETRIES
;

3431 
	`rs_fûl_øãs_f‹_cﬁumn
(
mvm
, 
lq_°a
, &
øã
, 
lq_cmd
->
rs_èbÀ
, &
ödex
,

3432 
num_øãs
, 
num_ªåõs
, 
vÆid_tx_™t
,

3433 
toggÀ_™t
);

3436 
cﬁ‹
 = 
	`LQ_FLAGS_COLOR_INC
(
	`LQ_FLAG_COLOR_GET
(
lq_cmd
->
Êags
));

3437 
lq_cmd
->
Êags
 = 
	`LQ_FLAG_COLOR_SET
÷q_cmd->Êags, 
cﬁ‹
);

3438 
	}
}

3440 
	srs_b„r_a˘ive_ôî_d©a
 {

3441 
õì80211_°a
 *
	mex˛ude_°a
;

3442 
iwl_mvm_°a
 *
	mb„r_mvm°a
;

3445 
	$rs_b„r_a˘ive_ôî
(*
_d©a
,

3446 
õì80211_°a
 *
°a
)

3448 
rs_b„r_a˘ive_ôî_d©a
 *
d©a
 = 
_d©a
;

3449 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

3450 
iwl_lq_cmd
 *
lq_cmd
 = &
mvm°a
->
deÊök
.
lq_°a
.
rs_drv
.
lq
;

3451 
u32
 
ss_∑øms
 = 
	`À32_to_˝u
(
lq_cmd
->ss_params);

3453 i‡(
°a
 =
d©a
->
ex˛ude_°a
)

3457 i‡(
ss_∑øms
 & 
LQ_SS_BFER_ALLOWED
) {

3458 
	`WARN_ON_ONCE
(
d©a
->
b„r_mvm°a
 !
NULL
);

3460 
d©a
->
b„r_mvm°a
 = 
mvm°a
;

3462 
	}
}

3464 
	$rs_b„r_¥i‹ôy
(
iwl_mvm_°a
 *
°a
)

3466 
¥io
 = -1;

3467 
∆80211_i·y≥
 
vi·y≥
 = 
	`õì80211_vif_ty≥_p2p
(
°a
->
vif
);

3469 
vi·y≥
) {

3470 
NL80211_IFTYPE_AP
:

3471 
NL80211_IFTYPE_P2P_GO
:

3472 
¥io
 = 3;

3474 
NL80211_IFTYPE_P2P_CLIENT
:

3475 
¥io
 = 2;

3477 
NL80211_IFTYPE_STATION
:

3478 
¥io
 = 1;

3481 
	`WARN_ONCE
(
åue
, "vi·y≥ %d sè_id %d", 
vi·y≥
,

3482 
°a
->
deÊök
.
°a_id
);

3483 
¥io
 = -1;

3486  
¥io
;

3487 
	}
}

3490 
	$rs_b„r_¥i‹ôy_cmp
(
iwl_mvm_°a
 *
°a1
,

3491 
iwl_mvm_°a
 *
°a2
)

3493 
¥io1
 = 
	`rs_b„r_¥i‹ôy
(
°a1
);

3494 
¥io2
 = 
	`rs_b„r_¥i‹ôy
(
°a2
);

3496 i‡(
¥io1
 > 
¥io2
)

3498 i‡(
¥io1
 < 
¥io2
)

3501 
	}
}

3503 
	$rs_£t_lq_ss_∑øms
(
iwl_mvm
 *
mvm
,

3504 
õì80211_°a
 *
°a
,

3505 
iwl_lq_°a
 *
lq_°a
,

3506 c⁄° 
rs_øã
 *
öôül_øã
)

3508 
iwl_lq_cmd
 *
lq_cmd
 = &
lq_°a
->
lq
;

3509 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

3510 
rs_b„r_a˘ive_ôî_d©a
 
d©a
 = {

3511 .
ex˛ude_°a
 = 
°a
,

3512 .
b„r_mvm°a
 = 
NULL
,

3514 
iwl_mvm_°a
 *
b„r_mvm°a
 = 
NULL
;

3515 
u32
 
ss_∑øms
 = 
LQ_SS_PARAMS_VALID
;

3517 i‡(!
	`iwl_mvm_bt_c€x_is_mimo_Ælowed
(
mvm
, 
°a
))

3518 
out
;

3520 #ifde‡
CONFIG_MAC80211_DEBUGFS


3524 i‡(
lq_°a
->
≥rs
.
ss_f‹˚
 =
RS_SS_FORCE_STBC
)

3525 
ss_∑øms
 |(
LQ_SS_STBC_1SS_ALLOWED
 | 
LQ_SS_FORCE
);

3526 i‡(
lq_°a
->
≥rs
.
ss_f‹˚
 =
RS_SS_FORCE_BFER
)

3527 
ss_∑øms
 |(
LQ_SS_BFER_ALLOWED
 | 
LQ_SS_FORCE
);

3529 i‡(
lq_°a
->
≥rs
.
ss_f‹˚
 !
RS_SS_FORCE_NONE
) {

3530 
	`IWL_DEBUG_RATE
(
mvm
, "Forcing single stream Tx decision %d\n",

3531 
lq_°a
->
≥rs
.
ss_f‹˚
);

3532 
out
;

3536 i‡(
lq_°a
->
°bc_ˇ∑bÀ
)

3537 
ss_∑øms
 |
LQ_SS_STBC_1SS_ALLOWED
;

3539 i‡(!
lq_°a
->
b„r_ˇ∑bÀ
)

3540 
out
;

3542 
	`õì80211_ôî©e_°©i⁄s_©omic
(
mvm
->
hw
,

3543 
rs_b„r_a˘ive_ôî
,

3544 &
d©a
);

3545 
b„r_mvm°a
 = 
d©a
.bfer_mvmsta;

3551 i‡(!
b„r_mvm°a
) {

3552 
	`IWL_DEBUG_RATE
(
mvm
, "No sta with BFERállowed found. Allow\n");

3554 
ss_∑øms
 |
LQ_SS_BFER_ALLOWED
;

3555 
out
;

3558 
	`IWL_DEBUG_RATE
(
mvm
, "FoundÉxisting sta %d with BFERáctivated\n",

3559 
b„r_mvm°a
->
deÊök
.
°a_id
);

3562 i‡(
	`rs_b„r_¥i‹ôy_cmp
(
mvm°a
, 
b„r_mvm°a
) > 0) {

3563 
iwl_lq_cmd
 *
b„r°a_lq_cmd
 =

3564 &
b„r_mvm°a
->
deÊök
.
lq_°a
.
rs_drv
.
lq
;

3565 
u32
 
b„r°a_ss_∑øms
 = 
	`À32_to_˝u
(
b„r°a_lq_cmd
->
ss_∑øms
);

3567 
b„r°a_ss_∑øms
 &~
LQ_SS_BFER_ALLOWED
;

3568 
b„r°a_lq_cmd
->
ss_∑øms
 = 
	`˝u_to_À32
(
b„r°a_ss_∑øms
);

3569 
	`iwl_mvm_£nd_lq_cmd
(
mvm
, 
b„r°a_lq_cmd
);

3571 
ss_∑øms
 |
LQ_SS_BFER_ALLOWED
;

3572 
	`IWL_DEBUG_RATE
(
mvm
,

3574 
b„r_mvm°a
->
deÊök
.
°a_id
);

3576 
out
:

3577 
lq_cmd
->
ss_∑øms
 = 
	`˝u_to_À32
(ss_params);

3578 
	}
}

3580 
	$rs_fûl_lq_cmd
(
iwl_mvm
 *
mvm
,

3581 
õì80211_°a
 *
°a
,

3582 
iwl_lq_°a
 *
lq_°a
,

3583 c⁄° 
rs_øã
 *
öôül_øã
)

3585 
iwl_lq_cmd
 *
lq_cmd
 = &
lq_°a
->
lq
;

3586 
iwl_mvm_°a
 *
mvm°a
;

3587 
iwl_mvm_vif
 *
mvmvif
;

3589 
lq_cmd
->
agg_dißbÀ_°¨t_th
 = 
IWL_MVM_RS_AGG_DISABLE_START
;

3590 
lq_cmd
->
agg_time_limô
 =

3591 
	`˝u_to_À16
(
IWL_MVM_RS_AGG_TIME_LIMIT
);

3593 #ifde‡
CONFIG_MAC80211_DEBUGFS


3594 i‡(
lq_°a
->
≥rs
.
dbg_fixed_øã
) {

3595 
	`rs_buûd_øãs_èbÀ_‰om_fixed
(
mvm
, 
lq_cmd
,

3596 
lq_°a
->
b™d
,

3597 
lq_°a
->
≥rs
.
dbg_fixed_øã
);

3601 i‡(
	`WARN_ON_ONCE
(!
°a
 || !
öôül_øã
))

3604 
	`rs_buûd_øãs_èbÀ
(
mvm
, 
°a
, 
lq_°a
, 
öôül_øã
);

3606 i‡(
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_API_LQ_SS_PARAMS
))

3607 
	`rs_£t_lq_ss_∑øms
(
mvm
, 
°a
, 
lq_°a
, 
öôül_øã
);

3609 
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

3610 
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
mvm°a
->
vif
);

3612 i‡(!
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_CAPA_COEX_SCHEMA_2
) &&

3613 
	`num_of_™t
(
öôül_øã
->
™t
) == 1)

3614 
lq_cmd
->
sögÀ_°ªam_™t_msk
 = 
öôül_øã
->
™t
;

3616 
lq_cmd
->
agg_‰ame_˙t_limô
 = 
lq_°a
->
≥rs
.
max_agg_bufsize
;

3623 i‡(
	`iwl_mvm_vif_low_œãncy
(
mvmvif
))

3624 
lq_cmd
->
agg_‰ame_˙t_limô
--;

3626 i‡(
mvm°a
->
vif
->
p2p
)

3627 
lq_cmd
->
Êags
 |
LQ_FLAG_USE_RTS_MSK
;

3629 
lq_cmd
->
agg_time_limô
 =

3630 
	`˝u_to_À16
(
	`iwl_mvm_c€x_agg_time_limô
(
mvm
, 
°a
));

3631 
	}
}

3633 *
	$rs_Æloc
(
õì80211_hw
 *
hw
)

3635  
hw
->
¥iv
;

3636 
	}
}

3639 
	$rs_‰ì
(*
mvm_øã
)

3642 
	}
}

3644 
	$rs_‰ì_°a
(*
mvm_r
, 
õì80211_°a
 *
°a
, *
mvm_°a
)

3646 
iwl_›_mode
 *
›_mode
 
__maybe_unu£d
 = 
mvm_r
;

3647 
iwl_mvm
 *
mvm
 
__maybe_unu£d
 = 
	`IWL_OP_MODE_GET_MVM
(
›_mode
);

3649 
	`IWL_DEBUG_RATE
(
mvm
, "enter\n");

3650 
	`IWL_DEBUG_RATE
(
mvm
, "leave\n");

3651 
	}
}

3653 
	$rs_¥ëty_¥öt_øã_v1
(*
buf
, 
bufsz
, c⁄° 
u32
 
øã
)

3656 *
ty≥
;

3657 
u8
 
mcs
 = 0, 
nss
 = 0;

3658 
u8
 
™t
 = (
øã
 & 
RATE_MCS_ANT_AB_MSK
Ë>> 
RATE_MCS_ANT_POS
;

3659 
u32
 
bw
 = (
øã
 & 
RATE_MCS_CHAN_WIDTH_MSK_V1
) >>

3660 
RATE_MCS_CHAN_WIDTH_POS
;

3662 i‡(!(
øã
 & 
RATE_MCS_HT_MSK_V1
) &&

3663 !(
øã
 & 
RATE_MCS_VHT_MSK_V1
) &&

3664 !(
øã
 & 
RATE_MCS_HE_MSK_V1
)) {

3665 
ödex
 = 
	`iwl_hwøã_to_∂˝_idx
(
øã
);

3667  
	`s˙¥ötf
(
buf
, 
bufsz
, "Legacy | ANT: %s Rate: %s Mbps",

3668 
	`iwl_rs_¥ëty_™t
(
™t
),

3669 
ödex
 =
IWL_RATE_INVALID
 ? "BAD" :

3670 
	`iwl_øã_mcs
(
ödex
)->
mbps
);

3673 i‡(
øã
 & 
RATE_MCS_VHT_MSK_V1
) {

3674 
ty≥
 = "VHT";

3675 
mcs
 = 
øã
 & 
RATE_VHT_MCS_RATE_CODE_MSK
;

3676 
nss
 = 
	`FIELD_GET
(
RATE_MCS_NSS_MSK
, 
øã
) + 1;

3677 } i‡(
øã
 & 
RATE_MCS_HT_MSK_V1
) {

3678 
ty≥
 = "HT";

3679 
mcs
 = 
øã
 & 
RATE_HT_MCS_INDEX_MSK_V1
;

3680 
nss
 = ((
øã
 & 
RATE_HT_MCS_NSS_MSK_V1
)

3681 >> 
RATE_HT_MCS_NSS_POS_V1
) + 1;

3682 } i‡(
øã
 & 
RATE_MCS_HE_MSK_V1
) {

3683 
ty≥
 = "HE";

3684 
mcs
 = 
øã
 & 
RATE_VHT_MCS_RATE_CODE_MSK
;

3685 
nss
 = 
	`FIELD_GET
(
RATE_MCS_NSS_MSK
, 
øã
) + 1;

3687 
ty≥
 = "Unknown";

3690  
	`s˙¥ötf
(
buf
, 
bufsz
,

3692 
øã
, 
ty≥
, 
	`iwl_rs_¥ëty_™t
(
™t
), 
	`iwl_rs_¥ëty_bw
(
bw
), 
mcs
, 
nss
,

3693 (
øã
 & 
RATE_MCS_SGI_MSK_V1
) ? "SGI " : "NGI ",

3694 (
øã
 & 
RATE_MCS_STBC_MSK
) ? "STBC " : "",

3695 (
øã
 & 
RATE_MCS_LDPC_MSK_V1
) ? "LDPC " : "",

3696 (
øã
 & 
RATE_HE_DUAL_CARRIER_MODE_MSK
) ? "DCM " : "",

3697 (
øã
 & 
RATE_MCS_BF_MSK
) ? "BF " : "");

3698 
	}
}

3700 #ifde‡
CONFIG_MAC80211_DEBUGFS


3707 
	$rs_¥ogøm_fix_øã
(
iwl_mvm
 *
mvm
,

3708 
iwl_lq_°a
 *
lq_°a
)

3710 
lq_°a
->
a˘ive_Àgacy_øã
 = 0x0FFF;

3711 
lq_°a
->
a˘ive_siso_øã
 = 0x1FD0;

3712 
lq_°a
->
a˘ive_mimo2_øã
 = 0x1FD0;

3714 
	`IWL_DEBUG_RATE
(
mvm
, "sta_id %dÑate 0x%X\n",

3715 
lq_°a
->
lq
.
°a_id
,Üq_°a->
≥rs
.
dbg_fixed_øã
);

3717 i‡(
lq_°a
->
≥rs
.
dbg_fixed_øã
) {

3718 
	`rs_fûl_lq_cmd
(
mvm
, 
NULL
, 
lq_°a
, NULL);

3719 
	`iwl_mvm_£nd_lq_cmd
(
lq_°a
->
≥rs
.
drv
, &lq_°a->
lq
);

3721 
	}
}

3723 
ssize_t
 
	$rs_°a_dbgfs_sˇÀ_èbÀ_wrôe
(
fûe
 *file,

3724 c⁄° 
__u£r
 *
u£r_buf
, 
size_t
 
cou¡
, 
loff_t
 *
µos
)

3726 
iwl_lq_°a
 *
lq_°a
 = 
fûe
->
¥iv©e_d©a
;

3727 
iwl_mvm
 *
mvm
;

3728 
buf
[64];

3729 
size_t
 
buf_size
;

3730 
u32
 
∑r£d_øã
;

3732 
mvm
 = 
lq_°a
->
≥rs
.
drv
;

3733 
	`mem£t
(
buf
, 0, (buf));

3734 
buf_size
 = 
	`mö
(
cou¡
, (
buf
) - 1);

3735 i‡(
	`c›y_‰om_u£r
(
buf
, 
u£r_buf
, 
buf_size
))

3736  -
EFAULT
;

3738 i‡(
	`ssˇnf
(
buf
, "%x", &
∑r£d_øã
) == 1)

3739 
lq_°a
->
≥rs
.
dbg_fixed_øã
 = 
∑r£d_øã
;

3741 
lq_°a
->
≥rs
.
dbg_fixed_øã
 = 0;

3743 
	`rs_¥ogøm_fix_øã
(
mvm
, 
lq_°a
);

3745  
cou¡
;

3746 
	}
}

3748 
ssize_t
 
	$rs_°a_dbgfs_sˇÀ_èbÀ_ªad
(
fûe
 *file,

3749 
__u£r
 *
u£r_buf
, 
size_t
 
cou¡
, 
loff_t
 *
µos
)

3751 *
buff
;

3752 
desc
 = 0;

3753 
i
 = 0;

3754 
ssize_t
 
ªt
;

3755 c⁄° 
size_t
 
bufsz
 = 2048;

3757 
iwl_lq_°a
 *
lq_°a
 = 
fûe
->
¥iv©e_d©a
;

3758 
iwl_mvm_°a
 *
mvm°a
 =

3759 
	`c⁄èöî_of
(
lq_°a
, 
iwl_mvm_°a
, 
deÊök
.lq_°a.
rs_drv
);

3760 
iwl_mvm
 *
mvm
;

3761 
iwl_sˇÀ_tbl_öfo
 *
tbl
 = &(
lq_°a
->
lq_öfo
[lq_°a->
a˘ive_tbl
]);

3762 
rs_øã
 *
øã
 = &
tbl
->rate;

3763 
u32
 
ss_∑øms
;

3765 
mvm
 = 
lq_°a
->
≥rs
.
drv
;

3766 
buff
 = 
	`kmÆloc
(
bufsz
, 
GFP_KERNEL
);

3767 i‡(!
buff
)

3768  -
ENOMEM
;

3770 
desc
 +
	`s˙¥ötf
(
buff
 + desc, 
bufsz
 - desc,

3771 "°a_id %d\n", 
lq_°a
->
lq
.
°a_id
);

3772 
desc
 +
	`s˙¥ötf
(
buff
 + desc, 
bufsz
 - desc,

3774 
lq_°a
->
tŸÆ_Áûed
,Üq_°a->
tŸÆ_suc˚ss
,

3775 
lq_°a
->
a˘ive_Àgacy_øã
);

3776 
desc
 +
	`s˙¥ötf
(
buff
 + desc, 
bufsz
 - desc, "fixedÑate 0x%X\n",

3777 
lq_°a
->
≥rs
.
dbg_fixed_øã
);

3778 
desc
 +
	`s˙¥ötf
(
buff
 + desc, 
bufsz
 - desc, "valid_tx_ant %s%s\n",

3779 (
	`iwl_mvm_gë_vÆid_tx_™t
(
mvm
Ë& 
ANT_A
) ? "ANT_A," : "",

3780 (
	`iwl_mvm_gë_vÆid_tx_™t
(
mvm
Ë& 
ANT_B
) ? "ANT_B," : "");

3781 
desc
 +
	`s˙¥ötf
(
buff
 + desc, 
bufsz
 - desc, "lqÅype %s\n",

3782 (
	`is_Àgacy
(
øã
)) ? "legacy" :

3783 
	`is_vht
(
øã
) ? "VHT" : "HT");

3784 i‡(!
	`is_Àgacy
(
øã
)) {

3785 
desc
 +
	`s˙¥ötf
(
buff
 + desc, 
bufsz
 - desc, " %s",

3786 (
	`is_siso
(
øã
)) ? "SISO" : "MIMO2");

3787 
desc
 +
	`s˙¥ötf
(
buff
 + desc, 
bufsz
 - desc, " %s",

3788 (
	`is_ht20
(
øã
)) ? "20MHz" :

3789 (
	`is_ht40
(
øã
)) ? "40MHz" :

3790 (
	`is_ht80
(
øã
)) ? "80MHz" :

3791 (
	`is_ht160
(
øã
)) ? "160MHz" : "BAD BW");

3792 
desc
 +
	`s˙¥ötf
(
buff
 + desc, 
bufsz
 - desc, " %s %s %s %s\n",

3793 (
øã
->
sgi
) ? "SGI" : "NGI",

3794 (
øã
->
ldpc
) ? "LDPC" : "BCC",

3795 (
lq_°a
->
is_agg
) ? "AGG on" : "",

3796 (
mvm°a
->
amsdu_íabÀd
) ? "AMSDU on" : "");

3798 
desc
 +
	`s˙¥ötf
(
buff
 + desc, 
bufsz
 - desc, "lastÅxÑate=0x%X\n",

3799 
lq_°a
->
œ°_øã_n_Êags
);

3800 
desc
 +
	`s˙¥ötf
(
buff
 + desc, 
bufsz
 - desc,

3802 
lq_°a
->
lq
.
Êags
,

3803 
lq_°a
->
lq
.
mimo_dñim
,

3804 
lq_°a
->
lq
.
sögÀ_°ªam_™t_msk
,

3805 
lq_°a
->
lq
.
duÆ_°ªam_™t_msk
);

3807 
desc
 +
	`s˙¥ötf
(
buff
 + desc, 
bufsz
 - desc,

3809 
	`À16_to_˝u
(
lq_°a
->
lq
.
agg_time_limô
),

3810 
lq_°a
->
lq
.
agg_dißbÀ_°¨t_th
,

3811 
lq_°a
->
lq
.
agg_‰ame_˙t_limô
);

3813 
desc
 +
	`s˙¥ötf
(
buff
 + desc, 
bufsz
 - desc, "reducedÅpc=%d\n",

3814 
lq_°a
->
lq
.
ªdu˚d_çc
);

3815 
ss_∑øms
 = 
	`À32_to_˝u
(
lq_°a
->
lq
.ss_params);

3816 
desc
 +
	`s˙¥ötf
(
buff
 + desc, 
bufsz
 - desc,

3818 (
ss_∑øms
 & 
LQ_SS_PARAMS_VALID
) ?

3820 (
ss_∑øms
 & 
LQ_SS_BFER_ALLOWED
) ?

3822 (
ss_∑øms
 & 
LQ_SS_STBC_1SS_ALLOWED
) ?

3824 (
ss_∑øms
 & 
LQ_SS_FORCE
) ?

3826 
desc
 +
	`s˙¥ötf
(
buff
 + desc, 
bufsz
 - desc,

3828 
lq_°a
->
lq
.
öôül_øã_ödex
[0],

3829 
lq_°a
->
lq
.
öôül_øã_ödex
[1],

3830 
lq_°a
->
lq
.
öôül_øã_ödex
[2],

3831 
lq_°a
->
lq
.
öôül_øã_ödex
[3]);

3833 
i
 = 0; i < 
LINK_QUAL_MAX_RETRY_NUM
; i++) {

3834 
u32
 
r
 = 
	`À32_to_˝u
(
lq_°a
->
lq
.
rs_èbÀ
[
i
]);

3836 
desc
 +
	`s˙¥ötf
(
buff
 + desc, 
bufsz
 - desc,

3837 "Ñ©e[%d] 0x%X ", 
i
, 
r
);

3838 
desc
 +
	`rs_¥ëty_¥öt_øã_v1
(
buff
 + desc, 
bufsz
 - desc, 
r
);

3839 i‡(
desc
 < 
bufsz
 - 1)

3840 
buff
[
desc
++] = '\n';

3843 
ªt
 = 
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buff
, 
desc
);

3844 
	`k‰ì
(
buff
);

3845  
ªt
;

3846 
	}
}

3848 c⁄° 
fûe_›î©i⁄s
 
	grs_°a_dbgfs_sˇÀ_èbÀ_›s
 = {

3849 .
wrôe
 = 
rs_°a_dbgfs_sˇÀ_èbÀ_wrôe
,

3850 .
	gªad
 = 
rs_°a_dbgfs_sˇÀ_èbÀ_ªad
,

3851 .
	g›í
 = 
sim∂e_›í
,

3852 .
	gŒ£ek
 = 
deÁu…_Œ£ek
,

3854 
ssize_t
 
	$rs_°a_dbgfs_°©s_èbÀ_ªad
(
fûe
 *file,

3855 
__u£r
 *
u£r_buf
, 
size_t
 
cou¡
, 
loff_t
 *
µos
)

3857 *
buff
;

3858 
desc
 = 0;

3859 
i
, 
j
;

3860 
ssize_t
 
ªt
;

3861 
iwl_sˇÀ_tbl_öfo
 *
tbl
;

3862 
rs_øã
 *
øã
;

3863 
iwl_lq_°a
 *
lq_°a
 = 
fûe
->
¥iv©e_d©a
;

3865 
buff
 = 
	`kmÆloc
(1024, 
GFP_KERNEL
);

3866 i‡(!
buff
)

3867  -
ENOMEM
;

3869 
i
 = 0; i < 
LQ_SIZE
; i++) {

3870 
tbl
 = &(
lq_°a
->
lq_öfo
[
i
]);

3871 
øã
 = &
tbl
->rate;

3872 
desc
 +
	`•rötf
(
buff
+desc,

3875 
lq_°a
->
a˘ive_tbl
 =
i
 ? "*" : "x",

3876 
øã
->
ty≥
,

3877 
øã
->
sgi
,

3878 
	`is_ht20
(
øã
) ? "20MHz" :

3879 
	`is_ht40
(
øã
) ? "40MHz" :

3880 
	`is_ht80
(
øã
) ? "80MHz" :

3881 
	`is_ht160
(
øã
) ? "160MHz" : "ERR",

3882 
øã
->
ödex
);

3883 
j
 = 0; j < 
IWL_RATE_COUNT
; j++) {

3884 
desc
 +
	`•rötf
(
buff
+desc,

3886 
tbl
->
wö
[
j
].
cou¡î
,

3887 
tbl
->
wö
[
j
].
suc˚ss_cou¡î
,

3888 
tbl
->
wö
[
j
].
suc˚ss_øtio
);

3891 
ªt
 = 
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buff
, 
desc
);

3892 
	`k‰ì
(
buff
);

3893  
ªt
;

3894 
	}
}

3896 c⁄° 
fûe_›î©i⁄s
 
	grs_°a_dbgfs_°©s_èbÀ_›s
 = {

3897 .
ªad
 = 
rs_°a_dbgfs_°©s_èbÀ_ªad
,

3898 .
	g›í
 = 
sim∂e_›í
,

3899 .
	gŒ£ek
 = 
deÁu…_Œ£ek
,

3902 
ssize_t
 
	$rs_°a_dbgfs_drv_tx_°©s_ªad
(
fûe
 *file,

3903 
__u£r
 *
u£r_buf
,

3904 
size_t
 
cou¡
, 
loff_t
 *
µos
)

3906 c⁄° * c⁄° 
cﬁumn_«me
[] = {

3907 [
RS_COLUMN_LEGACY_ANT_A
] = "LEGACY_ANT_A",

3908 [
RS_COLUMN_LEGACY_ANT_B
] = "LEGACY_ANT_B",

3909 [
RS_COLUMN_SISO_ANT_A
] = "SISO_ANT_A",

3910 [
RS_COLUMN_SISO_ANT_B
] = "SISO_ANT_B",

3911 [
RS_COLUMN_SISO_ANT_A_SGI
] = "SISO_ANT_A_SGI",

3912 [
RS_COLUMN_SISO_ANT_B_SGI
] = "SISO_ANT_B_SGI",

3913 [
RS_COLUMN_MIMO2
] = "MIMO2",

3914 [
RS_COLUMN_MIMO2_SGI
] = "MIMO2_SGI",

3917 c⁄° * c⁄° 
øã_«me
[] = {

3918 [
IWL_RATE_1M_INDEX
] = "1M",

3919 [
IWL_RATE_2M_INDEX
] = "2M",

3920 [
IWL_RATE_5M_INDEX
] = "5.5M",

3921 [
IWL_RATE_11M_INDEX
] = "11M",

3922 [
IWL_RATE_6M_INDEX
] = "6M|MCS0",

3923 [
IWL_RATE_9M_INDEX
] = "9M",

3924 [
IWL_RATE_12M_INDEX
] = "12M|MCS1",

3925 [
IWL_RATE_18M_INDEX
] = "18M|MCS2",

3926 [
IWL_RATE_24M_INDEX
] = "24M|MCS3",

3927 [
IWL_RATE_36M_INDEX
] = "36M|MCS4",

3928 [
IWL_RATE_48M_INDEX
] = "48M|MCS5",

3929 [
IWL_RATE_54M_INDEX
] = "54M|MCS6",

3930 [
IWL_RATE_MCS_7_INDEX
] = "MCS7",

3931 [
IWL_RATE_MCS_8_INDEX
] = "MCS8",

3932 [
IWL_RATE_MCS_9_INDEX
] = "MCS9",

3933 [
IWL_RATE_MCS_10_INDEX
] = "MCS10",

3934 [
IWL_RATE_MCS_11_INDEX
] = "MCS11",

3937 *
buff
, *
pos
, *
ídpos
;

3938 
cﬁ
, 
øã
;

3939 
ssize_t
 
ªt
;

3940 
iwl_lq_°a
 *
lq_°a
 = 
fûe
->
¥iv©e_d©a
;

3941 
rs_øã_°©s
 *
°©s
;

3942 c⁄° 
size_t
 
bufsz
 = 1024;

3944 
buff
 = 
	`kmÆloc
(
bufsz
, 
GFP_KERNEL
);

3945 i‡(!
buff
)

3946  -
ENOMEM
;

3948 
pos
 = 
buff
;

3949 
ídpos
 = 
pos
 + 
bufsz
;

3951 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "COLUMN,");

3952 
øã
 = 0;Ñ©ê< 
IWL_RATE_COUNT
;Ñate++)

3953 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "%s,", 
øã_«me
[
øã
]);

3954 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "\n");

3956 
cﬁ
 = 0; cﬁ < 
RS_COLUMN_COUNT
; col++) {

3957 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos,

3958 "%s,", 
cﬁumn_«me
[
cﬁ
]);

3960 
øã
 = 0;Ñ©ê< 
IWL_RATE_COUNT
;Ñate++) {

3961 
°©s
 = &(
lq_°a
->
≥rs
.
tx_°©s
[
cﬁ
][
øã
]);

3962 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos,

3964 
°©s
->
suc˚ss
,

3965 
°©s
->
tŸÆ
);

3967 
pos
 +
	`s˙¥ötf
’os, 
ídpos
 -Öos, "\n");

3970 
ªt
 = 
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buff
, 
pos
 - buff);

3971 
	`k‰ì
(
buff
);

3972  
ªt
;

3973 
	}
}

3975 
ssize_t
 
	$rs_°a_dbgfs_drv_tx_°©s_wrôe
(
fûe
 *file,

3976 c⁄° 
__u£r
 *
u£r_buf
,

3977 
size_t
 
cou¡
, 
loff_t
 *
µos
)

3979 
iwl_lq_°a
 *
lq_°a
 = 
fûe
->
¥iv©e_d©a
;

3980 
	`mem£t
(
lq_°a
->
≥rs
.
tx_°©s
, 0, (lq_sta->pers.tx_stats));

3982  
cou¡
;

3983 
	}
}

3985 c⁄° 
fûe_›î©i⁄s
 
	grs_°a_dbgfs_drv_tx_°©s_›s
 = {

3986 .
ªad
 = 
rs_°a_dbgfs_drv_tx_°©s_ªad
,

3987 .
	gwrôe
 = 
rs_°a_dbgfs_drv_tx_°©s_wrôe
,

3988 .
	g›í
 = 
sim∂e_›í
,

3989 .
	gŒ£ek
 = 
deÁu…_Œ£ek
,

3992 
ssize_t
 
	$iwl_dbgfs_ss_f‹˚_ªad
(
fûe
 *file,

3993 
__u£r
 *
u£r_buf
,

3994 
size_t
 
cou¡
, 
loff_t
 *
µos
)

3996 
iwl_lq_°a
 *
lq_°a
 = 
fûe
->
¥iv©e_d©a
;

3997 
buf
[12];

3998 
bufsz
 = (
buf
);

3999 
pos
 = 0;

4000 c⁄° * c⁄° 
ss_f‹˚_«me
[] = {

4001 [
RS_SS_FORCE_NONE
] = "none",

4002 [
RS_SS_FORCE_STBC
] = "stbc",

4003 [
RS_SS_FORCE_BFER
] = "bfer",

4004 [
RS_SS_FORCE_SISO
] = "siso",

4007 
pos
 +
	`s˙¥ötf
(
buf
+pos, 
bufsz
-pos, "%s\n",

4008 
ss_f‹˚_«me
[
lq_°a
->
≥rs
.
ss_f‹˚
]);

4009  
	`sim∂e_ªad_‰om_buf„r
(
u£r_buf
, 
cou¡
, 
µos
, 
buf
, 
pos
);

4010 
	}
}

4012 
ssize_t
 
	$iwl_dbgfs_ss_f‹˚_wrôe
(
iwl_lq_°a
 *
lq_°a
, *
buf
,

4013 
size_t
 
cou¡
, 
loff_t
 *
µos
)

4015 
iwl_mvm
 *
mvm
 = 
lq_°a
->
≥rs
.
drv
;

4016 
ªt
 = 0;

4018 i‡(!
	`°∫cmp
("n⁄e", 
buf
, 4)) {

4019 
lq_°a
->
≥rs
.
ss_f‹˚
 = 
RS_SS_FORCE_NONE
;

4020 } i‡(!
	`°∫cmp
("siso", 
buf
, 4)) {

4021 
lq_°a
->
≥rs
.
ss_f‹˚
 = 
RS_SS_FORCE_SISO
;

4022 } i‡(!
	`°∫cmp
("°bc", 
buf
, 4)) {

4023 i‡(
lq_°a
->
°bc_ˇ∑bÀ
) {

4024 
lq_°a
->
≥rs
.
ss_f‹˚
 = 
RS_SS_FORCE_STBC
;

4026 
	`IWL_ERR
(
mvm
,

4028 
ªt
 = -
EINVAL
;

4030 } i‡(!
	`°∫cmp
("b„r", 
buf
, 4)) {

4031 i‡(
lq_°a
->
b„r_ˇ∑bÀ
) {

4032 
lq_°a
->
≥rs
.
ss_f‹˚
 = 
RS_SS_FORCE_BFER
;

4034 
	`IWL_ERR
(
mvm
,

4036 
ªt
 = -
EINVAL
;

4039 
	`IWL_ERR
(
mvm
, "valid valuesÇone|siso|stbc|bfer\n");

4040 
ªt
 = -
EINVAL
;

4042  
ªt
 ?: 
cou¡
;

4043 
	}
}

4045 
	#MVM_DEBUGFS_READ_WRITE_FILE_OPS
(
«me
, 
bufsz
) \

4046 
	`_MVM_DEBUGFS_READ_WRITE_FILE_OPS
(
«me
, 
bufsz
, 
iwl_lq_°a
)

	)

4047 
	#MVM_DEBUGFS_ADD_FILE_RS
(
«me
, 
∑ª¡
, 
mode
) do { \

4048 
	`debugfs_¸óã_fûe
(#«me, 
mode
, 
∑ª¡
, 
lq_°a
, \

4049 &
iwl_dbgfs_
##
«me
##
_›s
); \

4050 } 0)

	)

4052 
MVM_DEBUGFS_READ_WRITE_FILE_OPS
(
ss_f‹˚
, 32);

4054 
	$rs_drv_add_°a_debugfs
(*
mvm
, *
¥iv_°a
,

4055 
díåy
 *
dú
)

4057 
iwl_lq_°a
 *
lq_°a
 = 
¥iv_°a
;

4058 
iwl_mvm_°a
 *
mvm°a
;

4060 
mvm°a
 = 
	`c⁄èöî_of
(
lq_°a
, 
iwl_mvm_°a
,

4061 
deÊök
.
lq_°a
.
rs_drv
);

4063 i‡(!
mvm°a
->
vif
)

4066 
	`debugfs_¸óã_fûe
("øã_sˇÀ_èbÀ", 0600, 
dú
,

4067 
lq_°a
, &
rs_°a_dbgfs_sˇÀ_èbÀ_›s
);

4068 
	`debugfs_¸óã_fûe
("øã_°©s_èbÀ", 0400, 
dú
,

4069 
lq_°a
, &
rs_°a_dbgfs_°©s_èbÀ_›s
);

4070 
	`debugfs_¸óã_fûe
("drv_tx_°©s", 0600, 
dú
,

4071 
lq_°a
, &
rs_°a_dbgfs_drv_tx_°©s_›s
);

4072 
	`debugfs_¸óã_u8
("tx_agg_tid_íabÀ", 0600, 
dú
,

4073 &
lq_°a
->
tx_agg_tid_í
);

4074 
	`debugfs_¸óã_u8
("ªdu˚d_çc", 0600, 
dú
,

4075 &
lq_°a
->
≥rs
.
dbg_fixed_txp_ªdu˘i⁄
);

4077 
	`MVM_DEBUGFS_ADD_FILE_RS
(
ss_f‹˚
, 
dú
, 0600);

4078 
	}
}

4086 
	$rs_øã_öô_›s
(*
mvm_r
,

4087 
õì80211_suµ‹ãd_b™d
 *
sb™d
,

4088 
cfg80211_ch™_def
 *
ch™def
,

4089 
õì80211_°a
 *
°a
, *
mvm_°a
)

4091 
	}
}

4094 c⁄° 
øã_c⁄åﬁ_›s
 
	grs_mvm_›s_drv
 = {

4095 .
«me
 = 
RS_NAME
,

4096 .
	gtx_°©us
 = 
rs_drv_mac80211_tx_°©us
,

4097 .
	ggë_øã
 = 
rs_drv_gë_øã
,

4098 .
	gøã_öô
 = 
rs_øã_öô_›s
,

4099 .
	gÆloc
 = 
rs_Æloc
,

4100 .
	g‰ì
 = 
rs_‰ì
,

4101 .
	gÆloc_°a
 = 
rs_drv_Æloc_°a
,

4102 .
	g‰ì_°a
 = 
rs_‰ì_°a
,

4103 .
	gøã_upd©e
 = 
rs_drv_øã_upd©e
,

4104 #ifde‡
CONFIG_MAC80211_DEBUGFS


4105 .
	gadd_°a_debugfs
 = 
rs_drv_add_°a_debugfs
,

4107 .
	gˇ∑
 = 
RATE_CTRL_CAPA_VHT_EXT_NSS_BW
,

4110 
	$iwl_mvm_rs_øã_öô
(
iwl_mvm
 *
mvm
,

4111 
õì80211_vif
 *
vif
,

4112 
õì80211_°a
 *
°a
,

4113 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

4114 
õì80211_lök_°a
 *
lök_°a
,

4115 
∆80211_b™d
 
b™d
)

4117 i‡(
	`iwl_mvm_has_éc_ofÊﬂd
(
mvm
)) {

4118 
	`iwl_mvm_rs_fw_øã_öô
(
mvm
, 
vif
, 
°a
, 
lök_c⁄f
,

4119 
lök_°a
, 
b™d
);

4121 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

4123 
	`•ö_lock_bh
(&
mvm°a
->
deÊök
.
lq_°a
.
rs_drv
.
≥rs
.
lock
);

4124 
	`rs_drv_øã_öô
(
mvm
, 
°a
, 
b™d
);

4125 
	`•ö_u∆ock_bh
(&
mvm°a
->
deÊök
.
lq_°a
.
rs_drv
.
≥rs
.
lock
);

4127 
	}
}

4129 
	$iwl_mvm_øã_c⁄åﬁ_ªgi°î
()

4131  
	`õì80211_øã_c⁄åﬁ_ªgi°î
(&
rs_mvm_›s_drv
);

4132 
	}
}

4134 
	$iwl_mvm_øã_c⁄åﬁ_uƒegi°î
()

4136 
	`õì80211_øã_c⁄åﬁ_uƒegi°î
(&
rs_mvm_›s_drv
);

4137 
	}
}

4139 
	$rs_drv_tx_¥Ÿe˘i⁄
(
iwl_mvm
 *
mvm
, 
iwl_mvm_°a
 *
mvm°a
,

4140 
boﬁ
 
íabÀ
)

4142 
iwl_lq_cmd
 *
lq
 = &
mvm°a
->
deÊök
.
lq_°a
.
rs_drv
.lq;

4144 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

4146 i‡(
íabÀ
) {

4147 i‡(
mvm°a
->
tx_¥Ÿe˘i⁄
 == 0)

4148 
lq
->
Êags
 |
LQ_FLAG_USE_RTS_MSK
;

4149 
mvm°a
->
tx_¥Ÿe˘i⁄
++;

4151 
mvm°a
->
tx_¥Ÿe˘i⁄
--;

4152 i‡(
mvm°a
->
tx_¥Ÿe˘i⁄
 == 0)

4153 
lq
->
Êags
 &~
LQ_FLAG_USE_RTS_MSK
;

4156  
	`iwl_mvm_£nd_lq_cmd
(
mvm
, 
lq
);

4157 
	}
}

4167 
	$iwl_mvm_tx_¥Ÿe˘i⁄
(
iwl_mvm
 *
mvm
, 
iwl_mvm_°a
 *
mvm°a
,

4168 
boﬁ
 
íabÀ
)

4170 i‡(
	`iwl_mvm_has_éc_ofÊﬂd
(
mvm
))

4171  
	`rs_fw_tx_¥Ÿe˘i⁄
(
mvm
, 
mvm°a
, 
íabÀ
);

4173  
	`rs_drv_tx_¥Ÿe˘i⁄
(
mvm
, 
mvm°a
, 
íabÀ
);

4174 
	}
}

	@rs.h

9 #i‚de‡
__rs_h__


10 
	#__rs_h__


	)

12 
	~<√t/mac80211.h
>

14 
	~"iwl-c⁄fig.h
"

16 
	~"fw-≠i.h
"

17 
	~"iwl-å™s.h
"

19 
	#RS_NAME
 "iwl-mvm-rs"

	)

21 
	siwl_rs_øã_öfo
 {

22 
u8
 
	m∂˝
;

23 
u8
 
	m∂˝_ht_siso
;

24 
u8
 
	m∂˝_ht_mimo2
;

25 
u8
 
	m∂˝_vht_siso
;

26 
u8
 
	m∂˝_vht_mimo2
;

27 
u8
 
	m¥ev_rs
;

28 
u8
 
	m√xt_rs
;

31 
	#IWL_RATE_60M_PLCP
 3

	)

33 
	#LINK_QUAL_MAX_RETRY_NUM
 16

	)

36 
	mIWL_RATE_6M_INDEX_TABLE
 = 0,

37 
	mIWL_RATE_9M_INDEX_TABLE
,

38 
	mIWL_RATE_12M_INDEX_TABLE
,

39 
	mIWL_RATE_18M_INDEX_TABLE
,

40 
	mIWL_RATE_24M_INDEX_TABLE
,

41 
	mIWL_RATE_36M_INDEX_TABLE
,

42 
	mIWL_RATE_48M_INDEX_TABLE
,

43 
	mIWL_RATE_54M_INDEX_TABLE
,

44 
	mIWL_RATE_1M_INDEX_TABLE
,

45 
	mIWL_RATE_2M_INDEX_TABLE
,

46 
	mIWL_RATE_5M_INDEX_TABLE
,

47 
	mIWL_RATE_11M_INDEX_TABLE
,

48 
	mIWL_RATE_INVM_INDEX_TABLE
 = 
IWL_RATE_INVM_INDEX
 - 1,

52 
	#IWL_RATE_6M_MASK
 (1 << 
IWL_RATE_6M_INDEX
)

	)

53 
	#IWL_RATE_9M_MASK
 (1 << 
IWL_RATE_9M_INDEX
)

	)

54 
	#IWL_RATE_12M_MASK
 (1 << 
IWL_RATE_12M_INDEX
)

	)

55 
	#IWL_RATE_18M_MASK
 (1 << 
IWL_RATE_18M_INDEX
)

	)

56 
	#IWL_RATE_24M_MASK
 (1 << 
IWL_RATE_24M_INDEX
)

	)

57 
	#IWL_RATE_36M_MASK
 (1 << 
IWL_RATE_36M_INDEX
)

	)

58 
	#IWL_RATE_48M_MASK
 (1 << 
IWL_RATE_48M_INDEX
)

	)

59 
	#IWL_RATE_54M_MASK
 (1 << 
IWL_RATE_54M_INDEX
)

	)

60 
	#IWL_RATE_60M_MASK
 (1 << 
IWL_RATE_60M_INDEX
)

	)

61 
	#IWL_RATE_1M_MASK
 (1 << 
IWL_RATE_1M_INDEX
)

	)

62 
	#IWL_RATE_2M_MASK
 (1 << 
IWL_RATE_2M_INDEX
)

	)

63 
	#IWL_RATE_5M_MASK
 (1 << 
IWL_RATE_5M_INDEX
)

	)

64 
	#IWL_RATE_11M_MASK
 (1 << 
IWL_RATE_11M_INDEX
)

	)

69 
	mIWL_RATE_HT_SISO_MCS_0_PLCP
 = 0,

70 
	mIWL_RATE_HT_SISO_MCS_1_PLCP
 = 1,

71 
	mIWL_RATE_HT_SISO_MCS_2_PLCP
 = 2,

72 
	mIWL_RATE_HT_SISO_MCS_3_PLCP
 = 3,

73 
	mIWL_RATE_HT_SISO_MCS_4_PLCP
 = 4,

74 
	mIWL_RATE_HT_SISO_MCS_5_PLCP
 = 5,

75 
	mIWL_RATE_HT_SISO_MCS_6_PLCP
 = 6,

76 
	mIWL_RATE_HT_SISO_MCS_7_PLCP
 = 7,

77 
	mIWL_RATE_HT_MIMO2_MCS_0_PLCP
 = 0x8,

78 
	mIWL_RATE_HT_MIMO2_MCS_1_PLCP
 = 0x9,

79 
	mIWL_RATE_HT_MIMO2_MCS_2_PLCP
 = 0xA,

80 
	mIWL_RATE_HT_MIMO2_MCS_3_PLCP
 = 0xB,

81 
	mIWL_RATE_HT_MIMO2_MCS_4_PLCP
 = 0xC,

82 
	mIWL_RATE_HT_MIMO2_MCS_5_PLCP
 = 0xD,

83 
	mIWL_RATE_HT_MIMO2_MCS_6_PLCP
 = 0xE,

84 
	mIWL_RATE_HT_MIMO2_MCS_7_PLCP
 = 0xF,

85 
	mIWL_RATE_VHT_SISO_MCS_0_PLCP
 = 0,

86 
	mIWL_RATE_VHT_SISO_MCS_1_PLCP
 = 1,

87 
	mIWL_RATE_VHT_SISO_MCS_2_PLCP
 = 2,

88 
	mIWL_RATE_VHT_SISO_MCS_3_PLCP
 = 3,

89 
	mIWL_RATE_VHT_SISO_MCS_4_PLCP
 = 4,

90 
	mIWL_RATE_VHT_SISO_MCS_5_PLCP
 = 5,

91 
	mIWL_RATE_VHT_SISO_MCS_6_PLCP
 = 6,

92 
	mIWL_RATE_VHT_SISO_MCS_7_PLCP
 = 7,

93 
	mIWL_RATE_VHT_SISO_MCS_8_PLCP
 = 8,

94 
	mIWL_RATE_VHT_SISO_MCS_9_PLCP
 = 9,

95 
	mIWL_RATE_VHT_MIMO2_MCS_0_PLCP
 = 0x10,

96 
	mIWL_RATE_VHT_MIMO2_MCS_1_PLCP
 = 0x11,

97 
	mIWL_RATE_VHT_MIMO2_MCS_2_PLCP
 = 0x12,

98 
	mIWL_RATE_VHT_MIMO2_MCS_3_PLCP
 = 0x13,

99 
	mIWL_RATE_VHT_MIMO2_MCS_4_PLCP
 = 0x14,

100 
	mIWL_RATE_VHT_MIMO2_MCS_5_PLCP
 = 0x15,

101 
	mIWL_RATE_VHT_MIMO2_MCS_6_PLCP
 = 0x16,

102 
	mIWL_RATE_VHT_MIMO2_MCS_7_PLCP
 = 0x17,

103 
	mIWL_RATE_VHT_MIMO2_MCS_8_PLCP
 = 0x18,

104 
	mIWL_RATE_VHT_MIMO2_MCS_9_PLCP
 = 0x19,

105 
	mIWL_RATE_HT_SISO_MCS_INV_PLCP
,

106 
	mIWL_RATE_HT_MIMO2_MCS_INV_PLCP
 = 
IWL_RATE_HT_SISO_MCS_INV_PLCP
,

107 
	mIWL_RATE_VHT_SISO_MCS_INV_PLCP
 = 
IWL_RATE_HT_SISO_MCS_INV_PLCP
,

108 
	mIWL_RATE_VHT_MIMO2_MCS_INV_PLCP
 = 
IWL_RATE_HT_SISO_MCS_INV_PLCP
,

109 
	mIWL_RATE_HT_SISO_MCS_8_PLCP
 = 
IWL_RATE_HT_SISO_MCS_INV_PLCP
,

110 
	mIWL_RATE_HT_SISO_MCS_9_PLCP
 = 
IWL_RATE_HT_SISO_MCS_INV_PLCP
,

111 
	mIWL_RATE_HT_MIMO2_MCS_8_PLCP
 = 
IWL_RATE_HT_SISO_MCS_INV_PLCP
,

112 
	mIWL_RATE_HT_MIMO2_MCS_9_PLCP
 = 
IWL_RATE_HT_SISO_MCS_INV_PLCP
,

115 
	#IWL_RATES_MASK
 ((1 << 
IWL_RATE_COUNT
Ë- 1)

	)

117 
	#IWL_INVALID_VALUE
 -1

	)

119 
	#TPC_MAX_REDUCTION
 15

	)

120 
	#TPC_NO_REDUCTION
 0

	)

121 
	#TPC_INVALID
 0xff

	)

123 
	#LINK_QUAL_AGG_FRAME_LIMIT_DEF
 (63)

	)

124 
	#LINK_QUAL_AGG_FRAME_LIMIT_MAX
 (63)

	)

130 
	#LINK_QUAL_AGG_FRAME_LIMIT_GEN2_DEF
 (255)

	)

131 
	#LINK_QUAL_AGG_FRAME_LIMIT_GEN2_MAX
 (255)

	)

132 
	#LINK_QUAL_AGG_FRAME_LIMIT_MIN
 (0)

	)

134 
	#LQ_SIZE
 2

	)

137 
	#IWL_AGG_TPT_THREHOLD
 0

	)

138 
	#IWL_AGG_ALL_TID
 0xff

	)

140 
	eiwl_èbÀ_ty≥
 {

141 
	mLQ_NONE
,

142 
	mLQ_LEGACY_G
,

143 
	mLQ_LEGACY_A
,

144 
	mLQ_HT_SISO
,

145 
	mLQ_HT_MIMO2
,

146 
	mLQ_VHT_SISO
,

147 
	mLQ_VHT_MIMO2
,

148 
	mLQ_HE_SISO
,

149 
	mLQ_HE_MIMO2
,

150 
	mLQ_MAX
,

153 
	srs_øã
 {

154 
	mödex
;

155 
iwl_èbÀ_ty≥
 
	mty≥
;

156 
u8
 
	m™t
;

157 
u32
 
	mbw
;

158 
boﬁ
 
	msgi
;

159 
boﬁ
 
	mldpc
;

160 
boﬁ
 
	m°bc
;

161 
boﬁ
 
	mb„r
;

165 
	#is_ty≥_Àgacy
(
ty≥
Ë((—y≥Ë=
LQ_LEGACY_G
) || \

166 ((
ty≥
Ë=
LQ_LEGACY_A
))

	)

167 
	#is_ty≥_ht_siso
(
ty≥
Ë(—y≥Ë=
LQ_HT_SISO
)

	)

168 
	#is_ty≥_ht_mimo2
(
ty≥
Ë(—y≥Ë=
LQ_HT_MIMO2
)

	)

169 
	#is_ty≥_vht_siso
(
ty≥
Ë(—y≥Ë=
LQ_VHT_SISO
)

	)

170 
	#is_ty≥_vht_mimo2
(
ty≥
Ë(—y≥Ë=
LQ_VHT_MIMO2
)

	)

171 
	#is_ty≥_he_siso
(
ty≥
Ë(—y≥Ë=
LQ_HE_SISO
)

	)

172 
	#is_ty≥_he_mimo2
(
ty≥
Ë(—y≥Ë=
LQ_HE_MIMO2
)

	)

173 
	#is_ty≥_siso
(
ty≥
Ë(
	`is_ty≥_ht_siso
—y≥Ë|| 
	`is_ty≥_vht_siso
(type) || \

174 
	`is_ty≥_he_siso
(
ty≥
))

	)

175 
	#is_ty≥_mimo2
(
ty≥
Ë(
	`is_ty≥_ht_mimo2
(type) || \

176 
	`is_ty≥_vht_mimo2
(
ty≥
Ë|| 
	`is_ty≥_he_mimo2
—y≥))

	)

177 
	#is_ty≥_mimo
(
ty≥
Ë(
	`is_ty≥_mimo2
—y≥))

	)

178 
	#is_ty≥_ht
(
ty≥
Ë(
	`is_ty≥_ht_siso
—y≥Ë|| 
	`is_ty≥_ht_mimo2
—y≥))

	)

179 
	#is_ty≥_vht
(
ty≥
Ë(
	`is_ty≥_vht_siso
—y≥Ë|| 
	`is_ty≥_vht_mimo2
—y≥))

	)

180 
	#is_ty≥_he
(
ty≥
Ë(
	`is_ty≥_he_siso
—y≥Ë|| 
	`is_ty≥_he_mimo2
—y≥))

	)

181 
	#is_ty≥_a_b™d
(
ty≥
Ë(—y≥Ë=
LQ_LEGACY_A
)

	)

182 
	#is_ty≥_g_b™d
(
ty≥
Ë(—y≥Ë=
LQ_LEGACY_G
)

	)

184 
	#is_Àgacy
(
øã
Ë
	`is_ty≥_Àgacy
(‘©e)->
ty≥
)

	)

185 
	#is_ht_siso
(
øã
Ë
	`is_ty≥_ht_siso
(‘©e)->
ty≥
)

	)

186 
	#is_ht_mimo2
(
øã
Ë
	`is_ty≥_ht_mimo2
(‘©e)->
ty≥
)

	)

187 
	#is_vht_siso
(
øã
Ë
	`is_ty≥_vht_siso
(‘©e)->
ty≥
)

	)

188 
	#is_vht_mimo2
(
øã
Ë
	`is_ty≥_vht_mimo2
(‘©e)->
ty≥
)

	)

189 
	#is_siso
(
øã
Ë
	`is_ty≥_siso
(‘©e)->
ty≥
)

	)

190 
	#is_mimo2
(
øã
Ë
	`is_ty≥_mimo2
(‘©e)->
ty≥
)

	)

191 
	#is_mimo
(
øã
Ë
	`is_ty≥_mimo
(‘©e)->
ty≥
)

	)

192 
	#is_ht
(
øã
Ë
	`is_ty≥_ht
(‘©e)->
ty≥
)

	)

193 
	#is_vht
(
øã
Ë
	`is_ty≥_vht
(‘©e)->
ty≥
)

	)

194 
	#is_he
(
øã
Ë
	`is_ty≥_he
(‘©e)->
ty≥
)

	)

195 
	#is_a_b™d
(
øã
Ë
	`is_ty≥_a_b™d
(‘©e)->
ty≥
)

	)

196 
	#is_g_b™d
(
øã
Ë
	`is_ty≥_g_b™d
(‘©e)->
ty≥
)

	)

198 
	#is_ht20
(
øã
Ë(‘©e)->
bw
 =
RATE_MCS_CHAN_WIDTH_20
)

	)

199 
	#is_ht40
(
øã
Ë(‘©e)->
bw
 =
RATE_MCS_CHAN_WIDTH_40
)

	)

200 
	#is_ht80
(
øã
Ë(‘©e)->
bw
 =
RATE_MCS_CHAN_WIDTH_80
)

	)

201 
	#is_ht160
(
øã
Ë(‘©e)->
bw
 =
RATE_MCS_CHAN_WIDTH_160
)

	)

212 
	siwl_lq_°a_rs_fw
 {

214 
u32
 
	mœ°_øã_n_Êags
;

217 
	slq_°a_≥rs_rs_fw
 {

218 
u32
 
	m°a_id
;

219 #ifde‡
CONFIG_MAC80211_DEBUGFS


223 
u32
 
	mdbg_fixed_øã
;

228 
u16
 
	mdbg_agg_‰ame_cou¡_lim
;

230 
u8
 
	mchaös
;

231 
s8
 
	mchaö_sig«l
[
IEEE80211_MAX_CHAINS
];

232 
s8
 
	mœ°_rssi
;

233 
iwl_mvm
 *
	mdrv
;

234 } 
	m≥rs
;

240 
	siwl_øã_sˇÀ_d©a
 {

241 
u64
 
	md©a
;

242 
s32
 
	msuc˚ss_cou¡î
;

243 
s32
 
	msuc˚ss_øtio
;

244 
s32
 
	mcou¡î
;

245 
s32
 
	mavîage_çt
;

251 
	ers_cﬁumn
 {

252 
	mRS_COLUMN_LEGACY_ANT_A
 = 0,

253 
	mRS_COLUMN_LEGACY_ANT_B
,

254 
	mRS_COLUMN_SISO_ANT_A
,

255 
	mRS_COLUMN_SISO_ANT_B
,

256 
	mRS_COLUMN_SISO_ANT_A_SGI
,

257 
	mRS_COLUMN_SISO_ANT_B_SGI
,

258 
	mRS_COLUMN_MIMO2
,

259 
	mRS_COLUMN_MIMO2_SGI
,

261 
	mRS_COLUMN_LAST
 = 
RS_COLUMN_MIMO2_SGI
,

262 
	mRS_COLUMN_COUNT
 = 
RS_COLUMN_LAST
 + 1,

263 
	mRS_COLUMN_INVALID
,

266 
	ers_ss_f‹˚_›t
 {

267 
	mRS_SS_FORCE_NONE
 = 0,

268 
	mRS_SS_FORCE_STBC
,

269 
	mRS_SS_FORCE_BFER
,

270 
	mRS_SS_FORCE_SISO
,

274 
	srs_øã_°©s
 {

275 
u64
 
	msuc˚ss
;

276 
u64
 
	mtŸÆ
;

285 
	siwl_sˇÀ_tbl_öfo
 {

286 
rs_øã
 
	møã
;

287 
rs_cﬁumn
 
	mcﬁumn
;

288 c⁄° 
u16
 *
	mex≥˘ed_çt
;

289 
iwl_øã_sˇÀ_d©a
 
	mwö
[
IWL_RATE_COUNT
];

291 
iwl_øã_sˇÀ_d©a
 
	mçc_wö
[
TPC_MAX_REDUCTION
 + 1];

295 
	mRS_STATE_SEARCH_CYCLE_STARTED
,

296 
	mRS_STATE_SEARCH_CYCLE_ENDED
,

297 
	mRS_STATE_STAY_IN_COLUMN
,

305 
	siwl_lq_°a
 {

306 
u8
 
	ma˘ive_tbl
;

307 
u8
 
	mrs_°©e
;

308 
u8
 
	m£¨ch_bëãr_tbl
;

309 
s32
 
	mœ°_çt
;

312 
u32
 
	mèbÀ_cou¡_limô
;

313 
u32
 
	mmax_Áûuª_limô
;

314 
u32
 
	mmax_suc˚ss_limô
;

315 
u32
 
	mèbÀ_cou¡
;

316 
u32
 
	mtŸÆ_Áûed
;

317 
u32
 
	mtŸÆ_suc˚ss
;

318 
u64
 
	mÊush_timî
;

320 
u32
 
	mvisôed_cﬁumns
;

323 
u64
 
	mœ°_tx
;

324 
boﬁ
 
	mis_vht
;

325 
boﬁ
 
	mldpc
;

326 
boﬁ
 
	m°bc_ˇ∑bÀ
;

327 
boﬁ
 
	mb„r_ˇ∑bÀ
;

329 
∆80211_b™d
 
	mb™d
;

332 
	ma˘ive_Àgacy_øã
;

333 
	ma˘ive_siso_øã
;

334 
	ma˘ive_mimo2_øã
;

337 
u8
 
	mmax_Àgacy_øã_idx
;

338 
u8
 
	mmax_siso_øã_idx
;

339 
u8
 
	mmax_mimo2_øã_idx
;

344 
rs_øã
 
	m›timÆ_øã
;

345 
	m›timÆ_øã_mask
;

346 c⁄° 
rs_öô_øã_öfo
 *
	m›timÆ_øãs
;

347 
	m›timÆ_√¡rõs
;

349 
u8
 
	mmis£d_øã_cou¡î
;

351 
iwl_lq_cmd
 
	mlq
;

352 
iwl_sˇÀ_tbl_öfo
 
	mlq_öfo
[
LQ_SIZE
];

353 
u8
 
	mtx_agg_tid_í
;

356 
u32
 
	mœ°_øã_n_Êags
;

359 
u8
 
	mis_agg
;

362 
	mçc_ªdu˚
;

365 
	slq_°a_≥rs
 {

366 #ifde‡
CONFIG_MAC80211_DEBUGFS


367 
u32
 
	mdbg_fixed_øã
;

368 
u8
 
	mdbg_fixed_txp_ªdu˘i⁄
;

371 
rs_ss_f‹˚_›t
 
	mss_f‹˚
;

373 
u8
 
	mchaös
;

374 
s8
 
	mchaö_sig«l
[
IEEE80211_MAX_CHAINS
];

375 
s8
 
	mœ°_rssi
;

376 
u16
 
	mmax_agg_bufsize
;

377 
rs_øã_°©s
 
	mtx_°©s
[
RS_COLUMN_COUNT
][
IWL_RATE_COUNT
];

378 
iwl_mvm
 *
	mdrv
;

379 
•ölock_t
 
	mlock
;

380 } 
	m≥rs
;

388 
	#RS_DRV_DATA_TXP_MSK
 0xff

	)

389 
	#RS_DRV_DATA_LQ_COLOR_POS
 8

	)

390 
	#RS_DRV_DATA_LQ_COLOR_MSK
 (7 << 
RS_DRV_DATA_LQ_COLOR_POS
)

	)

391 
	#RS_DRV_DATA_LQ_COLOR_GET
(
_f
Ë(((_fË& 
RS_DRV_DATA_LQ_COLOR_MSK
) >>\

392 
RS_DRV_DATA_LQ_COLOR_POS
)

	)

393 
	#RS_DRV_DATA_PACK
(
_c
, 
_p
Ë((*)(
uöçå_t
)\

394 (((
uöçå_t
)
_p
) |\

395 ((
_c
Ë<< 
RS_DRV_DATA_LQ_COLOR_POS
)))

	)

398 
iwl_mvm_rs_øã_öô
(
iwl_mvm
 *
mvm
,

399 
õì80211_vif
 *
vif
,

400 
õì80211_°a
 *
°a
,

401 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

402 
õì80211_lök_°a
 *
lök_°a
,

403 
∆80211_b™d
 
b™d
);

406 
iwl_mvm_rs_tx_°©us
(
iwl_mvm
 *
mvm
, 
õì80211_°a
 *
°a
,

407 
tid
, 
õì80211_tx_öfo
 *
öfo
, 
boﬁ
 
ndp
);

419 
iwl_mvm_øã_c⁄åﬁ_ªgi°î
();

427 
iwl_mvm_øã_c⁄åﬁ_uƒegi°î
();

429 
	giwl_mvm_°a
;

431 
iwl_mvm_tx_¥Ÿe˘i⁄
(
iwl_mvm
 *
mvm
, 
iwl_mvm_°a
 *
mvm°a
,

432 
boﬁ
 
íabÀ
);

434 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


435 
iwl_mvm_ª£t_‰ame_°©s
(
iwl_mvm
 *
mvm
);

438 
	giwl_mvm_lök_°a
;

440 
iwl_mvm_rs_add_°a
(
iwl_mvm
 *
mvm
, 
iwl_mvm_°a
 *
mvm°a
);

441 
iwl_mvm_rs_add_°a_lök
(
iwl_mvm
 *
mvm
,

442 
iwl_mvm_lök_°a
 *
lök_°a
);

444 
iwl_mvm_rs_fw_øã_öô
(
iwl_mvm
 *
mvm
,

445 
õì80211_vif
 *
vif
,

446 
õì80211_°a
 *
°a
,

447 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

448 
õì80211_lök_°a
 *
lök_°a
,

449 
∆80211_b™d
 
b™d
);

450 
rs_fw_tx_¥Ÿe˘i⁄
(
iwl_mvm
 *
mvm
, 
iwl_mvm_°a
 *
mvm°a
,

451 
boﬁ
 
íabÀ
);

452 
iwl_mvm_éc_upd©e_nŸif
(
iwl_mvm
 *
mvm
,

453 
iwl_rx_cmd_buf„r
 *
rxb
);

455 
u16
 
rs_fw_gë_max_amsdu_Àn
(
õì80211_°a
 *
°a
,

456 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

457 
õì80211_lök_°a
 *
lök_°a
);

	@rx.c

7 
	~<asm/u«lig√d.h
>

8 
	~<löux/ëhîdevi˚.h
>

9 
	~<löux/skbuff.h
>

10 
	~"iwl-å™s.h
"

11 
	~"mvm.h
"

12 
	~"fw-≠i.h
"

20 
	$iwl_mvm_rx_rx_phy_cmd
(
iwl_mvm
 *
mvm
, 
iwl_rx_cmd_buf„r
 *
rxb
)

22 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

23 
pkt_Àn
 = 
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
);

25 i‡(
	`u∆ikñy
(
pkt_Àn
 < (
mvm
->
œ°_phy_öfo
)))

28 
	`mem˝y
(&
mvm
->
œ°_phy_öfo
, 
pkt
->
d©a
, (mvm->last_phy_info));

29 
mvm
->
ampdu_ªf
++;

31 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


32 i‡(
mvm
->
œ°_phy_öfo
.
phy_Êags
 & 
	`˝u_to_À16
(
RX_RES_PHY_FLAGS_AGG
)) {

33 
	`•ö_lock
(&
mvm
->
drv_°©s_lock
);

34 
mvm
->
drv_rx_°©s
.
ampdu_cou¡
++;

35 
	`•ö_u∆ock
(&
mvm
->
drv_°©s_lock
);

38 
	}
}

45 
	$iwl_mvm_∑ss_∑ckë_to_mac80211
(
iwl_mvm
 *
mvm
,

46 
õì80211_°a
 *
°a
,

47 
«pi_°ru˘
 *
«pi
,

48 
sk_buff
 *
skb
,

49 
õì80211_hdr
 *
hdr
, 
u16
 
Àn
,

50 
u8
 
¸y±_Àn
,

51 
iwl_rx_cmd_buf„r
 *
rxb
)

53 
hdæí
 = 
	`õì80211_hdæí
(
hdr
->
‰ame_c⁄åﬁ
);

54 
‰agÀn
;

66 
	`skb_ª£rve
(
skb
, 
hdæí
 & 3);

80 
hdæí
 = (
Àn
 <
	`skb_èûroom
(
skb
)Ë?Üí : hdæí + 
¸y±_Àn
 + 8;

82 
	`skb_put_d©a
(
skb
, 
hdr
, 
hdæí
);

83 
‰agÀn
 = 
Àn
 - 
hdæí
;

85 i‡(
‰agÀn
) {

86 
off£t
 = (
u8
 *)
hdr
 + 
hdæí
 -

87 (
u8
 *)
	`rxb_addr
(
rxb
Ë+ 
	`rxb_off£t
(rxb);

89 
	`skb_add_rx_‰ag
(
skb
, 0, 
	`rxb_°ól_∑ge
(
rxb
), 
off£t
,

90 
‰agÀn
, 
rxb
->
åuesize
);

93 
	`õì80211_rx_«pi
(
mvm
->
hw
, 
°a
, 
skb
, 
«pi
);

94 
	}
}

102 
	$iwl_mvm_gë_sig«l_°ªngth
(
iwl_mvm
 *
mvm
,

103 
iwl_rx_phy_öfo
 *
phy_öfo
,

104 
õì80211_rx_°©us
 *
rx_°©us
)

106 
íîgy_a
, 
íîgy_b
, 
max_íîgy
;

107 
u32
 
vÆ
;

109 
vÆ
 =

110 
	`À32_to_˝u
(
phy_öfo
->
n⁄_cfg_phy
[
IWL_RX_INFO_ENERGY_ANT_ABC_IDX
]);

111 
íîgy_a
 = (
vÆ
 & 
IWL_RX_INFO_ENERGY_ANT_A_MSK
) >>

112 
IWL_RX_INFO_ENERGY_ANT_A_POS
;

113 
íîgy_a
 =É√rgy_®? -íîgy_®: 
S8_MIN
;

114 
íîgy_b
 = (
vÆ
 & 
IWL_RX_INFO_ENERGY_ANT_B_MSK
) >>

115 
IWL_RX_INFO_ENERGY_ANT_B_POS
;

116 
íîgy_b
 =É√rgy_b ? -íîgy_b : 
S8_MIN
;

117 
max_íîgy
 = 
	`max
(
íîgy_a
, 
íîgy_b
);

119 
	`IWL_DEBUG_STATS
(
mvm
, "energy In A %d B %d ,ánd max %d\n",

120 
íîgy_a
, 
íîgy_b
, 
max_íîgy
);

122 
rx_°©us
->
sig«l
 = 
max_íîgy
;

123 
rx_°©us
->
chaös
 = (
	`À16_to_˝u
(
phy_öfo
->
phy_Êags
) &

124 
RX_RES_PHY_FLAGS_ANTENNA
)

125 >> 
RX_RES_PHY_FLAGS_ANTENNA_POS
;

126 
rx_°©us
->
chaö_sig«l
[0] = 
íîgy_a
;

127 
rx_°©us
->
chaö_sig«l
[1] = 
íîgy_b
;

128 
	}
}

139 
u32
 
	$iwl_mvm_£t_mac80211_rx_Êag
(
iwl_mvm
 *
mvm
,

140 
õì80211_hdr
 *
hdr
,

141 
õì80211_rx_°©us
 *
°©s
,

142 
u32
 
rx_pkt_°©us
,

143 
u8
 *
¸y±_Àn
)

145 i‡(!
	`õì80211_has_¥Ÿe˘ed
(
hdr
->
‰ame_c⁄åﬁ
) ||

146 (
rx_pkt_°©us
 & 
RX_MPDU_RES_STATUS_SEC_ENC_MSK
) ==

147 
RX_MPDU_RES_STATUS_SEC_NO_ENC
)

151 i‡((
rx_pkt_°©us
 & 
RX_MPDU_RES_STATUS_SEC_ENC_MSK
) ==

152 
RX_MPDU_RES_STATUS_SEC_ENC_ERR
)

155 
rx_pkt_°©us
 & 
RX_MPDU_RES_STATUS_SEC_ENC_MSK
) {

156 
RX_MPDU_RES_STATUS_SEC_CCM_ENC
:

158 i‡(!(
rx_pkt_°©us
 & 
RX_MPDU_RES_STATUS_MIC_OK
))

161 
°©s
->
Êag
 |
RX_FLAG_DECRYPTED
;

162 *
¸y±_Àn
 = 
IEEE80211_CCMP_HDR_LEN
;

165 
RX_MPDU_RES_STATUS_SEC_TKIP_ENC
:

167 i‡(!
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

168 
IWL_UCODE_TLV_API_DEPRECATE_TTAK
) &&

169 !(
rx_pkt_°©us
 & 
RX_MPDU_RES_STATUS_TTAK_OK
))

171 *
¸y±_Àn
 = 
IEEE80211_TKIP_IV_LEN
;

172 
ÁŒthrough
;

174 
RX_MPDU_RES_STATUS_SEC_WEP_ENC
:

175 i‡(!(
rx_pkt_°©us
 & 
RX_MPDU_RES_STATUS_ICV_OK
))

178 
°©s
->
Êag
 |
RX_FLAG_DECRYPTED
;

179 i‡((
rx_pkt_°©us
 & 
RX_MPDU_RES_STATUS_SEC_ENC_MSK
) ==

180 
RX_MPDU_RES_STATUS_SEC_WEP_ENC
)

181 *
¸y±_Àn
 = 
IEEE80211_WEP_IV_LEN
;

184 
RX_MPDU_RES_STATUS_SEC_EXT_ENC
:

185 i‡(!(
rx_pkt_°©us
 & 
RX_MPDU_RES_STATUS_MIC_OK
))

187 
°©s
->
Êag
 |
RX_FLAG_DECRYPTED
;

192 i‡(!
mvm
->
m⁄ô‹_⁄
)

193 
	`IWL_WARN
(
mvm
, "Unh™dÀdálg: 0x%x\n", 
rx_pkt_°©us
);

197 
	}
}

199 
	$iwl_mvm_rx_h™dÀ_tcm
(
iwl_mvm
 *
mvm
,

200 
õì80211_°a
 *
°a
,

201 
õì80211_hdr
 *
hdr
, 
u32
 
Àn
,

202 
iwl_rx_phy_öfo
 *
phy_öfo
,

203 
u32
 
øã_n_Êags
)

205 
iwl_mvm_°a
 *
mvm°a
;

206 
iwl_mvm_tcm_mac
 *
md©a
;

207 
mac
;

208 
ac
 = 
IEEE80211_AC_BE
;

209 
iwl_mvm_vif
 *
mvmvif
;

211 c⁄° 
u8
 
thªsh_çt
[] = {

214 
u16
 
thr
;

216 i‡(
	`õì80211_is_d©a_qos
(
hdr
->
‰ame_c⁄åﬁ
)) {

217 
u8
 
tid
 = 
	`õì80211_gë_tid
(
hdr
);

219 i‡(
tid
 < 
IWL_MAX_TID_COUNT
)

220 
ac
 = 
tid_to_mac80211_ac
[
tid
];

223 
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

224 
mac
 = 
mvm°a
->
mac_id_n_cﬁ‹
 & 
FW_CTXT_ID_MSK
;

226 i‡(
	`time_a·î
(
jiffõs
, 
mvm
->
tcm
.
ts
 + 
MVM_TCM_PERIOD
))

227 
	`scheduÀ_dñayed_w‹k
(&
mvm
->
tcm
.
w‹k
, 0);

228 
md©a
 = &
mvm
->
tcm
.
d©a
[
mac
];

229 
md©a
->
rx
.
pkts
[
ac
]++;

232 i‡(
md©a
->
rx
.
œ°_ampdu_ªf
 !
mvm
->
ampdu_ªf
) {

233 
md©a
->
rx
.
œ°_ampdu_ªf
 = 
mvm
->
ampdu_ªf
;

234 
md©a
->
rx
.
aútime
 +
	`À16_to_˝u
(
phy_öfo
->
‰ame_time
);

237 i‡(!(
øã_n_Êags
 & (
RATE_MCS_HT_MSK_V1
 | 
RATE_MCS_VHT_MSK_V1
)))

240 
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
mvm°a
->
vif
);

242 i‡(
md©a
->
›íed_rx_ba_£ssi⁄s
 ||

243 
md©a
->
u≠sd_n⁄agg_dëe˘
.
dëe˘ed
 ||

244 (!
mvmvif
->
deÊök
.
queue_∑øms
[
IEEE80211_AC_VO
].
u≠sd
 &&

245 !
mvmvif
->
deÊök
.
queue_∑øms
[
IEEE80211_AC_VI
].
u≠sd
 &&

246 !
mvmvif
->
deÊök
.
queue_∑øms
[
IEEE80211_AC_BE
].
u≠sd
 &&

247 !
mvmvif
->
deÊök
.
queue_∑øms
[
IEEE80211_AC_BK
].
u≠sd
) ||

248 
mvm°a
->
deÊök
.
°a_id
 !
mvmvif
->deÊök.
≠_°a_id
)

251 i‡(
øã_n_Êags
 & 
RATE_MCS_HT_MSK_V1
) {

252 
thr
 = 
thªsh_çt
[
øã_n_Êags
 & 
RATE_HT_MCS_RATE_CODE_MSK_V1
];

253 
thr
 *1 + ((
øã_n_Êags
 & 
RATE_HT_MCS_NSS_MSK_V1
) >>

254 
RATE_HT_MCS_NSS_POS_V1
);

256 i‡(
	`WARN_ON
((
øã_n_Êags
 & 
RATE_VHT_MCS_RATE_CODE_MSK
) >=

257 
	`ARRAY_SIZE
(
thªsh_çt
)))

259 
thr
 = 
thªsh_çt
[
øã_n_Êags
 & 
RATE_VHT_MCS_RATE_CODE_MSK
];

260 
thr
 *1 + 
	`FIELD_GET
(
RATE_MCS_NSS_MSK
, 
øã_n_Êags
);

263 
thr
 <<((
øã_n_Êags
 & 
RATE_MCS_CHAN_WIDTH_MSK_V1
) >>

264 
RATE_MCS_CHAN_WIDTH_POS
);

266 
md©a
->
u≠sd_n⁄agg_dëe˘
.
rx_byãs
 +
Àn
;

267 
	`ewma_øã_add
(&
md©a
->
u≠sd_n⁄agg_dëe˘
.
øã
, 
thr
);

268 
	}
}

270 
	$iwl_mvm_rx_csum
(
õì80211_°a
 *
°a
,

271 
sk_buff
 *
skb
,

272 
u32
 
°©us
)

274 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

275 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
mvm°a
->
vif
);

277 i‡(
mvmvif
->
„©uªs
 & 
NETIF_F_RXCSUM
 &&

278 
°©us
 & 
RX_MPDU_RES_STATUS_CSUM_DONE
 &&

279 
°©us
 & 
RX_MPDU_RES_STATUS_CSUM_OK
)

280 
skb
->
ù_summed
 = 
CHECKSUM_UNNECESSARY
;

281 
	}
}

288 
	$iwl_mvm_rx_rx_mpdu
(
iwl_mvm
 *
mvm
, 
«pi_°ru˘
 *
«pi
,

289 
iwl_rx_cmd_buf„r
 *
rxb
)

291 
õì80211_hdr
 *
hdr
;

292 
õì80211_rx_°©us
 *
rx_°©us
;

293 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

294 
iwl_rx_phy_öfo
 *
phy_öfo
;

295 
iwl_rx_mpdu_ªs_°¨t
 *
rx_ªs
;

296 
õì80211_°a
 *
°a
 = 
NULL
;

297 
sk_buff
 *
skb
;

298 
u32
 
Àn
, 
pkt_Àn
 = 
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
);

299 
u32
 
øã_n_Êags
;

300 
u32
 
rx_pkt_°©us
;

301 
u8
 
¸y±_Àn
 = 0;

303 i‡(
	`u∆ikñy
(
pkt_Àn
 < (*
rx_ªs
))) {

304 
	`IWL_DEBUG_DROP
(
mvm
, "Bad REPLY_RX_MPDU_CMD size\n");

308 
phy_öfo
 = &
mvm
->
œ°_phy_öfo
;

309 
rx_ªs
 = (
iwl_rx_mpdu_ªs_°¨t
 *)
pkt
->
d©a
;

310 
hdr
 = (
õì80211_hdr
 *)(
pkt
->
d©a
 + (*
rx_ªs
));

311 
Àn
 = 
	`À16_to_˝u
(
rx_ªs
->
byã_cou¡
);

313 i‡(
	`u∆ikñy
(
Àn
 + (*
rx_ªs
Ë+ (
__À32
Ë> 
pkt_Àn
)) {

314 
	`IWL_DEBUG_DROP
(
mvm
, "FWÜiedáboutÖacketÜen\n");

318 
rx_pkt_°©us
 = 
	`gë_u«lig√d_À32
((
__À32
 *)

319 (
pkt
->
d©a
 + (*
rx_ªs
Ë+ 
Àn
));

324 
skb
 = 
	`Æloc_skb
(128, 
GFP_ATOMIC
);

325 i‡(!
skb
) {

326 
	`IWL_ERR
(
mvm
, "alloc_skb failed\n");

330 
rx_°©us
 = 
	`IEEE80211_SKB_RXCB
(
skb
);

336 i‡(!(
rx_pkt_°©us
 & 
RX_MPDU_RES_STATUS_CRC_OK
) ||

337 !(
rx_pkt_°©us
 & 
RX_MPDU_RES_STATUS_OVERRUN_OK
)) {

338 
	`IWL_DEBUG_RX
(
mvm
, "Bad CRC o∏FIFO: 0x%08X.\n", 
rx_pkt_°©us
);

339 
rx_°©us
->
Êag
 |
RX_FLAG_FAILED_FCS_CRC
;

343 
øã_n_Êags
 = 
	`À32_to_˝u
(
phy_öfo
->rate_n_flags);

346 
rx_°©us
->
ma˘ime
 = 
	`À64_to_˝u
(
phy_öfo
->
time°amp
);

347 
rx_°©us
->
devi˚_time°amp
 = 
	`À32_to_˝u
(
phy_öfo
->
sy°em_time°amp
);

348 
rx_°©us
->
b™d
 =

349 (
phy_öfo
->
phy_Êags
 & 
	`˝u_to_À16
(
RX_RES_PHY_FLAGS_BAND_24
)) ?

350 
NL80211_BAND_2GHZ
 : 
NL80211_BAND_5GHZ
;

351 
rx_°©us
->
‰eq
 =

352 
	`õì80211_ch™√l_to_‰equícy
(
	`À16_to_˝u
(
phy_öfo
->
ch™√l
),

353 
rx_°©us
->
b™d
);

356 
rx_°©us
->
Êag
 |
RX_FLAG_MACTIME_PLCP_START
;

358 
	`iwl_mvm_gë_sig«l_°ªngth
(
mvm
, 
phy_öfo
, 
rx_°©us
);

360 
	`IWL_DEBUG_STATS_LIMIT
(
mvm
, "Rssò%d, TSF %Œu\n", 
rx_°©us
->
sig«l
,

361 ()
rx_°©us
->
ma˘ime
);

363 
	`rcu_ªad_lock
();

364 i‡(
rx_pkt_°©us
 & 
RX_MPDU_RES_STATUS_SRC_STA_FOUND
) {

365 
u32
 
id
 = 
rx_pkt_°©us
 & 
RX_MPDU_RES_STATUS_STA_ID_MSK
;

367 
id
 >>
RX_MDPU_RES_STATUS_STA_ID_SHIFT
;

369 i‡(!
	`WARN_ON_ONCE
(
id
 >
mvm
->
fw
->
ucode_ˇ∑
.
num_°©i⁄s
)) {

370 
°a
 = 
	`rcu_dîe„ªn˚
(
mvm
->
fw_id_to_mac_id
[
id
]);

371 i‡(
	`IS_ERR
(
°a
))

372 
°a
 = 
NULL
;

374 } i‡(!
	`is_mu…iˇ°_ëhî_addr
(
hdr
->
addr2
)) {

378 
°a
 = 
	`õì80211_föd_°a_by_iÁddr
(
mvm
->
hw
, 
hdr
->
addr2
, 
NULL
);

381 i‡(
°a
) {

382 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

383 
õì80211_vif
 *
vif
 = 
mvm°a
->vif;

384 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

390 i‡(
	`is_mu…iˇ°_ëhî_addr
(
hdr
->
addr1
) &&

391 
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
 &&

392 !
mvmvif
->
auth‹ized
 &&

393 
	`õì80211_has_¥Ÿe˘ed
(
hdr
->
‰ame_c⁄åﬁ
)) {

394 
	`IWL_DEBUG_DROP
(
mvm
, "MCAST beforeÅhe vif isáuthorized\n");

395 
	`k‰ì_skb
(
skb
);

396 
	`rcu_ªad_u∆ock
();

404 i‡(
	`iwl_mvm_£t_mac80211_rx_Êag
(
mvm
, 
hdr
, 
rx_°©us
, 
rx_pkt_°©us
,

405 &
¸y±_Àn
)) {

406 
	`IWL_DEBUG_DROP
(
mvm
, "Bad decryptionÑesults 0x%08x\n",

407 
rx_pkt_°©us
);

408 
	`k‰ì_skb
(
skb
);

409 
	`rcu_ªad_u∆ock
();

413 i‡(
°a
) {

414 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

415 
õì80211_vif
 *
tx_blocked_vif
 =

416 
	`rcu_dîe„ªn˚
(
mvm
->
cß_tx_blocked_vif
);

417 
iwl_fw_dbg_åiggî_év
 *
åig
;

418 
õì80211_vif
 *
vif
 = 
mvm°a
->vif;

424 i‡(
	`u∆ikñy
(
tx_blocked_vif
Ë&& 
vif
 ==Åx_blocked_vif) {

425 
iwl_mvm_vif
 *
mvmvif
 =

426 
	`iwl_mvm_vif_‰om_mac80211
(
tx_blocked_vif
);

428 i‡(
mvmvif
->
cß_èrgë_‰eq
 =
rx_°©us
->
‰eq
)

429 
	`iwl_mvm_°a_modify_dißbÀ_tx_≠
(
mvm
, 
°a
,

430 
Ál£
);

433 
	`rs_upd©e_œ°_rssi
(
mvm
, 
mvm°a
, 
rx_°©us
);

435 
åig
 = 
	`iwl_fw_dbg_åiggî_⁄
(&
mvm
->
fwπ
,

436 
	`õì80211_vif_to_wdev
(
vif
),

437 
FW_DBG_TRIGGER_RSSI
);

439 i‡(
åig
 && 
	`õì80211_is_bóc⁄
(
hdr
->
‰ame_c⁄åﬁ
)) {

440 
iwl_fw_dbg_åiggî_low_rssi
 *
rssi_åig
;

441 
s32
 
rssi
;

443 
rssi_åig
 = (*)
åig
->
d©a
;

444 
rssi
 = 
	`À32_to_˝u
(
rssi_åig
->rssi);

446 i‡(
rx_°©us
->
sig«l
 < 
rssi
)

447 
	`iwl_fw_dbg_cﬁÀ˘_åig
(&
mvm
->
fwπ
, 
åig
,

448 
NULL
);

451 i‡(!
mvm
->
tcm
.
∑u£d
 && 
Àn
 >(*
hdr
) &&

452 !
	`is_mu…iˇ°_ëhî_addr
(
hdr
->
addr1
) &&

453 
	`õì80211_is_d©a
(
hdr
->
‰ame_c⁄åﬁ
))

454 
	`iwl_mvm_rx_h™dÀ_tcm
(
mvm
, 
°a
, 
hdr
, 
Àn
, 
phy_öfo
,

455 
øã_n_Êags
);

457 i‡(
	`õì80211_is_d©a
(
hdr
->
‰ame_c⁄åﬁ
))

458 
	`iwl_mvm_rx_csum
(
°a
, 
skb
, 
rx_pkt_°©us
);

460 
	`rcu_ªad_u∆ock
();

463 i‡(
phy_öfo
->
phy_Êags
 & 
	`˝u_to_À16
(
RX_RES_PHY_FLAGS_SHORT_PREAMBLE
))

464 
rx_°©us
->
íc_Êags
 |
RX_ENC_FLAG_SHORTPRE
;

466 i‡(
phy_öfo
->
phy_Êags
 & 
	`˝u_to_À16
(
RX_RES_PHY_FLAGS_AGG
)) {

472 
rx_°©us
->
Êag
 |
RX_FLAG_AMPDU_DETAILS
;

473 
rx_°©us
->
ampdu_ª„ªn˚
 = 
mvm
->
ampdu_ªf
;

477 
øã_n_Êags
 & 
RATE_MCS_CHAN_WIDTH_MSK_V1
) {

478 
RATE_MCS_CHAN_WIDTH_20
:

480 
RATE_MCS_CHAN_WIDTH_40
:

481 
rx_°©us
->
bw
 = 
RATE_INFO_BW_40
;

483 
RATE_MCS_CHAN_WIDTH_80
:

484 
rx_°©us
->
bw
 = 
RATE_INFO_BW_80
;

486 
RATE_MCS_CHAN_WIDTH_160
:

487 
rx_°©us
->
bw
 = 
RATE_INFO_BW_160
;

490 i‡(!(
øã_n_Êags
 & 
RATE_MCS_CCK_MSK_V1
) &&

491 
øã_n_Êags
 & 
RATE_MCS_SGI_MSK_V1
)

492 
rx_°©us
->
íc_Êags
 |
RX_ENC_FLAG_SHORT_GI
;

493 i‡(
øã_n_Êags
 & 
RATE_HT_MCS_GF_MSK
)

494 
rx_°©us
->
íc_Êags
 |
RX_ENC_FLAG_HT_GF
;

495 i‡(
øã_n_Êags
 & 
RATE_MCS_LDPC_MSK_V1
)

496 
rx_°©us
->
íc_Êags
 |
RX_ENC_FLAG_LDPC
;

497 i‡(
øã_n_Êags
 & 
RATE_MCS_HT_MSK_V1
) {

498 
u8
 
°bc
 = (
øã_n_Êags
 & 
RATE_MCS_STBC_MSK
) >>

499 
RATE_MCS_STBC_POS
;

500 
rx_°©us
->
ícodög
 = 
RX_ENC_HT
;

501 
rx_°©us
->
øã_idx
 = 
øã_n_Êags
 & 
RATE_HT_MCS_INDEX_MSK_V1
;

502 
rx_°©us
->
íc_Êags
 |
°bc
 << 
RX_ENC_FLAG_STBC_SHIFT
;

503 } i‡(
øã_n_Êags
 & 
RATE_MCS_VHT_MSK_V1
) {

504 
u8
 
°bc
 = (
øã_n_Êags
 & 
RATE_MCS_STBC_MSK
) >>

505 
RATE_MCS_STBC_POS
;

506 
rx_°©us
->
nss
 =

507 
	`FIELD_GET
(
RATE_MCS_NSS_MSK
, 
øã_n_Êags
) + 1;

508 
rx_°©us
->
øã_idx
 = 
øã_n_Êags
 & 
RATE_VHT_MCS_RATE_CODE_MSK
;

509 
rx_°©us
->
ícodög
 = 
RX_ENC_VHT
;

510 
rx_°©us
->
íc_Êags
 |
°bc
 << 
RX_ENC_FLAG_STBC_SHIFT
;

511 i‡(
øã_n_Êags
 & 
RATE_MCS_BF_MSK
)

512 
rx_°©us
->
íc_Êags
 |
RX_ENC_FLAG_BF
;

514 
øã
 = 
	`iwl_mvm_Àgacy_øã_to_mac80211_idx
(
øã_n_Êags
,

515 
rx_°©us
->
b™d
);

517 i‡(
	`WARN
(
øã
 < 0 ||Ñate > 0xFF,

519 
øã_n_Êags
, 
rx_°©us
->
b™d
)) {

520 
	`k‰ì_skb
(
skb
);

523 
rx_°©us
->
øã_idx
 = 
øã
;

526 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


527 
	`iwl_mvm_upd©e_‰ame_°©s
(
mvm
, 
øã_n_Êags
,

528 
rx_°©us
->
Êag
 & 
RX_FLAG_AMPDU_DETAILS
);

531 i‡(
	`u∆ikñy
((
	`õì80211_is_bóc⁄
(
hdr
->
‰ame_c⁄åﬁ
) ||

532 
	`õì80211_is_¥obe_ª•
(
hdr
->
‰ame_c⁄åﬁ
)) &&

533 
mvm
->
sched_sˇn_∑ss_Æl
 =
SCHED_SCAN_PASS_ALL_ENABLED
))

534 
mvm
->
sched_sˇn_∑ss_Æl
 = 
SCHED_SCAN_PASS_ALL_FOUND
;

536 i‡(
	`u∆ikñy
(
	`õì80211_is_bóc⁄
(
hdr
->
‰ame_c⁄åﬁ
) ||

537 
	`õì80211_is_¥obe_ª•
(
hdr
->
‰ame_c⁄åﬁ
)))

538 
rx_°©us
->
boŸtime_ns
 = 
	`ktime_gë_boŸtime_ns
();

540 
	`iwl_mvm_∑ss_∑ckë_to_mac80211
(
mvm
, 
°a
, 
«pi
, 
skb
, 
hdr
, 
Àn
,

541 
¸y±_Àn
, 
rxb
);

542 
	}
}

544 
	siwl_mvm_°©_d©a
 {

545 
iwl_mvm
 *
	mmvm
;

546 
__À32
 
	mÊags
;

547 
__À32
 
	mmac_id
;

548 
u8
 
	mbóc⁄_fûãr_avîage_íîgy
;

549 
__À32
 *
	mbóc⁄_cou¡î
;

550 
u8
 *
	mbóc⁄_avîage_íîgy
;

553 
	siwl_mvm_°©_d©a_Æl_macs
 {

554 
iwl_mvm
 *
	mmvm
;

555 
__À32
 
	mÊags
;

556 
iwl_°©s_¡fy_≥r_mac
 *
	m≥r_mac
;

559 
	$iwl_mvm_upd©e_vif_sig
(
õì80211_vif
 *
vif
, 
sig
)

561 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

562 
iwl_mvm
 *
mvm
 = 
mvmvif
->mvm;

563 
thﬁd
 = 
vif
->
bss_c⁄f
.
cqm_rssi_thﬁd
;

564 
hy°
 = 
vif
->
bss_c⁄f
.
cqm_rssi_hy°
;

565 
œ°_evít
;

567 i‡(
sig
 == 0) {

568 
	`IWL_DEBUG_RX
(
mvm
, "RSSI is 0 - skip signal based decision\n");

572 
mvmvif
->
bf_d©a
.
ave_bóc⁄_sig«l
 = 
sig
;

575 i‡(
mvmvif
->
bf_d©a
.
bt_c€x_mö_thﬁd
 !=

576 
mvmvif
->
bf_d©a
.
bt_c€x_max_thﬁd
) {

577 
œ°_evít
 = 
mvmvif
->
bf_d©a
.
œ°_bt_c€x_evít
;

578 i‡(
sig
 > 
mvmvif
->
bf_d©a
.
bt_c€x_max_thﬁd
 &&

579 (
œ°_evít
 <
mvmvif
->
bf_d©a
.
bt_c€x_mö_thﬁd
 ||

580 
œ°_evít
 == 0)) {

581 
mvmvif
->
bf_d©a
.
œ°_bt_c€x_evít
 = 
sig
;

582 
	`IWL_DEBUG_RX
(
mvm
, "cqm_iterator bt coex high %d\n",

583 
sig
);

584 
	`iwl_mvm_bt_rssi_evít
(
mvm
, 
vif
, 
RSSI_EVENT_HIGH
);

585 } i‡(
sig
 < 
mvmvif
->
bf_d©a
.
bt_c€x_mö_thﬁd
 &&

586 (
œ°_evít
 >
mvmvif
->
bf_d©a
.
bt_c€x_max_thﬁd
 ||

587 
œ°_evít
 == 0)) {

588 
mvmvif
->
bf_d©a
.
œ°_bt_c€x_evít
 = 
sig
;

589 
	`IWL_DEBUG_RX
(
mvm
, "cqm_iterator bt coexÜow %d\n",

590 
sig
);

591 
	`iwl_mvm_bt_rssi_evít
(
mvm
, 
vif
, 
RSSI_EVENT_LOW
);

595 i‡(!(
vif
->
drivî_Êags
 & 
IEEE80211_VIF_SUPPORTS_CQM_RSSI
))

599 
œ°_evít
 = 
mvmvif
->
bf_d©a
.
œ°_cqm_evít
;

600 i‡(
thﬁd
 && 
sig
 <Åhﬁd && (
œ°_evít
 == 0 ||

601 
sig
 < 
œ°_evít
 - 
hy°
)) {

602 
mvmvif
->
bf_d©a
.
œ°_cqm_evít
 = 
sig
;

603 
	`IWL_DEBUG_RX
(
mvm
, "cqm_iterator cqmÜow %d\n",

604 
sig
);

605 
	`õì80211_cqm_rssi_nŸify
(

606 
vif
,

607 
NL80211_CQM_RSSI_THRESHOLD_EVENT_LOW
,

608 
sig
,

609 
GFP_KERNEL
);

610 } i‡(
sig
 > 
thﬁd
 &&

611 (
œ°_evít
 =0 || 
sig
 >Üa°_evíà+ 
hy°
)) {

612 
mvmvif
->
bf_d©a
.
œ°_cqm_evít
 = 
sig
;

613 
	`IWL_DEBUG_RX
(
mvm
, "cqm_iterator cqm high %d\n",

614 
sig
);

615 
	`õì80211_cqm_rssi_nŸify
(

616 
vif
,

617 
NL80211_CQM_RSSI_THRESHOLD_EVENT_HIGH
,

618 
sig
,

619 
GFP_KERNEL
);

621 
	}
}

623 
	$iwl_mvm_°©_ôî©‹
(*
_d©a
, 
u8
 *
mac
,

624 
õì80211_vif
 *
vif
)

626 
iwl_mvm_°©_d©a
 *
d©a
 = 
_d©a
;

627 
sig
 = -
d©a
->
bóc⁄_fûãr_avîage_íîgy
;

628 
u16
 
id
 = 
	`À32_to_˝u
(
d©a
->
mac_id
);

629 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

630 
u16
 
vif_id
 = 
mvmvif
->
id
;

636 
mvmvif
->
deÊök
.
bóc⁄_°©s
.
num_bóc⁄s
 =

637 
	`À32_to_˝u
(
d©a
->
bóc⁄_cou¡î
[
vif_id
]);

638 
mvmvif
->
deÊök
.
bóc⁄_°©s
.
avg_sig«l
 =

639 -
d©a
->
bóc⁄_avîage_íîgy
[
vif_id
];

641 i‡(
mvmvif
->
id
 != id)

644 i‡(
vif
->
ty≥
 !
NL80211_IFTYPE_STATION
)

650 i‡(
	`À32_to_˝u
(
d©a
->
Êags
Ë& 
IWL_STATISTICS_REPLY_FLG_CLEAR
)

651 
mvmvif
->
deÊök
.
bóc⁄_°©s
.
accu_num_bóc⁄s
 +=

652 
mvmvif
->
deÊök
.
bóc⁄_°©s
.
num_bóc⁄s
;

654 
	`iwl_mvm_upd©e_vif_sig
(
vif
, 
sig
);

655 
	}
}

657 
	$iwl_mvm_°©_ôî©‹_Æl_macs
(*
_d©a
, 
u8
 *
mac
,

658 
õì80211_vif
 *
vif
)

660 
iwl_mvm_°©_d©a_Æl_macs
 *
d©a
 = 
_d©a
;

661 
iwl_°©s_¡fy_≥r_mac
 *
mac_°©s
;

662 
sig
;

663 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

664 
u16
 
vif_id
 = 
mvmvif
->
id
;

666 i‡(
	`WARN_ONCE
(
vif_id
 >
MAC_INDEX_AUX
, "invalid vif id: %d", vif_id))

669 i‡(
vif
->
ty≥
 !
NL80211_IFTYPE_STATION
)

672 
mac_°©s
 = &
d©a
->
≥r_mac
[
vif_id
];

674 
mvmvif
->
deÊök
.
bóc⁄_°©s
.
num_bóc⁄s
 =

675 
	`À32_to_˝u
(
mac_°©s
->
bóc⁄_cou¡î
);

676 
mvmvif
->
deÊök
.
bóc⁄_°©s
.
avg_sig«l
 =

677 -
	`À32_to_˝u
(
mac_°©s
->
bóc⁄_avîage_íîgy
);

682 i‡(
	`À32_to_˝u
(
d©a
->
Êags
Ë& 
IWL_STATISTICS_REPLY_FLG_CLEAR
)

683 
mvmvif
->
deÊök
.
bóc⁄_°©s
.
accu_num_bóc⁄s
 +=

684 
mvmvif
->
deÊök
.
bóc⁄_°©s
.
num_bóc⁄s
;

686 
sig
 = -
	`À32_to_˝u
(
mac_°©s
->
bóc⁄_fûãr_avîage_íîgy
);

687 
	`iwl_mvm_upd©e_vif_sig
(
vif
, 
sig
);

688 
	}
}

690 
ölöe
 

691 
	$iwl_mvm_rx_°©s_check_åiggî
(
iwl_mvm
 *
mvm
, 
iwl_rx_∑ckë
 *
pkt
)

693 
iwl_fw_dbg_åiggî_év
 *
åig
;

694 
iwl_fw_dbg_åiggî_°©s
 *
åig_°©s
;

695 
u32
 
åig_off£t
, 
åig_thﬁd
;

697 
åig
 = 
	`iwl_fw_dbg_åiggî_⁄
(&
mvm
->
fwπ
, 
NULL
, 
FW_DBG_TRIGGER_STATS
);

698 i‡(!
åig
)

701 
åig_°©s
 = (*)
åig
->
d©a
;

703 
åig_off£t
 = 
	`À32_to_˝u
(
åig_°©s
->
°›_off£t
);

704 
åig_thﬁd
 = 
	`À32_to_˝u
(
åig_°©s
->
°›_thªshﬁd
);

706 i‡(
	`WARN_ON_ONCE
(
åig_off£t
 >
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
)))

709 i‡(
	`À32_to_˝up
((
__À32
 *Ë(
pkt
->
d©a
 + 
åig_off£t
)Ë< 
åig_thﬁd
)

712 
	`iwl_fw_dbg_cﬁÀ˘_åig
(&
mvm
->
fwπ
, 
åig
, 
NULL
);

713 
	}
}

715 
	$iwl_mvm_°©s_íîgy_ôî
(*
_d©a
,

716 
õì80211_°a
 *
°a
)

718 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

719 
u8
 *
íîgy
 = 
_d©a
;

720 
u32
 
°a_id
 = 
mvm°a
->
deÊök
.sta_id;

722 i‡(
	`WARN_ONCE
(
°a_id
 >
IWL_MVM_STATION_COUNT_MAX
, "sta_id %d >= %d",

723 
°a_id
, 
IWL_MVM_STATION_COUNT_MAX
))

726 i‡(
íîgy
[
°a_id
])

727 
mvm°a
->
deÊök
.
avg_íîgy
 = 
íîgy
[
°a_id
];

729 
	}
}

732 
	$iwl_mvm_upd©e_tcm_‰om_°©s
(
iwl_mvm
 *
mvm
, 
__À32
 *
aú_time_À
,

733 
__À32
 *
rx_byãs_À
)

735 
i
;

737 
	`•ö_lock
(&
mvm
->
tcm
.
lock
);

738 
i
 = 0; i < 
NUM_MAC_INDEX_DRIVER
; i++) {

739 
iwl_mvm_tcm_mac
 *
md©a
 = &
mvm
->
tcm
.
d©a
[
i
];

740 
u32
 
rx_byãs
 = 
	`À32_to_˝u
(
rx_byãs_À
[
i
]);

741 
u32
 
aútime
 = 
	`À32_to_˝u
(
aú_time_À
[
i
]);

743 
md©a
->
rx
.
aútime
 +=áirtime;

744 
md©a
->
u≠sd_n⁄agg_dëe˘
.
rx_byãs
 +=Ñx_bytes;

745 i‡(
aútime
) {

747 
	`ewma_øã_öô
(&
md©a
->
u≠sd_n⁄agg_dëe˘
.
øã
);

748 
	`ewma_øã_add
(&
md©a
->
u≠sd_n⁄agg_dëe˘
.
øã
,

749 
rx_byãs
 * 8 / 
aútime
);

752 
	`•ö_u∆ock
(&
mvm
->
tcm
.
lock
);

753 
	}
}

755 
	$iwl_mvm_h™dÀ_≥r_phy_°©s
(
iwl_mvm
 *
mvm
,

756 
iwl_°©s_¡fy_≥r_phy
 *
≥r_phy
)

758 
i
;

760 
i
 = 0; i < 
NUM_PHY_CTX
; i++) {

761 i‡(!
mvm
->
phy_˘xts
[
i
].
ªf
)

763 
mvm
->
phy_˘xts
[
i
].
ch™√l_lﬂd_by_us
 =

764 
	`À32_to_˝u
(
≥r_phy
[
i
].
ch™√l_lﬂd_by_us
);

766 
	}
}

769 
	$iwl_mvm_°©s_vî_15
(
iwl_mvm
 *
mvm
,

770 
iwl_°©i°ics_›î©i⁄Æ_¡fy
 *
°©s
)

772 
iwl_mvm_°©_d©a_Æl_macs
 
d©a
 = {

773 .
mvm
 = mvm,

774 .
Êags
 = 
°©s
->flags,

775 .
≥r_mac
 = 
°©s
->per_mac,

778 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s
(
mvm
->
hw
,

779 
IEEE80211_IFACE_ITER_NORMAL
,

780 
iwl_mvm_°©_ôî©‹_Æl_macs
,

781 &
d©a
);

782 
	`iwl_mvm_h™dÀ_≥r_phy_°©s
(
mvm
, 
°©s
->
≥r_phy
);

783 
	}
}

786 
	$iwl_mvm_°©s_vî_14
(
iwl_mvm
 *
mvm
,

787 
iwl_°©i°ics_›î©i⁄Æ_¡fy_vî_14
 *
°©s
)

789 
iwl_mvm_°©_d©a
 
d©a
 = {

790 .
mvm
 = mvm,

793 
u8
 
bóc⁄_avîage_íîgy
[
MAC_INDEX_AUX
];

794 
__À32
 
Êags
;

795 
i
;

797 
Êags
 = 
°©s
->flags;

799 
d©a
.
mac_id
 = 
°©s
->mac_id;

800 
d©a
.
bóc⁄_fûãr_avîage_íîgy
 =

801 
	`À32_to_˝u
(
°©s
->
bóc⁄_fûãr_avîage_íîgy
);

802 
d©a
.
Êags
 = flags;

803 
d©a
.
bóc⁄_cou¡î
 = 
°©s
->beacon_counter;

805 
i
 = 0; i < 
	`ARRAY_SIZE
(
bóc⁄_avîage_íîgy
); i++)

806 
bóc⁄_avîage_íîgy
[
i
] =

807 
	`À32_to_˝u
(
°©s
->
bóc⁄_avîage_íîgy
[
i
]);

809 
d©a
.
bóc⁄_avîage_íîgy
 = beacon_average_energy;

811 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s
(
mvm
->
hw
,

812 
IEEE80211_IFACE_ITER_NORMAL
,

813 
iwl_mvm_°©_ôî©‹
,

814 &
d©a
);

815 
	}
}

817 
boﬁ
 
	$iwl_mvm_vîify_°©s_Àn
(
iwl_mvm
 *
mvm
,

818 
iwl_rx_∑ckë
 *
pkt
,

819 
u32
 
ex≥˘ed_size
)

821 
iwl_°©i°ics_¡fy_hdr
 *
hdr
;

823 i‡(
	`WARN_ONCE
(
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
Ë< 
ex≥˘ed_size
,

825 
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
), 
ex≥˘ed_size
))

826  
Ál£
;

828 
hdr
 = (*)&
pkt
->
d©a
;

830 i‡(
	`WARN_ONCE
((
hdr
->
ty≥
 & 
IWL_STATISTICS_TYPE_MSK
Ë!
FW_STATISTICS_OPERATIONAL
 ||

831 
hdr
->
vîsi⁄
 !=

832 
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
LEGACY_GROUP
, 
STATISTICS_NOTIFICATION
, 0),

834 
hdr
->
ty≥
, hdr->
vîsi⁄
))

835  
Ál£
;

837 i‡(
	`WARN_ONCE
(
	`À16_to_˝u
(
hdr
->
size
Ë!
ex≥˘ed_size
,

839 
	`À16_to_˝u
(
hdr
->
size
), 
ex≥˘ed_size
))

840  
Ál£
;

842  
åue
;

843 
	}
}

846 
	$iwl_mvm_°©_ôî©‹_Æl_löks
(
iwl_mvm
 *
mvm
,

847 
iwl_°©s_¡fy_≥r_lök
 *
≥r_lök
)

849 
u32
 
aú_time
[
MAC_INDEX_AUX
] = {};

850 
u32
 
rx_byãs
[
MAC_INDEX_AUX
] = {};

851 
fw_lök_id
;

853 
fw_lök_id
 = 0; fw_lök_id < 
	`ARRAY_SIZE
(
mvm
->
lök_id_to_lök_c⁄f
);

854 
fw_lök_id
++) {

855 
iwl_°©s_¡fy_≥r_lök
 *
lök_°©s
;

856 
õì80211_bss_c⁄f
 *
bss_c⁄f
;

857 
iwl_mvm_vif
 *
mvmvif
;

858 
iwl_mvm_vif_lök_öfo
 *
lök_öfo
;

859 
lök_id
;

860 
sig
;

862 
bss_c⁄f
 = 
	`iwl_mvm_rcu_fw_lök_id_to_lök_c⁄f
(
mvm
, 
fw_lök_id
,

863 
Ál£
);

864 i‡(!
bss_c⁄f
)

867 i‡(
bss_c⁄f
->
vif
->
ty≥
 !
NL80211_IFTYPE_STATION
)

870 
lök_id
 = 
bss_c⁄f
->link_id;

871 i‡(
lök_id
 >
	`ARRAY_SIZE
(
mvmvif
->
lök
))

874 
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
bss_c⁄f
->
vif
);

875 
lök_öfo
 = 
mvmvif
->
lök
[
lök_id
];

876 i‡(!
lök_öfo
)

879 
lök_°©s
 = &
≥r_lök
[
fw_lök_id
];

881 
lök_öfo
->
bóc⁄_°©s
.
num_bóc⁄s
 =

882 
	`À32_to_˝u
(
lök_°©s
->
bóc⁄_cou¡î
);

887 
lök_öfo
->
bóc⁄_°©s
.
avg_sig«l
 =

888 -
	`À32_to_˝u
(
lök_°©s
->
bóc⁄_avîage_íîgy
);

890 i‡(
lök_öfo
->
phy_˘xt
 &&

891 
lök_öfo
->
phy_˘xt
->
ch™√l
->
b™d
 =
NL80211_BAND_2GHZ
)

892 
	`iwl_mvm_bt_c€x_upd©e_vif_e§
(
mvm
, 
bss_c⁄f
->
vif
,

893 
lök_id
);

898 i‡(
mvm
->
°©i°ics_˛ór
)

899 
mvmvif
->
lök
[
lök_id
]->
bóc⁄_°©s
.
accu_num_bóc⁄s
 +=

900 
mvmvif
->
lök
[
lök_id
]->
bóc⁄_°©s
.
num_bóc⁄s
;

902 
sig
 = -
	`À32_to_˝u
(
lök_°©s
->
bóc⁄_fûãr_avîage_íîgy
);

903 
	`iwl_mvm_upd©e_vif_sig
(
bss_c⁄f
->
vif
, 
sig
);

905 i‡(
	`WARN_ONCE
(
mvmvif
->
id
 >
MAC_INDEX_AUX
,

906 "övÆid mvmvi‡id: %d", 
mvmvif
->
id
))

909 
aú_time
[
mvmvif
->
id
] +=

910 
	`À32_to_˝u
(
≥r_lök
[
fw_lök_id
].
aú_time
);

911 
rx_byãs
[
mvmvif
->
id
] +=

912 
	`À32_to_˝u
(
≥r_lök
[
fw_lök_id
].
rx_byãs
);

919 i‡(
mvm
->
°©i°ics_˛ór
) {

920 
__À32
 
aú_time_À
[
MAC_INDEX_AUX
];

921 
__À32
 
rx_byãs_À
[
MAC_INDEX_AUX
];

922 
vif_id
;

924 
vif_id
 = 0; vif_id < 
	`ARRAY_SIZE
(
aú_time_À
); vif_id++) {

925 
aú_time_À
[
vif_id
] = 
	`˝u_to_À32
(
aú_time
[vif_id]);

926 
rx_byãs_À
[
vif_id
] = 
	`˝u_to_À32
(
rx_byãs
[vif_id]);

929 
	`iwl_mvm_upd©e_tcm_‰om_°©s
(
mvm
, 
aú_time_À
, 
rx_byãs_À
);

931 
	}
}

933 
	$iwl_mvm_h™dÀ_rx_sy°em_›î_°©s
(
iwl_mvm
 *
mvm
,

934 
iwl_rx_cmd_buf„r
 *
rxb
)

936 
u8
 
avîage_íîgy
[
IWL_MVM_STATION_COUNT_MAX
];

937 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

938 
iwl_sy°em_°©i°ics_nŸif_›î
 *
°©s
;

939 
i
;

940 
u32
 
nŸif_vî
 = 
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
STATISTICS_GROUP
,

941 
STATISTICS_OPER_NOTIF
, 0);

943 i‡(
nŸif_vî
 != 3) {

944 
	`IWL_FW_CHECK_FAILED
(
mvm
,

946 
nŸif_vî
);

950 
°©s
 = (*)&
pkt
->
d©a
;

951 
	`iwl_mvm_°©_ôî©‹_Æl_löks
(
mvm
, 
°©s
->
≥r_lök
);

953 
i
 = 0; i < 
	`ARRAY_SIZE
(
avîage_íîgy
); i++)

954 
avîage_íîgy
[
i
] =

955 
	`À32_to_˝u
(
°©s
->
≥r_°a
[
i
].
avîage_íîgy
);

957 
	`õì80211_ôî©e_°©i⁄s_©omic
(
mvm
->
hw
, 
iwl_mvm_°©s_íîgy_ôî
,

958 
avîage_íîgy
);

959 
	`iwl_mvm_h™dÀ_≥r_phy_°©s
(
mvm
, 
°©s
->
≥r_phy
);

960 
	}
}

962 
	$iwl_mvm_h™dÀ_rx_sy°em_›î_∑π1_°©s
(
iwl_mvm
 *
mvm
,

963 
iwl_rx_cmd_buf„r
 *
rxb
)

965 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

966 
iwl_sy°em_°©i°ics_∑π1_nŸif_›î
 *
∑π1_°©s
;

967 
i
;

968 
u32
 
nŸif_vî
 = 
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
STATISTICS_GROUP
,

969 
STATISTICS_OPER_PART1_NOTIF
, 0);

971 i‡(
nŸif_vî
 != 4) {

972 
	`IWL_FW_CHECK_FAILED
(
mvm
,

974 
nŸif_vî
);

978 
∑π1_°©s
 = (*)&
pkt
->
d©a
;

979 
mvm
->
ødio_°©s
.
rx_time
 = 0;

980 
mvm
->
ødio_°©s
.
tx_time
 = 0;

981 
i
 = 0; i < 
	`ARRAY_SIZE
(
∑π1_°©s
->
≥r_lök
); i++) {

982 
mvm
->
ødio_°©s
.
rx_time
 +=

983 
	`À64_to_˝u
(
∑π1_°©s
->
≥r_lök
[
i
].
rx_time
);

984 
mvm
->
ødio_°©s
.
tx_time
 +=

985 
	`À64_to_˝u
(
∑π1_°©s
->
≥r_lök
[
i
].
tx_time
);

987 
	}
}

990 
	$iwl_mvm_h™dÀ_rx_°©i°ics_év
(
iwl_mvm
 *
mvm
,

991 
iwl_rx_∑ckë
 *
pkt
)

993 
u8
 
avîage_íîgy
[
IWL_MVM_STATION_COUNT_MAX
];

994 
__À32
 
aú_time
[
MAC_INDEX_AUX
];

995 
__À32
 
rx_byãs
[
MAC_INDEX_AUX
];

996 
__À32
 
Êags
 = 0;

997 
i
;

998 
u32
 
nŸif_vî
 = 
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
LEGACY_GROUP
,

999 
STATISTICS_NOTIFICATION
, 0);

1001 i‡(
	`WARN_ONCE
(
nŸif_vî
 > 15,

1002 "övÆid sèti°ic†vîsi⁄ id: %d\n", 
nŸif_vî
))

1005 i‡(
nŸif_vî
 == 14) {

1006 
iwl_°©i°ics_›î©i⁄Æ_¡fy_vî_14
 *
°©s
 =

1007 (*)
pkt
->
d©a
;

1009 i‡(!
	`iwl_mvm_vîify_°©s_Àn
(
mvm
, 
pkt
, (*
°©s
)))

1012 
	`iwl_mvm_°©s_vî_14
(
mvm
, 
°©s
);

1014 
Êags
 = 
°©s
->flags;

1015 
mvm
->
ødio_°©s
.
rx_time
 = 
	`À64_to_˝u
(
°©s
->rx_time);

1016 
mvm
->
ødio_°©s
.
tx_time
 = 
	`À64_to_˝u
(
°©s
->tx_time);

1017 
mvm
->
ødio_°©s
.
⁄_time_rf
 = 
	`À64_to_˝u
(
°©s
->on_time_rf);

1018 
mvm
->
ødio_°©s
.
⁄_time_sˇn
 =

1019 
	`À64_to_˝u
(
°©s
->
⁄_time_sˇn
);

1021 
i
 = 0; i < 
	`ARRAY_SIZE
(
avîage_íîgy
); i++)

1022 
avîage_íîgy
[
i
] = 
	`À32_to_˝u
(
°©s
->average_energy[i]);

1024 
i
 = 0; i < 
	`ARRAY_SIZE
(
aú_time
); i++) {

1025 
aú_time
[
i
] = 
°©s
->air_time[i];

1026 
rx_byãs
[
i
] = 
°©s
->rx_bytes[i];

1030 i‡(
nŸif_vî
 == 15) {

1031 
iwl_°©i°ics_›î©i⁄Æ_¡fy
 *
°©s
 =

1032 (*)
pkt
->
d©a
;

1034 i‡(!
	`iwl_mvm_vîify_°©s_Àn
(
mvm
, 
pkt
, (*
°©s
)))

1037 
	`iwl_mvm_°©s_vî_15
(
mvm
, 
°©s
);

1039 
Êags
 = 
°©s
->flags;

1040 
mvm
->
ødio_°©s
.
rx_time
 = 
	`À64_to_˝u
(
°©s
->rx_time);

1041 
mvm
->
ødio_°©s
.
tx_time
 = 
	`À64_to_˝u
(
°©s
->tx_time);

1042 
mvm
->
ødio_°©s
.
⁄_time_rf
 = 
	`À64_to_˝u
(
°©s
->on_time_rf);

1043 
mvm
->
ødio_°©s
.
⁄_time_sˇn
 =

1044 
	`À64_to_˝u
(
°©s
->
⁄_time_sˇn
);

1046 
i
 = 0; i < 
	`ARRAY_SIZE
(
avîage_íîgy
); i++)

1047 
avîage_íîgy
[
i
] =

1048 
	`À32_to_˝u
(
°©s
->
≥r_°a
[
i
].
avîage_íîgy
);

1050 
i
 = 0; i < 
	`ARRAY_SIZE
(
aú_time
); i++) {

1051 
aú_time
[
i
] = 
°©s
->
≥r_mac
[i].air_time;

1052 
rx_byãs
[
i
] = 
°©s
->
≥r_mac
[i].rx_bytes;

1056 
	`iwl_mvm_rx_°©s_check_åiggî
(
mvm
, 
pkt
);

1058 
	`õì80211_ôî©e_°©i⁄s_©omic
(
mvm
->
hw
, 
iwl_mvm_°©s_íîgy_ôî
,

1059 
avîage_íîgy
);

1065 i‡(
	`À32_to_˝u
(
Êags
Ë& 
IWL_STATISTICS_REPLY_FLG_CLEAR
)

1066 
	`iwl_mvm_upd©e_tcm_‰om_°©s
(
mvm
, 
aú_time
, 
rx_byãs
);

1067 
	}
}

1069 
	$iwl_mvm_h™dÀ_rx_°©i°ics
(
iwl_mvm
 *
mvm
,

1070 
iwl_rx_∑ckë
 *
pkt
)

1072 
iwl_mvm_°©_d©a
 
d©a
 = {

1073 .
mvm
 = mvm,

1075 
__À32
 *
byãs
, *
aú_time
, 
Êags
;

1076 
ex≥˘ed_size
;

1077 
u8
 *
íîgy
;

1078 
u8
 
cmd_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
,

1079 
	`WIDE_ID
(
SYSTEM_GROUP
,

1080 
SYSTEM_STATISTICS_CMD
),

1081 
IWL_FW_CMD_VER_UNKNOWN
);

1083 i‡(
cmd_vî
 !
IWL_FW_CMD_VER_UNKNOWN
)

1087 i‡(
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
LEGACY_GROUP
,

1088 
STATISTICS_NOTIFICATION
, 0) >= 14)

1089  
	`iwl_mvm_h™dÀ_rx_°©i°ics_év
(
mvm
, 
pkt
);

1091 i‡(!
	`iwl_mvm_has_√w_rx_°©s_≠i
(
mvm
)) {

1092 i‡(
	`iwl_mvm_has_√w_rx_≠i
(
mvm
))

1093 
ex≥˘ed_size
 = (
iwl_nŸif_°©i°ics_v11
);

1095 
ex≥˘ed_size
 = (
iwl_nŸif_°©i°ics_v10
);

1097 
ex≥˘ed_size
 = (
iwl_nŸif_°©i°ics
);

1100 i‡(
	`WARN_ONCE
(
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
Ë!
ex≥˘ed_size
,

1102 
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
)))

1105 i‡(!
	`iwl_mvm_has_√w_rx_°©s_≠i
(
mvm
)) {

1106 
iwl_nŸif_°©i°ics_v11
 *
°©s
 = (*)&
pkt
->
d©a
;

1108 
d©a
.
mac_id
 = 
°©s
->
rx
.
gíîÆ
.mac_id;

1109 
d©a
.
bóc⁄_fûãr_avîage_íîgy
 =

1110 
°©s
->
gíîÆ
.
comm⁄
.
bóc⁄_fûãr_avîage_íîgy
;

1112 
mvm
->
rx_°©s_v3
 = 
°©s
->
rx
;

1114 
mvm
->
ødio_°©s
.
rx_time
 =

1115 
	`À64_to_˝u
(
°©s
->
gíîÆ
.
comm⁄
.
rx_time
);

1116 
mvm
->
ødio_°©s
.
tx_time
 =

1117 
	`À64_to_˝u
(
°©s
->
gíîÆ
.
comm⁄
.
tx_time
);

1118 
mvm
->
ødio_°©s
.
⁄_time_rf
 =

1119 
	`À64_to_˝u
(
°©s
->
gíîÆ
.
comm⁄
.
⁄_time_rf
);

1120 
mvm
->
ødio_°©s
.
⁄_time_sˇn
 =

1121 
	`À64_to_˝u
(
°©s
->
gíîÆ
.
comm⁄
.
⁄_time_sˇn
);

1123 
d©a
.
bóc⁄_cou¡î
 = 
°©s
->
gíîÆ
.beacon_counter;

1124 
d©a
.
bóc⁄_avîage_íîgy
 =

1125 
°©s
->
gíîÆ
.
bóc⁄_avîage_íîgy
;

1126 
Êags
 = 
°©s
->
Êag
;

1128 
iwl_nŸif_°©i°ics
 *
°©s
 = (*)&
pkt
->
d©a
;

1130 
d©a
.
mac_id
 = 
°©s
->
rx
.
gíîÆ
.mac_id;

1131 
d©a
.
bóc⁄_fûãr_avîage_íîgy
 =

1132 
°©s
->
gíîÆ
.
comm⁄
.
bóc⁄_fûãr_avîage_íîgy
;

1134 
mvm
->
rx_°©s
 = 
°©s
->
rx
;

1136 
mvm
->
ødio_°©s
.
rx_time
 =

1137 
	`À64_to_˝u
(
°©s
->
gíîÆ
.
comm⁄
.
rx_time
);

1138 
mvm
->
ødio_°©s
.
tx_time
 =

1139 
	`À64_to_˝u
(
°©s
->
gíîÆ
.
comm⁄
.
tx_time
);

1140 
mvm
->
ødio_°©s
.
⁄_time_rf
 =

1141 
	`À64_to_˝u
(
°©s
->
gíîÆ
.
comm⁄
.
⁄_time_rf
);

1142 
mvm
->
ødio_°©s
.
⁄_time_sˇn
 =

1143 
	`À64_to_˝u
(
°©s
->
gíîÆ
.
comm⁄
.
⁄_time_sˇn
);

1145 
d©a
.
bóc⁄_cou¡î
 = 
°©s
->
gíîÆ
.beacon_counter;

1146 
d©a
.
bóc⁄_avîage_íîgy
 =

1147 
°©s
->
gíîÆ
.
bóc⁄_avîage_íîgy
;

1148 
Êags
 = 
°©s
->
Êag
;

1150 
d©a
.
Êags
 = flags;

1152 
	`iwl_mvm_rx_°©s_check_åiggî
(
mvm
, 
pkt
);

1154 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s
(
mvm
->
hw
,

1155 
IEEE80211_IFACE_ITER_NORMAL
,

1156 
iwl_mvm_°©_ôî©‹
,

1157 &
d©a
);

1159 i‡(!
	`iwl_mvm_has_√w_rx_≠i
(
mvm
))

1162 i‡(!
	`iwl_mvm_has_√w_rx_°©s_≠i
(
mvm
)) {

1163 
iwl_nŸif_°©i°ics_v11
 *
v11
 = (*)&
pkt
->
d©a
;

1165 
íîgy
 = (*)&
v11
->
lﬂd_°©s
.
avg_íîgy
;

1166 
byãs
 = (*)&
v11
->
lﬂd_°©s
.
byã_cou¡
;

1167 
aú_time
 = (*)&
v11
->
lﬂd_°©s
.air_time;

1169 
iwl_nŸif_°©i°ics
 *
°©s
 = (*)&
pkt
->
d©a
;

1171 
íîgy
 = (*)&
°©s
->
lﬂd_°©s
.
avg_íîgy
;

1172 
byãs
 = (*)&
°©s
->
lﬂd_°©s
.
byã_cou¡
;

1173 
aú_time
 = (*)&
°©s
->
lﬂd_°©s
.air_time;

1175 
	`õì80211_ôî©e_°©i⁄s_©omic
(
mvm
->
hw
, 
iwl_mvm_°©s_íîgy_ôî
,

1176 
íîgy
);

1183 i‡(
	`À32_to_˝u
(
Êags
Ë& 
IWL_STATISTICS_REPLY_FLG_CLEAR
)

1184 
	`iwl_mvm_upd©e_tcm_‰om_°©s
(
mvm
, 
aú_time
, 
byãs
);

1186 
	}
}

1188 
	$iwl_mvm_rx_°©i°ics
(
iwl_mvm
 *
mvm
, 
iwl_rx_cmd_buf„r
 *
rxb
)

1190 
	`iwl_mvm_h™dÀ_rx_°©i°ics
(
mvm
, 
	`rxb_addr
(
rxb
));

1191 
	}
}

1193 
	$iwl_mvm_wödow_°©us_nŸif
(
iwl_mvm
 *
mvm
,

1194 
iwl_rx_cmd_buf„r
 *
rxb
)

1196 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

1197 
iwl_ba_wödow_°©us_nŸif
 *
nŸif
 = (*)
pkt
->
d©a
;

1198 
i
;

1200 
	`BUILD_BUG_ON
(
	`ARRAY_SIZE
(
nŸif
->
ø_tid
Ë!
BA_WINDOW_STREAMS_MAX
);

1201 
	`BUILD_BUG_ON
(
	`ARRAY_SIZE
(
nŸif
->
mpdu_rx_cou¡
Ë!
BA_WINDOW_STREAMS_MAX
);

1202 
	`BUILD_BUG_ON
(
	`ARRAY_SIZE
(
nŸif
->
bôm≠
Ë!
BA_WINDOW_STREAMS_MAX
);

1203 
	`BUILD_BUG_ON
(
	`ARRAY_SIZE
(
nŸif
->
°¨t_£q_num
Ë!
BA_WINDOW_STREAMS_MAX
);

1205 
	`rcu_ªad_lock
();

1206 
i
 = 0; i < 
BA_WINDOW_STREAMS_MAX
; i++) {

1207 
õì80211_°a
 *
°a
;

1208 
u8
 
°a_id
, 
tid
;

1209 
u64
 
bôm≠
;

1210 
u32
 
s¢
;

1211 
u16
 
øtid
;

1212 
u16
 
ª˚ived_mpdu
;

1214 
øtid
 = 
	`À16_to_˝u
(
nŸif
->
ø_tid
[
i
]);

1216 i‡(!(
øtid
 & 
BA_WINDOW_STATUS_VALID_MSK
))

1219 
ª˚ived_mpdu
 = 
	`À16_to_˝u
(
nŸif
->
mpdu_rx_cou¡
[
i
]);

1220 i‡(
ª˚ived_mpdu
 == 0)

1223 
tid
 = 
øtid
 & 
BA_WINDOW_STATUS_TID_MSK
;

1225 
°a_id
 = (
øtid
 & 
BA_WINDOW_STATUS_STA_ID_MSK
)

1226 >> 
BA_WINDOW_STATUS_STA_ID_POS
;

1227 
°a
 = 
	`rcu_dîe„ªn˚
(
mvm
->
fw_id_to_mac_id
[
°a_id
]);

1228 i‡(
	`IS_ERR_OR_NULL
(
°a
))

1230 
bôm≠
 = 
	`À64_to_˝u
(
nŸif
->bôm≠[
i
]);

1231 
s¢
 = 
	`À32_to_˝u
(
nŸif
->
°¨t_£q_num
[
i
]);

1234 
	`õì80211_m¨k_rx_ba_fûãªd_‰ames
(
°a
, 
tid
, 
s¢
, 
bôm≠
,

1235 
ª˚ived_mpdu
);

1237 
	`rcu_ªad_u∆ock
();

1238 
	}
}

	@rxmq.c

7 
	~<löux/ëhîdevi˚.h
>

8 
	~<löux/skbuff.h
>

9 
	~"iwl-å™s.h
"

10 
	~"mvm.h
"

11 
	~"fw-≠i.h
"

12 
	~"time-sync.h
"

14 
ölöe
 
	$iwl_mvm_check_≤
(
iwl_mvm
 *
mvm
, 
sk_buff
 *
skb
,

15 
queue
, 
õì80211_°a
 *
°a
)

17 
iwl_mvm_°a
 *
mvm°a
;

18 
õì80211_hdr
 *
hdr
 = (*)
	`skb_mac_hódî
(
skb
);

19 
õì80211_rx_°©us
 *
°©s
 = 
	`IEEE80211_SKB_RXCB
(
skb
);

20 
iwl_mvm_key_≤
 *
±k_≤
;

21 
ªs
;

22 
u8
 
tid
, 
keyidx
;

23 
u8
 
≤
[
IEEE80211_CCMP_PN_LEN
];

24 
u8
 *
extiv
;

29 i‡(!
	`õì80211_is_d©a
(
hdr
->
‰ame_c⁄åﬁ
) ||

30 
	`is_mu…iˇ°_ëhî_addr
(
hdr
->
addr1
))

34 i‡(!(
°©s
->
Êag
 & 
RX_FLAG_DECRYPTED
))

42 i‡(
queue
 == 0)

46 i‡(
	`IS_ERR_OR_NULL
(
°a
)) {

47 
	`IWL_DEBUG_DROP
(
mvm
,

52 
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

54 
extiv
 = (
u8
 *)
hdr
 + 
	`õì80211_hdæí
(hdr->
‰ame_c⁄åﬁ
);

55 
keyidx
 = 
extiv
[3] >> 6;

57 
±k_≤
 = 
	`rcu_dîe„ªn˚
(
mvm°a
->±k_≤[
keyidx
]);

58 i‡(!
±k_≤
)

61 i‡(
	`õì80211_is_d©a_qos
(
hdr
->
‰ame_c⁄åﬁ
))

62 
tid
 = 
	`õì80211_gë_tid
(
hdr
);

64 
tid
 = 0;

67 i‡(
tid
 >
IWL_MAX_TID_COUNT
)

71 
≤
[0] = 
extiv
[7];

72 
≤
[1] = 
extiv
[6];

73 
≤
[2] = 
extiv
[5];

74 
≤
[3] = 
extiv
[4];

75 
≤
[4] = 
extiv
[1];

76 
≤
[5] = 
extiv
[0];

78 
ªs
 = 
	`memcmp
(
≤
, 
±k_≤
->
q
[
queue
].≤[
tid
], 
IEEE80211_CCMP_PN_LEN
);

79 i‡(
ªs
 < 0)

81 i‡(!
ªs
 && !(
°©s
->
Êag
 & 
RX_FLAG_ALLOW_SAME_PN
))

84 
	`mem˝y
(
±k_≤
->
q
[
queue
].
≤
[
tid
],Ön, 
IEEE80211_CCMP_PN_LEN
);

85 
°©s
->
Êag
 |
RX_FLAG_PN_VALIDATED
;

88 
	}
}

91 
	$iwl_mvm_¸óã_skb
(
iwl_mvm
 *
mvm
, 
sk_buff
 *
skb
,

92 
õì80211_hdr
 *
hdr
, 
u16
 
Àn
, 
u8
 
¸y±_Àn
,

93 
iwl_rx_cmd_buf„r
 *
rxb
)

95 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

96 
iwl_rx_mpdu_desc
 *
desc
 = (*)
pkt
->
d©a
;

97 
hódÀn
, 
‰agÀn
, 
∑d_Àn
 = 0;

98 
hdæí
 = 
	`õì80211_hdæí
(
hdr
->
‰ame_c⁄åﬁ
);

99 
u8
 
mic_¸c_Àn
 = 
	`u8_gë_bôs
(
desc
->
mac_Êags1
,

100 
IWL_RX_MPDU_MFLG1_MIC_CRC_LEN_MASK
) << 1;

102 i‡(
desc
->
mac_Êags2
 & 
IWL_RX_MPDU_MFLG2_PAD
) {

103 
Àn
 -= 2;

104 
∑d_Àn
 = 2;

113 i‡(
Àn
 > 
mic_¸c_Àn
 && !
	`õì80211_hw_check
(
mvm
->
hw
, 
RX_INCLUDES_FCS
))

114 
Àn
 -
mic_¸c_Àn
;

128 
hódÀn
 = (
Àn
 <
	`skb_èûroom
(
skb
)) ?Üen :

129 
hdæí
 + 
¸y±_Àn
 + 8;

136 
hdæí
 +
¸y±_Àn
;

138 i‡(
	`u∆ikñy
(
hódÀn
 < 
hdæí
))

139  -
EINVAL
;

144 
	`skb_£t_mac_hódî
(
skb
, skb->
Àn
);

145 
	`skb_put_d©a
(
skb
, 
hdr
, 
hdæí
);

146 
	`skb_put_d©a
(
skb
, (
u8
 *)
hdr
 + 
hdæí
 + 
∑d_Àn
, 
hódÀn
 - hdrlen);

159 i‡(
skb
->
ù_summed
 =
CHECKSUM_COMPLETE
) {

161 
u8
 
hdr
[6];

162 
__be16
 
ty≥
;

163 } 
__∑cked
 *
shdr
 = (*)((
u8
 *)
hdr
 + 
hdæí
 + 
∑d_Àn
);

165 i‡(
	`u∆ikñy
(
hódÀn
 - 
hdæí
 < (*
shdr
) ||

166 !
	`ëhî_addr_equÆ
(
shdr
->
hdr
, 
rfc1042_hódî
) ||

167 (
shdr
->
ty≥
 !
	`ht⁄s
(
ETH_P_IP
) &&

168 
shdr
->
ty≥
 !
	`ht⁄s
(
ETH_P_ARP
) &&

169 
shdr
->
ty≥
 !
	`ht⁄s
(
ETH_P_IPV6
) &&

170 
shdr
->
ty≥
 !
	`ht⁄s
(
ETH_P_8021Q
) &&

171 
shdr
->
ty≥
 !
	`ht⁄s
(
ETH_P_PAE
) &&

172 
shdr
->
ty≥
 !
	`ht⁄s
(
ETH_P_TDLS
))))

173 
skb
->
ù_summed
 = 
CHECKSUM_NONE
;

174 i‡(
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 < 
IWL_DEVICE_FAMILY_BZ
)

176 
	`skb_po°push_rcsum
(
skb
, 
shdr
, (*shdr));

179 
‰agÀn
 = 
Àn
 - 
hódÀn
;

181 i‡(
‰agÀn
) {

182 
off£t
 = (
u8
 *)
hdr
 + 
hódÀn
 + 
∑d_Àn
 -

183 (
u8
 *)
	`rxb_addr
(
rxb
Ë+ 
	`rxb_off£t
(rxb);

185 
	`skb_add_rx_‰ag
(
skb
, 0, 
	`rxb_°ól_∑ge
(
rxb
), 
off£t
,

186 
‰agÀn
, 
rxb
->
åuesize
);

190 
	}
}

197 
	$iwl_mvm_ødiŸ≠_put_év
(
sk_buff
 *
skb
, 
u16
 
ty≥
, u16 
Àn
)

199 
õì80211_ødiŸ≠_év
 *
év
;

201 
év
 = 
	`skb_put
(
skb
, (*tlv));

202 
év
->
ty≥
 = 
	`˝u_to_À16
(type);

203 
év
->
Àn
 = 
	`˝u_to_À16
(len);

204  
	`skb_put_zîo
(
skb
, 
	`ALIGN
(
Àn
, 4));

205 
	}
}

207 
	$iwl_mvm_add_π≠_¢if„r_c⁄fig
(
iwl_mvm
 *
mvm
,

208 
sk_buff
 *
skb
)

210 
õì80211_rx_°©us
 *
rx_°©us
 = 
	`IEEE80211_SKB_RXCB
(
skb
);

211 
õì80211_ødiŸ≠_víd‹_c⁄ã¡
 *
ødiŸ≠
;

212 c⁄° 
u16
 
víd‹_d©a_Àn
 = (
mvm
->
cur_aid
);

214 i‡(!
mvm
->
cur_aid
)

217 
ødiŸ≠
 = 
	`iwl_mvm_ødiŸ≠_put_év
(
skb
,

218 
IEEE80211_RADIOTAP_VENDOR_NAMESPACE
,

219 (*
ødiŸ≠
Ë+ 
víd‹_d©a_Àn
);

222 
ødiŸ≠
->
oui
[0] = 0xf6;

223 
ødiŸ≠
->
oui
[1] = 0x54;

224 
ødiŸ≠
->
oui
[2] = 0x25;

226 
ødiŸ≠
->
oui_subty≥
 = 1;

227 
ødiŸ≠
->
víd‹_ty≥
 = 0;

230 
	`mem˝y
(
ødiŸ≠
->
d©a
, &
mvm
->
cur_aid
, (mvm->cur_aid));

232 
rx_°©us
->
Êag
 |
RX_FLAG_RADIOTAP_TLV_AT_END
;

233 
	}
}

236 
	$iwl_mvm_∑ss_∑ckë_to_mac80211
(
iwl_mvm
 *
mvm
,

237 
«pi_°ru˘
 *
«pi
,

238 
sk_buff
 *
skb
, 
queue
,

239 
õì80211_°a
 *
°a
)

241 i‡(
	`u∆ikñy
(
	`iwl_mvm_check_≤
(
mvm
, 
skb
, 
queue
, 
°a
))) {

242 
	`k‰ì_skb
(
skb
);

246 
	`õì80211_rx_«pi
(
mvm
->
hw
, 
°a
, 
skb
, 
«pi
);

247 
	}
}

249 
	$iwl_mvm_gë_sig«l_°ªngth
(
iwl_mvm
 *
mvm
,

250 
õì80211_rx_°©us
 *
rx_°©us
,

251 
u32
 
øã_n_Êags
, 
íîgy_a
,

252 
íîgy_b
)

254 
max_íîgy
;

255 
u32
 
øã_Êags
 = 
øã_n_Êags
;

257 
íîgy_a
 =É√rgy_®? -íîgy_®: 
S8_MIN
;

258 
íîgy_b
 =É√rgy_b ? -íîgy_b : 
S8_MIN
;

259 
max_íîgy
 = 
	`max
(
íîgy_a
, 
íîgy_b
);

261 
	`IWL_DEBUG_STATS
(
mvm
, "energy In A %d B %d,ánd max %d\n",

262 
íîgy_a
, 
íîgy_b
, 
max_íîgy
);

264 
rx_°©us
->
sig«l
 = 
max_íîgy
;

265 
rx_°©us
->
chaös
 =

266 (
øã_Êags
 & 
RATE_MCS_ANT_AB_MSK
Ë>> 
RATE_MCS_ANT_POS
;

267 
rx_°©us
->
chaö_sig«l
[0] = 
íîgy_a
;

268 
rx_°©us
->
chaö_sig«l
[1] = 
íîgy_b
;

269 
	}
}

271 
	$iwl_mvm_rx_mgmt_¥Ÿ
(
õì80211_°a
 *
°a
,

272 
õì80211_hdr
 *
hdr
,

273 
iwl_rx_mpdu_desc
 *
desc
,

274 
u32
 
°©us
,

275 
õì80211_rx_°©us
 *
°©s
)

277 
wúñess_dev
 *
wdev
;

278 
iwl_mvm_°a
 *
mvm°a
;

279 
iwl_mvm_vif
 *
mvmvif
;

280 
u8
 
keyid
;

281 
õì80211_key_c⁄f
 *
key
;

282 
u32
 
Àn
 = 
	`À16_to_˝u
(
desc
->
mpdu_Àn
);

283 c⁄° 
u8
 *
‰ame
 = (*)
hdr
;

285 i‡((
°©us
 & 
IWL_RX_MPDU_STATUS_SEC_MASK
Ë=
IWL_RX_MPDU_STATUS_SEC_NONE
)

296 i‡(!
	`õì80211_is_bóc⁄
(
hdr
->
‰ame_c⁄åﬁ
))

299 i‡(!
°a
)

302 
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

303 
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
mvm°a
->
vif
);

306 i‡(!(
°©us
 & 
IWL_RX_MPDU_STATUS_KEY_VALID
))

307 
ªp‹t
;

310 i‡(
	`likñy
(
°©us
 & 
IWL_RX_MPDU_STATUS_MIC_OK
 &&

311 !(
°©us
 & 
IWL_RX_MPDU_STATUS_REPLAY_ERROR
))) {

312 
°©s
->
Êag
 |
RX_FLAG_DECRYPTED
;

320 
key
 = 
	`rcu_dîe„ªn˚
(
mvmvif
->
b˙_¥Ÿ
.
keys
[0]);

321 i‡(!
key
) {

322 
key
 = 
	`rcu_dîe„ªn˚
(
mvmvif
->
b˙_¥Ÿ
.
keys
[1]);

323 i‡(!
key
)

324 
ªp‹t
;

327 i‡(
Àn
 < 
key
->
icv_Àn
 + 
IEEE80211_GMAC_PN_LEN
 + 2)

328 
ªp‹t
;

331 
keyid
 = 
‰ame
[
Àn
 - 
key
->
icv_Àn
 - 
IEEE80211_GMAC_PN_LEN
 - 2];

333 i‡(
keyid
 !
key
->
keyidx
) {

338 i‡(
keyid
 != 6 && keyid != 7)

340 
key
 = 
	`rcu_dîe„ªn˚
(
mvmvif
->
b˙_¥Ÿ
.
keys
[
keyid
 - 6]);

341 i‡(!
key
)

342 
ªp‹t
;

346 i‡(!(
°©us
 & 
IWL_RX_MPDU_STATUS_MIC_OK
))

347 
	`õì80211_key_mic_Áûuª
(
key
);

348 i‡(
°©us
 & 
IWL_RX_MPDU_STATUS_REPLAY_ERROR
)

349 
	`õì80211_key_ª∂ay
(
key
);

350 
ªp‹t
:

351 
wdev
 = 
	`õì80211_vif_to_wdev
(
mvm°a
->
vif
);

352 i‡(
wdev
->
√tdev
)

353 
	`cfg80211_rx_u≈rŸ_mlme_mgmt
(
wdev
->
√tdev
, (*)
hdr
, 
Àn
);

356 
	}
}

358 
	$iwl_mvm_rx_¸y±o
(
iwl_mvm
 *
mvm
, 
õì80211_°a
 *
°a
,

359 
õì80211_hdr
 *
hdr
,

360 
õì80211_rx_°©us
 *
°©s
, 
u16
 
phy_öfo
,

361 
iwl_rx_mpdu_desc
 *
desc
,

362 
u32
 
pkt_Êags
, 
queue
, 
u8
 *
¸y±_Àn
)

364 
u32
 
°©us
 = 
	`À32_to_˝u
(
desc
->status);

373 i‡(
phy_öfo
 & 
IWL_RX_MPDU_PHY_AMPDU
 &&

374 (
°©us
 & 
IWL_RX_MPDU_STATUS_SEC_MASK
) ==

375 
IWL_RX_MPDU_STATUS_SEC_UNKNOWN
 && !
mvm
->
m⁄ô‹_⁄
) {

376 
	`IWL_DEBUG_DROP
(
mvm
, "DroppingÖackets, badÉnc status\n");

380 i‡(
	`u∆ikñy
(
	`õì80211_is_mgmt
(
hdr
->
‰ame_c⁄åﬁ
) &&

381 !
	`õì80211_has_¥Ÿe˘ed
(
hdr
->
‰ame_c⁄åﬁ
)))

382  
	`iwl_mvm_rx_mgmt_¥Ÿ
(
°a
, 
hdr
, 
desc
, 
°©us
, 
°©s
);

384 i‡(!
	`õì80211_has_¥Ÿe˘ed
(
hdr
->
‰ame_c⁄åﬁ
) ||

385 (
°©us
 & 
IWL_RX_MPDU_STATUS_SEC_MASK
) ==

386 
IWL_RX_MPDU_STATUS_SEC_NONE
)

391 
°©us
 & 
IWL_RX_MPDU_STATUS_SEC_MASK
) {

392 
IWL_RX_MPDU_STATUS_SEC_CCM
:

393 
IWL_RX_MPDU_STATUS_SEC_GCM
:

394 
	`BUILD_BUG_ON
(
IEEE80211_CCMP_PN_LEN
 !
IEEE80211_GCMP_PN_LEN
);

396 i‡(!(
°©us
 & 
IWL_RX_MPDU_STATUS_MIC_OK
)) {

397 
	`IWL_DEBUG_DROP
(
mvm
,

402 
°©s
->
Êag
 |
RX_FLAG_DECRYPTED
 | 
RX_FLAG_MIC_STRIPPED
;

403 *
¸y±_Àn
 = 
IEEE80211_CCMP_HDR_LEN
;

405 
IWL_RX_MPDU_STATUS_SEC_TKIP
:

407 i‡(!
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

408 
IWL_UCODE_TLV_API_DEPRECATE_TTAK
) &&

409 !(
°©us
 & 
IWL_RX_MPDU_RES_STATUS_TTAK_OK
))

412 i‡(
mvm
->
å™s
->
å™s_cfg
->
gí2
 &&

413 !(
°©us
 & 
RX_MPDU_RES_STATUS_MIC_OK
))

414 
°©s
->
Êag
 |
RX_FLAG_MMIC_ERROR
;

416 *
¸y±_Àn
 = 
IEEE80211_TKIP_IV_LEN
;

417 
ÁŒthrough
;

418 
IWL_RX_MPDU_STATUS_SEC_WEP
:

419 i‡(!(
°©us
 & 
IWL_RX_MPDU_STATUS_ICV_OK
))

422 
°©s
->
Êag
 |
RX_FLAG_DECRYPTED
;

423 i‡((
°©us
 & 
IWL_RX_MPDU_STATUS_SEC_MASK
) ==

424 
IWL_RX_MPDU_STATUS_SEC_WEP
)

425 *
¸y±_Àn
 = 
IEEE80211_WEP_IV_LEN
;

427 i‡(
pkt_Êags
 & 
FH_RSCSR_RADA_EN
) {

428 
°©s
->
Êag
 |
RX_FLAG_ICV_STRIPPED
;

429 i‡(
mvm
->
å™s
->
å™s_cfg
->
gí2
)

430 
°©s
->
Êag
 |
RX_FLAG_MMIC_STRIPPED
;

434 
IWL_RX_MPDU_STATUS_SEC_EXT_ENC
:

435 i‡(!(
°©us
 & 
IWL_RX_MPDU_STATUS_MIC_OK
))

437 
°©s
->
Êag
 |
RX_FLAG_DECRYPTED
;

439 
RX_MPDU_RES_STATUS_SEC_CMAC_GMAC_ENC
:

450 i‡(!
	`is_mu…iˇ°_ëhî_addr
(
hdr
->
addr1
) &&

451 !
mvm
->
m⁄ô‹_⁄
 && 
	`√t_øãlimô
())

452 
	`IWL_WARN
(
mvm
, "Unh™dÀdálg: 0x%x\n", 
°©us
);

456 
	}
}

458 
	$iwl_mvm_rx_csum
(
iwl_mvm
 *
mvm
,

459 
õì80211_°a
 *
°a
,

460 
sk_buff
 *
skb
,

461 
iwl_rx_∑ckë
 *
pkt
)

463 
iwl_rx_mpdu_desc
 *
desc
 = (*)
pkt
->
d©a
;

465 i‡(
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 >
IWL_DEVICE_FAMILY_AX210
) {

466 i‡(
pkt
->
Àn_n_Êags
 & 
	`˝u_to_À32
(
FH_RSCSR_RPA_EN
)) {

467 
u16
 
hwsum
 = 
	`be16_to_˝u
(
desc
->
v3
.
øw_xsum
);

469 
skb
->
ù_summed
 = 
CHECKSUM_COMPLETE
;

470 
skb
->
csum
 = 
	`csum_unfﬁd
(~(
__f‹˚
 
__sum16
)
hwsum
);

473 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

474 
iwl_mvm_vif
 *
mvmvif
;

475 
u16
 
Êags
 = 
	`À16_to_˝u
(
desc
->
l3l4_Êags
);

476 
u8
 
l3_¥Ÿ
 = (u8)((
Êags
 & 
IWL_RX_L3L4_L3_PROTO_MASK
) >>

477 
IWL_RX_L3_PROTO_POS
);

479 
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
mvm°a
->
vif
);

481 i‡(
mvmvif
->
„©uªs
 & 
NETIF_F_RXCSUM
 &&

482 
Êags
 & 
IWL_RX_L3L4_TCP_UDP_CSUM_OK
 &&

483 (
Êags
 & 
IWL_RX_L3L4_IP_HDR_CSUM_OK
 ||

484 
l3_¥Ÿ
 =
IWL_RX_L3_TYPE_IPV6
 ||

485 
l3_¥Ÿ
 =
IWL_RX_L3_TYPE_IPV6_FRAG
))

486 
skb
->
ù_summed
 = 
CHECKSUM_UNNECESSARY
;

488 
	}
}

494 
boﬁ
 
	$iwl_mvm_is_dup
(
õì80211_°a
 *
°a
, 
queue
,

495 
õì80211_rx_°©us
 *
rx_°©us
,

496 
õì80211_hdr
 *
hdr
,

497 
iwl_rx_mpdu_desc
 *
desc
)

499 
iwl_mvm_°a
 *
mvm_°a
;

500 
iwl_mvm_rxq_dup_d©a
 *
dup_d©a
;

501 
u8
 
tid
, 
sub_‰ame_idx
;

503 i‡(
	`WARN_ON
(
	`IS_ERR_OR_NULL
(
°a
)))

504  
Ál£
;

506 
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

508 i‡(
	`WARN_ON_ONCE
(!
mvm_°a
->
dup_d©a
))

509  
Ál£
;

511 
dup_d©a
 = &
mvm_°a
->dup_d©a[
queue
];

517 i‡(
	`õì80211_is_˘l
(
hdr
->
‰ame_c⁄åﬁ
) ||

518 
	`õì80211_is_™y_nuŒfunc
(
hdr
->
‰ame_c⁄åﬁ
) ||

519 
	`is_mu…iˇ°_ëhî_addr
(
hdr
->
addr1
))

520  
Ál£
;

522 i‡(
	`õì80211_is_d©a_qos
(
hdr
->
‰ame_c⁄åﬁ
)) {

524 
tid
 = 
	`õì80211_gë_tid
(
hdr
);

525 i‡(
tid
 >
IWL_MAX_TID_COUNT
)

526  
åue
;

528 
tid
 = 
IWL_MAX_TID_COUNT
;

532 
sub_‰ame_idx
 = 
desc
->
amsdu_öfo
 &

533 
IWL_RX_MPDU_AMSDU_SUBFRAME_IDX_MASK
;

535 i‡(
	`u∆ikñy
(
	`õì80211_has_ªåy
(
hdr
->
‰ame_c⁄åﬁ
) &&

536 
dup_d©a
->
œ°_£q
[
tid
] =
hdr
->
£q_˘æ
 &&

537 
dup_d©a
->
œ°_sub_‰ame
[
tid
] >
sub_‰ame_idx
))

538  
åue
;

541 i‡(
dup_d©a
->
œ°_£q
[
tid
] =
hdr
->
£q_˘æ
 &&

542 
sub_‰ame_idx
 > 
dup_d©a
->
œ°_sub_‰ame
[
tid
] &&

543 
desc
->
mac_Êags2
 & 
IWL_RX_MPDU_MFLG2_AMSDU
)

544 
rx_°©us
->
Êag
 |
RX_FLAG_ALLOW_SAME_PN
;

546 
dup_d©a
->
œ°_£q
[
tid
] = 
hdr
->
£q_˘æ
;

547 
dup_d©a
->
œ°_sub_‰ame
[
tid
] = 
sub_‰ame_idx
;

549 
rx_°©us
->
Êag
 |
RX_FLAG_DUP_VALIDATED
;

551  
Ál£
;

552 
	}
}

554 
	$iwl_mvm_ªÀa£_‰ames
(
iwl_mvm
 *
mvm
,

555 
õì80211_°a
 *
°a
,

556 
«pi_°ru˘
 *
«pi
,

557 
iwl_mvm_baid_d©a
 *
baid_d©a
,

558 
iwl_mvm_ª‹dî_buf„r
 *
ª‹dî_buf
,

559 
u16
 
ns¢
)

561 
iwl_mvm_ª‹dî_buf_íåy
 *
íåõs
 =

562 &
baid_d©a
->
íåõs
[
ª‹dî_buf
->
queue
 *

563 
baid_d©a
->
íåõs_≥r_queue
];

564 
u16
 
s¢
 = 
ª‹dî_buf
->
hód_¢
;

566 
	`lockdï_as£π_hñd
(&
ª‹dî_buf
->
lock
);

568 
	`õì80211_¢_Àss
(
s¢
, 
ns¢
)) {

569 
ödex
 = 
s¢
 % 
ª‹dî_buf
->
buf_size
;

570 
sk_buff_hód
 *
skb_li°
 = &
íåõs
[
ödex
].
‰ames
;

571 
sk_buff
 *
skb
;

573 
s¢
 = 
	`õì80211_¢_öc
(ssn);

580 (
skb
 = 
	`__skb_dequeue
(
skb_li°
))) {

581 
	`iwl_mvm_∑ss_∑ckë_to_mac80211
(
mvm
, 
«pi
, 
skb
,

582 
ª‹dî_buf
->
queue
,

583 
°a
);

584 
ª‹dî_buf
->
num_°‹ed
--;

587 
ª‹dî_buf
->
hód_¢
 = 
ns¢
;

588 
	}
}

590 
	$iwl_mvm_dñ_ba
(
iwl_mvm
 *
mvm
, 
queue
,

591 
iwl_mvm_dñba_d©a
 *
d©a
)

593 
iwl_mvm_baid_d©a
 *
ba_d©a
;

594 
õì80211_°a
 *
°a
;

595 
iwl_mvm_ª‹dî_buf„r
 *
ª‹dî_buf
;

596 
u8
 
baid
 = 
d©a
->baid;

597 
u32
 
°a_id
;

599 i‡(
	`WARN_ONCE
(
baid
 >
IWL_MAX_BAID
, "invalid BAID: %x\n", baid))

602 
	`rcu_ªad_lock
();

604 
ba_d©a
 = 
	`rcu_dîe„ªn˚
(
mvm
->
baid_m≠
[
baid
]);

605 i‡(
	`WARN_ON_ONCE
(!
ba_d©a
))

606 
out
;

609 
°a_id
 = 
	`ffs
(
ba_d©a
->
°a_mask
) - 1;

610 
°a
 = 
	`rcu_dîe„ªn˚
(
mvm
->
fw_id_to_mac_id
[
°a_id
]);

611 i‡(
	`WARN_ON_ONCE
(
	`IS_ERR_OR_NULL
(
°a
)))

612 
out
;

614 
ª‹dî_buf
 = &
ba_d©a
->ª‹dî_buf[
queue
];

617 
	`•ö_lock_bh
(&
ª‹dî_buf
->
lock
);

618 
	`iwl_mvm_ªÀa£_‰ames
(
mvm
, 
°a
, 
NULL
, 
ba_d©a
, 
ª‹dî_buf
,

619 
	`õì80211_¢_add
(
ª‹dî_buf
->
hód_¢
,

620 
ª‹dî_buf
->
buf_size
));

621 
	`•ö_u∆ock_bh
(&
ª‹dî_buf
->
lock
);

623 
out
:

624 
	`rcu_ªad_u∆ock
();

625 
	}
}

627 
	$iwl_mvm_ªÀa£_‰ames_‰om_nŸif
(
iwl_mvm
 *
mvm
,

628 
«pi_°ru˘
 *
«pi
,

629 
u8
 
baid
, 
u16
 
ns¢
, 
queue
)

631 
õì80211_°a
 *
°a
;

632 
iwl_mvm_ª‹dî_buf„r
 *
ª‹dî_buf
;

633 
iwl_mvm_baid_d©a
 *
ba_d©a
;

634 
u32
 
°a_id
;

636 
	`IWL_DEBUG_HT
(
mvm
, "FrameÑeleaseÇotification for BAID %u, NSSN %d\n",

637 
baid
, 
ns¢
);

639 i‡(
	`WARN_ON_ONCE
(
baid
 =
IWL_RX_REORDER_DATA_INVALID_BAID
 ||

640 
baid
 >
	`ARRAY_SIZE
(
mvm
->
baid_m≠
)))

643 
	`rcu_ªad_lock
();

645 
ba_d©a
 = 
	`rcu_dîe„ªn˚
(
mvm
->
baid_m≠
[
baid
]);

646 i‡(
	`WARN
(!
ba_d©a
, "BAID %dÇŸ found i¿m≠\n", 
baid
))

647 
out
;

650 
°a_id
 = 
	`ffs
(
ba_d©a
->
°a_mask
) - 1;

651 
°a
 = 
	`rcu_dîe„ªn˚
(
mvm
->
fw_id_to_mac_id
[
°a_id
]);

652 i‡(
	`WARN_ON_ONCE
(
	`IS_ERR_OR_NULL
(
°a
)))

653 
out
;

655 
ª‹dî_buf
 = &
ba_d©a
->ª‹dî_buf[
queue
];

657 
	`•ö_lock_bh
(&
ª‹dî_buf
->
lock
);

658 
	`iwl_mvm_ªÀa£_‰ames
(
mvm
, 
°a
, 
«pi
, 
ba_d©a
,

659 
ª‹dî_buf
, 
ns¢
);

660 
	`•ö_u∆ock_bh
(&
ª‹dî_buf
->
lock
);

662 
out
:

663 
	`rcu_ªad_u∆ock
();

664 
	}
}

666 
	$iwl_mvm_rx_queue_nŸif
(
iwl_mvm
 *
mvm
, 
«pi_°ru˘
 *
«pi
,

667 
iwl_rx_cmd_buf„r
 *
rxb
, 
queue
)

669 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

670 
iwl_rxq_sync_nŸifiˇti⁄
 *
nŸif
;

671 
iwl_mvm_öã∫Æ_rxq_nŸif
 *
öã∫Æ_nŸif
;

672 
u32
 
Àn
 = 
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
);

674 
nŸif
 = (*)
pkt
->
d©a
;

675 
öã∫Æ_nŸif
 = (*)
nŸif
->
∑ylﬂd
;

677 i‡(
	`WARN_ONCE
(
Àn
 < (*
nŸif
Ë+ (*
öã∫Æ_nŸif
),

679 
Àn
, ()((*
nŸif
Ë+ (*
öã∫Æ_nŸif
))))

681 
Àn
 -(*
nŸif
Ë+ (*
öã∫Æ_nŸif
);

683 i‡(
	`WARN_ONCE
(
öã∫Æ_nŸif
->
sync
 &&

684 
mvm
->
queue_sync_cookõ
 !
öã∫Æ_nŸif
->
cookõ
,

686 
öã∫Æ_nŸif
->
cookõ
, 
mvm
->
queue_sync_cookõ
, 
queue
))

689 
öã∫Æ_nŸif
->
ty≥
) {

690 
IWL_MVM_RXQ_EMPTY
:

691 
	`WARN_ONCE
(
Àn
, "invalidÉmptyÇotification size %d",Üen);

693 
IWL_MVM_RXQ_NOTIF_DEL_BA
:

694 i‡(
	`WARN_ONCE
(
Àn
 !(
iwl_mvm_dñba_d©a
),

696 
Àn
, ()(
iwl_mvm_dñba_d©a
)))

698 
	`iwl_mvm_dñ_ba
(
mvm
, 
queue
, (*)
öã∫Æ_nŸif
->
d©a
);

701 
	`WARN_ONCE
(1, "InvÆid idítifõ∏%d", 
öã∫Æ_nŸif
->
ty≥
);

704 i‡(
öã∫Æ_nŸif
->
sync
) {

705 
	`WARN_ONCE
(!
	`ã°_™d_˛ór_bô
(
queue
, &
mvm
->
queue_sync_°©e
),

707 
queue
);

708 i‡(
	`READ_ONCE
(
mvm
->
queue_sync_°©e
) == 0)

709 
	`wake_up
(&
mvm
->
rx_sync_waôq
);

711 
	}
}

717 
boﬁ
 
	$iwl_mvm_ª‹dî
(
iwl_mvm
 *
mvm
,

718 
«pi_°ru˘
 *
«pi
,

719 
queue
,

720 
õì80211_°a
 *
°a
,

721 
sk_buff
 *
skb
,

722 
iwl_rx_mpdu_desc
 *
desc
)

724 
õì80211_hdr
 *
hdr
 = (*)
	`skb_mac_hódî
(
skb
);

725 
iwl_mvm_baid_d©a
 *
baid_d©a
;

726 
iwl_mvm_ª‹dî_buf„r
 *
buf„r
;

727 
u32
 
ª‹dî
 = 
	`À32_to_˝u
(
desc
->
ª‹dî_d©a
);

728 
boﬁ
 
amsdu
 = 
desc
->
mac_Êags2
 & 
IWL_RX_MPDU_MFLG2_AMSDU
;

729 
boﬁ
 
œ°_sub‰ame
 =

730 
desc
->
amsdu_öfo
 & 
IWL_RX_MPDU_AMSDU_LAST_SUBFRAME
;

731 
u8
 
tid
 = 
	`õì80211_gë_tid
(
hdr
);

732 
u8
 
sub_‰ame_idx
 = 
desc
->
amsdu_öfo
 &

733 
IWL_RX_MPDU_AMSDU_SUBFRAME_IDX_MASK
;

734 
iwl_mvm_ª‹dî_buf_íåy
 *
íåõs
;

735 
u32
 
°a_mask
;

736 
ödex
;

737 
u16
 
ns¢
, 
¢
;

738 
u8
 
baid
;

740 
baid
 = (
ª‹dî
 & 
IWL_RX_MPDU_REORDER_BAID_MASK
) >>

741 
IWL_RX_MPDU_REORDER_BAID_SHIFT
;

743 i‡(
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 =
IWL_DEVICE_FAMILY_9000
)

744  
Ál£
;

753 i‡(
baid
 =
IWL_RX_REORDER_DATA_INVALID_BAID
)

754  
Ál£
;

757 i‡(
	`WARN_ONCE
(
	`IS_ERR_OR_NULL
(
°a
),

759  
Ál£
;

762 i‡(!
	`õì80211_is_back_ªq
(
hdr
->
‰ame_c⁄åﬁ
) &&

763 (!
	`õì80211_is_d©a_qos
(
hdr
->
‰ame_c⁄åﬁ
) ||

764 
	`is_mu…iˇ°_ëhî_addr
(
hdr
->
addr1
)))

765  
Ál£
;

767 i‡(
	`u∆ikñy
(!
	`õì80211_is_d©a_¥e£¡
(
hdr
->
‰ame_c⁄åﬁ
)))

768  
Ál£
;

770 
baid_d©a
 = 
	`rcu_dîe„ªn˚
(
mvm
->
baid_m≠
[
baid
]);

771 i‡(!
baid_d©a
) {

772 
	`IWL_DEBUG_RX
(
mvm
,

774 
baid
, 
ª‹dî
);

775  
Ál£
;

778 
	`rcu_ªad_lock
();

779 
°a_mask
 = 
	`iwl_mvm_°a_fw_id_mask
(
mvm
, 
°a
, -1);

780 
	`rcu_ªad_u∆ock
();

782 i‡(
	`IWL_FW_CHECK
(
mvm
,

783 
tid
 !
baid_d©a
->tid ||

784 !(
°a_mask
 & 
baid_d©a
->sta_mask),

786 
baid
, 
baid_d©a
->
°a_mask
, baid_d©a->
tid
,

787 
°a_mask
, 
tid
))

788  
Ál£
;

790 
ns¢
 = 
ª‹dî
 & 
IWL_RX_MPDU_REORDER_NSSN_MASK
;

791 
¢
 = (
ª‹dî
 & 
IWL_RX_MPDU_REORDER_SN_MASK
) >>

792 
IWL_RX_MPDU_REORDER_SN_SHIFT
;

794 
buf„r
 = &
baid_d©a
->
ª‹dî_buf
[
queue
];

795 
íåõs
 = &
baid_d©a
->íåõs[
queue
 * baid_d©a->
íåõs_≥r_queue
];

797 
	`•ö_lock_bh
(&
buf„r
->
lock
);

799 i‡(!
buf„r
->
vÆid
) {

800 i‡(
ª‹dî
 & 
IWL_RX_MPDU_REORDER_BA_OLD_SN
) {

801 
	`•ö_u∆ock_bh
(&
buf„r
->
lock
);

802  
Ál£
;

804 
buf„r
->
vÆid
 = 
åue
;

808 i‡(
desc
->
°©us
 & 
	`˝u_to_À32
(
IWL_RX_MPDU_STATUS_DUPLICATE
))

809 
dr›
;

812 i‡(
ª‹dî
 & 
IWL_RX_MPDU_REORDER_BA_OLD_SN
)

813 
dr›
;

816 i‡(!
buf„r
->
num_°‹ed
 && 
	`õì80211_¢_Àss
(
¢
, 
ns¢
)) {

817 i‡(!
amsdu
 || 
œ°_sub‰ame
)

818 
buf„r
->
hód_¢
 = 
ns¢
;

820 
	`•ö_u∆ock_bh
(&
buf„r
->
lock
);

821  
Ál£
;

832 i‡(!
buf„r
->
num_°‹ed
 && 
¢
 =buf„r->
hód_¢
) {

833 i‡(!
amsdu
 || 
œ°_sub‰ame
)

834 
buf„r
->
hód_¢
 = 
	`õì80211_¢_öc
(buffer->head_sn);

837 
	`•ö_u∆ock_bh
(&
buf„r
->
lock
);

838  
Ál£
;

842 
ödex
 = 
¢
 % 
buf„r
->
buf_size
;

843 
	`__skb_queue_èû
(&
íåõs
[
ödex
].
‰ames
, 
skb
);

844 
buf„r
->
num_°‹ed
++;

846 i‡(
amsdu
) {

847 
buf„r
->
œ°_amsdu
 = 
¢
;

848 
buf„r
->
œ°_sub_ödex
 = 
sub_‰ame_idx
;

862 i‡(!
amsdu
 || 
œ°_sub‰ame
)

863 
	`iwl_mvm_ªÀa£_‰ames
(
mvm
, 
°a
, 
«pi
, 
baid_d©a
,

864 
buf„r
, 
ns¢
);

866 
	`•ö_u∆ock_bh
(&
buf„r
->
lock
);

867  
åue
;

869 
dr›
:

870 
	`k‰ì_skb
(
skb
);

871 
	`•ö_u∆ock_bh
(&
buf„r
->
lock
);

872  
åue
;

873 
	}
}

875 
	$iwl_mvm_agg_rx_ª˚ived
(
iwl_mvm
 *
mvm
,

876 
u32
 
ª‹dî_d©a
, 
u8
 
baid
)

878 
now
 = 
jiffõs
;

879 
timeout
;

880 
iwl_mvm_baid_d©a
 *
d©a
;

882 
	`rcu_ªad_lock
();

884 
d©a
 = 
	`rcu_dîe„ªn˚
(
mvm
->
baid_m≠
[
baid
]);

885 i‡(!
d©a
) {

886 
	`IWL_DEBUG_RX
(
mvm
,

888 
baid
, 
ª‹dî_d©a
);

889 
out
;

892 i‡(!
d©a
->
timeout
)

893 
out
;

895 
timeout
 = 
d©a
->timeout;

902 i‡(
	`time_bef‹e
(
d©a
->
œ°_rx
 + 
	`TU_TO_JIFFIES
(
timeout
), 
now
))

904 
d©a
->
œ°_rx
 = 
now
;

906 
out
:

907 
	`rcu_ªad_u∆ock
();

908 
	}
}

910 
	$iwl_mvm_Êù_addªss
(
u8
 *
addr
)

912 
i
;

913 
u8
 
mac_addr
[
ETH_ALEN
];

915 
i
 = 0; i < 
ETH_ALEN
; i++)

916 
mac_addr
[
i
] = 
addr
[
ETH_ALEN
 - i - 1];

917 
	`ëhî_addr_c›y
(
addr
, 
mac_addr
);

918 
	}
}

920 
	siwl_mvm_rx_phy_d©a
 {

921 
iwl_rx_phy_öfo_ty≥
 
	möfo_ty≥
;

922 
__À32
 
	md0
, 
	md1
, 
	md2
, 
	md3
, 
	meht_d4
, 
	md5
;

923 
__À16
 
	md4
;

924 
boﬁ
 
	mwôh_d©a
;

925 
boﬁ
 
	mfú°_sub‰ame
;

926 
__À32
 
	mrx_vec
[4];

928 
u32
 
	møã_n_Êags
;

929 
u32
 
	mgp2_⁄_aú_ri£
;

930 
u16
 
	mphy_öfo
;

931 
u8
 
	míîgy_a
, 
	míîgy_b
;

932 
u8
 
	mch™√l
;

935 
	$iwl_mvm_decode_he_mu_ext
(
iwl_mvm
 *
mvm
,

936 
iwl_mvm_rx_phy_d©a
 *
phy_d©a
,

937 
õì80211_ødiŸ≠_he_mu
 *
he_mu
)

939 
u32
 
phy_d©a2
 = 
	`À32_to_˝u
(
phy_d©a
->
d2
);

940 
u32
 
phy_d©a3
 = 
	`À32_to_˝u
(
phy_d©a
->
d3
);

941 
u16
 
phy_d©a4
 = 
	`À16_to_˝u
(
phy_d©a
->
d4
);

942 
u32
 
øã_n_Êags
 = 
phy_d©a
->rate_n_flags;

944 i‡(
	`FIELD_GET
(
IWL_RX_PHY_DATA4_HE_MU_EXT_CH1_CRC_OK
, 
phy_d©a4
)) {

945 
he_mu
->
Êags1
 |=

946 
	`˝u_to_À16
(
IEEE80211_RADIOTAP_HE_MU_FLAGS1_CH1_RU_KNOWN
 |

947 
IEEE80211_RADIOTAP_HE_MU_FLAGS1_CH1_CTR_26T_RU_KNOWN
);

949 
he_mu
->
Êags1
 |=

950 
	`À16_ícode_bôs
(
	`FIELD_GET
(
IWL_RX_PHY_DATA4_HE_MU_EXT_CH1_CTR_RU
,

951 
phy_d©a4
),

952 
IEEE80211_RADIOTAP_HE_MU_FLAGS1_CH1_CTR_26T_RU
);

954 
he_mu
->
ru_ch1
[0] = 
	`FIELD_GET
(
IWL_RX_PHY_DATA2_HE_MU_EXT_CH1_RU0
,

955 
phy_d©a2
);

956 
he_mu
->
ru_ch1
[1] = 
	`FIELD_GET
(
IWL_RX_PHY_DATA3_HE_MU_EXT_CH1_RU1
,

957 
phy_d©a3
);

958 
he_mu
->
ru_ch1
[2] = 
	`FIELD_GET
(
IWL_RX_PHY_DATA2_HE_MU_EXT_CH1_RU2
,

959 
phy_d©a2
);

960 
he_mu
->
ru_ch1
[3] = 
	`FIELD_GET
(
IWL_RX_PHY_DATA3_HE_MU_EXT_CH1_RU3
,

961 
phy_d©a3
);

964 i‡(
	`FIELD_GET
(
IWL_RX_PHY_DATA4_HE_MU_EXT_CH2_CRC_OK
, 
phy_d©a4
) &&

965 (
øã_n_Êags
 & 
RATE_MCS_CHAN_WIDTH_MSK_V1
Ë!
RATE_MCS_CHAN_WIDTH_20
) {

966 
he_mu
->
Êags1
 |=

967 
	`˝u_to_À16
(
IEEE80211_RADIOTAP_HE_MU_FLAGS1_CH2_RU_KNOWN
 |

968 
IEEE80211_RADIOTAP_HE_MU_FLAGS1_CH2_CTR_26T_RU_KNOWN
);

970 
he_mu
->
Êags2
 |=

971 
	`À16_ícode_bôs
(
	`FIELD_GET
(
IWL_RX_PHY_DATA4_HE_MU_EXT_CH2_CTR_RU
,

972 
phy_d©a4
),

973 
IEEE80211_RADIOTAP_HE_MU_FLAGS2_CH2_CTR_26T_RU
);

975 
he_mu
->
ru_ch2
[0] = 
	`FIELD_GET
(
IWL_RX_PHY_DATA2_HE_MU_EXT_CH2_RU0
,

976 
phy_d©a2
);

977 
he_mu
->
ru_ch2
[1] = 
	`FIELD_GET
(
IWL_RX_PHY_DATA3_HE_MU_EXT_CH2_RU1
,

978 
phy_d©a3
);

979 
he_mu
->
ru_ch2
[2] = 
	`FIELD_GET
(
IWL_RX_PHY_DATA2_HE_MU_EXT_CH2_RU2
,

980 
phy_d©a2
);

981 
he_mu
->
ru_ch2
[3] = 
	`FIELD_GET
(
IWL_RX_PHY_DATA3_HE_MU_EXT_CH2_RU3
,

982 
phy_d©a3
);

984 
	}
}

987 
	$iwl_mvm_decode_he_phy_ru_Æloc
(
iwl_mvm_rx_phy_d©a
 *
phy_d©a
,

988 
õì80211_ødiŸ≠_he
 *
he
,

989 
õì80211_ødiŸ≠_he_mu
 *
he_mu
,

990 
õì80211_rx_°©us
 *
rx_°©us
)

1000 
u8
 
ru
 = 
	`À32_gë_bôs
(
phy_d©a
->
d1
, 
IWL_RX_PHY_DATA1_HE_RU_ALLOC_MASK
);

1001 
u32
 
øã_n_Êags
 = 
phy_d©a
->rate_n_flags;

1002 
u32
 
he_ty≥
 = 
øã_n_Êags
 & 
RATE_MCS_HE_TYPE_MSK_V1
;

1003 
u8
 
offs
 = 0;

1005 
rx_°©us
->
bw
 = 
RATE_INFO_BW_HE_RU
;

1007 
he
->
d©a1
 |
	`˝u_to_À16
(
IEEE80211_RADIOTAP_HE_DATA1_BW_RU_ALLOC_KNOWN
);

1009 
ru
) {

1011 
rx_°©us
->
he_ru
 = 
NL80211_RATE_INFO_HE_RU_ALLOC_26
;

1012 
offs
 = 
ru
;

1015 
rx_°©us
->
he_ru
 = 
NL80211_RATE_INFO_HE_RU_ALLOC_52
;

1016 
offs
 = 
ru
 - 37;

1019 
rx_°©us
->
he_ru
 = 
NL80211_RATE_INFO_HE_RU_ALLOC_106
;

1020 
offs
 = 
ru
 - 53;

1023 
rx_°©us
->
he_ru
 = 
NL80211_RATE_INFO_HE_RU_ALLOC_242
;

1024 
offs
 = 
ru
 - 61;

1027 
rx_°©us
->
he_ru
 = 
NL80211_RATE_INFO_HE_RU_ALLOC_484
;

1028 
offs
 = 
ru
 - 65;

1031 
rx_°©us
->
he_ru
 = 
NL80211_RATE_INFO_HE_RU_ALLOC_996
;

1034 
rx_°©us
->
he_ru
 = 
NL80211_RATE_INFO_HE_RU_ALLOC_2x996
;

1037 
he
->
d©a2
 |
	`À16_ícode_bôs
(
offs
,

1038 
IEEE80211_RADIOTAP_HE_DATA2_RU_OFFSET
);

1039 
he
->
d©a2
 |
	`˝u_to_À16
(
IEEE80211_RADIOTAP_HE_DATA2_PRISEC_80_KNOWN
 |

1040 
IEEE80211_RADIOTAP_HE_DATA2_RU_OFFSET_KNOWN
);

1041 i‡(
phy_d©a
->
d1
 & 
	`˝u_to_À32
(
IWL_RX_PHY_DATA1_HE_RU_ALLOC_SEC80
))

1042 
he
->
d©a2
 |=

1043 
	`˝u_to_À16
(
IEEE80211_RADIOTAP_HE_DATA2_PRISEC_80_SEC
);

1045 
	#CHECK_BW
(
bw
) \

1046 
	`BUILD_BUG_ON
(
IEEE80211_RADIOTAP_HE_MU_FLAGS2_BW_FROM_SIG_A_BW_
 ## 
bw
 ## 
MHZ
 != \

1047 
RATE_MCS_CHAN_WIDTH_
##
bw
 >> 
RATE_MCS_CHAN_WIDTH_POS
); \

1048 
	`BUILD_BUG_ON
(
IEEE80211_RADIOTAP_HE_DATA6_TB_PPDU_BW_
 ## 
bw
 ## 
MHZ
 != \

1049 
RATE_MCS_CHAN_WIDTH_
##
bw
 >> 
RATE_MCS_CHAN_WIDTH_POS
)

	)

1050 
	`CHECK_BW
(20);

1051 
	`CHECK_BW
(40);

1052 
	`CHECK_BW
(80);

1053 
	`CHECK_BW
(160);

1055 i‡(
he_mu
)

1056 
he_mu
->
Êags2
 |=

1057 
	`À16_ícode_bôs
(
	`FIELD_GET
(
RATE_MCS_CHAN_WIDTH_MSK_V1
,

1058 
øã_n_Êags
),

1059 
IEEE80211_RADIOTAP_HE_MU_FLAGS2_BW_FROM_SIG_A_BW
);

1060 i‡(
he_ty≥
 =
RATE_MCS_HE_TYPE_TRIG_V1
)

1061 
he
->
d©a6
 |=

1062 
	`˝u_to_À16
(
IEEE80211_RADIOTAP_HE_DATA6_TB_PPDU_BW_KNOWN
) |

1063 
	`À16_ícode_bôs
(
	`FIELD_GET
(
RATE_MCS_CHAN_WIDTH_MSK_V1
,

1064 
øã_n_Êags
),

1065 
IEEE80211_RADIOTAP_HE_DATA6_TB_PPDU_BW
);

1066 
	}
}

1068 
	$iwl_mvm_decode_he_phy_d©a
(
iwl_mvm
 *
mvm
,

1069 
iwl_mvm_rx_phy_d©a
 *
phy_d©a
,

1070 
õì80211_ødiŸ≠_he
 *
he
,

1071 
õì80211_ødiŸ≠_he_mu
 *
he_mu
,

1072 
õì80211_rx_°©us
 *
rx_°©us
,

1073 
queue
)

1075 
phy_d©a
->
öfo_ty≥
) {

1076 
IWL_RX_PHY_INFO_TYPE_NONE
:

1077 
IWL_RX_PHY_INFO_TYPE_CCK
:

1078 
IWL_RX_PHY_INFO_TYPE_OFDM_LGCY
:

1079 
IWL_RX_PHY_INFO_TYPE_HT
:

1080 
IWL_RX_PHY_INFO_TYPE_VHT_SU
:

1081 
IWL_RX_PHY_INFO_TYPE_VHT_MU
:

1082 
IWL_RX_PHY_INFO_TYPE_EHT_MU
:

1083 
IWL_RX_PHY_INFO_TYPE_EHT_TB
:

1084 
IWL_RX_PHY_INFO_TYPE_EHT_MU_EXT
:

1085 
IWL_RX_PHY_INFO_TYPE_EHT_TB_EXT
:

1087 
IWL_RX_PHY_INFO_TYPE_HE_TB_EXT
:

1088 
he
->
d©a1
 |
	`˝u_to_À16
(
IEEE80211_RADIOTAP_HE_DATA1_SPTL_REUSE_KNOWN
 |

1089 
IEEE80211_RADIOTAP_HE_DATA1_SPTL_REUSE2_KNOWN
 |

1090 
IEEE80211_RADIOTAP_HE_DATA1_SPTL_REUSE3_KNOWN
 |

1091 
IEEE80211_RADIOTAP_HE_DATA1_SPTL_REUSE4_KNOWN
);

1092 
he
->
d©a4
 |
	`À16_ícode_bôs
(
	`À32_gë_bôs
(
phy_d©a
->
d2
,

1093 
IWL_RX_PHY_DATA2_HE_TB_EXT_SPTL_REUSE1
),

1094 
IEEE80211_RADIOTAP_HE_DATA4_TB_SPTL_REUSE1
);

1095 
he
->
d©a4
 |
	`À16_ícode_bôs
(
	`À32_gë_bôs
(
phy_d©a
->
d2
,

1096 
IWL_RX_PHY_DATA2_HE_TB_EXT_SPTL_REUSE2
),

1097 
IEEE80211_RADIOTAP_HE_DATA4_TB_SPTL_REUSE2
);

1098 
he
->
d©a4
 |
	`À16_ícode_bôs
(
	`À32_gë_bôs
(
phy_d©a
->
d2
,

1099 
IWL_RX_PHY_DATA2_HE_TB_EXT_SPTL_REUSE3
),

1100 
IEEE80211_RADIOTAP_HE_DATA4_TB_SPTL_REUSE3
);

1101 
he
->
d©a4
 |
	`À16_ícode_bôs
(
	`À32_gë_bôs
(
phy_d©a
->
d2
,

1102 
IWL_RX_PHY_DATA2_HE_TB_EXT_SPTL_REUSE4
),

1103 
IEEE80211_RADIOTAP_HE_DATA4_TB_SPTL_REUSE4
);

1104 
ÁŒthrough
;

1105 
IWL_RX_PHY_INFO_TYPE_HE_SU
:

1106 
IWL_RX_PHY_INFO_TYPE_HE_MU
:

1107 
IWL_RX_PHY_INFO_TYPE_HE_MU_EXT
:

1108 
IWL_RX_PHY_INFO_TYPE_HE_TB
:

1110 
he
->
d©a1
 |
	`˝u_to_À16
(
IEEE80211_RADIOTAP_HE_DATA1_LDPC_XSYMSEG_KNOWN
 |

1111 
IEEE80211_RADIOTAP_HE_DATA1_DOPPLER_KNOWN
 |

1112 
IEEE80211_RADIOTAP_HE_DATA1_BSS_COLOR_KNOWN
);

1113 
he
->
d©a2
 |
	`˝u_to_À16
(
IEEE80211_RADIOTAP_HE_DATA2_PRE_FEC_PAD_KNOWN
 |

1114 
IEEE80211_RADIOTAP_HE_DATA2_PE_DISAMBIG_KNOWN
 |

1115 
IEEE80211_RADIOTAP_HE_DATA2_TXOP_KNOWN
 |

1116 
IEEE80211_RADIOTAP_HE_DATA2_NUM_LTF_SYMS_KNOWN
);

1117 
he
->
d©a3
 |
	`À16_ícode_bôs
(
	`À32_gë_bôs
(
phy_d©a
->
d0
,

1118 
IWL_RX_PHY_DATA0_HE_BSS_COLOR_MASK
),

1119 
IEEE80211_RADIOTAP_HE_DATA3_BSS_COLOR
);

1120 i‡(
phy_d©a
->
öfo_ty≥
 !
IWL_RX_PHY_INFO_TYPE_HE_TB
 &&

1121 
phy_d©a
->
öfo_ty≥
 !
IWL_RX_PHY_INFO_TYPE_HE_TB_EXT
) {

1122 
he
->
d©a1
 |
	`˝u_to_À16
(
IEEE80211_RADIOTAP_HE_DATA1_UL_DL_KNOWN
);

1123 
he
->
d©a3
 |
	`À16_ícode_bôs
(
	`À32_gë_bôs
(
phy_d©a
->
d0
,

1124 
IWL_RX_PHY_DATA0_HE_UPLINK
),

1125 
IEEE80211_RADIOTAP_HE_DATA3_UL_DL
);

1127 
he
->
d©a3
 |
	`À16_ícode_bôs
(
	`À32_gë_bôs
(
phy_d©a
->
d0
,

1128 
IWL_RX_PHY_DATA0_HE_LDPC_EXT_SYM
),

1129 
IEEE80211_RADIOTAP_HE_DATA3_LDPC_XSYMSEG
);

1130 
he
->
d©a5
 |
	`À16_ícode_bôs
(
	`À32_gë_bôs
(
phy_d©a
->
d0
,

1131 
IWL_RX_PHY_DATA0_HE_PRE_FEC_PAD_MASK
),

1132 
IEEE80211_RADIOTAP_HE_DATA5_PRE_FEC_PAD
);

1133 
he
->
d©a5
 |
	`À16_ícode_bôs
(
	`À32_gë_bôs
(
phy_d©a
->
d0
,

1134 
IWL_RX_PHY_DATA0_HE_PE_DISAMBIG
),

1135 
IEEE80211_RADIOTAP_HE_DATA5_PE_DISAMBIG
);

1136 
he
->
d©a5
 |
	`À16_ícode_bôs
(
	`À32_gë_bôs
(
phy_d©a
->
d1
,

1137 
IWL_RX_PHY_DATA1_HE_LTF_NUM_MASK
),

1138 
IEEE80211_RADIOTAP_HE_DATA5_NUM_LTF_SYMS
);

1139 
he
->
d©a6
 |
	`À16_ícode_bôs
(
	`À32_gë_bôs
(
phy_d©a
->
d0
,

1140 
IWL_RX_PHY_DATA0_HE_TXOP_DUR_MASK
),

1141 
IEEE80211_RADIOTAP_HE_DATA6_TXOP
);

1142 
he
->
d©a6
 |
	`À16_ícode_bôs
(
	`À32_gë_bôs
(
phy_d©a
->
d0
,

1143 
IWL_RX_PHY_DATA0_HE_DOPPLER
),

1144 
IEEE80211_RADIOTAP_HE_DATA6_DOPPLER
);

1148 
phy_d©a
->
öfo_ty≥
) {

1149 
IWL_RX_PHY_INFO_TYPE_HE_MU_EXT
:

1150 
IWL_RX_PHY_INFO_TYPE_HE_MU
:

1151 
IWL_RX_PHY_INFO_TYPE_HE_SU
:

1152 
he
->
d©a1
 |
	`˝u_to_À16
(
IEEE80211_RADIOTAP_HE_DATA1_SPTL_REUSE_KNOWN
);

1153 
he
->
d©a4
 |
	`À16_ícode_bôs
(
	`À32_gë_bôs
(
phy_d©a
->
d0
,

1154 
IWL_RX_PHY_DATA0_HE_SPATIAL_REUSE_MASK
),

1155 
IEEE80211_RADIOTAP_HE_DATA4_SU_MU_SPTL_REUSE
);

1162 
phy_d©a
->
öfo_ty≥
) {

1163 
IWL_RX_PHY_INFO_TYPE_HE_MU_EXT
:

1164 
he_mu
->
Êags1
 |=

1165 
	`À16_ícode_bôs
(
	`À16_gë_bôs
(
phy_d©a
->
d4
,

1166 
IWL_RX_PHY_DATA4_HE_MU_EXT_SIGB_DCM
),

1167 
IEEE80211_RADIOTAP_HE_MU_FLAGS1_SIG_B_DCM
);

1168 
he_mu
->
Êags1
 |=

1169 
	`À16_ícode_bôs
(
	`À16_gë_bôs
(
phy_d©a
->
d4
,

1170 
IWL_RX_PHY_DATA4_HE_MU_EXT_SIGB_MCS_MASK
),

1171 
IEEE80211_RADIOTAP_HE_MU_FLAGS1_SIG_B_MCS
);

1172 
he_mu
->
Êags2
 |=

1173 
	`À16_ícode_bôs
(
	`À16_gë_bôs
(
phy_d©a
->
d4
,

1174 
IWL_RX_PHY_DATA4_HE_MU_EXT_PREAMBLE_PUNC_TYPE_MASK
),

1175 
IEEE80211_RADIOTAP_HE_MU_FLAGS2_PUNC_FROM_SIG_A_BW
);

1176 
	`iwl_mvm_decode_he_mu_ext
(
mvm
, 
phy_d©a
, 
he_mu
);

1177 
ÁŒthrough
;

1178 
IWL_RX_PHY_INFO_TYPE_HE_MU
:

1179 
he_mu
->
Êags2
 |=

1180 
	`À16_ícode_bôs
(
	`À32_gë_bôs
(
phy_d©a
->
d1
,

1181 
IWL_RX_PHY_DATA1_HE_MU_SIBG_SYM_OR_USER_NUM_MASK
),

1182 
IEEE80211_RADIOTAP_HE_MU_FLAGS2_SIG_B_SYMS_USERS
);

1183 
he_mu
->
Êags2
 |=

1184 
	`À16_ícode_bôs
(
	`À32_gë_bôs
(
phy_d©a
->
d1
,

1185 
IWL_RX_PHY_DATA1_HE_MU_SIGB_COMPRESSION
),

1186 
IEEE80211_RADIOTAP_HE_MU_FLAGS2_SIG_B_COMP
);

1187 
ÁŒthrough
;

1188 
IWL_RX_PHY_INFO_TYPE_HE_TB
:

1189 
IWL_RX_PHY_INFO_TYPE_HE_TB_EXT
:

1190 
	`iwl_mvm_decode_he_phy_ru_Æloc
(
phy_d©a
, 
he
, 
he_mu
, 
rx_°©us
);

1192 
IWL_RX_PHY_INFO_TYPE_HE_SU
:

1193 
he
->
d©a1
 |
	`˝u_to_À16
(
IEEE80211_RADIOTAP_HE_DATA1_BEAM_CHANGE_KNOWN
);

1194 
he
->
d©a3
 |
	`À16_ícode_bôs
(
	`À32_gë_bôs
(
phy_d©a
->
d0
,

1195 
IWL_RX_PHY_DATA0_HE_BEAM_CHNG
),

1196 
IEEE80211_RADIOTAP_HE_DATA3_BEAM_CHANGE
);

1202 
	}
}

1204 
	#LE32_DEC_ENC
(
vÆue
, 
dec_bôs
, 
íc_bôs
) \

1205 
	`À32_ícode_bôs
(
	`À32_gë_bôs
(
vÆue
, 
dec_bôs
), 
íc_bôs
)

	)

1207 
	#IWL_MVM_ENC_USIG_VALUE_MASK
(
usig
, 
ö_vÆue
, 
dec_bôs
, 
íc_bôs
) do { \

1208 
	`ty≥of
(
íc_bôs
Ë
_íc_bôs
 =Énc_bits; \

1209 
	`ty≥of
(
usig
Ë
_usig
 = usig; \

1210 (
_usig
)->
mask
 |
	`˝u_to_À32
(
_íc_bôs
); \

1211 (
_usig
)->
vÆue
 |
	`LE32_DEC_ENC
(
ö_vÆue
, 
dec_bôs
, 
_íc_bôs
); \

1212 } 0)

	)

1214 
	#__IWL_MVM_ENC_EHT_RU
(
π_d©a
, 
π_ru
, 
fw_d©a
, 
fw_ru
) \

1215 
eht
->
d©a
[(
π_d©a
)] |= \

1216 (
˝u_to_À32
 \

1217 (
IEEE80211_RADIOTAP_EHT_DATA
 ## 
π_d©a
 ## 
_RU_ALLOC_CC_
 ## 
π_ru
 ## 
_KNOWN
) | \

1218 
	`LE32_DEC_ENC
(
d©a
 ## 
fw_d©a
, \

1219 
IWL_RX_PHY_DATA
 ## 
fw_d©a
 ## 
_EHT_MU_EXT_RU_ALLOC_
 ## 
fw_ru
, \

1220 
IEEE80211_RADIOTAP_EHT_DATA
 ## 
π_d©a
 ## 
_RU_ALLOC_CC_
 ## 
π_ru
))

	)

1222 
	#_IWL_MVM_ENC_EHT_RU
(
π_d©a
, 
π_ru
, 
fw_d©a
, 
fw_ru
) \

1223 
	`__IWL_MVM_ENC_EHT_RU
(
π_d©a
, 
π_ru
, 
fw_d©a
, 
fw_ru
)

	)

1225 
	#IEEE80211_RADIOTAP_RU_DATA_1_1_1
 1

	)

1226 
	#IEEE80211_RADIOTAP_RU_DATA_2_1_1
 2

	)

1227 
	#IEEE80211_RADIOTAP_RU_DATA_1_1_2
 2

	)

1228 
	#IEEE80211_RADIOTAP_RU_DATA_2_1_2
 2

	)

1229 
	#IEEE80211_RADIOTAP_RU_DATA_1_2_1
 3

	)

1230 
	#IEEE80211_RADIOTAP_RU_DATA_2_2_1
 3

	)

1231 
	#IEEE80211_RADIOTAP_RU_DATA_1_2_2
 3

	)

1232 
	#IEEE80211_RADIOTAP_RU_DATA_2_2_2
 4

	)

1234 
	#IWL_RX_RU_DATA_A1
 2

	)

1235 
	#IWL_RX_RU_DATA_A2
 2

	)

1236 
	#IWL_RX_RU_DATA_B1
 2

	)

1237 
	#IWL_RX_RU_DATA_B2
 4

	)

1238 
	#IWL_RX_RU_DATA_C1
 3

	)

1239 
	#IWL_RX_RU_DATA_C2
 3

	)

1240 
	#IWL_RX_RU_DATA_D1
 4

	)

1241 
	#IWL_RX_RU_DATA_D2
 4

	)

1243 
	#IWL_MVM_ENC_EHT_RU
(
π_ru
, 
fw_ru
) \

1244 
	`_IWL_MVM_ENC_EHT_RU
(
IEEE80211_RADIOTAP_RU_DATA_
 ## 
π_ru
, \

1245 
π_ru
, \

1246 
IWL_RX_RU_DATA_
 ## 
fw_ru
, \

1247 
fw_ru
)

	)

1249 
	$iwl_mvm_decode_eht_ext_mu
(
iwl_mvm
 *
mvm
,

1250 
iwl_mvm_rx_phy_d©a
 *
phy_d©a
,

1251 
õì80211_rx_°©us
 *
rx_°©us
,

1252 
õì80211_ødiŸ≠_eht
 *
eht
,

1253 
õì80211_ødiŸ≠_eht_usig
 *
usig
)

1255 i‡(
phy_d©a
->
wôh_d©a
) {

1256 
__À32
 
d©a1
 = 
phy_d©a
->
d1
;

1257 
__À32
 
d©a2
 = 
phy_d©a
->
d2
;

1258 
__À32
 
d©a3
 = 
phy_d©a
->
d3
;

1259 
__À32
 
d©a4
 = 
phy_d©a
->
eht_d4
;

1260 
__À32
 
d©a5
 = 
phy_d©a
->
d5
;

1261 
u32
 
phy_bw
 = 
phy_d©a
->
øã_n_Êags
 & 
RATE_MCS_CHAN_WIDTH_MSK
;

1263 
	`IWL_MVM_ENC_USIG_VALUE_MASK
(
usig
, 
d©a5
,

1264 
IWL_RX_PHY_DATA5_EHT_TYPE_AND_COMP
,

1265 
IEEE80211_RADIOTAP_EHT_USIG2_MU_B0_B1_PPDU_TYPE
);

1266 
	`IWL_MVM_ENC_USIG_VALUE_MASK
(
usig
, 
d©a5
,

1267 
IWL_RX_PHY_DATA5_EHT_MU_PUNC_CH_CODE
,

1268 
IEEE80211_RADIOTAP_EHT_USIG2_MU_B3_B7_PUNCTURED_INFO
);

1269 
	`IWL_MVM_ENC_USIG_VALUE_MASK
(
usig
, 
d©a4
,

1270 
IWL_RX_PHY_DATA4_EHT_MU_EXT_SIGB_MCS
,

1271 
IEEE80211_RADIOTAP_EHT_USIG2_MU_B9_B10_SIG_MCS
);

1272 
IWL_MVM_ENC_USIG_VALUE_MASK


1273 (
usig
, 
d©a1
, 
IWL_RX_PHY_DATA1_EHT_MU_NUM_SIG_SYM_USIGA2
,

1274 
IEEE80211_RADIOTAP_EHT_USIG2_MU_B11_B15_EHT_SIG_SYMBOLS
);

1276 
eht
->
u£r_öfo
[0] |=

1277 
	`˝u_to_À32
(
IEEE80211_RADIOTAP_EHT_USER_INFO_STA_ID_KNOWN
) |

1278 
	`LE32_DEC_ENC
(
d©a5
, 
IWL_RX_PHY_DATA5_EHT_MU_STA_ID_USR
,

1279 
IEEE80211_RADIOTAP_EHT_USER_INFO_STA_ID
);

1281 
eht
->
known
 |
	`˝u_to_À32
(
IEEE80211_RADIOTAP_EHT_KNOWN_NR_NON_OFDMA_USERS_M
);

1282 
eht
->
d©a
[7] |
LE32_DEC_ENC


1283 (
d©a5
, 
IWL_RX_PHY_DATA5_EHT_MU_NUM_USR_NON_OFDMA
,

1284 
IEEE80211_RADIOTAP_EHT_DATA7_NUM_OF_NON_OFDMA_USERS
);

1300 
phy_bw
) {

1301 
RATE_MCS_CHAN_WIDTH_320
:

1303 
RATE_MCS_CHAN_WIDTH_160
:

1305 
	`IWL_MVM_ENC_EHT_RU
(1
_2_1
, 
A2
);

1306 
	`IWL_MVM_ENC_EHT_RU
(1
_2_2
, 
C2
);

1308 
	`IWL_MVM_ENC_EHT_RU
(2
_2_1
, 
B2
);

1309 
	`IWL_MVM_ENC_EHT_RU
(2
_2_2
, 
D2
);

1310 
ÁŒthrough
;

1311 
RATE_MCS_CHAN_WIDTH_80
:

1313 
	`IWL_MVM_ENC_EHT_RU
(1
_1_2
, 
C1
);

1315 
	`IWL_MVM_ENC_EHT_RU
(2
_1_2
, 
D1
);

1316 
ÁŒthrough
;

1317 
RATE_MCS_CHAN_WIDTH_40
:

1319 
	`IWL_MVM_ENC_EHT_RU
(2
_1_1
, 
B1
);

1320 
ÁŒthrough
;

1321 
RATE_MCS_CHAN_WIDTH_20
:

1322 
	`IWL_MVM_ENC_EHT_RU
(1
_1_1
, 
A1
);

1326 
__À32
 
usig_a1
 = 
phy_d©a
->
rx_vec
[0];

1327 
__À32
 
usig_a2
 = 
phy_d©a
->
rx_vec
[1];

1329 
	`IWL_MVM_ENC_USIG_VALUE_MASK
(
usig
, 
usig_a1
,

1330 
IWL_RX_USIG_A1_DISREGARD
,

1331 
IEEE80211_RADIOTAP_EHT_USIG1_MU_B20_B24_DISREGARD
);

1332 
	`IWL_MVM_ENC_USIG_VALUE_MASK
(
usig
, 
usig_a1
,

1333 
IWL_RX_USIG_A1_VALIDATE
,

1334 
IEEE80211_RADIOTAP_EHT_USIG1_MU_B25_VALIDATE
);

1335 
	`IWL_MVM_ENC_USIG_VALUE_MASK
(
usig
, 
usig_a2
,

1336 
IWL_RX_USIG_A2_EHT_PPDU_TYPE
,

1337 
IEEE80211_RADIOTAP_EHT_USIG2_MU_B0_B1_PPDU_TYPE
);

1338 
	`IWL_MVM_ENC_USIG_VALUE_MASK
(
usig
, 
usig_a2
,

1339 
IWL_RX_USIG_A2_EHT_USIG2_VALIDATE_B2
,

1340 
IEEE80211_RADIOTAP_EHT_USIG2_MU_B2_VALIDATE
);

1341 
	`IWL_MVM_ENC_USIG_VALUE_MASK
(
usig
, 
usig_a2
,

1342 
IWL_RX_USIG_A2_EHT_PUNC_CHANNEL
,

1343 
IEEE80211_RADIOTAP_EHT_USIG2_MU_B3_B7_PUNCTURED_INFO
);

1344 
	`IWL_MVM_ENC_USIG_VALUE_MASK
(
usig
, 
usig_a2
,

1345 
IWL_RX_USIG_A2_EHT_USIG2_VALIDATE_B8
,

1346 
IEEE80211_RADIOTAP_EHT_USIG2_MU_B8_VALIDATE
);

1347 
	`IWL_MVM_ENC_USIG_VALUE_MASK
(
usig
, 
usig_a2
,

1348 
IWL_RX_USIG_A2_EHT_SIG_MCS
,

1349 
IEEE80211_RADIOTAP_EHT_USIG2_MU_B9_B10_SIG_MCS
);

1350 
IWL_MVM_ENC_USIG_VALUE_MASK


1351 (
usig
, 
usig_a2
, 
IWL_RX_USIG_A2_EHT_SIG_SYM_NUM
,

1352 
IEEE80211_RADIOTAP_EHT_USIG2_MU_B11_B15_EHT_SIG_SYMBOLS
);

1353 
	`IWL_MVM_ENC_USIG_VALUE_MASK
(
usig
, 
usig_a2
,

1354 
IWL_RX_USIG_A2_EHT_CRC_OK
,

1355 
IEEE80211_RADIOTAP_EHT_USIG2_MU_B16_B19_CRC
);

1357 
	}
}

1359 
	$iwl_mvm_decode_eht_ext_tb
(
iwl_mvm
 *
mvm
,

1360 
iwl_mvm_rx_phy_d©a
 *
phy_d©a
,

1361 
õì80211_rx_°©us
 *
rx_°©us
,

1362 
õì80211_ødiŸ≠_eht
 *
eht
,

1363 
õì80211_ødiŸ≠_eht_usig
 *
usig
)

1365 i‡(
phy_d©a
->
wôh_d©a
) {

1366 
__À32
 
d©a5
 = 
phy_d©a
->
d5
;

1368 
	`IWL_MVM_ENC_USIG_VALUE_MASK
(
usig
, 
d©a5
,

1369 
IWL_RX_PHY_DATA5_EHT_TYPE_AND_COMP
,

1370 
IEEE80211_RADIOTAP_EHT_USIG2_TB_B0_B1_PPDU_TYPE
);

1371 
	`IWL_MVM_ENC_USIG_VALUE_MASK
(
usig
, 
d©a5
,

1372 
IWL_RX_PHY_DATA5_EHT_TB_SPATIAL_REUSE1
,

1373 
IEEE80211_RADIOTAP_EHT_USIG2_TB_B3_B6_SPATIAL_REUSE_1
);

1375 
	`IWL_MVM_ENC_USIG_VALUE_MASK
(
usig
, 
d©a5
,

1376 
IWL_RX_PHY_DATA5_EHT_TB_SPATIAL_REUSE2
,

1377 
IEEE80211_RADIOTAP_EHT_USIG2_TB_B7_B10_SPATIAL_REUSE_2
);

1379 
__À32
 
usig_a1
 = 
phy_d©a
->
rx_vec
[0];

1380 
__À32
 
usig_a2
 = 
phy_d©a
->
rx_vec
[1];

1382 
	`IWL_MVM_ENC_USIG_VALUE_MASK
(
usig
, 
usig_a1
,

1383 
IWL_RX_USIG_A1_DISREGARD
,

1384 
IEEE80211_RADIOTAP_EHT_USIG1_TB_B20_B25_DISREGARD
);

1385 
	`IWL_MVM_ENC_USIG_VALUE_MASK
(
usig
, 
usig_a2
,

1386 
IWL_RX_USIG_A2_EHT_PPDU_TYPE
,

1387 
IEEE80211_RADIOTAP_EHT_USIG2_TB_B0_B1_PPDU_TYPE
);

1388 
	`IWL_MVM_ENC_USIG_VALUE_MASK
(
usig
, 
usig_a2
,

1389 
IWL_RX_USIG_A2_EHT_USIG2_VALIDATE_B2
,

1390 
IEEE80211_RADIOTAP_EHT_USIG2_TB_B2_VALIDATE
);

1391 
	`IWL_MVM_ENC_USIG_VALUE_MASK
(
usig
, 
usig_a2
,

1392 
IWL_RX_USIG_A2_EHT_TRIG_SPATIAL_REUSE_1
,

1393 
IEEE80211_RADIOTAP_EHT_USIG2_TB_B3_B6_SPATIAL_REUSE_1
);

1394 
	`IWL_MVM_ENC_USIG_VALUE_MASK
(
usig
, 
usig_a2
,

1395 
IWL_RX_USIG_A2_EHT_TRIG_SPATIAL_REUSE_2
,

1396 
IEEE80211_RADIOTAP_EHT_USIG2_TB_B7_B10_SPATIAL_REUSE_2
);

1397 
	`IWL_MVM_ENC_USIG_VALUE_MASK
(
usig
, 
usig_a2
,

1398 
IWL_RX_USIG_A2_EHT_TRIG_USIG2_DISREGARD
,

1399 
IEEE80211_RADIOTAP_EHT_USIG2_TB_B11_B15_DISREGARD
);

1400 
	`IWL_MVM_ENC_USIG_VALUE_MASK
(
usig
, 
usig_a2
,

1401 
IWL_RX_USIG_A2_EHT_CRC_OK
,

1402 
IEEE80211_RADIOTAP_EHT_USIG2_TB_B16_B19_CRC
);

1404 
	}
}

1406 
	$iwl_mvm_decode_eht_ru
(
iwl_mvm
 *
mvm
,

1407 
õì80211_rx_°©us
 *
rx_°©us
,

1408 
õì80211_ødiŸ≠_eht
 *
eht
)

1410 
u32
 
ru
 = 
	`À32_gë_bôs
(
eht
->
d©a
[8],

1411 
IEEE80211_RADIOTAP_EHT_DATA8_RU_ALLOC_TB_FMT_B7_B1
);

1412 
∆80211_eht_ru_Æloc
 
∆_ru
;

1418 
ru
) {

1420 
∆_ru
 = 
NL80211_RATE_INFO_EHT_RU_ALLOC_26
;

1423 
∆_ru
 = 
NL80211_RATE_INFO_EHT_RU_ALLOC_52
;

1426 
∆_ru
 = 
NL80211_RATE_INFO_EHT_RU_ALLOC_106
;

1429 
∆_ru
 = 
NL80211_RATE_INFO_EHT_RU_ALLOC_242
;

1432 
∆_ru
 = 
NL80211_RATE_INFO_EHT_RU_ALLOC_484
;

1435 
∆_ru
 = 
NL80211_RATE_INFO_EHT_RU_ALLOC_996
;

1438 
∆_ru
 = 
NL80211_RATE_INFO_EHT_RU_ALLOC_2x996
;

1441 
∆_ru
 = 
NL80211_RATE_INFO_EHT_RU_ALLOC_4x996
;

1444 
∆_ru
 = 
NL80211_RATE_INFO_EHT_RU_ALLOC_52P26
;

1447 
∆_ru
 = 
NL80211_RATE_INFO_EHT_RU_ALLOC_106P26
;

1450 
∆_ru
 = 
NL80211_RATE_INFO_EHT_RU_ALLOC_484P242
;

1453 
∆_ru
 = 
NL80211_RATE_INFO_EHT_RU_ALLOC_996P484
;

1456 
∆_ru
 = 
NL80211_RATE_INFO_EHT_RU_ALLOC_996P484P242
;

1459 
∆_ru
 = 
NL80211_RATE_INFO_EHT_RU_ALLOC_2x996P484
;

1462 
∆_ru
 = 
NL80211_RATE_INFO_EHT_RU_ALLOC_3x996
;

1465 
∆_ru
 = 
NL80211_RATE_INFO_EHT_RU_ALLOC_3x996P484
;

1471 
rx_°©us
->
bw
 = 
RATE_INFO_BW_EHT_RU
;

1472 
rx_°©us
->
eht
.
ru
 = 
∆_ru
;

1473 
	}
}

1475 
	$iwl_mvm_decode_eht_phy_d©a
(
iwl_mvm
 *
mvm
,

1476 
iwl_mvm_rx_phy_d©a
 *
phy_d©a
,

1477 
õì80211_rx_°©us
 *
rx_°©us
,

1478 
õì80211_ødiŸ≠_eht
 *
eht
,

1479 
õì80211_ødiŸ≠_eht_usig
 *
usig
)

1482 
__À32
 
d©a0
 = 
phy_d©a
->
d0
;

1483 
__À32
 
d©a1
 = 
phy_d©a
->
d1
;

1484 
__À32
 
usig_a1
 = 
phy_d©a
->
rx_vec
[0];

1485 
u8
 
öfo_ty≥
 = 
phy_d©a
->info_type;

1488 i‡(
öfo_ty≥
 < 
IWL_RX_PHY_INFO_TYPE_EHT_MU
 ||

1489 
öfo_ty≥
 > 
IWL_RX_PHY_INFO_TYPE_EHT_TB_EXT
)

1492 
usig
->
comm⁄
 |
˝u_to_À32


1493 (
IEEE80211_RADIOTAP_EHT_USIG_COMMON_UL_DL_KNOWN
 |

1494 
IEEE80211_RADIOTAP_EHT_USIG_COMMON_BSS_COLOR_KNOWN
);

1495 i‡(
phy_d©a
->
wôh_d©a
) {

1496 
usig
->
comm⁄
 |
	`LE32_DEC_ENC
(
d©a0
,

1497 
IWL_RX_PHY_DATA0_EHT_UPLINK
,

1498 
IEEE80211_RADIOTAP_EHT_USIG_COMMON_UL_DL
);

1499 
usig
->
comm⁄
 |
	`LE32_DEC_ENC
(
d©a0
,

1500 
IWL_RX_PHY_DATA0_EHT_BSS_COLOR_MASK
,

1501 
IEEE80211_RADIOTAP_EHT_USIG_COMMON_BSS_COLOR
);

1503 
usig
->
comm⁄
 |
	`LE32_DEC_ENC
(
usig_a1
,

1504 
IWL_RX_USIG_A1_UL_FLAG
,

1505 
IEEE80211_RADIOTAP_EHT_USIG_COMMON_UL_DL
);

1506 
usig
->
comm⁄
 |
	`LE32_DEC_ENC
(
usig_a1
,

1507 
IWL_RX_USIG_A1_BSS_COLOR
,

1508 
IEEE80211_RADIOTAP_EHT_USIG_COMMON_BSS_COLOR
);

1511 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

1512 
IWL_UCODE_TLV_CAPA_SNIFF_VALIDATE_SUPPORT
)) {

1513 
usig
->
comm⁄
 |=

1514 
	`˝u_to_À32
(
IEEE80211_RADIOTAP_EHT_USIG_COMMON_VALIDATE_BITS_CHECKED
);

1515 
usig
->
comm⁄
 |=

1516 
	`LE32_DEC_ENC
(
d©a0
, 
IWL_RX_PHY_DATA0_EHT_VALIDATE
,

1517 
IEEE80211_RADIOTAP_EHT_USIG_COMMON_VALIDATE_BITS_OK
);

1520 
eht
->
known
 |
	`˝u_to_À32
(
IEEE80211_RADIOTAP_EHT_KNOWN_SPATIAL_REUSE
);

1521 
eht
->
d©a
[0] |
	`LE32_DEC_ENC
(
d©a0
,

1522 
IWL_RX_PHY_DATA0_ETH_SPATIAL_REUSE_MASK
,

1523 
IEEE80211_RADIOTAP_EHT_DATA0_SPATIAL_REUSE
);

1526 
eht
->
known
 |
	`˝u_to_À32
(
IEEE80211_RADIOTAP_EHT_KNOWN_RU_ALLOC_TB_FMT
);

1527 
eht
->
d©a
[8] |
	`LE32_DEC_ENC
(
d©a0
, 
IWL_RX_PHY_DATA0_EHT_PS160
,

1528 
IEEE80211_RADIOTAP_EHT_DATA8_RU_ALLOC_TB_FMT_PS_160
);

1529 
eht
->
d©a
[8] |
	`LE32_DEC_ENC
(
d©a1
, 
IWL_RX_PHY_DATA1_EHT_RU_ALLOC_B0
,

1530 
IEEE80211_RADIOTAP_EHT_DATA8_RU_ALLOC_TB_FMT_B0
);

1531 
eht
->
d©a
[8] |
	`LE32_DEC_ENC
(
d©a1
, 
IWL_RX_PHY_DATA1_EHT_RU_ALLOC_B1_B7
,

1532 
IEEE80211_RADIOTAP_EHT_DATA8_RU_ALLOC_TB_FMT_B7_B1
);

1534 
	`iwl_mvm_decode_eht_ru
(
mvm
, 
rx_°©us
, 
eht
);

1540 
eht
->
known
 |
	`˝u_to_À32
(
IEEE80211_RADIOTAP_EHT_KNOWN_PRIMARY_80
);

1541 
eht
->
d©a
[1] |=

1542 
	`À32_ícode_bôs
(
mvm
->
m⁄ô‹_p80
,

1543 
IEEE80211_RADIOTAP_EHT_DATA1_PRIMARY_80
);

1545 
usig
->
comm⁄
 |
	`˝u_to_À32
(
IEEE80211_RADIOTAP_EHT_USIG_COMMON_TXOP_KNOWN
);

1546 i‡(
phy_d©a
->
wôh_d©a
)

1547 
usig
->
comm⁄
 |
	`LE32_DEC_ENC
(
d©a0
, 
IWL_RX_PHY_DATA0_EHT_TXOP_DUR_MASK
,

1548 
IEEE80211_RADIOTAP_EHT_USIG_COMMON_TXOP
);

1550 
usig
->
comm⁄
 |
	`LE32_DEC_ENC
(
usig_a1
, 
IWL_RX_USIG_A1_TXOP_DURATION
,

1551 
IEEE80211_RADIOTAP_EHT_USIG_COMMON_TXOP
);

1553 
eht
->
known
 |
	`˝u_to_À32
(
IEEE80211_RADIOTAP_EHT_KNOWN_LDPC_EXTRA_SYM_OM
);

1554 
eht
->
d©a
[0] |
	`LE32_DEC_ENC
(
d©a0
, 
IWL_RX_PHY_DATA0_EHT_LDPC_EXT_SYM
,

1555 
IEEE80211_RADIOTAP_EHT_DATA0_LDPC_EXTRA_SYM_OM
);

1557 
eht
->
known
 |
	`˝u_to_À32
(
IEEE80211_RADIOTAP_EHT_KNOWN_PRE_PADD_FACOR_OM
);

1558 
eht
->
d©a
[0] |
	`LE32_DEC_ENC
(
d©a0
, 
IWL_RX_PHY_DATA0_EHT_PRE_FEC_PAD_MASK
,

1559 
IEEE80211_RADIOTAP_EHT_DATA0_PRE_PADD_FACOR_OM
);

1561 
eht
->
known
 |
	`˝u_to_À32
(
IEEE80211_RADIOTAP_EHT_KNOWN_PE_DISAMBIGUITY_OM
);

1562 
eht
->
d©a
[0] |
	`LE32_DEC_ENC
(
d©a0
, 
IWL_RX_PHY_DATA0_EHT_PE_DISAMBIG
,

1563 
IEEE80211_RADIOTAP_EHT_DATA0_PE_DISAMBIGUITY_OM
);

1567 i‡(!
	`À32_gë_bôs
(
d©a0
, 
IWL_RX_PHY_DATA0_EHT_SIGA_CRC_OK
))

1568 
usig
->
comm⁄
 |
	`˝u_to_À32
(
IEEE80211_RADIOTAP_EHT_USIG_COMMON_BAD_USIG_CRC
);

1570 
usig
->
comm⁄
 |
	`˝u_to_À32
(
IEEE80211_RADIOTAP_EHT_USIG_COMMON_PHY_VER_KNOWN
);

1571 
usig
->
comm⁄
 |
	`LE32_DEC_ENC
(
d©a0
, 
IWL_RX_PHY_DATA0_EHT_PHY_VER
,

1572 
IEEE80211_RADIOTAP_EHT_USIG_COMMON_PHY_VER
);

1579 
eht
->
known
 |
	`˝u_to_À32
(
IEEE80211_RADIOTAP_EHT_KNOWN_EHT_LTF
);

1580 
eht
->
d©a
[0] |
	`LE32_DEC_ENC
(
d©a1
, 
IWL_RX_PHY_DATA1_EHT_SIG_LTF_NUM
,

1581 
IEEE80211_RADIOTAP_EHT_DATA0_EHT_LTF
);

1583 i‡(
öfo_ty≥
 =
IWL_RX_PHY_INFO_TYPE_EHT_TB_EXT
 ||

1584 
öfo_ty≥
 =
IWL_RX_PHY_INFO_TYPE_EHT_TB
)

1585 
	`iwl_mvm_decode_eht_ext_tb
(
mvm
, 
phy_d©a
, 
rx_°©us
, 
eht
, 
usig
);

1587 i‡(
öfo_ty≥
 =
IWL_RX_PHY_INFO_TYPE_EHT_MU_EXT
 ||

1588 
öfo_ty≥
 =
IWL_RX_PHY_INFO_TYPE_EHT_MU
)

1589 
	`iwl_mvm_decode_eht_ext_mu
(
mvm
, 
phy_d©a
, 
rx_°©us
, 
eht
, 
usig
);

1590 
	}
}

1592 
	$iwl_mvm_rx_eht
(
iwl_mvm
 *
mvm
, 
sk_buff
 *
skb
,

1593 
iwl_mvm_rx_phy_d©a
 *
phy_d©a
,

1594 
queue
)

1596 
õì80211_rx_°©us
 *
rx_°©us
 = 
	`IEEE80211_SKB_RXCB
(
skb
);

1598 
õì80211_ødiŸ≠_eht
 *
eht
;

1599 
õì80211_ødiŸ≠_eht_usig
 *
usig
;

1600 
size_t
 
eht_Àn
 = (*
eht
);

1602 
u32
 
øã_n_Êags
 = 
phy_d©a
->rate_n_flags;

1603 
u32
 
he_ty≥
 = 
øã_n_Êags
 & 
RATE_MCS_HE_TYPE_MSK
;

1605 
u8
 
…f
 = 
IEEE80211_RADIOTAP_HE_DATA5_LTF_SIZE_UNKNOWN
;

1606 
u16
 
phy_öfo
 = 
phy_d©a
->phy_info;

1607 
u32
 
bw
;

1610 i‡(
phy_d©a
->
wôh_d©a
)

1611 
eht_Àn
 +(
u32
);

1613 
eht
 = 
	`iwl_mvm_ødiŸ≠_put_év
(
skb
, 
IEEE80211_RADIOTAP_EHT
, 
eht_Àn
);

1615 
usig
 = 
	`iwl_mvm_ødiŸ≠_put_év
(
skb
, 
IEEE80211_RADIOTAP_EHT_USIG
,

1616 (*
usig
));

1617 
rx_°©us
->
Êag
 |
RX_FLAG_RADIOTAP_TLV_AT_END
;

1618 
usig
->
comm⁄
 |=

1619 
	`˝u_to_À32
(
IEEE80211_RADIOTAP_EHT_USIG_COMMON_BW_KNOWN
);

1622 
bw
 = 
	`FIELD_GET
(
RATE_MCS_CHAN_WIDTH_MSK
, 
øã_n_Êags
);

1623 i‡(
bw
 =
RATE_MCS_CHAN_WIDTH_320_VAL
)

1624 
bw
 +
	`FIELD_GET
(
IWL_RX_PHY_DATA0_EHT_BW320_SLOT
,

1625 
	`À32_to_˝u
(
phy_d©a
->
d0
));

1627 
usig
->
comm⁄
 |
˝u_to_À32


1628 (
	`FIELD_PREP
(
IEEE80211_RADIOTAP_EHT_USIG_COMMON_BW
, 
bw
));

1631 i‡(!
queue
 && !(
phy_öfo
 & 
IWL_RX_MPDU_PHY_AMPDU
)) {

1632 
rx_°©us
->
Êag
 |
RX_FLAG_AMPDU_DETAILS
;

1633 
rx_°©us
->
Êag
 |
RX_FLAG_AMPDU_EOF_BIT_KNOWN
;

1634 i‡(
phy_d©a
->
d0
 & 
	`˝u_to_À32
(
IWL_RX_PHY_DATA0_EHT_DELIM_EOF
))

1635 
rx_°©us
->
Êag
 |
RX_FLAG_AMPDU_EOF_BIT
;

1639 i‡(!
queue
 && (
phy_öfo
 & 
IWL_RX_MPDU_PHY_TSF_OVERLOAD
) &&

1640 (
phy_öfo
 & 
IWL_RX_MPDU_PHY_AMPDU
Ë&& 
phy_d©a
->
fú°_sub‰ame
) {

1641 
rx_°©us
->
Êag
 |
RX_FLAG_AMPDU_EOF_BIT_KNOWN
;

1642 i‡(
phy_d©a
->
d0
 & 
	`˝u_to_À32
(
IWL_RX_PHY_DATA0_EHT_DELIM_EOF
))

1643 
rx_°©us
->
Êag
 |
RX_FLAG_AMPDU_EOF_BIT
;

1646 i‡(
phy_öfo
 & 
IWL_RX_MPDU_PHY_TSF_OVERLOAD
)

1647 
	`iwl_mvm_decode_eht_phy_d©a
(
mvm
, 
phy_d©a
, 
rx_°©us
, 
eht
, 
usig
);

1649 
	#CHECK_TYPE
(
F
) \

1650 
	`BUILD_BUG_ON
(
IEEE80211_RADIOTAP_HE_DATA1_FORMAT_
 ## 
F
 != \

1651 (
RATE_MCS_HE_TYPE_
 ## 
F
 >> 
RATE_MCS_HE_TYPE_POS
))

	)

1653 
	`CHECK_TYPE
(
SU
);

1654 
	`CHECK_TYPE
(
EXT_SU
);

1655 
	`CHECK_TYPE
(
MU
);

1656 
	`CHECK_TYPE
(
TRIG
);

1658 
	`FIELD_GET
(
RATE_MCS_HE_GI_LTF_MSK
, 
øã_n_Êags
)) {

1660 i‡(
he_ty≥
 =
RATE_MCS_HE_TYPE_TRIG
) {

1661 
rx_°©us
->
eht
.
gi
 = 
NL80211_RATE_INFO_EHT_GI_1_6
;

1662 
…f
 = 
IEEE80211_RADIOTAP_HE_DATA5_LTF_SIZE_1X
;

1664 
rx_°©us
->
eht
.
gi
 = 
NL80211_RATE_INFO_EHT_GI_0_8
;

1665 
…f
 = 
IEEE80211_RADIOTAP_HE_DATA5_LTF_SIZE_2X
;

1669 
rx_°©us
->
eht
.
gi
 = 
NL80211_RATE_INFO_EHT_GI_1_6
;

1670 
…f
 = 
IEEE80211_RADIOTAP_HE_DATA5_LTF_SIZE_2X
;

1673 
…f
 = 
IEEE80211_RADIOTAP_HE_DATA5_LTF_SIZE_4X
;

1674 i‡(
he_ty≥
 =
RATE_MCS_HE_TYPE_TRIG
)

1675 
rx_°©us
->
eht
.
gi
 = 
NL80211_RATE_INFO_EHT_GI_3_2
;

1677 
rx_°©us
->
eht
.
gi
 = 
NL80211_RATE_INFO_EHT_GI_0_8
;

1680 i‡(
he_ty≥
 !
RATE_MCS_HE_TYPE_TRIG
) {

1681 
…f
 = 
IEEE80211_RADIOTAP_HE_DATA5_LTF_SIZE_4X
;

1682 
rx_°©us
->
eht
.
gi
 = 
NL80211_RATE_INFO_EHT_GI_3_2
;

1690 i‡(
…f
 !
IEEE80211_RADIOTAP_HE_DATA5_LTF_SIZE_UNKNOWN
) {

1691 
eht
->
known
 |
	`˝u_to_À32
(
IEEE80211_RADIOTAP_EHT_KNOWN_GI
);

1692 
eht
->
d©a
[0] |
˝u_to_À32


1693 (
	`FIELD_PREP
(
IEEE80211_RADIOTAP_EHT_DATA0_LTF
,

1694 
…f
) |

1695 
	`FIELD_PREP
(
IEEE80211_RADIOTAP_EHT_DATA0_GI
,

1696 
rx_°©us
->
eht
.
gi
));

1700 i‡(!
phy_d©a
->
wôh_d©a
) {

1701 
eht
->
known
 |
	`˝u_to_À32
(
IEEE80211_RADIOTAP_EHT_KNOWN_NSS_S
 |

1702 
IEEE80211_RADIOTAP_EHT_KNOWN_BEAMFORMED_S
);

1703 
eht
->
d©a
[7] |=

1704 
	`À32_ícode_bôs
(
	`À32_gë_bôs
(
phy_d©a
->
rx_vec
[2],

1705 
RX_NO_DATA_RX_VEC2_EHT_NSTS_MSK
),

1706 
IEEE80211_RADIOTAP_EHT_DATA7_NSS_S
);

1707 i‡(
øã_n_Êags
 & 
RATE_MCS_BF_MSK
)

1708 
eht
->
d©a
[7] |=

1709 
	`˝u_to_À32
(
IEEE80211_RADIOTAP_EHT_DATA7_BEAMFORMED_S
);

1711 
eht
->
u£r_öfo
[0] |=

1712 
	`˝u_to_À32
(
IEEE80211_RADIOTAP_EHT_USER_INFO_MCS_KNOWN
 |

1713 
IEEE80211_RADIOTAP_EHT_USER_INFO_CODING_KNOWN
 |

1714 
IEEE80211_RADIOTAP_EHT_USER_INFO_NSS_KNOWN_O
 |

1715 
IEEE80211_RADIOTAP_EHT_USER_INFO_BEAMFORMING_KNOWN_O
 |

1716 
IEEE80211_RADIOTAP_EHT_USER_INFO_DATA_FOR_USER
);

1718 i‡(
øã_n_Êags
 & 
RATE_MCS_BF_MSK
)

1719 
eht
->
u£r_öfo
[0] |=

1720 
	`˝u_to_À32
(
IEEE80211_RADIOTAP_EHT_USER_INFO_BEAMFORMING_O
);

1722 i‡(
øã_n_Êags
 & 
RATE_MCS_LDPC_MSK
)

1723 
eht
->
u£r_öfo
[0] |=

1724 
	`˝u_to_À32
(
IEEE80211_RADIOTAP_EHT_USER_INFO_CODING
);

1726 
eht
->
u£r_öfo
[0] |
˝u_to_À32


1727 (
	`FIELD_PREP
(
IEEE80211_RADIOTAP_EHT_USER_INFO_MCS
,

1728 
	`FIELD_GET
(
RATE_VHT_MCS_RATE_CODE_MSK
,

1729 
øã_n_Êags
)) |

1730 
	`FIELD_PREP
(
IEEE80211_RADIOTAP_EHT_USER_INFO_NSS_O
,

1731 
	`FIELD_GET
(
RATE_MCS_NSS_MSK
, 
øã_n_Êags
)));

1733 
	}
}

1735 
	$iwl_mvm_rx_he
(
iwl_mvm
 *
mvm
, 
sk_buff
 *
skb
,

1736 
iwl_mvm_rx_phy_d©a
 *
phy_d©a
,

1737 
queue
)

1739 
õì80211_rx_°©us
 *
rx_°©us
 = 
	`IEEE80211_SKB_RXCB
(
skb
);

1740 
õì80211_ødiŸ≠_he
 *
he
 = 
NULL
;

1741 
õì80211_ødiŸ≠_he_mu
 *
he_mu
 = 
NULL
;

1742 
u32
 
øã_n_Êags
 = 
phy_d©a
->rate_n_flags;

1743 
u32
 
he_ty≥
 = 
øã_n_Êags
 & 
RATE_MCS_HE_TYPE_MSK
;

1744 
u8
 
…f
;

1745 c⁄° 
õì80211_ødiŸ≠_he
 
known
 = {

1746 .
d©a1
 = 
	`˝u_to_À16
(
IEEE80211_RADIOTAP_HE_DATA1_DATA_MCS_KNOWN
 |

1747 
IEEE80211_RADIOTAP_HE_DATA1_DATA_DCM_KNOWN
 |

1748 
IEEE80211_RADIOTAP_HE_DATA1_STBC_KNOWN
 |

1749 
IEEE80211_RADIOTAP_HE_DATA1_CODING_KNOWN
),

1750 .
d©a2
 = 
	`˝u_to_À16
(
IEEE80211_RADIOTAP_HE_DATA2_GI_KNOWN
 |

1751 
IEEE80211_RADIOTAP_HE_DATA2_TXBF_KNOWN
),

1753 c⁄° 
õì80211_ødiŸ≠_he_mu
 
mu_known
 = {

1754 .
Êags1
 = 
	`˝u_to_À16
(
IEEE80211_RADIOTAP_HE_MU_FLAGS1_SIG_B_MCS_KNOWN
 |

1755 
IEEE80211_RADIOTAP_HE_MU_FLAGS1_SIG_B_DCM_KNOWN
 |

1756 
IEEE80211_RADIOTAP_HE_MU_FLAGS1_SIG_B_SYMS_USERS_KNOWN
 |

1757 
IEEE80211_RADIOTAP_HE_MU_FLAGS1_SIG_B_COMP_KNOWN
),

1758 .
Êags2
 = 
	`˝u_to_À16
(
IEEE80211_RADIOTAP_HE_MU_FLAGS2_PUNC_FROM_SIG_A_BW_KNOWN
 |

1759 
IEEE80211_RADIOTAP_HE_MU_FLAGS2_BW_FROM_SIG_A_BW_KNOWN
),

1761 
u16
 
phy_öfo
 = 
phy_d©a
->phy_info;

1763 
he
 = 
	`skb_put_d©a
(
skb
, &
known
, (known));

1764 
rx_°©us
->
Êag
 |
RX_FLAG_RADIOTAP_HE
;

1766 i‡(
phy_d©a
->
öfo_ty≥
 =
IWL_RX_PHY_INFO_TYPE_HE_MU
 ||

1767 
phy_d©a
->
öfo_ty≥
 =
IWL_RX_PHY_INFO_TYPE_HE_MU_EXT
) {

1768 
he_mu
 = 
	`skb_put_d©a
(
skb
, &
mu_known
, (mu_known));

1769 
rx_°©us
->
Êag
 |
RX_FLAG_RADIOTAP_HE_MU
;

1773 i‡(!
queue
 && !(
phy_öfo
 & 
IWL_RX_MPDU_PHY_AMPDU
)) {

1774 
rx_°©us
->
Êag
 |
RX_FLAG_AMPDU_DETAILS
;

1775 
rx_°©us
->
Êag
 |
RX_FLAG_AMPDU_EOF_BIT_KNOWN
;

1776 i‡(
phy_d©a
->
d0
 & 
	`˝u_to_À32
(
IWL_RX_PHY_DATA0_HE_DELIM_EOF
))

1777 
rx_°©us
->
Êag
 |
RX_FLAG_AMPDU_EOF_BIT
;

1780 i‡(
phy_öfo
 & 
IWL_RX_MPDU_PHY_TSF_OVERLOAD
)

1781 
	`iwl_mvm_decode_he_phy_d©a
(
mvm
, 
phy_d©a
, 
he
, 
he_mu
, 
rx_°©us
,

1782 
queue
);

1785 i‡(!
queue
 && (
phy_öfo
 & 
IWL_RX_MPDU_PHY_TSF_OVERLOAD
) &&

1786 (
phy_öfo
 & 
IWL_RX_MPDU_PHY_AMPDU
Ë&& 
phy_d©a
->
fú°_sub‰ame
) {

1787 
rx_°©us
->
Êag
 |
RX_FLAG_AMPDU_EOF_BIT_KNOWN
;

1788 i‡(
phy_d©a
->
d0
 & 
	`˝u_to_À32
(
IWL_RX_PHY_DATA0_EHT_DELIM_EOF
))

1789 
rx_°©us
->
Êag
 |
RX_FLAG_AMPDU_EOF_BIT
;

1792 i‡(
he_ty≥
 =
RATE_MCS_HE_TYPE_EXT_SU
 &&

1793 
øã_n_Êags
 & 
RATE_MCS_HE_106T_MSK
) {

1794 
rx_°©us
->
bw
 = 
RATE_INFO_BW_HE_RU
;

1795 
rx_°©us
->
he_ru
 = 
NL80211_RATE_INFO_HE_RU_ALLOC_106
;

1799 i‡(
he_ty≥
 =
RATE_MCS_HE_TYPE_SU
 ||

1800 
he_ty≥
 =
RATE_MCS_HE_TYPE_EXT_SU
)

1801 
he
->
d©a1
 |=

1802 
	`˝u_to_À16
(
IEEE80211_RADIOTAP_HE_DATA1_BW_RU_ALLOC_KNOWN
);

1804 
	#CHECK_TYPE
(
F
) \

1805 
	`BUILD_BUG_ON
(
IEEE80211_RADIOTAP_HE_DATA1_FORMAT_
 ## 
F
 != \

1806 (
RATE_MCS_HE_TYPE_
 ## 
F
 >> 
RATE_MCS_HE_TYPE_POS
))

	)

1808 
	`CHECK_TYPE
(
SU
);

1809 
	`CHECK_TYPE
(
EXT_SU
);

1810 
	`CHECK_TYPE
(
MU
);

1811 
	`CHECK_TYPE
(
TRIG
);

1813 
he
->
d©a1
 |
	`˝u_to_À16
(
he_ty≥
 >> 
RATE_MCS_HE_TYPE_POS
);

1815 i‡(
øã_n_Êags
 & 
RATE_MCS_BF_MSK
)

1816 
he
->
d©a5
 |
	`˝u_to_À16
(
IEEE80211_RADIOTAP_HE_DATA5_TXBF
);

1818 (
øã_n_Êags
 & 
RATE_MCS_HE_GI_LTF_MSK
) >>

1819 
RATE_MCS_HE_GI_LTF_POS
) {

1821 i‡(
he_ty≥
 =
RATE_MCS_HE_TYPE_TRIG
)

1822 
rx_°©us
->
he_gi
 = 
NL80211_RATE_INFO_HE_GI_1_6
;

1824 
rx_°©us
->
he_gi
 = 
NL80211_RATE_INFO_HE_GI_0_8
;

1825 i‡(
he_ty≥
 =
RATE_MCS_HE_TYPE_MU
)

1826 
…f
 = 
IEEE80211_RADIOTAP_HE_DATA5_LTF_SIZE_4X
;

1828 
…f
 = 
IEEE80211_RADIOTAP_HE_DATA5_LTF_SIZE_1X
;

1831 i‡(
he_ty≥
 =
RATE_MCS_HE_TYPE_TRIG
)

1832 
rx_°©us
->
he_gi
 = 
NL80211_RATE_INFO_HE_GI_1_6
;

1834 
rx_°©us
->
he_gi
 = 
NL80211_RATE_INFO_HE_GI_0_8
;

1835 
…f
 = 
IEEE80211_RADIOTAP_HE_DATA5_LTF_SIZE_2X
;

1838 i‡(
he_ty≥
 =
RATE_MCS_HE_TYPE_TRIG
) {

1839 
rx_°©us
->
he_gi
 = 
NL80211_RATE_INFO_HE_GI_3_2
;

1840 
…f
 = 
IEEE80211_RADIOTAP_HE_DATA5_LTF_SIZE_4X
;

1842 
rx_°©us
->
he_gi
 = 
NL80211_RATE_INFO_HE_GI_1_6
;

1843 
…f
 = 
IEEE80211_RADIOTAP_HE_DATA5_LTF_SIZE_2X
;

1847 
rx_°©us
->
he_gi
 = 
NL80211_RATE_INFO_HE_GI_3_2
;

1848 
…f
 = 
IEEE80211_RADIOTAP_HE_DATA5_LTF_SIZE_4X
;

1851 
rx_°©us
->
he_gi
 = 
NL80211_RATE_INFO_HE_GI_0_8
;

1852 
…f
 = 
IEEE80211_RADIOTAP_HE_DATA5_LTF_SIZE_4X
;

1855 
…f
 = 
IEEE80211_RADIOTAP_HE_DATA5_LTF_SIZE_UNKNOWN
;

1858 
he
->
d©a5
 |
	`À16_ícode_bôs
(
…f
,

1859 
IEEE80211_RADIOTAP_HE_DATA5_LTF_SIZE
);

1860 
	}
}

1862 
	$iwl_mvm_decode_lsig
(
sk_buff
 *
skb
,

1863 
iwl_mvm_rx_phy_d©a
 *
phy_d©a
)

1865 
õì80211_rx_°©us
 *
rx_°©us
 = 
	`IEEE80211_SKB_RXCB
(
skb
);

1866 
õì80211_ødiŸ≠_lsig
 *
lsig
;

1868 
phy_d©a
->
öfo_ty≥
) {

1869 
IWL_RX_PHY_INFO_TYPE_HT
:

1870 
IWL_RX_PHY_INFO_TYPE_VHT_SU
:

1871 
IWL_RX_PHY_INFO_TYPE_VHT_MU
:

1872 
IWL_RX_PHY_INFO_TYPE_HE_TB_EXT
:

1873 
IWL_RX_PHY_INFO_TYPE_HE_SU
:

1874 
IWL_RX_PHY_INFO_TYPE_HE_MU
:

1875 
IWL_RX_PHY_INFO_TYPE_HE_MU_EXT
:

1876 
IWL_RX_PHY_INFO_TYPE_HE_TB
:

1877 
IWL_RX_PHY_INFO_TYPE_EHT_MU
:

1878 
IWL_RX_PHY_INFO_TYPE_EHT_TB
:

1879 
IWL_RX_PHY_INFO_TYPE_EHT_MU_EXT
:

1880 
IWL_RX_PHY_INFO_TYPE_EHT_TB_EXT
:

1881 
lsig
 = 
	`skb_put
(
skb
, (*lsig));

1882 
lsig
->
d©a1
 = 
	`˝u_to_À16
(
IEEE80211_RADIOTAP_LSIG_DATA1_LENGTH_KNOWN
);

1883 
lsig
->
d©a2
 = 
	`À16_ícode_bôs
(
	`À32_gë_bôs
(
phy_d©a
->
d1
,

1884 
IWL_RX_PHY_DATA1_LSIG_LEN_MASK
),

1885 
IEEE80211_RADIOTAP_LSIG_DATA2_LENGTH
);

1886 
rx_°©us
->
Êag
 |
RX_FLAG_RADIOTAP_LSIG
;

1891 
	}
}

1893 
ölöe
 
u8
 
	$iwl_mvm_∆80211_b™d_‰om_rx_msdu
(
u8
 
phy_b™d
)

1895 
phy_b™d
) {

1896 
PHY_BAND_24
:

1897  
NL80211_BAND_2GHZ
;

1898 
PHY_BAND_5
:

1899  
NL80211_BAND_5GHZ
;

1900 
PHY_BAND_6
:

1901  
NL80211_BAND_6GHZ
;

1903 
	`WARN_ONCE
(1, "Unsuµ‹ãdÖhy b™d (%u)\n", 
phy_b™d
);

1904  
NL80211_BAND_5GHZ
;

1906 
	}
}

1908 
	siwl_rx_°a_cß
 {

1909 
boﬁ
 
	mÆl_°a_unblocked
;

1910 
õì80211_vif
 *
	mvif
;

1913 
	$iwl_mvm_rx_gë_°a_block_tx
(*
d©a
, 
õì80211_°a
 *
°a
)

1915 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

1916 
iwl_rx_°a_cß
 *
rx_°a_cß
 = 
d©a
;

1918 i‡(
mvm°a
->
vif
 !
rx_°a_cß
->vif)

1921 i‡(
mvm°a
->
dißbÀ_tx
)

1922 
rx_°a_cß
->
Æl_°a_unblocked
 = 
Ál£
;

1923 
	}
}

1929 
	$iwl_mvm_rx_fûl_°©us
(
iwl_mvm
 *
mvm
,

1930 
sk_buff
 *
skb
,

1931 
iwl_mvm_rx_phy_d©a
 *
phy_d©a
,

1932 
queue
)

1934 
õì80211_rx_°©us
 *
rx_°©us
 = 
	`IEEE80211_SKB_RXCB
(
skb
);

1935 
u32
 
øã_n_Êags
 = 
phy_d©a
->rate_n_flags;

1936 
u8
 
°bc
 = 
	`u32_gë_bôs
(
øã_n_Êags
, 
RATE_MCS_STBC_MSK
);

1937 
u32
 
f‹m©
 = 
øã_n_Êags
 & 
RATE_MCS_MOD_TYPE_MSK
;

1938 
boﬁ
 
is_sgi
;

1940 
phy_d©a
->
öfo_ty≥
 = 
IWL_RX_PHY_INFO_TYPE_NONE
;

1942 i‡(
phy_d©a
->
phy_öfo
 & 
IWL_RX_MPDU_PHY_TSF_OVERLOAD
)

1943 
phy_d©a
->
öfo_ty≥
 =

1944 
	`À32_gë_bôs
(
phy_d©a
->
d1
,

1945 
IWL_RX_PHY_DATA1_INFO_TYPE_MASK
);

1948 
øã_n_Êags
 & 
RATE_MCS_CHAN_WIDTH_MSK
) {

1949 
RATE_MCS_CHAN_WIDTH_20
:

1951 
RATE_MCS_CHAN_WIDTH_40
:

1952 
rx_°©us
->
bw
 = 
RATE_INFO_BW_40
;

1954 
RATE_MCS_CHAN_WIDTH_80
:

1955 
rx_°©us
->
bw
 = 
RATE_INFO_BW_80
;

1957 
RATE_MCS_CHAN_WIDTH_160
:

1958 
rx_°©us
->
bw
 = 
RATE_INFO_BW_160
;

1960 
RATE_MCS_CHAN_WIDTH_320
:

1961 
rx_°©us
->
bw
 = 
RATE_INFO_BW_320
;

1966 i‡(
f‹m©
 =
RATE_MCS_HE_MSK
)

1967 
	`iwl_mvm_rx_he
(
mvm
, 
skb
, 
phy_d©a
, 
queue
);

1969 
	`iwl_mvm_decode_lsig
(
skb
, 
phy_d©a
);

1971 
rx_°©us
->
devi˚_time°amp
 = 
phy_d©a
->
gp2_⁄_aú_ri£
;

1972 
rx_°©us
->
‰eq
 = 
	`õì80211_ch™√l_to_‰equícy
(
phy_d©a
->
ch™√l
,

1973 
rx_°©us
->
b™d
);

1974 
	`iwl_mvm_gë_sig«l_°ªngth
(
mvm
, 
rx_°©us
, 
øã_n_Êags
,

1975 
phy_d©a
->
íîgy_a
,Öhy_d©a->
íîgy_b
);

1978 i‡(
f‹m©
 =
RATE_MCS_EHT_MSK
)

1979 
	`iwl_mvm_rx_eht
(
mvm
, 
skb
, 
phy_d©a
, 
queue
);

1981 i‡(
	`u∆ikñy
(
mvm
->
m⁄ô‹_⁄
))

1982 
	`iwl_mvm_add_π≠_¢if„r_c⁄fig
(
mvm
, 
skb
);

1984 
is_sgi
 = 
f‹m©
 =
RATE_MCS_HE_MSK
 ?

1985 
	`iwl_he_is_sgi
(
øã_n_Êags
) :

1986 
øã_n_Êags
 & 
RATE_MCS_SGI_MSK
;

1988 i‡(!(
f‹m©
 =
RATE_MCS_CCK_MSK
Ë&& 
is_sgi
)

1989 
rx_°©us
->
íc_Êags
 |
RX_ENC_FLAG_SHORT_GI
;

1991 i‡(
øã_n_Êags
 & 
RATE_MCS_LDPC_MSK
)

1992 
rx_°©us
->
íc_Êags
 |
RX_ENC_FLAG_LDPC
;

1994 
f‹m©
) {

1995 
RATE_MCS_VHT_MSK
:

1996 
rx_°©us
->
ícodög
 = 
RX_ENC_VHT
;

1998 
RATE_MCS_HE_MSK
:

1999 
rx_°©us
->
ícodög
 = 
RX_ENC_HE
;

2000 
rx_°©us
->
he_dcm
 =

2001 !!(
øã_n_Êags
 & 
RATE_HE_DUAL_CARRIER_MODE_MSK
);

2003 
RATE_MCS_EHT_MSK
:

2004 
rx_°©us
->
ícodög
 = 
RX_ENC_EHT
;

2008 
f‹m©
) {

2009 
RATE_MCS_HT_MSK
:

2010 
rx_°©us
->
ícodög
 = 
RX_ENC_HT
;

2011 
rx_°©us
->
øã_idx
 = 
	`RATE_HT_MCS_INDEX
(
øã_n_Êags
);

2012 
rx_°©us
->
íc_Êags
 |
°bc
 << 
RX_ENC_FLAG_STBC_SHIFT
;

2014 
RATE_MCS_VHT_MSK
:

2015 
RATE_MCS_HE_MSK
:

2016 
RATE_MCS_EHT_MSK
:

2017 
rx_°©us
->
nss
 =

2018 
	`u32_gë_bôs
(
øã_n_Êags
, 
RATE_MCS_NSS_MSK
) + 1;

2019 
rx_°©us
->
øã_idx
 = 
øã_n_Êags
 & 
RATE_MCS_CODE_MSK
;

2020 
rx_°©us
->
íc_Êags
 |
°bc
 << 
RX_ENC_FLAG_STBC_SHIFT
;

2023 
øã
 = 
	`iwl_mvm_Àgacy_hw_idx_to_mac80211_idx
(
øã_n_Êags
,

2024 
rx_°©us
->
b™d
);

2026 
rx_°©us
->
øã_idx
 = 
øã
;

2028 i‡((
øã
 < 0 ||Ñate > 0xFF)) {

2029 
rx_°©us
->
øã_idx
 = 0;

2030 i‡(
	`√t_øãlimô
())

2031 
	`IWL_ERR
(
mvm
, "InvalidÑate flags 0x%x, band %d,\n",

2032 
øã_n_Êags
, 
rx_°©us
->
b™d
);

2038 
	}
}

2040 
	$iwl_mvm_rx_mpdu_mq
(
iwl_mvm
 *
mvm
, 
«pi_°ru˘
 *
«pi
,

2041 
iwl_rx_cmd_buf„r
 *
rxb
, 
queue
)

2043 
õì80211_rx_°©us
 *
rx_°©us
;

2044 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

2045 
iwl_rx_mpdu_desc
 *
desc
 = (*)
pkt
->
d©a
;

2046 
õì80211_hdr
 *
hdr
;

2047 
u32
 
Àn
;

2048 
u32
 
pkt_Àn
 = 
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
);

2049 
õì80211_°a
 *
°a
 = 
NULL
;

2050 
õì80211_lök_°a
 *
lök_°a
 = 
NULL
;

2051 
sk_buff
 *
skb
;

2052 
u8
 
¸y±_Àn
 = 0;

2053 
size_t
 
desc_size
;

2054 
iwl_mvm_rx_phy_d©a
 
phy_d©a
 = {};

2055 
u32
 
f‹m©
;

2057 i‡(
	`u∆ikñy
(
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
)))

2060 i‡(
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 >
IWL_DEVICE_FAMILY_AX210
)

2061 
desc_size
 = (*
desc
);

2063 
desc_size
 = 
IWL_RX_DESC_SIZE_V1
;

2065 i‡(
	`u∆ikñy
(
pkt_Àn
 < 
desc_size
)) {

2066 
	`IWL_DEBUG_DROP
(
mvm
, "Bad REPLY_RX_MPDU_CMD size\n");

2070 i‡(
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 >
IWL_DEVICE_FAMILY_AX210
) {

2071 
phy_d©a
.
øã_n_Êags
 = 
	`À32_to_˝u
(
desc
->
v3
.rate_n_flags);

2072 
phy_d©a
.
ch™√l
 = 
desc
->
v3
.channel;

2073 
phy_d©a
.
gp2_⁄_aú_ri£
 = 
	`À32_to_˝u
(
desc
->
v3
.gp2_on_air_rise);

2074 
phy_d©a
.
íîgy_a
 = 
desc
->
v3
.energy_a;

2075 
phy_d©a
.
íîgy_b
 = 
desc
->
v3
.energy_b;

2077 
phy_d©a
.
d0
 = 
desc
->
v3
.
phy_d©a0
;

2078 
phy_d©a
.
d1
 = 
desc
->
v3
.
phy_d©a1
;

2079 
phy_d©a
.
d2
 = 
desc
->
v3
.
phy_d©a2
;

2080 
phy_d©a
.
d3
 = 
desc
->
v3
.
phy_d©a3
;

2081 
phy_d©a
.
eht_d4
 = 
desc
->
phy_eht_d©a4
;

2082 
phy_d©a
.
d5
 = 
desc
->
v3
.
phy_d©a5
;

2084 
phy_d©a
.
øã_n_Êags
 = 
	`À32_to_˝u
(
desc
->
v1
.rate_n_flags);

2085 
phy_d©a
.
ch™√l
 = 
desc
->
v1
.channel;

2086 
phy_d©a
.
gp2_⁄_aú_ri£
 = 
	`À32_to_˝u
(
desc
->
v1
.gp2_on_air_rise);

2087 
phy_d©a
.
íîgy_a
 = 
desc
->
v1
.energy_a;

2088 
phy_d©a
.
íîgy_b
 = 
desc
->
v1
.energy_b;

2090 
phy_d©a
.
d0
 = 
desc
->
v1
.
phy_d©a0
;

2091 
phy_d©a
.
d1
 = 
desc
->
v1
.
phy_d©a1
;

2092 
phy_d©a
.
d2
 = 
desc
->
v1
.
phy_d©a2
;

2093 
phy_d©a
.
d3
 = 
desc
->
v1
.
phy_d©a3
;

2096 i‡(
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
LEGACY_GROUP
,

2097 
REPLY_RX_MPDU_CMD
, 0) < 4) {

2098 
phy_d©a
.
øã_n_Êags
 = 
	`iwl_√w_øã_‰om_v1
(phy_data.rate_n_flags);

2099 
	`IWL_DEBUG_DROP
(
mvm
, "Got old formatÑate, converting. NewÑate: 0x%x\n",

2100 
phy_d©a
.
øã_n_Êags
);

2103 
f‹m©
 = 
phy_d©a
.
øã_n_Êags
 & 
RATE_MCS_MOD_TYPE_MSK
;

2105 
Àn
 = 
	`À16_to_˝u
(
desc
->
mpdu_Àn
);

2107 i‡(
	`u∆ikñy
(
Àn
 + 
desc_size
 > 
pkt_Àn
)) {

2108 
	`IWL_DEBUG_DROP
(
mvm
, "FWÜiedáboutÖacketÜen\n");

2112 
phy_d©a
.
wôh_d©a
 = 
åue
;

2113 
phy_d©a
.
phy_öfo
 = 
	`À16_to_˝u
(
desc
->phy_info);

2114 
phy_d©a
.
d4
 = 
desc
->
phy_d©a4
;

2116 
hdr
 = (*)(
pkt
->
d©a
 + 
desc_size
);

2120 
skb
 = 
	`Æloc_skb
(128, 
GFP_ATOMIC
);

2121 i‡(!
skb
) {

2122 
	`IWL_ERR
(
mvm
, "alloc_skb failed\n");

2126 i‡(
desc
->
mac_Êags2
 & 
IWL_RX_MPDU_MFLG2_PAD
) {

2133 
	`skb_ª£rve
(
skb
, 2);

2136 
rx_°©us
 = 
	`IEEE80211_SKB_RXCB
(
skb
);

2142 i‡(!(
desc
->
°©us
 & 
	`˝u_to_À32
(
IWL_RX_MPDU_STATUS_CRC_OK
)) ||

2143 !(
desc
->
°©us
 & 
	`˝u_to_À32
(
IWL_RX_MPDU_STATUS_OVERRUN_OK
))) {

2144 
	`IWL_DEBUG_RX
(
mvm
, "Bad CRC or FIFO: 0x%08X.\n",

2145 
	`À32_to_˝u
(
desc
->
°©us
));

2146 
rx_°©us
->
Êag
 |
RX_FLAG_FAILED_FCS_CRC
;

2150 i‡(
f‹m©
 =
RATE_MCS_CCK_MSK
 &&

2151 
phy_d©a
.
phy_öfo
 & 
IWL_RX_MPDU_PHY_SHORT_PREAMBLE
)

2152 
rx_°©us
->
íc_Êags
 |
RX_ENC_FLAG_SHORTPRE
;

2154 i‡(
	`likñy
(!(
phy_d©a
.
phy_öfo
 & 
IWL_RX_MPDU_PHY_TSF_OVERLOAD
))) {

2155 
u64
 
tsf_⁄_aú_ri£
;

2157 i‡(
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 >=

2158 
IWL_DEVICE_FAMILY_AX210
)

2159 
tsf_⁄_aú_ri£
 = 
	`À64_to_˝u
(
desc
->
v3
.tsf_on_air_rise);

2161 
tsf_⁄_aú_ri£
 = 
	`À64_to_˝u
(
desc
->
v1
.tsf_on_air_rise);

2163 
rx_°©us
->
ma˘ime
 = 
tsf_⁄_aú_ri£
;

2165 
rx_°©us
->
Êag
 |
RX_FLAG_MACTIME_PLCP_START
;

2168 i‡(
	`iwl_mvm_is_b™d_ö_rx_suµ‹ãd
(
mvm
)) {

2169 
u8
 
b™d
 = 
	`BAND_IN_RX_STATUS
(
desc
->
mac_phy_idx
);

2171 
rx_°©us
->
b™d
 = 
	`iwl_mvm_∆80211_b™d_‰om_rx_msdu
(band);

2173 
rx_°©us
->
b™d
 = 
phy_d©a
.
ch™√l
 > 14 ? 
NL80211_BAND_5GHZ
 :

2174 
NL80211_BAND_2GHZ
;

2178 i‡(!
queue
 && (
phy_d©a
.
phy_öfo
 & 
IWL_RX_MPDU_PHY_AMPDU
)) {

2179 
boﬁ
 
toggÀ_bô
;

2181 
toggÀ_bô
 = 
phy_d©a
.
phy_öfo
 & 
IWL_RX_MPDU_PHY_AMPDU_TOGGLE
;

2182 
rx_°©us
->
Êag
 |
RX_FLAG_AMPDU_DETAILS
;

2188 i‡(
toggÀ_bô
 !
mvm
->
ampdu_toggÀ
) {

2189 
mvm
->
ampdu_ªf
++;

2190 i‡(
mvm
->
ampdu_ªf
 == 0)

2191 
mvm
->
ampdu_ªf
++;

2192 
mvm
->
ampdu_toggÀ
 = 
toggÀ_bô
;

2193 
phy_d©a
.
fú°_sub‰ame
 = 
åue
;

2195 
rx_°©us
->
ampdu_ª„ªn˚
 = 
mvm
->
ampdu_ªf
;

2198 
	`rcu_ªad_lock
();

2200 i‡(
desc
->
°©us
 & 
	`˝u_to_À32
(
IWL_RX_MPDU_STATUS_SRC_STA_FOUND
)) {

2201 
u8
 
id
 = 
	`À32_gë_bôs
(
desc
->
°©us
, 
IWL_RX_MPDU_STATUS_STA_ID
);

2203 i‡(!
	`WARN_ON_ONCE
(
id
 >
mvm
->
fw
->
ucode_ˇ∑
.
num_°©i⁄s
)) {

2204 
°a
 = 
	`rcu_dîe„ªn˚
(
mvm
->
fw_id_to_mac_id
[
id
]);

2205 i‡(
	`IS_ERR
(
°a
))

2206 
°a
 = 
NULL
;

2207 
lök_°a
 = 
	`rcu_dîe„ªn˚
(
mvm
->
fw_id_to_lök_°a
[
id
]);

2209 i‡(
°a
 && sè->
vÆid_löks
 && 
lök_°a
) {

2210 
rx_°©us
->
lök_vÆid
 = 1;

2211 
rx_°©us
->
lök_id
 = 
lök_°a
->link_id;

2214 } i‡(!
	`is_mu…iˇ°_ëhî_addr
(
hdr
->
addr2
)) {

2219 
°a
 = 
	`õì80211_föd_°a_by_iÁddr
(
mvm
->
hw
, 
hdr
->
addr2
, 
NULL
);

2222 i‡(
	`iwl_mvm_rx_¸y±o
(
mvm
, 
°a
, 
hdr
, 
rx_°©us
, 
phy_d©a
.
phy_öfo
, 
desc
,

2223 
	`À32_to_˝u
(
pkt
->
Àn_n_Êags
), 
queue
,

2224 &
¸y±_Àn
)) {

2225 
	`k‰ì_skb
(
skb
);

2226 
out
;

2229 
	`iwl_mvm_rx_fûl_°©us
(
mvm
, 
skb
, &
phy_d©a
, 
queue
);

2231 i‡(
°a
) {

2232 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

2233 
õì80211_vif
 *
tx_blocked_vif
 =

2234 
	`rcu_dîe„ªn˚
(
mvm
->
cß_tx_blocked_vif
);

2235 
u8
 
baid
 = (u8)((
	`À32_to_˝u
(
desc
->
ª‹dî_d©a
) &

2236 
IWL_RX_MPDU_REORDER_BAID_MASK
) >>

2237 
IWL_RX_MPDU_REORDER_BAID_SHIFT
);

2238 
iwl_fw_dbg_åiggî_év
 *
åig
;

2239 
õì80211_vif
 *
vif
 = 
mvm°a
->vif;

2241 i‡(!
mvm
->
tcm
.
∑u£d
 && 
Àn
 >(*
hdr
) &&

2242 !
	`is_mu…iˇ°_ëhî_addr
(
hdr
->
addr1
) &&

2243 
	`õì80211_is_d©a
(
hdr
->
‰ame_c⁄åﬁ
) &&

2244 
	`time_a·î
(
jiffõs
, 
mvm
->
tcm
.
ts
 + 
MVM_TCM_PERIOD
))

2245 
	`scheduÀ_dñayed_w‹k
(&
mvm
->
tcm
.
w‹k
, 0);

2252 i‡(
	`u∆ikñy
(
tx_blocked_vif
Ë&&Åx_blocked_vi‡=
vif
) {

2253 
iwl_mvm_vif
 *
mvmvif
 =

2254 
	`iwl_mvm_vif_‰om_mac80211
(
tx_blocked_vif
);

2255 
iwl_rx_°a_cß
 
rx_°a_cß
 = {

2256 .
Æl_°a_unblocked
 = 
åue
,

2257 .
vif
 = 
tx_blocked_vif
,

2260 i‡(
mvmvif
->
cß_èrgë_‰eq
 =
rx_°©us
->
‰eq
)

2261 
	`iwl_mvm_°a_modify_dißbÀ_tx_≠
(
mvm
, 
°a
,

2262 
Ál£
);

2263 
	`õì80211_ôî©e_°©i⁄s_©omic
(
mvm
->
hw
,

2264 
iwl_mvm_rx_gë_°a_block_tx
,

2265 &
rx_°a_cß
);

2267 i‡(
rx_°a_cß
.
Æl_°a_unblocked
) {

2268 
	`RCU_INIT_POINTER
(
mvm
->
cß_tx_blocked_vif
, 
NULL
);

2270 
	`iwl_mvm_modify_Æl_°a_dißbÀ_tx
(
mvm
, 
mvmvif
, 
Ál£
);

2271 
	`ˇn˚l_dñayed_w‹k
(&
mvm
->
cs_tx_unblock_dw‹k
);

2275 
	`rs_upd©e_œ°_rssi
(
mvm
, 
mvm°a
, 
rx_°©us
);

2277 
åig
 = 
	`iwl_fw_dbg_åiggî_⁄
(&
mvm
->
fwπ
,

2278 
	`õì80211_vif_to_wdev
(
vif
),

2279 
FW_DBG_TRIGGER_RSSI
);

2281 i‡(
åig
 && 
	`õì80211_is_bóc⁄
(
hdr
->
‰ame_c⁄åﬁ
)) {

2282 
iwl_fw_dbg_åiggî_low_rssi
 *
rssi_åig
;

2283 
s32
 
rssi
;

2285 
rssi_åig
 = (*)
åig
->
d©a
;

2286 
rssi
 = 
	`À32_to_˝u
(
rssi_åig
->rssi);

2288 i‡(
rx_°©us
->
sig«l
 < 
rssi
)

2289 
	`iwl_fw_dbg_cﬁÀ˘_åig
(&
mvm
->
fwπ
, 
åig
,

2290 
NULL
);

2293 i‡(
	`õì80211_is_d©a
(
hdr
->
‰ame_c⁄åﬁ
))

2294 
	`iwl_mvm_rx_csum
(
mvm
, 
°a
, 
skb
, 
pkt
);

2296 i‡(
	`iwl_mvm_is_dup
(
°a
, 
queue
, 
rx_°©us
, 
hdr
, 
desc
)) {

2297 
	`IWL_DEBUG_DROP
(
mvm
, "Dropping duplicateÖacket 0x%x\n",

2298 
	`À16_to_˝u
(
hdr
->
£q_˘æ
));

2299 
	`k‰ì_skb
(
skb
);

2300 
out
;

2309 i‡((
desc
->
mac_Êags2
 & 
IWL_RX_MPDU_MFLG2_AMSDU
) &&

2310 !
	`WARN_ON
(!
	`õì80211_is_d©a_qos
(
hdr
->
‰ame_c⁄åﬁ
))) {

2311 
u8
 *
qc
 = 
	`õì80211_gë_qos_˘l
(
hdr
);

2313 *
qc
 &~
IEEE80211_QOS_CTL_A_MSDU_PRESENT
;

2315 i‡(
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 ==

2316 
IWL_DEVICE_FAMILY_9000
) {

2317 
	`iwl_mvm_Êù_addªss
(
hdr
->
addr3
);

2319 i‡(
	`õì80211_has_a4
(
hdr
->
‰ame_c⁄åﬁ
))

2320 
	`iwl_mvm_Êù_addªss
(
hdr
->
addr4
);

2323 i‡(
baid
 !
IWL_RX_REORDER_DATA_INVALID_BAID
) {

2324 
u32
 
ª‹dî_d©a
 = 
	`À32_to_˝u
(
desc
->reorder_data);

2326 
	`iwl_mvm_agg_rx_ª˚ived
(
mvm
, 
ª‹dî_d©a
, 
baid
);

2331 i‡(!
queue
) {

2332 i‡(
	`u∆ikñy
((
	`õì80211_is_bóc⁄
(
hdr
->
‰ame_c⁄åﬁ
) ||

2333 
	`õì80211_is_¥obe_ª•
(
hdr
->
‰ame_c⁄åﬁ
)) &&

2334 
mvm
->
sched_sˇn_∑ss_Æl
 ==

2335 
SCHED_SCAN_PASS_ALL_ENABLED
))

2336 
mvm
->
sched_sˇn_∑ss_Æl
 = 
SCHED_SCAN_PASS_ALL_FOUND
;

2338 i‡(
	`u∆ikñy
(
	`õì80211_is_bóc⁄
(
hdr
->
‰ame_c⁄åﬁ
) ||

2339 
	`õì80211_is_¥obe_ª•
(
hdr
->
‰ame_c⁄åﬁ
)))

2340 
rx_°©us
->
boŸtime_ns
 = 
	`ktime_gë_boŸtime_ns
();

2343 i‡(
	`iwl_mvm_¸óã_skb
(
mvm
, 
skb
, 
hdr
, 
Àn
, 
¸y±_Àn
, 
rxb
)) {

2344 
	`k‰ì_skb
(
skb
);

2345 
out
;

2348 i‡(!
	`iwl_mvm_ª‹dî
(
mvm
, 
«pi
, 
queue
, 
°a
, 
skb
, 
desc
) &&

2349 
	`likñy
(!
	`iwl_mvm_time_sync_‰ame
(
mvm
, 
skb
, 
hdr
->
addr2
)) &&

2350 
	`likñy
(!
	`iwl_mvm_mei_fûãr_sˇn
(
mvm
, 
skb
))) {

2351 i‡(
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 =
IWL_DEVICE_FAMILY_9000
 &&

2352 (
desc
->
mac_Êags2
 & 
IWL_RX_MPDU_MFLG2_AMSDU
) &&

2353 !(
desc
->
amsdu_öfo
 & 
IWL_RX_MPDU_AMSDU_LAST_SUBFRAME
))

2354 
rx_°©us
->
Êag
 |
RX_FLAG_AMSDU_MORE
;

2356 
	`iwl_mvm_∑ss_∑ckë_to_mac80211
(
mvm
, 
«pi
, 
skb
, 
queue
, 
°a
);

2358 
out
:

2359 
	`rcu_ªad_u∆ock
();

2360 
	}
}

2362 
	$iwl_mvm_rx_m⁄ô‹_no_d©a
(
iwl_mvm
 *
mvm
, 
«pi_°ru˘
 *
«pi
,

2363 
iwl_rx_cmd_buf„r
 *
rxb
, 
queue
)

2365 
õì80211_rx_°©us
 *
rx_°©us
;

2366 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

2367 
iwl_rx_no_d©a_vî_3
 *
desc
 = (*)
pkt
->
d©a
;

2368 
u32
 
rssi
;

2369 
u32
 
öfo_ty≥
;

2370 
õì80211_°a
 *
°a
 = 
NULL
;

2371 
sk_buff
 *
skb
;

2372 
iwl_mvm_rx_phy_d©a
 
phy_d©a
;

2373 
u32
 
f‹m©
;

2375 i‡(
	`u∆ikñy
(
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
)))

2378 i‡(
	`u∆ikñy
(
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
Ë< (
iwl_rx_no_d©a
)))

2381 
rssi
 = 
	`À32_to_˝u
(
desc
->rssi);

2382 
öfo_ty≥
 = 
	`À32_to_˝u
(
desc
->
öfo
Ë& 
RX_NO_DATA_INFO_TYPE_MSK
;

2383 
phy_d©a
.
d0
 = 
desc
->
phy_öfo
[0];

2384 
phy_d©a
.
d1
 = 
desc
->
phy_öfo
[1];

2385 
phy_d©a
.
phy_öfo
 = 
IWL_RX_MPDU_PHY_TSF_OVERLOAD
;

2386 
phy_d©a
.
gp2_⁄_aú_ri£
 = 
	`À32_to_˝u
(
desc
->
⁄_aú_ri£_time
);

2387 
phy_d©a
.
øã_n_Êags
 = 
	`À32_to_˝u
(
desc
->
øã
);

2388 
phy_d©a
.
íîgy_a
 = 
	`u32_gë_bôs
(
rssi
, 
RX_NO_DATA_CHAIN_A_MSK
);

2389 
phy_d©a
.
íîgy_b
 = 
	`u32_gë_bôs
(
rssi
, 
RX_NO_DATA_CHAIN_B_MSK
);

2390 
phy_d©a
.
ch™√l
 = 
	`u32_gë_bôs
(
rssi
, 
RX_NO_DATA_CHANNEL_MSK
);

2391 
phy_d©a
.
wôh_d©a
 = 
Ál£
;

2392 
phy_d©a
.
rx_vec
[0] = 
desc
->rx_vec[0];

2393 
phy_d©a
.
rx_vec
[1] = 
desc
->rx_vec[1];

2395 i‡(
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
DATA_PATH_GROUP
,

2396 
RX_NO_DATA_NOTIF
, 0) < 2) {

2397 
	`IWL_DEBUG_DROP
(
mvm
, "Gotán oldÑate format. OldÑate: 0x%x\n",

2398 
phy_d©a
.
øã_n_Êags
);

2399 
phy_d©a
.
øã_n_Êags
 = 
	`iwl_√w_øã_‰om_v1
(phy_data.rate_n_flags);

2400 
	`IWL_DEBUG_DROP
(
mvm
, " Rateáfter conversionÅoÅheÇew format: 0x%x\n",

2401 
phy_d©a
.
øã_n_Êags
);

2404 
f‹m©
 = 
phy_d©a
.
øã_n_Êags
 & 
RATE_MCS_MOD_TYPE_MSK
;

2406 i‡(
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
DATA_PATH_GROUP
,

2407 
RX_NO_DATA_NOTIF
, 0) >= 3) {

2408 i‡(
	`u∆ikñy
(
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
) <

2409 (
iwl_rx_no_d©a_vî_3
)))

2412 
phy_d©a
.
rx_vec
[2] = 
desc
->rx_vec[2];

2413 
phy_d©a
.
rx_vec
[3] = 
desc
->rx_vec[3];

2415 i‡(
f‹m©
 =
RATE_MCS_EHT_MSK
)

2423 
skb
 = 
	`Æloc_skb
(128, 
GFP_ATOMIC
);

2424 i‡(!
skb
) {

2425 
	`IWL_ERR
(
mvm
, "alloc_skb failed\n");

2429 
rx_°©us
 = 
	`IEEE80211_SKB_RXCB
(
skb
);

2432 
rx_°©us
->
Êag
 |
RX_FLAG_NO_PSDU
;

2434 
öfo_ty≥
) {

2435 
RX_NO_DATA_INFO_TYPE_NDP
:

2436 
rx_°©us
->
zîo_Àngth_psdu_ty≥
 =

2437 
IEEE80211_RADIOTAP_ZERO_LEN_PSDU_SOUNDING
;

2439 
RX_NO_DATA_INFO_TYPE_MU_UNMATCHED
:

2440 
RX_NO_DATA_INFO_TYPE_TB_UNMATCHED
:

2441 
rx_°©us
->
zîo_Àngth_psdu_ty≥
 =

2442 
IEEE80211_RADIOTAP_ZERO_LEN_PSDU_NOT_CAPTURED
;

2445 
rx_°©us
->
zîo_Àngth_psdu_ty≥
 =

2446 
IEEE80211_RADIOTAP_ZERO_LEN_PSDU_VENDOR
;

2450 
rx_°©us
->
b™d
 = 
phy_d©a
.
ch™√l
 > 14 ? 
NL80211_BAND_5GHZ
 :

2451 
NL80211_BAND_2GHZ
;

2453 
	`iwl_mvm_rx_fûl_°©us
(
mvm
, 
skb
, &
phy_d©a
, 
queue
);

2460 
	`skb_ª£t_mac_hódî
(
skb
);

2467 
f‹m©
) {

2468 
RATE_MCS_VHT_MSK
:

2469 
rx_°©us
->
nss
 =

2470 
	`À32_gë_bôs
(
desc
->
rx_vec
[0],

2471 
RX_NO_DATA_RX_VEC0_VHT_NSTS_MSK
) + 1;

2473 
RATE_MCS_HE_MSK
:

2474 
rx_°©us
->
nss
 =

2475 
	`À32_gë_bôs
(
desc
->
rx_vec
[0],

2476 
RX_NO_DATA_RX_VEC0_HE_NSTS_MSK
) + 1;

2478 
RATE_MCS_EHT_MSK
:

2479 
rx_°©us
->
nss
 =

2480 
	`À32_gë_bôs
(
desc
->
rx_vec
[2],

2481 
RX_NO_DATA_RX_VEC2_EHT_NSTS_MSK
) + 1;

2484 
	`rcu_ªad_lock
();

2485 
	`õì80211_rx_«pi
(
mvm
->
hw
, 
°a
, 
skb
, 
«pi
);

2486 
	`rcu_ªad_u∆ock
();

2487 
	}
}

2489 
	$iwl_mvm_rx_‰ame_ªÀa£
(
iwl_mvm
 *
mvm
, 
«pi_°ru˘
 *
«pi
,

2490 
iwl_rx_cmd_buf„r
 *
rxb
, 
queue
)

2492 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

2493 
iwl_‰ame_ªÀa£
 *
ªÀa£
 = (*)
pkt
->
d©a
;

2495 i‡(
	`u∆ikñy
(
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
Ë< (*
ªÀa£
)))

2498 
	`iwl_mvm_ªÀa£_‰ames_‰om_nŸif
(
mvm
, 
«pi
, 
ªÀa£
->
baid
,

2499 
	`À16_to_˝u
(
ªÀa£
->
ns¢
),

2500 
queue
);

2501 
	}
}

2503 
	$iwl_mvm_rx_b¨_‰ame_ªÀa£
(
iwl_mvm
 *
mvm
, 
«pi_°ru˘
 *
«pi
,

2504 
iwl_rx_cmd_buf„r
 *
rxb
, 
queue
)

2506 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

2507 
iwl_b¨_‰ame_ªÀa£
 *
ªÀa£
 = (*)
pkt
->
d©a
;

2508 
baid
 = 
	`À32_gë_bôs
(
ªÀa£
->
ba_öfo
,

2509 
IWL_BAR_FRAME_RELEASE_BAID_MASK
);

2510 
ns¢
 = 
	`À32_gë_bôs
(
ªÀa£
->
ba_öfo
,

2511 
IWL_BAR_FRAME_RELEASE_NSSN_MASK
);

2512 
°a_id
 = 
	`À32_gë_bôs
(
ªÀa£
->
°a_tid
,

2513 
IWL_BAR_FRAME_RELEASE_STA_MASK
);

2514 
tid
 = 
	`À32_gë_bôs
(
ªÀa£
->
°a_tid
,

2515 
IWL_BAR_FRAME_RELEASE_TID_MASK
);

2516 
iwl_mvm_baid_d©a
 *
baid_d©a
;

2518 i‡(
	`u∆ikñy
(
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
Ë< (*
ªÀa£
)))

2521 i‡(
	`WARN_ON_ONCE
(
baid
 =
IWL_RX_REORDER_DATA_INVALID_BAID
 ||

2522 
baid
 >
	`ARRAY_SIZE
(
mvm
->
baid_m≠
)))

2525 
	`rcu_ªad_lock
();

2526 
baid_d©a
 = 
	`rcu_dîe„ªn˚
(
mvm
->
baid_m≠
[
baid
]);

2527 i‡(!
baid_d©a
) {

2528 
	`IWL_DEBUG_RX
(
mvm
,

2530 
baid
);

2531 
out
;

2534 i‡(
	`WARN
(
tid
 !
baid_d©a
->tid || 
°a_id
 > 
IWL_MVM_STATION_COUNT_MAX
 ||

2535 !(
baid_d©a
->
°a_mask
 & 
	`BIT
(
°a_id
)),

2537 
baid
, 
baid_d©a
->
°a_mask
, baid_d©a->
tid
, 
°a_id
,

2538 
tid
))

2539 
out
;

2541 
	`IWL_DEBUG_DROP
(
mvm
, "Receivedá BAR,ÉxpectÖacketÜoss:Çssn %d\n",

2542 
ns¢
);

2544 
	`iwl_mvm_ªÀa£_‰ames_‰om_nŸif
(
mvm
, 
«pi
, 
baid
, 
ns¢
, 
queue
);

2545 
out
:

2546 
	`rcu_ªad_u∆ock
();

2547 
	}
}

	@scan.c

7 
	~<löux/ëhîdevi˚.h
>

8 
	~<√t/mac80211.h
>

9 
	~<löux/¸c32.h
>

11 
	~"mvm.h
"

12 
	~"fw/≠i/sˇn.h
"

13 
	~"iwl-io.h
"

15 
	#IWL_DENSE_EBS_SCAN_RATIO
 5

	)

16 
	#IWL_SPARSE_EBS_SCAN_RATIO
 1

	)

18 
	#IWL_SCAN_DWELL_ACTIVE
 10

	)

19 
	#IWL_SCAN_DWELL_PASSIVE
 110

	)

20 
	#IWL_SCAN_DWELL_FRAGMENTED
 44

	)

21 
	#IWL_SCAN_DWELL_EXTENDED
 90

	)

22 
	#IWL_SCAN_NUM_OF_FRAGS
 3

	)

25 
	#IWL_SCAN_ADWELL_MAX_BUDGET_FULL_SCAN
 300

	)

27 
	#IWL_SCAN_ADWELL_MAX_BUDGET_DIRECTED_SCAN
 100

	)

29 
	#IWL_SCAN_ADWELL_DEFAULT_HB_N_APS
 8

	)

31 
	#IWL_SCAN_ADWELL_DEFAULT_LB_N_APS
 2

	)

33 
	#IWL_SCAN_ADWELL_DEFAULT_N_APS_SOCIAL
 10

	)

35 
	#IWL_SCAN_NUM_CHANNELS
 112

	)

37 
	#IWL_SCAN_ADWELL_N_APS_GO_FRIENDLY_BIT
 
	`BIT
(20)

	)

39 
	#IWL_SCAN_ADWELL_N_APS_SOCIAL_CHS_BIT
 
	`BIT
(21)

	)

41 
	#IWL_SCAN_ADWELL_N_APS_GO_FRIENDLY
 10

	)

43 
	#IWL_SCAN_ADWELL_N_APS_SOCIAL_CHS
 2

	)

46 
	#IWL_MVM_6GHZ_PASSIVE_SCAN_MIN_CHANS
 4

	)

49 
	#IWL_MEI_SCAN_NUM_ITER
 5U

	)

51 
	siwl_mvm_sˇn_timög_∑øms
 {

52 
u32
 
	msu•íd_time
;

53 
u32
 
	mmax_out_time
;

56 
iwl_mvm_sˇn_timög_∑øms
 
	gsˇn_timög
[] = {

57 [
IWL_SCAN_TYPE_UNASSOC
] = {

58 .
su•íd_time
 = 0,

59 .
	gmax_out_time
 = 0,

61 [
IWL_SCAN_TYPE_WILD
] = {

62 .
su•íd_time
 = 30,

63 .
	gmax_out_time
 = 120,

65 [
IWL_SCAN_TYPE_MILD
] = {

66 .
su•íd_time
 = 120,

67 .
	gmax_out_time
 = 120,

69 [
IWL_SCAN_TYPE_FRAGMENTED
] = {

70 .
su•íd_time
 = 95,

71 .
	gmax_out_time
 = 44,

73 [
IWL_SCAN_TYPE_FAST_BALANCE
] = {

74 .
su•íd_time
 = 30,

75 .
	gmax_out_time
 = 37,

79 
	siwl_mvm_sˇn_∑øms
 {

81 
iwl_mvm_sˇn_ty≥
 
	mty≥
;

82 
iwl_mvm_sˇn_ty≥
 
	mhb_ty≥
;

83 
u32
 
	mn_ch™√ls
;

84 
u16
 
	mdñay
;

85 
	mn_ssids
;

86 
cfg80211_ssid
 *
	mssids
;

87 
õì80211_ch™√l
 **
	mch™√ls
;

88 
u32
 
	mÊags
;

89 
u8
 *
	mmac_addr
;

90 
u8
 *
	mmac_addr_mask
;

91 
boﬁ
 
	mno_cck
;

92 
boﬁ
 
	m∑ss_Æl
;

93 
	mn_m©ch_£ts
;

94 
iwl_sˇn_¥obe_ªq
 
	m¥eq
;

95 
cfg80211_m©ch_£t
 *
	mm©ch_£ts
;

96 
	mn_sˇn_∂™s
;

97 
cfg80211_sched_sˇn_∂™
 *
	msˇn_∂™s
;

98 
boﬁ
 
	môî_nŸif
;

99 
cfg80211_sˇn_6ghz_∑øms
 *
	msˇn_6ghz_∑øms
;

100 
u32
 
	mn_6ghz_∑øms
;

101 
boﬁ
 
	msˇn_6ghz
;

102 
boﬁ
 
	míabÀ_6ghz_∑ssive
;

103 
boﬁ
 
	mª•e˘_p2p_go
, 
	mª•e˘_p2p_go_hb
;

104 
s8
 
	mtsf_ªp‹t_lök_id
;

105 
u8
 
	mbssid
[
ETH_ALEN
] 
__Æig√d
(2);

108 
ölöe
 *
	$iwl_mvm_gë_sˇn_ªq_umac_d©a
(
iwl_mvm
 *
mvm
)

110 
iwl_sˇn_ªq_umac
 *
cmd
 = 
mvm
->
sˇn_cmd
;

112 i‡(
	`iwl_mvm_is_ad≠tive_dwñl_v2_suµ‹ãd
(
mvm
))

113  (*)&
cmd
->
v8
.
d©a
;

115 i‡(
	`iwl_mvm_is_ad≠tive_dwñl_suµ‹ãd
(
mvm
))

116  (*)&
cmd
->
v7
.
d©a
;

118 i‡(
	`iwl_mvm_cdb_sˇn_≠i
(
mvm
))

119  (*)&
cmd
->
v6
.
d©a
;

121  (*)&
cmd
->
v1
.
d©a
;

122 
	}
}

124 
ölöe
 
iwl_sˇn_umac_ch™_∑øm
 *

125 
	$iwl_mvm_gë_sˇn_ªq_umac_ch™√l
(
iwl_mvm
 *
mvm
)

127 
iwl_sˇn_ªq_umac
 *
cmd
 = 
mvm
->
sˇn_cmd
;

129 i‡(
	`iwl_mvm_is_ad≠tive_dwñl_v2_suµ‹ãd
(
mvm
))

130  &
cmd
->
v8
.
ch™√l
;

132 i‡(
	`iwl_mvm_is_ad≠tive_dwñl_suµ‹ãd
(
mvm
))

133  &
cmd
->
v7
.
ch™√l
;

135 i‡(
	`iwl_mvm_cdb_sˇn_≠i
(
mvm
))

136  &
cmd
->
v6
.
ch™√l
;

138  &
cmd
->
v1
.
ch™√l
;

139 
	}
}

141 
u8
 
	$iwl_mvm_sˇn_rx_™t
(
iwl_mvm
 *
mvm
)

143 i‡(
mvm
->
sˇn_rx_™t
 !
ANT_NONE
)

144  
mvm
->
sˇn_rx_™t
;

145  
	`iwl_mvm_gë_vÆid_rx_™t
(
mvm
);

146 
	}
}

148 
ölöe
 
__À16
 
	$iwl_mvm_sˇn_rx_chaö
(
iwl_mvm
 *
mvm
)

150 
u16
 
rx_chaö
;

151 
u8
 
rx_™t
;

153 
rx_™t
 = 
	`iwl_mvm_sˇn_rx_™t
(
mvm
);

154 
rx_chaö
 = 
rx_™t
 << 
PHY_RX_CHAIN_VALID_POS
;

155 
rx_chaö
 |
rx_™t
 << 
PHY_RX_CHAIN_FORCE_MIMO_SEL_POS
;

156 
rx_chaö
 |
rx_™t
 << 
PHY_RX_CHAIN_FORCE_SEL_POS
;

157 
rx_chaö
 |0x1 << 
PHY_RX_CHAIN_DRIVER_FORCE_POS
;

158  
	`˝u_to_À16
(
rx_chaö
);

159 
	}
}

161 
ölöe
 
__À32


162 
	$iwl_mvm_sˇn_øã_n_Êags
(
iwl_mvm
 *
mvm
, 
∆80211_b™d
 
b™d
,

163 
boﬁ
 
no_cck
)

165 
u32
 
tx_™t
;

167 
	`iwl_mvm_toggÀ_tx_™t
(
mvm
, &mvm->
sˇn_œ°_™ã¬a_idx
);

168 
tx_™t
 = 
	`BIT
(
mvm
->
sˇn_œ°_™ã¬a_idx
Ë<< 
RATE_MCS_ANT_POS
;

170 i‡(
b™d
 =
NL80211_BAND_2GHZ
 && !
no_cck
)

171  
	`˝u_to_À32
(
IWL_RATE_1M_PLCP
 | 
RATE_MCS_CCK_MSK_V1
 |

172 
tx_™t
);

174  
	`˝u_to_À32
(
IWL_RATE_6M_PLCP
 | 
tx_™t
);

175 
	}
}

177 
iwl_mvm_åaffic_lﬂd
 
	$iwl_mvm_gë_åaffic_lﬂd
(
iwl_mvm
 *
mvm
)

179  
mvm
->
tcm
.
ªsu…
.
globÆ_lﬂd
;

180 
	}
}

182 
iwl_mvm_åaffic_lﬂd


183 
	$iwl_mvm_gë_åaffic_lﬂd_b™d
(
iwl_mvm
 *
mvm
, 
∆80211_b™d
 
b™d
)

185  
mvm
->
tcm
.
ªsu…
.
b™d_lﬂd
[
b™d
];

186 
	}
}

188 
	siwl_mvm_sˇn_ôî_d©a
 {

189 
u32
 
	mglobÆ_˙t
;

190 
õì80211_vif
 *
	mcuºít_vif
;

191 
boﬁ
 
	mis_dcm_wôh_p2p_go
;

194 
	$iwl_mvm_sˇn_ôî©‹
(*
_d©a
, 
u8
 *
mac
,

195 
õì80211_vif
 *
vif
)

197 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

198 
iwl_mvm_sˇn_ôî_d©a
 *
d©a
 = 
_d©a
;

199 
iwl_mvm_vif
 *
cuº_mvmvif
;

201 i‡(
vif
->
ty≥
 !
NL80211_IFTYPE_P2P_DEVICE
 &&

202 
mvmvif
->
deÊök
.
phy_˘xt
 &&

203 
mvmvif
->
deÊök
.
phy_˘xt
->
id
 < 
NUM_PHY_CTX
)

204 
d©a
->
globÆ_˙t
 += 1;

206 i‡(!
d©a
->
cuºít_vif
 || 
vif
 == data->current_vif)

209 
cuº_mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
d©a
->
cuºít_vif
);

211 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
 && vif->
p2p
 &&

212 
mvmvif
->
deÊök
.
phy_˘xt
 && 
cuº_mvmvif
->deflink.phy_ctxt &&

213 
mvmvif
->
deÊök
.
phy_˘xt
->
id
 !
cuº_mvmvif
->deflink.phy_ctxt->id)

214 
d©a
->
is_dcm_wôh_p2p_go
 = 
åue
;

215 
	}
}

218 
iwl_mvm_sˇn_ty≥
 
	$_iwl_mvm_gë_sˇn_ty≥
(
iwl_mvm
 *
mvm
,

219 
õì80211_vif
 *
vif
,

220 
iwl_mvm_åaffic_lﬂd
 
lﬂd
,

221 
boﬁ
 
low_œãncy
)

223 
iwl_mvm_sˇn_ôî_d©a
 
d©a
 = {

224 .
cuºít_vif
 = 
vif
,

225 .
is_dcm_wôh_p2p_go
 = 
Ál£
,

226 .
globÆ_˙t
 = 0,

229 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s_©omic
(
mvm
->
hw
,

230 
IEEE80211_IFACE_ITER_NORMAL
,

231 
iwl_mvm_sˇn_ôî©‹
,

232 &
d©a
);

234 i‡(!
d©a
.
globÆ_˙t
)

235  
IWL_SCAN_TYPE_UNASSOC
;

237 i‡(
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

238 
IWL_UCODE_TLV_API_FRAGMENTED_SCAN
)) {

239 i‡((
lﬂd
 =
IWL_MVM_TRAFFIC_HIGH
 || 
low_œãncy
) &&

240 (!
vif
 || vif->
ty≥
 !
NL80211_IFTYPE_P2P_DEVICE
))

241  
IWL_SCAN_TYPE_FRAGMENTED
;

247 i‡(
vif
 && vif->
ty≥
 =
NL80211_IFTYPE_STATION
 &&

248 
d©a
.
is_dcm_wôh_p2p_go
)

249  
IWL_SCAN_TYPE_FAST_BALANCE
;

252 i‡(
lﬂd
 >
IWL_MVM_TRAFFIC_MEDIUM
 || 
low_œãncy
)

253  
IWL_SCAN_TYPE_MILD
;

255  
IWL_SCAN_TYPE_WILD
;

256 
	}
}

259 
iwl_mvm_sˇn_ty≥
 
	$iwl_mvm_gë_sˇn_ty≥
(
iwl_mvm
 *
mvm
,

260 
õì80211_vif
 *
vif
)

262 
iwl_mvm_åaffic_lﬂd
 
lﬂd
;

263 
boﬁ
 
low_œãncy
;

265 
lﬂd
 = 
	`iwl_mvm_gë_åaffic_lﬂd
(
mvm
);

266 
low_œãncy
 = 
	`iwl_mvm_low_œãncy
(
mvm
);

268  
	`_iwl_mvm_gë_sˇn_ty≥
(
mvm
, 
vif
, 
lﬂd
, 
low_œãncy
);

269 
	}
}

272 
iwl_mvm_sˇn_ty≥
 
	$iwl_mvm_gë_sˇn_ty≥_b™d
(
iwl_mvm
 *
mvm
,

273 
õì80211_vif
 *
vif
,

274 
∆80211_b™d
 
b™d
)

276 
iwl_mvm_åaffic_lﬂd
 
lﬂd
;

277 
boﬁ
 
low_œãncy
;

279 
lﬂd
 = 
	`iwl_mvm_gë_åaffic_lﬂd_b™d
(
mvm
, 
b™d
);

280 
low_œãncy
 = 
	`iwl_mvm_low_œãncy_b™d
(
mvm
, 
b™d
);

282  
	`_iwl_mvm_gë_sˇn_ty≥
(
mvm
, 
vif
, 
lﬂd
, 
low_œãncy
);

283 
	}
}

285 
ölöe
 
boﬁ
 
	$iwl_mvm_ºm_sˇn_√eded
(
iwl_mvm
 *
mvm
)

288  
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

289 
IWL_UCODE_TLV_CAPA_DS_PARAM_SET_IE_SUPPORT
);

290 
	}
}

292 
	$iwl_mvm_max_sˇn_õ_fw_cmd_room
(
iwl_mvm
 *
mvm
)

294 
max_¥obe_Àn
;

296 
max_¥obe_Àn
 = 
SCAN_OFFLOAD_PROBE_REQ_SIZE
;

299 
max_¥obe_Àn
 -= 24 + 2;

302 i‡(
	`iwl_mvm_ºm_sˇn_√eded
(
mvm
))

303 
max_¥obe_Àn
 -= 3;

305  
max_¥obe_Àn
;

306 
	}
}

308 
	$iwl_mvm_max_sˇn_õ_Àn
(
iwl_mvm
 *
mvm
)

310 
max_õ_Àn
 = 
	`iwl_mvm_max_sˇn_õ_fw_cmd_room
(
mvm
);

322  
max_õ_Àn
;

323 
	}
}

325 
	$iwl_mvm_rx_lmac_sˇn_ôî_com∂ëe_nŸif
(
iwl_mvm
 *
mvm
,

326 
iwl_rx_cmd_buf„r
 *
rxb
)

328 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

329 
iwl_lmac_sˇn_com∂ëe_nŸif
 *
nŸif
 = (*)
pkt
->
d©a
;

331 
	`IWL_DEBUG_SCAN
(
mvm
,

333 
nŸif
->
°©us
,ÇŸif->
sˇ¬ed_ch™√ls
);

335 i‡(
mvm
->
sched_sˇn_∑ss_Æl
 =
SCHED_SCAN_PASS_ALL_FOUND
) {

336 
	`IWL_DEBUG_SCAN
(
mvm
, "Passáll scheduled scanÑesults found\n");

337 
	`õì80211_sched_sˇn_ªsu…s
(
mvm
->
hw
);

338 
mvm
->
sched_sˇn_∑ss_Æl
 = 
SCHED_SCAN_PASS_ALL_ENABLED
;

340 
	}
}

342 
	$iwl_mvm_rx_sˇn_m©ch_found
(
iwl_mvm
 *
mvm
,

343 
iwl_rx_cmd_buf„r
 *
rxb
)

345 
	`IWL_DEBUG_SCAN
(
mvm
, "Scheduled scanÑesults\n");

346 
	`õì80211_sched_sˇn_ªsu…s
(
mvm
->
hw
);

347 
	}
}

349 c⁄° *
	$iwl_mvm_ebs_°©us_°r
(
iwl_sˇn_ebs_°©us
 
°©us
)

351 
°©us
) {

352 
IWL_SCAN_EBS_SUCCESS
:

354 
IWL_SCAN_EBS_INACTIVE
:

356 
IWL_SCAN_EBS_FAILED
:

357 
IWL_SCAN_EBS_CHAN_NOT_FOUND
:

361 
	}
}

363 
	$iwl_mvm_rx_lmac_sˇn_com∂ëe_nŸif
(
iwl_mvm
 *
mvm
,

364 
iwl_rx_cmd_buf„r
 *
rxb
)

366 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

367 
iwl_≥riodic_sˇn_com∂ëe
 *
sˇn_nŸif
 = (*)
pkt
->
d©a
;

368 
boﬁ
 
ab‹ãd
 = (
sˇn_nŸif
->
°©us
 =
IWL_SCAN_OFFLOAD_ABORTED
);

373 i‡(
	`WARN_ON_ONCE
(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

374 
IWL_UCODE_TLV_CAPA_UMAC_SCAN
)))

378 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

390 i‡(
mvm
->
sˇn_°©us
 & 
IWL_MVM_SCAN_STOPPING_SCHED
) {

391 
	`WARN_ON_ONCE
(
mvm
->
sˇn_°©us
 & 
IWL_MVM_SCAN_STOPPING_REGULAR
);

393 
	`IWL_DEBUG_SCAN
(
mvm
, "Scheduled scan %s, EBS status %s\n",

394 
ab‹ãd
 ? "aborted" : "completed",

395 
	`iwl_mvm_ebs_°©us_°r
(
sˇn_nŸif
->
ebs_°©us
));

396 
	`IWL_DEBUG_SCAN
(
mvm
,

398 
sˇn_nŸif
->
œ°_scheduÀ_löe
,

399 
sˇn_nŸif
->
œ°_scheduÀ_ôî©i⁄
,

400 
	`__À32_to_˝u
(
sˇn_nŸif
->
time_a·î_œ°_ôî
));

402 
mvm
->
sˇn_°©us
 &~
IWL_MVM_SCAN_STOPPING_SCHED
;

403 } i‡(
mvm
->
sˇn_°©us
 & 
IWL_MVM_SCAN_STOPPING_REGULAR
) {

404 
	`IWL_DEBUG_SCAN
(
mvm
, "Regular scan %s, EBS status %s\n",

405 
ab‹ãd
 ? "aborted" : "completed",

406 
	`iwl_mvm_ebs_°©us_°r
(
sˇn_nŸif
->
ebs_°©us
));

408 
mvm
->
sˇn_°©us
 &~
IWL_MVM_SCAN_STOPPING_REGULAR
;

409 } i‡(
mvm
->
sˇn_°©us
 & 
IWL_MVM_SCAN_SCHED
) {

410 
	`WARN_ON_ONCE
(
mvm
->
sˇn_°©us
 & 
IWL_MVM_SCAN_REGULAR
);

412 
	`IWL_DEBUG_SCAN
(
mvm
, "Scheduled scan %s, EBS status %s\n",

413 
ab‹ãd
 ? "aborted" : "completed",

414 
	`iwl_mvm_ebs_°©us_°r
(
sˇn_nŸif
->
ebs_°©us
));

415 
	`IWL_DEBUG_SCAN
(
mvm
,

417 
sˇn_nŸif
->
œ°_scheduÀ_löe
,

418 
sˇn_nŸif
->
œ°_scheduÀ_ôî©i⁄
,

419 
	`__À32_to_˝u
(
sˇn_nŸif
->
time_a·î_œ°_ôî
));

421 
mvm
->
sˇn_°©us
 &~
IWL_MVM_SCAN_SCHED
;

422 
	`õì80211_sched_sˇn_°›≥d
(
mvm
->
hw
);

423 
mvm
->
sched_sˇn_∑ss_Æl
 = 
SCHED_SCAN_PASS_ALL_DISABLED
;

424 } i‡(
mvm
->
sˇn_°©us
 & 
IWL_MVM_SCAN_REGULAR
) {

425 
cfg80211_sˇn_öfo
 
öfo
 = {

426 .
ab‹ãd
 =áborted,

429 
	`IWL_DEBUG_SCAN
(
mvm
, "Regular scan %s, EBS status %s (FW)\n",

430 
ab‹ãd
 ? "aborted" : "completed",

431 
	`iwl_mvm_ebs_°©us_°r
(
sˇn_nŸif
->
ebs_°©us
));

433 
mvm
->
sˇn_°©us
 &~
IWL_MVM_SCAN_REGULAR
;

434 
	`õì80211_sˇn_com∂ëed
(
mvm
->
hw
, &
öfo
);

435 
	`ˇn˚l_dñayed_w‹k
(&
mvm
->
sˇn_timeout_dw‹k
);

436 
	`iwl_mvm_ªsume_tcm
(
mvm
);

438 
	`IWL_ERR
(
mvm
,

442 
mvm
->
œ°_ebs_suc˚ssful
 =

443 
sˇn_nŸif
->
ebs_°©us
 =
IWL_SCAN_EBS_SUCCESS
 ||

444 
sˇn_nŸif
->
ebs_°©us
 =
IWL_SCAN_EBS_INACTIVE
;

445 
	}
}

447 
	$iwl_ssid_exi°
(
u8
 *
ssid
, u8 
ssid_Àn
, 
iwl_ssid_õ
 *
ssid_li°
)

449 
i
;

451 
i
 = 0; i < 
PROBE_OPTION_MAX
; i++) {

452 i‡(!
ssid_li°
[
i
].
Àn
)

454 i‡(
ssid_li°
[
i
].
Àn
 =
ssid_Àn
 &&

455 !
	`memcmp
(
ssid_li°
->
ssid
, ssid, 
ssid_Àn
))

456  
i
;

459 
	}
}

464 
	$iwl_sˇn_buûd_ssids
(
iwl_mvm_sˇn_∑øms
 *
∑øms
,

465 
iwl_ssid_õ
 *
ssids
,

466 
u32
 *
ssid_bôm≠
)

468 
i
, 
j
;

469 
ödex
;

470 
u32
 
tmp_bôm≠
 = 0;

477 
i
 = 0, 
j
 = 
∑øms
->
n_m©ch_£ts
 - 1;

478 
j
 >0 && 
i
 < 
PROBE_OPTION_MAX
;

479 
i
++, 
j
--) {

481 i‡(!
∑øms
->
m©ch_£ts
[
j
].
ssid
.
ssid_Àn
)

483 
ssids
[
i
].
id
 = 
WLAN_EID_SSID
;

484 
ssids
[
i
].
Àn
 = 
∑øms
->
m©ch_£ts
[
j
].
ssid
.
ssid_Àn
;

485 
	`mem˝y
(
ssids
[
i
].
ssid
, 
∑øms
->
m©ch_£ts
[
j
].ssid.ssid,

486 
ssids
[
i
].
Àn
);

490 
j
 = 
∑øms
->
n_ssids
 - 1;

491 
j
 >0 && 
i
 < 
PROBE_OPTION_MAX
;

492 
i
++, 
j
--) {

493 
ödex
 = 
	`iwl_ssid_exi°
(
∑øms
->
ssids
[
j
].
ssid
,

494 
∑øms
->
ssids
[
j
].
ssid_Àn
,

495 
ssids
);

496 i‡(
ödex
 < 0) {

497 
ssids
[
i
].
id
 = 
WLAN_EID_SSID
;

498 
ssids
[
i
].
Àn
 = 
∑øms
->ssids[
j
].
ssid_Àn
;

499 
	`mem˝y
(
ssids
[
i
].
ssid
, 
∑øms
->ssids[
j
].ssid,

500 
ssids
[
i
].
Àn
);

501 
tmp_bôm≠
 |
	`BIT
(
i
);

503 
tmp_bôm≠
 |
	`BIT
(
ödex
);

506 i‡(
ssid_bôm≠
)

507 *
ssid_bôm≠
 = 
tmp_bôm≠
;

508 
	}
}

511 
	$iwl_mvm_c⁄fig_sched_sˇn_¥ofûes
(
iwl_mvm
 *
mvm
,

512 
cfg80211_sched_sˇn_ªque°
 *
ªq
)

514 
iwl_sˇn_ofÊﬂd_¥ofûe
 *
¥ofûe
;

515 
iwl_sˇn_ofÊﬂd_¥ofûe_cfg_v1
 *
¥ofûe_cfg_v1
;

516 
iwl_sˇn_ofÊﬂd_blockli°
 *
blockli°
;

517 
iwl_sˇn_ofÊﬂd_¥ofûe_cfg_d©a
 *
d©a
;

518 
max_¥ofûes
 = 
	`iwl_umac_sˇn_gë_max_¥ofûes
(
mvm
->
fw
);

519 
¥ofûe_cfg_size
 = (*
d©a
) +

520 (*
¥ofûe
Ë* 
max_¥ofûes
;

521 
iwl_ho°_cmd
 
cmd
 = {

522 .
id
 = 
SCAN_OFFLOAD_UPDATE_PROFILES_CMD
,

523 .
Àn
[1] = 
¥ofûe_cfg_size
,

524 .
d©aÊags
[0] = 
IWL_HCMD_DFL_NOCOPY
,

525 .
d©aÊags
[1] = 
IWL_HCMD_DFL_NOCOPY
,

527 
blockli°_Àn
;

528 
i
;

529 
ªt
;

531 i‡(
	`WARN_ON
(
ªq
->
n_m©ch_£ts
 > 
max_¥ofûes
))

532  -
EIO
;

534 i‡(
mvm
->
fw
->
ucode_ˇ∑
.
Êags
 & 
IWL_UCODE_TLV_FLAGS_SHORT_BL
)

535 
blockli°_Àn
 = 
IWL_SCAN_SHORT_BLACKLIST_LEN
;

537 
blockli°_Àn
 = 
IWL_SCAN_MAX_BLACKLIST_LEN
;

539 
blockli°
 = 
	`kˇŒoc
(
blockli°_Àn
, (*blockli°), 
GFP_KERNEL
);

540 i‡(!
blockli°
)

541  -
ENOMEM
;

543 
¥ofûe_cfg_v1
 = 
	`kzÆloc
(
¥ofûe_cfg_size
, 
GFP_KERNEL
);

544 i‡(!
¥ofûe_cfg_v1
) {

545 
ªt
 = -
ENOMEM
;

546 
‰ì_blockli°
;

549 
cmd
.
d©a
[0] = 
blockli°
;

550 
cmd
.
Àn
[0] = (*
blockli°
Ë* 
blockli°_Àn
;

551 
cmd
.
d©a
[1] = 
¥ofûe_cfg_v1
;

554 i‡(
max_¥ofûes
 =
IWL_SCAN_MAX_PROFILES_V2
) {

555 
iwl_sˇn_ofÊﬂd_¥ofûe_cfg
 *
¥ofûe_cfg
 =

556 (
iwl_sˇn_ofÊﬂd_¥ofûe_cfg
 *)
¥ofûe_cfg_v1
;

558 
d©a
 = &
¥ofûe_cfg
->data;

560 
d©a
 = &
¥ofûe_cfg_v1
->data;

564 
d©a
->
num_¥ofûes
 = 
ªq
->
n_m©ch_£ts
;

565 
d©a
->
a˘ive_˛õ¡s
 = 
SCAN_CLIENT_SCHED_SCAN
;

566 
d©a
->
∑ss_m©ch
 = 
SCAN_CLIENT_SCHED_SCAN
;

567 
d©a
->
m©ch_nŸify
 = 
SCAN_CLIENT_SCHED_SCAN
;

569 i‡(!
ªq
->
n_m©ch_£ts
 || !ªq->
m©ch_£ts
[0].
ssid
.
ssid_Àn
)

570 
d©a
->
™y_bóc⁄_nŸify
 = 
SCAN_CLIENT_SCHED_SCAN
;

572 
i
 = 0; i < 
ªq
->
n_m©ch_£ts
; i++) {

573 
¥ofûe
 = &
¥ofûe_cfg_v1
->
¥ofûes
[
i
];

574 
¥ofûe
->
ssid_ödex
 = 
i
;

576 
¥ofûe
->
uniˇ°_cùhî
 = 0xff;

577 
¥ofûe
->
auth_Æg
 = 
IWL_AUTH_ALGO_UNSUPPORTED
 |

578 
IWL_AUTH_ALGO_NONE
 | 
IWL_AUTH_ALGO_PSK
 | 
IWL_AUTH_ALGO_8021X
 |

579 
IWL_AUTH_ALGO_SAE
 | 
IWL_AUTH_ALGO_8021X_SHA384
 | 
IWL_AUTH_ALGO_OWE
;

580 
¥ofûe
->
√tw‹k_ty≥
 = 
IWL_NETWORK_TYPE_ANY
;

581 
¥ofûe
->
b™d_£À˘i⁄
 = 
IWL_SCAN_OFFLOAD_SELECT_ANY
;

582 
¥ofûe
->
˛õ¡_bôm≠
 = 
SCAN_CLIENT_SCHED_SCAN
;

585 
	`IWL_DEBUG_SCAN
(
mvm
, "Sending scheduled scanÖrofile config\n");

587 
ªt
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
cmd
);

588 
	`k‰ì
(
¥ofûe_cfg_v1
);

589 
‰ì_blockli°
:

590 
	`k‰ì
(
blockli°
);

592  
ªt
;

593 
	}
}

595 
boﬁ
 
	$iwl_mvm_sˇn_∑ss_Æl
(
iwl_mvm
 *
mvm
,

596 
cfg80211_sched_sˇn_ªque°
 *
ªq
)

598 i‡(
ªq
->
n_m©ch_£ts
 &&Ñeq->
m©ch_£ts
[0].
ssid
.
ssid_Àn
) {

599 
	`IWL_DEBUG_SCAN
(
mvm
,

601 
ªq
->
n_m©ch_£ts
);

602 
mvm
->
sched_sˇn_∑ss_Æl
 = 
SCHED_SCAN_PASS_ALL_DISABLED
;

603  
Ál£
;

606 
	`IWL_DEBUG_SCAN
(
mvm
, "Sending Scheduled scan without filtering\n");

608 
mvm
->
sched_sˇn_∑ss_Æl
 = 
SCHED_SCAN_PASS_ALL_ENABLED
;

609  
åue
;

610 
	}
}

612 
	$iwl_mvm_lmac_sˇn_ab‹t
(
iwl_mvm
 *
mvm
)

614 
ªt
;

615 
iwl_ho°_cmd
 
cmd
 = {

616 .
id
 = 
SCAN_OFFLOAD_ABORT_CMD
,

618 
u32
 
°©us
 = 
CAN_ABORT_STATUS
;

620 
ªt
 = 
	`iwl_mvm_£nd_cmd_°©us
(
mvm
, &
cmd
, &
°©us
);

621 i‡(
ªt
)

622  
ªt
;

624 i‡(
°©us
 !
CAN_ABORT_STATUS
) {

632 
	`IWL_DEBUG_SCAN
(
mvm
, "SCAN OFFLOAD ABORTÑë %d.\n", 
°©us
);

633 
ªt
 = -
ENOENT
;

636  
ªt
;

637 
	}
}

639 
	$iwl_mvm_sˇn_fûl_tx_cmd
(
iwl_mvm
 *
mvm
,

640 
iwl_sˇn_ªq_tx_cmd
 *
tx_cmd
,

641 
boﬁ
 
no_cck
)

643 
tx_cmd
[0].
tx_Êags
 = 
	`˝u_to_À32
(
TX_CMD_FLG_SEQ_CTL
 |

644 
TX_CMD_FLG_BT_DIS
);

645 
tx_cmd
[0].
øã_n_Êags
 = 
	`iwl_mvm_sˇn_øã_n_Êags
(
mvm
,

646 
NL80211_BAND_2GHZ
,

647 
no_cck
);

649 i‡(!
	`iwl_mvm_has_√w_°©i⁄_≠i
(
mvm
->
fw
)) {

650 
tx_cmd
[0].
°a_id
 = 
mvm
->
aux_°a
.sta_id;

651 
tx_cmd
[1].
°a_id
 = 
mvm
->
aux_°a
.sta_id;

658 
tx_cmd
[0].
°a_id
 = 0xff;

659 
tx_cmd
[1].
°a_id
 = 0xff;

662 
tx_cmd
[1].
tx_Êags
 = 
	`˝u_to_À32
(
TX_CMD_FLG_SEQ_CTL
 |

663 
TX_CMD_FLG_BT_DIS
);

665 
tx_cmd
[1].
øã_n_Êags
 = 
	`iwl_mvm_sˇn_øã_n_Êags
(
mvm
,

666 
NL80211_BAND_5GHZ
,

667 
no_cck
);

668 
	}
}

671 
	$iwl_mvm_lmac_sˇn_cfg_ch™√ls
(
iwl_mvm
 *
mvm
,

672 
õì80211_ch™√l
 **
ch™√ls
,

673 
n_ch™√ls
, 
u32
 
ssid_bôm≠
,

674 
iwl_sˇn_ªq_lmac
 *
cmd
)

676 
iwl_sˇn_ch™√l_cfg_lmac
 *
ch™√l_cfg
 = (*)&
cmd
->
d©a
;

677 
i
;

679 
i
 = 0; i < 
n_ch™√ls
; i++) {

680 
ch™√l_cfg
[
i
].
ch™√l_num
 =

681 
	`˝u_to_À16
(
ch™√ls
[
i
]->
hw_vÆue
);

682 
ch™√l_cfg
[
i
].
ôî_cou¡
 = 
	`˝u_to_À16
(1);

683 
ch™√l_cfg
[
i
].
ôî_öãrvÆ
 = 0;

684 
ch™√l_cfg
[
i
].
Êags
 =

685 
	`˝u_to_À32
(
IWL_UNIFIED_SCAN_CHANNEL_PARTIAL
 |

686 
ssid_bôm≠
);

688 
	}
}

690 
u8
 *
	$iwl_mvm_c›y_™d_ö£π_ds_ñem
(
iwl_mvm
 *
mvm
, c⁄° 
u8
 *
õs
,

691 
size_t
 
Àn
, 
u8
 *c⁄° 
pos
)

693 c⁄° 
u8
 
bef‹e_ds_∑øms
[] = {

694 
WLAN_EID_SSID
,

695 
WLAN_EID_SUPP_RATES
,

696 
WLAN_EID_REQUEST
,

697 
WLAN_EID_EXT_SUPP_RATES
,

699 
size_t
 
offs
;

700 
u8
 *
√wpos
 = 
pos
;

702 i‡(!
	`iwl_mvm_ºm_sˇn_√eded
(
mvm
)) {

703 
	`mem˝y
(
√wpos
, 
õs
, 
Àn
);

704  
√wpos
 + 
Àn
;

707 
offs
 = 
	`õì80211_õ_•lô
(
õs
, 
Àn
,

708 
bef‹e_ds_∑øms
,

709 
	`ARRAY_SIZE
(
bef‹e_ds_∑øms
),

712 
	`mem˝y
(
√wpos
, 
õs
, 
offs
);

713 
√wpos
 +
offs
;

716 *
√wpos
++ = 
WLAN_EID_DS_PARAMS
;

717 *
√wpos
++ = 1;

718 *
√wpos
++ = 0;

720 
	`mem˝y
(
√wpos
, 
õs
 + 
offs
, 
Àn
 - offs);

721 
√wpos
 +
Àn
 - 
offs
;

723  
√wpos
;

724 
	}
}

726 
	#WFA_TPC_IE_LEN
 9

	)

728 
	$iwl_mvm_add_çc_ªp‹t_õ
(
u8
 *
pos
)

730 
pos
[0] = 
WLAN_EID_VENDOR_SPECIFIC
;

731 
pos
[1] = 
WFA_TPC_IE_LEN
 - 2;

732 
pos
[2] = (
WLAN_OUI_MICROSOFT
 >> 16) & 0xff;

733 
pos
[3] = (
WLAN_OUI_MICROSOFT
 >> 8) & 0xff;

734 
pos
[4] = 
WLAN_OUI_MICROSOFT
 & 0xff;

735 
pos
[5] = 
WLAN_OUI_TYPE_MICROSOFT_TPC
;

736 
pos
[6] = 0;

738 
pos
[7] = 0;

739 
pos
[8] = 0;

740 
	}
}

743 
	$iwl_mvm_buûd_sˇn_¥obe
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

744 
õì80211_sˇn_õs
 *
õs
,

745 
iwl_mvm_sˇn_∑øms
 *
∑øms
)

747 
õì80211_mgmt
 *
‰ame
 = (*)
∑øms
->
¥eq
.
buf
;

748 
u8
 *
pos
, *
√wpos
;

749 c⁄° 
u8
 *
mac_addr
 = 
∑øms
->
Êags
 & 
NL80211_SCAN_FLAG_RANDOM_ADDR
 ?

750 
∑øms
->
mac_addr
 : 
NULL
;

758 i‡(
mac_addr
)

759 
	`gë_øndom_mask_addr
(
‰ame
->
ß
, 
mac_addr
,

760 
∑øms
->
mac_addr_mask
);

762 
	`mem˝y
(
‰ame
->
ß
, 
vif
->
addr
, 
ETH_ALEN
);

764 
‰ame
->
‰ame_c⁄åﬁ
 = 
	`˝u_to_À16
(
IEEE80211_STYPE_PROBE_REQ
);

765 
	`ëh_brﬂdˇ°_addr
(
‰ame
->
da
);

766 
	`ëhî_addr_c›y
(
‰ame
->
bssid
, 
∑øms
->bssid);

767 
‰ame
->
£q_˘æ
 = 0;

769 
pos
 = 
‰ame
->
u
.
¥obe_ªq
.
v¨übÀ
;

770 *
pos
++ = 
WLAN_EID_SSID
;

771 *
pos
++ = 0;

773 
∑øms
->
¥eq
.
mac_hódî
.
off£t
 = 0;

774 
∑øms
->
¥eq
.
mac_hódî
.
Àn
 = 
	`˝u_to_À16
(24 + 2);

777 
√wpos
 = 
	`iwl_mvm_c›y_™d_ö£π_ds_ñem
(
mvm
,

778 
õs
->õs[
NL80211_BAND_2GHZ
],

779 
õs
->
Àn
[
NL80211_BAND_2GHZ
],

780 
pos
);

781 
∑øms
->
¥eq
.
b™d_d©a
[0].
off£t
 = 
	`˝u_to_À16
(
pos
 -Ö¨ams->¥eq.
buf
);

782 
∑øms
->
¥eq
.
b™d_d©a
[0].
Àn
 = 
	`˝u_to_À16
(
√wpos
 - 
pos
);

783 
pos
 = 
√wpos
;

785 
	`mem˝y
(
pos
, 
õs
->õs[
NL80211_BAND_5GHZ
],

786 
õs
->
Àn
[
NL80211_BAND_5GHZ
]);

787 
∑øms
->
¥eq
.
b™d_d©a
[1].
off£t
 = 
	`˝u_to_À16
(
pos
 -Ö¨ams->¥eq.
buf
);

788 
∑øms
->
¥eq
.
b™d_d©a
[1].
Àn
 =

789 
	`˝u_to_À16
(
õs
->
Àn
[
NL80211_BAND_5GHZ
]);

790 
pos
 +
õs
->
Àn
[
NL80211_BAND_5GHZ
];

792 
	`mem˝y
(
pos
, 
õs
->õs[
NL80211_BAND_6GHZ
],

793 
õs
->
Àn
[
NL80211_BAND_6GHZ
]);

794 
∑øms
->
¥eq
.
b™d_d©a
[2].
off£t
 = 
	`˝u_to_À16
(
pos
 -Ö¨ams->¥eq.
buf
);

795 
∑øms
->
¥eq
.
b™d_d©a
[2].
Àn
 =

796 
	`˝u_to_À16
(
õs
->
Àn
[
NL80211_BAND_6GHZ
]);

797 
pos
 +
õs
->
Àn
[
NL80211_BAND_6GHZ
];

798 
	`mem˝y
(
pos
, 
õs
->
comm⁄_õs
, ies->
comm⁄_õ_Àn
);

799 
∑øms
->
¥eq
.
comm⁄_d©a
.
off£t
 = 
	`˝u_to_À16
(
pos
 -Ö¨ams->¥eq.
buf
);

801 i‡(
	`iwl_mvm_ºm_sˇn_√eded
(
mvm
) &&

802 !
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

803 
IWL_UCODE_TLV_CAPA_WFA_TPC_REP_IE_SUPPORT
)) {

804 
	`iwl_mvm_add_çc_ªp‹t_õ
(
pos
 + 
õs
->
comm⁄_õ_Àn
);

805 
∑øms
->
¥eq
.
comm⁄_d©a
.
Àn
 = 
	`˝u_to_À16
(
õs
->
comm⁄_õ_Àn
 +

806 
WFA_TPC_IE_LEN
);

808 
∑øms
->
¥eq
.
comm⁄_d©a
.
Àn
 = 
	`˝u_to_À16
(
õs
->
comm⁄_õ_Àn
);

810 
	}
}

812 
	$iwl_mvm_sˇn_lmac_dwñl
(
iwl_mvm
 *
mvm
,

813 
iwl_sˇn_ªq_lmac
 *
cmd
,

814 
iwl_mvm_sˇn_∑øms
 *
∑øms
)

816 
cmd
->
a˘ive_dwñl
 = 
IWL_SCAN_DWELL_ACTIVE
;

817 
cmd
->
∑ssive_dwñl
 = 
IWL_SCAN_DWELL_PASSIVE
;

818 
cmd
->
‰agmíãd_dwñl
 = 
IWL_SCAN_DWELL_FRAGMENTED
;

819 
cmd
->
exãnded_dwñl
 = 
IWL_SCAN_DWELL_EXTENDED
;

820 
cmd
->
max_out_time
 = 
	`˝u_to_À32
(
sˇn_timög
[
∑øms
->
ty≥
].max_out_time);

821 
cmd
->
su•íd_time
 = 
	`˝u_to_À32
(
sˇn_timög
[
∑øms
->
ty≥
].suspend_time);

822 
cmd
->
sˇn_¥io
 = 
	`˝u_to_À32
(
IWL_SCAN_PRIORITY_EXT_6
);

823 
	}
}

825 
ölöe
 
boﬁ
 
	$iwl_mvm_sˇn_fôs
(
iwl_mvm
 *
mvm
, 
n_ssids
,

826 
õì80211_sˇn_õs
 *
õs
,

827 
n_ch™√ls
)

829  ((
n_ssids
 <
PROBE_OPTION_MAX
) &&

830 (
n_ch™√ls
 <
mvm
->
fw
->
ucode_ˇ∑
.
n_sˇn_ch™√ls
) &

831 (
õs
->
comm⁄_õ_Àn
 +

832 
õs
->
Àn
[
NL80211_BAND_2GHZ
] +

833 
õs
->
Àn
[
NL80211_BAND_5GHZ
] <=

834 
	`iwl_mvm_max_sˇn_õ_fw_cmd_room
(
mvm
)));

835 
	}
}

837 
ölöe
 
boﬁ
 
	$iwl_mvm_sˇn_u£_ebs
(
iwl_mvm
 *
mvm
,

838 
õì80211_vif
 *
vif
)

840 c⁄° 
iwl_ucode_ˇ∑bûôõs
 *
ˇ∑
 = &
mvm
->
fw
->
ucode_ˇ∑
;

841 
boﬁ
 
low_œãncy
;

843 i‡(
	`iwl_mvm_is_cdb_suµ‹ãd
(
mvm
))

844 
low_œãncy
 = 
	`iwl_mvm_low_œãncy_b™d
(
mvm
, 
NL80211_BAND_5GHZ
);

846 
low_œãncy
 = 
	`iwl_mvm_low_œãncy
(
mvm
);

856  ((
ˇ∑
->
Êags
 & 
IWL_UCODE_TLV_FLAGS_EBS_SUPPORT
) &&

857 
mvm
->
œ°_ebs_suc˚ssful
 && 
IWL_MVM_ENABLE_EBS
 &&

858 
vif
->
ty≥
 !
NL80211_IFTYPE_P2P_DEVICE
 &&

859 (!
low_œãncy
 || 
	`iwl_mvm_is_‰ag_ebs_suµ‹ãd
(
mvm
)));

860 
	}
}

862 
ölöe
 
boﬁ
 
	$iwl_mvm_is_ªguœr_sˇn
(
iwl_mvm_sˇn_∑øms
 *
∑øms
)

864  
∑øms
->
n_sˇn_∂™s
 == 1 &&

865 
∑øms
->
sˇn_∂™s
[0].
ôî©i⁄s
 == 1;

866 
	}
}

868 
boﬁ
 
	$iwl_mvm_is_sˇn_‰agmíãd
(
iwl_mvm_sˇn_ty≥
 
ty≥
)

870  (
ty≥
 =
IWL_SCAN_TYPE_FRAGMENTED
 ||

871 
ty≥
 =
IWL_SCAN_TYPE_FAST_BALANCE
);

872 
	}
}

874 
	$iwl_mvm_sˇn_lmac_Êags
(
iwl_mvm
 *
mvm
,

875 
iwl_mvm_sˇn_∑øms
 *
∑øms
,

876 
õì80211_vif
 *
vif
)

878 
Êags
 = 0;

880 i‡(
∑øms
->
n_ssids
 == 0)

881 
Êags
 |
IWL_MVM_LMAC_SCAN_FLAG_PASSIVE
;

883 i‡(
∑øms
->
n_ssids
 =1 &&Ö¨ams->
ssids
[0].
ssid_Àn
 != 0)

884 
Êags
 |
IWL_MVM_LMAC_SCAN_FLAG_PRE_CONNECTION
;

886 i‡(
	`iwl_mvm_is_sˇn_‰agmíãd
(
∑øms
->
ty≥
))

887 
Êags
 |
IWL_MVM_LMAC_SCAN_FLAG_FRAGMENTED
;

889 i‡(
	`iwl_mvm_ºm_sˇn_√eded
(
mvm
) &&

890 
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

891 
IWL_UCODE_TLV_CAPA_WFA_TPC_REP_IE_SUPPORT
))

892 
Êags
 |
IWL_MVM_LMAC_SCAN_FLAGS_RRM_ENABLED
;

894 i‡(
∑øms
->
∑ss_Æl
)

895 
Êags
 |
IWL_MVM_LMAC_SCAN_FLAG_PASS_ALL
;

897 
Êags
 |
IWL_MVM_LMAC_SCAN_FLAG_MATCH
;

899 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


900 i‡(
mvm
->
sˇn_ôî_nŸif_íabÀd
)

901 
Êags
 |
IWL_MVM_LMAC_SCAN_FLAG_ITER_COMPLETE
;

904 i‡(
mvm
->
sched_sˇn_∑ss_Æl
 =
SCHED_SCAN_PASS_ALL_ENABLED
)

905 
Êags
 |
IWL_MVM_LMAC_SCAN_FLAG_ITER_COMPLETE
;

907 i‡(
	`iwl_mvm_is_ªguœr_sˇn
(
∑øms
) &&

908 
vif
->
ty≥
 !
NL80211_IFTYPE_P2P_DEVICE
 &&

909 !
	`iwl_mvm_is_sˇn_‰agmíãd
(
∑øms
->
ty≥
))

910 
Êags
 |
IWL_MVM_LMAC_SCAN_FLAG_EXTENDED_DWELL
;

912  
Êags
;

913 
	}
}

916 
	$iwl_mvm_sˇn_£t_Àgacy_¥obe_ªq
(
iwl_sˇn_¥obe_ªq_v1
 *
p_ªq
,

917 
iwl_sˇn_¥obe_ªq
 *
§c_p_ªq
)

919 
i
;

921 
p_ªq
->
mac_hódî
 = 
§c_p_ªq
->mac_header;

922 
i
 = 0; i < 
SCAN_NUM_BAND_PROBE_DATA_V_1
; i++)

923 
p_ªq
->
b™d_d©a
[
i
] = 
§c_p_ªq
->band_data[i];

924 
p_ªq
->
comm⁄_d©a
 = 
§c_p_ªq
->common_data;

925 
	`mem˝y
(
p_ªq
->
buf
, 
§c_p_ªq
->buf, (p_req->buf));

926 
	}
}

928 
	$iwl_mvm_sˇn_lmac
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

929 
iwl_mvm_sˇn_∑øms
 *
∑øms
)

931 
iwl_sˇn_ªq_lmac
 *
cmd
 = 
mvm
->
sˇn_cmd
;

932 
iwl_sˇn_¥obe_ªq_v1
 *
¥eq
 =

933 (*)(
cmd
->
d©a
 + (
iwl_sˇn_ch™√l_cfg_lmac
) *

934 
mvm
->
fw
->
ucode_ˇ∑
.
n_sˇn_ch™√ls
);

935 
u32
 
ssid_bôm≠
 = 0;

936 
i
;

937 
u8
 
b™d
;

939 i‡(
	`WARN_ON
(
∑øms
->
n_sˇn_∂™s
 > 
IWL_MAX_SCHED_SCAN_PLANS
))

940  -
EINVAL
;

942 
	`iwl_mvm_sˇn_lmac_dwñl
(
mvm
, 
cmd
, 
∑øms
);

944 
cmd
->
rx_chaö_£À˘
 = 
	`iwl_mvm_sˇn_rx_chaö
(
mvm
);

945 
cmd
->
ôî_num
 = 
	`˝u_to_À32
(1);

946 
cmd
->
n_ch™√ls
 = (
u8
)
∑øms
->n_channels;

948 
cmd
->
dñay
 = 
	`˝u_to_À32
(
∑øms
->delay);

950 
cmd
->
sˇn_Êags
 = 
	`˝u_to_À32
(
	`iwl_mvm_sˇn_lmac_Êags
(
mvm
, 
∑øms
,

951 
vif
));

953 
b™d
 = 
	`iwl_mvm_phy_b™d_‰om_∆80211
(
∑øms
->
ch™√ls
[0]->band);

954 
cmd
->
Êags
 = 
	`˝u_to_À32
(
b™d
);

955 
cmd
->
fûãr_Êags
 = 
	`˝u_to_À32
(
MAC_FILTER_ACCEPT_GRP
 |

956 
MAC_FILTER_IN_BEACON
);

957 
	`iwl_mvm_sˇn_fûl_tx_cmd
(
mvm
, 
cmd
->
tx_cmd
, 
∑øms
->
no_cck
);

958 
	`iwl_sˇn_buûd_ssids
(
∑øms
, 
cmd
->
dúe˘_sˇn
, &
ssid_bôm≠
);

961 
ssid_bôm≠
 <<= 1;

963 
i
 = 0; i < 
∑øms
->
n_sˇn_∂™s
; i++) {

964 
cfg80211_sched_sˇn_∂™
 *
sˇn_∂™
 =

965 &
∑øms
->
sˇn_∂™s
[
i
];

967 
cmd
->
scheduÀ
[
i
].
dñay
 =

968 
	`˝u_to_À16
(
sˇn_∂™
->
öãrvÆ
);

969 
cmd
->
scheduÀ
[
i
].
ôî©i⁄s
 = 
sˇn_∂™
->iterations;

970 
cmd
->
scheduÀ
[
i
].
fuŒ_sˇn_mul
 = 1;

979 i‡(!
cmd
->
scheduÀ
[
i
 - 1].
ôî©i⁄s
)

980 
cmd
->
scheduÀ
[
i
 - 1].
ôî©i⁄s
 = 0xff;

982 i‡(
	`iwl_mvm_sˇn_u£_ebs
(
mvm
, 
vif
)) {

983 
cmd
->
ch™√l_›t
[0].
Êags
 =

984 
	`˝u_to_À16
(
IWL_SCAN_CHANNEL_FLAG_EBS
 |

985 
IWL_SCAN_CHANNEL_FLAG_EBS_ACCURATE
 |

986 
IWL_SCAN_CHANNEL_FLAG_CACHE_ADD
);

987 
cmd
->
ch™√l_›t
[0].
n⁄_ebs_øtio
 =

988 
	`˝u_to_À16
(
IWL_DENSE_EBS_SCAN_RATIO
);

989 
cmd
->
ch™√l_›t
[1].
Êags
 =

990 
	`˝u_to_À16
(
IWL_SCAN_CHANNEL_FLAG_EBS
 |

991 
IWL_SCAN_CHANNEL_FLAG_EBS_ACCURATE
 |

992 
IWL_SCAN_CHANNEL_FLAG_CACHE_ADD
);

993 
cmd
->
ch™√l_›t
[1].
n⁄_ebs_øtio
 =

994 
	`˝u_to_À16
(
IWL_SPARSE_EBS_SCAN_RATIO
);

997 
	`iwl_mvm_lmac_sˇn_cfg_ch™√ls
(
mvm
, 
∑øms
->
ch™√ls
,

998 
∑øms
->
n_ch™√ls
, 
ssid_bôm≠
, 
cmd
);

1000 
	`iwl_mvm_sˇn_£t_Àgacy_¥obe_ªq
(
¥eq
, &
∑øms
->preq);

1003 
	}
}

1005 
	$øã_to_sˇn_øã_Êag
(
øã
)

1007 c⁄° 
øã_to_sˇn_øã
[
IWL_RATE_COUNT
] = {

1008 [
IWL_RATE_1M_INDEX
] = 
SCAN_CONFIG_RATE_1M
,

1009 [
IWL_RATE_2M_INDEX
] = 
SCAN_CONFIG_RATE_2M
,

1010 [
IWL_RATE_5M_INDEX
] = 
SCAN_CONFIG_RATE_5M
,

1011 [
IWL_RATE_11M_INDEX
] = 
SCAN_CONFIG_RATE_11M
,

1012 [
IWL_RATE_6M_INDEX
] = 
SCAN_CONFIG_RATE_6M
,

1013 [
IWL_RATE_9M_INDEX
] = 
SCAN_CONFIG_RATE_9M
,

1014 [
IWL_RATE_12M_INDEX
] = 
SCAN_CONFIG_RATE_12M
,

1015 [
IWL_RATE_18M_INDEX
] = 
SCAN_CONFIG_RATE_18M
,

1016 [
IWL_RATE_24M_INDEX
] = 
SCAN_CONFIG_RATE_24M
,

1017 [
IWL_RATE_36M_INDEX
] = 
SCAN_CONFIG_RATE_36M
,

1018 [
IWL_RATE_48M_INDEX
] = 
SCAN_CONFIG_RATE_48M
,

1019 [
IWL_RATE_54M_INDEX
] = 
SCAN_CONFIG_RATE_54M
,

1022  
øã_to_sˇn_øã
[
øã
];

1023 
	}
}

1025 
__À32
 
	$iwl_mvm_sˇn_c⁄fig_øãs
(
iwl_mvm
 *
mvm
)

1027 
õì80211_suµ‹ãd_b™d
 *
b™d
;

1028 
øãs
 = 0;

1029 
i
;

1031 
b™d
 = &
mvm
->
nvm_d©a
->
b™ds
[
NL80211_BAND_2GHZ
];

1032 
i
 = 0; i < 
b™d
->
n_bôøãs
; i++)

1033 
øãs
 |
	`øã_to_sˇn_øã_Êag
(
b™d
->
bôøãs
[
i
].
hw_vÆue
);

1034 
b™d
 = &
mvm
->
nvm_d©a
->
b™ds
[
NL80211_BAND_5GHZ
];

1035 
i
 = 0; i < 
b™d
->
n_bôøãs
; i++)

1036 
øãs
 |
	`øã_to_sˇn_øã_Êag
(
b™d
->
bôøãs
[
i
].
hw_vÆue
);

1039 
øãs
 |
	`SCAN_CONFIG_SUPPORTED_RATE
(rates);

1041  
	`˝u_to_À32
(
øãs
);

1042 
	}
}

1044 
	$iwl_mvm_fûl_sˇn_dwñl
(
iwl_mvm
 *
mvm
,

1045 
iwl_sˇn_dwñl
 *
dwñl
)

1047 
dwñl
->
a˘ive
 = 
IWL_SCAN_DWELL_ACTIVE
;

1048 
dwñl
->
∑ssive
 = 
IWL_SCAN_DWELL_PASSIVE
;

1049 
dwñl
->
‰agmíãd
 = 
IWL_SCAN_DWELL_FRAGMENTED
;

1050 
dwñl
->
exãnded
 = 
IWL_SCAN_DWELL_EXTENDED
;

1051 
	}
}

1053 
	$iwl_mvm_fûl_ch™√ls
(
iwl_mvm
 *
mvm
, 
u8
 *
ch™√ls
,

1054 
u32
 
max_ch™√ls
)

1056 
õì80211_suµ‹ãd_b™d
 *
b™d
;

1057 
i
, 
j
 = 0;

1059 
b™d
 = &
mvm
->
nvm_d©a
->
b™ds
[
NL80211_BAND_2GHZ
];

1060 
i
 = 0; i < 
b™d
->
n_ch™√ls
 && 
j
 < 
max_ch™√ls
; i++, j++)

1061 
ch™√ls
[
j
] = 
b™d
->ch™√ls[
i
].
hw_vÆue
;

1062 
b™d
 = &
mvm
->
nvm_d©a
->
b™ds
[
NL80211_BAND_5GHZ
];

1063 
i
 = 0; i < 
b™d
->
n_ch™√ls
 && 
j
 < 
max_ch™√ls
; i++, j++)

1064 
ch™√ls
[
j
] = 
b™d
->ch™√ls[
i
].
hw_vÆue
;

1065 
	}
}

1067 
	$iwl_mvm_fûl_sˇn_c⁄fig_v1
(
iwl_mvm
 *
mvm
, *
c⁄fig
,

1068 
u32
 
Êags
, 
u8
 
ch™√l_Êags
,

1069 
u32
 
max_ch™√ls
)

1071 
iwl_mvm_sˇn_ty≥
 
ty≥
 = 
	`iwl_mvm_gë_sˇn_ty≥
(
mvm
, 
NULL
);

1072 
iwl_sˇn_c⁄fig_v1
 *
cfg
 = 
c⁄fig
;

1074 
cfg
->
Êags
 = 
	`˝u_to_À32
(flags);

1075 
cfg
->
tx_chaös
 = 
	`˝u_to_À32
(
	`iwl_mvm_gë_vÆid_tx_™t
(
mvm
));

1076 
cfg
->
rx_chaös
 = 
	`˝u_to_À32
(
	`iwl_mvm_sˇn_rx_™t
(
mvm
));

1077 
cfg
->
Àgacy_øãs
 = 
	`iwl_mvm_sˇn_c⁄fig_øãs
(
mvm
);

1078 
cfg
->
out_of_ch™√l_time
 = 
	`˝u_to_À32
(
sˇn_timög
[
ty≥
].
max_out_time
);

1079 
cfg
->
su•íd_time
 = 
	`˝u_to_À32
(
sˇn_timög
[
ty≥
].suspend_time);

1081 
	`iwl_mvm_fûl_sˇn_dwñl
(
mvm
, &
cfg
->
dwñl
);

1083 
	`mem˝y
(&
cfg
->
mac_addr
, &
mvm
->
addªs£s
[0].
addr
, 
ETH_ALEN
);

1086 
	`WARN_ON_ONCE
(
	`iwl_mvm_has_√w_°©i⁄_≠i
(
mvm
->
fw
));

1088 
cfg
->
bˇ°_°a_id
 = 
mvm
->
aux_°a
.
°a_id
;

1089 
cfg
->
ch™√l_Êags
 = channel_flags;

1091 
	`iwl_mvm_fûl_ch™√ls
(
mvm
, 
cfg
->
ch™√l_¨øy
, 
max_ch™√ls
);

1092 
	}
}

1094 
	$iwl_mvm_fûl_sˇn_c⁄fig_v2
(
iwl_mvm
 *
mvm
, *
c⁄fig
,

1095 
u32
 
Êags
, 
u8
 
ch™√l_Êags
,

1096 
u32
 
max_ch™√ls
)

1098 
iwl_sˇn_c⁄fig_v2
 *
cfg
 = 
c⁄fig
;

1100 
cfg
->
Êags
 = 
	`˝u_to_À32
(flags);

1101 
cfg
->
tx_chaös
 = 
	`˝u_to_À32
(
	`iwl_mvm_gë_vÆid_tx_™t
(
mvm
));

1102 
cfg
->
rx_chaös
 = 
	`˝u_to_À32
(
	`iwl_mvm_sˇn_rx_™t
(
mvm
));

1103 
cfg
->
Àgacy_øãs
 = 
	`iwl_mvm_sˇn_c⁄fig_øãs
(
mvm
);

1105 i‡(
	`iwl_mvm_is_cdb_suµ‹ãd
(
mvm
)) {

1106 
iwl_mvm_sˇn_ty≥
 
lb_ty≥
, 
hb_ty≥
;

1108 
lb_ty≥
 = 
	`iwl_mvm_gë_sˇn_ty≥_b™d
(
mvm
, 
NULL
,

1109 
NL80211_BAND_2GHZ
);

1110 
hb_ty≥
 = 
	`iwl_mvm_gë_sˇn_ty≥_b™d
(
mvm
, 
NULL
,

1111 
NL80211_BAND_5GHZ
);

1113 
cfg
->
out_of_ch™√l_time
[
SCAN_LB_LMAC_IDX
] =

1114 
	`˝u_to_À32
(
sˇn_timög
[
lb_ty≥
].
max_out_time
);

1115 
cfg
->
su•íd_time
[
SCAN_LB_LMAC_IDX
] =

1116 
	`˝u_to_À32
(
sˇn_timög
[
lb_ty≥
].
su•íd_time
);

1118 
cfg
->
out_of_ch™√l_time
[
SCAN_HB_LMAC_IDX
] =

1119 
	`˝u_to_À32
(
sˇn_timög
[
hb_ty≥
].
max_out_time
);

1120 
cfg
->
su•íd_time
[
SCAN_HB_LMAC_IDX
] =

1121 
	`˝u_to_À32
(
sˇn_timög
[
hb_ty≥
].
su•íd_time
);

1123 
iwl_mvm_sˇn_ty≥
 
ty≥
 =

1124 
	`iwl_mvm_gë_sˇn_ty≥
(
mvm
, 
NULL
);

1126 
cfg
->
out_of_ch™√l_time
[
SCAN_LB_LMAC_IDX
] =

1127 
	`˝u_to_À32
(
sˇn_timög
[
ty≥
].
max_out_time
);

1128 
cfg
->
su•íd_time
[
SCAN_LB_LMAC_IDX
] =

1129 
	`˝u_to_À32
(
sˇn_timög
[
ty≥
].
su•íd_time
);

1132 
	`iwl_mvm_fûl_sˇn_dwñl
(
mvm
, &
cfg
->
dwñl
);

1134 
	`mem˝y
(&
cfg
->
mac_addr
, &
mvm
->
addªs£s
[0].
addr
, 
ETH_ALEN
);

1137 
	`WARN_ON_ONCE
(
	`iwl_mvm_has_√w_°©i⁄_≠i
(
mvm
->
fw
));

1139 
cfg
->
bˇ°_°a_id
 = 
mvm
->
aux_°a
.
°a_id
;

1140 
cfg
->
ch™√l_Êags
 = channel_flags;

1142 
	`iwl_mvm_fûl_ch™√ls
(
mvm
, 
cfg
->
ch™√l_¨øy
, 
max_ch™√ls
);

1143 
	}
}

1145 
	$iwl_mvm_Àgacy_c⁄fig_sˇn
(
iwl_mvm
 *
mvm
)

1147 *
cfg
;

1148 
ªt
, 
cmd_size
;

1149 
iwl_ho°_cmd
 
cmd
 = {

1150 .
id
 = 
	`WIDE_ID
(
IWL_ALWAYS_LONG_GROUP
, 
SCAN_CFG_CMD
),

1152 
iwl_mvm_sˇn_ty≥
 
ty≥
;

1153 
iwl_mvm_sˇn_ty≥
 
hb_ty≥
 = 
IWL_SCAN_TYPE_NOT_SET
;

1154 
num_ch™√ls
 =

1155 
mvm
->
nvm_d©a
->
b™ds
[
NL80211_BAND_2GHZ
].
n_ch™√ls
 +

1156 
mvm
->
nvm_d©a
->
b™ds
[
NL80211_BAND_5GHZ
].
n_ch™√ls
;

1157 
u32
 
Êags
;

1158 
u8
 
ch™√l_Êags
;

1160 i‡(
	`WARN_ON
(
num_ch™√ls
 > 
mvm
->
fw
->
ucode_ˇ∑
.
n_sˇn_ch™√ls
))

1161 
num_ch™√ls
 = 
mvm
->
fw
->
ucode_ˇ∑
.
n_sˇn_ch™√ls
;

1163 i‡(
	`iwl_mvm_is_cdb_suµ‹ãd
(
mvm
)) {

1164 
ty≥
 = 
	`iwl_mvm_gë_sˇn_ty≥_b™d
(
mvm
, 
NULL
,

1165 
NL80211_BAND_2GHZ
);

1166 
hb_ty≥
 = 
	`iwl_mvm_gë_sˇn_ty≥_b™d
(
mvm
, 
NULL
,

1167 
NL80211_BAND_5GHZ
);

1168 i‡(
ty≥
 =
mvm
->
sˇn_ty≥
 && 
hb_ty≥
 =mvm->
hb_sˇn_ty≥
)

1171 
ty≥
 = 
	`iwl_mvm_gë_sˇn_ty≥
(
mvm
, 
NULL
);

1172 i‡(
ty≥
 =
mvm
->
sˇn_ty≥
)

1176 i‡(
	`iwl_mvm_cdb_sˇn_≠i
(
mvm
))

1177 
cmd_size
 = (
iwl_sˇn_c⁄fig_v2
);

1179 
cmd_size
 = (
iwl_sˇn_c⁄fig_v1
);

1180 
cmd_size
 +
mvm
->
fw
->
ucode_ˇ∑
.
n_sˇn_ch™√ls
;

1182 
cfg
 = 
	`kzÆloc
(
cmd_size
, 
GFP_KERNEL
);

1183 i‡(!
cfg
)

1184  -
ENOMEM
;

1186 
Êags
 = 
SCAN_CONFIG_FLAG_ACTIVATE
 |

1187 
SCAN_CONFIG_FLAG_ALLOW_CHUB_REQS
 |

1188 
SCAN_CONFIG_FLAG_SET_TX_CHAINS
 |

1189 
SCAN_CONFIG_FLAG_SET_RX_CHAINS
 |

1190 
SCAN_CONFIG_FLAG_SET_AUX_STA_ID
 |

1191 
SCAN_CONFIG_FLAG_SET_ALL_TIMES
 |

1192 
SCAN_CONFIG_FLAG_SET_LEGACY_RATES
 |

1193 
SCAN_CONFIG_FLAG_SET_MAC_ADDR
 |

1194 
SCAN_CONFIG_FLAG_SET_CHANNEL_FLAGS
 |

1195 
	`SCAN_CONFIG_N_CHANNELS
(
num_ch™√ls
) |

1196 (
	`iwl_mvm_is_sˇn_‰agmíãd
(
ty≥
) ?

1197 
SCAN_CONFIG_FLAG_SET_FRAGMENTED
 :

1198 
SCAN_CONFIG_FLAG_CLEAR_FRAGMENTED
);

1200 
ch™√l_Êags
 = 
IWL_CHANNEL_FLAG_EBS
 |

1201 
IWL_CHANNEL_FLAG_ACCURATE_EBS
 |

1202 
IWL_CHANNEL_FLAG_EBS_ADD
 |

1203 
IWL_CHANNEL_FLAG_PRE_SCAN_PASSIVE2ACTIVE
;

1209 i‡(
	`iwl_mvm_cdb_sˇn_≠i
(
mvm
)) {

1210 i‡(
	`iwl_mvm_is_cdb_suµ‹ãd
(
mvm
))

1211 
Êags
 |(
	`iwl_mvm_is_sˇn_‰agmíãd
(
hb_ty≥
)) ?

1212 
SCAN_CONFIG_FLAG_SET_LMAC2_FRAGMENTED
 :

1213 
SCAN_CONFIG_FLAG_CLEAR_LMAC2_FRAGMENTED
;

1214 
	`iwl_mvm_fûl_sˇn_c⁄fig_v2
(
mvm
, 
cfg
, 
Êags
, 
ch™√l_Êags
,

1215 
num_ch™√ls
);

1217 
	`iwl_mvm_fûl_sˇn_c⁄fig_v1
(
mvm
, 
cfg
, 
Êags
, 
ch™√l_Êags
,

1218 
num_ch™√ls
);

1221 
cmd
.
d©a
[0] = 
cfg
;

1222 
cmd
.
Àn
[0] = 
cmd_size
;

1223 
cmd
.
d©aÊags
[0] = 
IWL_HCMD_DFL_NOCOPY
;

1225 
	`IWL_DEBUG_SCAN
(
mvm
, "Sending UMAC scan config\n");

1227 
ªt
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
cmd
);

1228 i‡(!
ªt
) {

1229 
mvm
->
sˇn_ty≥
 = 
ty≥
;

1230 
mvm
->
hb_sˇn_ty≥
 = 
hb_ty≥
;

1233 
	`k‰ì
(
cfg
);

1234  
ªt
;

1235 
	}
}

1237 
	$iwl_mvm_c⁄fig_sˇn
(
iwl_mvm
 *
mvm
)

1239 
iwl_sˇn_c⁄fig
 
cfg
;

1240 
iwl_ho°_cmd
 
cmd
 = {

1241 .
id
 = 
	`WIDE_ID
(
IWL_ALWAYS_LONG_GROUP
, 
SCAN_CFG_CMD
),

1242 .
Àn
[0] = (
cfg
),

1243 .
d©a
[0] = &
cfg
,

1244 .
d©aÊags
[0] = 
IWL_HCMD_DFL_NOCOPY
,

1247 i‡(!
	`iwl_mvm_is_ªdu˚d_c⁄fig_sˇn_suµ‹ãd
(
mvm
))

1248  
	`iwl_mvm_Àgacy_c⁄fig_sˇn
(
mvm
);

1250 
	`mem£t
(&
cfg
, 0, (cfg));

1252 i‡(!
	`iwl_mvm_has_√w_°©i⁄_≠i
(
mvm
->
fw
)) {

1253 
cfg
.
bˇ°_°a_id
 = 
mvm
->
aux_°a
.
°a_id
;

1254 } i‡(
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
SCAN_CFG_CMD
, 0) < 5) {

1259 
cfg
.
bˇ°_°a_id
 = 0xff;

1262 
cfg
.
tx_chaös
 = 
	`˝u_to_À32
(
	`iwl_mvm_gë_vÆid_tx_™t
(
mvm
));

1263 
cfg
.
rx_chaös
 = 
	`˝u_to_À32
(
	`iwl_mvm_sˇn_rx_™t
(
mvm
));

1265 
	`IWL_DEBUG_SCAN
(
mvm
, "Sending UMAC scan config\n");

1267  
	`iwl_mvm_£nd_cmd
(
mvm
, &
cmd
);

1268 
	}
}

1270 
	$iwl_mvm_sˇn_uid_by_°©us
(
iwl_mvm
 *
mvm
, 
°©us
)

1272 
i
;

1274 
i
 = 0; i < 
mvm
->
max_sˇns
; i++)

1275 i‡(
mvm
->
sˇn_uid_°©us
[
i
] =
°©us
)

1276  
i
;

1278  -
ENOENT
;

1279 
	}
}

1281 
	$iwl_mvm_sˇn_umac_dwñl
(
iwl_mvm
 *
mvm
,

1282 
iwl_sˇn_ªq_umac
 *
cmd
,

1283 
iwl_mvm_sˇn_∑øms
 *
∑øms
)

1285 
iwl_mvm_sˇn_timög_∑øms
 *
timög
, *
hb_timög
;

1286 
u8
 
a˘ive_dwñl
, 
∑ssive_dwñl
;

1288 
timög
 = &
sˇn_timög
[
∑øms
->
ty≥
];

1289 
a˘ive_dwñl
 = 
IWL_SCAN_DWELL_ACTIVE
;

1290 
∑ssive_dwñl
 = 
IWL_SCAN_DWELL_PASSIVE
;

1292 i‡(
	`iwl_mvm_is_ad≠tive_dwñl_suµ‹ãd
(
mvm
)) {

1293 
cmd
->
v7
.
adwñl_deÁu…_n_≠s_socül
 =

1294 
IWL_SCAN_ADWELL_DEFAULT_N_APS_SOCIAL
;

1295 
cmd
->
v7
.
adwñl_deÁu…_n_≠s
 =

1296 
IWL_SCAN_ADWELL_DEFAULT_LB_N_APS
;

1298 i‡(
	`iwl_mvm_is_adwñl_hb_≠_num_suµ‹ãd
(
mvm
))

1299 
cmd
->
v9
.
adwñl_deÁu…_hb_n_≠s
 =

1300 
IWL_SCAN_ADWELL_DEFAULT_HB_N_APS
;

1303 i‡(
IWL_MVM_ADWELL_MAX_BUDGET
)

1304 
cmd
->
v7
.
adwñl_max_budgë
 =

1305 
	`˝u_to_À16
(
IWL_MVM_ADWELL_MAX_BUDGET
);

1306 i‡(
∑øms
->
ssids
 &&Ö¨ams->ssids[0].
ssid_Àn
)

1307 
cmd
->
v7
.
adwñl_max_budgë
 =

1308 
	`˝u_to_À16
(
IWL_SCAN_ADWELL_MAX_BUDGET_DIRECTED_SCAN
);

1310 
cmd
->
v7
.
adwñl_max_budgë
 =

1311 
	`˝u_to_À16
(
IWL_SCAN_ADWELL_MAX_BUDGET_FULL_SCAN
);

1313 
cmd
->
v7
.
sˇn_¥i‹ôy
 = 
	`˝u_to_À32
(
IWL_SCAN_PRIORITY_EXT_6
);

1314 
cmd
->
v7
.
max_out_time
[
SCAN_LB_LMAC_IDX
] =

1315 
	`˝u_to_À32
(
timög
->
max_out_time
);

1316 
cmd
->
v7
.
su•íd_time
[
SCAN_LB_LMAC_IDX
] =

1317 
	`˝u_to_À32
(
timög
->
su•íd_time
);

1319 i‡(
	`iwl_mvm_is_cdb_suµ‹ãd
(
mvm
)) {

1320 
hb_timög
 = &
sˇn_timög
[
∑øms
->
hb_ty≥
];

1322 
cmd
->
v7
.
max_out_time
[
SCAN_HB_LMAC_IDX
] =

1323 
	`˝u_to_À32
(
hb_timög
->
max_out_time
);

1324 
cmd
->
v7
.
su•íd_time
[
SCAN_HB_LMAC_IDX
] =

1325 
	`˝u_to_À32
(
hb_timög
->
su•íd_time
);

1328 i‡(!
	`iwl_mvm_is_ad≠tive_dwñl_v2_suµ‹ãd
(
mvm
)) {

1329 
cmd
->
v7
.
a˘ive_dwñl
 =áctive_dwell;

1330 
cmd
->
v7
.
∑ssive_dwñl
 =Öassive_dwell;

1331 
cmd
->
v7
.
‰agmíãd_dwñl
 = 
IWL_SCAN_DWELL_FRAGMENTED
;

1333 
cmd
->
v8
.
a˘ive_dwñl
[
SCAN_LB_LMAC_IDX
] =áctive_dwell;

1334 
cmd
->
v8
.
∑ssive_dwñl
[
SCAN_LB_LMAC_IDX
] =Öassive_dwell;

1335 i‡(
	`iwl_mvm_is_cdb_suµ‹ãd
(
mvm
)) {

1336 
cmd
->
v8
.
a˘ive_dwñl
[
SCAN_HB_LMAC_IDX
] =

1337 
a˘ive_dwñl
;

1338 
cmd
->
v8
.
∑ssive_dwñl
[
SCAN_HB_LMAC_IDX
] =

1339 
∑ssive_dwñl
;

1343 
cmd
->
v1
.
exãnded_dwñl
 = 
IWL_SCAN_DWELL_EXTENDED
;

1344 
cmd
->
v1
.
a˘ive_dwñl
 =áctive_dwell;

1345 
cmd
->
v1
.
∑ssive_dwñl
 =Öassive_dwell;

1346 
cmd
->
v1
.
‰agmíãd_dwñl
 = 
IWL_SCAN_DWELL_FRAGMENTED
;

1348 i‡(
	`iwl_mvm_is_cdb_suµ‹ãd
(
mvm
)) {

1349 
hb_timög
 = &
sˇn_timög
[
∑øms
->
hb_ty≥
];

1351 
cmd
->
v6
.
max_out_time
[
SCAN_HB_LMAC_IDX
] =

1352 
	`˝u_to_À32
(
hb_timög
->
max_out_time
);

1353 
cmd
->
v6
.
su•íd_time
[
SCAN_HB_LMAC_IDX
] =

1354 
	`˝u_to_À32
(
hb_timög
->
su•íd_time
);

1357 i‡(
	`iwl_mvm_cdb_sˇn_≠i
(
mvm
)) {

1358 
cmd
->
v6
.
sˇn_¥i‹ôy
 =

1359 
	`˝u_to_À32
(
IWL_SCAN_PRIORITY_EXT_6
);

1360 
cmd
->
v6
.
max_out_time
[
SCAN_LB_LMAC_IDX
] =

1361 
	`˝u_to_À32
(
timög
->
max_out_time
);

1362 
cmd
->
v6
.
su•íd_time
[
SCAN_LB_LMAC_IDX
] =

1363 
	`˝u_to_À32
(
timög
->
su•íd_time
);

1365 
cmd
->
v1
.
sˇn_¥i‹ôy
 =

1366 
	`˝u_to_À32
(
IWL_SCAN_PRIORITY_EXT_6
);

1367 
cmd
->
v1
.
max_out_time
 =

1368 
	`˝u_to_À32
(
timög
->
max_out_time
);

1369 
cmd
->
v1
.
su•íd_time
 =

1370 
	`˝u_to_À32
(
timög
->
su•íd_time
);

1374 i‡(
	`iwl_mvm_is_ªguœr_sˇn
(
∑øms
))

1375 
cmd
->
ooc_¥i‹ôy
 = 
	`˝u_to_À32
(
IWL_SCAN_PRIORITY_EXT_6
);

1377 
cmd
->
ooc_¥i‹ôy
 = 
	`˝u_to_À32
(
IWL_SCAN_PRIORITY_EXT_2
);

1378 
	}
}

1380 
u32
 
	$iwl_mvm_sˇn_umac_ooc_¥i‹ôy
(
iwl_mvm_sˇn_∑øms
 *
∑øms
)

1382  
	`iwl_mvm_is_ªguœr_sˇn
(
∑øms
) ?

1383 
IWL_SCAN_PRIORITY_EXT_6
 :

1384 
IWL_SCAN_PRIORITY_EXT_2
;

1385 
	}
}

1388 
	$iwl_mvm_sˇn_umac_dwñl_v11
(
iwl_mvm
 *
mvm
,

1389 
iwl_sˇn_gíîÆ_∑øms_v11
 *
gíîÆ_∑øms
,

1390 
iwl_mvm_sˇn_∑øms
 *
∑øms
)

1392 
iwl_mvm_sˇn_timög_∑øms
 *
timög
, *
hb_timög
;

1393 
u8
 
a˘ive_dwñl
, 
∑ssive_dwñl
;

1395 
timög
 = &
sˇn_timög
[
∑øms
->
ty≥
];

1396 
a˘ive_dwñl
 = 
IWL_SCAN_DWELL_ACTIVE
;

1397 
∑ssive_dwñl
 = 
IWL_SCAN_DWELL_PASSIVE
;

1399 
gíîÆ_∑øms
->
adwñl_deÁu…_socül_chn
 =

1400 
IWL_SCAN_ADWELL_DEFAULT_N_APS_SOCIAL
;

1401 
gíîÆ_∑øms
->
adwñl_deÁu…_2g
 = 
IWL_SCAN_ADWELL_DEFAULT_LB_N_APS
;

1402 
gíîÆ_∑øms
->
adwñl_deÁu…_5g
 = 
IWL_SCAN_ADWELL_DEFAULT_HB_N_APS
;

1405 i‡(
IWL_MVM_ADWELL_MAX_BUDGET
)

1406 
gíîÆ_∑øms
->
adwñl_max_budgë
 =

1407 
	`˝u_to_À16
(
IWL_MVM_ADWELL_MAX_BUDGET
);

1408 i‡(
∑øms
->
ssids
 &&Ö¨ams->ssids[0].
ssid_Àn
)

1409 
gíîÆ_∑øms
->
adwñl_max_budgë
 =

1410 
	`˝u_to_À16
(
IWL_SCAN_ADWELL_MAX_BUDGET_DIRECTED_SCAN
);

1412 
gíîÆ_∑øms
->
adwñl_max_budgë
 =

1413 
	`˝u_to_À16
(
IWL_SCAN_ADWELL_MAX_BUDGET_FULL_SCAN
);

1415 
gíîÆ_∑øms
->
sˇn_¥i‹ôy
 = 
	`˝u_to_À32
(
IWL_SCAN_PRIORITY_EXT_6
);

1416 
gíîÆ_∑øms
->
max_out_of_time
[
SCAN_LB_LMAC_IDX
] =

1417 
	`˝u_to_À32
(
timög
->
max_out_time
);

1418 
gíîÆ_∑øms
->
su•íd_time
[
SCAN_LB_LMAC_IDX
] =

1419 
	`˝u_to_À32
(
timög
->
su•íd_time
);

1421 
hb_timög
 = &
sˇn_timög
[
∑øms
->
hb_ty≥
];

1423 
gíîÆ_∑øms
->
max_out_of_time
[
SCAN_HB_LMAC_IDX
] =

1424 
	`˝u_to_À32
(
hb_timög
->
max_out_time
);

1425 
gíîÆ_∑øms
->
su•íd_time
[
SCAN_HB_LMAC_IDX
] =

1426 
	`˝u_to_À32
(
hb_timög
->
su•íd_time
);

1428 
gíîÆ_∑øms
->
a˘ive_dwñl
[
SCAN_LB_LMAC_IDX
] =áctive_dwell;

1429 
gíîÆ_∑øms
->
∑ssive_dwñl
[
SCAN_LB_LMAC_IDX
] =Öassive_dwell;

1430 
gíîÆ_∑øms
->
a˘ive_dwñl
[
SCAN_HB_LMAC_IDX
] =áctive_dwell;

1431 
gíîÆ_∑øms
->
∑ssive_dwñl
[
SCAN_HB_LMAC_IDX
] =Öassive_dwell;

1432 
	}
}

1434 
	siwl_mvm_sˇn_ch™√l_£gmít
 {

1435 
u8
 
	m°¨t_idx
;

1436 
u8
 
	míd_idx
;

1437 
u8
 
	mfú°_ch™√l_id
;

1438 
u8
 
	mœ°_ch™√l_id
;

1439 
u8
 
	mch™√l_•acög_shi·
;

1440 
u8
 
	mb™d
;

1443 c⁄° 
iwl_mvm_sˇn_ch™√l_£gmít
 
	gsˇn_ch™√l_£gmíts
[] = {

1445 .
°¨t_idx
 = 0,

1446 .
	gíd_idx
 = 13,

1447 .
	gfú°_ch™√l_id
 = 1,

1448 .
	gœ°_ch™√l_id
 = 14,

1449 .
	gch™√l_•acög_shi·
 = 0,

1450 .
	gb™d
 = 
PHY_BAND_24


1453 .
	g°¨t_idx
 = 14,

1454 .
	gíd_idx
 = 41,

1455 .
	gfú°_ch™√l_id
 = 36,

1456 .
	gœ°_ch™√l_id
 = 144,

1457 .
	gch™√l_•acög_shi·
 = 2,

1458 .
	gb™d
 = 
PHY_BAND_5


1461 .
	g°¨t_idx
 = 42,

1462 .
	gíd_idx
 = 50,

1463 .
	gfú°_ch™√l_id
 = 149,

1464 .
	gœ°_ch™√l_id
 = 181,

1465 .
	gch™√l_•acög_shi·
 = 2,

1466 .
	gb™d
 = 
PHY_BAND_5


1469 .
	g°¨t_idx
 = 51,

1470 .
	gíd_idx
 = 111,

1471 .
	gfú°_ch™√l_id
 = 1,

1472 .
	gœ°_ch™√l_id
 = 241,

1473 .
	gch™√l_•acög_shi·
 = 2,

1474 .
	gb™d
 = 
PHY_BAND_6


1478 
	$iwl_mvm_sˇn_ch_™d_b™d_to_idx
(
u8
 
ch™√l_id
, u8 
b™d
)

1480 
i
, 
ödex
;

1482 i‡(!
ch™√l_id
)

1483  -
EINVAL
;

1485 
i
 = 0; i < 
	`ARRAY_SIZE
(
sˇn_ch™√l_£gmíts
); i++) {

1486 c⁄° 
iwl_mvm_sˇn_ch™√l_£gmít
 *
ch_£gmít
 =

1487 &
sˇn_ch™√l_£gmíts
[
i
];

1488 
u32
 
ch_off£t
;

1490 i‡(
ch_£gmít
->
b™d
 != band ||

1491 
ch_£gmít
->
fú°_ch™√l_id
 > 
ch™√l_id
 ||

1492 
ch_£gmít
->
œ°_ch™√l_id
 < 
ch™√l_id
)

1495 
ch_off£t
 = (
ch™√l_id
 - 
ch_£gmít
->
fú°_ch™√l_id
) >>

1496 
ch_£gmít
->
ch™√l_•acög_shi·
;

1498 
ödex
 = 
sˇn_ch™√l_£gmíts
[
i
].
°¨t_idx
 + 
ch_off£t
;

1499 i‡(
ödex
 < 
IWL_SCAN_NUM_CHANNELS
)

1500  
ödex
;

1505  -
EINVAL
;

1506 
	}
}

1508 c⁄° 
u8
 
	gp2p_go_‰õndly_chs
[] = {

1512 c⁄° 
u8
 
	gsocül_chs
[] = {

1516 
	$iwl_mvm_sˇn_ch_add_n_≠s_ovîride
(
∆80211_i·y≥
 
vif_ty≥
,

1517 
u8
 
ch_id
, u8 
b™d
, u8 *
ch_bôm≠
,

1518 
size_t
 
bôm≠_n_íåõs
)

1520 
i
;

1522 i‡(
vif_ty≥
 !
NL80211_IFTYPE_P2P_DEVICE
)

1525 
i
 = 0; i < 
	`ARRAY_SIZE
(
p2p_go_‰õndly_chs
); i++) {

1526 i‡(
p2p_go_‰õndly_chs
[
i
] =
ch_id
) {

1527 
ch_idx
, 
bôm≠_idx
;

1529 
ch_idx
 = 
	`iwl_mvm_sˇn_ch_™d_b™d_to_idx
(
ch_id
, 
b™d
);

1530 i‡(
ch_idx
 < 0)

1533 
bôm≠_idx
 = 
ch_idx
 / 8;

1534 i‡(
bôm≠_idx
 >
bôm≠_n_íåõs
)

1537 
ch_idx
 = ch_idx % 8;

1538 
ch_bôm≠
[
bôm≠_idx
] |
	`BIT
(
ch_idx
);

1543 
	}
}

1545 
u32
 
	$iwl_mvm_sˇn_ch_n_≠s_Êag
(
∆80211_i·y≥
 
vif_ty≥
, 
u8
 
ch_id
)

1547 
i
;

1548 
u32
 
Êags
 = 0;

1550 i‡(
vif_ty≥
 !
NL80211_IFTYPE_P2P_DEVICE
)

1551 
out
;

1553 
i
 = 0; i < 
	`ARRAY_SIZE
(
p2p_go_‰õndly_chs
); i++) {

1554 i‡(
p2p_go_‰õndly_chs
[
i
] =
ch_id
) {

1555 
Êags
 |
IWL_SCAN_ADWELL_N_APS_GO_FRIENDLY_BIT
;

1560 i‡(
Êags
)

1561 
out
;

1563 
i
 = 0; i < 
	`ARRAY_SIZE
(
socül_chs
); i++) {

1564 i‡(
socül_chs
[
i
] =
ch_id
) {

1565 
Êags
 |
IWL_SCAN_ADWELL_N_APS_SOCIAL_CHS_BIT
;

1570 
out
:

1571  
Êags
;

1572 
	}
}

1575 
	$iwl_mvm_umac_sˇn_cfg_ch™√ls
(
iwl_mvm
 *
mvm
,

1576 
õì80211_ch™√l
 **
ch™√ls
,

1577 
n_ch™√ls
, 
u32
 
Êags
,

1578 
iwl_sˇn_ch™√l_cfg_umac
 *
ch™√l_cfg
)

1580 
i
;

1582 
i
 = 0; i < 
n_ch™√ls
; i++) {

1583 
ch™√l_cfg
[
i
].
Êags
 = 
	`˝u_to_À32
(flags);

1584 
ch™√l_cfg
[
i
].
v1
.
ch™√l_num
 = 
ch™√ls
[i]->
hw_vÆue
;

1585 i‡(
	`iwl_mvm_is_sˇn_ext_ch™_suµ‹ãd
(
mvm
)) {

1586 
∆80211_b™d
 
b™d
 = 
ch™√ls
[
i
]->band;

1588 
ch™√l_cfg
[
i
].
v2
.
b™d
 =

1589 
	`iwl_mvm_phy_b™d_‰om_∆80211
(
b™d
);

1590 
ch™√l_cfg
[
i
].
v2
.
ôî_cou¡
 = 1;

1591 
ch™√l_cfg
[
i
].
v2
.
ôî_öãrvÆ
 = 0;

1593 
ch™√l_cfg
[
i
].
v1
.
ôî_cou¡
 = 1;

1594 
ch™√l_cfg
[
i
].
v1
.
ôî_öãrvÆ
 = 0;

1597 
	}
}

1600 
	$iwl_mvm_umac_sˇn_cfg_ch™√ls_v4
(
iwl_mvm
 *
mvm
,

1601 
õì80211_ch™√l
 **
ch™√ls
,

1602 
iwl_sˇn_ch™√l_∑øms_v4
 *
˝
,

1603 
n_ch™√ls
, 
u32
 
Êags
,

1604 
∆80211_i·y≥
 
vif_ty≥
)

1606 
u8
 *
bôm≠
 = 
˝
->
adwñl_ch_ovîride_bôm≠
;

1607 
size_t
 
bôm≠_n_íåõs
 = 
	`ARRAY_SIZE
(
˝
->
adwñl_ch_ovîride_bôm≠
);

1608 
i
;

1610 
i
 = 0; i < 
n_ch™√ls
; i++) {

1611 
∆80211_b™d
 
b™d
 = 
ch™√ls
[
i
]->band;

1612 
iwl_sˇn_ch™√l_cfg_umac
 *
cfg
 =

1613 &
˝
->
ch™√l_c⁄fig
[
i
];

1615 
cfg
->
Êags
 = 
	`˝u_to_À32
(flags);

1616 
cfg
->
v2
.
ch™√l_num
 = 
ch™√ls
[
i
]->
hw_vÆue
;

1617 
cfg
->
v2
.
b™d
 = 
	`iwl_mvm_phy_b™d_‰om_∆80211
(band);

1618 
cfg
->
v2
.
ôî_cou¡
 = 1;

1619 
cfg
->
v2
.
ôî_öãrvÆ
 = 0;

1621 
	`iwl_mvm_sˇn_ch_add_n_≠s_ovîride
(
vif_ty≥
,

1622 
cfg
->
v2
.
ch™√l_num
,

1623 
cfg
->
v2
.
b™d
, 
bôm≠
,

1624 
bôm≠_n_íåõs
);

1626 
	}
}

1629 
	$iwl_mvm_umac_sˇn_cfg_ch™√ls_v7
(
iwl_mvm
 *
mvm
,

1630 
õì80211_ch™√l
 **
ch™√ls
,

1631 
iwl_sˇn_ch™√l_∑øms_v7
 *
˝
,

1632 
n_ch™√ls
, 
u32
 
Êags
,

1633 
∆80211_i·y≥
 
vif_ty≥
, 
u32
 
vîsi⁄
)

1635 
i
;

1637 
i
 = 0; i < 
n_ch™√ls
; i++) {

1638 
∆80211_b™d
 
b™d
 = 
ch™√ls
[
i
]->band;

1639 
iwl_sˇn_ch™√l_cfg_umac
 *
cfg
 = &
˝
->
ch™√l_c⁄fig
[
i
];

1640 
u32
 
n_≠s_Êag
 =

1641 
	`iwl_mvm_sˇn_ch_n_≠s_Êag
(
vif_ty≥
,

1642 
ch™√ls
[
i
]->
hw_vÆue
);

1643 
u8
 
iwl_b™d
 = 
	`iwl_mvm_phy_b™d_‰om_∆80211
(
b™d
);

1645 
cfg
->
Êags
 = 
	`˝u_to_À32
(Êag†| 
n_≠s_Êag
);

1646 
cfg
->
v2
.
ch™√l_num
 = 
ch™√ls
[
i
]->
hw_vÆue
;

1647 i‡(
	`cfg80211_ch™√l_is_psc
(
ch™√ls
[
i
]))

1648 
cfg
->
Êags
 = 0;

1649 
cfg
->
v2
.
ôî_cou¡
 = 1;

1650 
cfg
->
v2
.
ôî_öãrvÆ
 = 0;

1651 i‡(
vîsi⁄
 < 17)

1652 
cfg
->
v2
.
b™d
 = 
iwl_b™d
;

1654 
cfg
->
Êags
 |
	`˝u_to_À32
((
iwl_b™d
 <<

1655 
IWL_CHAN_CFG_FLAGS_BAND_POS
));

1657 
	}
}

1660 
	$iwl_mvm_umac_sˇn_fûl_6g_ch™_li°
(
iwl_mvm
 *
mvm
,

1661 
iwl_mvm_sˇn_∑øms
 *
∑øms
,

1662 
iwl_sˇn_¥obe_∑øms_v4
 *
µ
)

1664 
j
, 
idex_s
 = 0, 
idex_b
 = 0;

1665 
cfg80211_sˇn_6ghz_∑øms
 *
sˇn_6ghz_∑øms
 =

1666 
∑øms
->
sˇn_6ghz_∑øms
;

1667 
boﬁ
 
hiddí_suµ‹ãd
 = 
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

1668 
IWL_UCODE_TLV_CAPA_HIDDEN_6GHZ_SCAN
);

1670 
j
 = 0; j < 
∑øms
->
n_ssids
 && 
idex_s
 < 
SCAN_SHORT_SSID_MAX_SIZE
;

1671 
j
++) {

1672 i‡(!
∑øms
->
ssids
[
j
].
ssid_Àn
)

1675 
µ
->
sh‹t_ssid
[
idex_s
] =

1676 
	`˝u_to_À32
(~
	`¸c32_À
(~0, 
∑øms
->
ssids
[
j
].
ssid
,

1677 
∑øms
->
ssids
[
j
].
ssid_Àn
));

1679 i‡(
hiddí_suµ‹ãd
) {

1680 
µ
->
dúe˘_sˇn
[
idex_s
].
id
 = 
WLAN_EID_SSID
;

1681 
µ
->
dúe˘_sˇn
[
idex_s
].
Àn
 = 
∑øms
->
ssids
[
j
].
ssid_Àn
;

1682 
	`mem˝y
(
µ
->
dúe˘_sˇn
[
idex_s
].
ssid
, 
∑øms
->
ssids
[
j
].ssid,

1683 
∑øms
->
ssids
[
j
].
ssid_Àn
);

1685 
idex_s
++;

1696 
j
 = 0; j < 
∑øms
->
n_6ghz_∑øms
; j++) {

1697 
k
;

1700 i‡(
sˇn_6ghz_∑øms
[
j
].
sh‹t_ssid_vÆid
) {

1701 
k
 = 0; k < 
idex_s
; k++) {

1702 i‡(
µ
->
sh‹t_ssid
[
k
] ==

1703 
	`˝u_to_À32
(
sˇn_6ghz_∑øms
[
j
].
sh‹t_ssid
))

1707 i‡(
k
 =
idex_s
 && idex_†< 
SCAN_SHORT_SSID_MAX_SIZE
) {

1708 
µ
->
sh‹t_ssid
[
idex_s
++] =

1709 
	`˝u_to_À32
(
sˇn_6ghz_∑øms
[
j
].
sh‹t_ssid
);

1714 
k
 = 0; k < 
idex_b
; k++) {

1715 i‡(!
	`memcmp
(&
µ
->
bssid_¨øy
[
k
],

1716 
sˇn_6ghz_∑øms
[
j
].
bssid
, 
ETH_ALEN
))

1720 i‡(
k
 =
idex_b
 && idex_b < 
SCAN_BSSID_MAX_SIZE
) {

1721 
	`mem˝y
(&
µ
->
bssid_¨øy
[
idex_b
++],

1722 
sˇn_6ghz_∑øms
[
j
].
bssid
, 
ETH_ALEN
);

1726 
µ
->
sh‹t_ssid_num
 = 
idex_s
;

1727 
µ
->
bssid_num
 = 
idex_b
;

1728 
	}
}

1731 
u32


1732 
	$iwl_mvm_umac_sˇn_cfg_ch™√ls_v7_6g
(
iwl_mvm
 *
mvm
,

1733 
iwl_mvm_sˇn_∑øms
 *
∑øms
,

1734 
u32
 
n_ch™√ls
,

1735 
iwl_sˇn_¥obe_∑øms_v4
 *
µ
,

1736 
iwl_sˇn_ch™√l_∑øms_v7
 *
˝
,

1737 
∆80211_i·y≥
 
vif_ty≥
,

1738 
u32
 
vîsi⁄
)

1740 
i
;

1741 
cfg80211_sˇn_6ghz_∑øms
 *
sˇn_6ghz_∑øms
 =

1742 
∑øms
->
sˇn_6ghz_∑øms
;

1743 
u32
 
ch_˙t
;

1745 
i
 = 0, 
ch_˙t
 = 0; i < 
∑øms
->
n_ch™√ls
; i++) {

1746 
iwl_sˇn_ch™√l_cfg_umac
 *
cfg
 =

1747 &
˝
->
ch™√l_c⁄fig
[
ch_˙t
];

1749 
u32
 
s_ssid_bôm≠
 = 0, 
bssid_bôm≠
 = 0, 
Êags
 = 0;

1750 
u8
 
j
, 
k
, 
s_max
 = 0, 
b_max
 = 0, 
n_u£d_bssid_íåõs
;

1751 
boﬁ
 
f‹˚_∑ssive
, 
found
 = 
Ál£
, 
Ælow_∑ssive
 = 
åue
,

1752 
unsﬁicôed_¥obe_⁄_ch™
 = 
Ál£
, 
psc_no_li°í
 = false;

1753 
s8
 
psd_20
 = 
IEEE80211_RNR_TBTT_PARAMS_PSD_RESERVED
;

1760 i‡(!
	`cfg80211_ch™√l_is_psc
(
∑øms
->
ch™√ls
[
i
]) &&

1761 !
∑øms
->
n_6ghz_∑øms
 &&Ö¨ams->
n_ssids
)

1764 
cfg
->
v1
.
ch™√l_num
 = 
∑øms
->
ch™√ls
[
i
]->
hw_vÆue
;

1765 i‡(
vîsi⁄
 < 17)

1766 
cfg
->
v2
.
b™d
 = 
PHY_BAND_6
;

1768 
cfg
->
Êags
 |
	`˝u_to_À32
(
PHY_BAND_6
 <<

1769 
IWL_CHAN_CFG_FLAGS_BAND_POS
);

1771 
cfg
->
v5
.
ôî_cou¡
 = 1;

1772 
cfg
->
v5
.
ôî_öãrvÆ
 = 0;

1781 
n_u£d_bssid_íåõs
 = 3;

1782 
j
 = 0; j < 
∑øms
->
n_6ghz_∑øms
; j++) {

1783 
s8
 
tmp_psd_20
;

1785 i‡(!(
sˇn_6ghz_∑øms
[
j
].
ch™√l_idx
 =
i
))

1791 
tmp_psd_20
 = 
sˇn_6ghz_∑øms
[
j
].
psd_20
;

1792 i‡(
tmp_psd_20
 !=

1793 
IEEE80211_RNR_TBTT_PARAMS_PSD_RESERVED
 &&

1794 (
psd_20
 ==

1795 
IEEE80211_RNR_TBTT_PARAMS_PSD_RESERVED
 ||

1796 
psd_20
 < 
tmp_psd_20
))

1797 
psd_20
 = 
tmp_psd_20
;

1799 
found
 = 
Ál£
;

1800 
unsﬁicôed_¥obe_⁄_ch™
 |=

1801 
sˇn_6ghz_∑øms
[
j
].
unsﬁicôed_¥obe
;

1802 
psc_no_li°í
 |
sˇn_6ghz_∑øms
[
j
].psc_no_listen;

1804 
k
 = 0; k < 
µ
->
sh‹t_ssid_num
; k++) {

1805 i‡(!
sˇn_6ghz_∑øms
[
j
].
unsﬁicôed_¥obe
 &&

1806 
	`À32_to_˝u
(
µ
->
sh‹t_ssid
[
k
]) ==

1807 
sˇn_6ghz_∑øms
[
j
].
sh‹t_ssid
) {

1809 i‡(
s_ssid_bôm≠
 & 
	`BIT
(
k
)) {

1810 
found
 = 
åue
;

1821 i‡(
n_u£d_bssid_íåõs
 >= 3) {

1822 
s_ssid_bôm≠
 |
	`BIT
(
k
);

1823 
s_max
++;

1824 
n_u£d_bssid_íåõs
 -= 3;

1825 
found
 = 
åue
;

1827 } i‡(
µ
->
dúe˘_sˇn
[
k
].
Àn
) {

1828 
s_ssid_bôm≠
 |
	`BIT
(
k
);

1829 
s_max
++;

1830 
found
 = 
åue
;

1831 
Ælow_∑ssive
 = 
Ál£
;

1837 i‡(
found
)

1840 
k
 = 0; k < 
µ
->
bssid_num
; k++) {

1841 i‡(!
	`memcmp
(&
µ
->
bssid_¨øy
[
k
],

1842 
sˇn_6ghz_∑øms
[
j
].
bssid
,

1843 
ETH_ALEN
)) {

1844 i‡(!(
bssid_bôm≠
 & 
	`BIT
(
k
))) {

1845 
bssid_bôm≠
 |
	`BIT
(
k
);

1846 
b_max
++;

1847 
n_u£d_bssid_íåõs
++;

1854 i‡(
	`cfg80211_ch™√l_is_psc
(
∑øms
->
ch™√ls
[
i
]) &&

1855 
psc_no_li°í
)

1856 
Êags
 |
IWL_UHB_CHAN_CFG_FLAG_PSC_CHAN_NO_LISTEN
;

1858 i‡(
unsﬁicôed_¥obe_⁄_ch™
)

1859 
Êags
 |
IWL_UHB_CHAN_CFG_FLAG_UNSOLICITED_PROBE_RES
;

1878 i‡(!
	`iwl_mvm_is_sˇn_‰agmíãd
(
∑øms
->
ty≥
)) {

1879 i‡(!
	`cfg80211_ch™√l_is_psc
(
∑øms
->
ch™√ls
[
i
]) ||

1880 
Êags
 & 
IWL_UHB_CHAN_CFG_FLAG_PSC_CHAN_NO_LISTEN
) {

1881 
f‹˚_∑ssive
 = (
s_max
 > 3 || 
b_max
 > 9);

1882 
f‹˚_∑ssive
 |(
unsﬁicôed_¥obe_⁄_ch™
 &&

1883 (
s_max
 > 2 || 
b_max
 > 6));

1885 
f‹˚_∑ssive
 = (
s_max
 > 2 || 
b_max
 > 6);

1887 } i‡(
	`cfg80211_ch™√l_is_psc
(
∑øms
->
ch™√ls
[
i
])) {

1888 
f‹˚_∑ssive
 = (
s_max
 > 1 || 
b_max
 > 3);

1890 
f‹˚_∑ssive
 = (
s_max
 > 2 || 
b_max
 > 6);

1891 
f‹˚_∑ssive
 |(
unsﬁicôed_¥obe_⁄_ch™
 &&

1892 (
s_max
 > 1 || 
b_max
 > 3));

1894 i‡((
Ælow_∑ssive
 && 
f‹˚_∑ssive
) ||

1895 (!(
bssid_bôm≠
 | 
s_ssid_bôm≠
) &&

1896 !
	`cfg80211_ch™√l_is_psc
(
∑øms
->
ch™√ls
[
i
])))

1897 
Êags
 |
IWL_UHB_CHAN_CFG_FLAG_FORCE_PASSIVE
;

1899 
Êags
 |
bssid_bôm≠
 | (
s_ssid_bôm≠
 << 16);

1901 
cfg
->
Êags
 |
	`˝u_to_À32
(flags);

1902 i‡(
vîsi⁄
 >= 17)

1903 
cfg
->
v5
.
psd_20
 =Ösd_20;

1905 
ch_˙t
++;

1908 i‡(
∑øms
->
n_ch™√ls
 > 
ch_˙t
)

1909 
	`IWL_DEBUG_SCAN
(
mvm
,

1911 
∑øms
->
n_ch™√ls
, 
ch_˙t
);

1913  
ch_˙t
;

1914 
	}
}

1916 
u8
 
	$iwl_mvm_sˇn_umac_ch™_Êags_v2
(
iwl_mvm
 *
mvm
,

1917 
iwl_mvm_sˇn_∑øms
 *
∑øms
,

1918 
õì80211_vif
 *
vif
)

1920 
u8
 
Êags
 = 0;

1922 
Êags
 |
IWL_SCAN_CHANNEL_FLAG_ENABLE_CHAN_ORDER
;

1924 i‡(
	`iwl_mvm_sˇn_u£_ebs
(
mvm
, 
vif
))

1925 
Êags
 |
IWL_SCAN_CHANNEL_FLAG_EBS
 |

1926 
IWL_SCAN_CHANNEL_FLAG_EBS_ACCURATE
 |

1927 
IWL_SCAN_CHANNEL_FLAG_CACHE_ADD
;

1930 i‡((!
	`iwl_mvm_is_cdb_suµ‹ãd
(
mvm
) &&

1931 
	`iwl_mvm_is_sˇn_‰agmíãd
(
∑øms
->
ty≥
)) ||

1932 (
	`iwl_mvm_is_cdb_suµ‹ãd
(
mvm
) &&

1933 
	`iwl_mvm_is_sˇn_‰agmíãd
(
∑øms
->
hb_ty≥
)))

1934 
Êags
 |
IWL_SCAN_CHANNEL_FLAG_EBS_FRAG
;

1940 i‡((!
	`iwl_mvm_is_cdb_suµ‹ãd
(
mvm
) &&

1941 
	`iwl_mvm_is_sˇn_‰agmíãd
(
∑øms
->
ty≥
Ë&&Ö¨ams->
ª•e˘_p2p_go
) ||

1942 (
	`iwl_mvm_is_cdb_suµ‹ãd
(
mvm
) &&

1943 
	`iwl_mvm_is_sˇn_‰agmíãd
(
∑øms
->
hb_ty≥
) &&

1944 
∑øms
->
ª•e˘_p2p_go_hb
)) {

1945 
	`IWL_DEBUG_SCAN
(
mvm
, "Respect P2P GO. Force EBS\n");

1946 
Êags
 |
IWL_SCAN_CHANNEL_FLAG_FORCE_EBS
;

1949  
Êags
;

1950 
	}
}

1952 
	$iwl_mvm_sˇn_6ghz_∑ssive_sˇn
(
iwl_mvm
 *
mvm
,

1953 
iwl_mvm_sˇn_∑øms
 *
∑øms
,

1954 
õì80211_vif
 *
vif
)

1956 
õì80211_suµ‹ãd_b™d
 *
sb™d
 =

1957 &
mvm
->
nvm_d©a
->
b™ds
[
NL80211_BAND_6GHZ
];

1958 
u32
 
n_dißbÀd
, 
i
;

1960 
∑øms
->
íabÀ_6ghz_∑ssive
 = 
Ál£
;

1962 i‡(
∑øms
->
sˇn_6ghz
)

1965 i‡(!
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

1966 
IWL_UCODE_TLV_CAPA_PASSIVE_6GHZ_SCAN
)) {

1967 
	`IWL_DEBUG_SCAN
(
mvm
,

1973 i‡(
vif
->
ty≥
 !
NL80211_IFTYPE_STATION
) {

1974 
	`IWL_DEBUG_SCAN
(
mvm
,

1984 i‡((
vif
->
cfg
.
assoc
 ||

1985 
	`time_a·î
(
mvm
->
œ°_6ghz_∑ssive_sˇn_jiffõs
 +

1986 (
IWL_MVM_6GHZ_PASSIVE_SCAN_TIMEOUT
 * 
HZ
), 
jiffõs
)) &&

1987 (
	`time_bef‹e
(
mvm
->
œ°_ª£t_‹_ªsume_time_jiffõs
 +

1988 (
IWL_MVM_6GHZ_PASSIVE_SCAN_ASSOC_TIMEOUT
 * 
HZ
),

1989 
jiffõs
))) {

1990 
	`IWL_DEBUG_SCAN
(
mvm
, "6GHzÖassive scan: %s\n",

1991 
vif
->
cfg
.
assoc
 ? "associated" :

1997 i‡(
∑øms
->
n_ch™√ls
 < 
IWL_MVM_6GHZ_PASSIVE_SCAN_MIN_CHANS
) {

1998 
	`IWL_DEBUG_SCAN
(
mvm
,

2003 
i
 = 0; i < 
∑øms
->
n_ssids
; i++) {

2004 i‡(!
∑øms
->
ssids
[
i
].
ssid_Àn
)

2009 i‡(
i
 =
∑øms
->
n_ssids
) {

2010 
	`IWL_DEBUG_SCAN
(
mvm
,

2015 i‡(!
sb™d
 || !sb™d->
n_ch™√ls
) {

2016 
	`IWL_DEBUG_SCAN
(
mvm
,

2021 
i
 = 0, 
n_dißbÀd
 = 0; i < 
sb™d
->
n_ch™√ls
; i++) {

2022 i‡(
sb™d
->
ch™√ls
[
i
].
Êags
 & (
IEEE80211_CHAN_DISABLED
))

2023 
n_dißbÀd
++;

2030 i‡(
n_dißbÀd
 !
sb™d
->
n_ch™√ls
) {

2031 
	`IWL_DEBUG_SCAN
(
mvm
,

2037 
	`IWL_DEBUG_SCAN
(
mvm
, "6GHzÖassive scan: can beÉnabled\n");

2038 
∑øms
->
íabÀ_6ghz_∑ssive
 = 
åue
;

2039 
	}
}

2041 
u16
 
	$iwl_mvm_sˇn_umac_Êags_v2
(
iwl_mvm
 *
mvm
,

2042 
iwl_mvm_sˇn_∑øms
 *
∑øms
,

2043 
õì80211_vif
 *
vif
,

2044 
ty≥
)

2046 
u16
 
Êags
 = 0;

2054 i‡(
∑øms
->
n_ssids
 == 0)

2055 
Êags
 |
IWL_UMAC_SCAN_GEN_FLAGS_V2_FORCE_PASSIVE
;

2056 i‡(
∑øms
->
n_ssids
 =1 &&Ö¨ams->
ssids
[0].
ssid_Àn
)

2057 
Êags
 |
IWL_UMAC_SCAN_GEN_FLAGS_V2_USE_ALL_RX_CHAINS
;

2059 i‡(
	`iwl_mvm_is_sˇn_‰agmíãd
(
∑øms
->
ty≥
))

2060 
Êags
 |
IWL_UMAC_SCAN_GEN_FLAGS_V2_FRAGMENTED_LMAC1
;

2062 i‡(
	`iwl_mvm_is_sˇn_‰agmíãd
(
∑øms
->
hb_ty≥
))

2063 
Êags
 |
IWL_UMAC_SCAN_GEN_FLAGS_V2_FRAGMENTED_LMAC2
;

2065 i‡(
∑øms
->
∑ss_Æl
)

2066 
Êags
 |
IWL_UMAC_SCAN_GEN_FLAGS_V2_PASS_ALL
;

2068 
Êags
 |
IWL_UMAC_SCAN_GEN_FLAGS_V2_MATCH
;

2070 i‡(!
	`iwl_mvm_is_ªguœr_sˇn
(
∑øms
))

2071 
Êags
 |
IWL_UMAC_SCAN_GEN_FLAGS_V2_PERIODIC
;

2073 i‡(
∑øms
->
ôî_nŸif
 ||

2074 
mvm
->
sched_sˇn_∑ss_Æl
 =
SCHED_SCAN_PASS_ALL_ENABLED
)

2075 
Êags
 |
IWL_UMAC_SCAN_GEN_FLAGS_V2_NTFY_ITER_COMPLETE
;

2077 i‡(
IWL_MVM_ADWELL_ENABLE
)

2078 
Êags
 |
IWL_UMAC_SCAN_GEN_FLAGS_V2_ADAPTIVE_DWELL
;

2080 i‡(
ty≥
 =
IWL_MVM_SCAN_SCHED
 ||Åy≥ =
IWL_MVM_SCAN_NETDETECT
)

2081 
Êags
 |
IWL_UMAC_SCAN_GEN_FLAGS_V2_PREEMPTIVE
;

2083 i‡((
ty≥
 =
IWL_MVM_SCAN_SCHED
 ||Åy≥ =
IWL_MVM_SCAN_NETDETECT
) &&

2084 
∑øms
->
Êags
 & 
NL80211_SCAN_FLAG_COLOCATED_6GHZ
)

2085 
Êags
 |
IWL_UMAC_SCAN_GEN_FLAGS_V2_TRIGGER_UHB_SCAN
;

2087 i‡(
∑øms
->
íabÀ_6ghz_∑ssive
)

2088 
Êags
 |
IWL_UMAC_SCAN_GEN_FLAGS_V2_6GHZ_PASSIVE_SCAN
;

2090 i‡(
	`iwl_mvm_is_o˚_suµ‹ãd
(
mvm
) &&

2091 (
∑øms
->
Êags
 & (
NL80211_SCAN_FLAG_ACCEPT_BCAST_PROBE_RESP
 |

2092 
NL80211_SCAN_FLAG_OCE_PROBE_REQ_HIGH_TX_RATE
 |

2093 
NL80211_SCAN_FLAG_FILS_MAX_CHANNEL_TIME
)))

2094 
Êags
 |
IWL_UMAC_SCAN_GEN_FLAGS_V2_OCE
;

2096  
Êags
;

2097 
	}
}

2099 
u8
 
	$iwl_mvm_sˇn_umac_Êags2
(
iwl_mvm
 *
mvm
,

2100 
iwl_mvm_sˇn_∑øms
 *
∑øms
,

2101 
õì80211_vif
 *
vif
, 
ty≥
)

2103 
u8
 
Êags
 = 0;

2105 i‡(
	`iwl_mvm_is_cdb_suµ‹ãd
(
mvm
)) {

2106 i‡(
∑øms
->
ª•e˘_p2p_go
)

2107 
Êags
 |
IWL_UMAC_SCAN_GEN_PARAMS_FLAGS2_RESPECT_P2P_GO_LB
;

2108 i‡(
∑øms
->
ª•e˘_p2p_go_hb
)

2109 
Êags
 |
IWL_UMAC_SCAN_GEN_PARAMS_FLAGS2_RESPECT_P2P_GO_HB
;

2111 i‡(
∑øms
->
ª•e˘_p2p_go
)

2112 
Êags
 = 
IWL_UMAC_SCAN_GEN_PARAMS_FLAGS2_RESPECT_P2P_GO_LB
 |

2113 
IWL_UMAC_SCAN_GEN_PARAMS_FLAGS2_RESPECT_P2P_GO_HB
;

2116 i‡(
∑øms
->
sˇn_6ghz
 &&

2117 
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

2118 
IWL_UCODE_TLV_CAPA_SCAN_DONT_TOGGLE_ANT
))

2119 
Êags
 |
IWL_UMAC_SCAN_GEN_PARAMS_FLAGS2_DONT_TOGGLE_ANT
;

2121  
Êags
;

2122 
	}
}

2124 
u16
 
	$iwl_mvm_sˇn_umac_Êags
(
iwl_mvm
 *
mvm
,

2125 
iwl_mvm_sˇn_∑øms
 *
∑øms
,

2126 
õì80211_vif
 *
vif
)

2128 
u16
 
Êags
 = 0;

2130 i‡(
∑øms
->
n_ssids
 == 0)

2131 
Êags
 = 
IWL_UMAC_SCAN_GEN_FLAGS_PASSIVE
;

2133 i‡(
∑øms
->
n_ssids
 =1 &&Ö¨ams->
ssids
[0].
ssid_Àn
 != 0)

2134 
Êags
 |
IWL_UMAC_SCAN_GEN_FLAGS_PRE_CONNECT
;

2136 i‡(
	`iwl_mvm_is_sˇn_‰agmíãd
(
∑øms
->
ty≥
))

2137 
Êags
 |
IWL_UMAC_SCAN_GEN_FLAGS_FRAGMENTED
;

2139 i‡(
	`iwl_mvm_is_cdb_suµ‹ãd
(
mvm
) &&

2140 
	`iwl_mvm_is_sˇn_‰agmíãd
(
∑øms
->
hb_ty≥
))

2141 
Êags
 |
IWL_UMAC_SCAN_GEN_FLAGS_LMAC2_FRAGMENTED
;

2143 i‡(
	`iwl_mvm_ºm_sˇn_√eded
(
mvm
) &&

2144 
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

2145 
IWL_UCODE_TLV_CAPA_WFA_TPC_REP_IE_SUPPORT
))

2146 
Êags
 |
IWL_UMAC_SCAN_GEN_FLAGS_RRM_ENABLED
;

2148 i‡(
∑øms
->
∑ss_Æl
)

2149 
Êags
 |
IWL_UMAC_SCAN_GEN_FLAGS_PASS_ALL
;

2151 
Êags
 |
IWL_UMAC_SCAN_GEN_FLAGS_MATCH
;

2153 i‡(!
	`iwl_mvm_is_ªguœr_sˇn
(
∑øms
))

2154 
Êags
 |
IWL_UMAC_SCAN_GEN_FLAGS_PERIODIC
;

2156 i‡(
∑øms
->
ôî_nŸif
)

2157 
Êags
 |
IWL_UMAC_SCAN_GEN_FLAGS_ITER_COMPLETE
;

2159 #ifde‡
CONFIG_IWLWIFI_DEBUGFS


2160 i‡(
mvm
->
sˇn_ôî_nŸif_íabÀd
)

2161 
Êags
 |
IWL_UMAC_SCAN_GEN_FLAGS_ITER_COMPLETE
;

2164 i‡(
mvm
->
sched_sˇn_∑ss_Æl
 =
SCHED_SCAN_PASS_ALL_ENABLED
)

2165 
Êags
 |
IWL_UMAC_SCAN_GEN_FLAGS_ITER_COMPLETE
;

2167 i‡(
	`iwl_mvm_is_ad≠tive_dwñl_suµ‹ãd
(
mvm
Ë&& 
IWL_MVM_ADWELL_ENABLE
)

2168 
Êags
 |
IWL_UMAC_SCAN_GEN_FLAGS_ADAPTIVE_DWELL
;

2175 i‡(
	`iwl_mvm_is_ªguœr_sˇn
(
∑øms
) &&

2176 
vif
->
ty≥
 !
NL80211_IFTYPE_P2P_DEVICE
 &&

2177 !
	`iwl_mvm_is_sˇn_‰agmíãd
(
∑øms
->
ty≥
) &&

2178 !
	`iwl_mvm_is_ad≠tive_dwñl_suµ‹ãd
(
mvm
) &&

2179 !
	`iwl_mvm_is_o˚_suµ‹ãd
(
mvm
))

2180 
Êags
 |
IWL_UMAC_SCAN_GEN_FLAGS_EXTENDED_DWELL
;

2182 i‡(
	`iwl_mvm_is_o˚_suµ‹ãd
(
mvm
)) {

2183 i‡((
∑øms
->
Êags
 &

2184 
NL80211_SCAN_FLAG_OCE_PROBE_REQ_HIGH_TX_RATE
))

2185 
Êags
 |
IWL_UMAC_SCAN_GEN_FLAGS_PROB_REQ_HIGH_TX_RATE
;

2191 i‡((
∑øms
->
Êags
 &

2192 
NL80211_SCAN_FLAG_OCE_PROBE_REQ_DEFERRAL_SUPPRESSION
) &&

2193 !
	`WARN_ON_ONCE
(!
	`iwl_mvm_is_ad≠tive_dwñl_suµ‹ãd
(
mvm
)))

2194 
Êags
 |
IWL_UMAC_SCAN_GEN_FLAGS_PROB_REQ_DEFER_SUPP
;

2195 i‡((
∑øms
->
Êags
 & 
NL80211_SCAN_FLAG_FILS_MAX_CHANNEL_TIME
))

2196 
Êags
 |
IWL_UMAC_SCAN_GEN_FLAGS_MAX_CHNL_TIME
;

2199  
Êags
;

2200 
	}
}

2203 
	$iwl_mvm_fûl_sˇn_sched_∑øms
(
iwl_mvm_sˇn_∑øms
 *
∑øms
,

2204 
iwl_sˇn_umac_scheduÀ
 *
scheduÀ
,

2205 
__À16
 *
dñay
)

2207 
i
;

2208 i‡(
	`WARN_ON
(!
∑øms
->
n_sˇn_∂™s
 ||

2209 
∑øms
->
n_sˇn_∂™s
 > 
IWL_MAX_SCHED_SCAN_PLANS
))

2210  -
EINVAL
;

2212 
i
 = 0; i < 
∑øms
->
n_sˇn_∂™s
; i++) {

2213 
cfg80211_sched_sˇn_∂™
 *
sˇn_∂™
 =

2214 &
∑øms
->
sˇn_∂™s
[
i
];

2216 
scheduÀ
[
i
].
ôî_cou¡
 = 
sˇn_∂™
->
ôî©i⁄s
;

2217 
scheduÀ
[
i
].
öãrvÆ
 =

2218 
	`˝u_to_À16
(
sˇn_∂™
->
öãrvÆ
);

2227 i‡(!
scheduÀ
[
∑øms
->
n_sˇn_∂™s
 - 1].
ôî_cou¡
)

2228 
scheduÀ
[
∑øms
->
n_sˇn_∂™s
 - 1].
ôî_cou¡
 = 0xff;

2230 *
dñay
 = 
	`˝u_to_À16
(
∑øms
->delay);

2233 
	}
}

2235 
	$iwl_mvm_sˇn_umac
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

2236 
iwl_mvm_sˇn_∑øms
 *
∑øms
,

2237 
ty≥
, 
uid
)

2239 
iwl_sˇn_ªq_umac
 *
cmd
 = 
mvm
->
sˇn_cmd
;

2240 
iwl_sˇn_umac_ch™_∑øm
 *
ch™_∑øm
;

2241 *
cmd_d©a
 = 
	`iwl_mvm_gë_sˇn_ªq_umac_d©a
(
mvm
);

2242 *
£c_∑π
 = (
u8
 *)
cmd_d©a
 + (
iwl_sˇn_ch™√l_cfg_umac
) *

2243 
mvm
->
fw
->
ucode_ˇ∑
.
n_sˇn_ch™√ls
;

2244 
iwl_sˇn_ªq_umac_èû_v2
 *
èû_v2
 =

2245 (
iwl_sˇn_ªq_umac_èû_v2
 *)
£c_∑π
;

2246 
iwl_sˇn_ªq_umac_èû_v1
 *
èû_v1
;

2247 
iwl_ssid_õ
 *
dúe˘_sˇn
;

2248 
ªt
 = 0;

2249 
u32
 
ssid_bôm≠
 = 0;

2250 
u8
 
ch™√l_Êags
 = 0;

2251 
u16
 
gí_Êags
;

2252 
iwl_mvm_vif
 *
sˇn_vif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

2254 
ch™_∑øm
 = 
	`iwl_mvm_gë_sˇn_ªq_umac_ch™√l
(
mvm
);

2256 
	`iwl_mvm_sˇn_umac_dwñl
(
mvm
, 
cmd
, 
∑øms
);

2258 
mvm
->
sˇn_uid_°©us
[
uid
] = 
ty≥
;

2260 
cmd
->
uid
 = 
	`˝u_to_À32
(uid);

2261 
gí_Êags
 = 
	`iwl_mvm_sˇn_umac_Êags
(
mvm
, 
∑øms
, 
vif
);

2262 
cmd
->
gíîÆ_Êags
 = 
	`˝u_to_À16
(
gí_Êags
);

2263 i‡(
	`iwl_mvm_is_ad≠tive_dwñl_v2_suµ‹ãd
(
mvm
)) {

2264 i‡(
gí_Êags
 & 
IWL_UMAC_SCAN_GEN_FLAGS_FRAGMENTED
)

2265 
cmd
->
v8
.
num_of_‰agmíts
[
SCAN_LB_LMAC_IDX
] =

2266 
IWL_SCAN_NUM_OF_FRAGS
;

2267 i‡(
gí_Êags
 & 
IWL_UMAC_SCAN_GEN_FLAGS_LMAC2_FRAGMENTED
)

2268 
cmd
->
v8
.
num_of_‰agmíts
[
SCAN_HB_LMAC_IDX
] =

2269 
IWL_SCAN_NUM_OF_FRAGS
;

2271 
cmd
->
v8
.
gíîÆ_Êags2
 =

2272 
IWL_UMAC_SCAN_GEN_FLAGS2_ALLOW_CHNL_REORDER
;

2275 
cmd
->
sˇn_°¨t_mac_id
 = 
sˇn_vif
->
id
;

2277 i‡(
ty≥
 =
IWL_MVM_SCAN_SCHED
 ||Åy≥ =
IWL_MVM_SCAN_NETDETECT
)

2278 
cmd
->
Êags
 = 
	`˝u_to_À32
(
IWL_UMAC_SCAN_FLAG_PREEMPTIVE
);

2280 i‡(
	`iwl_mvm_sˇn_u£_ebs
(
mvm
, 
vif
)) {

2281 
ch™√l_Êags
 = 
IWL_SCAN_CHANNEL_FLAG_EBS
 |

2282 
IWL_SCAN_CHANNEL_FLAG_EBS_ACCURATE
 |

2283 
IWL_SCAN_CHANNEL_FLAG_CACHE_ADD
;

2286 i‡(
	`iwl_mvm_is_‰ag_ebs_suµ‹ãd
(
mvm
)) {

2287 i‡(
gí_Êags
 &

2288 
IWL_UMAC_SCAN_GEN_FLAGS_LMAC2_FRAGMENTED
 ||

2289 (!
	`iwl_mvm_is_cdb_suµ‹ãd
(
mvm
) &&

2290 
gí_Êags
 & 
IWL_UMAC_SCAN_GEN_FLAGS_FRAGMENTED
))

2291 
ch™√l_Êags
 |
IWL_SCAN_CHANNEL_FLAG_EBS_FRAG
;

2295 
ch™_∑øm
->
Êags
 = 
ch™√l_Êags
;

2296 
ch™_∑øm
->
cou¡
 = 
∑øms
->
n_ch™√ls
;

2298 
ªt
 = 
	`iwl_mvm_fûl_sˇn_sched_∑øms
(
∑øms
, 
èû_v2
->
scheduÀ
,

2299 &
èû_v2
->
dñay
);

2300 i‡(
ªt
) {

2301 
mvm
->
sˇn_uid_°©us
[
uid
] = 0;

2302  
ªt
;

2305 i‡(
	`iwl_mvm_is_sˇn_ext_ch™_suµ‹ãd
(
mvm
)) {

2306 
èû_v2
->
¥eq
 = 
∑øms
->preq;

2307 
dúe˘_sˇn
 = 
èû_v2
->direct_scan;

2309 
èû_v1
 = (
iwl_sˇn_ªq_umac_èû_v1
 *)
£c_∑π
;

2310 
	`iwl_mvm_sˇn_£t_Àgacy_¥obe_ªq
(&
èû_v1
->
¥eq
,

2311 &
∑øms
->
¥eq
);

2312 
dúe˘_sˇn
 = 
èû_v1
->direct_scan;

2314 
	`iwl_sˇn_buûd_ssids
(
∑øms
, 
dúe˘_sˇn
, &
ssid_bôm≠
);

2315 
	`iwl_mvm_umac_sˇn_cfg_ch™√ls
(
mvm
, 
∑øms
->
ch™√ls
,

2316 
∑øms
->
n_ch™√ls
, 
ssid_bôm≠
,

2317 
cmd_d©a
);

2319 
	}
}

2322 
	$iwl_mvm_sˇn_umac_fûl_gíîÆ_p_v12
(
iwl_mvm
 *
mvm
,

2323 
iwl_mvm_sˇn_∑øms
 *
∑øms
,

2324 
õì80211_vif
 *
vif
,

2325 
iwl_sˇn_gíîÆ_∑øms_v11
 *
gp
,

2326 
u16
 
gí_Êags
, 
u8
 
gí_Êags2
,

2327 
u32
 
vîsi⁄
)

2329 
iwl_mvm_vif
 *
sˇn_vif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

2331 
	`iwl_mvm_sˇn_umac_dwñl_v11
(
mvm
, 
gp
, 
∑øms
);

2333 
	`IWL_DEBUG_SCAN
(
mvm
, "General: flags=0x%x, flags2=0x%x\n",

2334 
gí_Êags
, 
gí_Êags2
);

2336 
gp
->
Êags
 = 
	`˝u_to_À16
(
gí_Êags
);

2337 
gp
->
Êags2
 = 
gí_Êags2
;

2339 i‡(
gí_Êags
 & 
IWL_UMAC_SCAN_GEN_FLAGS_V2_FRAGMENTED_LMAC1
)

2340 
gp
->
num_of_‰agmíts
[
SCAN_LB_LMAC_IDX
] = 
IWL_SCAN_NUM_OF_FRAGS
;

2341 i‡(
gí_Êags
 & 
IWL_UMAC_SCAN_GEN_FLAGS_V2_FRAGMENTED_LMAC2
)

2342 
gp
->
num_of_‰agmíts
[
SCAN_HB_LMAC_IDX
] = 
IWL_SCAN_NUM_OF_FRAGS
;

2344 
mvm
->
sˇn_lök_id
 = 0;

2346 i‡(
vîsi⁄
 < 16) {

2347 
gp
->
sˇn_°¨t_mac_‹_lök_id
 = 
sˇn_vif
->
id
;

2349 
iwl_mvm_vif_lök_öfo
 *
lök_öfo
 =

2350 
sˇn_vif
->
lök
[
∑øms
->
tsf_ªp‹t_lök_id
];

2352 
mvm
->
sˇn_lök_id
 = 
∑øms
->
tsf_ªp‹t_lök_id
;

2353 i‡(!
	`WARN_ON
(!
lök_öfo
))

2354 
gp
->
sˇn_°¨t_mac_‹_lök_id
 = 
lök_öfo
->
fw_lök_id
;

2356 
	}
}

2359 
	$iwl_mvm_sˇn_umac_fûl_¥obe_p_v3
(
iwl_mvm_sˇn_∑øms
 *
∑øms
,

2360 
iwl_sˇn_¥obe_∑øms_v3
 *
µ
)

2362 
µ
->
¥eq
 = 
∑øms
->preq;

2363 
µ
->
ssid_num
 = 
∑øms
->
n_ssids
;

2364 
	`iwl_sˇn_buûd_ssids
(
∑øms
, 
µ
->
dúe˘_sˇn
, 
NULL
);

2365 
	}
}

2368 
	$iwl_mvm_sˇn_umac_fûl_¥obe_p_v4
(
iwl_mvm_sˇn_∑øms
 *
∑øms
,

2369 
iwl_sˇn_¥obe_∑øms_v4
 *
µ
,

2370 
u32
 *
bôm≠_ssid
)

2372 
µ
->
¥eq
 = 
∑øms
->preq;

2373 
	`iwl_sˇn_buûd_ssids
(
∑øms
, 
µ
->
dúe˘_sˇn
, 
bôm≠_ssid
);

2374 
	}
}

2377 
	$iwl_mvm_sˇn_umac_fûl_ch_p_v4
(
iwl_mvm
 *
mvm
,

2378 
iwl_mvm_sˇn_∑øms
 *
∑øms
,

2379 
õì80211_vif
 *
vif
,

2380 
iwl_sˇn_ch™√l_∑øms_v4
 *
˝
,

2381 
u32
 
ch™√l_cfg_Êags
)

2383 
˝
->
Êags
 = 
	`iwl_mvm_sˇn_umac_ch™_Êags_v2
(
mvm
, 
∑øms
, 
vif
);

2384 
˝
->
cou¡
 = 
∑øms
->
n_ch™√ls
;

2385 
˝
->
num_of_≠s_ovîride
 = 
IWL_SCAN_ADWELL_N_APS_GO_FRIENDLY
;

2387 
	`iwl_mvm_umac_sˇn_cfg_ch™√ls_v4
(
mvm
, 
∑øms
->
ch™√ls
, 
˝
,

2388 
∑øms
->
n_ch™√ls
,

2389 
ch™√l_cfg_Êags
,

2390 
vif
->
ty≥
);

2391 
	}
}

2394 
	$iwl_mvm_sˇn_umac_fûl_ch_p_v7
(
iwl_mvm
 *
mvm
,

2395 
iwl_mvm_sˇn_∑øms
 *
∑øms
,

2396 
õì80211_vif
 *
vif
,

2397 
iwl_sˇn_ch™√l_∑øms_v7
 *
˝
,

2398 
u32
 
ch™√l_cfg_Êags
,

2399 
u32
 
vîsi⁄
)

2401 
˝
->
Êags
 = 
	`iwl_mvm_sˇn_umac_ch™_Êags_v2
(
mvm
, 
∑øms
, 
vif
);

2402 
˝
->
cou¡
 = 
∑øms
->
n_ch™√ls
;

2403 
˝
->
n_≠s_ovîride
[0] = 
IWL_SCAN_ADWELL_N_APS_GO_FRIENDLY
;

2404 
˝
->
n_≠s_ovîride
[1] = 
IWL_SCAN_ADWELL_N_APS_SOCIAL_CHS
;

2406 
	`iwl_mvm_umac_sˇn_cfg_ch™√ls_v7
(
mvm
, 
∑øms
->
ch™√ls
, 
˝
,

2407 
∑øms
->
n_ch™√ls
,

2408 
ch™√l_cfg_Êags
,

2409 
vif
->
ty≥
, 
vîsi⁄
);

2411 i‡(
∑øms
->
íabÀ_6ghz_∑ssive
) {

2412 
õì80211_suµ‹ãd_b™d
 *
sb™d
 =

2413 &
mvm
->
nvm_d©a
->
b™ds
[
NL80211_BAND_6GHZ
];

2414 
u32
 
i
;

2416 
i
 = 0; i < 
sb™d
->
n_ch™√ls
; i++) {

2417 
õì80211_ch™√l
 *
ch™√l
 =

2418 &
sb™d
->
ch™√ls
[
i
];

2420 
iwl_sˇn_ch™√l_cfg_umac
 *
cfg
 =

2421 &
˝
->
ch™√l_c⁄fig
[˝->
cou¡
];

2423 i‡(!
	`cfg80211_ch™√l_is_psc
(
ch™√l
))

2426 
cfg
->
v5
.
ch™√l_num
 = 
ch™√l
->
hw_vÆue
;

2427 
cfg
->
v5
.
ôî_cou¡
 = 1;

2428 
cfg
->
v5
.
ôî_öãrvÆ
 = 0;

2430 i‡(
vîsi⁄
 < 17) {

2431 
cfg
->
Êags
 = 0;

2432 
cfg
->
v2
.
b™d
 = 
PHY_BAND_6
;

2434 
cfg
->
Êags
 = 
	`˝u_to_À32
(
PHY_BAND_6
 <<

2435 
IWL_CHAN_CFG_FLAGS_BAND_POS
);

2436 
cfg
->
v5
.
psd_20
 =

2437 
IEEE80211_RNR_TBTT_PARAMS_PSD_RESERVED
;

2439 
˝
->
cou¡
++;

2442 
	}
}

2444 
	$iwl_mvm_sˇn_umac_v12
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

2445 
iwl_mvm_sˇn_∑øms
 *
∑øms
, 
ty≥
,

2446 
uid
)

2448 
iwl_sˇn_ªq_umac_v12
 *
cmd
 = 
mvm
->
sˇn_cmd
;

2449 
iwl_sˇn_ªq_∑øms_v12
 *
sˇn_p
 = &
cmd
->
sˇn_∑øms
;

2450 
ªt
;

2451 
u16
 
gí_Êags
;

2453 
mvm
->
sˇn_uid_°©us
[
uid
] = 
ty≥
;

2455 
cmd
->
ooc_¥i‹ôy
 = 
	`˝u_to_À32
(
	`iwl_mvm_sˇn_umac_ooc_¥i‹ôy
(
∑øms
));

2456 
cmd
->
uid
 = 
	`˝u_to_À32
(uid);

2458 
gí_Êags
 = 
	`iwl_mvm_sˇn_umac_Êags_v2
(
mvm
, 
∑øms
, 
vif
, 
ty≥
);

2459 
	`iwl_mvm_sˇn_umac_fûl_gíîÆ_p_v12
(
mvm
, 
∑øms
, 
vif
,

2460 &
sˇn_p
->
gíîÆ_∑øms
,

2461 
gí_Êags
, 0, 12);

2463 
ªt
 = 
	`iwl_mvm_fûl_sˇn_sched_∑øms
(
∑øms
,

2464 
sˇn_p
->
≥riodic_∑øms
.
scheduÀ
,

2465 &
sˇn_p
->
≥riodic_∑øms
.
dñay
);

2466 i‡(
ªt
)

2467  
ªt
;

2469 
	`iwl_mvm_sˇn_umac_fûl_¥obe_p_v3
(
∑øms
, &
sˇn_p
->
¥obe_∑øms
);

2470 
	`iwl_mvm_sˇn_umac_fûl_ch_p_v4
(
mvm
, 
∑øms
, 
vif
,

2471 &
sˇn_p
->
ch™√l_∑øms
, 0);

2474 
	}
}

2476 
	$iwl_mvm_sˇn_umac_v14_™d_above
(
iwl_mvm
 *
mvm
,

2477 
õì80211_vif
 *
vif
,

2478 
iwl_mvm_sˇn_∑øms
 *
∑øms
,

2479 
ty≥
, 
uid
, 
u32
 
vîsi⁄
)

2481 
iwl_sˇn_ªq_umac_v17
 *
cmd
 = 
mvm
->
sˇn_cmd
;

2482 
iwl_sˇn_ªq_∑øms_v17
 *
sˇn_p
 = &
cmd
->
sˇn_∑øms
;

2483 
iwl_sˇn_ch™√l_∑øms_v7
 *
˝
 = &
sˇn_p
->
ch™√l_∑øms
;

2484 
iwl_sˇn_¥obe_∑øms_v4
 *
pb
 = &
sˇn_p
->
¥obe_∑øms
;

2485 
ªt
;

2486 
u16
 
gí_Êags
;

2487 
u8
 
gí_Êags2
;

2488 
u32
 
bôm≠_ssid
 = 0;

2490 
mvm
->
sˇn_uid_°©us
[
uid
] = 
ty≥
;

2492 
cmd
->
ooc_¥i‹ôy
 = 
	`˝u_to_À32
(
	`iwl_mvm_sˇn_umac_ooc_¥i‹ôy
(
∑øms
));

2493 
cmd
->
uid
 = 
	`˝u_to_À32
(uid);

2495 
gí_Êags
 = 
	`iwl_mvm_sˇn_umac_Êags_v2
(
mvm
, 
∑øms
, 
vif
, 
ty≥
);

2497 i‡(
vîsi⁄
 >= 15)

2498 
gí_Êags2
 = 
	`iwl_mvm_sˇn_umac_Êags2
(
mvm
, 
∑øms
, 
vif
, 
ty≥
);

2500 
gí_Êags2
 = 0;

2502 
	`iwl_mvm_sˇn_umac_fûl_gíîÆ_p_v12
(
mvm
, 
∑øms
, 
vif
,

2503 &
sˇn_p
->
gíîÆ_∑øms
,

2504 
gí_Êags
, 
gí_Êags2
, 
vîsi⁄
);

2506 
ªt
 = 
	`iwl_mvm_fûl_sˇn_sched_∑øms
(
∑øms
,

2507 
sˇn_p
->
≥riodic_∑øms
.
scheduÀ
,

2508 &
sˇn_p
->
≥riodic_∑øms
.
dñay
);

2509 i‡(
ªt
)

2510  
ªt
;

2512 i‡(!
∑øms
->
sˇn_6ghz
) {

2513 
	`iwl_mvm_sˇn_umac_fûl_¥obe_p_v4
(
∑øms
,

2514 &
sˇn_p
->
¥obe_∑øms
,

2515 &
bôm≠_ssid
);

2516 
	`iwl_mvm_sˇn_umac_fûl_ch_p_v7
(
mvm
, 
∑øms
, 
vif
,

2517 &
sˇn_p
->
ch™√l_∑øms
,

2518 
bôm≠_ssid
,

2519 
vîsi⁄
);

2522 
pb
->
¥eq
 = 
∑øms
->preq;

2525 
˝
->
Êags
 = 
	`iwl_mvm_sˇn_umac_ch™_Êags_v2
(
mvm
, 
∑øms
, 
vif
);

2526 
˝
->
n_≠s_ovîride
[0] = 
IWL_SCAN_ADWELL_N_APS_GO_FRIENDLY
;

2527 
˝
->
n_≠s_ovîride
[1] = 
IWL_SCAN_ADWELL_N_APS_SOCIAL_CHS
;

2529 
	`iwl_mvm_umac_sˇn_fûl_6g_ch™_li°
(
mvm
, 
∑øms
, 
pb
);

2531 
˝
->
cou¡
 = 
	`iwl_mvm_umac_sˇn_cfg_ch™√ls_v7_6g
(
mvm
, 
∑øms
,

2532 
∑øms
->
n_ch™√ls
,

2533 
pb
, 
˝
, 
vif
->
ty≥
,

2534 
vîsi⁄
);

2535 i‡(!
˝
->
cou¡
) {

2536 
mvm
->
sˇn_uid_°©us
[
uid
] = 0;

2537  -
EINVAL
;

2540 i‡(!
∑øms
->
n_ssids
 ||

2541 (
∑øms
->
n_ssids
 =1 && !∑øms->
ssids
[0].
ssid_Àn
))

2542 
˝
->
Êags
 |
IWL_SCAN_CHANNEL_FLAG_6G_PSC_NO_FILTER
;

2545 
	}
}

2547 
	$iwl_mvm_sˇn_umac_v14
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

2548 
iwl_mvm_sˇn_∑øms
 *
∑øms
, 
ty≥
,

2549 
uid
)

2551  
	`iwl_mvm_sˇn_umac_v14_™d_above
(
mvm
, 
vif
, 
∑øms
, 
ty≥
, 
uid
, 14);

2552 
	}
}

2554 
	$iwl_mvm_sˇn_umac_v15
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

2555 
iwl_mvm_sˇn_∑øms
 *
∑øms
, 
ty≥
,

2556 
uid
)

2558  
	`iwl_mvm_sˇn_umac_v14_™d_above
(
mvm
, 
vif
, 
∑øms
, 
ty≥
, 
uid
, 15);

2559 
	}
}

2561 
	$iwl_mvm_sˇn_umac_v16
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

2562 
iwl_mvm_sˇn_∑øms
 *
∑øms
, 
ty≥
,

2563 
uid
)

2565  
	`iwl_mvm_sˇn_umac_v14_™d_above
(
mvm
, 
vif
, 
∑øms
, 
ty≥
, 
uid
, 16);

2566 
	}
}

2568 
	$iwl_mvm_sˇn_umac_v17
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

2569 
iwl_mvm_sˇn_∑øms
 *
∑øms
, 
ty≥
,

2570 
uid
)

2572  
	`iwl_mvm_sˇn_umac_v14_™d_above
(
mvm
, 
vif
, 
∑øms
, 
ty≥
, 
uid
, 17);

2573 
	}
}

2575 
	$iwl_mvm_num_sˇns
(
iwl_mvm
 *
mvm
)

2577  
	`hweight32
(
mvm
->
sˇn_°©us
 & 
IWL_MVM_SCAN_MASK
);

2578 
	}
}

2580 
	$iwl_mvm_check_ru¬ög_sˇns
(
iwl_mvm
 *
mvm
, 
ty≥
)

2582 
boﬁ
 
unifõd_image
 = 
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

2583 
IWL_UCODE_TLV_CAPA_CNSLDTD_D3_D0_IMG
);

2596 i‡((
ty≥
 =
IWL_MVM_SCAN_SCHED
 ||Åy≥ =
IWL_MVM_SCAN_NETDETECT
) &&

2597 
mvm
->
sˇn_°©us
 & (
IWL_MVM_SCAN_SCHED
 | 
IWL_MVM_SCAN_NETDETECT
))

2598  -
EBUSY
;

2600 i‡(
	`iwl_mvm_num_sˇns
(
mvm
Ë< mvm->
max_sˇns
)

2606 
ty≥
) {

2607 
IWL_MVM_SCAN_REGULAR
:

2608 i‡(
mvm
->
sˇn_°©us
 & 
IWL_MVM_SCAN_REGULAR_MASK
)

2609  -
EBUSY
;

2610  
	`iwl_mvm_sˇn_°›
(
mvm
, 
IWL_MVM_SCAN_SCHED
, 
åue
);

2611 
IWL_MVM_SCAN_SCHED
:

2612 i‡(
mvm
->
sˇn_°©us
 & 
IWL_MVM_SCAN_SCHED_MASK
)

2613  -
EBUSY
;

2614  
	`iwl_mvm_sˇn_°›
(
mvm
, 
IWL_MVM_SCAN_REGULAR
, 
åue
);

2615 
IWL_MVM_SCAN_NETDETECT
:

2621 i‡(!
unifõd_image
)

2630 i‡(
mvm
->
sˇn_°©us
 & 
IWL_MVM_SCAN_REGULAR_MASK
)

2631  
	`iwl_mvm_sˇn_°›
(
mvm
, 
IWL_MVM_SCAN_REGULAR
,

2632 
åue
);

2633 i‡(
mvm
->
sˇn_°©us
 & 
IWL_MVM_SCAN_SCHED_MASK
)

2634  
	`iwl_mvm_sˇn_°›
(
mvm
, 
IWL_MVM_SCAN_SCHED
,

2635 
åue
);

2639 
ÁŒthrough
;

2641 
	`WARN_ON
(1);

2645  -
EIO
;

2646 
	}
}

2648 
	#SCAN_TIMEOUT
 30000

	)

2650 
	$iwl_mvm_sˇn_timeout_wk
(
w‹k_°ru˘
 *
w‹k
)

2652 
dñayed_w‹k
 *dñayed_w‹k = 
	`to_dñayed_w‹k
(
w‹k
);

2653 
iwl_mvm
 *
mvm
 = 
	`c⁄èöî_of
(
dñayed_w‹k
, iwl_mvm,

2654 
sˇn_timeout_dw‹k
);

2656 
	`IWL_ERR
(
mvm
, "regular scanÅimed out\n");

2658 
	`iwl_f‹˚_nmi
(
mvm
->
å™s
);

2659 
	}
}

2661 
	$iwl_mvm_fûl_sˇn_ty≥
(
iwl_mvm
 *
mvm
,

2662 
iwl_mvm_sˇn_∑øms
 *
∑øms
,

2663 
õì80211_vif
 *
vif
)

2665 i‡(
	`iwl_mvm_is_cdb_suµ‹ãd
(
mvm
)) {

2666 
∑øms
->
ty≥
 =

2667 
	`iwl_mvm_gë_sˇn_ty≥_b™d
(
mvm
, 
vif
,

2668 
NL80211_BAND_2GHZ
);

2669 
∑øms
->
hb_ty≥
 =

2670 
	`iwl_mvm_gë_sˇn_ty≥_b™d
(
mvm
, 
vif
,

2671 
NL80211_BAND_5GHZ
);

2673 
∑øms
->
ty≥
 = 
	`iwl_mvm_gë_sˇn_ty≥
(
mvm
, 
vif
);

2675 
	}
}

2677 
	siwl_sˇn_umac_h™dÀr
 {

2678 
u8
 
	mvîsi⁄
;

2679 (*
	mh™dÀr
)(
iwl_mvm
 *
	mmvm
, 
õì80211_vif
 *
	mvif
,

2680 
iwl_mvm_sˇn_∑øms
 *
	m∑øms
, 
	mty≥
, 
	muid
);

2683 
	#IWL_SCAN_UMAC_HANDLER
(
_vî
) { \

2684 .
vîsi⁄
 = 
_vî
, \

2685 .
h™dÀr
 = 
iwl_mvm_sˇn_umac_v
##
_vî
, \

2686 }

	)

2688 c⁄° 
iwl_sˇn_umac_h™dÀr
 
	giwl_sˇn_umac_h™dÀrs
[] = {

2690 
IWL_SCAN_UMAC_HANDLER
(17),

2691 
IWL_SCAN_UMAC_HANDLER
(16),

2692 
IWL_SCAN_UMAC_HANDLER
(15),

2693 
IWL_SCAN_UMAC_HANDLER
(14),

2694 
IWL_SCAN_UMAC_HANDLER
(12),

2697 
	$iwl_mvm_mei_sˇn_w‹k
(
w‹k_°ru˘
 *
wk
)

2699 
iwl_mei_sˇn_fûãr
 *
sˇn_fûãr
 =

2700 
	`c⁄èöî_of
(
wk
, 
iwl_mei_sˇn_fûãr
, 
sˇn_w‹k
);

2701 
iwl_mvm
 *
mvm
 =

2702 
	`c⁄èöî_of
(
sˇn_fûãr
, 
iwl_mvm
, 
mei_sˇn_fûãr
);

2703 
iwl_mvm_csme_c⁄n_öfo
 *
öfo
;

2704 
sk_buff
 *
skb
;

2705 
u8
 
bssid
[
ETH_ALEN
];

2707 
	`muãx_lock
(&
mvm
->
muãx
);

2708 
öfo
 = 
	`iwl_mvm_gë_csme_c⁄n_öfo
(
mvm
);

2709 
	`mem˝y
(
bssid
, 
öfo
->
c⁄n_öfo
.bssid, 
ETH_ALEN
);

2710 
	`muãx_u∆ock
(&
mvm
->
muãx
);

2712 (
skb
 = 
	`skb_dequeue
(&
sˇn_fûãr
->
sˇn_ªs
))) {

2713 
õì80211_mgmt
 *
mgmt
 = (*)
skb
->
d©a
;

2715 i‡(!
	`memcmp
(
mgmt
->
bssid
, bssid, 
ETH_ALEN
))

2716 
	`õì80211_rx_úqß„
(
mvm
->
hw
, 
skb
);

2718 
	`k‰ì_skb
(
skb
);

2720 
	}
}

2722 
	$iwl_mvm_mei_sˇn_fûãr_öô
(
iwl_mei_sˇn_fûãr
 *
mei_sˇn_fûãr
)

2724 
	`skb_queue_hód_öô
(&
mei_sˇn_fûãr
->
sˇn_ªs
);

2725 
	`INIT_WORK
(&
mei_sˇn_fûãr
->
sˇn_w‹k
, 
iwl_mvm_mei_sˇn_w‹k
);

2726 
	}
}

2732 
	$iwl_mvm_mei_limôed_sˇn
(
iwl_mvm
 *
mvm
,

2733 
iwl_mvm_sˇn_∑øms
 *
∑øms
)

2735 
iwl_mvm_csme_c⁄n_öfo
 *
öfo
 = 
	`iwl_mvm_gë_csme_c⁄n_öfo
(
mvm
);

2736 
iwl_mei_c⁄n_öfo
 *
c⁄n_öfo
;

2737 
õì80211_ch™√l
 *
ch™
;

2738 
sˇn_ôîs
, 
i
;

2740 i‡(!
öfo
) {

2741 
	`IWL_DEBUG_SCAN
(
mvm
, "mei_limited_scan:Ço connection info\n");

2745 
c⁄n_öfo
 = &
öfo
->conn_info;

2746 i‡(!
öfo
->
c⁄n_öfo
.
Õ_°©e
 || !öfo->c⁄n_öfo.
ssid_Àn
)

2749 i‡(!
∑øms
->
n_ch™√ls
 || !∑øms->
n_ssids
)

2752 
mvm
->
mei_sˇn_fûãr
.
is_mei_limôed_sˇn
 = 
åue
;

2754 
ch™
 = 
	`õì80211_gë_ch™√l
(
mvm
->
hw
->
wùhy
,

2755 
	`õì80211_ch™√l_to_‰equícy
(
c⁄n_öfo
->
ch™√l
,

2756 
c⁄n_öfo
->
b™d
));

2757 i‡(!
ch™
) {

2758 
	`IWL_DEBUG_SCAN
(
mvm
,

2760 
c⁄n_öfo
->
ch™√l
, c⁄n_öfo->
b™d
);

2768 
sˇn_ôîs
 = 
	`mö
(
IWL_MEI_SCAN_NUM_ITER
, 
∑øms
->
n_ch™√ls
);

2769 
∑øms
->
n_ch™√ls
 = 
sˇn_ôîs
;

2770 
i
 = 0; i < 
sˇn_ôîs
; i++)

2771 
∑øms
->
ch™√ls
[
i
] = 
ch™
;

2773 
	`IWL_DEBUG_SCAN
(
mvm
, "Meòsˇn:Çum iãøti⁄s=%u\n", 
sˇn_ôîs
);

2775 
∑øms
->
n_ssids
 = 1;

2776 
∑øms
->
ssids
[0].
ssid_Àn
 = 
c⁄n_öfo
->ssid_len;

2777 
	`mem˝y
(
∑øms
->
ssids
[0].
ssid
, 
c⁄n_öfo
->ssid, c⁄n_öfo->
ssid_Àn
);

2778 
	}
}

2780 
	$iwl_mvm_buûd_sˇn_cmd
(
iwl_mvm
 *
mvm
,

2781 
õì80211_vif
 *
vif
,

2782 
iwl_ho°_cmd
 *
hcmd
,

2783 
iwl_mvm_sˇn_∑øms
 *
∑øms
,

2784 
ty≥
)

2786 
uid
, 
i
, 
îr
;

2787 
u8
 
sˇn_vî
;

2789 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

2790 
	`mem£t
(
mvm
->
sˇn_cmd
, 0, mvm->
sˇn_cmd_size
);

2792 
	`iwl_mvm_mei_limôed_sˇn
(
mvm
, 
∑øms
);

2794 i‡(!
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_CAPA_UMAC_SCAN
)) {

2795 
hcmd
->
id
 = 
SCAN_OFFLOAD_REQUEST_CMD
;

2797  
	`iwl_mvm_sˇn_lmac
(
mvm
, 
vif
, 
∑øms
);

2800 
uid
 = 
	`iwl_mvm_sˇn_uid_by_°©us
(
mvm
, 0);

2801 i‡(
uid
 < 0)

2802  
uid
;

2804 
hcmd
->
id
 = 
	`WIDE_ID
(
IWL_ALWAYS_LONG_GROUP
, 
SCAN_REQ_UMAC
);

2806 
sˇn_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
SCAN_REQ_UMAC
,

2807 
IWL_FW_CMD_VER_UNKNOWN
);

2809 
i
 = 0; i < 
	`ARRAY_SIZE
(
iwl_sˇn_umac_h™dÀrs
); i++) {

2810 c⁄° 
iwl_sˇn_umac_h™dÀr
 *
vî_h™dÀr
 =

2811 &
iwl_sˇn_umac_h™dÀrs
[
i
];

2813 i‡(
vî_h™dÀr
->
vîsi⁄
 !
sˇn_vî
)

2816 
îr
 = 
vî_h™dÀr
->
	`h™dÀr
(
mvm
, 
vif
, 
∑øms
, 
ty≥
, 
uid
);

2817  
îr
 ? : 
uid
;

2820 
îr
 = 
	`iwl_mvm_sˇn_umac
(
mvm
, 
vif
, 
∑øms
, 
ty≥
, 
uid
);

2821 i‡(
îr
)

2822  
îr
;

2824  
uid
;

2825 
	}
}

2827 
	siwl_mvm_sˇn_ª•e˘_p2p_go_ôî_d©a
 {

2828 
õì80211_vif
 *
	mcuºít_vif
;

2829 
boﬁ
 
	mp2p_go
;

2830 
∆80211_b™d
 
	mb™d
;

2833 
	$iwl_mvm_sˇn_ª•e˘_p2p_go_ôî
(*
_d©a
, 
u8
 *
mac
,

2834 
õì80211_vif
 *
vif
)

2836 
iwl_mvm_sˇn_ª•e˘_p2p_go_ôî_d©a
 *
d©a
 = 
_d©a
;

2837 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

2840 i‡(
vif
 =
d©a
->
cuºít_vif
)

2843 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
 && vif->
p2p
) {

2844 
u32
 
lök_id
;

2846 
lök_id
 = 0;

2847 
lök_id
 < 
	`ARRAY_SIZE
(
mvmvif
->
lök
);

2848 
lök_id
++) {

2849 
iwl_mvm_vif_lök_öfo
 *
lök
 =

2850 
mvmvif
->
lök
[
lök_id
];

2852 i‡(
lök
 &&Üök->
phy_˘xt
->
id
 < 
NUM_PHY_CTX
 &&

2853 (
d©a
->
b™d
 =
NUM_NL80211_BANDS
 ||

2854 
lök
->
phy_˘xt
->
ch™√l
->
b™d
 =
d©a
->band)) {

2855 
d©a
->
p2p_go
 = 
åue
;

2860 
	}
}

2862 
boﬁ
 
	$_iwl_mvm_gë_ª•e˘_p2p_go
(
iwl_mvm
 *
mvm
,

2863 
õì80211_vif
 *
vif
,

2864 
boﬁ
 
low_œãncy
,

2865 
∆80211_b™d
 
b™d
)

2867 
iwl_mvm_sˇn_ª•e˘_p2p_go_ôî_d©a
 
d©a
 = {

2868 .
cuºít_vif
 = 
vif
,

2869 .
p2p_go
 = 
Ál£
,

2870 .
b™d
 = band,

2873 i‡(!
low_œãncy
)

2874  
Ál£
;

2876 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s_©omic
(
mvm
->
hw
,

2877 
IEEE80211_IFACE_ITER_NORMAL
,

2878 
iwl_mvm_sˇn_ª•e˘_p2p_go_ôî
,

2879 &
d©a
);

2881  
d©a
.
p2p_go
;

2882 
	}
}

2884 
boﬁ
 
	$iwl_mvm_gë_ª•e˘_p2p_go_b™d
(
iwl_mvm
 *
mvm
,

2885 
õì80211_vif
 *
vif
,

2886 
∆80211_b™d
 
b™d
)

2888 
boﬁ
 
low_œãncy
 = 
	`iwl_mvm_low_œãncy_b™d
(
mvm
, 
b™d
);

2890  
	`_iwl_mvm_gë_ª•e˘_p2p_go
(
mvm
, 
vif
, 
low_œãncy
, 
b™d
);

2891 
	}
}

2893 
boﬁ
 
	$iwl_mvm_gë_ª•e˘_p2p_go
(
iwl_mvm
 *
mvm
,

2894 
õì80211_vif
 *
vif
)

2896 
boﬁ
 
low_œãncy
 = 
	`iwl_mvm_low_œãncy
(
mvm
);

2898  
	`_iwl_mvm_gë_ª•e˘_p2p_go
(
mvm
, 
vif
, 
low_œãncy
,

2899 
NUM_NL80211_BANDS
);

2900 
	}
}

2902 
	$iwl_mvm_fûl_ª•e˘_p2p_go
(
iwl_mvm
 *
mvm
,

2903 
iwl_mvm_sˇn_∑øms
 *
∑øms
,

2904 
õì80211_vif
 *
vif
)

2906 i‡(
	`iwl_mvm_is_cdb_suµ‹ãd
(
mvm
)) {

2907 
∑øms
->
ª•e˘_p2p_go
 =

2908 
	`iwl_mvm_gë_ª•e˘_p2p_go_b™d
(
mvm
, 
vif
,

2909 
NL80211_BAND_2GHZ
);

2910 
∑øms
->
ª•e˘_p2p_go_hb
 =

2911 
	`iwl_mvm_gë_ª•e˘_p2p_go_b™d
(
mvm
, 
vif
,

2912 
NL80211_BAND_5GHZ
);

2914 
∑øms
->
ª•e˘_p2p_go
 = 
	`iwl_mvm_gë_ª•e˘_p2p_go
(
mvm
, 
vif
);

2916 
	}
}

2918 
	$iwl_mvm_ªg_sˇn_°¨t
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

2919 
cfg80211_sˇn_ªque°
 *
ªq
,

2920 
õì80211_sˇn_õs
 *
õs
)

2922 
iwl_ho°_cmd
 
hcmd
 = {

2923 .
Àn
 = { 
	`iwl_mvm_sˇn_size
(
mvm
), },

2924 .
d©a
 = { 
mvm
->
sˇn_cmd
, },

2925 .
d©aÊags
 = { 
IWL_HCMD_DFL_NOCOPY
, },

2927 
iwl_mvm_sˇn_∑øms
 
∑øms
 = {};

2928 
ªt
, 
uid
;

2929 
cfg80211_sched_sˇn_∂™
 
sˇn_∂™
 = { .
ôî©i⁄s
 = 1 };

2931 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

2933 i‡(
	`iwl_mvm_is_œr_suµ‹ãd
(
mvm
Ë&& !mvm->
œr_ªgdom_£t
) {

2934 
	`IWL_ERR
(
mvm
, "scan while LARÑegdomain isÇot set\n");

2935  -
EBUSY
;

2938 
ªt
 = 
	`iwl_mvm_check_ru¬ög_sˇns
(
mvm
, 
IWL_MVM_SCAN_REGULAR
);

2939 i‡(
ªt
)

2940  
ªt
;

2943 i‡(
	`WARN_ON
(!
mvm
->
sˇn_cmd
))

2944  -
ENOMEM
;

2946 i‡(!
	`iwl_mvm_sˇn_fôs
(
mvm
, 
ªq
->
n_ssids
, 
õs
,Ñeq->
n_ch™√ls
))

2947  -
ENOBUFS
;

2949 
∑øms
.
n_ssids
 = 
ªq
->n_ssids;

2950 
∑øms
.
Êags
 = 
ªq
->flags;

2951 
∑øms
.
n_ch™√ls
 = 
ªq
->n_channels;

2952 
∑øms
.
dñay
 = 0;

2953 
∑øms
.
ssids
 = 
ªq
->ssids;

2954 
∑øms
.
ch™√ls
 = 
ªq
->channels;

2955 
∑øms
.
mac_addr
 = 
ªq
->mac_addr;

2956 
∑øms
.
mac_addr_mask
 = 
ªq
->mac_addr_mask;

2957 
∑øms
.
no_cck
 = 
ªq
->no_cck;

2958 
∑øms
.
∑ss_Æl
 = 
åue
;

2959 
∑øms
.
n_m©ch_£ts
 = 0;

2960 
∑øms
.
m©ch_£ts
 = 
NULL
;

2961 
	`ëhî_addr_c›y
(
∑øms
.
bssid
, 
ªq
->bssid);

2963 
∑øms
.
sˇn_∂™s
 = &
sˇn_∂™
;

2964 
∑øms
.
n_sˇn_∂™s
 = 1;

2966 
∑øms
.
n_6ghz_∑øms
 = 
ªq
->n_6ghz_params;

2967 
∑øms
.
sˇn_6ghz_∑øms
 = 
ªq
->scan_6ghz_params;

2968 
∑øms
.
sˇn_6ghz
 = 
ªq
->scan_6ghz;

2969 
	`iwl_mvm_fûl_sˇn_ty≥
(
mvm
, &
∑øms
, 
vif
);

2970 
	`iwl_mvm_fûl_ª•e˘_p2p_go
(
mvm
, &
∑øms
, 
vif
);

2972 i‡(
ªq
->
duøti⁄
)

2973 
∑øms
.
ôî_nŸif
 = 
åue
;

2975 
∑øms
.
tsf_ªp‹t_lök_id
 = 
ªq
->tsf_report_link_id;

2976 i‡(
∑øms
.
tsf_ªp‹t_lök_id
 < 0) {

2977 i‡(
vif
->
a˘ive_löks
)

2978 
∑øms
.
tsf_ªp‹t_lök_id
 = 
	`__ffs
(
vif
->
a˘ive_löks
);

2980 
∑øms
.
tsf_ªp‹t_lök_id
 = 0;

2983 
	`iwl_mvm_buûd_sˇn_¥obe
(
mvm
, 
vif
, 
õs
, &
∑øms
);

2985 
	`iwl_mvm_sˇn_6ghz_∑ssive_sˇn
(
mvm
, &
∑øms
, 
vif
);

2987 
uid
 = 
	`iwl_mvm_buûd_sˇn_cmd
(
mvm
, 
vif
, &
hcmd
, &
∑øms
,

2988 
IWL_MVM_SCAN_REGULAR
);

2990 i‡(
uid
 < 0)

2991  
uid
;

2993 
	`iwl_mvm_∑u£_tcm
(
mvm
, 
Ál£
);

2995 
ªt
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
hcmd
);

2996 i‡(
ªt
) {

3001 
	`IWL_ERR
(
mvm
, "Sˇ¿Áûed!Ñë %d\n", 
ªt
);

3002 
	`iwl_mvm_ªsume_tcm
(
mvm
);

3003 
mvm
->
sˇn_uid_°©us
[
uid
] = 0;

3004  
ªt
;

3007 
	`IWL_DEBUG_SCAN
(
mvm
, "ScanÑequest was sent successfully\n");

3008 
mvm
->
sˇn_°©us
 |
IWL_MVM_SCAN_REGULAR
;

3009 
mvm
->
sˇn_vif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

3011 i‡(
∑øms
.
íabÀ_6ghz_∑ssive
)

3012 
mvm
->
œ°_6ghz_∑ssive_sˇn_jiffõs
 = 
jiffõs
;

3014 
	`scheduÀ_dñayed_w‹k
(&
mvm
->
sˇn_timeout_dw‹k
,

3015 
	`m£cs_to_jiffõs
(
SCAN_TIMEOUT
));

3018 
	}
}

3020 
	$iwl_mvm_sched_sˇn_°¨t
(
iwl_mvm
 *
mvm
,

3021 
õì80211_vif
 *
vif
,

3022 
cfg80211_sched_sˇn_ªque°
 *
ªq
,

3023 
õì80211_sˇn_õs
 *
õs
,

3024 
ty≥
)

3026 
iwl_ho°_cmd
 
hcmd
 = {

3027 .
Àn
 = { 
	`iwl_mvm_sˇn_size
(
mvm
), },

3028 .
d©a
 = { 
mvm
->
sˇn_cmd
, },

3029 .
d©aÊags
 = { 
IWL_HCMD_DFL_NOCOPY
, },

3031 
iwl_mvm_sˇn_∑øms
 
∑øms
 = {};

3032 
ªt
, 
uid
;

3033 
i
, 
j
;

3034 
boﬁ
 
n⁄_psc_ö˛uded
 = 
Ál£
;

3036 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

3038 i‡(
	`iwl_mvm_is_œr_suµ‹ãd
(
mvm
Ë&& !mvm->
œr_ªgdom_£t
) {

3039 
	`IWL_ERR
(
mvm
, "sched-scan while LARÑegdomain isÇot set\n");

3040  -
EBUSY
;

3043 
ªt
 = 
	`iwl_mvm_check_ru¬ög_sˇns
(
mvm
, 
ty≥
);

3044 i‡(
ªt
)

3045  
ªt
;

3048 i‡(
	`WARN_ON
(!
mvm
->
sˇn_cmd
))

3049  -
ENOMEM
;

3052 
∑øms
.
n_ssids
 = 
ªq
->n_ssids;

3053 
∑øms
.
Êags
 = 
ªq
->flags;

3054 
∑øms
.
n_ch™√ls
 = 
ªq
->n_channels;

3055 
∑øms
.
ssids
 = 
ªq
->ssids;

3056 
∑øms
.
ch™√ls
 = 
ªq
->channels;

3057 
∑øms
.
mac_addr
 = 
ªq
->mac_addr;

3058 
∑øms
.
mac_addr_mask
 = 
ªq
->mac_addr_mask;

3059 
∑øms
.
no_cck
 = 
Ál£
;

3060 
∑øms
.
∑ss_Æl
 = 
	`iwl_mvm_sˇn_∑ss_Æl
(
mvm
, 
ªq
);

3061 
∑øms
.
n_m©ch_£ts
 = 
ªq
->n_match_sets;

3062 
∑øms
.
m©ch_£ts
 = 
ªq
->match_sets;

3063 
	`ëh_brﬂdˇ°_addr
(
∑øms
.
bssid
);

3064 i‡(!
ªq
->
n_sˇn_∂™s
)

3065  -
EINVAL
;

3067 
∑øms
.
n_sˇn_∂™s
 = 
ªq
->n_scan_plans;

3068 
∑øms
.
sˇn_∂™s
 = 
ªq
->scan_plans;

3070 
	`iwl_mvm_fûl_sˇn_ty≥
(
mvm
, &
∑øms
, 
vif
);

3071 
	`iwl_mvm_fûl_ª•e˘_p2p_go
(
mvm
, &
∑øms
, 
vif
);

3078 i‡(
ªq
->
dñay
 > 
U16_MAX
) {

3079 
	`IWL_DEBUG_SCAN
(
mvm
,

3081 
∑øms
.
dñay
 = 
U16_MAX
;

3083 
∑øms
.
dñay
 = 
ªq
->delay;

3086 
ªt
 = 
	`iwl_mvm_c⁄fig_sched_sˇn_¥ofûes
(
mvm
, 
ªq
);

3087 i‡(
ªt
)

3088  
ªt
;

3090 
	`iwl_mvm_buûd_sˇn_¥obe
(
mvm
, 
vif
, 
õs
, &
∑øms
);

3093 
i
 = 0; i < 
∑øms
.
n_ch™√ls
; i++) {

3094 
õì80211_ch™√l
 *
ch™√l
 = 
∑øms
.
ch™√ls
[
i
];

3096 i‡(
ch™√l
->
b™d
 =
NL80211_BAND_6GHZ
 &&

3097 !
	`cfg80211_ch™√l_is_psc
(
ch™√l
)) {

3098 
n⁄_psc_ö˛uded
 = 
åue
;

3103 i‡(
n⁄_psc_ö˛uded
) {

3104 
∑øms
.
ch™√ls
 = 
	`kmemdup
(params.channels,

3105 (
∑øms
.
ch™√ls
[0]) *

3106 
∑øms
.
n_ch™√ls
,

3107 
GFP_KERNEL
);

3108 i‡(!
∑øms
.
ch™√ls
)

3109  -
ENOMEM
;

3111 
i
 = 
j
 = 0; i < 
∑øms
.
n_ch™√ls
; i++) {

3112 i‡(
∑øms
.
ch™√ls
[
i
]->
b™d
 =
NL80211_BAND_6GHZ
 &&

3113 !
	`cfg80211_ch™√l_is_psc
(
∑øms
.
ch™√ls
[
i
]))

3115 
∑øms
.
ch™√ls
[
j
++] =Ö¨ams.ch™√ls[
i
];

3117 
∑øms
.
n_ch™√ls
 = 
j
;

3120 i‡(
n⁄_psc_ö˛uded
 &&

3121 !
	`iwl_mvm_sˇn_fôs
(
mvm
, 
ªq
->
n_ssids
, 
õs
, 
∑øms
.
n_ch™√ls
)) {

3122 
	`k‰ì
(
∑øms
.
ch™√ls
);

3123  -
ENOBUFS
;

3126 
uid
 = 
	`iwl_mvm_buûd_sˇn_cmd
(
mvm
, 
vif
, &
hcmd
, &
∑øms
, 
ty≥
);

3128 i‡(
n⁄_psc_ö˛uded
)

3129 
	`k‰ì
(
∑øms
.
ch™√ls
);

3130 i‡(
uid
 < 0)

3131  
uid
;

3133 
ªt
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
hcmd
);

3134 i‡(!
ªt
) {

3135 
	`IWL_DEBUG_SCAN
(
mvm
,

3137 
mvm
->
sˇn_°©us
 |
ty≥
;

3143 
	`IWL_ERR
(
mvm
, "Sched sˇ¿Áûed!Ñë %d\n", 
ªt
);

3144 
mvm
->
sˇn_uid_°©us
[
uid
] = 0;

3145 
mvm
->
sched_sˇn_∑ss_Æl
 = 
SCHED_SCAN_PASS_ALL_DISABLED
;

3148  
ªt
;

3149 
	}
}

3151 
	$iwl_mvm_rx_umac_sˇn_com∂ëe_nŸif
(
iwl_mvm
 *
mvm
,

3152 
iwl_rx_cmd_buf„r
 *
rxb
)

3154 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

3155 
iwl_umac_sˇn_com∂ëe
 *
nŸif
 = (*)
pkt
->
d©a
;

3156 
u32
 
uid
 = 
	`__À32_to_˝u
(
nŸif
->uid);

3157 
boﬁ
 
ab‹ãd
 = (
nŸif
->
°©us
 =
IWL_SCAN_OFFLOAD_ABORTED
);

3159 
mvm
->
mei_sˇn_fûãr
.
is_mei_limôed_sˇn
 = 
Ál£
;

3161 i‡(
	`WARN_ON
(!(
mvm
->
sˇn_uid_°©us
[
uid
] & mvm->
sˇn_°©us
)))

3165 i‡(
mvm
->
sˇn_uid_°©us
[
uid
] =
IWL_MVM_SCAN_REGULAR
) {

3166 
cfg80211_sˇn_öfo
 
öfo
 = {

3167 .
ab‹ãd
 =áborted,

3168 .
sˇn_°¨t_tsf
 = 
mvm
->
sˇn_°¨t
,

3170 
iwl_mvm_vif
 *
sˇn_vif
 = 
mvm
->scan_vif;

3171 
iwl_mvm_vif_lök_öfo
 *
lök_öfo
 =

3172 
sˇn_vif
->
lök
[
mvm
->
sˇn_lök_id
];

3174 i‡(!
	`WARN_ON
(!
lök_öfo
))

3175 
	`mem˝y
(
öfo
.
tsf_bssid
, 
lök_öfo
->
bssid
, 
ETH_ALEN
);

3177 
	`õì80211_sˇn_com∂ëed
(
mvm
->
hw
, &
öfo
);

3178 
mvm
->
sˇn_vif
 = 
NULL
;

3179 
	`ˇn˚l_dñayed_w‹k
(&
mvm
->
sˇn_timeout_dw‹k
);

3180 
	`iwl_mvm_ªsume_tcm
(
mvm
);

3181 } i‡(
mvm
->
sˇn_uid_°©us
[
uid
] =
IWL_MVM_SCAN_SCHED
) {

3182 
	`õì80211_sched_sˇn_°›≥d
(
mvm
->
hw
);

3183 
mvm
->
sched_sˇn_∑ss_Æl
 = 
SCHED_SCAN_PASS_ALL_DISABLED
;

3186 
mvm
->
sˇn_°©us
 &~mvm->
sˇn_uid_°©us
[
uid
];

3187 
	`IWL_DEBUG_SCAN
(
mvm
,

3189 
uid
, 
mvm
->
sˇn_uid_°©us
[uid],

3190 
nŸif
->
°©us
 =
IWL_SCAN_OFFLOAD_COMPLETED
 ?

3192 
	`iwl_mvm_ebs_°©us_°r
(
nŸif
->
ebs_°©us
));

3193 
	`IWL_DEBUG_SCAN
(
mvm
,

3195 
nŸif
->
œ°_scheduÀ
,ÇŸif->
œ°_ôî
,

3196 
	`__À32_to_˝u
(
nŸif
->
time_‰om_œ°_ôî
));

3198 i‡(
nŸif
->
ebs_°©us
 !
IWL_SCAN_EBS_SUCCESS
 &&

3199 
nŸif
->
ebs_°©us
 !
IWL_SCAN_EBS_INACTIVE
)

3200 
mvm
->
œ°_ebs_suc˚ssful
 = 
Ál£
;

3202 
mvm
->
sˇn_uid_°©us
[
uid
] = 0;

3203 
	}
}

3205 
	$iwl_mvm_rx_umac_sˇn_ôî_com∂ëe_nŸif
(
iwl_mvm
 *
mvm
,

3206 
iwl_rx_cmd_buf„r
 *
rxb
)

3208 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

3209 
iwl_umac_sˇn_ôî_com∂ëe_nŸif
 *
nŸif
 = (*)
pkt
->
d©a
;

3211 
mvm
->
sˇn_°¨t
 = 
	`À64_to_˝u
(
nŸif
->
°¨t_tsf
);

3213 
	`IWL_DEBUG_SCAN
(
mvm
,

3215 
nŸif
->
°©us
,ÇŸif->
sˇ¬ed_ch™√ls
);

3217 i‡(
mvm
->
sched_sˇn_∑ss_Æl
 =
SCHED_SCAN_PASS_ALL_FOUND
) {

3218 
	`IWL_DEBUG_SCAN
(
mvm
, "Passáll scheduled scanÑesults found\n");

3219 
	`õì80211_sched_sˇn_ªsu…s
(
mvm
->
hw
);

3220 
mvm
->
sched_sˇn_∑ss_Æl
 = 
SCHED_SCAN_PASS_ALL_ENABLED
;

3223 
	`IWL_DEBUG_SCAN
(
mvm
,

3225 
mvm
->
sˇn_°¨t
);

3226 
	}
}

3228 
	$iwl_mvm_umac_sˇn_ab‹t
(
iwl_mvm
 *
mvm
, 
ty≥
)

3230 
iwl_umac_sˇn_ab‹t
 
cmd
 = {};

3231 
uid
, 
ªt
;

3233 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

3239 
uid
 = 
	`iwl_mvm_sˇn_uid_by_°©us
(
mvm
, 
ty≥
);

3240 i‡(
	`WARN_ON_ONCE
(
uid
 < 0))

3241  
uid
;

3243 
cmd
.
uid
 = 
	`˝u_to_À32
(uid);

3245 
	`IWL_DEBUG_SCAN
(
mvm
, "Sídög sˇ¿ab‹t, uid %u\n", 
uid
);

3247 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
,

3248 
	`WIDE_ID
(
IWL_ALWAYS_LONG_GROUP
, 
SCAN_ABORT_UMAC
),

3249 0, (
cmd
), &cmd);

3250 i‡(!
ªt
)

3251 
mvm
->
sˇn_uid_°©us
[
uid
] = 
ty≥
 << 
IWL_MVM_SCAN_STOPPING_SHIFT
;

3253  
ªt
;

3254 
	}
}

3256 
	$iwl_mvm_sˇn_°›_waô
(
iwl_mvm
 *
mvm
, 
ty≥
)

3258 
iwl_nŸifiˇti⁄_waô
 
waô_sˇn_d⁄e
;

3259 c⁄° 
u16
 
sˇn_d⁄e_nŸif
[] = { 
SCAN_COMPLETE_UMAC
,

3260 
SCAN_OFFLOAD_COMPLETE
, };

3261 
ªt
;

3263 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

3265 
	`iwl_öô_nŸifiˇti⁄_waô
(&
mvm
->
nŸif_waô
, &
waô_sˇn_d⁄e
,

3266 
sˇn_d⁄e_nŸif
,

3267 
	`ARRAY_SIZE
(
sˇn_d⁄e_nŸif
),

3268 
NULL
, NULL);

3270 
	`IWL_DEBUG_SCAN
(
mvm
, "Pª∑rögÅÿ°› sˇn,Åy≥ %x\n", 
ty≥
);

3272 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_CAPA_UMAC_SCAN
))

3273 
ªt
 = 
	`iwl_mvm_umac_sˇn_ab‹t
(
mvm
, 
ty≥
);

3275 
ªt
 = 
	`iwl_mvm_lmac_sˇn_ab‹t
(
mvm
);

3277 i‡(
ªt
) {

3278 
	`IWL_DEBUG_SCAN
(
mvm
, "couldn'à°› sˇ¿ty≥ %d\n", 
ty≥
);

3279 
	`iwl_ªmove_nŸifiˇti⁄
(&
mvm
->
nŸif_waô
, &
waô_sˇn_d⁄e
);

3280  
ªt
;

3283  
	`iwl_waô_nŸifiˇti⁄
(&
mvm
->
nŸif_waô
, &
waô_sˇn_d⁄e
,

3284 1 * 
HZ
);

3285 
	}
}

3287 
size_t
 
	$iwl_sˇn_ªq_umac_gë_size
(
u8
 
sˇn_vî
)

3289 
sˇn_vî
) {

3291  (
iwl_sˇn_ªq_umac_v12
);

3296  (
iwl_sˇn_ªq_umac_v17
);

3300 
	}
}

3302 
size_t
 
	$iwl_mvm_sˇn_size
(
iwl_mvm
 *
mvm
)

3304 
ba£_size
, 
èû_size
;

3305 
u8
 
sˇn_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
SCAN_REQ_UMAC
,

3306 
IWL_FW_CMD_VER_UNKNOWN
);

3308 
ba£_size
 = 
	`iwl_sˇn_ªq_umac_gë_size
(
sˇn_vî
);

3309 i‡(
ba£_size
)

3310  
ba£_size
;

3313 i‡(
	`iwl_mvm_is_ad≠tive_dwñl_v2_suµ‹ãd
(
mvm
))

3314 
ba£_size
 = 
IWL_SCAN_REQ_UMAC_SIZE_V8
;

3315 i‡(
	`iwl_mvm_is_ad≠tive_dwñl_suµ‹ãd
(
mvm
))

3316 
ba£_size
 = 
IWL_SCAN_REQ_UMAC_SIZE_V7
;

3317 i‡(
	`iwl_mvm_cdb_sˇn_≠i
(
mvm
))

3318 
ba£_size
 = 
IWL_SCAN_REQ_UMAC_SIZE_V6
;

3320 
ba£_size
 = 
IWL_SCAN_REQ_UMAC_SIZE_V1
;

3322 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_CAPA_UMAC_SCAN
)) {

3323 i‡(
	`iwl_mvm_is_sˇn_ext_ch™_suµ‹ãd
(
mvm
))

3324 
èû_size
 = (
iwl_sˇn_ªq_umac_èû_v2
);

3326 
èû_size
 = (
iwl_sˇn_ªq_umac_èû_v1
);

3328  
ba£_size
 +

3329 (
iwl_sˇn_ch™√l_cfg_umac
) *

3330 
mvm
->
fw
->
ucode_ˇ∑
.
n_sˇn_ch™√ls
 +

3331 
èû_size
;

3333  (
iwl_sˇn_ªq_lmac
) +

3334 (
iwl_sˇn_ch™√l_cfg_lmac
) *

3335 
mvm
->
fw
->
ucode_ˇ∑
.
n_sˇn_ch™√ls
 +

3336 (
iwl_sˇn_¥obe_ªq_v1
);

3337 
	}
}

3343 
	$iwl_mvm_ªp‹t_sˇn_ab‹ãd
(
iwl_mvm
 *
mvm
)

3345 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_CAPA_UMAC_SCAN
)) {

3346 
uid
, 
i
;

3348 
uid
 = 
	`iwl_mvm_sˇn_uid_by_°©us
(
mvm
, 
IWL_MVM_SCAN_REGULAR
);

3349 i‡(
uid
 >= 0) {

3350 
cfg80211_sˇn_öfo
 
öfo
 = {

3351 .
ab‹ãd
 = 
åue
,

3354 
	`ˇn˚l_dñayed_w‹k
(&
mvm
->
sˇn_timeout_dw‹k
);

3356 
	`õì80211_sˇn_com∂ëed
(
mvm
->
hw
, &
öfo
);

3357 
mvm
->
sˇn_uid_°©us
[
uid
] = 0;

3359 
uid
 = 
	`iwl_mvm_sˇn_uid_by_°©us
(
mvm
, 
IWL_MVM_SCAN_SCHED
);

3360 i‡(
uid
 >= 0) {

3365 i‡(!
mvm
->
fw_ª°¨t
)

3366 
	`õì80211_sched_sˇn_°›≥d
(
mvm
->
hw
);

3367 
mvm
->
sched_sˇn_∑ss_Æl
 = 
SCHED_SCAN_PASS_ALL_DISABLED
;

3368 
mvm
->
sˇn_uid_°©us
[
uid
] = 0;

3370 
uid
 = 
	`iwl_mvm_sˇn_uid_by_°©us
(
mvm
,

3371 
IWL_MVM_SCAN_STOPPING_REGULAR
);

3372 i‡(
uid
 >= 0)

3373 
mvm
->
sˇn_uid_°©us
[
uid
] = 0;

3375 
uid
 = 
	`iwl_mvm_sˇn_uid_by_°©us
(
mvm
,

3376 
IWL_MVM_SCAN_STOPPING_SCHED
);

3377 i‡(
uid
 >= 0)

3378 
mvm
->
sˇn_uid_°©us
[
uid
] = 0;

3384 
i
 = 0; i < 
mvm
->
max_sˇns
; i++) {

3385 i‡(
	`WARN_ONCE
(
mvm
->
sˇn_uid_°©us
[
i
],

3387 
i
))

3388 
mvm
->
sˇn_uid_°©us
[
i
] = 0;

3391 i‡(
mvm
->
sˇn_°©us
 & 
IWL_MVM_SCAN_REGULAR
) {

3392 
cfg80211_sˇn_öfo
 
öfo
 = {

3393 .
ab‹ãd
 = 
åue
,

3396 
	`ˇn˚l_dñayed_w‹k
(&
mvm
->
sˇn_timeout_dw‹k
);

3397 
	`õì80211_sˇn_com∂ëed
(
mvm
->
hw
, &
öfo
);

3404 i‡((
mvm
->
sˇn_°©us
 & 
IWL_MVM_SCAN_SCHED
) &&

3405 !
mvm
->
fw_ª°¨t
) {

3406 
	`õì80211_sched_sˇn_°›≥d
(
mvm
->
hw
);

3407 
mvm
->
sched_sˇn_∑ss_Æl
 = 
SCHED_SCAN_PASS_ALL_DISABLED
;

3410 
	}
}

3412 
	$iwl_mvm_sˇn_°›
(
iwl_mvm
 *
mvm
, 
ty≥
, 
boﬁ
 
nŸify
)

3414 
ªt
;

3416 i‡(!(
mvm
->
sˇn_°©us
 & 
ty≥
))

3419 i‡(!
	`ã°_bô
(
STATUS_DEVICE_ENABLED
, &
mvm
->
å™s
->
°©us
)) {

3420 
ªt
 = 0;

3421 
out
;

3424 
ªt
 = 
	`iwl_mvm_sˇn_°›_waô
(
mvm
, 
ty≥
);

3425 i‡(!
ªt
)

3426 
mvm
->
sˇn_°©us
 |
ty≥
 << 
IWL_MVM_SCAN_STOPPING_SHIFT
;

3427 
out
:

3433 
mvm
->
sˇn_°©us
 &~
ty≥
;

3435 i‡(
ty≥
 =
IWL_MVM_SCAN_REGULAR
) {

3436 
	`ˇn˚l_dñayed_w‹k
(&
mvm
->
sˇn_timeout_dw‹k
);

3437 i‡(
nŸify
) {

3438 
cfg80211_sˇn_öfo
 
öfo
 = {

3439 .
ab‹ãd
 = 
åue
,

3442 
	`õì80211_sˇn_com∂ëed
(
mvm
->
hw
, &
öfo
);

3444 } i‡(
nŸify
) {

3445 
	`õì80211_sched_sˇn_°›≥d
(
mvm
->
hw
);

3446 
mvm
->
sched_sˇn_∑ss_Æl
 = 
SCHED_SCAN_PASS_ALL_DISABLED
;

3449  
ªt
;

3450 
	}
}

	@sf.c

6 
	~"mvm.h
"

9 
	siwl_mvm_a˘ive_iÁ˚_ôî©‹_d©a
 {

10 
õì80211_vif
 *
	mign‹e_vif
;

11 
õì80211_°a
 *
	m°a_vif_≠_°a
;

12 
iwl_sf_°©e
 
	m°a_vif_°©e
;

13 
u32
 
	mnum_a˘ive_macs
;

20 
	$iwl_mvm_bound_iÁ˚_ôî©‹
(*
_d©a
, 
u8
 *
mac
,

21 
õì80211_vif
 *
vif
)

23 
iwl_mvm_a˘ive_iÁ˚_ôî©‹_d©a
 *
d©a
 = 
_d©a
;

24 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

26 i‡(
vif
 =
d©a
->
ign‹e_vif
 || !
mvmvif
->
deÊök
.
phy_˘xt
 ||

27 
vif
->
ty≥
 =
NL80211_IFTYPE_P2P_DEVICE
)

30 
d©a
->
num_a˘ive_macs
++;

32 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
) {

33 
d©a
->
°a_vif_≠_°a
 = 
mvmvif
->
≠_°a
;

34 i‡(
vif
->
cfg
.
assoc
)

35 
d©a
->
°a_vif_°©e
 = 
SF_FULL_ON
;

37 
d©a
->
°a_vif_°©e
 = 
SF_INIT_OFF
;

39 
	}
}

46 
__À32
 
	gsf_fuŒ_timeout_def
[
SF_NUM_SCENARIO
][
SF_NUM_TIMEOUT_TYPES
] = {

48 
˝u_to_À32
(
SF_SINGLE_UNICAST_AGING_TIMER_DEF
),

49 
˝u_to_À32
(
SF_SINGLE_UNICAST_IDLE_TIMER_DEF
)

52 
˝u_to_À32
(
SF_AGG_UNICAST_AGING_TIMER_DEF
),

53 
˝u_to_À32
(
SF_AGG_UNICAST_IDLE_TIMER_DEF
)

56 
˝u_to_À32
(
SF_MCAST_AGING_TIMER_DEF
),

57 
˝u_to_À32
(
SF_MCAST_IDLE_TIMER_DEF
)

60 
˝u_to_À32
(
SF_BA_AGING_TIMER_DEF
),

61 
˝u_to_À32
(
SF_BA_IDLE_TIMER_DEF
)

64 
˝u_to_À32
(
SF_TX_RE_AGING_TIMER_DEF
),

65 
˝u_to_À32
(
SF_TX_RE_IDLE_TIMER_DEF
)

73 c⁄° 
__À32
 
	gsf_fuŒ_timeout
[
SF_NUM_SCENARIO
][
SF_NUM_TIMEOUT_TYPES
] = {

75 
˝u_to_À32
(
SF_SINGLE_UNICAST_AGING_TIMER
),

76 
˝u_to_À32
(
SF_SINGLE_UNICAST_IDLE_TIMER
)

79 
˝u_to_À32
(
SF_AGG_UNICAST_AGING_TIMER
),

80 
˝u_to_À32
(
SF_AGG_UNICAST_IDLE_TIMER
)

83 
˝u_to_À32
(
SF_MCAST_AGING_TIMER
),

84 
˝u_to_À32
(
SF_MCAST_IDLE_TIMER
)

87 
˝u_to_À32
(
SF_BA_AGING_TIMER
),

88 
˝u_to_À32
(
SF_BA_IDLE_TIMER
)

91 
˝u_to_À32
(
SF_TX_RE_AGING_TIMER
),

92 
˝u_to_À32
(
SF_TX_RE_IDLE_TIMER
)

96 
	$iwl_mvm_fûl_sf_comm™d
(
iwl_mvm
 *
mvm
,

97 
iwl_sf_cfg_cmd
 *
sf_cmd
,

98 
õì80211_°a
 *
°a
)

100 
i
, 
j
, 
w©îm¨k
;

101 
u8
 
max_rx_nss
 = 0;

102 
boﬁ
 
is_Àgacy
 = 
åue
;

103 
õì80211_lök_°a
 *
lök_°a
;

104 
lök_id
;

106 
sf_cmd
->
w©îm¨k
[
SF_LONG_DELAY_ON
] = 
	`˝u_to_À32
(
SF_W_MARK_SCAN
);

112 i‡(
°a
) {

114 
	`rcu_ªad_lock
();

115 
lök_id
 = 0;Üök_id < 
	`ARRAY_SIZE
(
°a
->
lök
);Üink_id++) {

116 
lök_°a
 = 
	`rcu_dîe„ªn˚
(
°a
->
lök
[
lök_id
]);

117 i‡(!
lök_°a
)

120 i‡(
lök_°a
->
ht_ˇp
.
ht_suµ‹ãd
 ||

121 
lök_°a
->
vht_ˇp
.
vht_suµ‹ãd
 ||

122 
lök_°a
->
eht_ˇp
.
has_eht
 ||

123 
lök_°a
->
he_ˇp
.
has_he
) {

124 
is_Àgacy
 = 
Ál£
;

125 
max_rx_nss
 = 
	`max
(max_rx_nss, 
lök_°a
->
rx_nss
);

128 
	`rcu_ªad_u∆ock
();

130 i‡(!
is_Àgacy
) {

131 
max_rx_nss
) {

133 
w©îm¨k
 = 
SF_W_MARK_SISO
;

136 
w©îm¨k
 = 
SF_W_MARK_MIMO2
;

139 
w©îm¨k
 = 
SF_W_MARK_MIMO3
;

143 
w©îm¨k
 = 
SF_W_MARK_LEGACY
;

147 
w©îm¨k
 = 
SF_W_MARK_MIMO2
;

149 
sf_cmd
->
w©îm¨k
[
SF_FULL_ON
] = 
	`˝u_to_À32
(watermark);

151 
i
 = 0; i < 
SF_NUM_SCENARIO
; i++) {

152 
j
 = 0; j < 
SF_NUM_TIMEOUT_TYPES
; j++) {

153 
sf_cmd
->
l⁄g_dñay_timeouts
[
i
][
j
] =

154 
	`˝u_to_À32
(
SF_LONG_DELAY_AGING_TIMER
);

158 i‡(
°a
) {

159 
	`BUILD_BUG_ON
((
sf_fuŒ_timeout
) !=

160 (
__À32
Ë* 
SF_NUM_SCENARIO
 *

161 
SF_NUM_TIMEOUT_TYPES
);

163 
	`mem˝y
(
sf_cmd
->
fuŒ_⁄_timeouts
, 
sf_fuŒ_timeout
,

164 (
sf_fuŒ_timeout
));

166 
	`BUILD_BUG_ON
((
sf_fuŒ_timeout_def
) !=

167 (
__À32
Ë* 
SF_NUM_SCENARIO
 *

168 
SF_NUM_TIMEOUT_TYPES
);

170 
	`mem˝y
(
sf_cmd
->
fuŒ_⁄_timeouts
, 
sf_fuŒ_timeout_def
,

171 (
sf_fuŒ_timeout_def
));

173 
	}
}

175 
	$iwl_mvm_sf_c⁄fig
(
iwl_mvm
 *
mvm
, 
õì80211_°a
 *
°a
,

176 
iwl_sf_°©e
 
√w_°©e
)

178 
iwl_sf_cfg_cmd
 
sf_cmd
 = {

179 .
°©e
 = 
	`˝u_to_À32
(
√w_°©e
),

181 
ªt
 = 0;

187 i‡(
√w_°©e
 !
SF_FULL_ON
 && 
mvm
->
sf_°©e
 ==Çew_state)

190 
√w_°©e
) {

191 
SF_UNINIT
:

192 
	`iwl_mvm_fûl_sf_comm™d
(
mvm
, &
sf_cmd
, 
NULL
);

194 
SF_FULL_ON
:

195 i‡(!
°a
) {

196 
	`IWL_ERR
(
mvm
,

198  -
EINVAL
;

200 
	`iwl_mvm_fûl_sf_comm™d
(
mvm
, &
sf_cmd
, 
°a
);

202 
SF_INIT_OFF
:

203 
	`iwl_mvm_fûl_sf_comm™d
(
mvm
, &
sf_cmd
, 
NULL
);

206 
	`WARN_ONCE
(1, "Invalid state: %d.Çot sending Smart Fifo cmd\n",

207 
√w_°©e
);

208  -
EINVAL
;

211 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
REPLY_SF_CFG_CMD
, 
CMD_ASYNC
,

212 (
sf_cmd
), &sf_cmd);

213 i‡(!
ªt
)

214 
mvm
->
sf_°©e
 = 
√w_°©e
;

216  
ªt
;

217 
	}
}

224 
	$iwl_mvm_sf_upd©e
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
ch™ged_vif
,

225 
boﬁ
 
ªmove_vif
)

227 
iwl_sf_°©e
 
√w_°©e
;

228 
iwl_mvm_vif
 *
mvmvif
 = 
NULL
;

229 
iwl_mvm_a˘ive_iÁ˚_ôî©‹_d©a
 
d©a
 = {

230 .
ign‹e_vif
 = 
ch™ged_vif
,

231 .
°a_vif_°©e
 = 
SF_UNINIT
,

233 
õì80211_°a
 *
°a
 = 
NULL
;

235 i‡(
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

236 
IWL_UCODE_TLV_API_SMART_FIFO_OFFLOAD
))

242 i‡(
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
) ||

243 (
ch™ged_vif
 && ch™ged_vif->
ty≥
 =
NL80211_IFTYPE_P2P_DEVICE
))

246 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s_©omic
(
mvm
->
hw
,

247 
IEEE80211_IFACE_ITER_NORMAL
,

248 
iwl_mvm_bound_iÁ˚_ôî©‹
,

249 &
d©a
);

252 i‡(
ch™ged_vif
 && !
ªmove_vif
)

253 
d©a
.
num_a˘ive_macs
++;

255 
d©a
.
num_a˘ive_macs
) {

258 
√w_°©e
 = 
SF_INIT_OFF
;

261 i‡(
ªmove_vif
) {

265 
√w_°©e
 = 
d©a
.
°a_vif_°©e
;

266 
°a
 = 
d©a
.
°a_vif_≠_°a
;

268 i‡(
	`WARN_ON
(!
ch™ged_vif
))

269  -
EINVAL
;

270 i‡(
ch™ged_vif
->
ty≥
 !
NL80211_IFTYPE_STATION
) {

271 
√w_°©e
 = 
SF_UNINIT
;

272 } i‡(
ch™ged_vif
->
cfg
.
assoc
 &&

273 
ch™ged_vif
->
bss_c⁄f
.
dtim_≥riod
) {

274 
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
ch™ged_vif
);

275 
°a
 = 
mvmvif
->
≠_°a
;

276 
√w_°©e
 = 
SF_FULL_ON
;

278 
√w_°©e
 = 
SF_INIT_OFF
;

284 
√w_°©e
 = 
SF_UNINIT
;

287  
	`iwl_mvm_sf_c⁄fig
(
mvm
, 
°a
, 
√w_°©e
);

288 
	}
}

	@sta.c

7 
	~<√t/mac80211.h
>

9 
	~"mvm.h
"

10 
	~"°a.h
"

11 
	~"rs.h
"

18 
ölöe
 
	$iwl_mvm_add_°a_cmd_size
(
iwl_mvm
 *
mvm
)

20 i‡(
	`iwl_mvm_has_√w_rx_≠i
(
mvm
) ||

21 
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_API_STA_TYPE
))

22  (
iwl_mvm_add_°a_cmd
);

24  (
iwl_mvm_add_°a_cmd_v7
);

25 
	}
}

27 
	$iwl_mvm_föd_‰ì_°a_id
(
iwl_mvm
 *
mvm
, 
∆80211_i·y≥
 
i·y≥
)

29 
°a_id
;

30 
u32
 
ª£rved_ids
 = 0;

32 
	`BUILD_BUG_ON
(
IWL_MVM_STATION_COUNT_MAX
 > 32);

33 
	`WARN_ON_ONCE
(
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
));

35 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

38 i‡(
i·y≥
 !
NL80211_IFTYPE_STATION
)

39 
ª£rved_ids
 = 
	`BIT
(0);

42 
°a_id
 = 0; sè_id < 
mvm
->
fw
->
ucode_ˇ∑
.
num_°©i⁄s
; sta_id++) {

43 i‡(
	`BIT
(
°a_id
Ë& 
ª£rved_ids
)

46 i‡(!
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm
->
fw_id_to_mac_id
[
°a_id
],

47 
	`lockdï_is_hñd
(&
mvm
->
muãx
)))

48  
°a_id
;

50  
IWL_MVM_INVALID_STA
;

51 
	}
}

54 
u32
 
	$iwl_mvm_gë_°a_ampdu_dís
(
õì80211_lök_°a
 *
lök_°a
,

55 
õì80211_bss_c⁄f
 *
lök_c⁄f
,

56 
u32
 *
_agg_size
)

58 
u32
 
agg_size
 = 0, 
mpdu_dís
 = 0;

60 i‡(
	`WARN_ON
(!
lök_°a
))

69 i‡(
lök_°a
->
ht_ˇp
.
ht_suµ‹ãd
) {

70 
agg_size
 = 
lök_°a
->
ht_ˇp
.
ampdu_Á˘‹
;

71 
mpdu_dís
 = 
lök_°a
->
ht_ˇp
.
ampdu_dísôy
;

74 i‡(
lök_c⁄f
->
ch™ªq
.
›î
.
ch™
->
b™d
 =
NL80211_BAND_6GHZ
) {

76 
mpdu_dís
 = 
	`À16_gë_bôs
(
lök_°a
->
he_6ghz_ˇ∑
.
ˇ∑
,

77 
IEEE80211_HE_6GHZ_CAP_MIN_MPDU_START
);

78 
agg_size
 = 
	`À16_gë_bôs
(
lök_°a
->
he_6ghz_ˇ∑
.
ˇ∑
,

79 
IEEE80211_HE_6GHZ_CAP_MAX_AMPDU_LEN_EXP
);

80 } i‡(
lök_°a
->
vht_ˇp
.
vht_suµ‹ãd
) {

82 
agg_size
 = 
	`u32_gë_bôs
(
lök_°a
->
vht_ˇp
.
ˇp
,

83 
IEEE80211_VHT_CAP_MAX_A_MPDU_LENGTH_EXPONENT_MASK
);

94 i‡(
lök_°a
->
he_ˇp
.
has_he
)

95 
agg_size
 +=

96 
	`u8_gë_bôs
(
lök_°a
->
he_ˇp
.
he_ˇp_ñem
.
mac_ˇp_öfo
[3],

97 
IEEE80211_HE_MAC_CAP3_MAX_AMPDU_LEN_EXP_MASK
);

99 i‡(
lök_°a
->
eht_ˇp
.
has_eht
)

100 
agg_size
 +
	`u8_gë_bôs
(
lök_°a
->
eht_ˇp
.
eht_ˇp_ñem
.
mac_ˇp_öfo
[1],

101 
IEEE80211_EHT_MAC_CAP1_MAX_AMPDU_LEN_MASK
);

104 
agg_size
 = 
	`mö_t
(
u32
,ágg_size,

105 
STA_FLG_MAX_AGG_SIZE_4M
 >> 
STA_FLG_MAX_AGG_SIZE_SHIFT
);

107 *
_agg_size
 = 
agg_size
;

108  
mpdu_dís
;

109 
	}
}

111 
u8
 
	$iwl_mvm_gë_°a_u≠sd_acs
(
õì80211_°a
 *
°a
)

113 
u8
 
u≠sd_acs
 = 0;

115 i‡(
°a
->
u≠sd_queues
 & 
IEEE80211_WMM_IE_STA_QOSINFO_AC_BK
)

116 
u≠sd_acs
 |
	`BIT
(
AC_BK
);

117 i‡(
°a
->
u≠sd_queues
 & 
IEEE80211_WMM_IE_STA_QOSINFO_AC_BE
)

118 
u≠sd_acs
 |
	`BIT
(
AC_BE
);

119 i‡(
°a
->
u≠sd_queues
 & 
IEEE80211_WMM_IE_STA_QOSINFO_AC_VI
)

120 
u≠sd_acs
 |
	`BIT
(
AC_VI
);

121 i‡(
°a
->
u≠sd_queues
 & 
IEEE80211_WMM_IE_STA_QOSINFO_AC_VO
)

122 
u≠sd_acs
 |
	`BIT
(
AC_VO
);

124  
u≠sd_acs
 | uapsd_acs << 4;

125 
	}
}

128 
	$iwl_mvm_°a_£nd_to_fw
(
iwl_mvm
 *
mvm
, 
õì80211_°a
 *
°a
,

129 
boﬁ
 
upd©e
, 
Êags
)

131 
iwl_mvm_°a
 *
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

132 
iwl_mvm_add_°a_cmd
 
add_°a_cmd
 = {

133 .
°a_id
 = 
mvm_°a
->
deÊök
.sta_id,

134 .
mac_id_n_cﬁ‹
 = 
	`˝u_to_À32
(
mvm_°a
->mac_id_n_color),

135 .
add_modify
 = 
upd©e
 ? 1 : 0,

136 .
°©i⁄_Êags_msk
 = 
	`˝u_to_À32
(
STA_FLG_FAT_EN_MSK
 |

137 
STA_FLG_MIMO_EN_MSK
 |

138 
STA_FLG_RTS_MIMO_PROT
),

139 .
tid_dißbÀ_tx
 = 
	`˝u_to_À16
(
mvm_°a
->
tid_dißbÀ_agg
),

141 
ªt
;

142 
u32
 
°©us
;

143 
u32
 
agg_size
 = 0, 
mpdu_dís
 = 0;

145 i‡(
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_API_STA_TYPE
))

146 
add_°a_cmd
.
°©i⁄_ty≥
 = 
mvm_°a
->
°a_ty≥
;

148 i‡(!
upd©e
 || (
Êags
 & 
STA_MODIFY_QUEUES
)) {

149 
	`mem˝y
(&
add_°a_cmd
.
addr
, 
°a
->addr, 
ETH_ALEN
);

151 i‡(!
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)) {

152 
add_°a_cmd
.
tfd_queue_msk
 =

153 
	`˝u_to_À32
(
mvm_°a
->
tfd_queue_msk
);

155 i‡(
Êags
 & 
STA_MODIFY_QUEUES
)

156 
add_°a_cmd
.
modify_mask
 |
STA_MODIFY_QUEUES
;

158 
	`WARN_ON
(
Êags
 & 
STA_MODIFY_QUEUES
);

162 
°a
->
deÊök
.
b™dwidth
) {

163 
IEEE80211_STA_RX_BW_320
:

164 
IEEE80211_STA_RX_BW_160
:

165 
add_°a_cmd
.
°©i⁄_Êags
 |
	`˝u_to_À32
(
STA_FLG_FAT_EN_160MHZ
);

166 
ÁŒthrough
;

167 
IEEE80211_STA_RX_BW_80
:

168 
add_°a_cmd
.
°©i⁄_Êags
 |
	`˝u_to_À32
(
STA_FLG_FAT_EN_80MHZ
);

169 
ÁŒthrough
;

170 
IEEE80211_STA_RX_BW_40
:

171 
add_°a_cmd
.
°©i⁄_Êags
 |
	`˝u_to_À32
(
STA_FLG_FAT_EN_40MHZ
);

172 
ÁŒthrough
;

173 
IEEE80211_STA_RX_BW_20
:

174 i‡(
°a
->
deÊök
.
ht_ˇp
.
ht_suµ‹ãd
)

175 
add_°a_cmd
.
°©i⁄_Êags
 |=

176 
	`˝u_to_À32
(
STA_FLG_FAT_EN_20MHZ
);

180 
°a
->
deÊök
.
rx_nss
) {

182 
add_°a_cmd
.
°©i⁄_Êags
 |
	`˝u_to_À32
(
STA_FLG_MIMO_EN_SISO
);

185 
add_°a_cmd
.
°©i⁄_Êags
 |
	`˝u_to_À32
(
STA_FLG_MIMO_EN_MIMO2
);

188 
add_°a_cmd
.
°©i⁄_Êags
 |
	`˝u_to_À32
(
STA_FLG_MIMO_EN_MIMO3
);

192 
°a
->
deÊök
.
smps_mode
) {

193 
IEEE80211_SMPS_AUTOMATIC
:

194 
IEEE80211_SMPS_NUM_MODES
:

195 
	`WARN_ON
(1);

197 
IEEE80211_SMPS_STATIC
:

199 
add_°a_cmd
.
°©i⁄_Êags
 &~
	`˝u_to_À32
(
STA_FLG_MIMO_EN_MSK
);

200 
add_°a_cmd
.
°©i⁄_Êags
 |
	`˝u_to_À32
(
STA_FLG_MIMO_EN_SISO
);

202 
IEEE80211_SMPS_DYNAMIC
:

203 
add_°a_cmd
.
°©i⁄_Êags
 |
	`˝u_to_À32
(
STA_FLG_RTS_MIMO_PROT
);

205 
IEEE80211_SMPS_OFF
:

210 i‡(
°a
->
deÊök
.
ht_ˇp
.
ht_suµ‹ãd
 ||

211 
mvm_°a
->
vif
->
bss_c⁄f
.
ch™ªq
.
›î
.
ch™
->
b™d
 =
NL80211_BAND_6GHZ
)

212 
add_°a_cmd
.
°©i⁄_Êags_msk
 |=

213 
	`˝u_to_À32
(
STA_FLG_MAX_AGG_SIZE_MSK
 |

214 
STA_FLG_AGG_MPDU_DENS_MSK
);

216 
mpdu_dís
 = 
	`iwl_mvm_gë_°a_ampdu_dís
(&
°a
->
deÊök
,

217 &
mvm_°a
->
vif
->
bss_c⁄f
,

218 &
agg_size
);

219 
add_°a_cmd
.
°©i⁄_Êags
 |=

220 
	`˝u_to_À32
(
agg_size
 << 
STA_FLG_MAX_AGG_SIZE_SHIFT
);

221 
add_°a_cmd
.
°©i⁄_Êags
 |=

222 
	`˝u_to_À32
(
mpdu_dís
 << 
STA_FLG_AGG_MPDU_DENS_SHIFT
);

224 i‡(
mvm_°a
->
°a_°©e
 >
IEEE80211_STA_ASSOC
)

225 
add_°a_cmd
.
assoc_id
 = 
	`˝u_to_À16
(
°a
->
aid
);

227 i‡(
°a
->
wme
) {

228 
add_°a_cmd
.
modify_mask
 |
STA_MODIFY_UAPSD_ACS
;

229 
add_°a_cmd
.
u≠sd_acs
 = 
	`iwl_mvm_gë_°a_u≠sd_acs
(
°a
);

230 
add_°a_cmd
.
•_Àngth
 = 
°a
->
max_•
 ? sta->max_sp * 2 : 128;

233 
°©us
 = 
ADD_STA_SUCCESS
;

234 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu_°©us
(
mvm
, 
ADD_STA
,

235 
	`iwl_mvm_add_°a_cmd_size
(
mvm
),

236 &
add_°a_cmd
, &
°©us
);

237 i‡(
ªt
)

238  
ªt
;

240 
°©us
 & 
IWL_ADD_STA_STATUS_MASK
) {

241 
ADD_STA_SUCCESS
:

242 
	`IWL_DEBUG_ASSOC
(
mvm
, "ADD_STA PASSED\n");

245 
ªt
 = -
EIO
;

246 
	`IWL_ERR
(
mvm
, "ADD_STA failed\n");

250  
ªt
;

251 
	}
}

253 
	$iwl_mvm_rx_agg_£ssi⁄_expúed
(
timî_li°
 *
t
)

255 
iwl_mvm_baid_d©a
 *
d©a
 =

256 
	`‰om_timî
(
d©a
, 
t
, 
£ssi⁄_timî
);

257 
iwl_mvm_baid_d©a
 
__rcu
 **
rcu_±r
 = 
d©a
->rcu_ptr;

258 
iwl_mvm_baid_d©a
 *
ba_d©a
;

259 
õì80211_°a
 *
°a
;

260 
iwl_mvm_°a
 *
mvm_°a
;

261 
timeout
;

262 
°a_id
;

264 
	`rcu_ªad_lock
();

266 
ba_d©a
 = 
	`rcu_dîe„ªn˚
(*
rcu_±r
);

268 i‡(
	`WARN_ON
(!
ba_d©a
))

269 
u∆ock
;

271 i‡(!
ba_d©a
->
timeout
)

272 
u∆ock
;

274 
timeout
 = 
ba_d©a
->
œ°_rx
 + 
	`TU_TO_JIFFIES
(ba_data->timeout * 2);

275 i‡(
	`time_is_a·î_jiffõs
(
timeout
)) {

276 
	`mod_timî
(&
ba_d©a
->
£ssi⁄_timî
, 
timeout
);

277 
u∆ock
;

281 
°a_id
 = 
	`ffs
(
ba_d©a
->
°a_mask
) - 1;

282 
°a
 = 
	`rcu_dîe„ªn˚
(
ba_d©a
->
mvm
->
fw_id_to_mac_id
[
°a_id
]);

292 i‡(
	`IS_ERR_OR_NULL
(
°a
))

293 
u∆ock
;

295 
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

296 
	`õì80211_rx_ba_timî_expúed
(
mvm_°a
->
vif
,

297 
°a
->
addr
, 
ba_d©a
->
tid
);

298 
u∆ock
:

299 
	`rcu_ªad_u∆ock
();

300 
	}
}

303 
	$iwl_mvm_övÆid©e_°a_queue
(
iwl_mvm
 *
mvm
, 
queue
,

304 
dißbÀ_agg_tids
,

305 
boﬁ
 
ªmove_queue
)

307 
iwl_mvm_add_°a_cmd
 
cmd
 = {};

308 
õì80211_°a
 *
°a
;

309 
iwl_mvm_°a
 *
mvm°a
;

310 
u32
 
°©us
;

311 
u8
 
°a_id
;

313 i‡(
	`WARN_ON
(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)))

314  -
EINVAL
;

316 
°a_id
 = 
mvm
->
queue_öfo
[
queue
].
ø_°a_id
;

318 
	`rcu_ªad_lock
();

320 
°a
 = 
	`rcu_dîe„ªn˚
(
mvm
->
fw_id_to_mac_id
[
°a_id
]);

322 i‡(
	`WARN_ON_ONCE
(
	`IS_ERR_OR_NULL
(
°a
))) {

323 
	`rcu_ªad_u∆ock
();

324  -
EINVAL
;

327 
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

329 
mvm°a
->
tid_dißbÀ_agg
 |
dißbÀ_agg_tids
;

331 
cmd
.
mac_id_n_cﬁ‹
 = 
	`˝u_to_À32
(
mvm°a
->mac_id_n_color);

332 
cmd
.
°a_id
 = 
mvm°a
->
deÊök
.sta_id;

333 
cmd
.
add_modify
 = 
STA_MODE_MODIFY
;

334 
cmd
.
modify_mask
 = 
STA_MODIFY_QUEUES
;

335 i‡(
dißbÀ_agg_tids
)

336 
cmd
.
modify_mask
 |
STA_MODIFY_TID_DISABLE_TX
;

337 i‡(
ªmove_queue
)

338 
cmd
.
modify_mask
 |
STA_MODIFY_QUEUE_REMOVAL
;

339 
cmd
.
tfd_queue_msk
 = 
	`˝u_to_À32
(
mvm°a
->tfd_queue_msk);

340 
cmd
.
tid_dißbÀ_tx
 = 
	`˝u_to_À16
(
mvm°a
->
tid_dißbÀ_agg
);

342 
	`rcu_ªad_u∆ock
();

345 
°©us
 = 
ADD_STA_SUCCESS
;

346  
	`iwl_mvm_£nd_cmd_pdu_°©us
(
mvm
, 
ADD_STA
,

347 
	`iwl_mvm_add_°a_cmd_size
(
mvm
),

348 &
cmd
, &
°©us
);

349 
	}
}

351 
	$iwl_mvm_dißbÀ_txq
(
iwl_mvm
 *
mvm
, 
õì80211_°a
 *
°a
,

352 
°a_id
, 
u16
 *
queuïå
, 
u8
 
tid
)

354 
queue
 = *
queuïå
;

355 
iwl_scd_txq_cfg_cmd
 
cmd
 = {

356 .
scd_queue
 = 
queue
,

357 .
a˘i⁄
 = 
SCD_CFG_DISABLE_QUEUE
,

359 
ªt
;

361 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

363 i‡(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)) {

364 i‡(
mvm
->
°a_ªmove_ªquúes_queue_ªmove
) {

365 
u32
 
cmd_id
 = 
	`WIDE_ID
(
DATA_PATH_GROUP
,

366 
SCD_QUEUE_CONFIG_CMD
);

367 
iwl_scd_queue_cfg_cmd
 
ªmove_cmd
 = {

368 .
›î©i⁄
 = 
	`˝u_to_À32
(
IWL_SCD_QUEUE_REMOVE
),

369 .
u
.
ªmove
.
°a_mask
 = 
	`˝u_to_À32
(
	`BIT
(
°a_id
)),

372 i‡(
tid
 =
IWL_MAX_TID_COUNT
)

373 
tid
 = 
IWL_MGMT_TID
;

375 
ªmove_cmd
.
u
.
ªmove
.
tid
 = 
	`˝u_to_À32
(tid);

377 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
cmd_id
, 0,

378 (
ªmove_cmd
),

379 &
ªmove_cmd
);

381 
ªt
 = 0;

384 
	`iwl_å™s_txq_‰ì
(
mvm
->
å™s
, 
queue
);

385 *
queuïå
 = 
IWL_MVM_INVALID_QUEUE
;

387  
ªt
;

390 i‡(
	`WARN_ON
(
mvm
->
queue_öfo
[
queue
].
tid_bôm≠
 == 0))

393 
mvm
->
queue_öfo
[
queue
].
tid_bôm≠
 &~
	`BIT
(
tid
);

395 
cmd
.
a˘i⁄
 = 
mvm
->
queue_öfo
[
queue
].
tid_bôm≠
 ?

396 
SCD_CFG_ENABLE_QUEUE
 : 
SCD_CFG_DISABLE_QUEUE
;

397 i‡(
cmd
.
a˘i⁄
 =
SCD_CFG_DISABLE_QUEUE
)

398 
mvm
->
queue_öfo
[
queue
].
°©us
 = 
IWL_MVM_QUEUE_FREE
;

400 
	`IWL_DEBUG_TX_QUEUES
(
mvm
,

402 
queue
,

403 
mvm
->
queue_öfo
[
queue
].
tid_bôm≠
);

406 i‡(
cmd
.
a˘i⁄
 =
SCD_CFG_ENABLE_QUEUE
)

409 
cmd
.
°a_id
 = 
mvm
->
queue_öfo
[
queue
].
ø_°a_id
;

410 
cmd
.
tid
 = 
mvm
->
queue_öfo
[
queue
].
txq_tid
;

413 
	`WARN
(
mvm
->
queue_öfo
[
queue
].
tid_bôm≠
,

415 
queue
, 
mvm
->
queue_öfo
[queue].
tid_bôm≠
);

418 
mvm
->
queue_öfo
[
queue
].
tid_bôm≠
 = 0;

420 i‡(
°a
) {

421 
iwl_mvm_txq
 *
mvmtxq
 =

422 
	`iwl_mvm_txq_‰om_tid
(
°a
, 
tid
);

424 
	`•ö_lock_bh
(&
mvm
->
add_°ªam_lock
);

425 
	`li°_dñ_öô
(&
mvmtxq
->
li°
);

426 
	`˛ór_bô
(
IWL_MVM_TXQ_STATE_READY
, &
mvmtxq
->
°©e
);

427 
mvmtxq
->
txq_id
 = 
IWL_MVM_INVALID_QUEUE
;

428 
	`•ö_u∆ock_bh
(&
mvm
->
add_°ªam_lock
);

432 
mvm
->
queue_öfo
[
queue
].
ª£rved
 = 
Ál£
;

434 
	`iwl_å™s_txq_dißbÀ
(
mvm
->
å™s
, 
queue
, 
Ál£
);

435 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
SCD_QUEUE_CFG
, 0,

436 (
iwl_scd_txq_cfg_cmd
), &
cmd
);

438 i‡(
ªt
)

439 
	`IWL_ERR
(
mvm
, "FailedÅo disable queue %d (ret=%d)\n",

440 
queue
, 
ªt
);

441  
ªt
;

442 
	}
}

444 
	$iwl_mvm_gë_queue_agg_tids
(
iwl_mvm
 *
mvm
, 
queue
)

446 
õì80211_°a
 *
°a
;

447 
iwl_mvm_°a
 *
mvm°a
;

448 
tid_bôm≠
;

449 
agg_tids
 = 0;

450 
u8
 
°a_id
;

451 
tid
;

453 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

455 i‡(
	`WARN_ON
(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)))

456  -
EINVAL
;

458 
°a_id
 = 
mvm
->
queue_öfo
[
queue
].
ø_°a_id
;

459 
tid_bôm≠
 = 
mvm
->
queue_öfo
[
queue
].tid_bitmap;

461 
°a
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm
->
fw_id_to_mac_id
[
°a_id
],

462 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

464 i‡(
	`WARN_ON_ONCE
(
	`IS_ERR_OR_NULL
(
°a
)))

465  -
EINVAL
;

467 
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

469 
	`•ö_lock_bh
(&
mvm°a
->
lock
);

470 
	`f‹_óch_£t_bô
(
tid
, &
tid_bôm≠
, 
IWL_MAX_TID_COUNT
 + 1) {

471 i‡(
mvm°a
->
tid_d©a
[
tid
].
°©e
 =
IWL_AGG_ON
)

472 
agg_tids
 |
	`BIT
(
tid
);

474 
	`•ö_u∆ock_bh
(&
mvm°a
->
lock
);

476  
agg_tids
;

477 
	}
}

484 
	$iwl_mvm_ªmove_°a_queue_m¨kög
(
iwl_mvm
 *
mvm
, 
queue
)

486 
õì80211_°a
 *
°a
;

487 
iwl_mvm_°a
 *
mvm°a
;

488 
tid_bôm≠
;

489 
dißbÀ_agg_tids
 = 0;

490 
u8
 
°a_id
;

491 
tid
;

493 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

495 i‡(
	`WARN_ON
(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)))

496  -
EINVAL
;

498 
°a_id
 = 
mvm
->
queue_öfo
[
queue
].
ø_°a_id
;

499 
tid_bôm≠
 = 
mvm
->
queue_öfo
[
queue
].tid_bitmap;

501 
	`rcu_ªad_lock
();

503 
°a
 = 
	`rcu_dîe„ªn˚
(
mvm
->
fw_id_to_mac_id
[
°a_id
]);

505 i‡(
	`WARN_ON_ONCE
(
	`IS_ERR_OR_NULL
(
°a
))) {

506 
	`rcu_ªad_u∆ock
();

510 
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

512 
	`•ö_lock_bh
(&
mvm°a
->
lock
);

514 
	`f‹_óch_£t_bô
(
tid
, &
tid_bôm≠
, 
IWL_MAX_TID_COUNT
 + 1) {

515 
iwl_mvm_txq
 *
mvmtxq
 =

516 
	`iwl_mvm_txq_‰om_tid
(
°a
, 
tid
);

518 i‡(
mvm°a
->
tid_d©a
[
tid
].
°©e
 =
IWL_AGG_ON
)

519 
dißbÀ_agg_tids
 |
	`BIT
(
tid
);

520 
mvm°a
->
tid_d©a
[
tid
].
txq_id
 = 
IWL_MVM_INVALID_QUEUE
;

522 
	`•ö_lock_bh
(&
mvm
->
add_°ªam_lock
);

523 
	`li°_dñ_öô
(&
mvmtxq
->
li°
);

524 
	`˛ór_bô
(
IWL_MVM_TXQ_STATE_READY
, &
mvmtxq
->
°©e
);

525 
mvmtxq
->
txq_id
 = 
IWL_MVM_INVALID_QUEUE
;

526 
	`•ö_u∆ock_bh
(&
mvm
->
add_°ªam_lock
);

529 
mvm°a
->
tfd_queue_msk
 &~
	`BIT
(
queue
);

530 
	`•ö_u∆ock_bh
(&
mvm°a
->
lock
);

532 
	`rcu_ªad_u∆ock
();

542 
	`synchr⁄ize_√t
();

544  
dißbÀ_agg_tids
;

545 
	}
}

547 
	$iwl_mvm_‰ì_öa˘ive_queue
(
iwl_mvm
 *
mvm
, 
queue
,

548 
õì80211_°a
 *
ﬁd_°a
,

549 
u8
 
√w_°a_id
)

551 
iwl_mvm_°a
 *
mvm°a
;

552 
u8
 
°a_id
, 
tid
;

553 
dißbÀ_agg_tids
 = 0;

554 
boﬁ
 
ßme_°a
;

555 
u16
 
queue_tmp
 = 
queue
;

556 
ªt
;

558 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

560 i‡(
	`WARN_ON
(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)))

561  -
EINVAL
;

563 
°a_id
 = 
mvm
->
queue_öfo
[
queue
].
ø_°a_id
;

564 
tid
 = 
mvm
->
queue_öfo
[
queue
].
txq_tid
;

566 
ßme_°a
 = 
°a_id
 =
√w_°a_id
;

568 
mvm°a
 = 
	`iwl_mvm_°a_‰om_°aid_¥Ÿe˘ed
(
mvm
, 
°a_id
);

569 i‡(
	`WARN_ON
(!
mvm°a
))

570  -
EINVAL
;

572 
dißbÀ_agg_tids
 = 
	`iwl_mvm_ªmove_°a_queue_m¨kög
(
mvm
, 
queue
);

574 i‡(
dißbÀ_agg_tids
)

575 
	`iwl_mvm_övÆid©e_°a_queue
(
mvm
, 
queue
,

576 
dißbÀ_agg_tids
, 
Ál£
);

578 
ªt
 = 
	`iwl_mvm_dißbÀ_txq
(
mvm
, 
ﬁd_°a
, 
°a_id
, &
queue_tmp
, 
tid
);

579 i‡(
ªt
) {

580 
	`IWL_ERR
(
mvm
,

582 
queue
, 
ªt
);

584  
ªt
;

588 i‡(!
ßme_°a
)

589 
	`iwl_mvm_övÆid©e_°a_queue
(
mvm
, 
queue
, 0, 
åue
);

592 
	}
}

594 
	$iwl_mvm_gë_sh¨ed_queue
(
iwl_mvm
 *
mvm
,

595 
tfd_queue_mask
, 
u8
 
ac
)

597 
queue
 = 0;

598 
u8
 
ac_to_queue
[
IEEE80211_NUM_ACS
];

599 
i
;

605 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

607 i‡(
	`WARN_ON
(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)))

608  -
EINVAL
;

610 
	`mem£t
(&
ac_to_queue
, 
IEEE80211_INVAL_HW_QUEUE
, (ac_to_queue));

613 
	`f‹_óch_£t_bô
(
i
, &
tfd_queue_mask
, 
IWL_MVM_DQA_MAX_DATA_QUEUE
) {

615 i‡(
i
 < 
IWL_MVM_DQA_MIN_DATA_QUEUE
 &&

616 
i
 !
IWL_MVM_DQA_BSS_CLIENT_QUEUE
)

619 
ac_to_queue
[
mvm
->
queue_öfo
[
i
].
mac80211_ac
] = i;

632 i‡(
ac_to_queue
[
IEEE80211_AC_BE
] !
IEEE80211_INVAL_HW_QUEUE
)

633 
queue
 = 
ac_to_queue
[
IEEE80211_AC_BE
];

635 i‡(
ac_to_queue
[
ac
] !
IEEE80211_INVAL_HW_QUEUE
)

636 
queue
 = 
ac_to_queue
[
ac
];

638 i‡(
ac
 =
IEEE80211_AC_VO
 &&

639 
ac_to_queue
[
IEEE80211_AC_VI
] !
IEEE80211_INVAL_HW_QUEUE
)

640 
queue
 = 
ac_to_queue
[
IEEE80211_AC_VI
];

642 i‡(
ac_to_queue
[
IEEE80211_AC_BK
] !
IEEE80211_INVAL_HW_QUEUE
)

643 
queue
 = 
ac_to_queue
[
IEEE80211_AC_BK
];

645 i‡(
ac_to_queue
[
IEEE80211_AC_VI
] !
IEEE80211_INVAL_HW_QUEUE
)

646 
queue
 = 
ac_to_queue
[
IEEE80211_AC_VI
];

648 i‡(
ac_to_queue
[
IEEE80211_AC_VO
] !
IEEE80211_INVAL_HW_QUEUE
)

649 
queue
 = 
ac_to_queue
[
IEEE80211_AC_VO
];

652 i‡(!
	`iwl_mvm_is_dqa_d©a_queue
(
mvm
, 
queue
) &&

653 !
	`iwl_mvm_is_dqa_mgmt_queue
(
mvm
, 
queue
) &&

654 (
queue
 !
IWL_MVM_DQA_BSS_CLIENT_QUEUE
)) {

655 
	`IWL_ERR
(
mvm
, "No DATA queuesávailableÅo share\n");

656  -
ENOSPC
;

659  
queue
;

660 
	}
}

663 
	$iwl_mvm_ªc⁄fig_scd
(
iwl_mvm
 *
mvm
, 
queue
, 
fifo
,

664 
°a_id
, 
tid
, 
‰ame_limô
, 
u16
 
s¢
)

666 
iwl_scd_txq_cfg_cmd
 
cmd
 = {

667 .
scd_queue
 = 
queue
,

668 .
a˘i⁄
 = 
SCD_CFG_ENABLE_QUEUE
,

669 .
wödow
 = 
‰ame_limô
,

670 .
°a_id
 = sta_id,

671 .
s¢
 = 
	`˝u_to_À16
(ssn),

672 .
tx_fifo
 = 
fifo
,

673 .
aggªg©e
 = (
queue
 >
IWL_MVM_DQA_MIN_DATA_QUEUE
 ||

674 
queue
 =
IWL_MVM_DQA_BSS_CLIENT_QUEUE
),

675 .
tid
 =Åid,

677 
ªt
;

679 i‡(
	`WARN_ON
(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)))

680  -
EINVAL
;

682 i‡(
	`WARN
(
mvm
->
queue_öfo
[
queue
].
tid_bôm≠
 == 0,

683 "TryögÅÿªc⁄fig u«Œoˇãd queuê%d\n", 
queue
))

684  -
ENXIO
;

686 
	`IWL_DEBUG_TX_QUEUES
(
mvm
, "Rec⁄fig SCD f‹ TXQ #%d\n", 
queue
);

688 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
SCD_QUEUE_CFG
, 0, (
cmd
), &cmd);

689 
	`WARN_ONCE
(
ªt
, "FailedÅoÑe-configure queue %d on FIFO %d,Ñet=%d\n",

690 
queue
, 
fifo
, 
ªt
);

692  
ªt
;

693 
	}
}

701 
	$iwl_mvm_ªdúe˘_queue
(
iwl_mvm
 *
mvm
, 
queue
, 
tid
,

702 
ac
, 
s¢
, 
wdg_timeout
,

703 
boﬁ
 
f‹˚
, 
iwl_mvm_txq
 *
txq
)

705 
iwl_scd_txq_cfg_cmd
 
cmd
 = {

706 .
scd_queue
 = 
queue
,

707 .
a˘i⁄
 = 
SCD_CFG_DISABLE_QUEUE
,

709 
boﬁ
 
sh¨ed_queue
;

710 
ªt
;

712 i‡(
	`WARN_ON
(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)))

713  -
EINVAL
;

723 i‡(
ac
 <
mvm
->
queue_öfo
[
queue
].
mac80211_ac
 && !
f‹˚
) {

724 
	`IWL_DEBUG_TX_QUEUES
(
mvm
,

726 
queue
);

730 
cmd
.
°a_id
 = 
mvm
->
queue_öfo
[
queue
].
ø_°a_id
;

731 
cmd
.
tx_fifo
 = 
iwl_mvm_ac_to_tx_fifo
[
mvm
->
queue_öfo
[
queue
].
mac80211_ac
];

732 
cmd
.
tid
 = 
mvm
->
queue_öfo
[
queue
].
txq_tid
;

733 
sh¨ed_queue
 = 
	`hweight16
(
mvm
->
queue_öfo
[
queue
].
tid_bôm≠
) > 1;

735 
	`IWL_DEBUG_TX_QUEUES
(
mvm
, "Redirecting TXQ #%dÅo FIFO #%d\n",

736 
queue
, 
iwl_mvm_ac_to_tx_fifo
[
ac
]);

739 
	`£t_bô
(
IWL_MVM_TXQ_STATE_STOP_REDIRECT
, &
txq
->
°©e
);

741 
ªt
 = 
	`iwl_å™s_waô_tx_queues_em±y
(
mvm
->
å™s
, 
	`BIT
(
queue
));

742 i‡(
ªt
) {

743 
	`IWL_ERR
(
mvm
, "Error draining queue %d beforeÑeconfig\n",

744 
queue
);

745 
ªt
 = -
EIO
;

746 
out
;

750 
	`iwl_å™s_txq_dißbÀ
(
mvm
->
å™s
, 
queue
, 
Ál£
);

751 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
SCD_QUEUE_CFG
, 0, (
cmd
), &cmd);

752 i‡(
ªt
)

753 
	`IWL_ERR
(
mvm
, "Faûed SCD dißbÀ TXQ %d (ªt=%d)\n", 
queue
,

754 
ªt
);

757 
	`iwl_å™s_txq_íabÀ_cfg
(
mvm
->
å™s
, 
queue
, 
s¢
, 
NULL
, 
wdg_timeout
);

760 
mvm
->
queue_öfo
[
queue
].
txq_tid
 = 
tid
;

765 
	`iwl_mvm_ªc⁄fig_scd
(
mvm
, 
queue
, 
iwl_mvm_ac_to_tx_fifo
[
ac
],

766 
cmd
.
°a_id
, 
tid
, 
IWL_FRAME_LIMIT
, 
s¢
);

769 
mvm
->
queue_öfo
[
queue
].
mac80211_ac
 = 
ac
;

777 i‡(
sh¨ed_queue
)

778 
	`iwl_å™s_txq_£t_sh¨ed_mode
(
mvm
->
å™s
, 
queue
, 
åue
);

780 
out
:

782 
	`˛ór_bô
(
IWL_MVM_TXQ_STATE_STOP_REDIRECT
, &
txq
->
°©e
);

784  
ªt
;

785 
	}
}

787 
	$iwl_mvm_föd_‰ì_queue
(
iwl_mvm
 *
mvm
, 
u8
 
°a_id
,

788 
u8
 
möq
, u8 
maxq
)

790 
i
;

792 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

794 i‡(
	`WARN
(
maxq
 >
mvm
->
å™s
->
å™s_cfg
->
ba£_∑øms
->
num_of_queues
,

795 "max queuê%d >num_of_queue†(%d)", 
maxq
,

796 
mvm
->
å™s
->
å™s_cfg
->
ba£_∑øms
->
num_of_queues
))

797 
maxq
 = 
mvm
->
å™s
->
å™s_cfg
->
ba£_∑øms
->
num_of_queues
 - 1;

800 i‡(
	`WARN_ON
(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)))

801  -
ENOSPC
;

804 
i
 = 
möq
; i <
maxq
; i++)

805 i‡(
mvm
->
queue_öfo
[
i
].
tid_bôm≠
 == 0 &&

806 
mvm
->
queue_öfo
[
i
].
°©us
 =
IWL_MVM_QUEUE_FREE
)

807  
i
;

809  -
ENOSPC
;

810 
	}
}

812 
	$iwl_mvm_gë_queue_size
(
õì80211_°a
 *
°a
)

814 
max_size
 = 
IWL_DEFAULT_QUEUE_SIZE
;

815 
lök_id
;

818 i‡(!
°a
)

819  
IWL_MGMT_QUEUE_SIZE
;

821 
	`rcu_ªad_lock
();

823 
lök_id
 = 0;Üök_id < 
	`ARRAY_SIZE
(
°a
->
lök
);Üink_id++) {

824 
õì80211_lök_°a
 *
lök
 =

825 
	`rcu_dîe„ªn˚
(
°a
->
lök
[
lök_id
]);

827 i‡(!
lök
)

831 i‡(
lök
->
eht_ˇp
.
has_eht
 &&

832 
max_size
 < 
IWL_DEFAULT_QUEUE_SIZE_EHT
)

833 
max_size
 = 
IWL_DEFAULT_QUEUE_SIZE_EHT
;

836 i‡(
lök
->
he_ˇp
.
has_he
 &&

837 
max_size
 < 
IWL_DEFAULT_QUEUE_SIZE_HE
)

838 
max_size
 = 
IWL_DEFAULT_QUEUE_SIZE_HE
;

841 
	`rcu_ªad_u∆ock
();

842  
max_size
;

843 
	}
}

845 
	$iwl_mvm_tvqm_íabÀ_txq
(
iwl_mvm
 *
mvm
,

846 
õì80211_°a
 *
°a
,

847 
u8
 
°a_id
, u8 
tid
, 
timeout
)

849 
queue
, 
size
;

850 
u32
 
°a_mask
 = 0;

852 i‡(
tid
 =
IWL_MAX_TID_COUNT
) {

853 
tid
 = 
IWL_MGMT_TID
;

854 
size
 = 
	`max_t
(
u32
, 
IWL_MGMT_QUEUE_SIZE
,

855 
mvm
->
å™s
->
cfg
->
mö_txq_size
);

857 
size
 = 
	`iwl_mvm_gë_queue_size
(
°a
);

861 
size
 = 
	`mö_t
(
u32
, size, 
mvm
->
å™s
->
txqs
.
bc_tbl_size
 / (
u16
));

864 
size
 = 
	`rounddown_pow_of_two
(size);

866 i‡(
°a
) {

867 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

868 
õì80211_lök_°a
 *
lök_°a
;

869 
lök_id
;

871 
	`rcu_ªad_lock
();

872 
	`f‹_óch_°a_a˘ive_lök
(
mvm°a
->
vif
, 
°a
, 
lök_°a
, 
lök_id
) {

873 
iwl_mvm_lök_°a
 *
lök
 =

874 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm°a
->
lök
[
lök_id
],

875 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

877 i‡(!
lök
)

880 
°a_mask
 |
	`BIT
(
lök
->
°a_id
);

882 
	`rcu_ªad_u∆ock
();

884 
°a_mask
 |
	`BIT
(
°a_id
);

887 i‡(!
°a_mask
)

888  -
EINVAL
;

891 
queue
 = 
	`iwl_å™s_txq_Æloc
(
mvm
->
å™s
, 0, 
°a_mask
,

892 
tid
, 
size
, 
timeout
);

894 i‡(
queue
 < 0)

895 
	`IWL_DEBUG_TX_QUEUES
(
mvm
,

897 
size
, 
°a_mask
, 
tid
, 
queue
);

898 
size
 /= 2;

899 } 
queue
 < 0 && 
size
 >= 16);

901 i‡(
queue
 < 0)

902  
queue
;

904 
	`IWL_DEBUG_TX_QUEUES
(
mvm
, "Enabling TXQ #%d for sta mask 0x%xÅid %d\n",

905 
queue
, 
°a_mask
, 
tid
);

907  
queue
;

908 
	}
}

910 
	$iwl_mvm_°a_Æloc_queue_tvqm
(
iwl_mvm
 *
mvm
,

911 
õì80211_°a
 *
°a
, 
u8
 
ac
,

912 
tid
)

914 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

915 
iwl_mvm_txq
 *
mvmtxq
 =

916 
	`iwl_mvm_txq_‰om_tid
(
°a
, 
tid
);

917 
wdg_timeout
 =

918 
	`iwl_mvm_gë_wd_timeout
(
mvm
, 
mvm°a
->
vif
, 
Ál£
, false);

919 
queue
 = -1;

921 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

923 
	`IWL_DEBUG_TX_QUEUES
(
mvm
,

925 
mvm°a
->
deÊök
.
°a_id
, 
tid
);

926 
queue
 = 
	`iwl_mvm_tvqm_íabÀ_txq
(
mvm
, 
°a
, 
mvm°a
->
deÊök
.
°a_id
,

927 
tid
, 
wdg_timeout
);

928 i‡(
queue
 < 0)

929  
queue
;

931 
mvmtxq
->
txq_id
 = 
queue
;

932 
mvm
->
tvqm_öfo
[
queue
].
txq_tid
 = 
tid
;

933 
mvm
->
tvqm_öfo
[
queue
].
°a_id
 = 
mvm°a
->
deÊök
.sta_id;

935 
	`IWL_DEBUG_TX_QUEUES
(
mvm
, "AŒoˇãd queuêi†%d\n", 
queue
);

937 
	`•ö_lock_bh
(&
mvm°a
->
lock
);

938 
mvm°a
->
tid_d©a
[
tid
].
txq_id
 = 
queue
;

939 
	`•ö_u∆ock_bh
(&
mvm°a
->
lock
);

942 
	}
}

944 
boﬁ
 
	$iwl_mvm_upd©e_txq_m≠pög
(
iwl_mvm
 *
mvm
,

945 
õì80211_°a
 *
°a
,

946 
queue
, 
u8
 
°a_id
, u8 
tid
)

948 
boﬁ
 
íabÀ_queue
 = 
åue
;

951 i‡(
mvm
->
queue_öfo
[
queue
].
tid_bôm≠
 & 
	`BIT
(
tid
)) {

952 
	`IWL_ERR
(
mvm
, "TryingÅoÉnable TXQ %d withÉxisting TID %d\n",

953 
queue
, 
tid
);

954  
Ál£
;

958 i‡(
mvm
->
queue_öfo
[
queue
].
tid_bôm≠
)

959 
íabÀ_queue
 = 
Ál£
;

961 
mvm
->
queue_öfo
[
queue
].
tid_bôm≠
 |
	`BIT
(
tid
);

962 
mvm
->
queue_öfo
[
queue
].
ø_°a_id
 = 
°a_id
;

964 i‡(
íabÀ_queue
) {

965 i‡(
tid
 !
IWL_MAX_TID_COUNT
)

966 
mvm
->
queue_öfo
[
queue
].
mac80211_ac
 =

967 
tid_to_mac80211_ac
[
tid
];

969 
mvm
->
queue_öfo
[
queue
].
mac80211_ac
 = 
IEEE80211_AC_VO
;

971 
mvm
->
queue_öfo
[
queue
].
txq_tid
 = 
tid
;

974 i‡(
°a
) {

975 
iwl_mvm_txq
 *
mvmtxq
 =

976 
	`iwl_mvm_txq_‰om_tid
(
°a
, 
tid
);

978 
mvmtxq
->
txq_id
 = 
queue
;

981 
	`IWL_DEBUG_TX_QUEUES
(
mvm
,

983 
queue
, 
mvm
->
queue_öfo
[queue].
tid_bôm≠
);

985  
íabÀ_queue
;

986 
	}
}

988 
boﬁ
 
	$iwl_mvm_íabÀ_txq
(
iwl_mvm
 *
mvm
, 
õì80211_°a
 *
°a
,

989 
queue
, 
u16
 
s¢
,

990 c⁄° 
iwl_å™s_txq_scd_cfg
 *
cfg
,

991 
wdg_timeout
)

993 
iwl_scd_txq_cfg_cmd
 
cmd
 = {

994 .
scd_queue
 = 
queue
,

995 .
a˘i⁄
 = 
SCD_CFG_ENABLE_QUEUE
,

996 .
wödow
 = 
cfg
->
‰ame_limô
,

997 .
°a_id
 = 
cfg
->sta_id,

998 .
s¢
 = 
	`˝u_to_À16
(ssn),

999 .
tx_fifo
 = 
cfg
->
fifo
,

1000 .
aggªg©e
 = 
cfg
->aggregate,

1001 .
tid
 = 
cfg
->tid,

1003 
boﬁ
 
öc_s¢
;

1005 i‡(
	`WARN_ON
(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)))

1006  
Ál£
;

1009 i‡(!
	`iwl_mvm_upd©e_txq_m≠pög
(
mvm
, 
°a
, 
queue
, 
cfg
->
°a_id
, cfg->
tid
))

1010  
Ál£
;

1012 
öc_s¢
 = 
	`iwl_å™s_txq_íabÀ_cfg
(
mvm
->
å™s
, 
queue
, 
s¢
,

1013 
NULL
, 
wdg_timeout
);

1014 i‡(
öc_s¢
)

1015 
	`À16_add_˝u
(&
cmd
.
s¢
, 1);

1017 
	`WARN
(
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
SCD_QUEUE_CFG
, 0, (
cmd
), &cmd),

1018 "FaûedÅÿc⁄figuª queuê%d o¿FIFO %d\n", 
queue
, 
cfg
->
fifo
);

1020  
öc_s¢
;

1021 
	}
}

1023 
	$iwl_mvm_ch™ge_queue_tid
(
iwl_mvm
 *
mvm
, 
queue
)

1025 
iwl_scd_txq_cfg_cmd
 
cmd
 = {

1026 .
scd_queue
 = 
queue
,

1027 .
a˘i⁄
 = 
SCD_CFG_UPDATE_QUEUE_TID
,

1029 
tid
;

1030 
tid_bôm≠
;

1031 
ªt
;

1033 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1035 i‡(
	`WARN_ON
(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)))

1038 
tid_bôm≠
 = 
mvm
->
queue_öfo
[
queue
].tid_bitmap;

1040 i‡(
	`WARN
(!
tid_bôm≠
, "TXQ %d ha†nÿtid†assig√dÅÿô\n", 
queue
))

1044 
tid
 = 
	`föd_fú°_bô
(&
tid_bôm≠
, 
IWL_MAX_TID_COUNT
 + 1);

1045 
cmd
.
tid
 =Åid;

1046 
cmd
.
tx_fifo
 = 
iwl_mvm_ac_to_tx_fifo
[
tid_to_mac80211_ac
[
tid
]];

1048 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
SCD_QUEUE_CFG
, 0, (
cmd
), &cmd);

1049 i‡(
ªt
) {

1050 
	`IWL_ERR
(
mvm
, "FailedÅo update owner of TXQ %d (ret=%d)\n",

1051 
queue
, 
ªt
);

1055 
mvm
->
queue_öfo
[
queue
].
txq_tid
 = 
tid
;

1056 
	`IWL_DEBUG_TX_QUEUES
(
mvm
, "Changed TXQ %d ownershipÅoÅid %d\n",

1057 
queue
, 
tid
);

1058 
	}
}

1060 
	$iwl_mvm_unsh¨e_queue
(
iwl_mvm
 *
mvm
, 
queue
)

1062 
õì80211_°a
 *
°a
;

1063 
iwl_mvm_°a
 *
mvm°a
;

1064 
u8
 
°a_id
;

1065 
tid
 = -1;

1066 
tid_bôm≠
;

1067 
wdg_timeout
;

1068 
s¢
;

1069 
ªt
 = 
åue
;

1072 i‡(
	`WARN_ON
(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)))

1075 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1077 
°a_id
 = 
mvm
->
queue_öfo
[
queue
].
ø_°a_id
;

1078 
tid_bôm≠
 = 
mvm
->
queue_öfo
[
queue
].tid_bitmap;

1081 
tid
 = 
	`föd_fú°_bô
(&
tid_bôm≠
, 
IWL_MAX_TID_COUNT
 + 1);

1082 i‡(
tid_bôm≠
 !
	`BIT
(
tid
)) {

1083 
	`IWL_ERR
(
mvm
, "FailedÅo unshare q %d,áctiveÅids=0x%lx\n",

1084 
queue
, 
tid_bôm≠
);

1088 
	`IWL_DEBUG_TX_QUEUES
(
mvm
, "Unsh¨ög TXQ %d, kìpögÅid %d\n", 
queue
,

1089 
tid
);

1091 
°a
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm
->
fw_id_to_mac_id
[
°a_id
],

1092 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

1094 i‡(
	`WARN_ON_ONCE
(
	`IS_ERR_OR_NULL
(
°a
)))

1097 
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

1098 
wdg_timeout
 = 
	`iwl_mvm_gë_wd_timeout
(
mvm
, 
mvm°a
->
vif
, 
Ál£
, false);

1100 
s¢
 = 
	`IEEE80211_SEQ_TO_SN
(
mvm°a
->
tid_d©a
[
tid
].
£q_numbî
);

1102 
ªt
 = 
	`iwl_mvm_ªdúe˘_queue
(
mvm
, 
queue
, 
tid
,

1103 
tid_to_mac80211_ac
[
tid
], 
s¢
,

1104 
wdg_timeout
, 
åue
,

1105 
	`iwl_mvm_txq_‰om_tid
(
°a
, 
tid
));

1106 i‡(
ªt
) {

1107 
	`IWL_ERR
(
mvm
, "FaûedÅÿªdúe˘ TXQ %d\n", 
queue
);

1112 i‡(
mvm°a
->
tid_d©a
[
tid
].
°©e
 =
IWL_AGG_ON
) {

1113 
iwl_mvm_add_°a_cmd
 
cmd
 = {0};

1115 
mvm°a
->
tid_dißbÀ_agg
 &~
	`BIT
(
tid
);

1117 
cmd
.
mac_id_n_cﬁ‹
 = 
	`˝u_to_À32
(
mvm°a
->mac_id_n_color);

1118 
cmd
.
°a_id
 = 
mvm°a
->
deÊök
.sta_id;

1119 
cmd
.
add_modify
 = 
STA_MODE_MODIFY
;

1120 
cmd
.
modify_mask
 = 
STA_MODIFY_TID_DISABLE_TX
;

1121 
cmd
.
tfd_queue_msk
 = 
	`˝u_to_À32
(
mvm°a
->tfd_queue_msk);

1122 
cmd
.
tid_dißbÀ_tx
 = 
	`˝u_to_À16
(
mvm°a
->
tid_dißbÀ_agg
);

1124 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
ADD_STA
, 
CMD_ASYNC
,

1125 
	`iwl_mvm_add_°a_cmd_size
(
mvm
), &
cmd
);

1126 i‡(!
ªt
) {

1127 
	`IWL_DEBUG_TX_QUEUES
(
mvm
,

1129 
queue
);

1132 
	`iwl_å™s_txq_£t_sh¨ed_mode
(
mvm
->
å™s
, 
queue
, 
Ál£
);

1136 
mvm
->
queue_öfo
[
queue
].
°©us
 = 
IWL_MVM_QUEUE_READY
;

1137 
	}
}

1146 
boﬁ
 
	$iwl_mvm_ªmove_öa˘ive_tids
(
iwl_mvm
 *
mvm
,

1147 
iwl_mvm_°a
 *
mvm°a
, 
queue
,

1148 
tid_bôm≠
,

1149 *
unsh¨e_queues
,

1150 *
ch™gëid_queues
)

1152 
tid
;

1154 
	`lockdï_as£π_hñd
(&
mvm°a
->
lock
);

1155 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1157 i‡(
	`WARN_ON
(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)))

1158  
Ál£
;

1161 
	`f‹_óch_£t_bô
(
tid
, &
tid_bôm≠
, 
IWL_MAX_TID_COUNT
 + 1) {

1163 i‡(
	`iwl_mvm_tid_queued
(
mvm
, &
mvm°a
->
tid_d©a
[
tid
]))

1164 
tid_bôm≠
 &~
	`BIT
(
tid
);

1167 i‡(
mvm°a
->
tid_d©a
[
tid
].
°©e
 !
IWL_AGG_OFF
)

1168 
tid_bôm≠
 &~
	`BIT
(
tid
);

1172 i‡(
tid_bôm≠
 =
mvm
->
queue_öfo
[
queue
].tid_bitmap) {

1173 
	`IWL_DEBUG_TX_QUEUES
(
mvm
, "Queuê%d i†öa˘ive\n", 
queue
);

1174  
åue
;

1181 
	`f‹_óch_£t_bô
(
tid
, &
tid_bôm≠
, 
IWL_MAX_TID_COUNT
 + 1) {

1182 
u16
 
q_tid_bôm≠
;

1184 
mvm°a
->
tid_d©a
[
tid
].
txq_id
 = 
IWL_MVM_INVALID_QUEUE
;

1185 
mvm
->
queue_öfo
[
queue
].
tid_bôm≠
 &~
	`BIT
(
tid
);

1187 
q_tid_bôm≠
 = 
mvm
->
queue_öfo
[
queue
].
tid_bôm≠
;

1200 i‡(!(
q_tid_bôm≠
 & 
	`BIT
(
mvm
->
queue_öfo
[
queue
].
txq_tid
)))

1201 
	`£t_bô
(
queue
, 
ch™gëid_queues
);

1203 
	`IWL_DEBUG_TX_QUEUES
(
mvm
,

1205 
tid
, 
queue
);

1208 
	`IWL_DEBUG_TX_QUEUES
(
mvm
,

1209 "TXQ #%dÜe· wôhÅid bôm≠ 0x%x\n", 
queue
,

1210 
mvm
->
queue_öfo
[
queue
].
tid_bôm≠
);

1216 
tid_bôm≠
 = 
mvm
->
queue_öfo
[
queue
].tid_bitmap;

1219 i‡(
	`hweight16
(
mvm
->
queue_öfo
[
queue
].
tid_bôm≠
) == 1 &&

1220 
mvm
->
queue_öfo
[
queue
].
°©us
 =
IWL_MVM_QUEUE_SHARED
) {

1221 
	`IWL_DEBUG_TX_QUEUES
(
mvm
, "Marking Q:%d forÑeconfig\n",

1222 
queue
);

1223 
	`£t_bô
(
queue
, 
unsh¨e_queues
);

1226  
Ál£
;

1227 
	}
}

1238 
	$iwl_mvm_öa˘ivôy_check
(
iwl_mvm
 *
mvm
, 
u8
 
Æloc_f‹_°a
)

1240 
now
 = 
jiffõs
;

1241 
unsh¨e_queues
 = 0;

1242 
ch™gëid_queues
 = 0;

1243 
i
, 
ªt
, 
‰ì_queue
 = -
ENOSPC
;

1244 
õì80211_°a
 *
queue_ow√r
 = 
NULL
;

1246 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1248 i‡(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
))

1249  -
ENOSPC
;

1251 
	`rcu_ªad_lock
();

1254 
	`BUILD_BUG_ON
(
IWL_MVM_DQA_CMD_QUEUE
 != 0);

1256 
i
 = 1; i < 
IWL_MAX_HW_QUEUES
; i++) {

1257 
õì80211_°a
 *
°a
;

1258 
iwl_mvm_°a
 *
mvm°a
;

1259 
u8
 
°a_id
;

1260 
tid
;

1261 
öa˘ive_tid_bôm≠
 = 0;

1262 
queue_tid_bôm≠
;

1264 
queue_tid_bôm≠
 = 
mvm
->
queue_öfo
[
i
].
tid_bôm≠
;

1265 i‡(!
queue_tid_bôm≠
)

1269 i‡(
mvm
->
queue_öfo
[
i
].
°©us
 !
IWL_MVM_QUEUE_READY
 &&

1270 
mvm
->
queue_öfo
[
i
].
°©us
 !
IWL_MVM_QUEUE_SHARED
)

1274 
	`f‹_óch_£t_bô
(
tid
, &
queue_tid_bôm≠
,

1275 
IWL_MAX_TID_COUNT
 + 1) {

1276 i‡(
	`time_a·î
(
mvm
->
queue_öfo
[
i
].
œ°_‰ame_time
[
tid
] +

1277 
IWL_MVM_DQA_QUEUE_TIMEOUT
, 
now
))

1280 
öa˘ive_tid_bôm≠
 |
	`BIT
(
tid
);

1284 i‡(!
öa˘ive_tid_bôm≠
)

1292 
°a_id
 = 
mvm
->
queue_öfo
[
i
].
ø_°a_id
;

1293 
°a
 = 
	`rcu_dîe„ªn˚
(
mvm
->
fw_id_to_mac_id
[
°a_id
]);

1300 i‡(
	`IS_ERR_OR_NULL
(
°a
))

1303 
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

1305 
	`•ö_lock_bh
(&
mvm°a
->
lock
);

1306 
ªt
 = 
	`iwl_mvm_ªmove_öa˘ive_tids
(
mvm
, 
mvm°a
, 
i
,

1307 
öa˘ive_tid_bôm≠
,

1308 &
unsh¨e_queues
,

1309 &
ch™gëid_queues
);

1310 i‡(
ªt
 && 
‰ì_queue
 < 0) {

1311 
queue_ow√r
 = 
°a
;

1312 
‰ì_queue
 = 
i
;

1315 
	`•ö_u∆ock_bh
(&
mvm°a
->
lock
);

1320 
	`f‹_óch_£t_bô
(
i
, &
unsh¨e_queues
, 
IWL_MAX_HW_QUEUES
)

1321 
	`iwl_mvm_unsh¨e_queue
(
mvm
, 
i
);

1322 
	`f‹_óch_£t_bô
(
i
, &
ch™gëid_queues
, 
IWL_MAX_HW_QUEUES
)

1323 
	`iwl_mvm_ch™ge_queue_tid
(
mvm
, 
i
);

1325 
	`rcu_ªad_u∆ock
();

1327 i‡(
‰ì_queue
 >0 && 
Æloc_f‹_°a
 !
IWL_MVM_INVALID_STA
) {

1328 
ªt
 = 
	`iwl_mvm_‰ì_öa˘ive_queue
(
mvm
, 
‰ì_queue
, 
queue_ow√r
,

1329 
Æloc_f‹_°a
);

1330 i‡(
ªt
)

1331  
ªt
;

1334  
‰ì_queue
;

1335 
	}
}

1337 
	$iwl_mvm_°a_Æloc_queue
(
iwl_mvm
 *
mvm
,

1338 
õì80211_°a
 *
°a
, 
u8
 
ac
, 
tid
)

1340 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

1341 
iwl_å™s_txq_scd_cfg
 
cfg
 = {

1342 .
fifo
 = 
	`iwl_mvm_mac_ac_to_tx_fifo
(
mvm
, 
ac
),

1343 .
°a_id
 = 
mvm°a
->
deÊök
.sta_id,

1344 .
tid
 =Åid,

1345 .
‰ame_limô
 = 
IWL_FRAME_LIMIT
,

1347 
wdg_timeout
 =

1348 
	`iwl_mvm_gë_wd_timeout
(
mvm
, 
mvm°a
->
vif
, 
Ál£
, false);

1349 
queue
 = -1;

1350 
u16
 
queue_tmp
;

1351 
dißbÀ_agg_tids
 = 0;

1352 
iwl_mvm_agg_°©e
 
queue_°©e
;

1353 
boﬁ
 
sh¨ed_queue
 = 
Ál£
, 
öc_s¢
;

1354 
s¢
;

1355 
tfd_queue_mask
;

1356 
ªt
;

1358 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1360 i‡(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
))

1361  
	`iwl_mvm_°a_Æloc_queue_tvqm
(
mvm
, 
°a
, 
ac
, 
tid
);

1363 
	`•ö_lock_bh
(&
mvm°a
->
lock
);

1364 
tfd_queue_mask
 = 
mvm°a
->
tfd_queue_msk
;

1365 
s¢
 = 
	`IEEE80211_SEQ_TO_SN
(
mvm°a
->
tid_d©a
[
tid
].
£q_numbî
);

1366 
	`•ö_u∆ock_bh
(&
mvm°a
->
lock
);

1368 i‡(
tid
 =
IWL_MAX_TID_COUNT
) {

1369 
queue
 = 
	`iwl_mvm_föd_‰ì_queue
(
mvm
, 
mvm°a
->
deÊök
.
°a_id
,

1370 
IWL_MVM_DQA_MIN_MGMT_QUEUE
,

1371 
IWL_MVM_DQA_MAX_MGMT_QUEUE
);

1372 i‡(
queue
 >
IWL_MVM_DQA_MIN_MGMT_QUEUE
)

1373 
	`IWL_DEBUG_TX_QUEUES
(
mvm
, "Found free MGMT queue #%d\n",

1374 
queue
);

1379 i‡((
queue
 < 0 && 
mvm°a
->
ª£rved_queue
 !
IEEE80211_INVAL_HW_QUEUE
) &&

1380 (
mvm
->
queue_öfo
[
mvm°a
->
ª£rved_queue
].
°©us
 ==

1381 
IWL_MVM_QUEUE_RESERVED
)) {

1382 
queue
 = 
mvm°a
->
ª£rved_queue
;

1383 
mvm
->
queue_öfo
[
queue
].
ª£rved
 = 
åue
;

1384 
	`IWL_DEBUG_TX_QUEUES
(
mvm
, "UsögÑe£rved queuê#%d\n", 
queue
);

1387 i‡(
queue
 < 0)

1388 
queue
 = 
	`iwl_mvm_föd_‰ì_queue
(
mvm
, 
mvm°a
->
deÊök
.
°a_id
,

1389 
IWL_MVM_DQA_MIN_DATA_QUEUE
,

1390 
IWL_MVM_DQA_MAX_DATA_QUEUE
);

1391 i‡(
queue
 < 0) {

1393 
queue
 = 
	`iwl_mvm_öa˘ivôy_check
(
mvm
, 
mvm°a
->
deÊök
.
°a_id
);

1397 i‡(
queue
 <= 0) {

1398 
queue
 = 
	`iwl_mvm_gë_sh¨ed_queue
(
mvm
, 
tfd_queue_mask
, 
ac
);

1399 i‡(
queue
 > 0) {

1400 
sh¨ed_queue
 = 
åue
;

1401 
mvm
->
queue_öfo
[
queue
].
°©us
 = 
IWL_MVM_QUEUE_SHARED
;

1411 i‡(
queue
 > 0 && !
sh¨ed_queue
)

1412 
mvm
->
queue_öfo
[
queue
].
°©us
 = 
IWL_MVM_QUEUE_READY
;

1415 i‡(
	`WARN_ON
(
queue
 <= 0)) {

1416 
	`IWL_ERR
(
mvm
, "Noávailable queues forÅid %d on sta_id %d\n",

1417 
tid
, 
cfg
.
°a_id
);

1418  
queue
;

1427 
cfg
.
aggªg©e
 = (
queue
 >
IWL_MVM_DQA_MIN_DATA_QUEUE
 ||

1428 
queue
 =
IWL_MVM_DQA_BSS_CLIENT_QUEUE
);

1430 
	`IWL_DEBUG_TX_QUEUES
(
mvm
,

1432 
sh¨ed_queue
 ? "sh¨ed " : "", 
queue
,

1433 
mvm°a
->
deÊök
.
°a_id
, 
tid
);

1435 i‡(
sh¨ed_queue
) {

1437 
dißbÀ_agg_tids
 = 
	`iwl_mvm_gë_queue_agg_tids
(
mvm
, 
queue
);

1439 i‡(
dißbÀ_agg_tids
) {

1440 
	`IWL_DEBUG_TX_QUEUES
(
mvm
, "Disablingággs on queue %d\n",

1441 
queue
);

1442 
	`iwl_mvm_övÆid©e_°a_queue
(
mvm
, 
queue
,

1443 
dißbÀ_agg_tids
, 
Ál£
);

1447 
öc_s¢
 = 
	`iwl_mvm_íabÀ_txq
(
mvm
, 
°a
, 
queue
, 
s¢
, &
cfg
, 
wdg_timeout
);

1455 i‡(
sh¨ed_queue
)

1456 
	`iwl_å™s_txq_£t_sh¨ed_mode
(
mvm
->
å™s
, 
queue
, 
åue
);

1458 
	`•ö_lock_bh
(&
mvm°a
->
lock
);

1464 i‡(
öc_s¢
) {

1465 
mvm°a
->
tid_d©a
[
tid
].
£q_numbî
 += 0x10;

1466 
s¢
 = (s¢ + 1Ë& 
IEEE80211_SCTL_SEQ
;

1468 
mvm°a
->
tid_d©a
[
tid
].
txq_id
 = 
queue
;

1469 
mvm°a
->
tfd_queue_msk
 |
	`BIT
(
queue
);

1470 
queue_°©e
 = 
mvm°a
->
tid_d©a
[
tid
].
°©e
;

1472 i‡(
mvm°a
->
ª£rved_queue
 =
queue
)

1473 
mvm°a
->
ª£rved_queue
 = 
IEEE80211_INVAL_HW_QUEUE
;

1474 
	`•ö_u∆ock_bh
(&
mvm°a
->
lock
);

1476 i‡(!
sh¨ed_queue
) {

1477 
ªt
 = 
	`iwl_mvm_°a_£nd_to_fw
(
mvm
, 
°a
, 
åue
, 
STA_MODIFY_QUEUES
);

1478 i‡(
ªt
)

1479 
out_îr
;

1482 i‡(
queue_°©e
 =
IWL_AGG_ON
) {

1483 
ªt
 = 
	`iwl_mvm_°a_tx_agg
(
mvm
, 
°a
, 
tid
, 
queue
, 
åue
);

1484 i‡(
ªt
)

1485 
out_îr
;

1489 
ªt
 = 
	`iwl_mvm_ªdúe˘_queue
(
mvm
, 
queue
, 
tid
, 
ac
, 
s¢
,

1490 
wdg_timeout
, 
Ál£
,

1491 
	`iwl_mvm_txq_‰om_tid
(
°a
, 
tid
));

1492 i‡(
ªt
)

1493 
out_îr
;

1498 
out_îr
:

1499 
queue_tmp
 = 
queue
;

1500 
	`iwl_mvm_dißbÀ_txq
(
mvm
, 
°a
, 
mvm°a
->
deÊök
.
°a_id
, &
queue_tmp
, 
tid
);

1502  
ªt
;

1503 
	}
}

1505 
	$iwl_mvm_°a_ísuª_queue
(
iwl_mvm
 *
mvm
,

1506 
õì80211_txq
 *
txq
)

1508 
iwl_mvm_txq
 *
mvmtxq
 = 
	`iwl_mvm_txq_‰om_mac80211
(
txq
);

1509 
ªt
 = -
EINVAL
;

1511 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1513 i‡(
	`likñy
(
	`ã°_bô
(
IWL_MVM_TXQ_STATE_READY
, &
mvmtxq
->
°©e
)) ||

1514 !
txq
->
°a
) {

1518 i‡(!
	`iwl_mvm_°a_Æloc_queue
(
mvm
, 
txq
->
°a
,Åxq->
ac
,Åxq->
tid
)) {

1519 
	`£t_bô
(
IWL_MVM_TXQ_STATE_READY
, &
mvmtxq
->
°©e
);

1520 
ªt
 = 0;

1523 
	`loˇl_bh_dißbÀ
();

1524 
	`•ö_lock
(&
mvm
->
add_°ªam_lock
);

1525 i‡(!
	`li°_em±y
(&
mvmtxq
->
li°
))

1526 
	`li°_dñ_öô
(&
mvmtxq
->
li°
);

1527 
	`•ö_u∆ock
(&
mvm
->
add_°ªam_lock
);

1528 
	`loˇl_bh_íabÀ
();

1530  
ªt
;

1531 
	}
}

1533 
	$iwl_mvm_add_√w_dqa_°ªam_wk
(
w‹k_°ru˘
 *
wk
)

1535 
iwl_mvm
 *
mvm
 = 
	`c⁄èöî_of
(
wk
, iwl_mvm,

1536 
add_°ªam_wk
);

1538 
	`muãx_lock
(&
mvm
->
muãx
);

1540 
	`iwl_mvm_öa˘ivôy_check
(
mvm
, 
IWL_MVM_INVALID_STA
);

1542 !
	`li°_em±y
(&
mvm
->
add_°ªam_txqs
)) {

1543 
iwl_mvm_txq
 *
mvmtxq
;

1544 
õì80211_txq
 *
txq
;

1545 
u8
 
tid
;

1547 
mvmtxq
 = 
	`li°_fú°_íåy
(&
mvm
->
add_°ªam_txqs
,

1548 
iwl_mvm_txq
, 
li°
);

1550 
txq
 = 
	`c⁄èöî_of
((*)
mvmtxq
, 
õì80211_txq
,

1551 
drv_¥iv
);

1552 
tid
 = 
txq
->tid;

1553 i‡(
tid
 =
IEEE80211_NUM_TIDS
)

1554 
tid
 = 
IWL_MAX_TID_COUNT
;

1562 i‡(
	`iwl_mvm_°a_Æloc_queue
(
mvm
, 
txq
->
°a
,Åxq->
ac
, 
tid
)) {

1563 
	`•ö_lock_bh
(&
mvm
->
add_°ªam_lock
);

1564 
	`li°_dñ_öô
(&
mvmtxq
->
li°
);

1565 
	`•ö_u∆ock_bh
(&
mvm
->
add_°ªam_lock
);

1572 
	`£t_bô
(
IWL_MVM_TXQ_STATE_READY
, &
mvmtxq
->
°©e
);

1574 
	`loˇl_bh_dißbÀ
();

1575 
	`•ö_lock
(&
mvm
->
add_°ªam_lock
);

1576 
	`li°_dñ_öô
(&
mvmtxq
->
li°
);

1577 
	`•ö_u∆ock
(&
mvm
->
add_°ªam_lock
);

1579 
	`iwl_mvm_mac_ôxq_xmô
(
mvm
->
hw
, 
txq
);

1580 
	`loˇl_bh_íabÀ
();

1583 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1584 
	}
}

1586 
	$iwl_mvm_ª£rve_°a_°ªam
(
iwl_mvm
 *
mvm
,

1587 
õì80211_°a
 *
°a
,

1588 
∆80211_i·y≥
 
vif_ty≥
)

1590 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

1591 
queue
;

1594 i‡(
	`WARN_ON
(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)))

1598 
	`iwl_mvm_öa˘ivôy_check
(
mvm
, 
IWL_MVM_INVALID_STA
);

1601 i‡(
vif_ty≥
 =
NL80211_IFTYPE_STATION
 && !
°a
->
tdls
 &&

1602 !
mvm
->
queue_öfo
[
IWL_MVM_DQA_BSS_CLIENT_QUEUE
].
tid_bôm≠
 &&

1603 (
mvm
->
queue_öfo
[
IWL_MVM_DQA_BSS_CLIENT_QUEUE
].
°©us
 ==

1604 
IWL_MVM_QUEUE_FREE
))

1605 
queue
 = 
IWL_MVM_DQA_BSS_CLIENT_QUEUE
;

1607 
queue
 = 
	`iwl_mvm_föd_‰ì_queue
(
mvm
, 
mvm°a
->
deÊök
.
°a_id
,

1608 
IWL_MVM_DQA_MIN_DATA_QUEUE
,

1609 
IWL_MVM_DQA_MAX_DATA_QUEUE
);

1610 i‡(
queue
 < 0) {

1612 
queue
 = 
	`iwl_mvm_öa˘ivôy_check
(
mvm
, 
mvm°a
->
deÊök
.
°a_id
);

1613 i‡(
queue
 < 0) {

1614 
	`IWL_ERR
(
mvm
, "Noávailable queues forÇew station\n");

1615  -
ENOSPC
;

1618 
mvm
->
queue_öfo
[
queue
].
°©us
 = 
IWL_MVM_QUEUE_RESERVED
;

1620 
mvm°a
->
ª£rved_queue
 = 
queue
;

1622 
	`IWL_DEBUG_TX_QUEUES
(
mvm
, "Reserving data queue #%d for sta_id %d\n",

1623 
queue
, 
mvm°a
->
deÊök
.
°a_id
);

1626 
	}
}

1635 
	$iwl_mvm_ªÆloc_queues_a·î_ª°¨t
(
iwl_mvm
 *
mvm
,

1636 
õì80211_°a
 *
°a
)

1638 
iwl_mvm_°a
 *
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

1639 
wdg
 =

1640 
	`iwl_mvm_gë_wd_timeout
(
mvm
, 
mvm_°a
->
vif
, 
Ál£
, false);

1641 
i
;

1642 
iwl_å™s_txq_scd_cfg
 
cfg
 = {

1643 .
°a_id
 = 
mvm_°a
->
deÊök
.sta_id,

1644 .
‰ame_limô
 = 
IWL_FRAME_LIMIT
,

1648 i‡(
mvm_°a
->
ª£rved_queue
 !
IEEE80211_INVAL_HW_QUEUE
)

1649 
mvm
->
queue_öfo
[
mvm_°a
->
ª£rved_queue
].
°©us
 =

1650 
IWL_MVM_QUEUE_RESERVED
;

1652 
i
 = 0; i <
IWL_MAX_TID_COUNT
; i++) {

1653 
iwl_mvm_tid_d©a
 *
tid_d©a
 = &
mvm_°a
->tid_d©a[
i
];

1654 
txq_id
 = 
tid_d©a
->txq_id;

1655 
ac
;

1657 i‡(
txq_id
 =
IWL_MVM_INVALID_QUEUE
)

1660 
ac
 = 
tid_to_mac80211_ac
[
i
];

1662 i‡(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)) {

1663 
	`IWL_DEBUG_TX_QUEUES
(
mvm
,

1665 
mvm_°a
->
deÊök
.
°a_id
, 
i
);

1666 
txq_id
 = 
	`iwl_mvm_tvqm_íabÀ_txq
(
mvm
, 
°a
,

1667 
mvm_°a
->
deÊök
.
°a_id
,

1668 
i
, 
wdg
);

1674 i‡(
txq_id
 < 0)

1675 
txq_id
 = 
IWL_MVM_INVALID_QUEUE
;

1676 
tid_d©a
->
txq_id
 =Åxq_id;

1684 
tid_d©a
->
£q_numbî
 = 0;

1686 
u16
 
£q
 = 
	`IEEE80211_SEQ_TO_SN
(
tid_d©a
->
£q_numbî
);

1688 
cfg
.
tid
 = 
i
;

1689 
cfg
.
fifo
 = 
	`iwl_mvm_mac_ac_to_tx_fifo
(
mvm
, 
ac
);

1690 
cfg
.
aggªg©e
 = (
txq_id
 >
IWL_MVM_DQA_MIN_DATA_QUEUE
 ||

1691 
txq_id
 ==

1692 
IWL_MVM_DQA_BSS_CLIENT_QUEUE
);

1694 
	`IWL_DEBUG_TX_QUEUES
(
mvm
,

1696 
mvm_°a
->
deÊök
.
°a_id
, 
i
,

1697 
txq_id
);

1699 
	`iwl_mvm_íabÀ_txq
(
mvm
, 
°a
, 
txq_id
, 
£q
, &
cfg
, 
wdg
);

1700 
mvm
->
queue_öfo
[
txq_id
].
°©us
 = 
IWL_MVM_QUEUE_READY
;

1703 
	}
}

1705 
	$iwl_mvm_add_öt_°a_comm⁄
(
iwl_mvm
 *
mvm
,

1706 
iwl_mvm_öt_°a
 *
°a
,

1707 c⁄° 
u8
 *
addr
,

1708 
u16
 
mac_id
, u16 
cﬁ‹
)

1710 
iwl_mvm_add_°a_cmd
 
cmd
;

1711 
ªt
;

1712 
u32
 
°©us
 = 
ADD_STA_SUCCESS
;

1714 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1716 
	`mem£t
(&
cmd
, 0, (cmd));

1717 
cmd
.
°a_id
 = 
°a
->sta_id;

1719 i‡(
	`iwl_mvm_has_√w_°©i⁄_≠i
(
mvm
->
fw
) &&

1720 
°a
->
ty≥
 =
IWL_STA_AUX_ACTIVITY
)

1721 
cmd
.
mac_id_n_cﬁ‹
 = 
	`˝u_to_À32
(
mac_id
);

1723 
cmd
.
mac_id_n_cﬁ‹
 = 
	`˝u_to_À32
(
	`FW_CMD_ID_AND_COLOR
(
mac_id
,

1724 
cﬁ‹
));

1726 i‡(
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_API_STA_TYPE
))

1727 
cmd
.
°©i⁄_ty≥
 = 
°a
->
ty≥
;

1729 i‡(!
	`iwl_mvm_has_√w_tx_≠i
(
mvm
))

1730 
cmd
.
tfd_queue_msk
 = 
	`˝u_to_À32
(
°a
->tfd_queue_msk);

1731 
cmd
.
tid_dißbÀ_tx
 = 
	`˝u_to_À16
(0xffff);

1733 i‡(
addr
)

1734 
	`mem˝y
(
cmd
.
addr
,áddr, 
ETH_ALEN
);

1736 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu_°©us
(
mvm
, 
ADD_STA
,

1737 
	`iwl_mvm_add_°a_cmd_size
(
mvm
),

1738 &
cmd
, &
°©us
);

1739 i‡(
ªt
)

1740  
ªt
;

1742 
°©us
 & 
IWL_ADD_STA_STATUS_MASK
) {

1743 
ADD_STA_SUCCESS
:

1744 
	`IWL_DEBUG_INFO
(
mvm
, "Internal stationádded.\n");

1747 
ªt
 = -
EIO
;

1748 
	`IWL_ERR
(
mvm
, "Add internal station failed, status=0x%x\n",

1749 
°©us
);

1752  
ªt
;

1753 
	}
}

1756 
	$iwl_mvm_°a_öô
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

1757 
õì80211_°a
 *
°a
, 
°a_id
, 
u8
 
°a_ty≥
)

1759 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1760 
iwl_mvm_°a
 *
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

1761 
iwl_mvm_rxq_dup_d©a
 *
dup_d©a
;

1762 
i
, 
ªt
 = 0;

1764 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1766 
mvm_°a
->
mac_id_n_cﬁ‹
 = 
	`FW_CMD_ID_AND_COLOR
(
mvmvif
->
id
,

1767 
mvmvif
->
cﬁ‹
);

1768 
mvm_°a
->
vif
 = vif;

1773 i‡(!
mvm
->
mld_≠i_is_u£d
) {

1774 i‡(
	`WARN_ON
(
°a_id
 =
IWL_MVM_INVALID_STA
))

1775  -
EINVAL
;

1777 
mvm_°a
->
deÊök
.
°a_id
 = sta_id;

1778 
	`rcu_assign_poöãr
(
mvm_°a
->
lök
[0], &mvm_°a->
deÊök
);

1780 i‡(!
mvm
->
å™s
->
å™s_cfg
->
gí2
)

1781 
mvm_°a
->
deÊök
.
lq_°a
.
rs_drv
.
≥rs
.
max_agg_bufsize
 =

1782 
LINK_QUAL_AGG_FRAME_LIMIT_DEF
;

1784 
mvm_°a
->
deÊök
.
lq_°a
.
rs_drv
.
≥rs
.
max_agg_bufsize
 =

1785 
LINK_QUAL_AGG_FRAME_LIMIT_GEN2_DEF
;

1788 
mvm_°a
->
â_tx_¥Ÿe˘i⁄
 = 
Ál£
;

1789 
mvm_°a
->
°a_ty≥
 = sta_type;

1791 
mvm_°a
->
tid_dißbÀ_agg
 = 0xffff;

1793 
i
 = 0; i <
IWL_MAX_TID_COUNT
; i++) {

1798 
mvm_°a
->
tid_d©a
[
i
].
txq_id
 = 
IWL_MVM_INVALID_QUEUE
;

1801 
i
 = 0; i < 
	`ARRAY_SIZE
(
°a
->
txq
); i++) {

1802 
iwl_mvm_txq
 *
mvmtxq
 =

1803 
	`iwl_mvm_txq_‰om_mac80211
(
°a
->
txq
[
i
]);

1805 
mvmtxq
->
txq_id
 = 
IWL_MVM_INVALID_QUEUE
;

1806 
	`INIT_LIST_HEAD
(&
mvmtxq
->
li°
);

1807 
	`©omic_£t
(&
mvmtxq
->
tx_ªque°
, 0);

1810 i‡(
	`iwl_mvm_has_√w_rx_≠i
(
mvm
)) {

1811 
q
;

1813 
dup_d©a
 = 
	`kˇŒoc
(
mvm
->
å™s
->
num_rx_queues
,

1814 (*
dup_d©a
), 
GFP_KERNEL
);

1815 i‡(!
dup_d©a
)

1816  -
ENOMEM
;

1826 
q
 = 0; q < 
mvm
->
å™s
->
num_rx_queues
; q++)

1827 
	`mem£t
(
dup_d©a
[
q
].
œ°_£q
, 0xff,

1828 (
dup_d©a
[
q
].
œ°_£q
));

1829 
mvm_°a
->
dup_d©a
 = dup_data;

1832 i‡(!
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)) {

1833 
ªt
 = 
	`iwl_mvm_ª£rve_°a_°ªam
(
mvm
, 
°a
,

1834 
	`õì80211_vif_ty≥_p2p
(
vif
));

1835 i‡(
ªt
)

1836  
ªt
;

1843 i‡(
	`iwl_mvm_has_éc_ofÊﬂd
(
mvm
))

1844 
	`iwl_mvm_rs_add_°a
(
mvm
, 
mvm_°a
);

1846 
	`•ö_lock_öô
(&
mvm_°a
->
deÊök
.
lq_°a
.
rs_drv
.
≥rs
.
lock
);

1848 
	`iwl_mvm_toggÀ_tx_™t
(
mvm
, &
mvm_°a
->
tx_™t
);

1851 
	}
}

1853 
	$iwl_mvm_add_°a
(
iwl_mvm
 *
mvm
,

1854 
õì80211_vif
 *
vif
,

1855 
õì80211_°a
 *
°a
)

1857 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1858 
iwl_mvm_°a
 *
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

1859 
ªt
, 
°a_id
;

1860 
boﬁ
 
°a_upd©e
 = 
Ál£
;

1861 
°a_Êags
 = 0;

1863 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1865 i‡(!
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
))

1866 
°a_id
 = 
	`iwl_mvm_föd_‰ì_°a_id
(
mvm
,

1867 
	`õì80211_vif_ty≥_p2p
(
vif
));

1869 
°a_id
 = 
mvm_°a
->
deÊök
.sta_id;

1871 i‡(
°a_id
 =
IWL_MVM_INVALID_STA
)

1872  -
ENOSPC
;

1874 
	`•ö_lock_öô
(&
mvm_°a
->
lock
);

1877 i‡(
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
)) {

1878 
iwl_mvm_öt_°a
 
tmp_°a
 = {

1879 .
°a_id
 = sta_id,

1880 .
ty≥
 = 
mvm_°a
->
°a_ty≥
,

1886 
ªt
 = 
	`iwl_mvm_add_öt_°a_comm⁄
(
mvm
, &
tmp_°a
, 
°a
->
addr
,

1887 
mvmvif
->
id
, mvmvif->
cﬁ‹
);

1888 i‡(
ªt
)

1889 
îr
;

1891 
	`iwl_mvm_ªÆloc_queues_a·î_ª°¨t
(
mvm
, 
°a
);

1892 
°a_upd©e
 = 
åue
;

1893 
°a_Êags
 = 
	`iwl_mvm_has_√w_tx_≠i
(
mvm
Ë? 0 : 
STA_MODIFY_QUEUES
;

1894 
upd©e_fw
;

1897 
ªt
 = 
	`iwl_mvm_°a_öô
(
mvm
, 
vif
, 
°a
, 
°a_id
,

1898 
°a
->
tdls
 ? 
IWL_STA_TDLS_LINK
 : 
IWL_STA_LINK
);

1899 i‡(
ªt
)

1900 
îr
;

1902 
upd©e_fw
:

1903 
ªt
 = 
	`iwl_mvm_°a_£nd_to_fw
(
mvm
, 
°a
, 
°a_upd©e
, 
°a_Êags
);

1904 i‡(
ªt
)

1905 
îr
;

1907 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
) {

1908 i‡(!
°a
->
tdls
) {

1909 
	`WARN_ON
(
mvmvif
->
deÊök
.
≠_°a_id
 !
IWL_MVM_INVALID_STA
);

1910 
mvmvif
->
deÊök
.
≠_°a_id
 = 
°a_id
;

1912 
	`WARN_ON
(
mvmvif
->
deÊök
.
≠_°a_id
 =
IWL_MVM_INVALID_STA
);

1916 
	`rcu_assign_poöãr
(
mvm
->
fw_id_to_mac_id
[
°a_id
], 
°a
);

1920 
îr
:

1921  
ªt
;

1922 
	}
}

1924 
	$iwl_mvm_døö_°a
(
iwl_mvm
 *
mvm
, 
iwl_mvm_°a
 *
mvm°a
,

1925 
boﬁ
 
døö
)

1927 
iwl_mvm_add_°a_cmd
 
cmd
 = {};

1928 
ªt
;

1929 
u32
 
°©us
;

1931 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1933 
cmd
.
mac_id_n_cﬁ‹
 = 
	`˝u_to_À32
(
mvm°a
->mac_id_n_color);

1934 
cmd
.
°a_id
 = 
mvm°a
->
deÊök
.sta_id;

1935 
cmd
.
add_modify
 = 
STA_MODE_MODIFY
;

1936 
cmd
.
°©i⁄_Êags
 = 
døö
 ? 
	`˝u_to_À32
(
STA_FLG_DRAIN_FLOW
) : 0;

1937 
cmd
.
°©i⁄_Êags_msk
 = 
	`˝u_to_À32
(
STA_FLG_DRAIN_FLOW
);

1939 
°©us
 = 
ADD_STA_SUCCESS
;

1940 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu_°©us
(
mvm
, 
ADD_STA
,

1941 
	`iwl_mvm_add_°a_cmd_size
(
mvm
),

1942 &
cmd
, &
°©us
);

1943 i‡(
ªt
)

1944  
ªt
;

1946 
°©us
 & 
IWL_ADD_STA_STATUS_MASK
) {

1947 
ADD_STA_SUCCESS
:

1948 
	`IWL_DEBUG_INFO
(
mvm
, "Frames for staid %d will drained in fw\n",

1949 
mvm°a
->
deÊök
.
°a_id
);

1952 
ªt
 = -
EIO
;

1953 
	`IWL_ERR
(
mvm
, "Couldn't drain frames for staid %d\n",

1954 
mvm°a
->
deÊök
.
°a_id
);

1958  
ªt
;

1959 
	}
}

1966 
	$iwl_mvm_rm_°a_comm⁄
(
iwl_mvm
 *
mvm
, 
u8
 
°a_id
)

1968 
õì80211_°a
 *
°a
;

1969 
iwl_mvm_rm_°a_cmd
 
rm_°a_cmd
 = {

1970 .
°a_id
 = sta_id,

1972 
ªt
;

1974 
°a
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm
->
fw_id_to_mac_id
[
°a_id
],

1975 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

1978 i‡(!
°a
) {

1979 
	`IWL_ERR
(
mvm
, "Invalid station id\n");

1980  -
EINVAL
;

1983 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
REMOVE_STA
, 0,

1984 (
rm_°a_cmd
), &rm_sta_cmd);

1985 i‡(
ªt
) {

1986 
	`IWL_ERR
(
mvm
, "FaûedÅÿªmovê°©i⁄. Id=%d\n", 
°a_id
);

1987  
ªt
;

1991 
	}
}

1993 
	$iwl_mvm_dißbÀ_°a_queues
(
iwl_mvm
 *
mvm
,

1994 
õì80211_vif
 *
vif
,

1995 
õì80211_°a
 *
°a
)

1997 
iwl_mvm_°a
 *
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

1998 
i
;

2000 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

2002 
i
 = 0; i < 
	`ARRAY_SIZE
(
mvm_°a
->
tid_d©a
); i++) {

2003 i‡(
mvm_°a
->
tid_d©a
[
i
].
txq_id
 =
IWL_MVM_INVALID_QUEUE
)

2006 
	`iwl_mvm_dißbÀ_txq
(
mvm
, 
°a
, 
mvm_°a
->
deÊök
.
°a_id
,

2007 &
mvm_°a
->
tid_d©a
[
i
].
txq_id
, i);

2008 
mvm_°a
->
tid_d©a
[
i
].
txq_id
 = 
IWL_MVM_INVALID_QUEUE
;

2011 
i
 = 0; i < 
	`ARRAY_SIZE
(
°a
->
txq
); i++) {

2012 
iwl_mvm_txq
 *
mvmtxq
 =

2013 
	`iwl_mvm_txq_‰om_mac80211
(
°a
->
txq
[
i
]);

2015 
	`•ö_lock_bh
(&
mvm
->
add_°ªam_lock
);

2016 
mvmtxq
->
txq_id
 = 
IWL_MVM_INVALID_QUEUE
;

2017 
	`li°_dñ_öô
(&
mvmtxq
->
li°
);

2018 
	`˛ór_bô
(
IWL_MVM_TXQ_STATE_READY
, &
mvmtxq
->
°©e
);

2019 
	`•ö_u∆ock_bh
(&
mvm
->
add_°ªam_lock
);

2021 
	}
}

2023 
	$iwl_mvm_waô_°a_queues_em±y
(
iwl_mvm
 *
mvm
,

2024 
iwl_mvm_°a
 *
mvm_°a
)

2026 
i
;

2028 
i
 = 0; i < 
	`ARRAY_SIZE
(
mvm_°a
->
tid_d©a
); i++) {

2029 
u16
 
txq_id
;

2030 
ªt
;

2032 
	`•ö_lock_bh
(&
mvm_°a
->
lock
);

2033 
txq_id
 = 
mvm_°a
->
tid_d©a
[
i
].txq_id;

2034 
	`•ö_u∆ock_bh
(&
mvm_°a
->
lock
);

2036 i‡(
txq_id
 =
IWL_MVM_INVALID_QUEUE
)

2039 
ªt
 = 
	`iwl_å™s_waô_txq_em±y
(
mvm
->
å™s
, 
txq_id
);

2040 i‡(
ªt
)

2041  
ªt
;

2045 
	}
}

2051 
boﬁ
 
	$iwl_mvm_°a_dñ
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

2052 
õì80211_°a
 *
°a
,

2053 
õì80211_lök_°a
 *
lök_°a
, *
ªt
)

2055 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

2056 
iwl_mvm_vif_lök_öfo
 *
mvm_lök
 =

2057 
mvmvif
->
lök
[
lök_°a
->
lök_id
];

2058 
iwl_mvm_°a
 *
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

2059 
iwl_mvm_lök_°a
 *
mvm_lök_°a
;

2060 
u8
 
°a_id
;

2062 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

2064 
mvm_lök_°a
 =

2065 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm_°a
->
lök
[
lök_°a
->
lök_id
],

2066 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

2067 
°a_id
 = 
mvm_lök_°a
->sta_id;

2070 i‡(
mvm_°a
->
ª£rved_queue
 !
IEEE80211_INVAL_HW_QUEUE
) {

2071 
u8
 
ª£rved_txq
 = 
mvm_°a
->
ª£rved_queue
;

2072 
iwl_mvm_queue_°©us
 *
°©us
;

2079 
°©us
 = &
mvm
->
queue_öfo
[
ª£rved_txq
].status;

2080 i‡(
	`WARN
((*
°©us
 !
IWL_MVM_QUEUE_RESERVED
) &&

2081 (*
°©us
 !
IWL_MVM_QUEUE_FREE
),

2083 
°a_id
, 
ª£rved_txq
, *
°©us
)) {

2084 *
ªt
 = -
EINVAL
;

2085  
åue
;

2088 *
°©us
 = 
IWL_MVM_QUEUE_FREE
;

2091 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
 &&

2092 
mvm_lök
->
≠_°a_id
 =
°a_id
) {

2094 i‡(
vif
->
cfg
.
assoc
)

2095  
åue
;

2098 
	`iwl_mvm_£c_key_ªmove_≠
(
mvm
, 
vif
, 
mvm_lök
, 0);

2101 
mvm_lök
->
≠_°a_id
 = 
IWL_MVM_INVALID_STA
;

2108 i‡(
	`WARN_ON_ONCE
(
mvm
->
tdls_cs
.
≥î
.
°a_id
 == sta_id)) {

2109 
mvm
->
tdls_cs
.
≥î
.
°a_id
 = 
IWL_MVM_INVALID_STA
;

2110 
	`ˇn˚l_dñayed_w‹k
(&
mvm
->
tdls_cs
.
dw‹k
);

2113  
Ál£
;

2114 
	}
}

2116 
	$iwl_mvm_rm_°a
(
iwl_mvm
 *
mvm
,

2117 
õì80211_vif
 *
vif
,

2118 
õì80211_°a
 *
°a
)

2120 
iwl_mvm_°a
 *
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

2121 
ªt
;

2123 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

2125 
ªt
 = 
	`iwl_mvm_døö_°a
(
mvm
, 
mvm_°a
, 
åue
);

2126 i‡(
ªt
)

2127  
ªt
;

2130 
ªt
 = 
	`iwl_mvm_Êush_°a
(
mvm
, 
mvm_°a
->
deÊök
.
°a_id
,

2131 
mvm_°a
->
tfd_queue_msk
);

2132 i‡(
ªt
)

2133  
ªt
;

2134 i‡(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)) {

2135 
ªt
 = 
	`iwl_mvm_waô_°a_queues_em±y
(
mvm
, 
mvm_°a
);

2137 
u32
 
q_mask
 = 
mvm_°a
->
tfd_queue_msk
;

2139 
ªt
 = 
	`iwl_å™s_waô_tx_queues_em±y
(
mvm
->
å™s
,

2140 
q_mask
);

2142 i‡(
ªt
)

2143  
ªt
;

2145 
ªt
 = 
	`iwl_mvm_døö_°a
(
mvm
, 
mvm_°a
, 
Ál£
);

2147 
	`iwl_mvm_dißbÀ_°a_queues
(
mvm
, 
vif
, 
°a
);

2149 i‡(
	`iwl_mvm_°a_dñ
(
mvm
, 
vif
, 
°a
, &°a->
deÊök
, &
ªt
))

2150  
ªt
;

2152 
ªt
 = 
	`iwl_mvm_rm_°a_comm⁄
(
mvm
, 
mvm_°a
->
deÊök
.
°a_id
);

2153 
	`RCU_INIT_POINTER
(
mvm
->
fw_id_to_mac_id
[
mvm_°a
->
deÊök
.
°a_id
], 
NULL
);

2155  
ªt
;

2156 
	}
}

2158 
	$iwl_mvm_rm_°a_id
(
iwl_mvm
 *
mvm
,

2159 
õì80211_vif
 *
vif
,

2160 
u8
 
°a_id
)

2162 
ªt
 = 
	`iwl_mvm_rm_°a_comm⁄
(
mvm
, 
°a_id
);

2164 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

2166 
	`RCU_INIT_POINTER
(
mvm
->
fw_id_to_mac_id
[
°a_id
], 
NULL
);

2167  
ªt
;

2168 
	}
}

2170 
	$iwl_mvm_Æloˇã_öt_°a
(
iwl_mvm
 *
mvm
,

2171 
iwl_mvm_öt_°a
 *
°a
,

2172 
u32
 
qmask
, 
∆80211_i·y≥
 
i·y≥
,

2173 
u8
 
ty≥
)

2175 i‡(!
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
) ||

2176 
°a
->
°a_id
 =
IWL_MVM_INVALID_STA
) {

2177 
°a
->
°a_id
 = 
	`iwl_mvm_föd_‰ì_°a_id
(
mvm
, 
i·y≥
);

2178 i‡(
	`WARN_ON_ONCE
(
°a
->
°a_id
 =
IWL_MVM_INVALID_STA
))

2179  -
ENOSPC
;

2182 
°a
->
tfd_queue_msk
 = 
qmask
;

2183 
°a
->
ty≥
 =Åype;

2186 
	`RCU_INIT_POINTER
(
mvm
->
fw_id_to_mac_id
[
°a
->
°a_id
], 
	`ERR_PTR
(-
EINVAL
));

2188 
	}
}

2190 
	$iwl_mvm_dóŒoc_öt_°a
(
iwl_mvm
 *
mvm
, 
iwl_mvm_öt_°a
 *
°a
)

2192 
	`RCU_INIT_POINTER
(
mvm
->
fw_id_to_mac_id
[
°a
->
°a_id
], 
NULL
);

2193 
	`mem£t
(
°a
, 0, (
iwl_mvm_öt_°a
));

2194 
°a
->
°a_id
 = 
IWL_MVM_INVALID_STA
;

2195 
	}
}

2197 
	$iwl_mvm_íabÀ_aux_¢if_queue
(
iwl_mvm
 *
mvm
, 
u16
 
queue
,

2198 
u8
 
°a_id
, u8 
fifo
)

2200 
wdg_timeout
 =

2201 
mvm
->
å™s
->
å™s_cfg
->
ba£_∑øms
->
wd_timeout
;

2202 
iwl_å™s_txq_scd_cfg
 
cfg
 = {

2203 .
fifo
 = fifo,

2204 .
°a_id
 = sta_id,

2205 .
tid
 = 
IWL_MAX_TID_COUNT
,

2206 .
aggªg©e
 = 
Ál£
,

2207 .
‰ame_limô
 = 
IWL_FRAME_LIMIT
,

2210 
	`WARN_ON
(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
));

2212 
	`iwl_mvm_íabÀ_txq
(
mvm
, 
NULL
, 
queue
, 0, &
cfg
, 
wdg_timeout
);

2213 
	}
}

2215 
	$iwl_mvm_íabÀ_aux_¢if_queue_tvqm
(
iwl_mvm
 *
mvm
, 
u8
 
°a_id
)

2217 
wdg_timeout
 =

2218 
mvm
->
å™s
->
å™s_cfg
->
ba£_∑øms
->
wd_timeout
;

2220 
	`WARN_ON
(!
	`iwl_mvm_has_√w_tx_≠i
(
mvm
));

2222  
	`iwl_mvm_tvqm_íabÀ_txq
(
mvm
, 
NULL
, 
°a_id
, 
IWL_MAX_TID_COUNT
,

2223 
wdg_timeout
);

2224 
	}
}

2226 
	$iwl_mvm_add_öt_°a_wôh_queue
(
iwl_mvm
 *
mvm
, 
macidx
,

2227 
maccﬁ‹
, 
u8
 *
addr
,

2228 
iwl_mvm_öt_°a
 *
°a
,

2229 
u16
 *
queue
, 
fifo
)

2231 
ªt
;

2234 i‡(!
	`iwl_mvm_has_√w_tx_≠i
(
mvm
))

2235 
	`iwl_mvm_íabÀ_aux_¢if_queue
(
mvm
, *
queue
, 
°a
->
°a_id
, 
fifo
);

2237 
ªt
 = 
	`iwl_mvm_add_öt_°a_comm⁄
(
mvm
, 
°a
, 
addr
, 
macidx
, 
maccﬁ‹
);

2238 i‡(
ªt
) {

2239 i‡(!
	`iwl_mvm_has_√w_tx_≠i
(
mvm
))

2240 
	`iwl_mvm_dißbÀ_txq
(
mvm
, 
NULL
, 
°a
->
°a_id
, 
queue
,

2241 
IWL_MAX_TID_COUNT
);

2242  
ªt
;

2249 i‡(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)) {

2250 
txq
;

2252 
txq
 = 
	`iwl_mvm_íabÀ_aux_¢if_queue_tvqm
(
mvm
, 
°a
->
°a_id
);

2253 i‡(
txq
 < 0) {

2254 
	`iwl_mvm_rm_°a_comm⁄
(
mvm
, 
°a
->
°a_id
);

2255  
txq
;

2258 *
queue
 = 
txq
;

2262 
	}
}

2264 
	$iwl_mvm_add_aux_°a
(
iwl_mvm
 *
mvm
, 
u32
 
lmac_id
)

2266 
ªt
;

2267 
u32
 
qmask
 = 
mvm
->
aux_queue
 =
IWL_MVM_INVALID_QUEUE
 ? 0 :

2268 
	`BIT
(
mvm
->
aux_queue
);

2270 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

2273 
ªt
 = 
	`iwl_mvm_Æloˇã_öt_°a
(
mvm
, &mvm->
aux_°a
, 
qmask
,

2274 
NL80211_IFTYPE_UNSPECIFIED
,

2275 
IWL_STA_AUX_ACTIVITY
);

2276 i‡(
ªt
)

2277  
ªt
;

2283 
ªt
 = 
	`iwl_mvm_add_öt_°a_wôh_queue
(
mvm
, 
lmac_id
, 0, 
NULL
,

2284 &
mvm
->
aux_°a
, &mvm->
aux_queue
,

2285 
IWL_MVM_TX_FIFO_MCAST
);

2286 i‡(
ªt
) {

2287 
	`iwl_mvm_dóŒoc_öt_°a
(
mvm
, &mvm->
aux_°a
);

2288  
ªt
;

2292 
	}
}

2294 
	$iwl_mvm_add_¢if_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

2296 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

2298 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

2300  
	`iwl_mvm_add_öt_°a_wôh_queue
(
mvm
, 
mvmvif
->
id
, mvmvif->
cﬁ‹
,

2301 
NULL
, &
mvm
->
¢if_°a
,

2302 &
mvm
->
¢if_queue
,

2303 
IWL_MVM_TX_FIFO_BE
);

2304 
	}
}

2306 
	$iwl_mvm_rm_¢if_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

2308 
ªt
;

2310 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

2312 i‡(
	`WARN_ON_ONCE
(
mvm
->
¢if_°a
.
°a_id
 =
IWL_MVM_INVALID_STA
))

2313  -
EINVAL
;

2315 
	`iwl_mvm_dißbÀ_txq
(
mvm
, 
NULL
, mvm->
¢if_°a
.
°a_id
,

2316 &
mvm
->
¢if_queue
, 
IWL_MAX_TID_COUNT
);

2317 
ªt
 = 
	`iwl_mvm_rm_°a_comm⁄
(
mvm
, mvm->
¢if_°a
.
°a_id
);

2318 i‡(
ªt
)

2319 
	`IWL_WARN
(
mvm
, "Failed sendingÑemove station\n");

2321  
ªt
;

2322 
	}
}

2324 
	$iwl_mvm_rm_aux_°a
(
iwl_mvm
 *
mvm
)

2326 
ªt
;

2328 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

2330 i‡(
	`WARN_ON_ONCE
(
mvm
->
aux_°a
.
°a_id
 =
IWL_MVM_INVALID_STA
))

2331  -
EINVAL
;

2333 
	`iwl_mvm_dißbÀ_txq
(
mvm
, 
NULL
, mvm->
aux_°a
.
°a_id
,

2334 &
mvm
->
aux_queue
, 
IWL_MAX_TID_COUNT
);

2335 
ªt
 = 
	`iwl_mvm_rm_°a_comm⁄
(
mvm
, mvm->
aux_°a
.
°a_id
);

2336 i‡(
ªt
)

2337 
	`IWL_WARN
(
mvm
, "Failed sendingÑemove station\n");

2338 
	`iwl_mvm_dóŒoc_öt_°a
(
mvm
, &mvm->
aux_°a
);

2340  
ªt
;

2341 
	}
}

2343 
	$iwl_mvm_dóŒoc_¢if_°a
(
iwl_mvm
 *
mvm
)

2345 
	`iwl_mvm_dóŒoc_öt_°a
(
mvm
, &mvm->
¢if_°a
);

2346 
	}
}

2356 
	$iwl_mvm_£nd_add_bˇ°_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

2358 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

2359 
iwl_mvm_öt_°a
 *
b°a
 = &
mvmvif
->
deÊök
.
bˇ°_°a
;

2360 c⁄° 
u8
 
_baddr
[] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF};

2361 c⁄° 
u8
 *
baddr
 = 
_baddr
;

2362 
queue
;

2363 
ªt
;

2364 
wdg_timeout
 =

2365 
	`iwl_mvm_gë_wd_timeout
(
mvm
, 
vif
, 
Ál£
, false);

2366 
iwl_å™s_txq_scd_cfg
 
cfg
 = {

2367 .
fifo
 = 
IWL_MVM_TX_FIFO_VO
,

2368 .
°a_id
 = 
mvmvif
->
deÊök
.
bˇ°_°a
.sta_id,

2369 .
tid
 = 
IWL_MAX_TID_COUNT
,

2370 .
aggªg©e
 = 
Ál£
,

2371 .
‰ame_limô
 = 
IWL_FRAME_LIMIT
,

2374 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

2376 i‡(!
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)) {

2377 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
 ||

2378 
vif
->
ty≥
 =
NL80211_IFTYPE_ADHOC
) {

2379 
queue
 = 
mvm
->
¥obe_queue
;

2380 } i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_P2P_DEVICE
) {

2381 
queue
 = 
mvm
->
p2p_dev_queue
;

2383 
	`WARN
(1, "MissingÑequired TXQ forádding bcast STA\n");

2384  -
EINVAL
;

2387 
b°a
->
tfd_queue_msk
 |
	`BIT
(
queue
);

2389 
	`iwl_mvm_íabÀ_txq
(
mvm
, 
NULL
, 
queue
, 0, &
cfg
, 
wdg_timeout
);

2392 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_ADHOC
)

2393 
baddr
 = 
vif
->
bss_c⁄f
.
bssid
;

2395 i‡(
	`WARN_ON_ONCE
(
b°a
->
°a_id
 =
IWL_MVM_INVALID_STA
))

2396  -
ENOSPC
;

2398 
ªt
 = 
	`iwl_mvm_add_öt_°a_comm⁄
(
mvm
, 
b°a
, 
baddr
,

2399 
mvmvif
->
id
, mvmvif->
cﬁ‹
);

2400 i‡(
ªt
)

2401  
ªt
;

2407 i‡(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)) {

2408 
queue
 = 
	`iwl_mvm_tvqm_íabÀ_txq
(
mvm
, 
NULL
, 
b°a
->
°a_id
,

2409 
IWL_MAX_TID_COUNT
,

2410 
wdg_timeout
);

2411 i‡(
queue
 < 0) {

2412 
	`iwl_mvm_rm_°a_comm⁄
(
mvm
, 
b°a
->
°a_id
);

2413  
queue
;

2416 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
 ||

2417 
vif
->
ty≥
 =
NL80211_IFTYPE_ADHOC
) {

2419 
mvm
->
¥obe_queue
 = 
queue
;

2421 
mvmvif
->
deÊök
.
mgmt_queue
 = 
queue
;

2422 } i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_P2P_DEVICE
) {

2423 
mvm
->
p2p_dev_queue
 = 
queue
;

2425 } i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
 ||

2426 
vif
->
ty≥
 =
NL80211_IFTYPE_ADHOC
) {

2428 
mvmvif
->
deÊök
.
mgmt_queue
 = 
mvm
->
¥obe_queue
;

2432 
	}
}

2434 
	$iwl_mvm_‰ì_bˇ°_°a_queues
(
iwl_mvm
 *
mvm
,

2435 
õì80211_vif
 *
vif
)

2437 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

2438 
u16
 *
queuïå
, 
queue
;

2440 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

2442 
	`iwl_mvm_Êush_°a
(
mvm
, 
mvmvif
->
deÊök
.
bˇ°_°a
.
°a_id
,

2443 
mvmvif
->
deÊök
.
bˇ°_°a
.
tfd_queue_msk
);

2445 
vif
->
ty≥
) {

2446 
NL80211_IFTYPE_AP
:

2447 
NL80211_IFTYPE_ADHOC
:

2448 
queuïå
 = &
mvm
->
¥obe_queue
;

2450 
NL80211_IFTYPE_P2P_DEVICE
:

2451 
queuïå
 = &
mvm
->
p2p_dev_queue
;

2454 
	`WARN
(1, "Can't free bcast queue on vifÅype %d\n",

2455 
vif
->
ty≥
);

2459 
queue
 = *
queuïå
;

2460 
	`iwl_mvm_dißbÀ_txq
(
mvm
, 
NULL
, 
mvmvif
->
deÊök
.
bˇ°_°a
.
°a_id
,

2461 
queuïå
, 
IWL_MAX_TID_COUNT
);

2463 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
 || vif->ty≥ =
NL80211_IFTYPE_ADHOC
)

2464 
mvmvif
->
deÊök
.
mgmt_queue
 = 
mvm
->
¥obe_queue
;

2466 i‡(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
))

2469 
	`WARN_ON
(!(
mvmvif
->
deÊök
.
bˇ°_°a
.
tfd_queue_msk
 & 
	`BIT
(
queue
)));

2470 
mvmvif
->
deÊök
.
bˇ°_°a
.
tfd_queue_msk
 &~
	`BIT
(
queue
);

2471 
	}
}

2475 
	$iwl_mvm_£nd_rm_bˇ°_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

2477 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

2478 
ªt
;

2480 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

2482 
	`iwl_mvm_‰ì_bˇ°_°a_queues
(
mvm
, 
vif
);

2484 
ªt
 = 
	`iwl_mvm_rm_°a_comm⁄
(
mvm
, 
mvmvif
->
deÊök
.
bˇ°_°a
.
°a_id
);

2485 i‡(
ªt
)

2486 
	`IWL_WARN
(
mvm
, "Failed sendingÑemove station\n");

2487  
ªt
;

2488 
	}
}

2490 
	$iwl_mvm_Æloc_bˇ°_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

2492 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

2494 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

2496  
	`iwl_mvm_Æloˇã_öt_°a
(
mvm
, &
mvmvif
->
deÊök
.
bˇ°_°a
, 0,

2497 
	`õì80211_vif_ty≥_p2p
(
vif
),

2498 
IWL_STA_GENERAL_PURPOSE
);

2499 
	}
}

2508 
	$iwl_mvm_add_p2p_bˇ°_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

2510 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

2511 
iwl_mvm_öt_°a
 *
b°a
 = &
mvmvif
->
deÊök
.
bˇ°_°a
;

2512 
ªt
;

2514 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

2516 
ªt
 = 
	`iwl_mvm_Æloc_bˇ°_°a
(
mvm
, 
vif
);

2517 i‡(
ªt
)

2518  
ªt
;

2520 
ªt
 = 
	`iwl_mvm_£nd_add_bˇ°_°a
(
mvm
, 
vif
);

2522 i‡(
ªt
)

2523 
	`iwl_mvm_dóŒoc_öt_°a
(
mvm
, 
b°a
);

2525  
ªt
;

2526 
	}
}

2528 
	$iwl_mvm_dóŒoc_bˇ°_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

2530 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

2532 
	`iwl_mvm_dóŒoc_öt_°a
(
mvm
, &
mvmvif
->
deÊök
.
bˇ°_°a
);

2533 
	}
}

2539 
	$iwl_mvm_rm_p2p_bˇ°_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

2541 
ªt
;

2543 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

2545 
ªt
 = 
	`iwl_mvm_£nd_rm_bˇ°_°a
(
mvm
, 
vif
);

2547 
	`iwl_mvm_dóŒoc_bˇ°_°a
(
mvm
, 
vif
);

2549  
ªt
;

2550 
	}
}

2560 
	$iwl_mvm_add_mˇ°_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

2562 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

2563 
iwl_mvm_öt_°a
 *
m°a
 = &
mvmvif
->
deÊök
.
mˇ°_°a
;

2564 c⁄° 
u8
 
_maddr
[] = {0x03, 0x00, 0x00, 0x00, 0x00, 0x00};

2565 c⁄° 
u8
 *
maddr
 = 
_maddr
;

2566 
iwl_å™s_txq_scd_cfg
 
cfg
 = {

2567 .
fifo
 = 
vif
->
ty≥
 =
NL80211_IFTYPE_AP
 ?

2568 
IWL_MVM_TX_FIFO_MCAST
 : 
IWL_MVM_TX_FIFO_BE
,

2569 .
°a_id
 = 
m°a
->sta_id,

2570 .
tid
 = 0,

2571 .
aggªg©e
 = 
Ál£
,

2572 .
‰ame_limô
 = 
IWL_FRAME_LIMIT
,

2574 
timeout
 = 
	`iwl_mvm_gë_wd_timeout
(
mvm
, 
vif
, 
Ál£
, false);

2575 
ªt
;

2577 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

2579 i‡(
	`WARN_ON
(
vif
->
ty≥
 !
NL80211_IFTYPE_AP
 &&

2580 
vif
->
ty≥
 !
NL80211_IFTYPE_ADHOC
))

2581  -
EOPNOTSUPP
;

2589 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_ADHOC
)

2590 
mvmvif
->
deÊök
.
ˇb_queue
 = 
IWL_MVM_DQA_GCAST_QUEUE
;

2596 i‡(!
	`iwl_mvm_has_√w_tx_≠i
(
mvm
) &&

2597 
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_API_STA_TYPE
)) {

2598 
	`iwl_mvm_íabÀ_txq
(
mvm
, 
NULL
, 
mvmvif
->
deÊök
.
ˇb_queue
, 0,

2599 &
cfg
,

2600 
timeout
);

2601 
m°a
->
tfd_queue_msk
 |
	`BIT
(
mvmvif
->
deÊök
.
ˇb_queue
);

2603 
ªt
 = 
	`iwl_mvm_add_öt_°a_comm⁄
(
mvm
, 
m°a
, 
maddr
,

2604 
mvmvif
->
id
, mvmvif->
cﬁ‹
);

2605 i‡(
ªt
)

2606 
îr
;

2615 i‡(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)) {

2616 
queue
 = 
	`iwl_mvm_tvqm_íabÀ_txq
(
mvm
, 
NULL
, 
m°a
->
°a_id
,

2617 0, 
timeout
);

2618 i‡(
queue
 < 0) {

2619 
ªt
 = 
queue
;

2620 
îr
;

2622 
mvmvif
->
deÊök
.
ˇb_queue
 = 
queue
;

2623 } i‡(!
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

2624 
IWL_UCODE_TLV_API_STA_TYPE
))

2625 
	`iwl_mvm_íabÀ_txq
(
mvm
, 
NULL
, 
mvmvif
->
deÊök
.
ˇb_queue
, 0,

2626 &
cfg
,

2627 
timeout
);

2630 
îr
:

2631 
	`iwl_mvm_dóŒoc_öt_°a
(
mvm
, 
m°a
);

2632  
ªt
;

2633 
	}
}

2635 
	$__iwl_mvm_ªmove_°a_key
(
iwl_mvm
 *
mvm
, 
u8
 
°a_id
,

2636 
õì80211_key_c⁄f
 *
keyc⁄f
,

2637 
boﬁ
 
mˇ°
)

2640 
iwl_mvm_add_°a_key_cmd_v1
 
cmd_v1
;

2641 
iwl_mvm_add_°a_key_cmd
 
cmd
;

2642 } 
u
 = {};

2643 
boﬁ
 
√w_≠i
 = 
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

2644 
IWL_UCODE_TLV_API_TKIP_MIC_KEYS
);

2645 
__À16
 
key_Êags
;

2646 
ªt
, 
size
;

2647 
u32
 
°©us
;

2650 i‡(
°a_id
 =
IWL_MVM_INVALID_STA
)

2653 
key_Êags
 = 
	`˝u_to_À16
((
keyc⁄f
->
keyidx
 << 
STA_KEY_FLG_KEYID_POS
) &

2654 
STA_KEY_FLG_KEYID_MSK
);

2655 
key_Êags
 |
	`˝u_to_À16
(
STA_KEY_FLG_NO_ENC
 | 
STA_KEY_FLG_WEP_KEY_MAP
);

2656 
key_Êags
 |
	`˝u_to_À16
(
STA_KEY_NOT_VALID
);

2658 i‡(
mˇ°
)

2659 
key_Êags
 |
	`˝u_to_À16
(
STA_KEY_MULTICAST
);

2665 
u
.
cmd
.
comm⁄
.
key_Êags
 = key_flags;

2666 
u
.
cmd
.
comm⁄
.
key_off£t
 = 
keyc⁄f
->
hw_key_idx
;

2667 
u
.
cmd
.
comm⁄
.
°a_id
 = sta_id;

2669 
size
 = 
√w_≠i
 ? (
u
.
cmd
Ë: (u.
cmd_v1
);

2671 
°©us
 = 
ADD_STA_SUCCESS
;

2672 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu_°©us
(
mvm
, 
ADD_STA_KEY
, 
size
, &
u
.
cmd
,

2673 &
°©us
);

2675 
°©us
) {

2676 
ADD_STA_SUCCESS
:

2677 
	`IWL_DEBUG_WEP
(
mvm
, "MODIFY_STA:Ñemove sta keyÖassed\n");

2680 
ªt
 = -
EIO
;

2681 
	`IWL_ERR
(
mvm
, "MODIFY_STA:Ñemove sta key failed\n");

2685  
ªt
;

2686 
	}
}

2692 
	$iwl_mvm_rm_mˇ°_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

2694 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

2695 
ªt
;

2697 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

2699 
	`iwl_mvm_Êush_°a
(
mvm
, 
mvmvif
->
deÊök
.
mˇ°_°a
.
°a_id
,

2700 
mvmvif
->
deÊök
.
mˇ°_°a
.
tfd_queue_msk
);

2702 
	`iwl_mvm_dißbÀ_txq
(
mvm
, 
NULL
, 
mvmvif
->
deÊök
.
mˇ°_°a
.
°a_id
,

2703 &
mvmvif
->
deÊök
.
ˇb_queue
, 0);

2705 
ªt
 = 
	`iwl_mvm_rm_°a_comm⁄
(
mvm
, 
mvmvif
->
deÊök
.
mˇ°_°a
.
°a_id
);

2706 i‡(
ªt
)

2707 
	`IWL_WARN
(
mvm
, "Failed sendingÑemove station\n");

2709  
ªt
;

2710 
	}
}

2712 
	$iwl_mvm_sync_rxq_dñ_ba
(
iwl_mvm
 *
mvm
, 
u8
 
baid
)

2714 
iwl_mvm_dñba_d©a
 
nŸif
 = {

2715 .
baid
 = baid,

2718 
	`iwl_mvm_sync_rx_queues_öã∫Æ
(
mvm
, 
IWL_MVM_RXQ_NOTIF_DEL_BA
, 
åue
,

2719 &
nŸif
, (notif));

2720 
	}
};

2722 
	$iwl_mvm_‰ì_ª‹dî
(
iwl_mvm
 *
mvm
,

2723 
iwl_mvm_baid_d©a
 *
d©a
)

2725 
i
;

2727 
	`iwl_mvm_sync_rxq_dñ_ba
(
mvm
, 
d©a
->
baid
);

2729 
i
 = 0; i < 
mvm
->
å™s
->
num_rx_queues
; i++) {

2730 
j
;

2731 
iwl_mvm_ª‹dî_buf„r
 *
ª‹dî_buf
 =

2732 &
d©a
->
ª‹dî_buf
[
i
];

2733 
iwl_mvm_ª‹dî_buf_íåy
 *
íåõs
 =

2734 &
d©a
->
íåõs
[
i
 * d©a->
íåõs_≥r_queue
];

2736 
	`•ö_lock_bh
(&
ª‹dî_buf
->
lock
);

2737 i‡(
	`likñy
(!
ª‹dî_buf
->
num_°‹ed
)) {

2738 
	`•ö_u∆ock_bh
(&
ª‹dî_buf
->
lock
);

2747 
	`WARN_ON
(1);

2749 
j
 = 0; j < 
ª‹dî_buf
->
buf_size
; j++)

2750 
	`__skb_queue_purge
(&
íåõs
[
j
].
‰ames
);

2752 
	`•ö_u∆ock_bh
(&
ª‹dî_buf
->
lock
);

2754 
	}
}

2756 
	$iwl_mvm_öô_ª‹dî_buf„r
(
iwl_mvm
 *
mvm
,

2757 
iwl_mvm_baid_d©a
 *
d©a
,

2758 
u16
 
s¢
, u16 
buf_size
)

2760 
i
;

2762 
i
 = 0; i < 
mvm
->
å™s
->
num_rx_queues
; i++) {

2763 
iwl_mvm_ª‹dî_buf„r
 *
ª‹dî_buf
 =

2764 &
d©a
->
ª‹dî_buf
[
i
];

2765 
iwl_mvm_ª‹dî_buf_íåy
 *
íåõs
 =

2766 &
d©a
->
íåõs
[
i
 * d©a->
íåõs_≥r_queue
];

2767 
j
;

2769 
ª‹dî_buf
->
num_°‹ed
 = 0;

2770 
ª‹dî_buf
->
hód_¢
 = 
s¢
;

2771 
ª‹dî_buf
->
buf_size
 = buf_size;

2772 
	`•ö_lock_öô
(&
ª‹dî_buf
->
lock
);

2773 
ª‹dî_buf
->
mvm
 = mvm;

2774 
ª‹dî_buf
->
queue
 = 
i
;

2775 
ª‹dî_buf
->
vÆid
 = 
Ál£
;

2776 
j
 = 0; j < 
ª‹dî_buf
->
buf_size
; j++)

2777 
	`__skb_queue_hód_öô
(&
íåõs
[
j
].
‰ames
);

2779 
	}
}

2781 
	$iwl_mvm_fw_baid_›_°a
(
iwl_mvm
 *
mvm
,

2782 
õì80211_°a
 *
°a
,

2783 
boﬁ
 
°¨t
, 
tid
, 
u16
 
s¢
,

2784 
u16
 
buf_size
)

2786 
iwl_mvm_°a
 *
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

2787 
iwl_mvm_add_°a_cmd
 
cmd
 = {

2788 .
mac_id_n_cﬁ‹
 = 
	`˝u_to_À32
(
mvm_°a
->mac_id_n_color),

2789 .
°a_id
 = 
mvm_°a
->
deÊök
.sta_id,

2790 .
add_modify
 = 
STA_MODE_MODIFY
,

2792 
u32
 
°©us
;

2793 
ªt
;

2795 i‡(
°¨t
) {

2796 
cmd
.
add_immedüã_ba_tid
 = 
tid
;

2797 
cmd
.
add_immedüã_ba_s¢
 = 
	`˝u_to_À16
(
s¢
);

2798 
cmd
.
rx_ba_wödow
 = 
	`˝u_to_À16
(
buf_size
);

2799 
cmd
.
modify_mask
 = 
STA_MODIFY_ADD_BA_TID
;

2801 
cmd
.
ªmove_immedüã_ba_tid
 = 
tid
;

2802 
cmd
.
modify_mask
 = 
STA_MODIFY_REMOVE_BA_TID
;

2805 
°©us
 = 
ADD_STA_SUCCESS
;

2806 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu_°©us
(
mvm
, 
ADD_STA
,

2807 
	`iwl_mvm_add_°a_cmd_size
(
mvm
),

2808 &
cmd
, &
°©us
);

2809 i‡(
ªt
)

2810  
ªt
;

2812 
°©us
 & 
IWL_ADD_STA_STATUS_MASK
) {

2813 
ADD_STA_SUCCESS
:

2814 
	`IWL_DEBUG_HT
(
mvm
, "RX BA Session %sed in fw\n",

2815 
°¨t
 ? "start" : "stopp");

2816 i‡(
	`WARN_ON
(
°¨t
 && 
	`iwl_mvm_has_√w_rx_≠i
(
mvm
) &&

2817 !(
°©us
 & 
IWL_ADD_STA_BAID_VALID_MASK
)))

2818  -
EINVAL
;

2819  
	`u32_gë_bôs
(
°©us
, 
IWL_ADD_STA_BAID_MASK
);

2820 
ADD_STA_IMMEDIATE_BA_FAILURE
:

2821 
	`IWL_WARN
(
mvm
, "RX BA SessionÑefused by fw\n");

2822  -
ENOSPC
;

2824 
	`IWL_ERR
(
mvm
, "RX BA Session failed %sing, status 0x%x\n",

2825 
°¨t
 ? "°¨t" : "°›p", 
°©us
);

2826  -
EIO
;

2828 
	}
}

2830 
	$iwl_mvm_fw_baid_›_cmd
(
iwl_mvm
 *
mvm
,

2831 
õì80211_°a
 *
°a
,

2832 
boﬁ
 
°¨t
, 
tid
, 
u16
 
s¢
,

2833 
u16
 
buf_size
, 
baid
)

2835 
iwl_rx_baid_cfg_cmd
 
cmd
 = {

2836 .
a˘i⁄
 = 
°¨t
 ? 
	`˝u_to_À32
(
IWL_RX_BAID_ACTION_ADD
) :

2837 
	`˝u_to_À32
(
IWL_RX_BAID_ACTION_REMOVE
),

2839 
u32
 
cmd_id
 = 
	`WIDE_ID
(
DATA_PATH_GROUP
, 
RX_BAID_ALLOCATION_CONFIG_CMD
);

2840 
ªt
;

2842 
	`BUILD_BUG_ON
((
iwl_rx_baid_cfg_ª•
Ë!(
baid
));

2844 i‡(
°¨t
) {

2845 
cmd
.
Æloc
.
°a_id_mask
 =

2846 
	`˝u_to_À32
(
	`iwl_mvm_°a_fw_id_mask
(
mvm
, 
°a
, -1));

2847 
cmd
.
Æloc
.
tid
 =Åid;

2848 
cmd
.
Æloc
.
s¢
 = 
	`˝u_to_À16
(ssn);

2849 
cmd
.
Æloc
.
wö_size
 = 
	`˝u_to_À16
(
buf_size
);

2850 
baid
 = -
EIO
;

2851 } i‡(
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
cmd_id
, 1) == 1) {

2852 
cmd
.
ªmove_v1
.
baid
 = 
	`˝u_to_À32
(baid);

2853 
	`BUILD_BUG_ON
((
cmd
.
ªmove_v1
Ë> (cmd.
ªmove
));

2855 
cmd
.
ªmove
.
°a_id_mask
 =

2856 
	`˝u_to_À32
(
	`iwl_mvm_°a_fw_id_mask
(
mvm
, 
°a
, -1));

2857 
cmd
.
ªmove
.
tid
 = 
	`˝u_to_À32
(tid);

2860 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu_°©us
(
mvm
, 
cmd_id
, (
cmd
),

2861 &
cmd
, &
baid
);

2862 i‡(
ªt
)

2863  
ªt
;

2865 i‡(!
°¨t
) {

2867 
baid
 = 0;

2870 
	`IWL_DEBUG_HT
(
mvm
, "RX BA Session %sed in fw\n",

2871 
°¨t
 ? "start" : "stopp");

2873 i‡(
baid
 < 0 || baid >
	`ARRAY_SIZE
(
mvm
->
baid_m≠
))

2874  -
EINVAL
;

2876  
baid
;

2877 
	}
}

2879 
	$iwl_mvm_fw_baid_›
(
iwl_mvm
 *
mvm
, 
õì80211_°a
 *
°a
,

2880 
boﬁ
 
°¨t
, 
tid
, 
u16
 
s¢
, u16 
buf_size
,

2881 
baid
)

2883 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

2884 
IWL_UCODE_TLV_CAPA_BAID_ML_SUPPORT
))

2885  
	`iwl_mvm_fw_baid_›_cmd
(
mvm
, 
°a
, 
°¨t
,

2886 
tid
, 
s¢
, 
buf_size
, 
baid
);

2888  
	`iwl_mvm_fw_baid_›_°a
(
mvm
, 
°a
, 
°¨t
,

2889 
tid
, 
s¢
, 
buf_size
);

2890 
	}
}

2892 
	$iwl_mvm_°a_rx_agg
(
iwl_mvm
 *
mvm
, 
õì80211_°a
 *
°a
,

2893 
tid
, 
u16
 
s¢
, 
boﬁ
 
°¨t
, u16 
buf_size
, u16 
timeout
)

2895 
iwl_mvm_°a
 *
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

2896 
iwl_mvm_baid_d©a
 *
baid_d©a
 = 
NULL
;

2897 
ªt
, 
baid
;

2898 
u32
 
max_ba_id_£ssi⁄s
 = 
	`iwl_mvm_has_√w_tx_≠i
(
mvm
Ë? 
IWL_MAX_BAID
 :

2899 
IWL_MAX_BAID_OLD
;

2901 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

2903 i‡(
°¨t
 && 
mvm
->
rx_ba_£ssi⁄s
 >
max_ba_id_£ssi⁄s
) {

2904 
	`IWL_WARN
(
mvm
, "NotÉnough RX BA SESSIONS\n");

2905  -
ENOSPC
;

2908 i‡(
	`iwl_mvm_has_√w_rx_≠i
(
mvm
Ë&& 
°¨t
) {

2909 
u32
 
ª‹dî_buf_size
 = 
buf_size
 * (
baid_d©a
->
íåõs
[0]);

2912 #i‚de‡
__CHECKER__


2919 
	`BUILD_BUG_ON
(
SMP_CACHE_BYTES
 % (
baid_d©a
->
íåõs
[0]) &&

2920 (
baid_d©a
->
íåõs
[0]Ë% 
SMP_CACHE_BYTES
);

2928 
ª‹dî_buf_size
 = 
	`ALIGN
‘e‹dî_buf_size, 
SMP_CACHE_BYTES
);

2934 
baid_d©a
 = 
	`kzÆloc
((*baid_data) +

2935 
mvm
->
å™s
->
num_rx_queues
 *

2936 
ª‹dî_buf_size
,

2937 
GFP_KERNEL
);

2938 i‡(!
baid_d©a
)

2939  -
ENOMEM
;

2945 
baid_d©a
->
íåõs_≥r_queue
 =

2946 
ª‹dî_buf_size
 / (
baid_d©a
->
íåõs
[0]);

2949 i‡(
	`iwl_mvm_has_√w_rx_≠i
(
mvm
Ë&& !
°¨t
) {

2950 
baid
 = 
mvm_°a
->
tid_to_baid
[
tid
];

2953 
baid
 = -1;

2957 i‡(
°¨t
 || !
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
))

2958 
baid
 = 
	`iwl_mvm_fw_baid_›
(
mvm
, 
°a
, 
°¨t
, 
tid
, 
s¢
, 
buf_size
,

2959 
baid
);

2961 i‡(
baid
 < 0) {

2962 
ªt
 = 
baid
;

2963 
out_‰ì
;

2966 i‡(
°¨t
) {

2967 
mvm
->
rx_ba_£ssi⁄s
++;

2969 i‡(!
	`iwl_mvm_has_√w_rx_≠i
(
mvm
))

2972 
baid_d©a
->
baid
 = baid;

2973 
baid_d©a
->
timeout
 =Åimeout;

2974 
baid_d©a
->
œ°_rx
 = 
jiffõs
;

2975 
baid_d©a
->
rcu_±r
 = &
mvm
->
baid_m≠
[
baid
];

2976 
	`timî_£tup
(&
baid_d©a
->
£ssi⁄_timî
,

2977 
iwl_mvm_rx_agg_£ssi⁄_expúed
, 0);

2978 
baid_d©a
->
mvm
 = mvm;

2979 
baid_d©a
->
tid
 =Åid;

2980 
baid_d©a
->
°a_mask
 = 
	`iwl_mvm_°a_fw_id_mask
(
mvm
, 
°a
, -1);

2982 
mvm_°a
->
tid_to_baid
[
tid
] = 
baid
;

2983 i‡(
timeout
)

2984 
	`mod_timî
(&
baid_d©a
->
£ssi⁄_timî
,

2985 
	`TU_TO_EXP_TIME
(
timeout
 * 2));

2987 
	`iwl_mvm_öô_ª‹dî_buf„r
(
mvm
, 
baid_d©a
, 
s¢
, 
buf_size
);

2994 
	`IWL_DEBUG_HT
(
mvm
, "Sta %d(%d) isássignedÅo BAID %d\n",

2995 
mvm_°a
->
deÊök
.
°a_id
, 
tid
, 
baid
);

2996 
	`WARN_ON
(
	`rcu_ac˚ss_poöãr
(
mvm
->
baid_m≠
[
baid
]));

2997 
	`rcu_assign_poöãr
(
mvm
->
baid_m≠
[
baid
], 
baid_d©a
);

2999 
baid
 = 
mvm_°a
->
tid_to_baid
[
tid
];

3001 i‡(
mvm
->
rx_ba_£ssi⁄s
 > 0)

3003 
mvm
->
rx_ba_£ssi⁄s
--;

3004 i‡(!
	`iwl_mvm_has_√w_rx_≠i
(
mvm
))

3007 i‡(
	`WARN_ON
(
baid
 =
IWL_RX_REORDER_DATA_INVALID_BAID
))

3008  -
EINVAL
;

3010 
baid_d©a
 = 
	`rcu_ac˚ss_poöãr
(
mvm
->
baid_m≠
[
baid
]);

3011 i‡(
	`WARN_ON
(!
baid_d©a
))

3012  -
EINVAL
;

3015 
	`iwl_mvm_‰ì_ª‹dî
(
mvm
, 
baid_d©a
);

3016 
	`timî_shutdown_sync
(&
baid_d©a
->
£ssi⁄_timî
);

3017 
	`RCU_INIT_POINTER
(
mvm
->
baid_m≠
[
baid
], 
NULL
);

3018 
	`k‰ì_rcu
(
baid_d©a
, 
rcu_hód
);

3019 
	`IWL_DEBUG_HT
(
mvm
, "BAID %d i†‰ì\n", 
baid
);

3023 
out_‰ì
:

3024 
	`k‰ì
(
baid_d©a
);

3025  
ªt
;

3026 
	}
}

3028 
	$iwl_mvm_°a_tx_agg
(
iwl_mvm
 *
mvm
, 
õì80211_°a
 *
°a
,

3029 
tid
, 
u8
 
queue
, 
boﬁ
 
°¨t
)

3031 
iwl_mvm_°a
 *
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

3032 
iwl_mvm_add_°a_cmd
 
cmd
 = {};

3033 
ªt
;

3034 
u32
 
°©us
;

3036 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

3038 i‡(
°¨t
) {

3039 
mvm_°a
->
tfd_queue_msk
 |
	`BIT
(
queue
);

3040 
mvm_°a
->
tid_dißbÀ_agg
 &~
	`BIT
(
tid
);

3043 
mvm_°a
->
tid_dißbÀ_agg
 |
	`BIT
(
tid
);

3046 
cmd
.
mac_id_n_cﬁ‹
 = 
	`˝u_to_À32
(
mvm_°a
->mac_id_n_color);

3047 
cmd
.
°a_id
 = 
mvm_°a
->
deÊök
.sta_id;

3048 
cmd
.
add_modify
 = 
STA_MODE_MODIFY
;

3049 i‡(!
	`iwl_mvm_has_√w_tx_≠i
(
mvm
))

3050 
cmd
.
modify_mask
 = 
STA_MODIFY_QUEUES
;

3051 
cmd
.
modify_mask
 |
STA_MODIFY_TID_DISABLE_TX
;

3052 
cmd
.
tfd_queue_msk
 = 
	`˝u_to_À32
(
mvm_°a
->tfd_queue_msk);

3053 
cmd
.
tid_dißbÀ_tx
 = 
	`˝u_to_À16
(
mvm_°a
->
tid_dißbÀ_agg
);

3055 
°©us
 = 
ADD_STA_SUCCESS
;

3056 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu_°©us
(
mvm
, 
ADD_STA
,

3057 
	`iwl_mvm_add_°a_cmd_size
(
mvm
),

3058 &
cmd
, &
°©us
);

3059 i‡(
ªt
)

3060  
ªt
;

3062 
°©us
 & 
IWL_ADD_STA_STATUS_MASK
) {

3063 
ADD_STA_SUCCESS
:

3066 
ªt
 = -
EIO
;

3067 
	`IWL_ERR
(
mvm
, "TX BA Session failed %sing, status 0x%x\n",

3068 
°¨t
 ? "°¨t" : "°›p", 
°©us
);

3072  
ªt
;

3073 
	}
}

3075 c⁄° 
u8
 
	gtid_to_mac80211_ac
[] = {

3076 
IEEE80211_AC_BE
,

3077 
IEEE80211_AC_BK
,

3078 
IEEE80211_AC_BK
,

3079 
IEEE80211_AC_BE
,

3080 
IEEE80211_AC_VI
,

3081 
IEEE80211_AC_VI
,

3082 
IEEE80211_AC_VO
,

3083 
IEEE80211_AC_VO
,

3084 
IEEE80211_AC_VO
,

3087 c⁄° 
u8
 
	gtid_to_ucode_ac
[] = {

3088 
AC_BE
,

3089 
AC_BK
,

3090 
AC_BK
,

3091 
AC_BE
,

3092 
AC_VI
,

3093 
AC_VI
,

3094 
AC_VO
,

3095 
AC_VO
,

3098 
	$iwl_mvm_°a_tx_agg_°¨t
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

3099 
õì80211_°a
 *
°a
, 
u16
 
tid
, u16 *
s¢
)

3101 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

3102 
iwl_mvm_tid_d©a
 *
tid_d©a
;

3103 
u16
 
n‹mÆized_s¢
;

3104 
u16
 
txq_id
;

3105 
ªt
;

3107 i‡(
	`WARN_ON_ONCE
(
tid
 >
IWL_MAX_TID_COUNT
))

3108  -
EINVAL
;

3110 i‡(
mvm°a
->
tid_d©a
[
tid
].
°©e
 !
IWL_AGG_QUEUED
 &&

3111 
mvm°a
->
tid_d©a
[
tid
].
°©e
 !
IWL_AGG_OFF
) {

3112 
	`IWL_ERR
(
mvm
,

3114 
mvm°a
->
tid_d©a
[
tid
].
°©e
);

3115  -
ENXIO
;

3118 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

3120 i‡(
mvm°a
->
tid_d©a
[
tid
].
txq_id
 =
IWL_MVM_INVALID_QUEUE
 &&

3121 
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)) {

3122 
u8
 
ac
 = 
tid_to_mac80211_ac
[
tid
];

3124 
ªt
 = 
	`iwl_mvm_°a_Æloc_queue_tvqm
(
mvm
, 
°a
, 
ac
, 
tid
);

3125 i‡(
ªt
)

3126  
ªt
;

3129 
	`•ö_lock_bh
(&
mvm°a
->
lock
);

3137 
txq_id
 = 
mvm°a
->
tid_d©a
[
tid
].txq_id;

3138 i‡(
txq_id
 =
IWL_MVM_INVALID_QUEUE
) {

3139 
ªt
 = 
	`iwl_mvm_föd_‰ì_queue
(
mvm
, 
mvm°a
->
deÊök
.
°a_id
,

3140 
IWL_MVM_DQA_MIN_DATA_QUEUE
,

3141 
IWL_MVM_DQA_MAX_DATA_QUEUE
);

3142 i‡(
ªt
 < 0) {

3143 
	`IWL_ERR
(
mvm
, "FailedÅoállocateágg queue\n");

3144 
out
;

3147 
txq_id
 = 
ªt
;

3150 
mvm
->
queue_öfo
[
txq_id
].
°©us
 = 
IWL_MVM_QUEUE_RESERVED
;

3151 } i‡(
	`WARN_ON
(
txq_id
 >
IWL_MAX_HW_QUEUES
)) {

3152 
ªt
 = -
ENXIO
;

3153 
	`IWL_ERR
(
mvm
, "tid_id %d out ofÑange (0, %d)!\n",

3154 
tid
, 
IWL_MAX_HW_QUEUES
 - 1);

3155 
out
;

3157 } i‡(
	`u∆ikñy
(
mvm
->
queue_öfo
[
txq_id
].
°©us
 ==

3158 
IWL_MVM_QUEUE_SHARED
)) {

3159 
ªt
 = -
ENXIO
;

3160 
	`IWL_DEBUG_TX_QUEUES
(
mvm
,

3162 
tid
);

3163 
out
;

3166 
	`IWL_DEBUG_TX_QUEUES
(
mvm
,

3168 
tid
, 
txq_id
);

3170 
tid_d©a
 = &
mvm°a
->tid_d©a[
tid
];

3171 
tid_d©a
->
s¢
 = 
	`IEEE80211_SEQ_TO_SN
—id_d©a->
£q_numbî
);

3172 
tid_d©a
->
txq_id
 =Åxq_id;

3173 *
s¢
 = 
tid_d©a
->ssn;

3175 
	`IWL_DEBUG_TX_QUEUES
(
mvm
,

3177 
mvm°a
->
deÊök
.
°a_id
, 
tid
, 
txq_id
,

3178 
tid_d©a
->
s¢
,

3179 
tid_d©a
->
√xt_ª˛aimed
);

3185 
n‹mÆized_s¢
 = 
tid_d©a
->
s¢
;

3186 i‡(
mvm
->
å™s
->
å™s_cfg
->
gí2
)

3187 
n‹mÆized_s¢
 &= 0xff;

3189 i‡(
n‹mÆized_s¢
 =
tid_d©a
->
√xt_ª˛aimed
) {

3190 
tid_d©a
->
°©e
 = 
IWL_AGG_STARTING
;

3191 
ªt
 = 
IEEE80211_AMPDU_TX_START_IMMEDIATE
;

3193 
tid_d©a
->
°©e
 = 
IWL_EMPTYING_HW_QUEUE_ADDBA
;

3194 
ªt
 = 
IEEE80211_AMPDU_TX_START_DELAY_ADDBA
;

3197 
out
:

3198 
	`•ö_u∆ock_bh
(&
mvm°a
->
lock
);

3200  
ªt
;

3201 
	}
}

3203 
	$iwl_mvm_°a_tx_agg_›î
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

3204 
õì80211_°a
 *
°a
, 
u16
 
tid
, u16 
buf_size
,

3205 
boﬁ
 
amsdu
)

3207 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

3208 
iwl_mvm_tid_d©a
 *
tid_d©a
 = &
mvm°a
->tid_d©a[
tid
];

3209 
wdg_timeout
 =

3210 
	`iwl_mvm_gë_wd_timeout
(
mvm
, 
vif
, 
°a
->
tdls
, 
Ál£
);

3211 
queue
, 
ªt
;

3212 
boﬁ
 
Æloc_queue
 = 
åue
;

3213 
iwl_mvm_queue_°©us
 
queue_°©us
;

3214 
u16
 
s¢
;

3216 
iwl_å™s_txq_scd_cfg
 
cfg
 = {

3217 .
°a_id
 = 
mvm°a
->
deÊök
.sta_id,

3218 .
tid
 =Åid,

3219 .
‰ame_limô
 = 
buf_size
,

3220 .
aggªg©e
 = 
åue
,

3227 i‡(
	`WARN_ON_ONCE
(
	`iwl_mvm_has_éc_ofÊﬂd
(
mvm
)))

3228  -
EINVAL
;

3230 
	`BUILD_BUG_ON
(((
mvm°a
->
agg_tids
Ë* 
BITS_PER_BYTE
)

3231 !
IWL_MAX_TID_COUNT
);

3233 
	`•ö_lock_bh
(&
mvm°a
->
lock
);

3234 
s¢
 = 
tid_d©a
->ssn;

3235 
queue
 = 
tid_d©a
->
txq_id
;

3236 
tid_d©a
->
°©e
 = 
IWL_AGG_ON
;

3237 
mvm°a
->
agg_tids
 |
	`BIT
(
tid
);

3238 
tid_d©a
->
s¢
 = 0xffff;

3239 
tid_d©a
->
amsdu_ö_ampdu_Ælowed
 = 
amsdu
;

3240 
	`•ö_u∆ock_bh
(&
mvm°a
->
lock
);

3242 i‡(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)) {

3254 i‡(
buf_size
 < 
IWL_FRAME_LIMIT
)

3255  -
EOPNOTSUPP
;

3257 
ªt
 = 
	`iwl_mvm_°a_tx_agg
(
mvm
, 
°a
, 
tid
, 
queue
, 
åue
);

3258 i‡(
ªt
)

3259  -
EIO
;

3260 
out
;

3263 
cfg
.
fifo
 = 
iwl_mvm_ac_to_tx_fifo
[
tid_to_mac80211_ac
[
tid
]];

3265 
queue_°©us
 = 
mvm
->
queue_öfo
[
queue
].
°©us
;

3268 i‡(
mvm
->
queue_öfo
[
queue
].
°©us
 =
IWL_MVM_QUEUE_READY
)

3269 
Æloc_queue
 = 
Ál£
;

3275 i‡(!
Æloc_queue
 && 
buf_size
 < 
IWL_FRAME_LIMIT
) {

3280 
ªt
 = 
	`iwl_å™s_waô_tx_queues_em±y
(
mvm
->
å™s
,

3281 
	`BIT
(
queue
));

3282 i‡(
ªt
) {

3283 
	`IWL_ERR
(
mvm
,

3285  
ªt
;

3288 
ªt
 = 
	`iwl_mvm_ªc⁄fig_scd
(
mvm
, 
queue
, 
cfg
.
fifo
,

3289 
mvm°a
->
deÊök
.
°a_id
, 
tid
,

3290 
buf_size
, 
s¢
);

3291 i‡(
ªt
) {

3292 
	`IWL_ERR
(
mvm
,

3293 "Eº‹Ñec⁄figurög TXQ #%d\n", 
queue
);

3294  
ªt
;

3298 i‡(
Æloc_queue
)

3299 
	`iwl_mvm_íabÀ_txq
(
mvm
, 
°a
, 
queue
, 
s¢
,

3300 &
cfg
, 
wdg_timeout
);

3303 i‡(
queue_°©us
 !
IWL_MVM_QUEUE_SHARED
) {

3304 
ªt
 = 
	`iwl_mvm_°a_tx_agg
(
mvm
, 
°a
, 
tid
, 
queue
, 
åue
);

3305 i‡(
ªt
)

3306  -
EIO
;

3310 
mvm
->
queue_öfo
[
queue
].
°©us
 = 
IWL_MVM_QUEUE_READY
;

3312 
out
:

3320 
mvm°a
->
deÊök
.
lq_°a
.
rs_drv
.
≥rs
.
max_agg_bufsize
 =

3321 
	`mö
(
mvm°a
->
deÊök
.
lq_°a
.
rs_drv
.
≥rs
.
max_agg_bufsize
,

3322 
buf_size
);

3323 
mvm°a
->
deÊök
.
lq_°a
.
rs_drv
.
lq
.
agg_‰ame_˙t_limô
 =

3324 
mvm°a
->
deÊök
.
lq_°a
.
rs_drv
.
≥rs
.
max_agg_bufsize
;

3326 
	`IWL_DEBUG_HT
(
mvm
, "TxággregationÉnabled onÑa = %pMÅid = %d\n",

3327 
°a
->
addr
, 
tid
);

3329  
	`iwl_mvm_£nd_lq_cmd
(
mvm
, &
mvm°a
->
deÊök
.
lq_°a
.
rs_drv
.
lq
);

3330 
	}
}

3332 
	$iwl_mvm_uƒe£rve_agg_queue
(
iwl_mvm
 *
mvm
,

3333 
iwl_mvm_°a
 *
mvm°a
,

3334 
iwl_mvm_tid_d©a
 *
tid_d©a
)

3336 
u16
 
txq_id
 = 
tid_d©a
->txq_id;

3338 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

3340 i‡(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
))

3350 i‡(
mvm
->
queue_öfo
[
txq_id
].
°©us
 =
IWL_MVM_QUEUE_RESERVED
) {

3351 
mvm
->
queue_öfo
[
txq_id
].
°©us
 = 
IWL_MVM_QUEUE_FREE
;

3352 
tid_d©a
->
txq_id
 = 
IWL_MVM_INVALID_QUEUE
;

3354 
	}
}

3356 
	$iwl_mvm_°a_tx_agg_°›
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

3357 
õì80211_°a
 *
°a
, 
u16
 
tid
)

3359 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

3360 
iwl_mvm_tid_d©a
 *
tid_d©a
 = &
mvm°a
->tid_d©a[
tid
];

3361 
u16
 
txq_id
;

3362 
îr
;

3368 i‡(
	`ã°_bô
(
IWL_MVM_STATUS_IN_HW_RESTART
, &
mvm
->
°©us
)) {

3369 
	`õì80211_°›_tx_ba_cb_úqß„
(
vif
, 
°a
->
addr
, 
tid
);

3373 
	`•ö_lock_bh
(&
mvm°a
->
lock
);

3375 
txq_id
 = 
tid_d©a
->txq_id;

3377 
	`IWL_DEBUG_TX_QUEUES
(
mvm
, "Stop AGG: sta %dÅid %d q %d state %d\n",

3378 
mvm°a
->
deÊök
.
°a_id
, 
tid
, 
txq_id
,

3379 
tid_d©a
->
°©e
);

3381 
mvm°a
->
agg_tids
 &~
	`BIT
(
tid
);

3383 
	`iwl_mvm_uƒe£rve_agg_queue
(
mvm
, 
mvm°a
, 
tid_d©a
);

3385 
tid_d©a
->
°©e
) {

3386 
IWL_AGG_ON
:

3387 
tid_d©a
->
s¢
 = 
	`IEEE80211_SEQ_TO_SN
—id_d©a->
£q_numbî
);

3389 
	`IWL_DEBUG_TX_QUEUES
(
mvm
,

3391 
tid_d©a
->
s¢
,Åid_d©a->
√xt_ª˛aimed
);

3393 
tid_d©a
->
s¢
 = 0xffff;

3394 
tid_d©a
->
°©e
 = 
IWL_AGG_OFF
;

3395 
	`•ö_u∆ock_bh
(&
mvm°a
->
lock
);

3397 
	`õì80211_°›_tx_ba_cb_úqß„
(
vif
, 
°a
->
addr
, 
tid
);

3399 
	`iwl_mvm_°a_tx_agg
(
mvm
, 
°a
, 
tid
, 
txq_id
, 
Ál£
);

3401 
IWL_AGG_STARTING
:

3402 
IWL_EMPTYING_HW_QUEUE_ADDBA
:

3409 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

3411 
	`õì80211_°›_tx_ba_cb_úqß„
(
vif
, 
°a
->
addr
, 
tid
);

3412 
tid_d©a
->
°©e
 = 
IWL_AGG_OFF
;

3413 
îr
 = 0;

3416 
	`IWL_ERR
(
mvm
,

3418 
mvm°a
->
deÊök
.
°a_id
, 
tid
, 
tid_d©a
->
°©e
);

3419 
	`IWL_ERR
(
mvm
,

3420 "\âid_d©a->txq_id = %d\n", 
tid_d©a
->
txq_id
);

3421 
îr
 = -
EINVAL
;

3424 
	`•ö_u∆ock_bh
(&
mvm°a
->
lock
);

3426  
îr
;

3427 
	}
}

3429 
	$iwl_mvm_°a_tx_agg_Êush
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

3430 
õì80211_°a
 *
°a
, 
u16
 
tid
)

3432 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

3433 
iwl_mvm_tid_d©a
 *
tid_d©a
 = &
mvm°a
->tid_d©a[
tid
];

3434 
u16
 
txq_id
;

3435 
iwl_mvm_agg_°©e
 
ﬁd_°©e
;

3441 
	`•ö_lock_bh
(&
mvm°a
->
lock
);

3442 
txq_id
 = 
tid_d©a
->txq_id;

3443 
	`IWL_DEBUG_TX_QUEUES
(
mvm
, "Flush AGG: sta %dÅid %d q %d state %d\n",

3444 
mvm°a
->
deÊök
.
°a_id
, 
tid
, 
txq_id
,

3445 
tid_d©a
->
°©e
);

3446 
ﬁd_°©e
 = 
tid_d©a
->
°©e
;

3447 
tid_d©a
->
°©e
 = 
IWL_AGG_OFF
;

3448 
mvm°a
->
agg_tids
 &~
	`BIT
(
tid
);

3449 
	`•ö_u∆ock_bh
(&
mvm°a
->
lock
);

3451 
	`iwl_mvm_uƒe£rve_agg_queue
(
mvm
, 
mvm°a
, 
tid_d©a
);

3453 i‡(
ﬁd_°©e
 >
IWL_AGG_ON
) {

3454 
	`iwl_mvm_døö_°a
(
mvm
, 
mvm°a
, 
åue
);

3456 i‡(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)) {

3457 i‡(
	`iwl_mvm_Êush_°a_tids
(
mvm
, 
mvm°a
->
deÊök
.
°a_id
,

3458 
	`BIT
(
tid
)))

3459 
	`IWL_ERR
(
mvm
, "Couldn't flushÅhe AGG queue\n");

3460 
	`iwl_å™s_waô_txq_em±y
(
mvm
->
å™s
, 
txq_id
);

3462 i‡(
	`iwl_mvm_Êush_tx_∑th
(
mvm
, 
	`BIT
(
txq_id
)))

3463 
	`IWL_ERR
(
mvm
, "Couldn't flushÅhe AGG queue\n");

3464 
	`iwl_å™s_waô_tx_queues_em±y
(
mvm
->
å™s
, 
	`BIT
(
txq_id
));

3467 
	`iwl_mvm_døö_°a
(
mvm
, 
mvm°a
, 
Ál£
);

3469 
	`iwl_mvm_°a_tx_agg
(
mvm
, 
°a
, 
tid
, 
txq_id
, 
Ál£
);

3473 
	}
}

3475 
	$iwl_mvm_£t_fw_key_idx
(
iwl_mvm
 *
mvm
)

3477 
i
, 
max
 = -1, 
max_offs
 = -1;

3479 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

3487 
i
 = 0; i < 
STA_KEY_MAX_NUM
; i++) {

3488 i‡(
	`ã°_bô
(
i
, 
mvm
->
fw_key_èbÀ
))

3490 i‡(
mvm
->
fw_key_dñëed
[
i
] > 
max
) {

3491 
max
 = 
mvm
->
fw_key_dñëed
[
i
];

3492 
max_offs
 = 
i
;

3496 i‡(
max_offs
 < 0)

3497  
STA_KEY_IDX_INVALID
;

3499  
max_offs
;

3500 
	}
}

3502 
iwl_mvm_°a
 *
	$iwl_mvm_gë_key_°a
(
iwl_mvm
 *
mvm
,

3503 
õì80211_vif
 *
vif
,

3504 
õì80211_°a
 *
°a
)

3506 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

3508 i‡(
°a
)

3509  
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

3516 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
 &&

3517 
mvmvif
->
deÊök
.
≠_°a_id
 !
IWL_MVM_INVALID_STA
) {

3518 
u8
 
°a_id
 = 
mvmvif
->
deÊök
.
≠_°a_id
;

3520 
°a
 = 
	`rcu_dîe„ªn˚_check
(
mvm
->
fw_id_to_mac_id
[
°a_id
],

3521 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

3528 i‡(
	`IS_ERR_OR_NULL
(
°a
))

3529  
NULL
;

3531  
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

3534  
NULL
;

3535 
	}
}

3537 
	$iwl_mvm_≤_cmp
(c⁄° 
u8
 *
≤1
, c⁄° u8 *
≤2
, 
Àn
)

3539 
i
;

3541 
i
 = 
Àn
 - 1; i >= 0; i--) {

3542 i‡(
≤1
[
i
] > 
≤2
[i])

3544 i‡(
≤1
[
i
] < 
≤2
[i])

3549 
	}
}

3551 
	$iwl_mvm_£nd_°a_key
(
iwl_mvm
 *
mvm
,

3552 
u32
 
°a_id
,

3553 
õì80211_key_c⁄f
 *
key
, 
boﬁ
 
mˇ°
,

3554 
u32
 
tkù_iv32
, 
u16
 *
tkù_p1k
, u32 
cmd_Êags
,

3555 
u8
 
key_off£t
, 
boﬁ
 
mÂ
)

3558 
iwl_mvm_add_°a_key_cmd_v1
 
cmd_v1
;

3559 
iwl_mvm_add_°a_key_cmd
 
cmd
;

3560 } 
u
 = {};

3561 
__À16
 
key_Êags
;

3562 
ªt
;

3563 
u32
 
°©us
;

3564 
u16
 
keyidx
;

3565 
u64
 
≤
 = 0;

3566 
i
, 
size
;

3567 
boﬁ
 
√w_≠i
 = 
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
,

3568 
IWL_UCODE_TLV_API_TKIP_MIC_KEYS
);

3569 
≠i_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
ADD_STA_KEY
,

3570 
√w_≠i
 ? 2 : 1);

3572 i‡(
°a_id
 =
IWL_MVM_INVALID_STA
)

3573  -
EINVAL
;

3575 
keyidx
 = (
key
->keyidx << 
STA_KEY_FLG_KEYID_POS
) &

3576 
STA_KEY_FLG_KEYID_MSK
;

3577 
key_Êags
 = 
	`˝u_to_À16
(
keyidx
);

3578 
key_Êags
 |
	`˝u_to_À16
(
STA_KEY_FLG_WEP_KEY_MAP
);

3580 i‡(
key
->
Êags
 & 
IEEE80211_KEY_FLAG_SPP_AMSDU
)

3581 
key_Êags
 |
	`˝u_to_À16
(
STA_KEY_FLG_AMSDU_SPP
);

3583 
key
->
cùhî
) {

3584 
WLAN_CIPHER_SUITE_TKIP
:

3585 
key_Êags
 |
	`˝u_to_À16
(
STA_KEY_FLG_TKIP
);

3586 i‡(
≠i_vî
 >= 2) {

3587 
	`mem˝y
((*)&
u
.
cmd
.
tx_mic_key
,

3588 &
key
->key[
NL80211_TKIP_DATA_OFFSET_TX_MIC_KEY
],

3589 
IWL_MIC_KEY_SIZE
);

3591 
	`mem˝y
((*)&
u
.
cmd
.
rx_mic_key
,

3592 &
key
->key[
NL80211_TKIP_DATA_OFFSET_RX_MIC_KEY
],

3593 
IWL_MIC_KEY_SIZE
);

3594 
≤
 = 
	`©omic64_ªad
(&
key
->
tx_≤
);

3597 
u
.
cmd_v1
.
tkù_rx_tsc_byã2
 = 
tkù_iv32
;

3598 
i
 = 0; i < 5; i++)

3599 
u
.
cmd_v1
.
tkù_rx_âak
[
i
] =

3600 
	`˝u_to_À16
(
tkù_p1k
[
i
]);

3602 
	`mem˝y
(
u
.
cmd
.
comm⁄
.
key
, key->key, key->
keyÀn
);

3604 
WLAN_CIPHER_SUITE_CCMP
:

3605 
key_Êags
 |
	`˝u_to_À16
(
STA_KEY_FLG_CCM
);

3606 
	`mem˝y
(
u
.
cmd
.
comm⁄
.
key
, key->key, key->
keyÀn
);

3607 i‡(
≠i_vî
 >= 2)

3608 
≤
 = 
	`©omic64_ªad
(&
key
->
tx_≤
);

3610 
WLAN_CIPHER_SUITE_WEP104
:

3611 
key_Êags
 |
	`˝u_to_À16
(
STA_KEY_FLG_WEP_13BYTES
);

3612 
ÁŒthrough
;

3613 
WLAN_CIPHER_SUITE_WEP40
:

3614 
key_Êags
 |
	`˝u_to_À16
(
STA_KEY_FLG_WEP
);

3615 
	`mem˝y
(
u
.
cmd
.
comm⁄
.
key
 + 3, key->key, key->
keyÀn
);

3617 
WLAN_CIPHER_SUITE_GCMP_256
:

3618 
key_Êags
 |
	`˝u_to_À16
(
STA_KEY_FLG_KEY_32BYTES
);

3619 
ÁŒthrough
;

3620 
WLAN_CIPHER_SUITE_GCMP
:

3621 
key_Êags
 |
	`˝u_to_À16
(
STA_KEY_FLG_GCMP
);

3622 
	`mem˝y
(
u
.
cmd
.
comm⁄
.
key
, key->key, key->
keyÀn
);

3623 i‡(
≠i_vî
 >= 2)

3624 
≤
 = 
	`©omic64_ªad
(&
key
->
tx_≤
);

3627 
key_Êags
 |
	`˝u_to_À16
(
STA_KEY_FLG_EXT
);

3628 
	`mem˝y
(
u
.
cmd
.
comm⁄
.
key
, key->key, key->
keyÀn
);

3631 i‡(
mˇ°
)

3632 
key_Êags
 |
	`˝u_to_À16
(
STA_KEY_MULTICAST
);

3633 i‡(
mÂ
)

3634 
key_Êags
 |
	`˝u_to_À16
(
STA_KEY_MFP
);

3636 
u
.
cmd
.
comm⁄
.
key_off£t
 = key_offset;

3637 
u
.
cmd
.
comm⁄
.
key_Êags
 = key_flags;

3638 
u
.
cmd
.
comm⁄
.
°a_id
 = sta_id;

3640 i‡(
key
->
cùhî
 =
WLAN_CIPHER_SUITE_TKIP
)

3641 
i
 = 0;

3643 
i
 = -1;

3645 ; 
i
 < 
IEEE80211_NUM_TIDS
; i++) {

3646 
õì80211_key_£q
 
£q
 = {};

3647 
u8
 
_rx_≤
[
IEEE80211_MAX_PN_LEN
] = {}, *
rx_≤
 = _rx_pn;

3648 
rx_≤_Àn
 = 8;

3650 
hﬁe
 = 
≠i_vî
 >= 3 ? 0 : 2;

3652 
	`õì80211_gë_key_rx_£q
(
key
, 
i
, &
£q
);

3654 i‡(
key
->
cùhî
 =
WLAN_CIPHER_SUITE_TKIP
) {

3655 
rx_≤
[0] = 
£q
.
tkù
.
iv16
;

3656 
rx_≤
[1] = 
£q
.
tkù
.
iv16
 >> 8;

3657 
rx_≤
[2 + 
hﬁe
] = 
£q
.
tkù
.
iv32
;

3658 
rx_≤
[3 + 
hﬁe
] = 
£q
.
tkù
.
iv32
 >> 8;

3659 
rx_≤
[4 + 
hﬁe
] = 
£q
.
tkù
.
iv32
 >> 16;

3660 
rx_≤
[5 + 
hﬁe
] = 
£q
.
tkù
.
iv32
 >> 24;

3661 } i‡(
key_Êags
 & 
	`˝u_to_À16
(
STA_KEY_FLG_EXT
)) {

3662 
rx_≤
 = 
£q
.
hw
.seq;

3663 
rx_≤_Àn
 = 
£q
.
hw
.
£q_Àn
;

3665 
rx_≤
[0] = 
£q
.
ccmp
.
≤
[0];

3666 
rx_≤
[1] = 
£q
.
ccmp
.
≤
[1];

3667 
rx_≤
[2 + 
hﬁe
] = 
£q
.
ccmp
.
≤
[2];

3668 
rx_≤
[3 + 
hﬁe
] = 
£q
.
ccmp
.
≤
[3];

3669 
rx_≤
[4 + 
hﬁe
] = 
£q
.
ccmp
.
≤
[4];

3670 
rx_≤
[5 + 
hﬁe
] = 
£q
.
ccmp
.
≤
[5];

3673 i‡(
	`iwl_mvm_≤_cmp
(
rx_≤
, (
u8
 *)&
u
.
cmd
.
comm⁄
.
rx_£cur_£q_˙t
,

3674 
rx_≤_Àn
) > 0)

3675 
	`mem˝y
(&
u
.
cmd
.
comm⁄
.
rx_£cur_£q_˙t
, 
rx_≤
,

3676 
rx_≤_Àn
);

3679 i‡(
≠i_vî
 >= 2) {

3680 
u
.
cmd
.
å™smô_£q_˙t
 = 
	`˝u_to_À64
(
≤
);

3681 
size
 = (
u
.
cmd
);

3683 
size
 = (
u
.
cmd_v1
);

3686 
°©us
 = 
ADD_STA_SUCCESS
;

3687 i‡(
cmd_Êags
 & 
CMD_ASYNC
)

3688 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
ADD_STA_KEY
, 
CMD_ASYNC
, 
size
,

3689 &
u
.
cmd
);

3691 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu_°©us
(
mvm
, 
ADD_STA_KEY
, 
size
,

3692 &
u
.
cmd
, &
°©us
);

3694 
°©us
) {

3695 
ADD_STA_SUCCESS
:

3696 
	`IWL_DEBUG_WEP
(
mvm
, "MODIFY_STA: set dynamic keyÖassed\n");

3699 
ªt
 = -
EIO
;

3700 
	`IWL_ERR
(
mvm
, "MODIFY_STA: set dynamic key failed\n");

3704  
ªt
;

3705 
	}
}

3707 
	$iwl_mvm_£nd_°a_igtk
(
iwl_mvm
 *
mvm
,

3708 
õì80211_key_c⁄f
 *
keyc⁄f
,

3709 
u8
 
°a_id
, 
boﬁ
 
ªmove_key
)

3711 
iwl_mvm_mgmt_mˇ°_key_cmd
 
igtk_cmd
 = {};

3714 i‡(
	`WARN_ON
((
keyc⁄f
->
Êags
 & 
IEEE80211_KEY_FLAG_PAIRWISE
) ||

3715 (
keyc⁄f
->
keyidx
 != 4 && keyconf->keyidx != 5 &&

3716 
keyc⁄f
->
keyidx
 != 6 && keyconf->keyidx != 7) ||

3717 (
keyc⁄f
->
cùhî
 !
WLAN_CIPHER_SUITE_AES_CMAC
 &&

3718 
keyc⁄f
->
cùhî
 !
WLAN_CIPHER_SUITE_BIP_GMAC_128
 &&

3719 
keyc⁄f
->
cùhî
 !
WLAN_CIPHER_SUITE_BIP_GMAC_256
)))

3720  -
EINVAL
;

3722 i‡(
	`WARN_ON
(!
	`iwl_mvm_has_√w_rx_≠i
(
mvm
) &&

3723 
keyc⁄f
->
cùhî
 !
WLAN_CIPHER_SUITE_AES_CMAC
))

3724  -
EINVAL
;

3726 
igtk_cmd
.
key_id
 = 
	`˝u_to_À32
(
keyc⁄f
->
keyidx
);

3727 
igtk_cmd
.
°a_id
 = 
	`˝u_to_À32
(sta_id);

3729 i‡(
ªmove_key
) {

3731 i‡(
°a_id
 =
IWL_MVM_INVALID_STA
)

3734 
igtk_cmd
.
˘æ_Êags
 |
	`˝u_to_À32
(
STA_KEY_NOT_VALID
);

3736 
õì80211_key_£q
 
£q
;

3737 c⁄° 
u8
 *
≤
;

3739 
keyc⁄f
->
cùhî
) {

3740 
WLAN_CIPHER_SUITE_AES_CMAC
:

3741 
igtk_cmd
.
˘æ_Êags
 |
	`˝u_to_À32
(
STA_KEY_FLG_CCM
);

3743 
WLAN_CIPHER_SUITE_BIP_GMAC_128
:

3744 
WLAN_CIPHER_SUITE_BIP_GMAC_256
:

3745 
igtk_cmd
.
˘æ_Êags
 |
	`˝u_to_À32
(
STA_KEY_FLG_GCMP
);

3748  -
EINVAL
;

3751 
	`mem˝y
(
igtk_cmd
.
igtk
, 
keyc⁄f
->
key
, keyc⁄f->
keyÀn
);

3752 i‡(
keyc⁄f
->
cùhî
 =
WLAN_CIPHER_SUITE_BIP_GMAC_256
)

3753 
igtk_cmd
.
˘æ_Êags
 |=

3754 
	`˝u_to_À32
(
STA_KEY_FLG_KEY_32BYTES
);

3755 
	`õì80211_gë_key_rx_£q
(
keyc⁄f
, 0, &
£q
);

3756 
≤
 = 
£q
.
´s_cmac
.pn;

3757 
igtk_cmd
.
ª˚ive_£q_˙t
 = 
	`˝u_to_À64
(((
u64
Ë
≤
[5] << 0) |

3758 ((
u64
Ë
≤
[4] << 8) |

3759 ((
u64
Ë
≤
[3] << 16) |

3760 ((
u64
Ë
≤
[2] << 24) |

3761 ((
u64
Ë
≤
[1] << 32) |

3762 ((
u64
Ë
≤
[0] << 40));

3765 
	`IWL_DEBUG_INFO
(
mvm
, "%s %sIGTK (%d) for sta %u\n",

3766 
ªmove_key
 ? "removing" : "installing",

3767 
keyc⁄f
->
keyidx
 >= 6 ? "B" : "",

3768 
keyc⁄f
->
keyidx
, 
igtk_cmd
.
°a_id
);

3770 i‡(!
	`iwl_mvm_has_√w_rx_≠i
(
mvm
)) {

3771 
iwl_mvm_mgmt_mˇ°_key_cmd_v1
 
igtk_cmd_v1
 = {

3772 .
˘æ_Êags
 = 
igtk_cmd
.ctrl_flags,

3773 .
key_id
 = 
igtk_cmd
.key_id,

3774 .
°a_id
 = 
igtk_cmd
.sta_id,

3775 .
ª˚ive_£q_˙t
 = 
igtk_cmd
.receive_seq_cnt

3778 
	`mem˝y
(
igtk_cmd_v1
.
igtk
, 
igtk_cmd
.igtk,

3779 
	`ARRAY_SIZE
(
igtk_cmd_v1
.
igtk
));

3780  
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
MGMT_MCAST_KEY
, 0,

3781 (
igtk_cmd_v1
), &igtk_cmd_v1);

3783  
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
MGMT_MCAST_KEY
, 0,

3784 (
igtk_cmd
), &igtk_cmd);

3785 
	}
}

3788 
ölöe
 
u8
 *
	$iwl_mvm_gë_mac_addr
(
iwl_mvm
 *
mvm
,

3789 
õì80211_vif
 *
vif
,

3790 
õì80211_°a
 *
°a
)

3792 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

3794 i‡(
°a
)

3795  
°a
->
addr
;

3797 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
 &&

3798 
mvmvif
->
deÊök
.
≠_°a_id
 !
IWL_MVM_INVALID_STA
) {

3799 
u8
 
°a_id
 = 
mvmvif
->
deÊök
.
≠_°a_id
;

3800 
°a
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm
->
fw_id_to_mac_id
[
°a_id
],

3801 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

3802 i‡(
	`WARN_ON_ONCE
(
	`IS_ERR_OR_NULL
(
°a
)))

3803  
NULL
;

3805  
°a
->
addr
;

3809  
NULL
;

3810 
	}
}

3812 
	$__iwl_mvm_£t_°a_key
(
iwl_mvm
 *
mvm
,

3813 
õì80211_vif
 *
vif
,

3814 
õì80211_°a
 *
°a
,

3815 
õì80211_key_c⁄f
 *
keyc⁄f
,

3816 
u8
 
key_off£t
,

3817 
boﬁ
 
mˇ°
)

3819 c⁄° 
u8
 *
addr
;

3820 
õì80211_key_£q
 
£q
;

3821 
u16
 
p1k
[5];

3822 
u32
 
°a_id
;

3823 
boﬁ
 
mÂ
 = 
Ál£
;

3825 i‡(
°a
) {

3826 
iwl_mvm_°a
 *
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

3828 
°a_id
 = 
mvm_°a
->
deÊök
.sta_id;

3829 
mÂ
 = 
°a
->mfp;

3830 } i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_AP
 &&

3831 !(
keyc⁄f
->
Êags
 & 
IEEE80211_KEY_FLAG_PAIRWISE
)) {

3832 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

3834 
°a_id
 = 
mvmvif
->
deÊök
.
mˇ°_°a
.sta_id;

3836 
	`IWL_ERR
(
mvm
, "FailedÅo find station id\n");

3837  -
EINVAL
;

3840 i‡(
keyc⁄f
->
cùhî
 =
WLAN_CIPHER_SUITE_TKIP
) {

3841 
addr
 = 
	`iwl_mvm_gë_mac_addr
(
mvm
, 
vif
, 
°a
);

3842 i‡(!
addr
) {

3843 
	`IWL_ERR
(
mvm
, "FailedÅo find macáddress\n");

3844  -
EINVAL
;

3848 
	`õì80211_gë_key_rx_£q
(
keyc⁄f
, 0, &
£q
);

3849 
	`õì80211_gë_tkù_rx_p1k
(
keyc⁄f
, 
addr
, 
£q
.
tkù
.
iv32
, 
p1k
);

3851  
	`iwl_mvm_£nd_°a_key
(
mvm
, 
°a_id
, 
keyc⁄f
, 
mˇ°
,

3852 
£q
.
tkù
.
iv32
, 
p1k
, 0, 
key_off£t
,

3853 
mÂ
);

3856  
	`iwl_mvm_£nd_°a_key
(
mvm
, 
°a_id
, 
keyc⁄f
, 
mˇ°
,

3857 0, 
NULL
, 0, 
key_off£t
, 
mÂ
);

3858 
	}
}

3860 
	$iwl_mvm_£t_°a_key
(
iwl_mvm
 *
mvm
,

3861 
õì80211_vif
 *
vif
,

3862 
õì80211_°a
 *
°a
,

3863 
õì80211_key_c⁄f
 *
keyc⁄f
,

3864 
u8
 
key_off£t
)

3866 
boﬁ
 
mˇ°
 = !(
keyc⁄f
->
Êags
 & 
IEEE80211_KEY_FLAG_PAIRWISE
);

3867 
iwl_mvm_°a
 *
mvm_°a
;

3868 
u8
 
°a_id
 = 
IWL_MVM_INVALID_STA
;

3869 
ªt
;

3870 c⁄° 
u8
 
__maybe_unu£d
 
zîo_addr
[
ETH_ALEN
] = {0};

3872 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

3874 i‡(
vif
->
ty≥
 !
NL80211_IFTYPE_AP
 ||

3875 
keyc⁄f
->
Êags
 & 
IEEE80211_KEY_FLAG_PAIRWISE
) {

3877 
mvm_°a
 = 
	`iwl_mvm_gë_key_°a
(
mvm
, 
vif
, 
°a
);

3878 i‡(!
mvm_°a
) {

3879 
	`IWL_ERR
(
mvm
, "FailedÅo find station\n");

3880  -
EINVAL
;

3882 
°a_id
 = 
mvm_°a
->
deÊök
.sta_id;

3889 i‡(!
°a
) {

3890 
°a
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(

3891 
mvm
->
fw_id_to_mac_id
[
°a_id
],

3892 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

3893 i‡(
	`IS_ERR_OR_NULL
(
°a
)) {

3894 
	`IWL_ERR
(
mvm
, "Invalid station id\n");

3895  -
EINVAL
;

3899 i‡(
	`WARN_ON_ONCE
(
	`iwl_mvm_°a_‰om_mac80211
(
°a
)->
vif
 != vif))

3900  -
EINVAL
;

3902 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

3904 
°a_id
 = 
mvmvif
->
deÊök
.
mˇ°_°a
.sta_id;

3907 i‡(
keyc⁄f
->
cùhî
 =
WLAN_CIPHER_SUITE_AES_CMAC
 ||

3908 
keyc⁄f
->
cùhî
 =
WLAN_CIPHER_SUITE_BIP_GMAC_128
 ||

3909 
keyc⁄f
->
cùhî
 =
WLAN_CIPHER_SUITE_BIP_GMAC_256
) {

3910 
ªt
 = 
	`iwl_mvm_£nd_°a_igtk
(
mvm
, 
keyc⁄f
, 
°a_id
, 
Ál£
);

3911 
íd
;

3925 i‡(
key_off£t
 =
STA_KEY_IDX_INVALID
) {

3926 
key_off£t
 = 
	`iwl_mvm_£t_fw_key_idx
(
mvm
);

3927 i‡(
key_off£t
 =
STA_KEY_IDX_INVALID
)

3928  -
ENOSPC
;

3929 
keyc⁄f
->
hw_key_idx
 = 
key_off£t
;

3932 
ªt
 = 
	`__iwl_mvm_£t_°a_key
(
mvm
, 
vif
, 
°a
, 
keyc⁄f
, 
key_off£t
, 
mˇ°
);

3933 i‡(
ªt
)

3934 
íd
;

3942 i‡((
keyc⁄f
->
cùhî
 =
WLAN_CIPHER_SUITE_WEP40
 ||

3943 
keyc⁄f
->
cùhî
 =
WLAN_CIPHER_SUITE_WEP104
) &&

3944 
°a
) {

3945 
ªt
 = 
	`__iwl_mvm_£t_°a_key
(
mvm
, 
vif
, 
°a
, 
keyc⁄f
,

3946 
key_off£t
, !
mˇ°
);

3947 i‡(
ªt
) {

3948 
	`__iwl_mvm_ªmove_°a_key
(
mvm
, 
°a_id
, 
keyc⁄f
, 
mˇ°
);

3949 
íd
;

3953 
	`__£t_bô
(
key_off£t
, 
mvm
->
fw_key_èbÀ
);

3955 
íd
:

3956 
	`IWL_DEBUG_WEP
(
mvm
, "key: cipher=%xÜen=%d idx=%d sta=%pMÑet=%d\n",

3957 
keyc⁄f
->
cùhî
, keyc⁄f->
keyÀn
, keyc⁄f->
keyidx
,

3958 
°a
 ? sè->
addr
 : 
zîo_addr
, 
ªt
);

3959  
ªt
;

3960 
	}
}

3962 
	$iwl_mvm_ªmove_°a_key
(
iwl_mvm
 *
mvm
,

3963 
õì80211_vif
 *
vif
,

3964 
õì80211_°a
 *
°a
,

3965 
õì80211_key_c⁄f
 *
keyc⁄f
)

3967 
boﬁ
 
mˇ°
 = !(
keyc⁄f
->
Êags
 & 
IEEE80211_KEY_FLAG_PAIRWISE
);

3968 
iwl_mvm_°a
 *
mvm_°a
;

3969 
u8
 
°a_id
 = 
IWL_MVM_INVALID_STA
;

3970 
ªt
, 
i
;

3972 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

3975 
mvm_°a
 = 
	`iwl_mvm_gë_key_°a
(
mvm
, 
vif
, 
°a
);

3976 i‡(
mvm_°a
)

3977 
°a_id
 = 
mvm_°a
->
deÊök
.sta_id;

3978 i‡(!
°a
 && 
vif
->
ty≥
 =
NL80211_IFTYPE_AP
 && 
mˇ°
)

3979 
°a_id
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
)->
deÊök
.
mˇ°_°a
.sta_id;

3982 
	`IWL_DEBUG_WEP
(
mvm
, "mvmÑemove dynamic key: idx=%d sta=%d\n",

3983 
keyc⁄f
->
keyidx
, 
°a_id
);

3985 i‡(
keyc⁄f
->
cùhî
 =
WLAN_CIPHER_SUITE_AES_CMAC
 ||

3986 
keyc⁄f
->
cùhî
 =
WLAN_CIPHER_SUITE_BIP_GMAC_128
 ||

3987 
keyc⁄f
->
cùhî
 =
WLAN_CIPHER_SUITE_BIP_GMAC_256
)

3988  
	`iwl_mvm_£nd_°a_igtk
(
mvm
, 
keyc⁄f
, 
°a_id
, 
åue
);

3990 i‡(!
	`__ã°_™d_˛ór_bô
(
keyc⁄f
->
hw_key_idx
, 
mvm
->
fw_key_èbÀ
)) {

3991 
	`IWL_ERR
(
mvm
, "offset %dÇot used in fw keyÅable.\n",

3992 
keyc⁄f
->
hw_key_idx
);

3993  -
ENOENT
;

3997 
i
 = 0; i < 
STA_KEY_MAX_NUM
; i++) {

3998 i‡(
mvm
->
fw_key_dñëed
[
i
] < 
U8_MAX
)

3999 
mvm
->
fw_key_dñëed
[
i
]++;

4001 
mvm
->
fw_key_dñëed
[
keyc⁄f
->
hw_key_idx
] = 0;

4003 i‡(
°a
 && !
mvm_°a
) {

4004 
	`IWL_DEBUG_WEP
(
mvm
, "stationÇon-existent,ÉarlyÑeturn.\n");

4008 
ªt
 = 
	`__iwl_mvm_ªmove_°a_key
(
mvm
, 
°a_id
, 
keyc⁄f
, 
mˇ°
);

4009 i‡(
ªt
)

4010  
ªt
;

4013 i‡(
keyc⁄f
->
cùhî
 =
WLAN_CIPHER_SUITE_WEP40
 ||

4014 
keyc⁄f
->
cùhî
 =
WLAN_CIPHER_SUITE_WEP104
)

4015 
ªt
 = 
	`__iwl_mvm_ªmove_°a_key
(
mvm
, 
°a_id
, 
keyc⁄f
, !
mˇ°
);

4017  
ªt
;

4018 
	}
}

4020 
	$iwl_mvm_upd©e_tkù_key
(
iwl_mvm
 *
mvm
,

4021 
õì80211_vif
 *
vif
,

4022 
õì80211_key_c⁄f
 *
keyc⁄f
,

4023 
õì80211_°a
 *
°a
, 
u32
 
iv32
,

4024 
u16
 *
pha£1key
)

4026 
iwl_mvm_°a
 *
mvm_°a
;

4027 
boﬁ
 
mˇ°
 = !(
keyc⁄f
->
Êags
 & 
IEEE80211_KEY_FLAG_PAIRWISE
);

4028 
boﬁ
 
mÂ
 = 
°a
 ? sè->mÂ : 
Ál£
;

4030 
	`rcu_ªad_lock
();

4032 
mvm_°a
 = 
	`iwl_mvm_gë_key_°a
(
mvm
, 
vif
, 
°a
);

4033 i‡(
	`WARN_ON_ONCE
(!
mvm_°a
))

4034 
u∆ock
;

4035 
	`iwl_mvm_£nd_°a_key
(
mvm
, 
mvm_°a
->
deÊök
.
°a_id
, 
keyc⁄f
, 
mˇ°
,

4036 
iv32
, 
pha£1key
, 
CMD_ASYNC
, 
keyc⁄f
->
hw_key_idx
,

4037 
mÂ
);

4039 
u∆ock
:

4040 
	`rcu_ªad_u∆ock
();

4041 
	}
}

4043 
	$iwl_mvm_°a_modify_ps_wake
(
iwl_mvm
 *
mvm
,

4044 
õì80211_°a
 *
°a
)

4046 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

4047 
iwl_mvm_add_°a_cmd
 
cmd
 = {

4048 .
add_modify
 = 
STA_MODE_MODIFY
,

4049 .
°a_id
 = 
mvm°a
->
deÊök
.sta_id,

4050 .
°©i⁄_Êags_msk
 = 
	`˝u_to_À32
(
STA_FLG_PS
),

4051 .
mac_id_n_cﬁ‹
 = 
	`˝u_to_À32
(
mvm°a
->mac_id_n_color),

4053 
ªt
;

4055 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
ADD_STA
, 
CMD_ASYNC
,

4056 
	`iwl_mvm_add_°a_cmd_size
(
mvm
), &
cmd
);

4057 i‡(
ªt
)

4058 
	`IWL_ERR
(
mvm
, "FaûedÅÿ£nd ADD_STA comm™d (%d)\n", 
ªt
);

4059 
	}
}

4061 
	$iwl_mvm_°a_modify_¶ìp_tx_cou¡
(
iwl_mvm
 *
mvm
,

4062 
õì80211_°a
 *
°a
,

4063 
õì80211_‰ame_ªÀa£_ty≥
 
ªas⁄
,

4064 
u16
 
˙t
, u16 
tids
, 
boﬁ
 
m‹e_d©a
,

4065 
boﬁ
 
sögÀ_°a_queue
)

4067 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

4068 
iwl_mvm_add_°a_cmd
 
cmd
 = {

4069 .
add_modify
 = 
STA_MODE_MODIFY
,

4070 .
°a_id
 = 
mvm°a
->
deÊök
.sta_id,

4071 .
modify_mask
 = 
STA_MODIFY_SLEEPING_STA_TX_COUNT
,

4072 .
¶ìp_tx_cou¡
 = 
	`˝u_to_À16
(
˙t
),

4073 .
mac_id_n_cﬁ‹
 = 
	`˝u_to_À32
(
mvm°a
->mac_id_n_color),

4075 
tid
, 
ªt
;

4076 
_tids
 = 
tids
;

4082 
	`f‹_óch_£t_bô
(
tid
, &
_tids
, 
IWL_MAX_TID_COUNT
)

4083 
cmd
.
awake_acs
 |
	`BIT
(
tid_to_ucode_ac
[
tid
]);

4092 i‡(
sögÀ_°a_queue
) {

4093 
ªmaöög
 = 
˙t
;

4094 
¶ìp_tx_cou¡
;

4096 
	`•ö_lock_bh
(&
mvm°a
->
lock
);

4097 
	`f‹_óch_£t_bô
(
tid
, &
_tids
, 
IWL_MAX_TID_COUNT
) {

4098 
iwl_mvm_tid_d©a
 *
tid_d©a
;

4099 
u16
 
n_queued
;

4101 
tid_d©a
 = &
mvm°a
->tid_d©a[
tid
];

4103 
n_queued
 = 
	`iwl_mvm_tid_queued
(
mvm
, 
tid_d©a
);

4104 i‡(
n_queued
 > 
ªmaöög
) {

4105 
m‹e_d©a
 = 
åue
;

4106 
ªmaöög
 = 0;

4109 
ªmaöög
 -
n_queued
;

4111 
¶ìp_tx_cou¡
 = 
˙t
 - 
ªmaöög
;

4112 i‡(
ªas⁄
 =
IEEE80211_FRAME_RELEASE_UAPSD
)

4113 
mvm°a
->
¶ìp_tx_cou¡
 = sleep_tx_count;

4114 
	`•ö_u∆ock_bh
(&
mvm°a
->
lock
);

4116 
cmd
.
¶ìp_tx_cou¡
 = 
	`˝u_to_À16
(sleep_tx_count);

4117 i‡(
	`WARN_ON
(
˙t
 - 
ªmaöög
 == 0)) {

4118 
	`õì80211_°a_eo•
(
°a
);

4124 i‡(
m‹e_d©a
)

4125 
cmd
.
¶ìp_°©e_Êags
 |
STA_SLEEP_STATE_MOREDATA
;

4127 i‡(
ªas⁄
 =
IEEE80211_FRAME_RELEASE_PSPOLL
) {

4128 
mvm°a
->
√xt_°©us_eo•
 = 
åue
;

4129 
cmd
.
¶ìp_°©e_Êags
 |
STA_SLEEP_STATE_PS_POLL
;

4131 
cmd
.
¶ìp_°©e_Êags
 |
STA_SLEEP_STATE_UAPSD
;

4135 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
ADD_STA
,

4136 
CMD_ASYNC
 | 
CMD_BLOCK_TXQS
,

4137 
	`iwl_mvm_add_°a_cmd_size
(
mvm
), &
cmd
);

4138 i‡(
ªt
)

4139 
	`IWL_ERR
(
mvm
, "FaûedÅÿ£nd ADD_STA comm™d (%d)\n", 
ªt
);

4140 
	}
}

4142 
	$iwl_mvm_rx_eo•_nŸif
(
iwl_mvm
 *
mvm
,

4143 
iwl_rx_cmd_buf„r
 *
rxb
)

4145 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

4146 
iwl_mvm_eo•_nŸifiˇti⁄
 *
nŸif
 = (*)
pkt
->
d©a
;

4147 
õì80211_°a
 *
°a
;

4148 
u32
 
°a_id
 = 
	`À32_to_˝u
(
nŸif
->sta_id);

4150 i‡(
	`WARN_ON_ONCE
(
°a_id
 >
mvm
->
fw
->
ucode_ˇ∑
.
num_°©i⁄s
))

4153 
	`rcu_ªad_lock
();

4154 
°a
 = 
	`rcu_dîe„ªn˚
(
mvm
->
fw_id_to_mac_id
[
°a_id
]);

4155 i‡(!
	`IS_ERR_OR_NULL
(
°a
))

4156 
	`õì80211_°a_eo•
(
°a
);

4157 
	`rcu_ªad_u∆ock
();

4158 
	}
}

4160 
	$iwl_mvm_°a_modify_dißbÀ_tx
(
iwl_mvm
 *
mvm
,

4161 
iwl_mvm_°a
 *
mvm°a
,

4162 
boﬁ
 
dißbÀ
)

4164 
iwl_mvm_add_°a_cmd
 
cmd
 = {

4165 .
add_modify
 = 
STA_MODE_MODIFY
,

4166 .
°a_id
 = 
mvm°a
->
deÊök
.sta_id,

4167 .
°©i⁄_Êags
 = 
dißbÀ
 ? 
	`˝u_to_À32
(
STA_FLG_DISABLE_TX
) : 0,

4168 .
°©i⁄_Êags_msk
 = 
	`˝u_to_À32
(
STA_FLG_DISABLE_TX
),

4169 .
mac_id_n_cﬁ‹
 = 
	`˝u_to_À32
(
mvm°a
->mac_id_n_color),

4171 
ªt
;

4173 i‡(
mvm
->
mld_≠i_is_u£d
) {

4174 i‡(!
	`iwl_mvm_has_no_ho°_dißbÀ_tx
(
mvm
))

4175 
	`iwl_mvm_mld_°a_modify_dißbÀ_tx
(
mvm
, 
mvm°a
, 
dißbÀ
);

4179 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
ADD_STA
, 
CMD_ASYNC
,

4180 
	`iwl_mvm_add_°a_cmd_size
(
mvm
), &
cmd
);

4181 i‡(
ªt
)

4182 
	`IWL_ERR
(
mvm
, "FaûedÅÿ£nd ADD_STA comm™d (%d)\n", 
ªt
);

4183 
	}
}

4185 
	$iwl_mvm_°a_modify_dißbÀ_tx_≠
(
iwl_mvm
 *
mvm
,

4186 
õì80211_°a
 *
°a
,

4187 
boﬁ
 
dißbÀ
)

4189 
iwl_mvm_°a
 *
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

4191 i‡(
mvm
->
mld_≠i_is_u£d
) {

4192 i‡(!
	`iwl_mvm_has_no_ho°_dißbÀ_tx
(
mvm
))

4193 
	`iwl_mvm_mld_°a_modify_dißbÀ_tx_≠
(
mvm
, 
°a
, 
dißbÀ
);

4197 
	`•ö_lock_bh
(&
mvm_°a
->
lock
);

4199 i‡(
mvm_°a
->
dißbÀ_tx
 =
dißbÀ
) {

4200 
	`•ö_u∆ock_bh
(&
mvm_°a
->
lock
);

4204 
mvm_°a
->
dißbÀ_tx
 = 
dißbÀ
;

4210 i‡(!
	`õì80211_hw_check
(
mvm
->
hw
, 
AP_LINK_PS
))

4211 
	`õì80211_°a_block_awake
(
mvm
->
hw
, 
°a
, 
dißbÀ
);

4213 
	`iwl_mvm_°a_modify_dißbÀ_tx
(
mvm
, 
mvm_°a
, 
dißbÀ
);

4215 
	`•ö_u∆ock_bh
(&
mvm_°a
->
lock
);

4216 
	}
}

4218 
	$iwl_mvm_öt_°a_modify_dißbÀ_tx
(
iwl_mvm
 *
mvm
,

4219 
iwl_mvm_vif
 *
mvmvif
,

4220 
iwl_mvm_öt_°a
 *
°a
,

4221 
boﬁ
 
dißbÀ
)

4223 
u32
 
id
 = 
	`FW_CMD_ID_AND_COLOR
(
mvmvif
->id, mvmvif->
cﬁ‹
);

4224 
iwl_mvm_add_°a_cmd
 
cmd
 = {

4225 .
add_modify
 = 
STA_MODE_MODIFY
,

4226 .
°a_id
 = 
°a
->sta_id,

4227 .
°©i⁄_Êags
 = 
dißbÀ
 ? 
	`˝u_to_À32
(
STA_FLG_DISABLE_TX
) : 0,

4228 .
°©i⁄_Êags_msk
 = 
	`˝u_to_À32
(
STA_FLG_DISABLE_TX
),

4229 .
mac_id_n_cﬁ‹
 = 
	`˝u_to_À32
(
id
),

4231 
ªt
;

4233 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
ADD_STA
, 
CMD_ASYNC
,

4234 
	`iwl_mvm_add_°a_cmd_size
(
mvm
), &
cmd
);

4235 i‡(
ªt
)

4236 
	`IWL_ERR
(
mvm
, "FaûedÅÿ£nd ADD_STA comm™d (%d)\n", 
ªt
);

4237 
	}
}

4239 
	$iwl_mvm_modify_Æl_°a_dißbÀ_tx
(
iwl_mvm
 *
mvm
,

4240 
iwl_mvm_vif
 *
mvmvif
,

4241 
boﬁ
 
dißbÀ
)

4243 
õì80211_°a
 *
°a
;

4244 
iwl_mvm_°a
 *
mvm_°a
;

4245 
i
;

4247 i‡(
mvm
->
mld_≠i_is_u£d
) {

4248 i‡(!
	`iwl_mvm_has_no_ho°_dißbÀ_tx
(
mvm
))

4249 
	`iwl_mvm_mld_modify_Æl_°a_dißbÀ_tx
(
mvm
, 
mvmvif
,

4250 
dißbÀ
);

4254 
	`rcu_ªad_lock
();

4257 
i
 = 0; i < 
mvm
->
fw
->
ucode_ˇ∑
.
num_°©i⁄s
; i++) {

4258 
°a
 = 
	`rcu_dîe„ªn˚
(
mvm
->
fw_id_to_mac_id
[
i
]);

4259 i‡(
	`IS_ERR_OR_NULL
(
°a
))

4262 
mvm_°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

4263 i‡(
mvm_°a
->
mac_id_n_cﬁ‹
 !=

4264 
	`FW_CMD_ID_AND_COLOR
(
mvmvif
->
id
, mvmvif->
cﬁ‹
))

4267 
	`iwl_mvm_°a_modify_dißbÀ_tx_≠
(
mvm
, 
°a
, 
dißbÀ
);

4270 
	`rcu_ªad_u∆ock
();

4272 i‡(!
	`fw_has_≠i
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_API_STA_TYPE
))

4276 i‡(
mvmvif
->
deÊök
.
mˇ°_°a
.
°a_id
 !
IWL_MVM_INVALID_STA
)

4277 
	`iwl_mvm_öt_°a_modify_dißbÀ_tx
(
mvm
, 
mvmvif
,

4278 &
mvmvif
->
deÊök
.
mˇ°_°a
,

4279 
dißbÀ
);

4285 i‡(!
dißbÀ
 && 
mvmvif
->
deÊök
.
bˇ°_°a
.
°a_id
 !
IWL_MVM_INVALID_STA
)

4286 
	`iwl_mvm_öt_°a_modify_dißbÀ_tx
(
mvm
, 
mvmvif
,

4287 &
mvmvif
->
deÊök
.
bˇ°_°a
,

4288 
dißbÀ
);

4289 
	}
}

4291 
	$iwl_mvm_cß_˛õ¡_ab£¡
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

4293 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

4294 
iwl_mvm_°a
 *
mvm°a
;

4296 
	`rcu_ªad_lock
();

4298 
mvm°a
 = 
	`iwl_mvm_°a_‰om_°aid_rcu
(
mvm
, 
mvmvif
->
deÊök
.
≠_°a_id
);

4300 i‡(
mvm°a
)

4301 
	`iwl_mvm_°a_modify_dißbÀ_tx
(
mvm
, 
mvm°a
, 
åue
);

4303 
	`rcu_ªad_u∆ock
();

4304 
	}
}

4306 
u16
 
	$iwl_mvm_tid_queued
(
iwl_mvm
 *
mvm
, 
iwl_mvm_tid_d©a
 *
tid_d©a
)

4308 
u16
 
¢
 = 
	`IEEE80211_SEQ_TO_SN
(
tid_d©a
->
£q_numbî
);

4314 i‡(
mvm
->
å™s
->
å™s_cfg
->
gí2
)

4315 
¢
 &= 0xff;

4317  
	`õì80211_¢_sub
(
¢
, 
tid_d©a
->
√xt_ª˛aimed
);

4318 
	}
}

4320 
	$iwl_mvm_add_∑¢_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

4321 
iwl_mvm_öt_°a
 *
°a
, 
u8
 *
addr
, 
u32
 
cùhî
,

4322 
u8
 *
key
, 
u32
 
key_Àn
,

4323 
õì80211_key_c⁄f
 *
keyc⁄f
)

4325 
ªt
;

4326 
u16
 
queue
;

4327 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

4328 
wdg_timeout
 =

4329 
	`iwl_mvm_gë_wd_timeout
(
mvm
, 
vif
, 
Ál£
, false);

4330 
boﬁ
 
mld
 = 
	`iwl_mvm_has_mld_≠i
(
mvm
->
fw
);

4331 
u32
 
ty≥
 = 
mld
 ? 
STATION_TYPE_PEER
 : 
IWL_STA_LINK
;

4333 
ªt
 = 
	`iwl_mvm_Æloˇã_öt_°a
(
mvm
, 
°a
, 0,

4334 
NL80211_IFTYPE_UNSPECIFIED
, 
ty≥
);

4335 i‡(
ªt
)

4336  
ªt
;

4338 i‡(
mld
)

4339 
ªt
 = 
	`iwl_mvm_mld_add_öt_°a_wôh_queue
(
mvm
, 
°a
, 
addr
,

4340 
mvmvif
->
deÊök
.
fw_lök_id
,

4341 &
queue
,

4342 
IWL_MAX_TID_COUNT
,

4343 &
wdg_timeout
);

4345 
ªt
 = 
	`iwl_mvm_add_öt_°a_wôh_queue
(
mvm
, 
mvmvif
->
id
,

4346 
mvmvif
->
cﬁ‹
, 
addr
, 
°a
,

4347 &
queue
,

4348 
IWL_MVM_TX_FIFO_BE
);

4349 i‡(
ªt
)

4350 
out
;

4352 
keyc⁄f
->
cùhî
 = cipher;

4353 
	`mem˝y
(
keyc⁄f
->
key
, key, 
key_Àn
);

4354 
keyc⁄f
->
keyÀn
 = 
key_Àn
;

4355 
keyc⁄f
->
Êags
 = 
IEEE80211_KEY_FLAG_PAIRWISE
;

4357 i‡(
mld
) {

4361 
u32
 
key_Êags
 =

4362 
	`iwl_mvm_gë_£c_Êags
(
mvm
, 
vif
, 
NULL
, 
keyc⁄f
) |

4363 
IWL_SEC_KEY_FLAG_MFP
;

4364 
u32
 
°a_mask
 = 
	`BIT
(
°a
->
°a_id
);

4366 
ªt
 = 
	`iwl_mvm_mld_£nd_key
(
mvm
, 
°a_mask
, 
key_Êags
, 
keyc⁄f
);

4368 
ªt
 = 
	`iwl_mvm_£nd_°a_key
(
mvm
, 
°a
->
°a_id
, 
keyc⁄f
, 
Ál£
,

4369 0, 
NULL
, 0, 0, 
åue
);

4372 
out
:

4373 i‡(
ªt
)

4374 
	`iwl_mvm_dóŒoc_öt_°a
(
mvm
, 
°a
);

4375  
ªt
;

4376 
	}
}

4378 
	$iwl_mvm_ˇn˚l_ch™√l_swôch
(
iwl_mvm
 *
mvm
,

4379 
õì80211_vif
 *
vif
,

4380 
u32
 
id
)

4382 
iwl_ˇn˚l_ch™√l_swôch_cmd
 
ˇn˚l_ch™√l_swôch_cmd
 = {

4383 .
id
 = 
	`˝u_to_À32
(id),

4385 
ªt
;

4387 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
,

4388 
	`WIDE_ID
(
MAC_CONF_GROUP
, 
CANCEL_CHANNEL_SWITCH_CMD
),

4389 
CMD_ASYNC
,

4390 (
ˇn˚l_ch™√l_swôch_cmd
),

4391 &
ˇn˚l_ch™√l_swôch_cmd
);

4392 i‡(
ªt
)

4393 
	`IWL_ERR
(
mvm
, "FailedÅo cancelÅhe channel switch\n");

4394 
	}
}

	@sta.h

7 #i‚de‡
__°a_h__


8 
	#__°a_h__


	)

10 
	~<löux/•ölock.h
>

11 
	~<√t/mac80211.h
>

12 
	~<löux/waô.h
>

14 
	~"iwl-å™s.h
"

15 
	~"fw-≠i.h
"

16 
	~"rs.h
"

18 
	giwl_mvm
;

19 
	giwl_mvm_vif
;

231 
	eiwl_mvm_agg_°©e
 {

232 
	mIWL_AGG_OFF
 = 0,

233 
	mIWL_AGG_QUEUED
,

234 
	mIWL_AGG_STARTING
,

235 
	mIWL_AGG_ON
,

236 
	mIWL_EMPTYING_HW_QUEUE_ADDBA
,

237 
	mIWL_EMPTYING_HW_QUEUE_DELBA
,

261 
	siwl_mvm_tid_d©a
 {

262 
u16
 
	m£q_numbî
;

263 
u16
 
	m√xt_ª˛aimed
;

265 
u32
 
	møã_n_Êags
;

266 
u8
 
	mlq_cﬁ‹
;

267 
boﬁ
 
	mamsdu_ö_ampdu_Ælowed
;

268 
iwl_mvm_agg_°©e
 
	m°©e
;

269 
u16
 
	mtxq_id
;

270 
u16
 
	ms¢
;

271 
u16
 
	mtx_time
;

272 
	mçt_mós_°¨t
;

273 
u32
 
	mtx_cou¡_œ°
;

274 
u32
 
	mtx_cou¡
;

277 
	siwl_mvm_key_≤
 {

278 
rcu_hód
 
	mrcu_hód
;

280 
u8
 
	m≤
[
IWL_MAX_TID_COUNT
][
IEEE80211_CCMP_PN_LEN
];

281 } 
____ˇchñöe_Æig√d_ö_smp
 
	mq
[];

290 
	eiwl_mvm_rxq_nŸif_ty≥
 {

291 
	mIWL_MVM_RXQ_EMPTY
,

292 
	mIWL_MVM_RXQ_NOTIF_DEL_BA
,

305 
	siwl_mvm_öã∫Æ_rxq_nŸif
 {

306 
u16
 
	mty≥
;

307 
u16
 
	msync
;

308 
u32
 
	mcookõ
;

309 
u8
 
	md©a
[];

310 } 
	g__∑cked
;

312 
	siwl_mvm_dñba_d©a
 {

313 
u32
 
	mbaid
;

314 } 
	g__∑cked
;

321 
	siwl_mvm_rxq_dup_d©a
 {

322 
__À16
 
	mœ°_£q
[
IWL_MAX_TID_COUNT
 + 1];

323 
u8
 
	mœ°_sub_‰ame
[
IWL_MAX_TID_COUNT
 + 1];

324 } 
	g____ˇchñöe_Æig√d_ö_smp
;

337 
	siwl_mvm_lök_°a
 {

338 
rcu_hód
 
	mrcu_hód
;

339 
u32
 
	m°a_id
;

341 
iwl_lq_°a_rs_fw
 
	mrs_fw
;

342 
iwl_lq_°a
 
	mrs_drv
;

343 } 
	mlq_°a
;

345 
u16
 
	m‹ig_amsdu_Àn
;

347 
u8
 
	mavg_íîgy
;

403 
	siwl_mvm_°a
 {

404 
u32
 
	mtfd_queue_msk
;

405 
u32
 
	mmac_id_n_cﬁ‹
;

406 
u16
 
	mtid_dißbÀ_agg
;

407 
u8
 
	m°a_ty≥
;

408 
õì80211_°a_°©e
 
	m°a_°©e
;

409 
boﬁ
 
	mbt_ªdu˚d_txpowî
;

410 
boﬁ
 
	m√xt_°©us_eo•
;

411 
boﬁ
 
	mauth‹ized
;

412 
•ölock_t
 
	mlock
;

413 
iwl_mvm_tid_d©a
 
	mtid_d©a
[
IWL_MAX_TID_COUNT
 + 1];

414 
u8
 
	mtid_to_baid
[
IWL_MAX_TID_COUNT
];

415 
õì80211_vif
 *
	mvif
;

416 
iwl_mvm_key_≤
 
__rcu
 *
	m±k_≤
[4];

417 
iwl_mvm_rxq_dup_d©a
 *
	mdup_d©a
;

419 
u8
 
	mª£rved_queue
;

422 
s8
 
	mtx_¥Ÿe˘i⁄
;

423 
boﬁ
 
	mâ_tx_¥Ÿe˘i⁄
;

425 
boﬁ
 
	mdißbÀ_tx
;

426 
u16
 
	mamsdu_íabÀd
;

427 
u16
 
	mmax_amsdu_Àn
;

428 
boﬁ
 
	m¶ìpög
;

429 
u8
 
	magg_tids
;

430 
u8
 
	m¶ìp_tx_cou¡
;

431 
u8
 
	mtx_™t
;

432 
u32
 
	m∑úwi£_cùhî
;

434 
iwl_mvm_lök_°a
 
	mdeÊök
;

435 
iwl_mvm_lök_°a
 
__rcu
 *
	mlök
[
IEEE80211_MLD_MAX_NUM_LINKS
];

438 
u16
 
iwl_mvm_tid_queued
(
iwl_mvm
 *
mvm
, 
iwl_mvm_tid_d©a
 *
tid_d©a
);

440 
ölöe
 
iwl_mvm_°a
 *

441 
	$iwl_mvm_°a_‰om_mac80211
(
õì80211_°a
 *
°a
)

443  (*)
°a
->
drv_¥iv
;

444 
	}
}

453 
	siwl_mvm_öt_°a
 {

454 
u32
 
	m°a_id
;

455 
u8
 
	mty≥
;

456 
u32
 
	mtfd_queue_msk
;

469 
iwl_mvm_°a_£nd_to_fw
(
iwl_mvm
 *
mvm
, 
õì80211_°a
 *
°a
,

470 
boﬁ
 
upd©e
, 
Êags
);

471 
iwl_mvm_föd_‰ì_°a_id
(
iwl_mvm
 *
mvm
, 
∆80211_i·y≥
 
i·y≥
);

472 
iwl_mvm_°a_öô
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

473 
õì80211_°a
 *
°a
, 
°a_id
, 
u8
 
°a_ty≥
);

474 
iwl_mvm_add_°a
(
iwl_mvm
 *
mvm
,

475 
õì80211_vif
 *
vif
,

476 
õì80211_°a
 *
°a
);

478 
ölöe
 
	$iwl_mvm_upd©e_°a
(
iwl_mvm
 *
mvm
,

479 
õì80211_vif
 *
vif
,

480 
õì80211_°a
 *
°a
)

482  
	`iwl_mvm_°a_£nd_to_fw
(
mvm
, 
°a
, 
åue
, 0);

483 
	}
}

485 
iwl_mvm_ªÆloc_queues_a·î_ª°¨t
(
iwl_mvm
 *
mvm
,

486 
õì80211_°a
 *
°a
);

487 
iwl_mvm_waô_°a_queues_em±y
(
iwl_mvm
 *
mvm
,

488 
iwl_mvm_°a
 *
mvm_°a
);

489 
boﬁ
 
iwl_mvm_°a_dñ
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

490 
õì80211_°a
 *
°a
,

491 
õì80211_lök_°a
 *
lök_°a
, *
ªt
);

492 
iwl_mvm_rm_°a
(
iwl_mvm
 *
mvm
,

493 
õì80211_vif
 *
vif
,

494 
õì80211_°a
 *
°a
);

495 
iwl_mvm_rm_°a_id
(
iwl_mvm
 *
mvm
,

496 
õì80211_vif
 *
vif
,

497 
u8
 
°a_id
);

498 
iwl_mvm_£t_°a_key
(
iwl_mvm
 *
mvm
,

499 
õì80211_vif
 *
vif
,

500 
õì80211_°a
 *
°a
,

501 
õì80211_key_c⁄f
 *
keyc⁄f
,

502 
u8
 
key_off£t
);

503 
iwl_mvm_ªmove_°a_key
(
iwl_mvm
 *
mvm
,

504 
õì80211_vif
 *
vif
,

505 
õì80211_°a
 *
°a
,

506 
õì80211_key_c⁄f
 *
keyc⁄f
);

508 
iwl_mvm_upd©e_tkù_key
(
iwl_mvm
 *
mvm
,

509 
õì80211_vif
 *
vif
,

510 
õì80211_key_c⁄f
 *
keyc⁄f
,

511 
õì80211_°a
 *
°a
, 
u32
 
iv32
,

512 
u16
 *
pha£1key
);

514 
iwl_mvm_rx_eo•_nŸif
(
iwl_mvm
 *
mvm
,

515 
iwl_rx_cmd_buf„r
 *
rxb
);

518 
iwl_mvm_°a_rx_agg
(
iwl_mvm
 *
mvm
, 
õì80211_°a
 *
°a
,

519 
tid
, 
u16
 
s¢
, 
boﬁ
 
°¨t
, u16 
buf_size
, u16 
timeout
);

520 
iwl_mvm_°a_tx_agg_°¨t
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

521 
õì80211_°a
 *
°a
, 
u16
 
tid
, u16 *
s¢
);

522 
iwl_mvm_°a_tx_agg_›î
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

523 
õì80211_°a
 *
°a
, 
u16
 
tid
, u16 
buf_size
,

524 
boﬁ
 
amsdu
);

525 
iwl_mvm_°a_tx_agg_°›
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

526 
õì80211_°a
 *
°a
, 
u16
 
tid
);

527 
iwl_mvm_°a_tx_agg_Êush
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

528 
õì80211_°a
 *
°a
, 
u16
 
tid
);

530 
iwl_mvm_°a_tx_agg
(
iwl_mvm
 *
mvm
, 
õì80211_°a
 *
°a
,

531 
tid
, 
u8
 
queue
, 
boﬁ
 
°¨t
);

533 
iwl_mvm_add_aux_°a
(
iwl_mvm
 *
mvm
, 
u32
 
lmac_id
);

534 
iwl_mvm_rm_aux_°a
(
iwl_mvm
 *
mvm
);

536 
iwl_mvm_Æloc_bˇ°_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
);

537 
iwl_mvm_‰ì_bˇ°_°a_queues
(
iwl_mvm
 *
mvm
,

538 
õì80211_vif
 *
vif
);

539 
iwl_mvm_£nd_add_bˇ°_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
);

540 
iwl_mvm_add_p2p_bˇ°_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
);

541 
iwl_mvm_£nd_rm_bˇ°_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
);

542 
iwl_mvm_rm_p2p_bˇ°_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
);

543 
iwl_mvm_add_mˇ°_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
);

544 
iwl_mvm_rm_mˇ°_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
);

545 
iwl_mvm_Æloˇã_öt_°a
(
iwl_mvm
 *
mvm
,

546 
iwl_mvm_öt_°a
 *
°a
,

547 
u32
 
qmask
, 
∆80211_i·y≥
 
i·y≥
,

548 
u8
 
ty≥
);

549 
iwl_mvm_dóŒoc_bˇ°_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
);

550 
iwl_mvm_dóŒoc_öt_°a
(
iwl_mvm
 *
mvm
, 
iwl_mvm_öt_°a
 *
°a
);

551 
iwl_mvm_add_¢if_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
);

552 
iwl_mvm_rm_¢if_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
);

553 
iwl_mvm_dóŒoc_¢if_°a
(
iwl_mvm
 *
mvm
);

555 
iwl_mvm_°a_modify_ps_wake
(
iwl_mvm
 *
mvm
,

556 
õì80211_°a
 *
°a
);

557 
iwl_mvm_°a_modify_¶ìp_tx_cou¡
(
iwl_mvm
 *
mvm
,

558 
õì80211_°a
 *
°a
,

559 
õì80211_‰ame_ªÀa£_ty≥
 
ªas⁄
,

560 
u16
 
˙t
, u16 
tids
, 
boﬁ
 
m‹e_d©a
,

561 
boﬁ
 
sögÀ_°a_queue
);

562 
iwl_mvm_døö_°a
(
iwl_mvm
 *
mvm
, 
iwl_mvm_°a
 *
mvm°a
,

563 
boﬁ
 
døö
);

564 
iwl_mvm_°a_modify_dißbÀ_tx
(
iwl_mvm
 *
mvm
,

565 
iwl_mvm_°a
 *
mvm°a
, 
boﬁ
 
dißbÀ
);

566 
iwl_mvm_°a_modify_dißbÀ_tx_≠
(
iwl_mvm
 *
mvm
,

567 
õì80211_°a
 *
°a
,

568 
boﬁ
 
dißbÀ
);

569 
iwl_mvm_modify_Æl_°a_dißbÀ_tx
(
iwl_mvm
 *
mvm
,

570 
iwl_mvm_vif
 *
mvmvif
,

571 
boﬁ
 
dißbÀ
);

573 
iwl_mvm_cß_˛õ¡_ab£¡
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
);

574 
iwl_mvm_°a_ísuª_queue
(
iwl_mvm
 *
mvm
, 
õì80211_txq
 *
txq
);

575 
iwl_mvm_add_√w_dqa_°ªam_wk
(
w‹k_°ru˘
 *
wk
);

576 
iwl_mvm_add_∑¢_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

577 
iwl_mvm_öt_°a
 *
°a
, 
u8
 *
addr
, 
u32
 
cùhî
,

578 
u8
 *
key
, 
u32
 
key_Àn
,

579 
õì80211_key_c⁄f
 *
key_c⁄f_out
);

580 
iwl_mvm_ˇn˚l_ch™√l_swôch
(
iwl_mvm
 *
mvm
,

581 
õì80211_vif
 *
vif
,

582 
u32
 
id
);

584 
iwl_mvm_tvqm_íabÀ_txq
(
iwl_mvm
 *
mvm
,

585 
õì80211_°a
 *
°a
,

586 
u8
 
°a_id
, u8 
tid
, 
timeout
);

602 
	siwl_mvm_°a_°©e_›s
 {

603 (*
	madd_°a
)(
iwl_mvm
 *
	mmvm
, 
õì80211_vif
 *
	mvif
,

604 
õì80211_°a
 *
	m°a
);

605 (*
	mupd©e_°a
)(
iwl_mvm
 *
	mmvm
, 
õì80211_vif
 *
	mvif
,

606 
õì80211_°a
 *
	m°a
);

607 (*
	mrm_°a
)(
iwl_mvm
 *
	mmvm
, 
õì80211_vif
 *
	mvif
,

608 
õì80211_°a
 *
	m°a
);

609 (*
	mmac_˘xt_ch™ged
)(
iwl_mvm
 *
	mmvm
, 
õì80211_vif
 *
	mvif
,

610 
boﬁ
 
	mf‹˚_assoc_off
);

613 
iwl_mvm_mac_°a_°©e_comm⁄
(
õì80211_hw
 *
hw
,

614 
õì80211_vif
 *
vif
,

615 
õì80211_°a
 *
°a
,

616 
õì80211_°a_°©e
 
ﬁd_°©e
,

617 
õì80211_°a_°©e
 
√w_°©e
,

618 c⁄° 
iwl_mvm_°a_°©e_›s
 *
ˇŒbacks
);

622 
iwl_mvm_mld_add_bˇ°_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

623 
õì80211_bss_c⁄f
 *
lök_c⁄f
);

624 
iwl_mvm_mld_add_¢if_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

625 
õì80211_bss_c⁄f
 *
lök_c⁄f
);

626 
iwl_mvm_mld_add_mˇ°_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

627 
õì80211_bss_c⁄f
 *
lök_c⁄f
);

628 
iwl_mvm_mld_add_aux_°a
(
iwl_mvm
 *
mvm
, 
u32
 
lmac_id
);

629 
iwl_mvm_mld_rm_bˇ°_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

630 
õì80211_bss_c⁄f
 *
lök_c⁄f
);

631 
iwl_mvm_mld_rm_¢if_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
);

632 
iwl_mvm_mld_rm_mˇ°_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

633 
õì80211_bss_c⁄f
 *
lök_c⁄f
);

634 
iwl_mvm_mld_rm_aux_°a
(
iwl_mvm
 *
mvm
);

635 
iwl_mvm_mld_add_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

636 
õì80211_°a
 *
°a
);

637 
iwl_mvm_mld_upd©e_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

638 
õì80211_°a
 *
°a
);

639 
iwl_mvm_mld_rm_°a
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

640 
õì80211_°a
 *
°a
);

641 
iwl_mvm_mld_rm_°a_id
(
iwl_mvm
 *
mvm
, 
u8
 
°a_id
);

642 
iwl_mvm_mld_upd©e_°a_löks
(
iwl_mvm
 *
mvm
,

643 
õì80211_vif
 *
vif
,

644 
õì80211_°a
 *
°a
,

645 
u16
 
ﬁd_löks
, u16 
√w_löks
);

646 
u32
 
iwl_mvm_°a_fw_id_mask
(
iwl_mvm
 *
mvm
, 
õì80211_°a
 *
°a
,

647 
fûãr_lök_id
);

648 
iwl_mvm_mld_add_öt_°a_wôh_queue
(
iwl_mvm
 *
mvm
,

649 
iwl_mvm_öt_°a
 *
°a
,

650 c⁄° 
u8
 *
addr
, 
lök_id
,

651 
u16
 *
queue
, 
u8
 
tid
,

652 *
_wdg_timeout
);

655 
iwl_mvm_mld_modify_Æl_°a_dißbÀ_tx
(
iwl_mvm
 *
mvm
,

656 
iwl_mvm_vif
 *
mvmvif
,

657 
boﬁ
 
dißbÀ
);

658 
iwl_mvm_mld_°a_modify_dißbÀ_tx
(
iwl_mvm
 *
mvm
,

659 
iwl_mvm_°a
 *
mvm_°a
,

660 
boﬁ
 
dißbÀ
);

661 
iwl_mvm_mld_°a_modify_dißbÀ_tx_≠
(
iwl_mvm
 *
mvm
,

662 
õì80211_°a
 *
°a
,

663 
boﬁ
 
dißbÀ
);

	@tdls.c

7 
	~<löux/ëhîdevi˚.h
>

8 
	~"mvm.h
"

9 
	~"time-evít.h
"

10 
	~"iwl-io.h
"

11 
	~"iwl-¥ph.h
"

13 
	#TU_TO_US
(
x
Ë(x * 1024)

	)

14 
	#TU_TO_MS
(
x
Ë(
	`TU_TO_US
(xË/ 1000)

	)

16 
	$iwl_mvm_ã¨down_tdls_≥îs
(
iwl_mvm
 *
mvm
)

18 
õì80211_°a
 *
°a
;

19 
iwl_mvm_°a
 *
mvm°a
;

20 
i
;

22 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

24 
i
 = 0; i < 
mvm
->
fw
->
ucode_ˇ∑
.
num_°©i⁄s
; i++) {

25 
°a
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm
->
fw_id_to_mac_id
[
i
],

26 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

27 i‡(!
°a
 || 
	`IS_ERR
(°aË|| !°a->
tdls
)

30 
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

31 
	`õì80211_tdls_›î_ªque°
(
mvm°a
->
vif
, 
°a
->
addr
,

32 
NL80211_TDLS_TEARDOWN
,

33 
WLAN_REASON_TDLS_TEARDOWN_UNSPECIFIED
,

34 
GFP_KERNEL
);

36 
	}
}

38 
	$iwl_mvm_tdls_°a_cou¡
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

40 
õì80211_°a
 *
°a
;

41 
iwl_mvm_°a
 *
mvm°a
;

42 
cou¡
 = 0;

43 
i
;

45 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

47 
i
 = 0; i < 
mvm
->
fw
->
ucode_ˇ∑
.
num_°©i⁄s
; i++) {

48 
°a
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm
->
fw_id_to_mac_id
[
i
],

49 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

50 i‡(!
°a
 || 
	`IS_ERR
(°aË|| !°a->
tdls
)

53 i‡(
vif
) {

54 
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

55 i‡(
mvm°a
->
vif
 != vif)

59 
cou¡
++;

62  
cou¡
;

63 
	}
}

65 
	$iwl_mvm_tdls_c⁄fig
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

67 
iwl_rx_∑ckë
 *
pkt
;

68 
iwl_tdls_c⁄fig_ªs
 *
ª•
;

69 
iwl_tdls_c⁄fig_cmd
 
tdls_cfg_cmd
 = {};

70 
iwl_ho°_cmd
 
cmd
 = {

71 .
id
 = 
TDLS_CONFIG_CMD
,

72 .
Êags
 = 
CMD_WANT_SKB
,

73 .
d©a
 = { &
tdls_cfg_cmd
, },

74 .
Àn
 = { (
iwl_tdls_c⁄fig_cmd
), },

76 
õì80211_°a
 *
°a
;

77 
ªt
, 
i
, 
˙t
;

78 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

80 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

82 
tdls_cfg_cmd
.
id_™d_cﬁ‹
 =

83 
	`˝u_to_À32
(
	`FW_CMD_ID_AND_COLOR
(
mvmvif
->
id
, mvmvif->
cﬁ‹
));

84 
tdls_cfg_cmd
.
tx_to_≠_tid
 = 
IWL_MVM_TDLS_FW_TID
;

85 
tdls_cfg_cmd
.
tx_to_≠_s¢
 = 
	`˝u_to_À16
(0);

90 
˙t
 = 0;

91 
i
 = 0; i < 
mvm
->
fw
->
ucode_ˇ∑
.
num_°©i⁄s
; i++) {

92 
°a
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm
->
fw_id_to_mac_id
[
i
],

93 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

94 i‡(
	`IS_ERR_OR_NULL
(
°a
Ë|| !°a->
tdls
)

97 
tdls_cfg_cmd
.
°a_öfo
[
˙t
].
°a_id
 = 
i
;

98 
tdls_cfg_cmd
.
°a_öfo
[
˙t
].
tx_to_≥î_tid
 =

99 
IWL_MVM_TDLS_FW_TID
;

100 
tdls_cfg_cmd
.
°a_öfo
[
˙t
].
tx_to_≥î_s¢
 = 
	`˝u_to_À16
(0);

101 
tdls_cfg_cmd
.
°a_öfo
[
˙t
].
is_öôüt‹
 =

102 
	`˝u_to_À32
(
°a
->
tdls_öôüt‹
 ? 1 : 0);

104 
˙t
++;

107 
tdls_cfg_cmd
.
tdls_≥î_cou¡
 = 
˙t
;

108 
	`IWL_DEBUG_TDLS
(
mvm
, "£nd TDLS c⁄figÅÿFW f‹ %dÖìrs\n", 
˙t
);

110 
ªt
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
cmd
);

111 i‡(
	`WARN_ON_ONCE
(
ªt
))

114 
pkt
 = 
cmd
.
ª•_pkt
;

116 
	`WARN_ON_ONCE
(
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
Ë!(*
ª•
));

120 
	`iwl_‰ì_ª•
(&
cmd
);

121 
	}
}

123 
	$iwl_mvm_ªˇlc_tdls_°©e
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

124 
boﬁ
 
°a_added
)

126 
tdls_°a_˙t
 = 
	`iwl_mvm_tdls_°a_cou¡
(
mvm
, 
vif
);

129 i‡(
tdls_°a_˙t
 =1 && 
°a_added
)

130 
	`iwl_mvm_powî_upd©e_mac
(
mvm
);

137 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

138 
IWL_UCODE_TLV_CAPA_TDLS_CHANNEL_SWITCH
))

139 
	`iwl_mvm_tdls_c⁄fig
(
mvm
, 
vif
);

142 i‡(
tdls_°a_˙t
 =0 && !
°a_added
)

143 
	`iwl_mvm_powî_upd©e_mac
(
mvm
);

144 
	}
}

146 
	$iwl_mvm_mac_mgd_¥Ÿe˘_tdls_discovî
(
õì80211_hw
 *
hw
,

147 
õì80211_vif
 *
vif
,

148 
lök_id
)

150 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

151 
u32
 
duøti⁄
 = 2 * 
vif
->
bss_c⁄f
.
dtim_≥riod
 * vif->bss_c⁄f.
bóc⁄_öt
;

154 
	`muãx_lock
(&
mvm
->
muãx
);

155 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

156 
IWL_UCODE_TLV_CAPA_SESSION_PROT_CMD
))

157 
	`iwl_mvm_scheduÀ_£ssi⁄_¥Ÿe˘i⁄
(
mvm
, 
vif
, 
duøti⁄
,

158 
duøti⁄
, 
åue
, 
lök_id
);

160 
	`iwl_mvm_¥Ÿe˘_£ssi⁄
(
mvm
, 
vif
, 
duøti⁄
,

161 
duøti⁄
, 100, 
åue
);

162 
	`muãx_u∆ock
(&
mvm
->
muãx
);

163 
	}
}

166 
	$iwl_mvm_tdls_cs_°©e_°r
(
iwl_mvm_tdls_cs_°©e
 
°©e
)

168 
°©e
) {

169 
IWL_MVM_TDLS_SW_IDLE
:

171 
IWL_MVM_TDLS_SW_REQ_SENT
:

173 
IWL_MVM_TDLS_SW_RESP_RCVD
:

175 
IWL_MVM_TDLS_SW_REQ_RCVD
:

177 
IWL_MVM_TDLS_SW_ACTIVE
:

181  
NULL
;

182 
	}
}

184 
	$iwl_mvm_tdls_upd©e_cs_°©e
(
iwl_mvm
 *
mvm
,

185 
iwl_mvm_tdls_cs_°©e
 
°©e
)

187 i‡(
mvm
->
tdls_cs
.
°©e
 == state)

190 
	`IWL_DEBUG_TDLS
(
mvm
, "TDLS channel switch state: %s -> %s\n",

191 
	`iwl_mvm_tdls_cs_°©e_°r
(
mvm
->
tdls_cs
.
°©e
),

192 
	`iwl_mvm_tdls_cs_°©e_°r
(
°©e
));

193 
mvm
->
tdls_cs
.
°©e
 = state;

196 i‡(
°©e
 =
IWL_MVM_TDLS_SW_REQ_SENT
)

197 
mvm
->
tdls_cs
.
≥î
.
£¡_time°amp
 = 
	`iwl_mvm_gë_sy°ime
(mvm);

199 i‡(
°©e
 =
IWL_MVM_TDLS_SW_IDLE
)

200 
mvm
->
tdls_cs
.
cur_°a_id
 = 
IWL_MVM_INVALID_STA
;

201 
	}
}

203 
	$iwl_mvm_rx_tdls_nŸif
(
iwl_mvm
 *
mvm
, 
iwl_rx_cmd_buf„r
 *
rxb
)

205 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

206 
iwl_tdls_ch™√l_swôch_nŸif
 *
nŸif
 = (*)
pkt
->
d©a
;

207 
õì80211_°a
 *
°a
;

208 
dñay
;

209 
iwl_mvm_°a
 *
mvm°a
;

210 
õì80211_vif
 *
vif
;

211 
u32
 
°a_id
 = 
	`À32_to_˝u
(
nŸif
->sta_id);

213 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

216 i‡(!
	`À32_to_˝u
(
nŸif
->
°©us
)) {

217 
	`iwl_mvm_tdls_upd©e_cs_°©e
(
mvm
, 
IWL_MVM_TDLS_SW_IDLE
);

221 i‡(
	`WARN_ON
(
°a_id
 >
mvm
->
fw
->
ucode_ˇ∑
.
num_°©i⁄s
))

224 
°a
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
mvm
->
fw_id_to_mac_id
[
°a_id
],

225 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

227 i‡(
	`IS_ERR_OR_NULL
(
°a
Ë|| 
	`WARN_ON
(!°a->
tdls
))

230 
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

231 
vif
 = 
mvm°a
->vif;

237 
dñay
 = 
	`TU_TO_MS
(
vif
->
bss_c⁄f
.
dtim_≥riod
 * vif->bss_c⁄f.
bóc⁄_öt
);

238 
	`mod_dñayed_w‹k
(
sy°em_wq
, &
mvm
->
tdls_cs
.
dw‹k
,

239 
	`m£cs_to_jiffõs
(
dñay
));

241 
	`iwl_mvm_tdls_upd©e_cs_°©e
(
mvm
, 
IWL_MVM_TDLS_SW_ACTIVE
);

242 
	}
}

245 
	$iwl_mvm_tdls_check_a˘i⁄
(
iwl_mvm
 *
mvm
,

246 
iwl_tdls_ch™√l_swôch_ty≥
 
ty≥
,

247 c⁄° 
u8
 *
≥î
, 
boﬁ
 
≥î_öôüt‹
, 
u32
 
time°amp
)

249 
boﬁ
 
ßme_≥î
 = 
Ál£
;

250 
ªt
 = 0;

253 i‡(
mvm
->
tdls_cs
.
°©e
 !
IWL_MVM_TDLS_SW_IDLE
 &&

254 
mvm
->
tdls_cs
.
cur_°a_id
 !
IWL_MVM_INVALID_STA
) {

255 
õì80211_°a
 *
°a
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(

256 
mvm
->
fw_id_to_mac_id
[mvm->
tdls_cs
.
cur_°a_id
],

257 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

258 i‡(!
	`IS_ERR_OR_NULL
(
°a
))

259 
ßme_≥î
 = 
	`ëhî_addr_equÆ
(
≥î
, 
°a
->
addr
);

262 
mvm
->
tdls_cs
.
°©e
) {

263 
IWL_MVM_TDLS_SW_IDLE
:

268 i‡(
ty≥
 =
TDLS_MOVE_CH
)

269 
ªt
 = -
EINVAL
;

271 
IWL_MVM_TDLS_SW_REQ_SENT
:

273 i‡(!
ßme_≥î
)

274 
ªt
 = -
EBUSY
;

275 i‡(
ty≥
 =
TDLS_SEND_CHAN_SW_RESP_AND_MOVE_CH
 &&

276 !
≥î_öôüt‹
)

282 
ªt
 = -
EBUSY
;

283 i‡(
ty≥
 =
TDLS_SEND_CHAN_SW_REQ
)

285 
ªt
 = -
EBUSY
;

286 i‡(
time°amp
 <
mvm
->
tdls_cs
.
≥î
.
£¡_time°amp
)

288 
ªt
 = -
EINVAL
;

290 
IWL_MVM_TDLS_SW_RESP_RCVD
:

295 
ªt
 = -
EBUSY
;

297 
IWL_MVM_TDLS_SW_REQ_RCVD
:

299 i‡(
ty≥
 =
TDLS_SEND_CHAN_SW_REQ
) {

300 i‡(!
ßme_≥î
)

301 
ªt
 = -
EBUSY
;

302 i‡(
≥î_öôüt‹
)

303 
ªt
 = -
EBUSY
;

304 } i‡(
ty≥
 =
TDLS_MOVE_CH
) {

305 
ªt
 = -
EINVAL
;

308 
IWL_MVM_TDLS_SW_ACTIVE
:

313 i‡(
ty≥
 !
TDLS_MOVE_CH
 || !
ßme_≥î
)

314 
ªt
 = -
EBUSY
;

318 i‡(
ªt
)

319 
	`IWL_DEBUG_TDLS
(
mvm
,

321 
ty≥
, 
mvm
->
tdls_cs
.
°©e
, 
≥î
, 
ßme_≥î
,

322 
≥î_öôüt‹
);

324  
ªt
;

325 
	}
}

328 
	$iwl_mvm_tdls_c⁄fig_ch™√l_swôch
(
iwl_mvm
 *
mvm
,

329 
õì80211_vif
 *
vif
,

330 
iwl_tdls_ch™√l_swôch_ty≥
 
ty≥
,

331 c⁄° 
u8
 *
≥î
, 
boﬁ
 
≥î_öôüt‹
,

332 
u8
 
›î_˛ass
,

333 
cfg80211_ch™_def
 *
ch™def
,

334 
u32
 
time°amp
, 
u16
 
swôch_time
,

335 
u16
 
swôch_timeout
, 
sk_buff
 *
skb
,

336 
u32
 
ch_sw_tm_õ
)

338 
õì80211_°a
 *
°a
;

339 
iwl_mvm_°a
 *
mvm°a
;

340 
õì80211_tx_öfo
 *
öfo
;

341 
õì80211_hdr
 *
hdr
;

342 
iwl_tdls_ch™√l_swôch_cmd
 
cmd
 = {0};

343 
iwl_tdls_ch™√l_swôch_cmd_èû
 *
èû
 =

344 
	`iwl_mvm_ch™_öfo_cmd_èû
(
mvm
, &
cmd
.
ci
);

345 
u16
 
Àn
 = (
cmd
Ë- 
	`iwl_mvm_ch™_öfo_∑ddög
(
mvm
);

346 
ªt
;

348 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

350 
ªt
 = 
	`iwl_mvm_tdls_check_a˘i⁄
(
mvm
, 
ty≥
, 
≥î
, 
≥î_öôüt‹
,

351 
time°amp
);

352 i‡(
ªt
)

353  
ªt
;

355 i‡(!
skb
 || 
	`WARN_ON
(skb->
Àn
 > 
IWL_TDLS_CH_SW_FRAME_MAX_SIZE
)) {

356 
ªt
 = -
EINVAL
;

357 
out
;

360 
cmd
.
swôch_ty≥
 = 
ty≥
;

361 
èû
->
timög
.
‰ame_time°amp
 = 
	`˝u_to_À32
(
time°amp
);

362 
èû
->
timög
.
swôch_time
 = 
	`˝u_to_À32
(switch_time);

363 
èû
->
timög
.
swôch_timeout
 = 
	`˝u_to_À32
(switch_timeout);

365 
	`rcu_ªad_lock
();

366 
°a
 = 
	`õì80211_föd_°a
(
vif
, 
≥î
);

367 i‡(!
°a
) {

368 
	`rcu_ªad_u∆ock
();

369 
ªt
 = -
ENOENT
;

370 
out
;

372 
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

373 
cmd
.
≥î_°a_id
 = 
	`˝u_to_À32
(
mvm°a
->
deÊök
.
°a_id
);

375 i‡(!
ch™def
) {

376 i‡(
mvm
->
tdls_cs
.
°©e
 =
IWL_MVM_TDLS_SW_REQ_SENT
 &&

377 
mvm
->
tdls_cs
.
≥î
.
ch™def
.
ch™
) {

379 
ch™def
 = &
mvm
->
tdls_cs
.
≥î
.chandef;

380 } i‡(
mvm
->
tdls_cs
.
°©e
 =
IWL_MVM_TDLS_SW_ACTIVE
 &&

381 
ty≥
 =
TDLS_MOVE_CH
) {

383 
õì80211_ch™˘x_c⁄f
 *
ch™˘x
 =

384 
	`rcu_dîe„ªn˚
(
vif
->
bss_c⁄f
.
ch™˘x_c⁄f
);

386 i‡(
	`WARN_ON_ONCE
(!
ch™˘x
)) {

387 
	`rcu_ªad_u∆ock
();

388 
out
;

391 
ch™def
 = &
ch™˘x
->
def
;

395 i‡(
ch™def
)

396 
	`iwl_mvm_£t_ch™_öfo_ch™def
(
mvm
, &
cmd
.
ci
, 
ch™def
);

399 
èû
->
timög
.
max_offch™_duøti⁄
 =

400 
	`˝u_to_À32
(
	`TU_TO_US
(
vif
->
bss_c⁄f
.
dtim_≥riod
 *

401 
vif
->
bss_c⁄f
.
bóc⁄_öt
) / 2);

404 
èû
->
‰ame
.
swôch_time_off£t
 = 
	`˝u_to_À32
(
ch_sw_tm_õ
 + 2);

406 
öfo
 = 
	`IEEE80211_SKB_CB
(
skb
);

407 
hdr
 = (*)
skb
->
d©a
;

408 i‡(
öfo
->
c⁄åﬁ
.
hw_key
) {

409 i‡(
öfo
->
c⁄åﬁ
.
hw_key
->
cùhî
 !
WLAN_CIPHER_SUITE_CCMP
) {

410 
	`rcu_ªad_u∆ock
();

411 
ªt
 = -
EINVAL
;

412 
out
;

414 
	`iwl_mvm_£t_tx_cmd_ccmp
(
öfo
, &
èû
->
‰ame
.
tx_cmd
);

417 
	`iwl_mvm_£t_tx_cmd
(
mvm
, 
skb
, &
èû
->
‰ame
.
tx_cmd
, 
öfo
,

418 
mvm°a
->
deÊök
.
°a_id
);

420 
	`iwl_mvm_£t_tx_cmd_øã
(
mvm
, &
èû
->
‰ame
.
tx_cmd
, 
öfo
, 
°a
,

421 
hdr
->
‰ame_c⁄åﬁ
);

422 
	`rcu_ªad_u∆ock
();

424 
	`mem˝y
(
èû
->
‰ame
.
d©a
, 
skb
->d©a, skb->
Àn
);

426 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
TDLS_CHANNEL_SWITCH_CMD
, 0, 
Àn
, &
cmd
);

427 i‡(
ªt
) {

428 
	`IWL_ERR
(
mvm
, "FailedÅo send TDLS_CHANNEL_SWITCH cmd: %d\n",

429 
ªt
);

430 
out
;

434 i‡(
ty≥
 !
TDLS_MOVE_CH
) {

435 
mvm
->
tdls_cs
.
cur_°a_id
 = 
mvm°a
->
deÊök
.
°a_id
;

436 
	`iwl_mvm_tdls_upd©e_cs_°©e
(
mvm
,

437 
ty≥
 =
TDLS_SEND_CHAN_SW_REQ
 ?

438 
IWL_MVM_TDLS_SW_REQ_SENT
 :

439 
IWL_MVM_TDLS_SW_REQ_RCVD
);

441 
	`iwl_mvm_tdls_upd©e_cs_°©e
(
mvm
, 
IWL_MVM_TDLS_SW_RESP_RCVD
);

444 
out
:

447 i‡(
ªt
)

448 
	`iwl_mvm_tdls_upd©e_cs_°©e
(
mvm
, 
IWL_MVM_TDLS_SW_IDLE
);

450  
ªt
;

451 
	}
}

453 
	$iwl_mvm_tdls_ch_swôch_w‹k
(
w‹k_°ru˘
 *
w‹k
)

455 
iwl_mvm
 *
mvm
;

456 
õì80211_°a
 *
°a
;

457 
iwl_mvm_°a
 *
mvm°a
;

458 
õì80211_vif
 *
vif
;

459 
dñay
;

460 
ªt
;

462 
mvm
 = 
	`c⁄èöî_of
(
w‹k
, 
iwl_mvm
, 
tdls_cs
.
dw‹k
.work);

463 
	`muãx_lock
(&
mvm
->
muãx
);

466 
	`iwl_mvm_tdls_upd©e_cs_°©e
(
mvm
, 
IWL_MVM_TDLS_SW_IDLE
);

469 i‡(
mvm
->
tdls_cs
.
≥î
.
°a_id
 =
IWL_MVM_INVALID_STA
)

470 
out
;

472 
°a
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(

473 
mvm
->
fw_id_to_mac_id
[mvm->
tdls_cs
.
≥î
.
°a_id
],

474 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

476 i‡(!
°a
 || 
	`IS_ERR
(°aË|| 
	`WARN_ON
(!°a->
tdls
))

477 
out
;

479 
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

480 
vif
 = 
mvm°a
->vif;

481 
ªt
 = 
	`iwl_mvm_tdls_c⁄fig_ch™√l_swôch
(
mvm
, 
vif
,

482 
TDLS_SEND_CHAN_SW_REQ
,

483 
°a
->
addr
,

484 
mvm
->
tdls_cs
.
≥î
.
öôüt‹
,

485 
mvm
->
tdls_cs
.
≥î
.
›_˛ass
,

486 &
mvm
->
tdls_cs
.
≥î
.
ch™def
,

488 
mvm
->
tdls_cs
.
≥î
.
skb
,

489 
mvm
->
tdls_cs
.
≥î
.
ch_sw_tm_õ
);

490 i‡(
ªt
)

491 
	`IWL_ERR
(
mvm
, "NŸ sídög TDLS ch™√»swôch: %d\n", 
ªt
);

494 
dñay
 = 
	`TU_TO_MS
(
vif
->
bss_c⁄f
.
dtim_≥riod
 * vif->bss_c⁄f.
bóc⁄_öt
);

495 
	`scheduÀ_dñayed_w‹k
(&
mvm
->
tdls_cs
.
dw‹k
, 
	`m£cs_to_jiffõs
(
dñay
));

496 
out
:

497 
	`muãx_u∆ock
(&
mvm
->
muãx
);

498 
	}
}

501 
	$iwl_mvm_tdls_ch™√l_swôch
(
õì80211_hw
 *
hw
,

502 
õì80211_vif
 *
vif
,

503 
õì80211_°a
 *
°a
, 
u8
 
›î_˛ass
,

504 
cfg80211_ch™_def
 *
ch™def
,

505 
sk_buff
 *
tm∂_skb
, 
u32
 
ch_sw_tm_õ
)

507 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

508 
iwl_mvm_°a
 *
mvm°a
;

509 
dñay
;

510 
ªt
;

512 
	`muãx_lock
(&
mvm
->
muãx
);

514 
	`IWL_DEBUG_TDLS
(
mvm
, "TDLS channel switch with %pM ch %d width %d\n",

515 
°a
->
addr
, 
ch™def
->
ch™
->
˚¡î_‰eq
, ch™def->
width
);

518 i‡(
mvm
->
tdls_cs
.
≥î
.
°a_id
 !
IWL_MVM_INVALID_STA
) {

519 
	`IWL_DEBUG_TDLS
(
mvm
,

521 
°a
->
addr
);

522 
ªt
 = -
EBUSY
;

523 
out
;

526 
ªt
 = 
	`iwl_mvm_tdls_c⁄fig_ch™√l_swôch
(
mvm
, 
vif
,

527 
TDLS_SEND_CHAN_SW_REQ
,

528 
°a
->
addr
, sè->
tdls_öôüt‹
,

529 
›î_˛ass
, 
ch™def
, 0, 0, 0,

530 
tm∂_skb
, 
ch_sw_tm_õ
);

531 i‡(
ªt
)

532 
out
;

538 
mvm
->
tdls_cs
.
≥î
.
skb
 = 
	`skb_c›y
(
tm∂_skb
, 
GFP_KERNEL
);

539 i‡(!
mvm
->
tdls_cs
.
≥î
.
skb
) {

540 
ªt
 = -
ENOMEM
;

541 
out
;

544 
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

545 
mvm
->
tdls_cs
.
≥î
.
°a_id
 = 
mvm°a
->
deÊök
.sta_id;

546 
mvm
->
tdls_cs
.
≥î
.
ch™def
 = *chandef;

547 
mvm
->
tdls_cs
.
≥î
.
öôüt‹
 = 
°a
->
tdls_öôüt‹
;

548 
mvm
->
tdls_cs
.
≥î
.
›_˛ass
 = 
›î_˛ass
;

549 
mvm
->
tdls_cs
.
≥î
.
ch_sw_tm_õ
 = ch_sw_tm_ie;

555 
dñay
 = 2 * 
	`TU_TO_MS
(
vif
->
bss_c⁄f
.
dtim_≥riod
 *

556 
vif
->
bss_c⁄f
.
bóc⁄_öt
);

557 
	`mod_dñayed_w‹k
(
sy°em_wq
, &
mvm
->
tdls_cs
.
dw‹k
,

558 
	`m£cs_to_jiffõs
(
dñay
));

560 
out
:

561 
	`muãx_u∆ock
(&
mvm
->
muãx
);

562  
ªt
;

563 
	}
}

565 
	$iwl_mvm_tdls_ˇn˚l_ch™√l_swôch
(
õì80211_hw
 *
hw
,

566 
õì80211_vif
 *
vif
,

567 
õì80211_°a
 *
°a
)

569 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

570 
õì80211_°a
 *
cur_°a
;

571 
boﬁ
 
waô_f‹_phy
 = 
Ál£
;

573 
	`muãx_lock
(&
mvm
->
muãx
);

575 
	`IWL_DEBUG_TDLS
(
mvm
, "TDLS c™˚»ch™√»swôch wôh %pM\n", 
°a
->
addr
);

578 i‡(
mvm
->
tdls_cs
.
≥î
.
°a_id
 =
IWL_MVM_INVALID_STA
) {

579 
	`IWL_DEBUG_TDLS
(
mvm
, "Nÿch swôchÖì∏- %pM\n", 
°a
->
addr
);

580 
out
;

583 
cur_°a
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(

584 
mvm
->
fw_id_to_mac_id
[mvm->
tdls_cs
.
≥î
.
°a_id
],

585 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

587 i‡(
cur_°a
 !
°a
)

588 
out
;

595 i‡(
mvm
->
tdls_cs
.
cur_°a_id
 =mvm->tdls_cs.
≥î
.
°a_id
 &&

596 
mvm
->
tdls_cs
.
°©e
 !
IWL_MVM_TDLS_SW_IDLE
)

597 
waô_f‹_phy
 = 
åue
;

599 
mvm
->
tdls_cs
.
≥î
.
°a_id
 = 
IWL_MVM_INVALID_STA
;

600 
	`dev_k‰ì_skb
(
mvm
->
tdls_cs
.
≥î
.
skb
);

601 
mvm
->
tdls_cs
.
≥î
.
skb
 = 
NULL
;

603 
out
:

604 
	`muãx_u∆ock
(&
mvm
->
muãx
);

607 i‡(
waô_f‹_phy
)

608 
	`m¶ìp
(
	`TU_TO_MS
(
vif
->
bss_c⁄f
.
dtim_≥riod
 *

609 
vif
->
bss_c⁄f
.
bóc⁄_öt
));

612 
	`Êush_dñayed_w‹k
(&
mvm
->
tdls_cs
.
dw‹k
);

614 
	`IWL_DEBUG_TDLS
(
mvm
, "TDLSÉndög ch™√»swôch wôh %pM\n", 
°a
->
addr
);

615 
	}
}

618 
	$iwl_mvm_tdls_ªcv_ch™√l_swôch
(
õì80211_hw
 *
hw
,

619 
õì80211_vif
 *
vif
,

620 
õì80211_tdls_ch_sw_∑øms
 *
∑øms
)

622 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

623 
iwl_tdls_ch™√l_swôch_ty≥
 
ty≥
;

624 
dñay
;

625 c⁄° *
a˘i⁄_°r
 =

626 
∑øms
->
a˘i⁄_code
 =
WLAN_TDLS_CHANNEL_SWITCH_REQUEST
 ?

629 
	`muãx_lock
(&
mvm
->
muãx
);

631 
	`IWL_DEBUG_TDLS
(
mvm
,

633 
a˘i⁄_°r
, 
∑øms
->
°a
->
addr
,Ö¨ams->
°©us
);

639 i‡(
∑øms
->
a˘i⁄_code
 =
WLAN_TDLS_CHANNEL_SWITCH_RESPONSE
 &&

640 
∑øms
->
°©us
 != 0 &&

641 
mvm
->
tdls_cs
.
°©e
 =
IWL_MVM_TDLS_SW_REQ_SENT
 &&

642 
mvm
->
tdls_cs
.
cur_°a_id
 !
IWL_MVM_INVALID_STA
) {

643 
õì80211_°a
 *
cur_°a
;

646 
cur_°a
 = 
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(

647 
mvm
->
fw_id_to_mac_id
[mvm->
tdls_cs
.
cur_°a_id
],

648 
	`lockdï_is_hñd
(&
mvm
->
muãx
));

649 i‡(
cur_°a
 =
∑øms
->
°a
) {

650 
	`iwl_mvm_tdls_upd©e_cs_°©e
(
mvm
,

651 
IWL_MVM_TDLS_SW_IDLE
);

652 
ªåy
;

656 
ty≥
 = (
∑øms
->
a˘i⁄_code
 =
WLAN_TDLS_CHANNEL_SWITCH_REQUEST
) ?

657 
TDLS_SEND_CHAN_SW_RESP_AND_MOVE_CH
 : 
TDLS_MOVE_CH
;

659 
	`iwl_mvm_tdls_c⁄fig_ch™√l_swôch
(
mvm
, 
vif
, 
ty≥
, 
∑øms
->
°a
->
addr
,

660 
∑øms
->
°a
->
tdls_öôüt‹
, 0,

661 
∑øms
->
ch™def
,Ö¨ams->
time°amp
,

662 
∑øms
->
swôch_time
,

663 
∑øms
->
swôch_timeout
,

664 
∑øms
->
tm∂_skb
,

665 
∑øms
->
ch_sw_tm_õ
);

667 
ªåy
:

669 
dñay
 = 
vif
->
bss_c⁄f
.
dtim_≥riod
 * vif->bss_c⁄f.
bóc⁄_öt
 *

671 
	`mod_dñayed_w‹k
(
sy°em_wq
, &
mvm
->
tdls_cs
.
dw‹k
,

672 
	`m£cs_to_jiffõs
(
dñay
));

673 
	`muãx_u∆ock
(&
mvm
->
muãx
);

674 
	}
}

	@testmode.h

61 #i‚de‡
__IWL_MVM_TESTMODE_H__


62 
	#__IWL_MVM_TESTMODE_H__


	)

71 
	eiwl_mvm_ã°mode_©ås
 {

72 
	mIWL_MVM_TM_ATTR_UNSPEC
,

73 
	mIWL_MVM_TM_ATTR_CMD
,

74 
	mIWL_MVM_TM_ATTR_NOA_DURATION
,

75 
	mIWL_MVM_TM_ATTR_BEACON_FILTER_STATE
,

78 
	mNUM_IWL_MVM_TM_ATTRS
,

79 
	mIWL_MVM_TM_ATTR_MAX
 = 
NUM_IWL_MVM_TM_ATTRS
 - 1,

87 
	eiwl_mvm_ã°mode_comm™ds
 {

88 
	mIWL_MVM_TM_CMD_SET_NOA
,

89 
	mIWL_MVM_TM_CMD_SET_BEACON_FILTER
,

	@time-event.c

7 
	~<löux/jiffõs.h
>

8 
	~<√t/mac80211.h
>

10 
	~"fw/nŸif-waô.h
"

11 
	~"iwl-å™s.h
"

12 
	~"fw-≠i.h
"

13 
	~"time-evít.h
"

14 
	~"mvm.h
"

15 
	~"iwl-io.h
"

16 
	~"iwl-¥ph.h
"

22 
	#IWL_MVM_ROC_TE_TYPE_NORMAL
 
TE_P2P_DEVICE_DISCOVERABLE


	)

23 
	#IWL_MVM_ROC_TE_TYPE_MGMT_TX
 
TE_P2P_CLIENT_ASSOC


	)

25 
	$iwl_mvm_ã_˛ór_d©a
(
iwl_mvm
 *
mvm
,

26 
iwl_mvm_time_evít_d©a
 *
ã_d©a
)

28 
	`lockdï_as£π_hñd
(&
mvm
->
time_evít_lock
);

30 i‡(!
ã_d©a
 || !ã_d©a->
vif
)

33 
	`li°_dñ
(&
ã_d©a
->
li°
);

39 
	`INIT_LIST_HEAD
(&
ã_d©a
->
li°
);

41 
ã_d©a
->
ru¬ög
 = 
Ál£
;

42 
ã_d©a
->
uid
 = 0;

43 
ã_d©a
->
id
 = 
TE_MAX
;

44 
ã_d©a
->
vif
 = 
NULL
;

45 
ã_d©a
->
lök_id
 = -1;

46 
	}
}

48 
	$iwl_mvm_˛ónup_roc
(
iwl_mvm
 *
mvm
)

61 i‡(
	`ã°_™d_˛ór_bô
(
IWL_MVM_STATUS_ROC_RUNNING
, &
mvm
->
°©us
)) {

62 
iwl_mvm_vif
 *
mvmvif
;

64 
	`synchr⁄ize_√t
();

73 i‡(!
	`WARN_ON
(!
mvm
->
p2p_devi˚_vif
)) {

74 
õì80211_vif
 *
vif
 = 
mvm
->
p2p_devi˚_vif
;

76 
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

77 
	`iwl_mvm_Êush_°a
(
mvm
, 
mvmvif
->
deÊök
.
bˇ°_°a
.
°a_id
,

78 
mvmvif
->
deÊök
.
bˇ°_°a
.
tfd_queue_msk
);

80 i‡(
mvm
->
mld_≠i_is_u£d
) {

81 
	`iwl_mvm_mld_rm_bˇ°_°a
(
mvm
, 
vif
,

82 &
vif
->
bss_c⁄f
);

84 
	`iwl_mvm_lök_ch™ged
(
mvm
, 
vif
, &vif->
bss_c⁄f
,

85 
LINK_CONTEXT_MODIFY_ACTIVE
,

86 
Ál£
);

88 
	`iwl_mvm_rm_p2p_bˇ°_°a
(
mvm
, 
vif
);

89 
	`iwl_mvm_bödög_ªmove_vif
(
mvm
, 
vif
);

101 i‡(
	`ã°_™d_˛ór_bô
(
IWL_MVM_STATUS_ROC_AUX_RUNNING
, &
mvm
->
°©us
)) {

102 
	`synchr⁄ize_√t
();

104 
	`iwl_mvm_Êush_°a
(
mvm
, mvm->
aux_°a
.
°a_id
,

105 
mvm
->
aux_°a
.
tfd_queue_msk
);

107 i‡(
mvm
->
mld_≠i_is_u£d
) {

108 
	`iwl_mvm_mld_rm_aux_°a
(
mvm
);

115 i‡(
	`iwl_mvm_has_√w_°©i⁄_≠i
(
mvm
->
fw
))

116 
	`iwl_mvm_rm_aux_°a
(
mvm
);

118 
	}
}

120 
	$iwl_mvm_roc_d⁄e_wk
(
w‹k_°ru˘
 *
wk
)

122 
iwl_mvm
 *
mvm
 = 
	`c⁄èöî_of
(
wk
, iwl_mvm, 
roc_d⁄e_wk
);

124 
	`muãx_lock
(&
mvm
->
muãx
);

125 
	`iwl_mvm_˛ónup_roc
(
mvm
);

126 
	`muãx_u∆ock
(&
mvm
->
muãx
);

127 
	}
}

129 
	$iwl_mvm_roc_föished
(
iwl_mvm
 *
mvm
)

138 
	`scheduÀ_w‹k
(&
mvm
->
roc_d⁄e_wk
);

139 
	}
}

141 
	$iwl_mvm_cß_nﬂ_°¨t
(
iwl_mvm
 *
mvm
)

143 
õì80211_vif
 *
cß_vif
;

145 
	`rcu_ªad_lock
();

147 
cß_vif
 = 
	`rcu_dîe„ªn˚
(
mvm
->csa_vif);

148 i‡(!
cß_vif
 || !cß_vif->
bss_c⁄f
.
cß_a˘ive
)

149 
out_u∆ock
;

151 
	`IWL_DEBUG_TE
(
mvm
, "CSA NOA started\n");

159 i‡(!
	`õì80211_bóc⁄_˙tdwn_is_com∂ëe
(
cß_vif
, 0)) {

160 
	`IWL_WARN
(
mvm
, "CSA NOA startedÅooÉarly\n");

161 
out_u∆ock
;

164 
	`õì80211_cß_föish
(
cß_vif
, 0);

166 
	`rcu_ªad_u∆ock
();

168 
	`RCU_INIT_POINTER
(
mvm
->
cß_vif
, 
NULL
);

172 
out_u∆ock
:

173 
	`rcu_ªad_u∆ock
();

174 
	}
}

176 
boﬁ
 
	$iwl_mvm_ã_check_disc⁄√˘
(
iwl_mvm
 *
mvm
,

177 
õì80211_vif
 *
vif
,

178 c⁄° *
îrmsg
)

180 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

182 i‡(
vif
->
ty≥
 !
NL80211_IFTYPE_STATION
)

183  
Ál£
;

185 i‡(!
mvmvif
->
cß_b˙_≥ndög
 && 
vif
->
cfg
.
assoc
 &&

186 
vif
->
bss_c⁄f
.
dtim_≥riod
)

187  
Ál£
;

188 i‡(
îrmsg
)

189 
	`IWL_ERR
(
mvm
, "%s\n", 
îrmsg
);

191 i‡(
mvmvif
->
cß_b˙_≥ndög
) {

192 
iwl_mvm_°a
 *
mvm°a
;

194 
	`rcu_ªad_lock
();

195 
mvm°a
 = 
	`iwl_mvm_°a_‰om_°aid_rcu
(
mvm
,

196 
mvmvif
->
deÊök
.
≠_°a_id
);

197 i‡(!
	`WARN_ON
(!
mvm°a
))

198 
	`iwl_mvm_°a_modify_dißbÀ_tx
(
mvm
, 
mvm°a
, 
Ál£
);

199 
	`rcu_ªad_u∆ock
();

202 i‡(
vif
->
cfg
.
assoc
) {

207 
	`iwl_dbg_év_time_poöt
(&
mvm
->
fwπ
,

208 
IWL_FW_INI_TIME_POINT_ASSOC_FAILED
,

209 
NULL
);

212 
	`iwl_mvm_c⁄√˘i⁄_loss
(
mvm
, 
vif
, 
îrmsg
);

213  
åue
;

214 
	}
}

217 
	$iwl_mvm_ã_h™dÀ_nŸify_cß
(
iwl_mvm
 *
mvm
,

218 
iwl_mvm_time_evít_d©a
 *
ã_d©a
,

219 
iwl_time_evít_nŸif
 *
nŸif
)

221 
õì80211_vif
 *
vif
 = 
ã_d©a
->vif;

222 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

224 i‡(!
nŸif
->
°©us
)

225 
	`IWL_DEBUG_TE
(
mvm
, "CSAÅimeÉvent failedÅo start\n");

227 
ã_d©a
->
vif
->
ty≥
) {

228 
NL80211_IFTYPE_AP
:

229 i‡(!
nŸif
->
°©us
)

230 
mvmvif
->
cß_Áûed
 = 
åue
;

231 
	`iwl_mvm_cß_nﬂ_°¨t
(
mvm
);

233 
NL80211_IFTYPE_STATION
:

234 i‡(!
nŸif
->
°©us
) {

235 
	`iwl_mvm_c⁄√˘i⁄_loss
(
mvm
, 
vif
,

239 
	`iwl_mvm_cß_˛õ¡_ab£¡
(
mvm
, 
ã_d©a
->
vif
);

240 
	`ˇn˚l_dñayed_w‹k
(&
mvmvif
->
cß_w‹k
);

241 
	`õì80211_chswôch_d⁄e
(
ã_d©a
->
vif
, 
åue
, 0);

245 
	`WARN_ON_ONCE
(1);

250 
	`iwl_mvm_ã_˛ór_d©a
(
mvm
, 
ã_d©a
);

251 
	}
}

253 
	$iwl_mvm_ã_check_åiggî
(
iwl_mvm
 *
mvm
,

254 
iwl_time_evít_nŸif
 *
nŸif
,

255 
iwl_mvm_time_evít_d©a
 *
ã_d©a
)

257 
iwl_fw_dbg_åiggî_év
 *
åig
;

258 
iwl_fw_dbg_åiggî_time_evít
 *
ã_åig
;

259 
i
;

261 
åig
 = 
	`iwl_fw_dbg_åiggî_⁄
(&
mvm
->
fwπ
,

262 
	`õì80211_vif_to_wdev
(
ã_d©a
->
vif
),

263 
FW_DBG_TRIGGER_TIME_EVENT
);

264 i‡(!
åig
)

267 
ã_åig
 = (*)
åig
->
d©a
;

269 
i
 = 0; i < 
	`ARRAY_SIZE
(
ã_åig
->
time_evíts
); i++) {

270 
u32
 
åig_ã_id
 = 
	`À32_to_˝u
(
ã_åig
->
time_evíts
[
i
].
id
);

271 
u32
 
åig_a˘i⁄_bôm≠
 =

272 
	`À32_to_˝u
(
ã_åig
->
time_evíts
[
i
].
a˘i⁄_bôm≠
);

273 
u32
 
åig_°©us_bôm≠
 =

274 
	`À32_to_˝u
(
ã_åig
->
time_evíts
[
i
].
°©us_bôm≠
);

276 i‡(
åig_ã_id
 !
ã_d©a
->
id
 ||

277 !(
åig_a˘i⁄_bôm≠
 & 
	`À32_to_˝u
(
nŸif
->
a˘i⁄
)) ||

278 !(
åig_°©us_bôm≠
 & 
	`BIT
(
	`À32_to_˝u
(
nŸif
->
°©us
))))

281 
	`iwl_fw_dbg_cﬁÀ˘_åig
(&
mvm
->
fwπ
, 
åig
,

283 
ã_d©a
->
id
,

284 
	`À32_to_˝u
(
nŸif
->
a˘i⁄
),

285 
	`À32_to_˝u
(
nŸif
->
°©us
));

288 
	}
}

297 
	$iwl_mvm_ã_h™dÀ_nŸif
(
iwl_mvm
 *
mvm
,

298 
iwl_mvm_time_evít_d©a
 *
ã_d©a
,

299 
iwl_time_evít_nŸif
 *
nŸif
)

301 
	`lockdï_as£π_hñd
(&
mvm
->
time_evít_lock
);

303 
	`IWL_DEBUG_TE
(
mvm
, "HandleÅimeÉventÇotif - UID = 0x%xáction %d\n",

304 
	`À32_to_˝u
(
nŸif
->
unique_id
),

305 
	`À32_to_˝u
(
nŸif
->
a˘i⁄
));

307 
	`iwl_mvm_ã_check_åiggî
(
mvm
, 
nŸif
, 
ã_d©a
);

317 i‡(!
	`À32_to_˝u
(
nŸif
->
°©us
)) {

318 c⁄° *
msg
;

320 i‡(
nŸif
->
a˘i⁄
 & 
	`˝u_to_À32
(
TE_V2_NOTIF_HOST_EVENT_START
))

321 
msg
 = "Time Event startÇotification failure";

323 
msg
 = "Time EventÉndÇotification failure";

325 
	`IWL_DEBUG_TE
(
mvm
, "%s\n", 
msg
);

327 i‡(
	`iwl_mvm_ã_check_disc⁄√˘
(
mvm
, 
ã_d©a
->
vif
, 
msg
)) {

328 
	`iwl_mvm_ã_˛ór_d©a
(
mvm
, 
ã_d©a
);

333 i‡(
	`À32_to_˝u
(
nŸif
->
a˘i⁄
Ë& 
TE_V2_NOTIF_HOST_EVENT_END
) {

334 
	`IWL_DEBUG_TE
(
mvm
,

336 
jiffõs
, 
ã_d©a
->
íd_jiffõs
);

338 
ã_d©a
->
vif
->
ty≥
) {

339 
NL80211_IFTYPE_P2P_DEVICE
:

340 
	`õì80211_ªmaö_⁄_ch™√l_expúed
(
mvm
->
hw
);

341 
	`iwl_mvm_roc_föished
(
mvm
);

343 
NL80211_IFTYPE_STATION
:

349 i‡(
ã_d©a
->
id
 =
TE_CHANNEL_SWITCH_PERIOD
) {

350 
	`IWL_DEBUG_TE
(
mvm
,

359 
	`iwl_mvm_ã_check_disc⁄√˘
(
mvm
, 
ã_d©a
->
vif
,

360 !
ã_d©a
->
vif
->
cfg
.
assoc
 ?

368 
	`iwl_mvm_ã_˛ór_d©a
(
mvm
, 
ã_d©a
);

369 } i‡(
	`À32_to_˝u
(
nŸif
->
a˘i⁄
Ë& 
TE_V2_NOTIF_HOST_EVENT_START
) {

370 
ã_d©a
->
ru¬ög
 = 
åue
;

371 
ã_d©a
->
íd_jiffõs
 = 
	`TU_TO_EXP_TIME
—e_d©a->
duøti⁄
);

373 i‡(
ã_d©a
->
vif
->
ty≥
 =
NL80211_IFTYPE_P2P_DEVICE
) {

374 
	`£t_bô
(
IWL_MVM_STATUS_ROC_RUNNING
, &
mvm
->
°©us
);

375 
	`õì80211_ªady_⁄_ch™√l
(
mvm
->
hw
);

376 } i‡(
ã_d©a
->
id
 =
TE_CHANNEL_SWITCH_PERIOD
) {

377 
	`iwl_mvm_ã_h™dÀ_nŸify_cß
(
mvm
, 
ã_d©a
, 
nŸif
);

380 
	`IWL_WARN
(
mvm
, "Got TE with unknownáction\n");

382 
	}
}

384 
	$iwl_mvm_rx_roc_nŸif
(
iwl_mvm
 *
mvm
,

385 
iwl_rx_cmd_buf„r
 *
rxb
)

387 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

388 
iwl_roc_nŸif
 *
nŸif
 = (*)
pkt
->
d©a
;

390 i‡(
	`À32_to_˝u
(
nŸif
->
suc˚ss
Ë&&Üe32_to_˝u“Ÿif->
°¨ãd
) &&

391 
	`À32_to_˝u
(
nŸif
->
a˘ivôy
Ë=
ROC_ACTIVITY_HOTSPOT
) {

392 
	`£t_bô
(
IWL_MVM_STATUS_ROC_AUX_RUNNING
, &
mvm
->
°©us
);

393 
	`õì80211_ªady_⁄_ch™√l
(
mvm
->
hw
);

395 
	`iwl_mvm_roc_föished
(
mvm
);

396 
	`õì80211_ªmaö_⁄_ch™√l_expúed
(
mvm
->
hw
);

398 
	}
}

403 
	$iwl_mvm_aux_roc_ã_h™dÀ_nŸif
(
iwl_mvm
 *
mvm
,

404 
iwl_time_evít_nŸif
 *
nŸif
)

406 
iwl_mvm_time_evít_d©a
 *
aux_roc_ã
 = 
NULL
, *
ã_d©a
;

408 
	`li°_f‹_óch_íåy
(
ã_d©a
, &
mvm
->
aux_roc_ã_li°
, 
li°
) {

409 i‡(
	`À32_to_˝u
(
nŸif
->
unique_id
Ë=
ã_d©a
->
uid
) {

410 
aux_roc_ã
 = 
ã_d©a
;

414 i‡(!
aux_roc_ã
)

415  -
EINVAL
;

417 
	`iwl_mvm_ã_check_åiggî
(
mvm
, 
nŸif
, 
ã_d©a
);

419 
	`IWL_DEBUG_TE
(
mvm
,

421 
	`À32_to_˝u
(
nŸif
->
unique_id
),

422 
	`À32_to_˝u
(
nŸif
->
a˘i⁄
),Üe32_to_˝u“Ÿif->
°©us
));

424 i‡(!
	`À32_to_˝u
(
nŸif
->
°©us
) ||

425 
	`À32_to_˝u
(
nŸif
->
a˘i⁄
Ë=
TE_V2_NOTIF_HOST_EVENT_END
) {

427 
	`õì80211_ªmaö_⁄_ch™√l_expúed
(
mvm
->
hw
);

428 
	`iwl_mvm_roc_föished
(
mvm
);

429 
	`li°_dñ
(&
ã_d©a
->
li°
);

430 
ã_d©a
->
ru¬ög
 = 
Ál£
;

431 
ã_d©a
->
vif
 = 
NULL
;

432 
ã_d©a
->
uid
 = 0;

433 
ã_d©a
->
id
 = 
TE_MAX
;

434 } i‡(
	`À32_to_˝u
(
nŸif
->
a˘i⁄
Ë=
TE_V2_NOTIF_HOST_EVENT_START
) {

435 
	`£t_bô
(
IWL_MVM_STATUS_ROC_AUX_RUNNING
, &
mvm
->
°©us
);

436 
ã_d©a
->
ru¬ög
 = 
åue
;

437 
	`õì80211_ªady_⁄_ch™√l
(
mvm
->
hw
);

439 
	`IWL_DEBUG_TE
(
mvm
,

441 
	`À32_to_˝u
(
nŸif
->
a˘i⁄
));

442  -
EINVAL
;

446 
	}
}

451 
	$iwl_mvm_rx_time_evít_nŸif
(
iwl_mvm
 *
mvm
,

452 
iwl_rx_cmd_buf„r
 *
rxb
)

454 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

455 
iwl_time_evít_nŸif
 *
nŸif
 = (*)
pkt
->
d©a
;

456 
iwl_mvm_time_evít_d©a
 *
ã_d©a
, *
tmp
;

458 
	`IWL_DEBUG_TE
(
mvm
, "TimeÉventÇotification - UID = 0x%xáction %d\n",

459 
	`À32_to_˝u
(
nŸif
->
unique_id
),

460 
	`À32_to_˝u
(
nŸif
->
a˘i⁄
));

462 
	`•ö_lock_bh
(&
mvm
->
time_evít_lock
);

464 i‡(!
	`iwl_mvm_aux_roc_ã_h™dÀ_nŸif
(
mvm
, 
nŸif
))

465 
u∆ock
;

467 
	`li°_f‹_óch_íåy_ß„
(
ã_d©a
, 
tmp
, &
mvm
->
time_evít_li°
, 
li°
) {

468 i‡(
	`À32_to_˝u
(
nŸif
->
unique_id
Ë=
ã_d©a
->
uid
)

469 
	`iwl_mvm_ã_h™dÀ_nŸif
(
mvm
, 
ã_d©a
, 
nŸif
);

471 
u∆ock
:

472 
	`•ö_u∆ock_bh
(&
mvm
->
time_evít_lock
);

473 
	}
}

475 
boﬁ
 
	$iwl_mvm_ã_nŸif
(
iwl_nŸif_waô_d©a
 *
nŸif_waô
,

476 
iwl_rx_∑ckë
 *
pkt
, *
d©a
)

478 
iwl_mvm
 *
mvm
 =

479 
	`c⁄èöî_of
(
nŸif_waô
, 
iwl_mvm
,Çotif_wait);

480 
iwl_mvm_time_evít_d©a
 *
ã_d©a
 = 
d©a
;

481 
iwl_time_evít_nŸif
 *
ª•
;

482 
ª•_Àn
 = 
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
);

484 i‡(
	`WARN_ON
(
pkt
->
hdr
.
cmd
 !
TIME_EVENT_NOTIFICATION
))

485  
åue
;

487 i‡(
	`WARN_ON_ONCE
(
ª•_Àn
 !(*
ª•
))) {

488 
	`IWL_ERR
(
mvm
, "Invalid TIME_EVENT_NOTIFICATIONÑesponse\n");

489  
åue
;

492 
ª•
 = (*)
pkt
->
d©a
;

495 i‡(
	`À32_to_˝u
(
ª•
->
unique_id
Ë!
ã_d©a
->
uid
)

496  
Ál£
;

498 
	`IWL_DEBUG_TE
(
mvm
, "TIME_EVENT_NOTIFICATIONÑesponse - UID = 0x%x\n",

499 
ã_d©a
->
uid
);

500 i‡(!
ª•
->
°©us
)

501 
	`IWL_ERR
(
mvm
,

504  
åue
;

505 
	}
}

507 
boﬁ
 
	$iwl_mvm_time_evít_ª•⁄£
(
iwl_nŸif_waô_d©a
 *
nŸif_waô
,

508 
iwl_rx_∑ckë
 *
pkt
, *
d©a
)

510 
iwl_mvm
 *
mvm
 =

511 
	`c⁄èöî_of
(
nŸif_waô
, 
iwl_mvm
,Çotif_wait);

512 
iwl_mvm_time_evít_d©a
 *
ã_d©a
 = 
d©a
;

513 
iwl_time_evít_ª•
 *
ª•
;

514 
ª•_Àn
 = 
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
);

516 i‡(
	`WARN_ON
(
pkt
->
hdr
.
cmd
 !
TIME_EVENT_CMD
))

517  
åue
;

519 i‡(
	`WARN_ON_ONCE
(
ª•_Àn
 !(*
ª•
))) {

520 
	`IWL_ERR
(
mvm
, "Invalid TIME_EVENT_CMDÑesponse\n");

521  
åue
;

524 
ª•
 = (*)
pkt
->
d©a
;

527 i‡(
	`WARN_ON_ONCE
(
	`À32_to_˝u
(
ª•
->
id
Ë!
ã_d©a
->id))

528  
Ál£
;

530 
ã_d©a
->
uid
 = 
	`À32_to_˝u
(
ª•
->
unique_id
);

531 
	`IWL_DEBUG_TE
(
mvm
, "TIME_EVENT_CMDÑesponse - UID = 0x%x\n",

532 
ã_d©a
->
uid
);

533  
åue
;

534 
	}
}

536 
	$iwl_mvm_time_evít_£nd_add
(
iwl_mvm
 *
mvm
,

537 
õì80211_vif
 *
vif
,

538 
iwl_mvm_time_evít_d©a
 *
ã_d©a
,

539 
iwl_time_evít_cmd
 *
ã_cmd
)

541 c⁄° 
u16
 
time_evít_ª•⁄£
[] = { 
TIME_EVENT_CMD
 };

542 
iwl_nŸifiˇti⁄_waô
 
waô_time_evít
;

543 
ªt
;

545 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

547 
	`IWL_DEBUG_TE
(
mvm
, "AddÇew TE, duration %d TU\n",

548 
	`À32_to_˝u
(
ã_cmd
->
duøti⁄
));

550 
	`•ö_lock_bh
(&
mvm
->
time_evít_lock
);

551 i‡(
	`WARN_ON
(
ã_d©a
->
id
 !
TE_MAX
)) {

552 
	`•ö_u∆ock_bh
(&
mvm
->
time_evít_lock
);

553  -
EIO
;

555 
ã_d©a
->
vif
 = vif;

556 
ã_d©a
->
duøti⁄
 = 
	`À32_to_˝u
(
ã_cmd
->duration);

557 
ã_d©a
->
id
 = 
	`À32_to_˝u
(
ã_cmd
->id);

558 
	`li°_add_èû
(&
ã_d©a
->
li°
, &
mvm
->
time_evít_li°
);

559 
	`•ö_u∆ock_bh
(&
mvm
->
time_evít_lock
);

570 
	`iwl_öô_nŸifiˇti⁄_waô
(&
mvm
->
nŸif_waô
, &
waô_time_evít
,

571 
time_evít_ª•⁄£
,

572 
	`ARRAY_SIZE
(
time_evít_ª•⁄£
),

573 
iwl_mvm_time_evít_ª•⁄£
, 
ã_d©a
);

575 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
TIME_EVENT_CMD
, 0,

576 (*
ã_cmd
),Åe_cmd);

577 i‡(
ªt
) {

578 
	`IWL_ERR
(
mvm
, "Couldn'à£nd TIME_EVENT_CMD: %d\n", 
ªt
);

579 
	`iwl_ªmove_nŸifiˇti⁄
(&
mvm
->
nŸif_waô
, &
waô_time_evít
);

580 
out_˛ór_ã
;

584 
ªt
 = 
	`iwl_waô_nŸifiˇti⁄
(&
mvm
->
nŸif_waô
, &
waô_time_evít
, 1);

586 
	`WARN_ON_ONCE
(
ªt
);

588 i‡(
ªt
) {

589 
out_˛ór_ã
:

590 
	`•ö_lock_bh
(&
mvm
->
time_evít_lock
);

591 
	`iwl_mvm_ã_˛ór_d©a
(
mvm
, 
ã_d©a
);

592 
	`•ö_u∆ock_bh
(&
mvm
->
time_evít_lock
);

594  
ªt
;

595 
	}
}

597 
	$iwl_mvm_¥Ÿe˘_£ssi⁄
(
iwl_mvm
 *
mvm
,

598 
õì80211_vif
 *
vif
,

599 
u32
 
duøti⁄
, u32 
mö_duøti⁄
,

600 
u32
 
max_dñay
, 
boﬁ
 
waô_f‹_nŸif
)

602 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

603 
iwl_mvm_time_evít_d©a
 *
ã_d©a
 = &
mvmvif
->
time_evít_d©a
;

604 c⁄° 
u16
 
ã_nŸif_ª•⁄£
[] = { 
TIME_EVENT_NOTIFICATION
 };

605 
iwl_nŸifiˇti⁄_waô
 
waô_ã_nŸif
;

606 
iwl_time_evít_cmd
 
time_cmd
 = {};

608 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

610 i‡(
ã_d©a
->
ru¬ög
 &&

611 
	`time_a·î
(
ã_d©a
->
íd_jiffõs
, 
	`TU_TO_EXP_TIME
(
mö_duøti⁄
))) {

612 
	`IWL_DEBUG_TE
(
mvm
, "We haveÉnoughÅime inÅhe current TE: %u\n",

613 
	`jiffõs_to_m£cs
(
ã_d©a
->
íd_jiffõs
 - 
jiffõs
));

617 i‡(
ã_d©a
->
ru¬ög
) {

618 
	`IWL_DEBUG_TE
(
mvm
, "extend 0x%x: only %u msÜeft\n",

619 
ã_d©a
->
uid
,

620 
	`jiffõs_to_m£cs
(
ã_d©a
->
íd_jiffõs
 - 
jiffõs
));

629 
	`iwl_mvm_°›_£ssi⁄_¥Ÿe˘i⁄
(
mvm
, 
vif
);

632 
time_cmd
.
a˘i⁄
 = 
	`˝u_to_À32
(
FW_CTXT_ACTION_ADD
);

633 
time_cmd
.
id_™d_cﬁ‹
 =

634 
	`˝u_to_À32
(
	`FW_CMD_ID_AND_COLOR
(
mvmvif
->
id
, mvmvif->
cﬁ‹
));

635 
time_cmd
.
id
 = 
	`˝u_to_À32
(
TE_BSS_STA_AGGRESSIVE_ASSOC
);

637 
time_cmd
.
≠∂y_time
 = 
	`˝u_to_À32
(0);

639 
time_cmd
.
max_‰ags
 = 
TE_V2_FRAG_NONE
;

640 
time_cmd
.
max_dñay
 = 
	`˝u_to_À32
(max_delay);

642 
time_cmd
.
öãrvÆ
 = 
	`˝u_to_À32
(1);

643 
time_cmd
.
duøti⁄
 = 
	`˝u_to_À32
(duration);

644 
time_cmd
.
ª≥©
 = 1;

645 
time_cmd
.
pﬁicy
 = 
	`˝u_to_À16
(
TE_V2_NOTIF_HOST_EVENT_START
 |

646 
TE_V2_NOTIF_HOST_EVENT_END
 |

647 
TE_V2_START_IMMEDIATELY
);

649 i‡(!
waô_f‹_nŸif
) {

650 
	`iwl_mvm_time_evít_£nd_add
(
mvm
, 
vif
, 
ã_d©a
, &
time_cmd
);

658 
	`iwl_öô_nŸifiˇti⁄_waô
(&
mvm
->
nŸif_waô
, &
waô_ã_nŸif
,

659 
ã_nŸif_ª•⁄£
,

660 
	`ARRAY_SIZE
(
ã_nŸif_ª•⁄£
),

661 
iwl_mvm_ã_nŸif
, 
ã_d©a
);

664 i‡(
	`iwl_mvm_time_evít_£nd_add
(
mvm
, 
vif
, 
ã_d©a
, &
time_cmd
)) {

665 
	`IWL_ERR
(
mvm
, "FailedÅoádd TEÅoÖrotect session\n");

666 
	`iwl_ªmove_nŸifiˇti⁄
(&
mvm
->
nŸif_waô
, &
waô_ã_nŸif
);

667 } i‡(
	`iwl_waô_nŸifiˇti⁄
(&
mvm
->
nŸif_waô
, &
waô_ã_nŸif
,

668 
	`TU_TO_JIFFIES
(
max_dñay
))) {

669 
	`IWL_ERR
(
mvm
, "FailedÅoÖrotect session until TE\n");

671 
	}
}

674 
	$iwl_mvm_gë_£ssi⁄_¥Ÿ_id
(
iwl_mvm
 *
mvm
,

675 
õì80211_vif
 *
vif
,

676 
s8
 
lök_id
)

678 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

679 
vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
,

680 
	`WIDE_ID
(
MAC_CONF_GROUP
,

681 
SESSION_PROTECTION_CMD
), 1);

683 i‡(
vî
 < 2)

684  
mvmvif
->
id
;

686 i‡(
	`WARN
(
lök_id
 < 0 || !
mvmvif
->
lök
[link_id],

687 "InvÆidÜök ID f‹ sessi⁄ÖrŸe˘i⁄: %u\n", 
lök_id
))

688  -
EINVAL
;

690 i‡(
	`WARN
(!
mvmvif
->
lök
[
lök_id
]->
a˘ive
,

691 "Sessi⁄ PrŸe˘i⁄ o¿™ i«˘ivêlök: %u\n", 
lök_id
))

692  -
EINVAL
;

694  
mvmvif
->
lök
[
lök_id
]->
fw_lök_id
;

695 
	}
}

697 
	$iwl_mvm_ˇn˚l_£ssi⁄_¥Ÿe˘i⁄
(
iwl_mvm
 *
mvm
,

698 
õì80211_vif
 *
vif
,

699 
u32
 
id
, 
s8
 
lök_id
)

701 
mac_lök_id
 = 
	`iwl_mvm_gë_£ssi⁄_¥Ÿ_id
(
mvm
, 
vif
, 
lök_id
);

702 
iwl_mvm_£ssi⁄_¥Ÿ_cmd
 
cmd
 = {

703 .
id_™d_cﬁ‹
 = 
	`˝u_to_À32
(
mac_lök_id
),

704 .
a˘i⁄
 = 
	`˝u_to_À32
(
FW_CTXT_ACTION_REMOVE
),

705 .
c⁄f_id
 = 
	`˝u_to_À32
(
id
),

707 
ªt
;

709 i‡(
mac_lök_id
 < 0)

712 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
,

713 
	`WIDE_ID
(
MAC_CONF_GROUP
, 
SESSION_PROTECTION_CMD
),

714 0, (
cmd
), &cmd);

715 i‡(
ªt
)

716 
	`IWL_ERR
(
mvm
,

717 "Couldn'à£ndÅhêSESSION_PROTECTION_CMD: %d\n", 
ªt
);

718 
	}
}

720 
boﬁ
 
	$__iwl_mvm_ªmove_time_evít
(
iwl_mvm
 *
mvm
,

721 
iwl_mvm_time_evít_d©a
 *
ã_d©a
,

722 
u32
 *
uid
)

724 
u32
 
id
;

725 
õì80211_vif
 *
vif
 = 
ã_d©a
->vif;

726 
iwl_mvm_vif
 *
mvmvif
;

727 
∆80211_i·y≥
 
i·y≥
;

728 
s8
 
lök_id
;

730 i‡(!
vif
)

731  
Ál£
;

733 
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
ã_d©a
->
vif
);

734 
i·y≥
 = 
ã_d©a
->
vif
->
ty≥
;

740 
	`•ö_lock_bh
(&
mvm
->
time_evít_lock
);

743 *
uid
 = 
ã_d©a
->uid;

744 
id
 = 
ã_d©a
->id;

745 
lök_id
 = 
ã_d©a
->link_id;

750 
	`iwl_mvm_ã_˛ór_d©a
(
mvm
, 
ã_d©a
);

751 
	`•ö_u∆ock_bh
(&
mvm
->
time_evít_lock
);

758 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

759 
IWL_UCODE_TLV_CAPA_SESSION_PROT_CMD
) &&

760 
id
 !
HOT_SPOT_CMD
) {

761 i‡(
mvmvif
 && 
id
 < 
SESSION_PROTECT_CONF_MAX_ID
) {

763 
	`iwl_mvm_ˇn˚l_£ssi⁄_¥Ÿe˘i⁄
(
mvm
, 
vif
, 
id
,

764 
lök_id
);

765 i‡(
i·y≥
 =
NL80211_IFTYPE_P2P_DEVICE
) {

766 
	`iwl_mvm_roc_föished
(
mvm
);

769  
Ál£
;

775 i‡(
id
 =
TE_MAX
) {

776 
	`IWL_DEBUG_TE
(
mvm
, "TE 0x%x ha†ÆªadyÉnded\n", *
uid
);

777  
Ál£
;

781  
åue
;

782 
	}
}

790 
	$iwl_mvm_ªmove_aux_roc_ã
(
iwl_mvm
 *
mvm
,

791 
iwl_mvm_vif
 *
mvmvif
,

792 
iwl_mvm_time_evít_d©a
 *
ã_d©a
)

794 
iwl_hs20_roc_ªq
 
aux_cmd
 = {};

795 
u16
 
Àn
 = (
aux_cmd
Ë- 
	`iwl_mvm_ch™_öfo_∑ddög
(
mvm
);

797 
u32
 
uid
;

798 
ªt
;

800 i‡(!
	`__iwl_mvm_ªmove_time_evít
(
mvm
, 
ã_d©a
, &
uid
))

803 
aux_cmd
.
evít_unique_id
 = 
	`˝u_to_À32
(
uid
);

804 
aux_cmd
.
a˘i⁄
 = 
	`˝u_to_À32
(
FW_CTXT_ACTION_REMOVE
);

805 
aux_cmd
.
id_™d_cﬁ‹
 =

806 
	`˝u_to_À32
(
	`FW_CMD_ID_AND_COLOR
(
mvmvif
->
id
, mvmvif->
cﬁ‹
));

807 
	`IWL_DEBUG_TE
(
mvm
, "Removing BSS AUX ROC TE 0x%x\n",

808 
	`À32_to_˝u
(
aux_cmd
.
evít_unique_id
));

809 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
HOT_SPOT_CMD
, 0,

810 
Àn
, &
aux_cmd
);

812 i‡(
	`WARN_ON
(
ªt
))

814 
	}
}

821 
	$iwl_mvm_ªmove_time_evít
(
iwl_mvm
 *
mvm
,

822 
iwl_mvm_vif
 *
mvmvif
,

823 
iwl_mvm_time_evít_d©a
 *
ã_d©a
)

825 
iwl_time_evít_cmd
 
time_cmd
 = {};

826 
u32
 
uid
;

827 
ªt
;

829 i‡(!
	`__iwl_mvm_ªmove_time_evít
(
mvm
, 
ã_d©a
, &
uid
))

833 
time_cmd
.
id
 = 
	`˝u_to_À32
(
uid
);

834 
time_cmd
.
a˘i⁄
 = 
	`˝u_to_À32
(
FW_CTXT_ACTION_REMOVE
);

835 
time_cmd
.
id_™d_cﬁ‹
 =

836 
	`˝u_to_À32
(
	`FW_CMD_ID_AND_COLOR
(
mvmvif
->
id
, mvmvif->
cﬁ‹
));

838 
	`IWL_DEBUG_TE
(
mvm
, "Removög TE 0x%x\n", 
	`À32_to_˝u
(
time_cmd
.
id
));

839 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
TIME_EVENT_CMD
, 0,

840 (
time_cmd
), &time_cmd);

841 i‡(
ªt
)

842 
	`IWL_ERR
(
mvm
, "Couldn'tÑemoveÅheÅimeÉvent\n");

843 
	}
}

845 
	$iwl_mvm_°›_£ssi⁄_¥Ÿe˘i⁄
(
iwl_mvm
 *
mvm
,

846 
õì80211_vif
 *
vif
)

848 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

849 
iwl_mvm_time_evít_d©a
 *
ã_d©a
 = &
mvmvif
->
time_evít_d©a
;

850 
u32
 
id
;

852 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

854 
	`•ö_lock_bh
(&
mvm
->
time_evít_lock
);

855 
id
 = 
ã_d©a
->id;

856 
	`•ö_u∆ock_bh
(&
mvm
->
time_evít_lock
);

858 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

859 
IWL_UCODE_TLV_CAPA_SESSION_PROT_CMD
)) {

860 i‡(
id
 !
SESSION_PROTECT_CONF_ASSOC
) {

861 
	`IWL_DEBUG_TE
(
mvm
,

863 
id
);

866 } i‡(
id
 !
TE_BSS_STA_AGGRESSIVE_ASSOC
) {

867 
	`IWL_DEBUG_TE
(
mvm
,

869 
id
);

873 
	`iwl_mvm_ªmove_time_evít
(
mvm
, 
mvmvif
, 
ã_d©a
);

874 
	}
}

876 
	$iwl_mvm_rx_£ssi⁄_¥Ÿe˘_nŸif
(
iwl_mvm
 *
mvm
,

877 
iwl_rx_cmd_buf„r
 *
rxb
)

879 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

880 
iwl_mvm_£ssi⁄_¥Ÿ_nŸif
 *
nŸif
 = (*)
pkt
->
d©a
;

881 
vî
 =

882 
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
MAC_CONF_GROUP
,

883 
SESSION_PROTECTION_NOTIF
, 2);

884 
id
 = 
	`À32_to_˝u
(
nŸif
->
mac_lök_id
);

885 
õì80211_vif
 *
vif
;

886 
iwl_mvm_vif
 *
mvmvif
;

887 
nŸif_lök_id
;

889 
	`rcu_ªad_lock
();

891 i‡(
vî
 <= 2) {

892 
vif
 = 
	`iwl_mvm_rcu_dîe„ªn˚_vif_id
(
mvm
, 
id
, 
åue
);

894 
õì80211_bss_c⁄f
 *
lök_c⁄f
 =

895 
	`iwl_mvm_rcu_fw_lök_id_to_lök_c⁄f
(
mvm
, 
id
, 
åue
);

897 i‡(!
lök_c⁄f
)

898 
out_u∆ock
;

900 
nŸif_lök_id
 = 
lök_c⁄f
->
lök_id
;

901 
vif
 = 
lök_c⁄f
->vif;

904 i‡(!
vif
)

905 
out_u∆ock
;

907 
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

909 i‡(
	`WARN
(
vî
 > 2 && 
mvmvif
->
time_evít_d©a
.
lök_id
 >= 0 &&

910 
mvmvif
->
time_evít_d©a
.
lök_id
 !
nŸif_lök_id
,

912 
nŸif_lök_id
, 
mvmvif
->
time_evít_d©a
.
lök_id
))

913 
out_u∆ock
;

916 i‡(
vif
->
ty≥
 !
NL80211_IFTYPE_P2P_DEVICE
) {

917 
iwl_mvm_time_evít_d©a
 *
ã_d©a
 =

918 &
mvmvif
->
time_evít_d©a
;

920 i‡(!
	`À32_to_˝u
(
nŸif
->
°©us
)) {

921 
	`iwl_mvm_ã_check_disc⁄√˘
(
mvm
, 
vif
,

923 
	`•ö_lock_bh
(&
mvm
->
time_evít_lock
);

924 
	`iwl_mvm_ã_˛ór_d©a
(
mvm
, 
ã_d©a
);

925 
	`•ö_u∆ock_bh
(&
mvm
->
time_evít_lock
);

928 i‡(
	`À32_to_˝u
(
nŸif
->
°¨t
)) {

929 
	`•ö_lock_bh
(&
mvm
->
time_evít_lock
);

930 
ã_d©a
->
ru¬ög
 = 
	`À32_to_˝u
(
nŸif
->
°¨t
);

931 
ã_d©a
->
íd_jiffõs
 =

932 
	`TU_TO_EXP_TIME
(
ã_d©a
->
duøti⁄
);

933 
	`•ö_u∆ock_bh
(&
mvm
->
time_evít_lock
);

939 
	`iwl_mvm_ã_check_disc⁄√˘
(
mvm
, 
vif
,

940 !
vif
->
cfg
.
assoc
 ?

943 
	`•ö_lock_bh
(&
mvm
->
time_evít_lock
);

944 
	`iwl_mvm_ã_˛ór_d©a
(
mvm
, 
ã_d©a
);

945 
	`•ö_u∆ock_bh
(&
mvm
->
time_evít_lock
);

948 
out_u∆ock
;

951 i‡(!
	`À32_to_˝u
(
nŸif
->
°©us
Ë|| !À32_to_˝u“Ÿif->
°¨t
)) {

953 
mvmvif
->
time_evít_d©a
.
id
 = 
SESSION_PROTECT_CONF_MAX_ID
;

954 
mvmvif
->
time_evít_d©a
.
lök_id
 = -1;

955 
	`iwl_mvm_roc_föished
(
mvm
);

956 
	`õì80211_ªmaö_⁄_ch™√l_expúed
(
mvm
->
hw
);

957 } i‡(
	`À32_to_˝u
(
nŸif
->
°¨t
)) {

958 i‡(
	`WARN_ON
(
mvmvif
->
time_evít_d©a
.
id
 !=

959 
	`À32_to_˝u
(
nŸif
->
c⁄f_id
)))

960 
out_u∆ock
;

961 
	`£t_bô
(
IWL_MVM_STATUS_ROC_RUNNING
, &
mvm
->
°©us
);

962 
	`õì80211_ªady_⁄_ch™√l
(
mvm
->
hw
);

965 
out_u∆ock
:

966 
	`rcu_ªad_u∆ock
();

967 
	}
}

969 
	#AUX_ROC_MIN_DURATION
 
	`MSEC_TO_TU
(100)

	)

970 
	#AUX_ROC_MIN_DELAY
 
	`MSEC_TO_TU
(200)

	)

971 
	#AUX_ROC_MAX_DELAY
 
	`MSEC_TO_TU
(600)

	)

972 
	#AUX_ROC_SAFETY_BUFFER
 
	`MSEC_TO_TU
(20)

	)

973 
	#AUX_ROC_MIN_SAFETY_BUFFER
 
	`MSEC_TO_TU
(10)

	)

975 
	$iwl_mvm_roc_duøti⁄_™d_dñay
(
õì80211_vif
 *
vif
,

976 
u32
 
duøti⁄_ms
,

977 
u32
 *
duøti⁄_tu
,

978 
u32
 *
dñay
)

980 
u32
 
dtim_öãrvÆ
 = 
vif
->
bss_c⁄f
.
dtim_≥riod
 *

981 
vif
->
bss_c⁄f
.
bóc⁄_öt
;

983 *
dñay
 = 
AUX_ROC_MIN_DELAY
;

984 *
duøti⁄_tu
 = 
	`MSEC_TO_TU
(
duøti⁄_ms
);

995 i‡(
vif
->
cfg
.
assoc
) {

996 *
dñay
 = 
	`mö_t
(
u32
, 
dtim_öãrvÆ
 * 3, 
AUX_ROC_MAX_DELAY
);

998 i‡(
dtim_öãrvÆ
 <*
duøti⁄_tu
) {

999 *
duøti⁄_tu
 = 
dtim_öãrvÆ
 - 
AUX_ROC_SAFETY_BUFFER
;

1000 i‡(*
duøti⁄_tu
 <
AUX_ROC_MIN_DURATION
)

1001 *
duøti⁄_tu
 = 
dtim_öãrvÆ
 -

1002 
AUX_ROC_MIN_SAFETY_BUFFER
;

1005 
	}
}

1007 
	$iwl_mvm_roc_add_cmd
(
iwl_mvm
 *
mvm
,

1008 
õì80211_ch™√l
 *
ch™√l
,

1009 
õì80211_vif
 *
vif
,

1010 
duøti⁄
, 
u32
 
a˘ivôy
)

1012 
ªs
;

1013 
u32
 
duøti⁄_tu
, 
dñay
;

1014 
iwl_roc_ªq
 
roc_ªq
 = {

1015 .
a˘i⁄
 = 
	`˝u_to_À32
(
FW_CTXT_ACTION_ADD
),

1016 .
a˘ivôy
 = 
	`˝u_to_À32
(activity),

1017 .
°a_id
 = 
	`˝u_to_À32
(
mvm
->
aux_°a
.sta_id),

1020 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1023 
	`iwl_mvm_£t_ch™_öfo
(
mvm
, &
roc_ªq
.
ch™√l_öfo
,

1024 
ch™√l
->
hw_vÆue
,

1025 
	`iwl_mvm_phy_b™d_‰om_∆80211
(
ch™√l
->
b™d
),

1026 
IWL_PHY_CHANNEL_MODE20
, 0);

1028 
	`iwl_mvm_roc_duøti⁄_™d_dñay
(
vif
, 
duøti⁄
, &
duøti⁄_tu
,

1029 &
dñay
);

1030 
roc_ªq
.
duøti⁄
 = 
	`˝u_to_À32
(
duøti⁄_tu
);

1031 
roc_ªq
.
max_dñay
 = 
	`˝u_to_À32
(
dñay
);

1033 
	`IWL_DEBUG_TE
(
mvm
,

1035 
duøti⁄
, 
dñay
);

1036 
	`IWL_DEBUG_TE
(
mvm
,

1038 
ch™√l
->
hw_vÆue
, 
duøti⁄_tu
);

1041 
	`mem˝y
(
roc_ªq
.
node_addr
, 
vif
->
addr
, 
ETH_ALEN
);

1043 
ªs
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
	`WIDE_ID
(
MAC_CONF_GROUP
, 
ROC_CMD
),

1044 0, (
roc_ªq
), &roc_req);

1046  
ªs
;

1047 
	}
}

1050 
	$iwl_mvm_°¨t_p2p_roc_£ssi⁄_¥Ÿe˘i⁄
(
iwl_mvm
 *
mvm
,

1051 
õì80211_vif
 *
vif
,

1052 
duøti⁄
,

1053 
õì80211_roc_ty≥
 
ty≥
)

1055 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1056 
iwl_mvm_£ssi⁄_¥Ÿ_cmd
 
cmd
 = {

1057 .
id_™d_cﬁ‹
 =

1058 
	`˝u_to_À32
(
	`iwl_mvm_gë_£ssi⁄_¥Ÿ_id
(
mvm
, 
vif
, 0)),

1059 .
a˘i⁄
 = 
	`˝u_to_À32
(
FW_CTXT_ACTION_ADD
),

1060 .
duøti⁄_tu
 = 
	`˝u_to_À32
(
	`MSEC_TO_TU
(
duøti⁄
)),

1063 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1069 
mvmvif
->
time_evít_d©a
.
lök_id
 = 0;

1071 
ty≥
) {

1072 
IEEE80211_ROC_TYPE_NORMAL
:

1073 
mvmvif
->
time_evít_d©a
.
id
 =

1074 
SESSION_PROTECT_CONF_P2P_DEVICE_DISCOV
;

1076 
IEEE80211_ROC_TYPE_MGMT_TX
:

1077 
mvmvif
->
time_evít_d©a
.
id
 =

1078 
SESSION_PROTECT_CONF_P2P_GO_NEGOTIATION
;

1081 
	`WARN_ONCE
(1, "Gotán invalid ROCÅype\n");

1082  -
EINVAL
;

1085 
cmd
.
c⁄f_id
 = 
	`˝u_to_À32
(
mvmvif
->
time_evít_d©a
.
id
);

1086  
	`iwl_mvm_£nd_cmd_pdu
(
mvm
,

1087 
	`WIDE_ID
(
MAC_CONF_GROUP
, 
SESSION_PROTECTION_CMD
),

1088 0, (
cmd
), &cmd);

1089 
	}
}

1091 
	$iwl_mvm_°¨t_p2p_roc
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

1092 
duøti⁄
, 
õì80211_roc_ty≥
 
ty≥
)

1094 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1095 
iwl_mvm_time_evít_d©a
 *
ã_d©a
 = &
mvmvif
->
time_evít_d©a
;

1096 
iwl_time_evít_cmd
 
time_cmd
 = {};

1098 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1099 i‡(
ã_d©a
->
ru¬ög
) {

1100 
	`IWL_WARN
(
mvm
, "P2P_DEVICEÑemain on channelálreadyÑunning\n");

1101  -
EBUSY
;

1104 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

1105 
IWL_UCODE_TLV_CAPA_SESSION_PROT_CMD
))

1106  
	`iwl_mvm_°¨t_p2p_roc_£ssi⁄_¥Ÿe˘i⁄
(
mvm
, 
vif
,

1107 
duøti⁄
,

1108 
ty≥
);

1110 
time_cmd
.
a˘i⁄
 = 
	`˝u_to_À32
(
FW_CTXT_ACTION_ADD
);

1111 
time_cmd
.
id_™d_cﬁ‹
 =

1112 
	`˝u_to_À32
(
	`FW_CMD_ID_AND_COLOR
(
mvmvif
->
id
, mvmvif->
cﬁ‹
));

1114 
ty≥
) {

1115 
IEEE80211_ROC_TYPE_NORMAL
:

1116 
time_cmd
.
id
 = 
	`˝u_to_À32
(
IWL_MVM_ROC_TE_TYPE_NORMAL
);

1118 
IEEE80211_ROC_TYPE_MGMT_TX
:

1119 
time_cmd
.
id
 = 
	`˝u_to_À32
(
IWL_MVM_ROC_TE_TYPE_MGMT_TX
);

1122 
	`WARN_ONCE
(1, "Gotán invalid ROCÅype\n");

1123  -
EINVAL
;

1126 
time_cmd
.
≠∂y_time
 = 
	`˝u_to_À32
(0);

1127 
time_cmd
.
öãrvÆ
 = 
	`˝u_to_À32
(1);

1135 
time_cmd
.
max_‰ags
 = 
	`mö
(
	`MSEC_TO_TU
(
duøti⁄
)/50, 
TE_V2_FRAG_ENDLESS
);

1136 
time_cmd
.
max_dñay
 = 
	`˝u_to_À32
(
	`MSEC_TO_TU
(
duøti⁄
/2));

1137 
time_cmd
.
duøti⁄
 = 
	`˝u_to_À32
(
	`MSEC_TO_TU
(duration));

1138 
time_cmd
.
ª≥©
 = 1;

1139 
time_cmd
.
pﬁicy
 = 
	`˝u_to_À16
(
TE_V2_NOTIF_HOST_EVENT_START
 |

1140 
TE_V2_NOTIF_HOST_EVENT_END
 |

1141 
TE_V2_START_IMMEDIATELY
);

1143  
	`iwl_mvm_time_evít_£nd_add
(
mvm
, 
vif
, 
ã_d©a
, &
time_cmd
);

1144 
	}
}

1146 
iwl_mvm_time_evít_d©a
 *
	$iwl_mvm_gë_roc_ã
(
iwl_mvm
 *
mvm
)

1148 
iwl_mvm_time_evít_d©a
 *
ã_d©a
;

1150 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1152 
	`•ö_lock_bh
(&
mvm
->
time_evít_lock
);

1161 
	`li°_f‹_óch_íåy
(
ã_d©a
, &
mvm
->
time_evít_li°
, 
li°
) {

1162 i‡(
ã_d©a
->
vif
->
ty≥
 =
NL80211_IFTYPE_P2P_DEVICE
)

1163 
out
;

1169 
ã_d©a
 = 
	`li°_fú°_íåy_‹_nuŒ
(&
mvm
->
aux_roc_ã_li°
,

1170 
iwl_mvm_time_evít_d©a
,

1171 
li°
);

1172 
out
:

1173 
	`•ö_u∆ock_bh
(&
mvm
->
time_evít_lock
);

1174  
ã_d©a
;

1175 
	}
}

1177 
	$iwl_mvm_˛ónup_roc_ã
(
iwl_mvm
 *
mvm
)

1179 
iwl_mvm_time_evít_d©a
 *
ã_d©a
;

1180 
u32
 
uid
;

1182 
ã_d©a
 = 
	`iwl_mvm_gë_roc_ã
(
mvm
);

1183 i‡(
ã_d©a
)

1184 
	`__iwl_mvm_ªmove_time_evít
(
mvm
, 
ã_d©a
, &
uid
);

1185 
	}
}

1187 
	$iwl_mvm_roc_rm_cmd
(
iwl_mvm
 *
mvm
, 
u32
 
a˘ivôy
)

1189 
ªt
;

1190 
iwl_roc_ªq
 
roc_cmd
 = {

1191 .
a˘i⁄
 = 
	`˝u_to_À32
(
FW_CTXT_ACTION_REMOVE
),

1192 .
a˘ivôy
 = 
	`˝u_to_À32
(activity),

1195 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1196 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
,

1197 
	`WIDE_ID
(
MAC_CONF_GROUP
, 
ROC_CMD
),

1198 0, (
roc_cmd
), &roc_cmd);

1199 
	`WARN_ON
(
ªt
);

1200 
	}
}

1202 
	$iwl_mvm_roc_°©i⁄_ªmove
(
iwl_mvm
 *
mvm
,

1203 
iwl_mvm_vif
 *
mvmvif
)

1205 
u32
 
cmd_id
 = 
	`WIDE_ID
(
MAC_CONF_GROUP
, 
ROC_CMD
);

1206 
u8
 
fw_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
cmd_id
,

1207 
IWL_FW_CMD_VER_UNKNOWN
);

1209 i‡(
fw_vî
 =
IWL_FW_CMD_VER_UNKNOWN
)

1210 
	`iwl_mvm_ªmove_aux_roc_ã
(
mvm
, 
mvmvif
,

1211 &
mvmvif
->
hs_time_evít_d©a
);

1212 i‡(
fw_vî
 == 3)

1213 
	`iwl_mvm_roc_rm_cmd
(
mvm
, 
ROC_ACTIVITY_HOTSPOT
);

1215 
	`IWL_ERR
(
mvm
, "ROC comm™d vîsi⁄ %d mism©ch!\n", 
fw_vî
);

1216 
	}
}

1218 
	$iwl_mvm_°›_roc
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

1220 
iwl_mvm_vif
 *
mvmvif
;

1221 
iwl_mvm_time_evít_d©a
 *
ã_d©a
;

1223 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

1224 
IWL_UCODE_TLV_CAPA_SESSION_PROT_CMD
)) {

1225 
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1226 
ã_d©a
 = &
mvmvif
->
time_evít_d©a
;

1228 i‡(
vif
->
ty≥
 =
NL80211_IFTYPE_P2P_DEVICE
) {

1229 i‡(
ã_d©a
->
id
 >
SESSION_PROTECT_CONF_MAX_ID
) {

1230 
	`IWL_DEBUG_TE
(
mvm
,

1235 
	`iwl_mvm_ˇn˚l_£ssi⁄_¥Ÿe˘i⁄
(
mvm
, 
vif
,

1236 
ã_d©a
->
id
,

1237 
ã_d©a
->
lök_id
);

1239 
	`iwl_mvm_roc_°©i⁄_ªmove
(
mvm
, 
mvmvif
);

1241 
˛ónup_roc
;

1244 
ã_d©a
 = 
	`iwl_mvm_gë_roc_ã
(
mvm
);

1245 i‡(!
ã_d©a
) {

1246 
	`IWL_WARN
(
mvm
, "NoÑemain on channelÉvent\n");

1250 
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
ã_d©a
->
vif
);

1252 i‡(
ã_d©a
->
vif
->
ty≥
 =
NL80211_IFTYPE_P2P_DEVICE
)

1253 
	`iwl_mvm_ªmove_time_evít
(
mvm
, 
mvmvif
, 
ã_d©a
);

1255 
	`iwl_mvm_ªmove_aux_roc_ã
(
mvm
, 
mvmvif
, 
ã_d©a
);

1257 
˛ónup_roc
:

1263 
	`£t_bô
(
vif
->
ty≥
 =
NL80211_IFTYPE_P2P_DEVICE
 ?

1264 
IWL_MVM_STATUS_ROC_RUNNING
 : 
IWL_MVM_STATUS_ROC_AUX_RUNNING
,

1265 &
mvm
->
°©us
);

1266 
	`iwl_mvm_˛ónup_roc
(
mvm
);

1267 
	}
}

1269 
	$iwl_mvm_ªmove_cß_≥riod
(
iwl_mvm
 *
mvm
,

1270 
õì80211_vif
 *
vif
)

1272 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1273 
iwl_mvm_time_evít_d©a
 *
ã_d©a
 = &
mvmvif
->
time_evít_d©a
;

1274 
u32
 
id
;

1276 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1278 
	`•ö_lock_bh
(&
mvm
->
time_evít_lock
);

1279 
id
 = 
ã_d©a
->id;

1280 
	`•ö_u∆ock_bh
(&
mvm
->
time_evít_lock
);

1282 i‡(
id
 !
TE_CHANNEL_SWITCH_PERIOD
)

1285 
	`iwl_mvm_ªmove_time_evít
(
mvm
, 
mvmvif
, 
ã_d©a
);

1286 
	}
}

1288 
	$iwl_mvm_scheduÀ_cß_≥riod
(
iwl_mvm
 *
mvm
,

1289 
õì80211_vif
 *
vif
,

1290 
u32
 
duøti⁄
, u32 
≠∂y_time
)

1292 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1293 
iwl_mvm_time_evít_d©a
 *
ã_d©a
 = &
mvmvif
->
time_evít_d©a
;

1294 
iwl_time_evít_cmd
 
time_cmd
 = {};

1296 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1298 i‡(
ã_d©a
->
ru¬ög
) {

1299 
u32
 
id
;

1301 
	`•ö_lock_bh
(&
mvm
->
time_evít_lock
);

1302 
id
 = 
ã_d©a
->id;

1303 
	`•ö_u∆ock_bh
(&
mvm
->
time_evít_lock
);

1305 i‡(
id
 =
TE_CHANNEL_SWITCH_PERIOD
) {

1306 
	`IWL_DEBUG_TE
(
mvm
, "CSÖeriod isálready scheduled\n");

1307  -
EBUSY
;

1315 
	`iwl_mvm_ªmove_time_evít
(
mvm
, 
mvmvif
, 
ã_d©a
);

1318 
time_cmd
.
a˘i⁄
 = 
	`˝u_to_À32
(
FW_CTXT_ACTION_ADD
);

1319 
time_cmd
.
id_™d_cﬁ‹
 =

1320 
	`˝u_to_À32
(
	`FW_CMD_ID_AND_COLOR
(
mvmvif
->
id
, mvmvif->
cﬁ‹
));

1321 
time_cmd
.
id
 = 
	`˝u_to_À32
(
TE_CHANNEL_SWITCH_PERIOD
);

1322 
time_cmd
.
≠∂y_time
 = 
	`˝u_to_À32
(apply_time);

1323 
time_cmd
.
max_‰ags
 = 
TE_V2_FRAG_NONE
;

1324 
time_cmd
.
duøti⁄
 = 
	`˝u_to_À32
(duration);

1325 
time_cmd
.
ª≥©
 = 1;

1326 
time_cmd
.
öãrvÆ
 = 
	`˝u_to_À32
(1);

1327 
time_cmd
.
pﬁicy
 = 
	`˝u_to_À16
(
TE_V2_NOTIF_HOST_EVENT_START
 |

1328 
TE_V2_ABSENCE
);

1329 i‡(!
≠∂y_time
)

1330 
time_cmd
.
pﬁicy
 |
	`˝u_to_À16
(
TE_V2_START_IMMEDIATELY
);

1332  
	`iwl_mvm_time_evít_£nd_add
(
mvm
, 
vif
, 
ã_d©a
, &
time_cmd
);

1333 
	}
}

1335 
boﬁ
 
	$iwl_mvm_£ssi⁄_¥Ÿ_nŸif
(
iwl_nŸif_waô_d©a
 *
nŸif_waô
,

1336 
iwl_rx_∑ckë
 *
pkt
, *
d©a
)

1338 
iwl_mvm
 *
mvm
 =

1339 
	`c⁄èöî_of
(
nŸif_waô
, 
iwl_mvm
,Çotif_wait);

1340 
iwl_mvm_£ssi⁄_¥Ÿ_nŸif
 *
ª•
;

1341 
ª•_Àn
 = 
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
);

1343 i‡(
	`WARN_ON
(
pkt
->
hdr
.
cmd
 !
SESSION_PROTECTION_NOTIF
 ||

1344 
pkt
->
hdr
.
group_id
 !
MAC_CONF_GROUP
))

1345  
åue
;

1347 i‡(
	`WARN_ON_ONCE
(
ª•_Àn
 !(*
ª•
))) {

1348 
	`IWL_ERR
(
mvm
, "Invalid SESSION_PROTECTION_NOTIFÑesponse\n");

1349  
åue
;

1352 
ª•
 = (*)
pkt
->
d©a
;

1354 i‡(!
ª•
->
°©us
)

1355 
	`IWL_ERR
(
mvm
,

1358  
åue
;

1359 
	}
}

1361 
	$iwl_mvm_scheduÀ_£ssi⁄_¥Ÿe˘i⁄
(
iwl_mvm
 *
mvm
,

1362 
õì80211_vif
 *
vif
,

1363 
u32
 
duøti⁄
, u32 
mö_duøti⁄
,

1364 
boﬁ
 
waô_f‹_nŸif
,

1365 
lök_id
)

1367 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1368 
iwl_mvm_time_evít_d©a
 *
ã_d©a
 = &
mvmvif
->
time_evít_d©a
;

1369 c⁄° 
u16
 
nŸif
[] = { 
	`WIDE_ID
(
MAC_CONF_GROUP
, 
SESSION_PROTECTION_NOTIF
) };

1370 
iwl_nŸifiˇti⁄_waô
 
waô_nŸif
;

1371 
mac_lök_id
 = 
	`iwl_mvm_gë_£ssi⁄_¥Ÿ_id
(
mvm
, 
vif
, (
s8
)
lök_id
);

1372 
iwl_mvm_£ssi⁄_¥Ÿ_cmd
 
cmd
 = {

1373 .
id_™d_cﬁ‹
 = 
	`˝u_to_À32
(
mac_lök_id
),

1374 .
a˘i⁄
 = 
	`˝u_to_À32
(
FW_CTXT_ACTION_ADD
),

1375 .
c⁄f_id
 = 
	`˝u_to_À32
(
SESSION_PROTECT_CONF_ASSOC
),

1376 .
duøti⁄_tu
 = 
	`˝u_to_À32
(
	`MSEC_TO_TU
(
duøti⁄
)),

1379 i‡(
mac_lök_id
 < 0)

1382 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1384 
	`•ö_lock_bh
(&
mvm
->
time_evít_lock
);

1385 i‡(
ã_d©a
->
ru¬ög
 &&Åe_d©a->
lök_id
 ==Üink_id &&

1386 
	`time_a·î
(
ã_d©a
->
íd_jiffõs
, 
	`TU_TO_EXP_TIME
(
mö_duøti⁄
))) {

1387 
	`IWL_DEBUG_TE
(
mvm
, "We haveÉnoughÅime inÅhe current TE: %u\n",

1388 
	`jiffõs_to_m£cs
(
ã_d©a
->
íd_jiffõs
 - 
jiffõs
));

1389 
	`•ö_u∆ock_bh
(&
mvm
->
time_evít_lock
);

1394 
	`iwl_mvm_ã_˛ór_d©a
(
mvm
, 
ã_d©a
);

1399 
ã_d©a
->
id
 = 
	`À32_to_˝u
(
cmd
.
c⁄f_id
);

1400 
ã_d©a
->
duøti⁄
 = 
	`À32_to_˝u
(
cmd
.
duøti⁄_tu
);

1401 
ã_d©a
->
vif
 = vif;

1402 
ã_d©a
->
lök_id
 =Üink_id;

1403 
	`•ö_u∆ock_bh
(&
mvm
->
time_evít_lock
);

1405 
	`IWL_DEBUG_TE
(
mvm
, "AddÇew sessionÖrotection, duration %d TU\n",

1406 
	`À32_to_˝u
(
cmd
.
duøti⁄_tu
));

1408 i‡(!
waô_f‹_nŸif
) {

1409 i‡(
	`iwl_mvm_£nd_cmd_pdu
(
mvm
,

1410 
	`WIDE_ID
(
MAC_CONF_GROUP
, 
SESSION_PROTECTION_CMD
),

1411 0, (
cmd
), &cmd)) {

1412 
£nd_cmd_îr
;

1418 
	`iwl_öô_nŸifiˇti⁄_waô
(&
mvm
->
nŸif_waô
, &
waô_nŸif
,

1419 
nŸif
, 
	`ARRAY_SIZE
(notif),

1420 
iwl_mvm_£ssi⁄_¥Ÿ_nŸif
, 
NULL
);

1422 i‡(
	`iwl_mvm_£nd_cmd_pdu
(
mvm
,

1423 
	`WIDE_ID
(
MAC_CONF_GROUP
, 
SESSION_PROTECTION_CMD
),

1424 0, (
cmd
), &cmd)) {

1425 
	`iwl_ªmove_nŸifiˇti⁄
(&
mvm
->
nŸif_waô
, &
waô_nŸif
);

1426 
£nd_cmd_îr
;

1427 } i‡(
	`iwl_waô_nŸifiˇti⁄
(&
mvm
->
nŸif_waô
, &
waô_nŸif
,

1428 
	`TU_TO_JIFFIES
(100))) {

1429 
	`IWL_ERR
(
mvm
,

1434 
£nd_cmd_îr
:

1435 
	`IWL_ERR
(
mvm
,

1437 
	`•ö_lock_bh
(&
mvm
->
time_evít_lock
);

1438 
	`iwl_mvm_ã_˛ór_d©a
(
mvm
, 
ã_d©a
);

1439 
	`•ö_u∆ock_bh
(&
mvm
->
time_evít_lock
);

1440 
	}
}

	@time-event.h

6 #i‚de‡
__time_evít_h__


7 
	#__time_evít_h__


	)

9 
	~"fw-≠i.h
"

11 
	~"mvm.h
"

58 
	#IWL_MVM_TE_SESSION_PROTECTION_MAX_TIME_MS
 600

	)

59 
	#IWL_MVM_TE_SESSION_PROTECTION_MIN_TIME_MS
 400

	)

79 
iwl_mvm_¥Ÿe˘_£ssi⁄
(
iwl_mvm
 *
mvm
,

80 
õì80211_vif
 *
vif
,

81 
u32
 
duøti⁄
, u32 
mö_duøti⁄
,

82 
u32
 
max_dñay
, 
boﬁ
 
waô_f‹_nŸif
);

94 
iwl_mvm_°›_£ssi⁄_¥Ÿe˘i⁄
(
iwl_mvm
 *
mvm
,

95 
õì80211_vif
 *
vif
);

100 
iwl_mvm_rx_time_evít_nŸif
(
iwl_mvm
 *
mvm
,

101 
iwl_rx_cmd_buf„r
 *
rxb
);

108 
iwl_mvm_rx_roc_nŸif
(
iwl_mvm
 *
mvm
,

109 
iwl_rx_cmd_buf„r
 *
rxb
);

128 
iwl_mvm_°¨t_p2p_roc
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

129 
duøti⁄
, 
õì80211_roc_ty≥
 
ty≥
);

140 
iwl_mvm_°›_roc
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
);

152 
iwl_mvm_ªmove_time_evít
(
iwl_mvm
 *
mvm
,

153 
iwl_mvm_vif
 *
mvmvif
,

154 
iwl_mvm_time_evít_d©a
 *
ã_d©a
);

164 
iwl_mvm_ã_˛ór_d©a
(
iwl_mvm
 *
mvm
,

165 
iwl_mvm_time_evít_d©a
 *
ã_d©a
);

167 
iwl_mvm_˛ónup_roc_ã
(
iwl_mvm
 *
mvm
);

168 
iwl_mvm_roc_d⁄e_wk
(
w‹k_°ru˘
 *
wk
);

170 
iwl_mvm_ªmove_cß_≥riod
(
iwl_mvm
 *
mvm
,

171 
õì80211_vif
 *
vif
);

183 
iwl_mvm_scheduÀ_cß_≥riod
(
iwl_mvm
 *
mvm
,

184 
õì80211_vif
 *
vif
,

185 
u32
 
duøti⁄
, u32 
≠∂y_time
);

193 
ölöe
 
boﬁ


194 
	$iwl_mvm_ã_scheduÀd
(
iwl_mvm_time_evít_d©a
 *
ã_d©a
)

196 i‡(!
ã_d©a
)

197  
Ál£
;

199  !!
ã_d©a
->
uid
;

200 
	}
}

211 
iwl_mvm_scheduÀ_£ssi⁄_¥Ÿe˘i⁄
(
iwl_mvm
 *
mvm
,

212 
õì80211_vif
 *
vif
,

213 
u32
 
duøti⁄
, u32 
mö_duøti⁄
,

214 
boﬁ
 
waô_f‹_nŸif
,

215 
lök_id
);

222 
iwl_mvm_rx_£ssi⁄_¥Ÿe˘_nŸif
(
iwl_mvm
 *
mvm
,

223 
iwl_rx_cmd_buf„r
 *
rxb
);

	@time-sync.c

6 
	~"mvm.h
"

7 
	~"time-sync.h
"

8 
	~<löux/õì80211.h
>

10 
	$iwl_mvm_öô_time_sync
(
iwl_time_sync_d©a
 *
d©a
)

12 
	`skb_queue_hód_öô
(&
d©a
->
‰ame_li°
);

13 
	}
}

15 
boﬁ
 
	$iwl_mvm_is_skb_m©ch
(
sk_buff
 *
skb
, 
u8
 *
addr
, u8 
dülog_tokí
)

17 
õì80211_mgmt
 *
mgmt
 = (*)
skb
->
d©a
;

18 
u8
 
skb_dülog_tokí
;

20 i‡(
	`õì80211_is_timög_mósuªmít
(
skb
))

21 
skb_dülog_tokí
 = 
mgmt
->
u
.
a˘i⁄
.u.
wnm_timög_m§
.
dülog_tokí
;

23 
skb_dülog_tokí
 = 
mgmt
->
u
.
a˘i⁄
.u.
·m
.
dülog_tokí
;

25 i‡((
	`ëhî_addr_equÆ
(
mgmt
->
ß
, 
addr
) ||

26 
	`ëhî_addr_equÆ
(
mgmt
->
da
, 
addr
)) &&

27 
skb_dülog_tokí
 =
dülog_tokí
)

28  
åue
;

30  
Ál£
;

31 
	}
}

33 
sk_buff
 *
	$iwl_mvm_time_sync_föd_skb
(
iwl_mvm
 *
mvm
, 
u8
 *
addr
,

34 
u8
 
dülog_tokí
)

36 
sk_buff
 *
skb
;

42 (
skb
 = 
	`skb_dequeue
(&
mvm
->
time_sync
.
‰ame_li°
))) {

43 i‡(
	`iwl_mvm_is_skb_m©ch
(
skb
, 
addr
, 
dülog_tokí
))

46 
	`k‰ì_skb
(
skb
);

47 
skb
 = 
NULL
;

50  
skb
;

51 
	}
}

53 
u64
 
	$iwl_mvm_gë_64_bô
(
__À32
 
high
, __À32 
low
)

55  ((
u64
)
	`À32_to_˝u
(
high
Ë<< 32Ë|Üe32_to_˝u(
low
);

56 
	}
}

58 
	$iwl_mvm_time_sync_msmt_evít
(
iwl_mvm
 *
mvm
,

59 
iwl_rx_cmd_buf„r
 *
rxb
)

61 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

62 
iwl_time_msmt_nŸify
 *
nŸif
 = (*)
pkt
->
d©a
;

63 
õì80211_rx_°©us
 *
rx_°©us
;

64 
skb_sh¨ed_hwt°amps
 *
shwt
;

65 
u64
 
ts_10ns
;

66 
sk_buff
 *
skb
 =

67 
	`iwl_mvm_time_sync_föd_skb
(
mvm
, 
nŸif
->
≥î_addr
,

68 
	`À32_to_˝u
(
nŸif
->
dülog_tokí
));

69 
u64
 
adj_time
;

71 i‡(!
skb
) {

72 
	`IWL_DEBUG_INFO
(
mvm
, "Time syncÉvent butÇoÖending skb\n");

76 
ts_10ns
 = 
	`iwl_mvm_gë_64_bô
(
nŸif
->
t2_hi
,ÇŸif->
t2_lo
);

77 
adj_time
 = 
	`iwl_mvm_±p_gë_adj_time
(
mvm
, 
ts_10ns
 * 10);

78 
shwt
 = 
	`skb_hwt°amps
(
skb
);

79 
shwt
->
hwt°amp
 = 
	`ktime_£t
(0, 
adj_time
);

81 
ts_10ns
 = 
	`iwl_mvm_gë_64_bô
(
nŸif
->
t3_hi
,ÇŸif->
t3_lo
);

82 
adj_time
 = 
	`iwl_mvm_±p_gë_adj_time
(
mvm
, 
ts_10ns
 * 10);

83 
rx_°©us
 = 
	`IEEE80211_SKB_RXCB
(
skb
);

84 
rx_°©us
->
ack_tx_hwt°amp
 = 
	`ktime_£t
(0, 
adj_time
);

86 
	`IWL_DEBUG_INFO
(
mvm
,

88 
	`ktime_to_ns
(
shwt
->
hwt°amp
),

89 
	`ktime_to_ns
(
rx_°©us
->
ack_tx_hwt°amp
));

90 
	`õì80211_rx_«pi
(
mvm
->
hw
, 
NULL
, 
skb
, NULL);

91 
	}
}

93 
	$iwl_mvm_time_sync_msmt_c⁄fúm_evít
(
iwl_mvm
 *
mvm
,

94 
iwl_rx_cmd_buf„r
 *
rxb
)

96 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

97 
iwl_time_msmt_cfm_nŸify
 *
nŸif
 = (*)
pkt
->
d©a
;

98 
õì80211_tx_°©us
 
°©us
 = {};

99 
skb_sh¨ed_hwt°amps
 *
shwt
;

100 
u64
 
ts_10ns
, 
adj_time
;

102 
°©us
.
skb
 =

103 
	`iwl_mvm_time_sync_föd_skb
(
mvm
, 
nŸif
->
≥î_addr
,

104 
	`À32_to_˝u
(
nŸif
->
dülog_tokí
));

106 i‡(!
°©us
.
skb
) {

107 
	`IWL_DEBUG_INFO
(
mvm
, "Time sync confirm butÇoÖending skb\n");

111 
ts_10ns
 = 
	`iwl_mvm_gë_64_bô
(
nŸif
->
t1_hi
,ÇŸif->
t1_lo
);

112 
adj_time
 = 
	`iwl_mvm_±p_gë_adj_time
(
mvm
, 
ts_10ns
 * 10);

113 
shwt
 = 
	`skb_hwt°amps
(
°©us
.
skb
);

114 
shwt
->
hwt°amp
 = 
	`ktime_£t
(0, 
adj_time
);

116 
ts_10ns
 = 
	`iwl_mvm_gë_64_bô
(
nŸif
->
t4_hi
,ÇŸif->
t4_lo
);

117 
adj_time
 = 
	`iwl_mvm_±p_gë_adj_time
(
mvm
, 
ts_10ns
 * 10);

118 
°©us
.
öfo
 = 
	`IEEE80211_SKB_CB
(°©us.
skb
);

119 
°©us
.
ack_hwt°amp
 = 
	`ktime_£t
(0, 
adj_time
);

121 
	`IWL_DEBUG_INFO
(
mvm
,

123 
	`ktime_to_ns
(
shwt
->
hwt°amp
),

124 
	`ktime_to_ns
(
°©us
.
ack_hwt°amp
));

125 
	`õì80211_tx_°©us_ext
(
mvm
->
hw
, &
°©us
);

126 
	}
}

128 
	$iwl_mvm_time_sync_c⁄fig
(
iwl_mvm
 *
mvm
, c⁄° 
u8
 *
addr
, 
u32
 
¥Ÿocﬁs
)

130 
iwl_time_sync_cfg_cmd
 
cmd
 = {};

131 
îr
;

133 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

135 i‡(!
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

136 
IWL_UCODE_TLV_CAPA_TIME_SYNC_BOTH_FTM_TM
))

137  -
EINVAL
;

142 i‡(
mvm
->
time_sync
.
a˘ive
 &&

143 !
	`ëhî_addr_equÆ
(
addr
, 
mvm
->
time_sync
.
≥î_addr
)) {

144 
	`IWL_DEBUG_INFO
(
mvm
, "Time sync:Ñeject config forÖeer: %pM\n",

145 
addr
);

146  -
ENOBUFS
;

149 i‡(
¥Ÿocﬁs
 & ~(
IWL_TIME_SYNC_PROTOCOL_TM
 |

150 
IWL_TIME_SYNC_PROTOCOL_FTM
))

151  -
EINVAL
;

153 
cmd
.
¥Ÿocﬁs
 = 
	`˝u_to_À32
(protocols);

155 
	`ëhî_addr_c›y
(
cmd
.
≥î_addr
, 
addr
);

157 
îr
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
,

158 
	`WIDE_ID
(
DATA_PATH_GROUP
,

159 
WNM_80211V_TIMING_MEASUREMENT_CONFIG_CMD
),

160 0, (
cmd
), &cmd);

161 i‡(
îr
) {

162 
	`IWL_ERR
(
mvm
, "FaûedÅÿ£ndÅimêsyn¯cfg cmd: %d\n", 
îr
);

164 
mvm
->
time_sync
.
a˘ive
 = 
¥Ÿocﬁs
 != 0;

165 
	`ëhî_addr_c›y
(
mvm
->
time_sync
.
≥î_addr
, 
addr
);

166 
	`IWL_DEBUG_INFO
(
mvm
, "Timêsync: sëÖì∏addr=%pM\n", 
addr
);

169 i‡(!
mvm
->
time_sync
.
a˘ive
)

170 
	`skb_queue_purge
(&
mvm
->
time_sync
.
‰ame_li°
);

172  
îr
;

173 
	}
}

	@time-sync.h

5 #i‚de‡
__TIME_SYNC_H__


6 
	#__TIME_SYNC_H__


	)

8 
	~"mvm.h
"

9 
	~<löux/õì80211.h
>

11 
iwl_mvm_öô_time_sync
(
iwl_time_sync_d©a
 *
d©a
);

12 
iwl_mvm_time_sync_msmt_evít
(
iwl_mvm
 *
mvm
,

13 
iwl_rx_cmd_buf„r
 *
rxb
);

14 
iwl_mvm_time_sync_msmt_c⁄fúm_evít
(
iwl_mvm
 *
mvm
,

15 
iwl_rx_cmd_buf„r
 *
rxb
);

16 
iwl_mvm_time_sync_c⁄fig
(
iwl_mvm
 *
mvm
, c⁄° 
u8
 *
addr
,

17 
u32
 
¥Ÿocﬁs
);

19 
ölöe


20 
boﬁ
 
	$iwl_mvm_time_sync_‰ame
(
iwl_mvm
 *
mvm
, 
sk_buff
 *
skb
, 
u8
 *
addr
)

22 i‡(
	`ëhî_addr_equÆ
(
mvm
->
time_sync
.
≥î_addr
, 
addr
) &&

23 (
	`õì80211_is_timög_mósuªmít
(
skb
Ë|| 
	`õì80211_is_·m
(skb))) {

24 
	`skb_queue_èû
(&
mvm
->
time_sync
.
‰ame_li°
, 
skb
);

25  
åue
;

28  
Ál£
;

29 
	}
}

	@tt.c

7 
	~<löux/s‹t.h
>

9 
	~"mvm.h
"

11 
	#IWL_MVM_TEMP_NOTIF_WAIT_TIMEOUT
 
HZ


	)

13 
	$iwl_mvm_íãr_˘kûl
(
iwl_mvm
 *
mvm
)

15 
iwl_mvm_â_mgmt
 *
â
 = &
mvm
->
thîmÆ_thrŸée
;

16 
u32
 
duøti⁄
 = 
â
->
∑øms
.
˘_kûl_duøti⁄
;

18 i‡(
	`ã°_bô
(
IWL_MVM_STATUS_HW_CTKILL
, &
mvm
->
°©us
))

21 
	`IWL_ERR
(
mvm
, "Enter CT Kill\n");

22 
	`iwl_mvm_£t_hw_˘kûl_°©e
(
mvm
, 
åue
);

24 i‡(!
	`iwl_mvm_is_â_ö_fw
(
mvm
)) {

25 
â
->
thrŸée
 = 
Ál£
;

26 
â
->
dy«mic_smps
 = 
Ál£
;

33 i‡(!
mvm
->
ãm≥øtuª_ã°
)

34 
	`scheduÀ_dñayed_w‹k
(&
â
->
˘_kûl_exô
,

35 
	`round_jiffõs_ªœtive
(
duøti⁄
 * 
HZ
));

36 
	}
}

38 
	$iwl_mvm_exô_˘kûl
(
iwl_mvm
 *
mvm
)

40 i‡(!
	`ã°_bô
(
IWL_MVM_STATUS_HW_CTKILL
, &
mvm
->
°©us
))

43 
	`IWL_ERR
(
mvm
, "Exit CT Kill\n");

44 
	`iwl_mvm_£t_hw_˘kûl_°©e
(
mvm
, 
Ál£
);

45 
	}
}

47 
	$iwl_mvm_â_ãmp_ch™ged
(
iwl_mvm
 *
mvm
, 
u32
 
ãmp
)

50 i‡(
mvm
->
ãm≥øtuª_ã°
)

53 i‡(
mvm
->
ãm≥øtuª
 =
ãmp
)

56 
mvm
->
ãm≥øtuª
 = 
ãmp
;

57 
	`iwl_mvm_â_h™dÀr
(
mvm
);

58 
	}
}

60 
	$iwl_mvm_ãmp_nŸif_∑r£
(
iwl_mvm
 *
mvm
,

61 
iwl_rx_∑ckë
 *
pkt
)

63 
iwl_dts_mósuªmít_nŸif_v1
 *
nŸif_v1
;

64 
Àn
 = 
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
);

65 
ãmp
;

70 i‡(
	`WARN_ON_ONCE
(
Àn
 < (*
nŸif_v1
))) {

71 
	`IWL_ERR
(
mvm
, "Invalid DTS_MEASUREMENT_NOTIFICATION\n");

72  -
EINVAL
;

75 
nŸif_v1
 = (*)
pkt
->
d©a
;

77 
ãmp
 = 
	`À32_to_˝u
(
nŸif_v1
->temp);

80 i‡(
	`WARN_ON_ONCE
(
ãmp
 < 0))

81 
ãmp
 = 0;

83 
	`IWL_DEBUG_TEMP
(
mvm
, "DTS_MEASUREMENT_NOTIFICATION - %d\n", 
ãmp
);

85  
ãmp
;

86 
	}
}

88 
boﬁ
 
	$iwl_mvm_ãmp_nŸif_waô
(
iwl_nŸif_waô_d©a
 *
nŸif_waô
,

89 
iwl_rx_∑ckë
 *
pkt
, *
d©a
)

91 
iwl_mvm
 *
mvm
 =

92 
	`c⁄èöî_of
(
nŸif_waô
, 
iwl_mvm
,Çotif_wait);

93 *
ãmp
 = 
d©a
;

94 
ªt
;

96 
ªt
 = 
	`iwl_mvm_ãmp_nŸif_∑r£
(
mvm
, 
pkt
);

97 i‡(
ªt
 < 0)

98  
åue
;

100 *
ãmp
 = 
ªt
;

102  
åue
;

103 
	}
}

105 
	$iwl_mvm_ãmp_nŸif
(
iwl_mvm
 *
mvm
, 
iwl_rx_cmd_buf„r
 *
rxb
)

107 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

108 
iwl_dts_mósuªmít_nŸif_v2
 *
nŸif_v2
;

109 
Àn
 = 
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
);

110 
ãmp
;

111 
u32
 
ths_¸os£d
;

114 i‡(
	`ã°_bô
(
IWL_MVM_STATUS_HW_CTKILL
, &
mvm
->
°©us
))

117 
ãmp
 = 
	`iwl_mvm_ãmp_nŸif_∑r£
(
mvm
, 
pkt
);

119 i‡(!
	`iwl_mvm_is_â_ö_fw
(
mvm
)) {

120 i‡(
ãmp
 >= 0)

121 
	`iwl_mvm_â_ãmp_ch™ged
(
mvm
, 
ãmp
);

125 i‡(
	`WARN_ON_ONCE
(
Àn
 < (*
nŸif_v2
))) {

126 
	`IWL_ERR
(
mvm
, "Invalid DTS_MEASUREMENT_NOTIFICATION\n");

130 
nŸif_v2
 = (*)
pkt
->
d©a
;

131 
ths_¸os£d
 = 
	`À32_to_˝u
(
nŸif_v2
->
thªshﬁd_idx
);

136 i‡(
ths_¸os£d
 == 0xFF)

139 
	`IWL_DEBUG_TEMP
(
mvm
, "Temp = %d Threshold crossed = %d\n",

140 
ãmp
, 
ths_¸os£d
);

142 #ifde‡
CONFIG_THERMAL


143 i‡(
	`WARN_ON
(
ths_¸os£d
 >
IWL_MAX_DTS_TRIPS
))

146 i‡(
mvm
->
tz_devi˚
.
tz⁄e
) {

147 
iwl_mvm_thîmÆ_devi˚
 *
tz_dev
 = &
mvm
->
tz_devi˚
;

149 
	`thîmÆ_z⁄e_devi˚_upd©e
(
tz_dev
->
tz⁄e
,

150 
THERMAL_TRIP_VIOLATED
);

153 
	}
}

155 
	$iwl_mvm_˘_kûl_nŸif
(
iwl_mvm
 *
mvm
, 
iwl_rx_cmd_buf„r
 *
rxb
)

157 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

158 
˘_kûl_nŸif
 *
nŸif
;

160 
nŸif
 = (
˘_kûl_nŸif
 *)
pkt
->
d©a
;

161 
	`IWL_DEBUG_TEMP
(
mvm
, "CT KillÇotificationÅemperature = %d\n",

162 
nŸif
->
ãm≥øtuª
);

163 i‡(
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
PHY_OPS_GROUP
,

164 
CT_KILL_NOTIFICATION
, 0) > 1)

165 
	`IWL_DEBUG_TEMP
(
mvm
,

167 
nŸif
->
dts
,ÇŸif->
scheme
);

169 
	`iwl_mvm_íãr_˘kûl
(
mvm
);

170 
	}
}

176 
	$iwl_mvm_£nd_ãmp_cmd
(
iwl_mvm
 *
mvm
, 
boﬁ
 
ª•⁄£
, 
s32
 *
ãmp
)

178 
iwl_ho°_cmd
 
cmd
 = {};

179 
iwl_dts_mósuªmít_cmd
 
dts_cmd
 = {

180 .
Êags
 = 
	`˝u_to_À32
(
DTS_TRIGGER_CMD_FLAGS_TEMP
),

182 
iwl_ext_dts_mósuªmít_cmd
 
ext_cmd
 = {

183 .
c⁄åﬁ_mode
 = 
	`˝u_to_À32
(
DTS_DIRECT_WITHOUT_MEASURE
),

185 
iwl_dts_mósuªmít_ª•
 *
ª•
;

186 *
cmd_±r
;

187 
ªt
;

188 
u32
 
cmd_Êags
 = 0;

189 
u16
 
Àn
;

192 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

193 
IWL_UCODE_TLV_CAPA_EXTENDED_DTS_MEASURE
)) {

194 
Àn
 = (
ext_cmd
);

195 
cmd_±r
 = &
ext_cmd
;

197 
Àn
 = (
dts_cmd
);

198 
cmd_±r
 = &
dts_cmd
;

201 i‡(
ª•⁄£
) {

202 
cmd_Êags
 = 
CMD_WANT_SKB
;

203 
Àn
 = 0;

206 
cmd
.
id
 = 
	`WIDE_ID
(
PHY_OPS_GROUP
, 
CMD_DTS_MEASUREMENT_TRIGGER_WIDE
);

207 
cmd
.
Àn
[0] =Üen;

208 
cmd
.
Êags
 = 
cmd_Êags
;

209 
cmd
.
d©a
[0] = 
cmd_±r
;

211 
	`IWL_DEBUG_TEMP
(
mvm
,

213 
ª•⁄£
 ? "with" : "without");

214 
ªt
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
cmd
);

216 i‡(
ªt
) {

217 
	`IWL_ERR
(
mvm
,

219 
ªt
);

220  
ªt
;

223 i‡(
ª•⁄£
) {

224 
ª•
 = (*)
cmd
.
ª•_pkt
->
d©a
;

225 *
ãmp
 = 
	`À32_to_˝u
(
ª•
->temp);

226 
	`IWL_DEBUG_TEMP
(
mvm
,

228 *
ãmp
);

229 
	`iwl_‰ì_ª•
(&
cmd
);

232  
ªt
;

233 
	}
}

235 
	$iwl_mvm_gë_ãmp
(
iwl_mvm
 *
mvm
, 
s32
 *
ãmp
)

237 
iwl_nŸifiˇti⁄_waô
 
waô_ãmp_nŸif
;

238 
u16
 
ãmp_nŸif
[] = { 
	`WIDE_ID
(
PHY_OPS_GROUP
,

239 
DTS_MEASUREMENT_NOTIF_WIDE
) };

240 
ªt
;

241 
u8
 
cmd_vî
;

248 
cmd_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
,

249 
	`WIDE_ID
(
PHY_OPS_GROUP
, 
CMD_DTS_MEASUREMENT_TRIGGER_WIDE
),

250 
IWL_FW_CMD_VER_UNKNOWN
);

251 i‡(
cmd_vî
 == 1)

252  
	`iwl_mvm_£nd_ãmp_cmd
(
mvm
, 
åue
, 
ãmp
);

254 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

256 
	`iwl_öô_nŸifiˇti⁄_waô
(&
mvm
->
nŸif_waô
, &
waô_ãmp_nŸif
,

257 
ãmp_nŸif
, 
	`ARRAY_SIZE
(temp_notif),

258 
iwl_mvm_ãmp_nŸif_waô
, 
ãmp
);

260 
ªt
 = 
	`iwl_mvm_£nd_ãmp_cmd
(
mvm
, 
Ál£
, 
ãmp
);

261 i‡(
ªt
) {

262 
	`iwl_ªmove_nŸifiˇti⁄
(&
mvm
->
nŸif_waô
, &
waô_ãmp_nŸif
);

263  
ªt
;

266 
ªt
 = 
	`iwl_waô_nŸifiˇti⁄
(&
mvm
->
nŸif_waô
, &
waô_ãmp_nŸif
,

267 
IWL_MVM_TEMP_NOTIF_WAIT_TIMEOUT
);

268 i‡(
ªt
)

269 
	`IWL_WARN
(
mvm
, "GettingÅheÅemperatureÅimed out\n");

271  
ªt
;

272 
	}
}

274 
	$check_exô_˘kûl
(
w‹k_°ru˘
 *
w‹k
)

276 
iwl_mvm_â_mgmt
 *
â
;

277 
iwl_mvm
 *
mvm
;

278 
u32
 
duøti⁄
;

279 
s32
 
ãmp
;

280 
ªt
;

282 
â
 = 
	`c⁄èöî_of
(
w‹k
, 
iwl_mvm_â_mgmt
, 
˘_kûl_exô
.work);

283 
mvm
 = 
	`c⁄èöî_of
(
â
, 
iwl_mvm
, 
thîmÆ_thrŸée
);

285 i‡(
	`iwl_mvm_is_â_ö_fw
(
mvm
)) {

286 
	`iwl_mvm_exô_˘kûl
(
mvm
);

291 
duøti⁄
 = 
â
->
∑øms
.
˘_kûl_duøti⁄
;

293 
	`Êush_w‹k
(&
mvm
->
roc_d⁄e_wk
);

295 
	`muãx_lock
(&
mvm
->
muãx
);

297 i‡(
	`__iwl_mvm_mac_°¨t
(
mvm
))

298 
ªscheduÀ
;

300 
ªt
 = 
	`iwl_mvm_gë_ãmp
(
mvm
, &
ãmp
);

302 
	`__iwl_mvm_mac_°›
(
mvm
);

304 i‡(
ªt
)

305 
ªscheduÀ
;

307 
	`IWL_DEBUG_TEMP
(
mvm
, "NICÅem≥øtuª: %d\n", 
ãmp
);

309 i‡(
ãmp
 <
â
->
∑øms
.
˘_kûl_exô
) {

310 
	`muãx_u∆ock
(&
mvm
->
muãx
);

311 
	`iwl_mvm_exô_˘kûl
(
mvm
);

315 
ªscheduÀ
:

316 
	`muãx_u∆ock
(&
mvm
->
muãx
);

317 
	`scheduÀ_dñayed_w‹k
(&
mvm
->
thîmÆ_thrŸée
.
˘_kûl_exô
,

318 
	`round_jiffõs
(
duøti⁄
 * 
HZ
));

319 
	}
}

321 
	$iwl_mvm_â_smps_ôî©‹
(*
_d©a
, 
u8
 *
mac
,

322 
õì80211_vif
 *
vif
)

324 
iwl_mvm
 *
mvm
 = 
_d©a
;

325 
õì80211_smps_mode
 
smps_mode
;

327 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

329 i‡(
mvm
->
thîmÆ_thrŸée
.
dy«mic_smps
)

330 
smps_mode
 = 
IEEE80211_SMPS_DYNAMIC
;

332 
smps_mode
 = 
IEEE80211_SMPS_AUTOMATIC
;

334 i‡(
vif
->
ty≥
 !
NL80211_IFTYPE_STATION
)

337 
	`iwl_mvm_upd©e_smps
(
mvm
, 
vif
, 
IWL_MVM_SMPS_REQ_TT
, 
smps_mode
, 0);

338 
	}
}

340 
	$iwl_mvm_â_tx_¥Ÿe˘i⁄
(
iwl_mvm
 *
mvm
, 
boﬁ
 
íabÀ
)

342 
iwl_mvm_°a
 *
mvm°a
;

343 
i
, 
îr
;

345 
i
 = 0; i < 
mvm
->
fw
->
ucode_ˇ∑
.
num_°©i⁄s
; i++) {

346 
mvm°a
 = 
	`iwl_mvm_°a_‰om_°aid_¥Ÿe˘ed
(
mvm
, 
i
);

347 i‡(!
mvm°a
)

350 i‡(
íabÀ
 =
mvm°a
->
â_tx_¥Ÿe˘i⁄
)

352 
îr
 = 
	`iwl_mvm_tx_¥Ÿe˘i⁄
(
mvm
, 
mvm°a
, 
íabÀ
);

353 i‡(
îr
) {

354 
	`IWL_ERR
(
mvm
, "FailedÅo %s TxÖrotection\n",

355 
íabÀ
 ? "enable" : "disable");

357 
	`IWL_DEBUG_TEMP
(
mvm
, "%s TxÖrotection\n",

358 
íabÀ
 ? "Enable" : "Disable");

359 
mvm°a
->
â_tx_¥Ÿe˘i⁄
 = 
íabÀ
;

362 
	}
}

364 
	$iwl_mvm_â_tx_backoff
(
iwl_mvm
 *
mvm
, 
u32
 
backoff
)

366 
iwl_ho°_cmd
 
cmd
 = {

367 .
id
 = 
REPLY_THERMAL_MNG_BACKOFF
,

368 .
Àn
 = { (
u32
), },

369 .
d©a
 = { &
backoff
, },

372 
backoff
 = 
	`max
(backoff, 
mvm
->
thîmÆ_thrŸée
.
mö_backoff
);

374 i‡(
	`iwl_mvm_£nd_cmd
(
mvm
, &
cmd
) == 0) {

375 
	`IWL_DEBUG_TEMP
(
mvm
, "Set Thermal Tx backoffÅo: %u\n",

376 
backoff
);

377 
mvm
->
thîmÆ_thrŸée
.
tx_backoff
 = 
backoff
;

379 
	`IWL_ERR
(
mvm
, "FailedÅo change Thermal Tx backoff\n");

381 
	}
}

383 
	$iwl_mvm_â_h™dÀr
(
iwl_mvm
 *
mvm
)

385 
iwl_â_∑øms
 *
∑øms
 = &
mvm
->
thîmÆ_thrŸée
.params;

386 
iwl_mvm_â_mgmt
 *
â
 = &
mvm
->
thîmÆ_thrŸée
;

387 
s32
 
ãm≥øtuª
 = 
mvm
->temperature;

388 
boﬁ
 
thrŸée_íabÀ
 = 
Ál£
;

389 
i
;

390 
u32
 
tx_backoff
;

392 
	`IWL_DEBUG_TEMP
(
mvm
, "NICÅem≥øtuª: %d\n", mvm->
ãm≥øtuª
);

394 i‡(
∑øms
->
suµ‹t_˘_kûl
 && 
ãm≥øtuª
 >∑øms->
˘_kûl_íåy
) {

395 
	`iwl_mvm_íãr_˘kûl
(
mvm
);

399 i‡(
∑øms
->
suµ‹t_˘_kûl
 &&

400 
ãm≥øtuª
 <
∑øms
->
˘_kûl_exô
) {

401 
	`iwl_mvm_exô_˘kûl
(
mvm
);

405 i‡(
∑øms
->
suµ‹t_dy«mic_smps
) {

406 i‡(!
â
->
dy«mic_smps
 &&

407 
ãm≥øtuª
 >
∑øms
->
dy«mic_smps_íåy
) {

408 
	`IWL_DEBUG_TEMP
(
mvm
, "Enable dynamic SMPS\n");

409 
â
->
dy«mic_smps
 = 
åue
;

410 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s_©omic
(

411 
mvm
->
hw
, 
IEEE80211_IFACE_ITER_NORMAL
,

412 
iwl_mvm_â_smps_ôî©‹
, 
mvm
);

413 
thrŸée_íabÀ
 = 
åue
;

414 } i‡(
â
->
dy«mic_smps
 &&

415 
ãm≥øtuª
 <
∑øms
->
dy«mic_smps_exô
) {

416 
	`IWL_DEBUG_TEMP
(
mvm
, "Disable dynamic SMPS\n");

417 
â
->
dy«mic_smps
 = 
Ál£
;

418 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s_©omic
(

419 
mvm
->
hw
, 
IEEE80211_IFACE_ITER_NORMAL
,

420 
iwl_mvm_â_smps_ôî©‹
, 
mvm
);

424 i‡(
∑øms
->
suµ‹t_tx_¥Ÿe˘i⁄
) {

425 i‡(
ãm≥øtuª
 >
∑øms
->
tx_¥Ÿe˘i⁄_íåy
) {

426 
	`iwl_mvm_â_tx_¥Ÿe˘i⁄
(
mvm
, 
åue
);

427 
thrŸée_íabÀ
 = 
åue
;

428 } i‡(
ãm≥øtuª
 <
∑øms
->
tx_¥Ÿe˘i⁄_exô
) {

429 
	`iwl_mvm_â_tx_¥Ÿe˘i⁄
(
mvm
, 
Ál£
);

433 i‡(
∑øms
->
suµ‹t_tx_backoff
) {

434 
tx_backoff
 = 
â
->
mö_backoff
;

435 
i
 = 0; i < 
TT_TX_BACKOFF_SIZE
; i++) {

436 i‡(
ãm≥øtuª
 < 
∑øms
->
tx_backoff
[
i
].temperature)

438 
tx_backoff
 = 
	`max
(
â
->
mö_backoff
,

439 
∑øms
->
tx_backoff
[
i
].
backoff
);

441 i‡(
tx_backoff
 !
â
->
mö_backoff
)

442 
thrŸée_íabÀ
 = 
åue
;

443 i‡(
â
->
tx_backoff
 !=Åx_backoff)

444 
	`iwl_mvm_â_tx_backoff
(
mvm
, 
tx_backoff
);

447 i‡(!
â
->
thrŸée
 && 
thrŸée_íabÀ
) {

448 
	`IWL_WARN
(
mvm
,

450 
â
->
thrŸée
 = 
åue
;

451 } i‡(
â
->
thrŸée
 && !â->
dy«mic_smps
 &&

452 
â
->
tx_backoff
 =â->
mö_backoff
 &&

453 
ãm≥øtuª
 <
∑øms
->
tx_¥Ÿe˘i⁄_exô
) {

454 
	`IWL_WARN
(
mvm
,

456 
â
->
thrŸée
 = 
Ál£
;

458 
	}
}

460 c⁄° 
iwl_â_∑øms
 
	giwl_mvm_deÁu…_â_∑øms
 = {

461 .
˘_kûl_íåy
 = 118,

462 .
	g˘_kûl_exô
 = 96,

463 .
	g˘_kûl_duøti⁄
 = 5,

464 .
	gdy«mic_smps_íåy
 = 114,

465 .
	gdy«mic_smps_exô
 = 110,

466 .
	gtx_¥Ÿe˘i⁄_íåy
 = 114,

467 .
	gtx_¥Ÿe˘i⁄_exô
 = 108,

468 .
	gtx_backoff
 = {

469 {.
ãm≥øtuª
 = 112, .
	gbackoff
 = 200},

470 {.
	gãm≥øtuª
 = 113, .
	gbackoff
 = 600},

471 {.
	gãm≥øtuª
 = 114, .
	gbackoff
 = 1200},

472 {.
	gãm≥øtuª
 = 115, .
	gbackoff
 = 2000},

473 {.
	gãm≥øtuª
 = 116, .
	gbackoff
 = 4000},

474 {.
	gãm≥øtuª
 = 117, .
	gbackoff
 = 10000},

476 .
	gsuµ‹t_˘_kûl
 = 
åue
,

477 .
	gsuµ‹t_dy«mic_smps
 = 
åue
,

478 .
	gsuµ‹t_tx_¥Ÿe˘i⁄
 = 
åue
,

479 .
	gsuµ‹t_tx_backoff
 = 
åue
,

483 c⁄° 
u32
 
	giwl_mvm_cdev_budgës
[] = {

507 
	$iwl_mvm_˘dp_comm™d
(
iwl_mvm
 *
mvm
, 
u32
 
›
, u32 
°©e
)

509 
iwl_mvm_˘dp_cmd
 
cmd
 = {

510 .
›î©i⁄
 = 
	`˝u_to_À32
(
›
),

511 .
budgë
 = 
	`˝u_to_À32
(
iwl_mvm_cdev_budgës
[
°©e
]),

512 .
wödow_size
 = 0,

514 
ªt
;

515 
u32
 
°©us
;

517 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

519 
°©us
 = 0;

520 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu_°©us
(
mvm
, 
	`WIDE_ID
(
PHY_OPS_GROUP
,

521 
CTDP_CONFIG_CMD
),

522 (
cmd
), &cmd, &
°©us
);

524 i‡(
ªt
) {

525 
	`IWL_ERR
(
mvm
, "cTDP comm™d faûed (îr=%d)\n", 
ªt
);

526  
ªt
;

529 
›
) {

530 
CTDP_CMD_OPERATION_START
:

531 #ifde‡
CONFIG_THERMAL


532 
mvm
->
coﬁög_dev
.
cur_°©e
 = 
°©e
;

535 
CTDP_CMD_OPERATION_REPORT
:

536 
	`IWL_DEBUG_TEMP
(
mvm
, "cTDPávgÉ√rgy i¿mW©à%d\n", 
°©us
);

543  
°©us
;

544 
CTDP_CMD_OPERATION_STOP
:

545 
	`IWL_DEBUG_TEMP
(
mvm
, "cTDP stopped successfully\n");

550 
	}
}

552 #ifde‡
CONFIG_THERMAL


553 
	$com∑ª_ãmps
(c⁄° *
a
, c⁄° *
b
)

555  ((
s16
)
	`À16_to_˝u
(*(
__À16
 *)
a
) -

556 (
s16
)
	`À16_to_˝u
(*(
__À16
 *)
b
));

557 
	}
}

559 
	siwl_åù_wÆk_d©a
 {

560 
__À16
 *
	mthªshﬁds
;

561 
	mcou¡
;

564 
	$iwl_åù_ãmp_cb
(
thîmÆ_åù
 *
åù
, *
¨g
)

566 
iwl_åù_wÆk_d©a
 *
twd
 = 
¨g
;

568 i‡(
åù
->
ãm≥øtuª
 =
THERMAL_TEMP_INVALID
)

571 
twd
->
thªshﬁds
[twd->
cou¡
++] = 
	`˝u_to_À16
((
s16
)(
åù
->
ãm≥øtuª
 / 1000));

573 
	}
}

576 
	$iwl_mvm_£nd_ãmp_ªp‹t_ths_cmd
(
iwl_mvm
 *
mvm
)

578 
ãmp_ªp‹t_ths_cmd
 
cmd
 = {0};

579 
ªt
;

580 #ifde‡
CONFIG_THERMAL


581 
iwl_åù_wÆk_d©a
 
twd
 = { .
thªshﬁds
 = 
cmd
.thªshﬁds, .
cou¡
 = 0 };

583 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

585 i‡(!
mvm
->
tz_devi˚
.
tz⁄e
)

586 
£nd
;

595 
	`f‹_óch_thîmÆ_åù
(
mvm
->
tz_devi˚
.
tz⁄e
, 
iwl_åù_ãmp_cb
, &
twd
);

597 
cmd
.
num_ãmps
 = 
	`˝u_to_À32
(
twd
.
cou¡
);

598 i‡(
twd
.
cou¡
)

599 
	`s‹t
(
cmd
.
thªshﬁds
, 
twd
.
cou¡
, (
s16
), 
com∑ª_ãmps
, 
NULL
);

601 
£nd
:

603 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
	`WIDE_ID
(
PHY_OPS_GROUP
,

604 
TEMP_REPORTING_THRESHOLDS_CMD
),

605 0, (
cmd
), &cmd);

606 i‡(
ªt
)

607 
	`IWL_ERR
(
mvm
, "TEMP_REPORT_THS_CMD command failed (err=%d)\n",

608 
ªt
);

610  
ªt
;

611 
	}
}

613 #ifde‡
CONFIG_THERMAL


614 
	$iwl_mvm_tz⁄e_gë_ãmp
(
thîmÆ_z⁄e_devi˚
 *
devi˚
,

615 *
ãm≥øtuª
)

617 
iwl_mvm
 *
mvm
 = 
	`thîmÆ_z⁄e_devi˚_¥iv
(
devi˚
);

618 
ªt
;

619 
ãmp
;

621 
	`muãx_lock
(&
mvm
->
muãx
);

623 i‡(!
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
) ||

624 
mvm
->
fwπ
.
cur_fw_img
 !
IWL_UCODE_REGULAR
) {

625 
ªt
 = -
ENODATA
;

626 
out
;

629 
ªt
 = 
	`iwl_mvm_gë_ãmp
(
mvm
, &
ãmp
);

630 i‡(
ªt
)

631 
out
;

633 *
ãm≥øtuª
 = 
ãmp
 * 1000;

635 
out
:

636 
	`muãx_u∆ock
(&
mvm
->
muãx
);

637  
ªt
;

638 
	}
}

640 
	$iwl_mvm_tz⁄e_£t_åù_ãmp
(
thîmÆ_z⁄e_devi˚
 *
devi˚
,

641 
åù
, 
ãmp
)

643 
iwl_mvm
 *
mvm
 = 
	`thîmÆ_z⁄e_devi˚_¥iv
(
devi˚
);

644 
ªt
;

646 
	`muãx_lock
(&
mvm
->
muãx
);

648 i‡(!
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
) ||

649 
mvm
->
fwπ
.
cur_fw_img
 !
IWL_UCODE_REGULAR
) {

650 
ªt
 = -
EIO
;

651 
out
;

654 i‡((
ãmp
 / 1000Ë> 
S16_MAX
) {

655 
ªt
 = -
EINVAL
;

656 
out
;

659 
ªt
 = 
	`iwl_mvm_£nd_ãmp_ªp‹t_ths_cmd
(
mvm
);

660 
out
:

661 
	`muãx_u∆ock
(&
mvm
->
muãx
);

662  
ªt
;

663 
	}
}

665 
thîmÆ_z⁄e_devi˚_›s
 
	gtz⁄e_›s
 = {

666 .
gë_ãmp
 = 
iwl_mvm_tz⁄e_gë_ãmp
,

667 .
	g£t_åù_ãmp
 = 
iwl_mvm_tz⁄e_£t_åù_ãmp
,

670 
	$iwl_mvm_thîmÆ_z⁄e_ªgi°î
(
iwl_mvm
 *
mvm
)

672 
i
, 
ªt
;

673 
«me
[16];

674 
©omic_t
 
cou¡î
 = 
	`ATOMIC_INIT
(0);

676 i‡(!
	`iwl_mvm_is_â_ö_fw
(
mvm
)) {

677 
mvm
->
tz_devi˚
.
tz⁄e
 = 
NULL
;

682 
	`BUILD_BUG_ON
(
	`ARRAY_SIZE
(
«me
Ë>
THERMAL_NAME_LENGTH
);

684 
	`•rötf
(
«me
, "iwlwifi_%u", 
	`©omic_öc_ªtu∫
(&
cou¡î
) & 0xFF);

689 
i
 = 0 ; i < 
IWL_MAX_DTS_TRIPS
; i++) {

690 
mvm
->
tz_devi˚
.
åùs
[
i
].
ãm≥øtuª
 = 
THERMAL_TEMP_INVALID
;

691 
mvm
->
tz_devi˚
.
åùs
[
i
].
ty≥
 = 
THERMAL_TRIP_PASSIVE
;

692 
mvm
->
tz_devi˚
.
åùs
[
i
].
Êags
 = 
THERMAL_TRIP_FLAG_RW_TEMP
;

694 
mvm
->
tz_devi˚
.
tz⁄e
 = 
	`thîmÆ_z⁄e_devi˚_ªgi°î_wôh_åùs
(
«me
,

695 
mvm
->
tz_devi˚
.
åùs
,

696 
IWL_MAX_DTS_TRIPS
,

697 
mvm
, &
tz⁄e_›s
,

698 
NULL
, 0, 0);

699 i‡(
	`IS_ERR
(
mvm
->
tz_devi˚
.
tz⁄e
)) {

700 
	`IWL_DEBUG_TEMP
(
mvm
,

702 
	`PTR_ERR
(
mvm
->
tz_devi˚
.
tz⁄e
));

703 
mvm
->
tz_devi˚
.
tz⁄e
 = 
NULL
;

707 
ªt
 = 
	`thîmÆ_z⁄e_devi˚_íabÀ
(
mvm
->
tz_devi˚
.
tz⁄e
);

708 i‡(
ªt
) {

709 
	`IWL_DEBUG_TEMP
(
mvm
, "FailedÅoÉnableÅhermal zone\n");

710 
	`thîmÆ_z⁄e_devi˚_uƒegi°î
(
mvm
->
tz_devi˚
.
tz⁄e
);

712 
	}
}

714 
	$iwl_mvm_tcoﬁ_gë_max_°©e
(
thîmÆ_coﬁög_devi˚
 *
cdev
,

715 *
°©e
)

717 *
°©e
 = 
	`ARRAY_SIZE
(
iwl_mvm_cdev_budgës
) - 1;

720 
	}
}

722 
	$iwl_mvm_tcoﬁ_gë_cur_°©e
(
thîmÆ_coﬁög_devi˚
 *
cdev
,

723 *
°©e
)

725 
iwl_mvm
 *
mvm
 = (iwl_mvm *)(
cdev
->
devd©a
);

727 *
°©e
 = 
mvm
->
coﬁög_dev
.
cur_°©e
;

730 
	}
}

732 
	$iwl_mvm_tcoﬁ_£t_cur_°©e
(
thîmÆ_coﬁög_devi˚
 *
cdev
,

733 
√w_°©e
)

735 
iwl_mvm
 *
mvm
 = (iwl_mvm *)(
cdev
->
devd©a
);

736 
ªt
;

738 
	`muãx_lock
(&
mvm
->
muãx
);

740 i‡(!
	`iwl_mvm_fúmw¨e_ru¬ög
(
mvm
) ||

741 
mvm
->
fwπ
.
cur_fw_img
 !
IWL_UCODE_REGULAR
) {

742 
ªt
 = -
EIO
;

743 
u∆ock
;

746 i‡(
√w_°©e
 >
	`ARRAY_SIZE
(
iwl_mvm_cdev_budgës
)) {

747 
ªt
 = -
EINVAL
;

748 
u∆ock
;

751 
ªt
 = 
	`iwl_mvm_˘dp_comm™d
(
mvm
, 
CTDP_CMD_OPERATION_START
,

752 
√w_°©e
);

754 
u∆ock
:

755 
	`muãx_u∆ock
(&
mvm
->
muãx
);

756  
ªt
;

757 
	}
}

759 c⁄° 
thîmÆ_coﬁög_devi˚_›s
 
	gtcoﬁög_›s
 = {

760 .
gë_max_°©e
 = 
iwl_mvm_tcoﬁ_gë_max_°©e
,

761 .
	ggë_cur_°©e
 = 
iwl_mvm_tcoﬁ_gë_cur_°©e
,

762 .
	g£t_cur_°©e
 = 
iwl_mvm_tcoﬁ_£t_cur_°©e
,

765 
	$iwl_mvm_coﬁög_devi˚_ªgi°î
(
iwl_mvm
 *
mvm
)

767 
«me
[] = "iwlwifi";

769 i‡(!
	`iwl_mvm_is_˘dp_suµ‹ãd
(
mvm
))

772 
	`BUILD_BUG_ON
(
	`ARRAY_SIZE
(
«me
Ë>
THERMAL_NAME_LENGTH
);

774 
mvm
->
coﬁög_dev
.
cdev
 =

775 
	`thîmÆ_coﬁög_devi˚_ªgi°î
(
«me
,

776 
mvm
,

777 &
tcoﬁög_›s
);

779 i‡(
	`IS_ERR
(
mvm
->
coﬁög_dev
.
cdev
)) {

780 
	`IWL_DEBUG_TEMP
(
mvm
,

782 
	`PTR_ERR
(
mvm
->
coﬁög_dev
.
cdev
));

783 
mvm
->
coﬁög_dev
.
cdev
 = 
NULL
;

786 
	}
}

788 
	$iwl_mvm_thîmÆ_z⁄e_uƒegi°î
(
iwl_mvm
 *
mvm
)

790 i‡(!
	`iwl_mvm_is_â_ö_fw
(
mvm
Ë|| !mvm->
tz_devi˚
.
tz⁄e
)

793 
	`IWL_DEBUG_TEMP
(
mvm
, "Thermal zone device unregister\n");

794 i‡(
mvm
->
tz_devi˚
.
tz⁄e
) {

795 
	`thîmÆ_z⁄e_devi˚_uƒegi°î
(
mvm
->
tz_devi˚
.
tz⁄e
);

796 
mvm
->
tz_devi˚
.
tz⁄e
 = 
NULL
;

798 
	}
}

800 
	$iwl_mvm_coﬁög_devi˚_uƒegi°î
(
iwl_mvm
 *
mvm
)

802 i‡(!
	`iwl_mvm_is_˘dp_suµ‹ãd
(
mvm
Ë|| !mvm->
coﬁög_dev
.
cdev
)

805 
	`IWL_DEBUG_TEMP
(
mvm
, "Cooling device unregister\n");

806 i‡(
mvm
->
coﬁög_dev
.
cdev
) {

807 
	`thîmÆ_coﬁög_devi˚_uƒegi°î
(
mvm
->
coﬁög_dev
.
cdev
);

808 
mvm
->
coﬁög_dev
.
cdev
 = 
NULL
;

810 
	}
}

813 
	$iwl_mvm_thîmÆ_öôülize
(
iwl_mvm
 *
mvm
, 
u32
 
mö_backoff
)

815 
iwl_mvm_â_mgmt
 *
â
 = &
mvm
->
thîmÆ_thrŸée
;

817 
	`IWL_DEBUG_TEMP
(
mvm
, "Initialize Thermal Throttling\n");

819 i‡(
mvm
->
cfg
->
thîmÆ_∑øms
)

820 
â
->
∑øms
 = *
mvm
->
cfg
->
thîmÆ_∑øms
;

822 
â
->
∑øms
 = 
iwl_mvm_deÁu…_â_∑øms
;

824 
â
->
thrŸée
 = 
Ál£
;

825 
â
->
dy«mic_smps
 = 
Ál£
;

826 
â
->
mö_backoff
 = min_backoff;

827 
	`INIT_DELAYED_WORK
(&
â
->
˘_kûl_exô
, 
check_exô_˘kûl
);

829 #ifde‡
CONFIG_THERMAL


830 
	`iwl_mvm_coﬁög_devi˚_ªgi°î
(
mvm
);

831 
	`iwl_mvm_thîmÆ_z⁄e_ªgi°î
(
mvm
);

833 
mvm
->
öô_°©us
 |
IWL_MVM_INIT_STATUS_THERMAL_INIT_COMPLETE
;

834 
	}
}

836 
	$iwl_mvm_thîmÆ_exô
(
iwl_mvm
 *
mvm
)

838 i‡(!(
mvm
->
öô_°©us
 & 
IWL_MVM_INIT_STATUS_THERMAL_INIT_COMPLETE
))

841 
	`ˇn˚l_dñayed_w‹k_sync
(&
mvm
->
thîmÆ_thrŸée
.
˘_kûl_exô
);

842 
	`IWL_DEBUG_TEMP
(
mvm
, "Exit Thermal Throttling\n");

844 #ifde‡
CONFIG_THERMAL


845 
	`iwl_mvm_coﬁög_devi˚_uƒegi°î
(
mvm
);

846 
	`iwl_mvm_thîmÆ_z⁄e_uƒegi°î
(
mvm
);

848 
mvm
->
öô_°©us
 &~
IWL_MVM_INIT_STATUS_THERMAL_INIT_COMPLETE
;

849 
	}
}

	@tx.c

7 
	~<löux/õì80211.h
>

8 
	~<löux/ëhîdevi˚.h
>

9 
	~<löux/t˝.h
>

10 
	~<√t/gso.h
>

11 
	~<√t/ù.h
>

12 
	~<√t/ùv6.h
>

14 
	~"iwl-å™s.h
"

15 
	~"iwl-ì¥om-∑r£.h
"

16 
	~"mvm.h
"

17 
	~"°a.h
"

18 
	~"time-sync.h
"

21 
	$iwl_mvm_b¨_check_åiggî
(
iwl_mvm
 *
mvm
, c⁄° 
u8
 *
addr
,

22 
u16
 
tid
, u16 
s¢
)

24 
iwl_fw_dbg_åiggî_év
 *
åig
;

25 
iwl_fw_dbg_åiggî_ba
 *
ba_åig
;

27 
åig
 = 
	`iwl_fw_dbg_åiggî_⁄
(&
mvm
->
fwπ
, 
NULL
, 
FW_DBG_TRIGGER_BA
);

28 i‡(!
åig
)

31 
ba_åig
 = (*)
åig
->
d©a
;

33 i‡(!(
	`À16_to_˝u
(
ba_åig
->
tx_b¨
Ë& 
	`BIT
(
tid
)))

36 
	`iwl_fw_dbg_cﬁÀ˘_åig
(&
mvm
->
fwπ
, 
åig
,

38 
addr
, 
tid
, 
s¢
);

39 
	}
}

41 
	#OPT_HDR
(
ty≥
, 
skb
, 
off
) \

42 (
ty≥
 *)(
	`skb_√tw‹k_hódî
(
skb
Ë+ (
off
))

	)

44 
u32
 
	$iwl_mvm_tx_csum
(
iwl_mvm
 *
mvm
, 
sk_buff
 *
skb
,

45 
õì80211_tx_öfo
 *
öfo
,

46 
boﬁ
 
amsdu
)

48 
õì80211_hdr
 *
hdr
 = (*)
skb
->
d©a
;

49 
u16
 
mh_Àn
 = 
	`õì80211_hdæí
(
hdr
->
‰ame_c⁄åﬁ
);

50 
u16
 
ofÊﬂd_assi°
 = 0;

51 #i‡
	`IS_ENABLED
(
CONFIG_INET
)

52 
u8
 
¥Ÿocﬁ
 = 0;

55 i‡(
skb
->
ù_summed
 !
CHECKSUM_PARTIAL
)

56 
out
;

59 i‡(
	`WARN_ONCE
(!(
mvm
->
hw
->
√tdev_„©uªs
 & 
IWL_TX_CSUM_NETIF_FLAGS
) ||

60 (
skb
->
¥Ÿocﬁ
 !
	`ht⁄s
(
ETH_P_IP
) &&

61 
skb
->
¥Ÿocﬁ
 !
	`ht⁄s
(
ETH_P_IPV6
)),

63 
	`skb_checksum_hñp
(
skb
);

64 
out
;

67 i‡(
skb
->
¥Ÿocﬁ
 =
	`ht⁄s
(
ETH_P_IP
)) {

68 
¥Ÿocﬁ
 = 
	`ù_hdr
(
skb
)->protocol;

70 #i‡
	`IS_ENABLED
(
CONFIG_IPV6
)

71 
ùv6hdr
 *
ùv6h
 =

72 (
ùv6hdr
 *)
	`skb_√tw‹k_hódî
(
skb
);

73 
off
 = (*
ùv6h
);

75 
¥Ÿocﬁ
 = 
ùv6h
->
√xthdr
;

76 
¥Ÿocﬁ
 !
NEXTHDR_NONE
 && 
	`ùv6_ext_hdr
(protocol)) {

77 
ùv6_›t_hdr
 *
hp
;

80 i‡(
¥Ÿocﬁ
 !
NEXTHDR_ROUTING
 &&

81 
¥Ÿocﬁ
 !
NEXTHDR_HOP
 &&

82 
¥Ÿocﬁ
 !
NEXTHDR_DEST
) {

83 
	`skb_checksum_hñp
(
skb
);

84 
out
;

87 
hp
 = 
	`OPT_HDR
(
ùv6_›t_hdr
, 
skb
, 
off
);

88 
¥Ÿocﬁ
 = 
hp
->
√xthdr
;

89 
off
 +
	`ùv6_›éí
(
hp
);

95 i‡(
¥Ÿocﬁ
 !
IPPROTO_TCP
 &&ÖrŸocﬁ !
IPPROTO_UDP
) {

96 
	`WARN_ON_ONCE
(1);

97 
	`skb_checksum_hñp
(
skb
);

98 
out
;

102 
ofÊﬂd_assi°
 |
	`BIT
(
TX_CMD_OFFLD_L4_EN
);

109 
ofÊﬂd_assi°
 |(4 << 
TX_CMD_OFFLD_IP_HDR
);

112 i‡(
skb
->
¥Ÿocﬁ
 =
	`ht⁄s
(
ETH_P_IP
Ë&& 
amsdu
) {

113 
	`ù_hdr
(
skb
)->
check
 = 0;

114 
ofÊﬂd_assi°
 |
	`BIT
(
TX_CMD_OFFLD_L3_EN
);

118 i‡(
¥Ÿocﬁ
 =
IPPROTO_TCP
)

119 
	`t˝_hdr
(
skb
)->
check
 = 0;

121 
	`udp_hdr
(
skb
)->
check
 = 0;

123 
out
:

130 i‡(!
	`iwl_mvm_has_√w_tx_≠i
(
mvm
Ë&& 
öfo
->
c⁄åﬁ
.
hw_key
 &&

131 
öfo
->
c⁄åﬁ
.
hw_key
->
cùhî
 !
WLAN_CIPHER_SUITE_WEP40
 &&

132 
öfo
->
c⁄åﬁ
.
hw_key
->
cùhî
 !
WLAN_CIPHER_SUITE_WEP104
)

133 
mh_Àn
 +
öfo
->
c⁄åﬁ
.
hw_key
->
iv_Àn
;

134 
mh_Àn
 /= 2;

135 
ofÊﬂd_assi°
 |
mh_Àn
 << 
TX_CMD_OFFLD_MH_SIZE
;

137 i‡(
amsdu
)

138 
ofÊﬂd_assi°
 |
	`BIT
(
TX_CMD_OFFLD_AMSDU
);

139 i‡(
	`õì80211_hdæí
(
hdr
->
‰ame_c⁄åﬁ
) % 4)

141 
ofÊﬂd_assi°
 |
	`BIT
(
TX_CMD_OFFLD_PAD
);

143  
ofÊﬂd_assi°
;

144 
	}
}

149 
	$iwl_mvm_£t_tx_cmd
(
iwl_mvm
 *
mvm
, 
sk_buff
 *
skb
,

150 
iwl_tx_cmd
 *
tx_cmd
,

151 
õì80211_tx_öfo
 *
öfo
, 
u8
 
°a_id
)

153 
õì80211_hdr
 *
hdr
 = (*)
skb
->
d©a
;

154 
__À16
 
fc
 = 
hdr
->
‰ame_c⁄åﬁ
;

155 
u32
 
tx_Êags
 = 
	`À32_to_˝u
(
tx_cmd
->tx_flags);

156 
u32
 
Àn
 = 
skb
->À¿+ 
FCS_LEN
;

157 
boﬁ
 
amsdu
 = 
Ál£
;

158 
u8
 
ac
;

160 i‡(!(
öfo
->
Êags
 & 
IEEE80211_TX_CTL_NO_ACK
) ||

161 (
	`õì80211_is_¥obe_ª•
(
fc
) &&

162 !
	`is_mu…iˇ°_ëhî_addr
(
hdr
->
addr1
)))

163 
tx_Êags
 |
TX_CMD_FLG_ACK
;

165 
tx_Êags
 &~
TX_CMD_FLG_ACK
;

167 i‡(
	`õì80211_is_¥obe_ª•
(
fc
))

168 
tx_Êags
 |
TX_CMD_FLG_TSF
;

170 i‡(
	`õì80211_has_m‹e‰ags
(
fc
))

171 
tx_Êags
 |
TX_CMD_FLG_MORE_FRAG
;

173 i‡(
	`õì80211_is_d©a_qos
(
fc
)) {

174 
u8
 *
qc
 = 
	`õì80211_gë_qos_˘l
(
hdr
);

175 
tx_cmd
->
tid_t•ec
 = 
qc
[0] & 0xf;

176 
tx_Êags
 &~
TX_CMD_FLG_SEQ_CTL
;

177 
amsdu
 = *
qc
 & 
IEEE80211_QOS_CTL_A_MSDU_PRESENT
;

178 } i‡(
	`õì80211_is_back_ªq
(
fc
)) {

179 
õì80211_b¨
 *
b¨
 = (*)
skb
->
d©a
;

180 
u16
 
c⁄åﬁ
 = 
	`À16_to_˝u
(
b¨
->control);

181 
u16
 
s¢
 = 
	`À16_to_˝u
(
b¨
->
°¨t_£q_num
);

183 
tx_Êags
 |
TX_CMD_FLG_ACK
 | 
TX_CMD_FLG_BAR
;

184 
tx_cmd
->
tid_t•ec
 = (
c⁄åﬁ
 &

185 
IEEE80211_BAR_CTRL_TID_INFO_MASK
) >>

186 
IEEE80211_BAR_CTRL_TID_INFO_SHIFT
;

187 
	`WARN_ON_ONCE
(
tx_cmd
->
tid_t•ec
 >
IWL_MAX_TID_COUNT
);

188 
	`iwl_mvm_b¨_check_åiggî
(
mvm
, 
b¨
->
ø
, 
tx_cmd
->
tid_t•ec
,

189 
s¢
);

191 i‡(
	`õì80211_is_d©a
(
fc
))

192 
tx_cmd
->
tid_t•ec
 = 
IWL_TID_NON_QOS
;

194 
tx_cmd
->
tid_t•ec
 = 
IWL_MAX_TID_COUNT
;

196 i‡(
öfo
->
Êags
 & 
IEEE80211_TX_CTL_ASSIGN_SEQ
)

197 
tx_Êags
 |
TX_CMD_FLG_SEQ_CTL
;

199 
tx_Êags
 &~
TX_CMD_FLG_SEQ_CTL
;

203 i‡(
tx_cmd
->
tid_t•ec
 < 
IWL_MAX_TID_COUNT
)

204 
ac
 = 
tid_to_mac80211_ac
[
tx_cmd
->
tid_t•ec
];

206 
ac
 = 
tid_to_mac80211_ac
[0];

208 
tx_Êags
 |
	`iwl_mvm_bt_c€x_tx_¥io
(
mvm
, 
hdr
, 
öfo
, 
ac
) <<

209 
TX_CMD_FLG_BT_PRIO_POS
;

211 i‡(
	`õì80211_is_mgmt
(
fc
)) {

212 i‡(
	`õì80211_is_assoc_ªq
(
fc
Ë|| 
	`õì80211_is_ªassoc_ªq
(fc))

213 
tx_cmd
->
pm_‰ame_timeout
 = 
	`˝u_to_À16
(
PM_FRAME_ASSOC
);

214 i‡(
	`õì80211_is_a˘i⁄
(
fc
))

215 
tx_cmd
->
pm_‰ame_timeout
 = 
	`˝u_to_À16
(
PM_FRAME_NONE
);

217 
tx_cmd
->
pm_‰ame_timeout
 = 
	`˝u_to_À16
(
PM_FRAME_MGMT
);

222 
	`WARN_ON_ONCE
(
öfo
->
Êags
 & 
IEEE80211_TX_CTL_AMPDU
);

223 } i‡(
öfo
->
c⁄åﬁ
.
Êags
 & 
IEEE80211_TX_CTRL_PORT_CTRL_PROTO
) {

224 
tx_cmd
->
pm_‰ame_timeout
 = 
	`˝u_to_À16
(
PM_FRAME_MGMT
);

226 
tx_cmd
->
pm_‰ame_timeout
 = 
	`˝u_to_À16
(
PM_FRAME_NONE
);

229 i‡(
	`õì80211_is_d©a
(
fc
Ë&& 
Àn
 > 
mvm
->
πs_thªshﬁd
 &&

230 !
	`is_mu…iˇ°_ëhî_addr
(
hdr
->
addr1
))

231 
tx_Êags
 |
TX_CMD_FLG_PROT_REQUIRE
;

233 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

234 
IWL_UCODE_TLV_CAPA_TXPOWER_INSERTION_SUPPORT
) &&

235 
	`õì80211_a˘i⁄_c⁄èös_çc
(
skb
))

236 
tx_Êags
 |
TX_CMD_FLG_WRITE_TX_POWER
;

238 
tx_cmd
->
tx_Êags
 = 
	`˝u_to_À32
(tx_flags);

240 
tx_cmd
->
Àn
 = 
	`˝u_to_À16
((
u16
)
skb
->len);

241 
tx_cmd
->
li„_time
 = 
	`˝u_to_À32
(
TX_CMD_LIFE_TIME_INFINITE
);

242 
tx_cmd
->
°a_id
 = sta_id;

244 
tx_cmd
->
ofÊﬂd_assi°
 =

245 
	`˝u_to_À16
(
	`iwl_mvm_tx_csum
(
mvm
, 
skb
, 
öfo
, 
amsdu
));

246 
	}
}

248 
u32
 
	$iwl_mvm_gë_tx_™t
(
iwl_mvm
 *
mvm
,

249 
õì80211_tx_öfo
 *
öfo
,

250 
õì80211_°a
 *
°a
, 
__À16
 
fc
)

252 i‡(
öfo
->
b™d
 =
NL80211_BAND_2GHZ
 &&

253 !
	`iwl_mvm_bt_c€x_is_sh¨ed_™t_avaû
(
mvm
))

254  
mvm
->
cfg
->
n⁄_sh¨ed_™t
 << 
RATE_MCS_ANT_POS
;

256 i‡(
°a
 && 
	`õì80211_is_d©a
(
fc
)) {

257 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

259  
	`BIT
(
mvm°a
->
tx_™t
Ë<< 
RATE_MCS_ANT_POS
;

262  
	`BIT
(
mvm
->
mgmt_œ°_™ã¬a_idx
Ë<< 
RATE_MCS_ANT_POS
;

263 
	}
}

265 
u32
 
	$iwl_mvm_c⁄vît_øã_idx
(
iwl_mvm
 *
mvm
,

266 
õì80211_tx_öfo
 *
öfo
,

267 
øã_idx
)

269 
u32
 
øã_Êags
 = 0;

270 
u8
 
øã_∂˝
;

271 
boﬁ
 
is_cck
;

274 i‡(
øã_idx
 < 0 ||Ñ©e_idx >
IWL_RATE_COUNT_LEGACY
)

275 
øã_idx
 = 
	`iwl_mvm_mac_˘xt_gë_lowe°_øã
(
mvm
,

276 
öfo
,

277 
öfo
->
c⁄åﬁ
.
vif
);

280 
øã_∂˝
 = 
	`iwl_mvm_mac80211_idx_to_hwøã
(
mvm
->
fw
, 
øã_idx
);

281 
is_cck
 = (
øã_idx
 >
IWL_FIRST_CCK_RATE
) &&

282 (
øã_idx
 <
IWL_LAST_CCK_RATE
);

285 i‡(
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
, 
TX_CMD
, 0) > 8) {

286 i‡(!
is_cck
)

287 
øã_Êags
 |
RATE_MCS_LEGACY_OFDM_MSK
;

289 
øã_Êags
 |
RATE_MCS_CCK_MSK
;

290 } i‡(
is_cck
) {

291 
øã_Êags
 |
RATE_MCS_CCK_MSK_V1
;

294  (
u32
)
øã_∂˝
 | 
øã_Êags
;

295 
	}
}

297 
u32
 
	$iwl_mvm_gë_öje˘_tx_øã
(
iwl_mvm
 *
mvm
,

298 
õì80211_tx_öfo
 *
öfo
,

299 
õì80211_°a
 *
°a
,

300 
__À16
 
fc
)

302 
õì80211_tx_øã
 *
øã
 = &
öfo
->
c⁄åﬁ
.
øãs
[0];

303 
u32
 
ªsu…
;

310 i‡(
øã
->
Êags
 & 
IEEE80211_TX_RC_VHT_MCS
) {

311 
u8
 
mcs
 = 
	`õì80211_øã_gë_vht_mcs
(
øã
);

312 
u8
 
nss
 = 
	`õì80211_øã_gë_vht_nss
(
øã
);

314 
ªsu…
 = 
RATE_MCS_VHT_MSK_V1
;

315 
ªsu…
 |
	`u32_ícode_bôs
(
mcs
, 
RATE_VHT_MCS_RATE_CODE_MSK
);

316 
ªsu…
 |
	`u32_ícode_bôs
(
nss
, 
RATE_MCS_NSS_MSK
);

317 i‡(
øã
->
Êags
 & 
IEEE80211_TX_RC_SHORT_GI
)

318 
ªsu…
 |
RATE_MCS_SGI_MSK_V1
;

319 i‡(
øã
->
Êags
 & 
IEEE80211_TX_RC_40_MHZ_WIDTH
)

320 
ªsu…
 |
	`u32_ícode_bôs
(1, 
RATE_MCS_CHAN_WIDTH_MSK_V1
);

321 i‡(
øã
->
Êags
 & 
IEEE80211_TX_RC_80_MHZ_WIDTH
)

322 
ªsu…
 |
	`u32_ícode_bôs
(2, 
RATE_MCS_CHAN_WIDTH_MSK_V1
);

323 i‡(
øã
->
Êags
 & 
IEEE80211_TX_RC_160_MHZ_WIDTH
)

324 
ªsu…
 |
	`u32_ícode_bôs
(3, 
RATE_MCS_CHAN_WIDTH_MSK_V1
);

326 i‡(
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
LONG_GROUP
, 
TX_CMD
, 0) > 6)

327 
ªsu…
 = 
	`iwl_√w_øã_‰om_v1
(result);

328 } i‡(
øã
->
Êags
 & 
IEEE80211_TX_RC_MCS
) {

329 
ªsu…
 = 
RATE_MCS_HT_MSK_V1
;

330 
ªsu…
 |
	`u32_ícode_bôs
(
øã
->
idx
,

331 
RATE_HT_MCS_RATE_CODE_MSK_V1
 |

332 
RATE_HT_MCS_NSS_MSK_V1
);

333 i‡(
øã
->
Êags
 & 
IEEE80211_TX_RC_SHORT_GI
)

334 
ªsu…
 |
RATE_MCS_SGI_MSK_V1
;

335 i‡(
øã
->
Êags
 & 
IEEE80211_TX_RC_40_MHZ_WIDTH
)

336 
ªsu…
 |
	`u32_ícode_bôs
(1, 
RATE_MCS_CHAN_WIDTH_MSK_V1
);

337 i‡(
öfo
->
Êags
 & 
IEEE80211_TX_CTL_LDPC
)

338 
ªsu…
 |
RATE_MCS_LDPC_MSK_V1
;

339 i‡(
	`u32_gë_bôs
(
öfo
->
Êags
, 
IEEE80211_TX_CTL_STBC
))

340 
ªsu…
 |
RATE_MCS_STBC_MSK
;

342 i‡(
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
LONG_GROUP
, 
TX_CMD
, 0) > 6)

343 
ªsu…
 = 
	`iwl_√w_øã_‰om_v1
(result);

345 
øã_idx
 = 
öfo
->
c⁄åﬁ
.
øãs
[0].
idx
;

347 
ªsu…
 = 
	`iwl_mvm_c⁄vît_øã_idx
(
mvm
, 
öfo
, 
øã_idx
);

350 i‡(
öfo
->
c⁄åﬁ
.
™ã¬as
)

351 
ªsu…
 |
	`u32_ícode_bôs
(
öfo
->
c⁄åﬁ
.
™ã¬as
,

352 
RATE_MCS_ANT_AB_MSK
);

354 
ªsu…
 |
	`iwl_mvm_gë_tx_™t
(
mvm
, 
öfo
, 
°a
, 
fc
);

356  
ªsu…
;

357 
	}
}

359 
u32
 
	$iwl_mvm_gë_tx_øã
(
iwl_mvm
 *
mvm
,

360 
õì80211_tx_öfo
 *
öfo
,

361 
õì80211_°a
 *
°a
, 
__À16
 
fc
)

363 
øã_idx
 = -1;

365 i‡(!
	`õì80211_hw_check
(
mvm
->
hw
, 
HAS_RATE_CONTROL
)) {

369 
	`WARN_ONCE
(
öfo
->
c⁄åﬁ
.
øãs
[0].
Êags
 & 
IEEE80211_TX_RC_MCS
 &&

370 !
	`õì80211_is_d©a
(
fc
),

372 
öfo
->
c⁄åﬁ
.
øãs
[0].
Êags
,

373 
öfo
->
c⁄åﬁ
.
øãs
[0].
idx
,

374 
	`À16_to_˝u
(
fc
),

375 
°a
 ? 
	`iwl_mvm_°a_‰om_mac80211
(°a)->
°a_°©e
 : -1);

377 
øã_idx
 = 
öfo
->
c⁄åﬁ
.
øãs
[0].
idx
;

382 i‡(
öfo
->
b™d
 !
NL80211_BAND_2GHZ
 ||

383 (
öfo
->
Êags
 & 
IEEE80211_TX_CTL_NO_CCK_RATE
))

384 
øã_idx
 +
IWL_FIRST_OFDM_RATE
;

387 
	`BUILD_BUG_ON
(
IWL_FIRST_CCK_RATE
 != 0);

390  
	`iwl_mvm_c⁄vît_øã_idx
(
mvm
, 
öfo
, 
øã_idx
);

391 
	}
}

393 
u32
 
	$iwl_mvm_gë_tx_øã_n_Êags
(
iwl_mvm
 *
mvm
,

394 
õì80211_tx_öfo
 *
öfo
,

395 
õì80211_°a
 *
°a
, 
__À16
 
fc
)

397 i‡(
	`u∆ikñy
(
öfo
->
c⁄åﬁ
.
Êags
 & 
IEEE80211_TX_CTRL_RATE_INJECT
))

398  
	`iwl_mvm_gë_öje˘_tx_øã
(
mvm
, 
öfo
, 
°a
, 
fc
);

400  
	`iwl_mvm_gë_tx_øã
(
mvm
, 
öfo
, 
°a
, 
fc
) |

401 
	`iwl_mvm_gë_tx_™t
(
mvm
, 
öfo
, 
°a
, 
fc
);

402 
	}
}

407 
	$iwl_mvm_£t_tx_cmd_øã
(
iwl_mvm
 *
mvm
, 
iwl_tx_cmd
 *
tx_cmd
,

408 
õì80211_tx_öfo
 *
öfo
,

409 
õì80211_°a
 *
°a
, 
__À16
 
fc
)

412 
tx_cmd
->
πs_ªåy_limô
 = 
IWL_RTS_DFAULT_RETRY_LIMIT
;

415 i‡(
	`õì80211_is_¥obe_ª•
(
fc
)) {

416 
tx_cmd
->
d©a_ªåy_limô
 = 
IWL_MGMT_DFAULT_RETRY_LIMIT
;

417 
tx_cmd
->
πs_ªåy_limô
 =

418 
	`mö
(
tx_cmd
->
d©a_ªåy_limô
,Åx_cmd->
πs_ªåy_limô
);

419 } i‡(
	`õì80211_is_back_ªq
(
fc
)) {

420 
tx_cmd
->
d©a_ªåy_limô
 = 
IWL_BAR_DFAULT_RETRY_LIMIT
;

422 
tx_cmd
->
d©a_ªåy_limô
 = 
IWL_DEFAULT_TX_RETRY
;

430 i‡(
	`likñy
(
	`õì80211_is_d©a
(
fc
Ë&& 
°a
 &&

431 !(
öfo
->
c⁄åﬁ
.
Êags
 & 
IEEE80211_TX_CTRL_RATE_INJECT
))) {

432 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

434 i‡(
mvm°a
->
°a_°©e
 >
IEEE80211_STA_AUTHORIZED
) {

435 
tx_cmd
->
öôül_øã_ödex
 = 0;

436 
tx_cmd
->
tx_Êags
 |
	`˝u_to_À32
(
TX_CMD_FLG_STA_RATE
);

439 } i‡(
	`õì80211_is_back_ªq
(
fc
)) {

440 
tx_cmd
->
tx_Êags
 |=

441 
	`˝u_to_À32
(
TX_CMD_FLG_ACK
 | 
TX_CMD_FLG_BAR
);

445 
tx_cmd
->
øã_n_Êags
 =

446 
	`˝u_to_À32
(
	`iwl_mvm_gë_tx_øã_n_Êags
(
mvm
, 
öfo
, 
°a
, 
fc
));

447 
	}
}

449 
ölöe
 
	$iwl_mvm_£t_tx_cmd_≤
(
õì80211_tx_öfo
 *
öfo
,

450 
u8
 *
¸y±o_hdr
)

452 
õì80211_key_c⁄f
 *
keyc⁄f
 = 
öfo
->
c⁄åﬁ
.
hw_key
;

453 
u64
 
≤
;

455 
≤
 = 
	`©omic64_öc_ªtu∫
(&
keyc⁄f
->
tx_≤
);

456 
¸y±o_hdr
[0] = 
≤
;

457 
¸y±o_hdr
[2] = 0;

458 
¸y±o_hdr
[3] = 0x20 | (
keyc⁄f
->
keyidx
 << 6);

459 
¸y±o_hdr
[1] = 
≤
 >> 8;

460 
¸y±o_hdr
[4] = 
≤
 >> 16;

461 
¸y±o_hdr
[5] = 
≤
 >> 24;

462 
¸y±o_hdr
[6] = 
≤
 >> 32;

463 
¸y±o_hdr
[7] = 
≤
 >> 40;

464 
	}
}

469 
	$iwl_mvm_£t_tx_cmd_¸y±o
(
iwl_mvm
 *
mvm
,

470 
õì80211_tx_öfo
 *
öfo
,

471 
iwl_tx_cmd
 *
tx_cmd
,

472 
sk_buff
 *
skb_‰ag
,

473 
hdæí
)

475 
õì80211_key_c⁄f
 *
keyc⁄f
 = 
öfo
->
c⁄åﬁ
.
hw_key
;

476 
u8
 *
¸y±o_hdr
 = 
skb_‰ag
->
d©a
 + 
hdæí
;

477 
iwl_tx_cmd_£c_˘æ
 
ty≥
 = 
TX_CMD_SEC_CCM
;

478 
u64
 
≤
;

480 
keyc⁄f
->
cùhî
) {

481 
WLAN_CIPHER_SUITE_CCMP
:

482 
	`iwl_mvm_£t_tx_cmd_ccmp
(
öfo
, 
tx_cmd
);

483 
	`iwl_mvm_£t_tx_cmd_≤
(
öfo
, 
¸y±o_hdr
);

486 
WLAN_CIPHER_SUITE_TKIP
:

487 
tx_cmd
->
£c_˘l
 = 
TX_CMD_SEC_TKIP
;

488 
≤
 = 
	`©omic64_öc_ªtu∫
(&
keyc⁄f
->
tx_≤
);

489 
	`õì80211_tkù_add_iv
(
¸y±o_hdr
, 
keyc⁄f
, 
≤
);

490 
	`õì80211_gë_tkù_p2k
(
keyc⁄f
, 
skb_‰ag
, 
tx_cmd
->
key
);

493 
WLAN_CIPHER_SUITE_WEP104
:

494 
tx_cmd
->
£c_˘l
 |
TX_CMD_SEC_KEY128
;

495 
ÁŒthrough
;

496 
WLAN_CIPHER_SUITE_WEP40
:

497 
tx_cmd
->
£c_˘l
 |
TX_CMD_SEC_WEP
 |

498 ((
keyc⁄f
->
keyidx
 << 
TX_CMD_SEC_WEP_KEY_IDX_POS
) &

499 
TX_CMD_SEC_WEP_KEY_IDX_MSK
);

501 
	`mem˝y
(&
tx_cmd
->
key
[3], 
keyc⁄f
->key, keyc⁄f->
keyÀn
);

503 
WLAN_CIPHER_SUITE_GCMP
:

504 
WLAN_CIPHER_SUITE_GCMP_256
:

505 
ty≥
 = 
TX_CMD_SEC_GCMP
;

506 
ÁŒthrough
;

507 
WLAN_CIPHER_SUITE_CCMP_256
:

514 
tx_cmd
->
£c_˘l
 |
ty≥
 | 
TX_CMD_SEC_KEY_FROM_TABLE
;

515 
tx_cmd
->
key
[0] = 
keyc⁄f
->
hw_key_idx
;

516 
	`iwl_mvm_£t_tx_cmd_≤
(
öfo
, 
¸y±o_hdr
);

519 
tx_cmd
->
£c_˘l
 |
TX_CMD_SEC_EXT
;

521 
	}
}

523 
boﬁ
 
	$iwl_mvm_u£_ho°_øã
(
iwl_mvm
 *
mvm
,

524 
iwl_mvm_°a
 *
mvm°a
,

525 
õì80211_hdr
 *
hdr
,

526 
õì80211_tx_öfo
 *
öfo
)

528 i‡(
	`u∆ikñy
(!
mvm°a
))

529  
åue
;

531 i‡(
	`u∆ikñy
(
öfo
->
c⁄åﬁ
.
Êags
 & 
IEEE80211_TX_CTRL_RATE_INJECT
))

532  
åue
;

534 i‡(
	`likñy
(
	`õì80211_is_d©a
(
hdr
->
‰ame_c⁄åﬁ
) &&

535 
mvm°a
->
°a_°©e
 >
IEEE80211_STA_AUTHORIZED
))

536  
Ál£
;

545  
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 < 
IWL_DEVICE_FAMILY_BZ
;

546 
	}
}

548 
	$iwl_mvm_c›y_hdr
(*
cmd
, c⁄° *
hdr
, 
hdæí
,

549 c⁄° 
u8
 *
addr3_ovîride
)

551 
õì80211_hdr
 *
out_hdr
 = 
cmd
;

553 
	`mem˝y
(
cmd
, 
hdr
, 
hdæí
);

554 i‡(
addr3_ovîride
)

555 
	`mem˝y
(
out_hdr
->
addr3
, 
addr3_ovîride
, 
ETH_ALEN
);

556 
	}
}

561 
iwl_devi˚_tx_cmd
 *

562 
	$iwl_mvm_£t_tx_∑øms
(
iwl_mvm
 *
mvm
, 
sk_buff
 *
skb
,

563 
õì80211_tx_öfo
 *
öfo
, 
hdæí
,

564 
õì80211_°a
 *
°a
, 
u8
 
°a_id
,

565 c⁄° 
u8
 *
addr3_ovîride
)

567 
õì80211_hdr
 *
hdr
 = (õì80211_hd∏*)
skb
->
d©a
;

568 
iwl_devi˚_tx_cmd
 *
dev_cmd
;

569 
iwl_tx_cmd
 *
tx_cmd
;

571 
dev_cmd
 = 
	`iwl_å™s_Æloc_tx_cmd
(
mvm
->
å™s
);

573 i‡(
	`u∆ikñy
(!
dev_cmd
))

574  
NULL
;

576 
dev_cmd
->
hdr
.
cmd
 = 
TX_CMD
;

578 i‡(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)) {

579 
u32
 
øã_n_Êags
 = 0;

580 
u16
 
Êags
 = 0;

581 
iwl_mvm_°a
 *
mvm°a
 = 
°a
 ?

582 
	`iwl_mvm_°a_‰om_mac80211
(
°a
Ë: 
NULL
;

583 
boﬁ
 
amsdu
 = 
Ál£
;

585 i‡(
	`õì80211_is_d©a_qos
(
hdr
->
‰ame_c⁄åﬁ
)) {

586 
u8
 *
qc
 = 
	`õì80211_gë_qos_˘l
(
hdr
);

588 
amsdu
 = *
qc
 & 
IEEE80211_QOS_CTL_A_MSDU_PRESENT
;

591 i‡(!
öfo
->
c⁄åﬁ
.
hw_key
)

592 
Êags
 |
IWL_TX_FLAGS_ENCRYPT_DIS
;

600 i‡(
	`u∆ikñy
(
	`iwl_mvm_u£_ho°_øã
(
mvm
, 
mvm°a
, 
hdr
, 
öfo
))) {

601 
Êags
 |
IWL_TX_FLAGS_CMD_RATE
;

602 
øã_n_Êags
 =

603 
	`iwl_mvm_gë_tx_øã_n_Êags
(
mvm
, 
öfo
, 
°a
,

604 
hdr
->
‰ame_c⁄åﬁ
);

605 } i‡(!
	`õì80211_is_d©a
(
hdr
->
‰ame_c⁄åﬁ
) ||

606 
mvm°a
->
°a_°©e
 < 
IEEE80211_STA_AUTHORIZED
) {

608 
Êags
 |
IWL_TX_FLAGS_HIGH_PRI
;

611 i‡(
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 >=

612 
IWL_DEVICE_FAMILY_AX210
) {

613 
iwl_tx_cmd_gí3
 *
cmd
 = (*)
dev_cmd
->
∑ylﬂd
;

614 
u32
 
ofÊﬂd_assi°
 = 
	`iwl_mvm_tx_csum
(
mvm
, 
skb
,

615 
öfo
, 
amsdu
);

617 
cmd
->
ofÊﬂd_assi°
 = 
	`˝u_to_À32
(offload_assist);

620 
cmd
->
Àn
 = 
	`˝u_to_À16
((
u16
)
skb
->len);

623 
	`iwl_mvm_c›y_hdr
(
cmd
->
hdr
, hdr, 
hdæí
, 
addr3_ovîride
);

625 
cmd
->
Êags
 = 
	`˝u_to_À16
(flags);

626 
cmd
->
øã_n_Êags
 = 
	`˝u_to_À32
(rate_n_flags);

628 
iwl_tx_cmd_gí2
 *
cmd
 = (*)
dev_cmd
->
∑ylﬂd
;

629 
u16
 
ofÊﬂd_assi°
 = 
	`iwl_mvm_tx_csum
(
mvm
, 
skb
,

630 
öfo
, 
amsdu
);

632 
cmd
->
ofÊﬂd_assi°
 = 
	`˝u_to_À16
(offload_assist);

635 
cmd
->
Àn
 = 
	`˝u_to_À16
((
u16
)
skb
->len);

638 
	`iwl_mvm_c›y_hdr
(
cmd
->
hdr
, hdr, 
hdæí
, 
addr3_ovîride
);

640 
cmd
->
Êags
 = 
	`˝u_to_À32
(flags);

641 
cmd
->
øã_n_Êags
 = 
	`˝u_to_À32
(rate_n_flags);

643 
out
;

646 
tx_cmd
 = (
iwl_tx_cmd
 *)
dev_cmd
->
∑ylﬂd
;

648 i‡(
öfo
->
c⁄åﬁ
.
hw_key
)

649 
	`iwl_mvm_£t_tx_cmd_¸y±o
(
mvm
, 
öfo
, 
tx_cmd
, 
skb
, 
hdæí
);

651 
	`iwl_mvm_£t_tx_cmd
(
mvm
, 
skb
, 
tx_cmd
, 
öfo
, 
°a_id
);

653 
	`iwl_mvm_£t_tx_cmd_øã
(
mvm
, 
tx_cmd
, 
öfo
, 
°a
, 
hdr
->
‰ame_c⁄åﬁ
);

656 
	`iwl_mvm_c›y_hdr
(
tx_cmd
->
hdr
, hdr, 
hdæí
, 
addr3_ovîride
);

658 
out
:

659  
dev_cmd
;

660 
	}
}

662 
	$iwl_mvm_skb_¥ï¨e_°©us
(
sk_buff
 *
skb
,

663 
iwl_devi˚_tx_cmd
 *
cmd
)

665 
õì80211_tx_öfo
 *
skb_öfo
 = 
	`IEEE80211_SKB_CB
(
skb
);

667 
	`mem£t
(&
skb_öfo
->
°©us
, 0, (skb_info->status));

668 
	`mem£t
(
skb_öfo
->
drivî_d©a
, 0, (skb_info->driver_data));

670 
skb_öfo
->
drivî_d©a
[1] = 
cmd
;

671 
	}
}

673 
	$iwl_mvm_gë_˘æ_vif_queue
(
iwl_mvm
 *
mvm
,

674 
iwl_mvm_vif_lök_öfo
 *
lök
,

675 
õì80211_tx_öfo
 *
öfo
,

676 
sk_buff
 *
skb
)

678 
õì80211_hdr
 *
hdr
 = (*)
skb
->
d©a
;

679 
__À16
 
fc
 = 
hdr
->
‰ame_c⁄åﬁ
;

681 
öfo
->
c⁄åﬁ
.
vif
->
ty≥
) {

682 
NL80211_IFTYPE_AP
:

683 
NL80211_IFTYPE_ADHOC
:

694 i‡(
	`õì80211_is_mgmt
(
fc
) &&

695 (!
	`õì80211_is_buf„øbÀ_mmpdu
(
skb
) ||

696 
	`õì80211_is_dóuth
(
fc
Ë|| 
	`õì80211_is_dißssoc
(fc)))

697  
lök
->
mgmt_queue
;

699 i‡(!
	`õì80211_has_‹dî
(
fc
Ë&& !
	`õì80211_is_¥obe_ªq
(fc) &&

700 
	`is_mu…iˇ°_ëhî_addr
(
hdr
->
addr1
))

701  
lök
->
ˇb_queue
;

703 
	`WARN_ONCE
(
öfo
->
c⁄åﬁ
.
vif
->
ty≥
 !
NL80211_IFTYPE_ADHOC
,

704 "fc=0x%02x", 
	`À16_to_˝u
(
fc
));

705  
lök
->
mgmt_queue
;

706 
NL80211_IFTYPE_P2P_DEVICE
:

707 i‡(
	`õì80211_is_mgmt
(
fc
))

708  
mvm
->
p2p_dev_queue
;

710 
	`WARN_ON_ONCE
(1);

711  
mvm
->
p2p_dev_queue
;

713 
	`WARN_ONCE
(1, "Notá ctrl vif,Çoávailable queue\n");

716 
	}
}

718 
	$iwl_mvm_¥obe_ª•_£t_nﬂ
(
iwl_mvm
 *
mvm
,

719 
sk_buff
 *
skb
)

721 
õì80211_tx_öfo
 *
öfo
 = 
	`IEEE80211_SKB_CB
(
skb
);

722 
iwl_mvm_vif
 *
mvmvif
 =

723 
	`iwl_mvm_vif_‰om_mac80211
(
öfo
->
c⁄åﬁ
.
vif
);

724 
õì80211_mgmt
 *
mgmt
 = (õì80211_mgmà*)
skb
->
d©a
;

725 
ba£_Àn
 = (
u8
 *)
mgmt
->
u
.
¥obe_ª•
.
v¨übÀ
 - (u8 *)mgmt;

726 
iwl_¥obe_ª•_d©a
 *
ª•_d©a
;

727 c⁄° 
u8
 *
õ
;

728 
u8
 *
pos
;

729 
u8
 
m©ch
[] = {

730 (
WLAN_OUI_WFA
 >> 16) & 0xff,

731 (
WLAN_OUI_WFA
 >> 8) & 0xff,

732 
WLAN_OUI_WFA
 & 0xff,

733 
WLAN_OUI_TYPE_WFA_P2P
,

736 
	`rcu_ªad_lock
();

738 
ª•_d©a
 = 
	`rcu_dîe„ªn˚
(
mvmvif
->
deÊök
.
¥obe_ª•_d©a
);

739 i‡(!
ª•_d©a
)

740 
out
;

742 i‡(!
ª•_d©a
->
nŸif
.
nﬂ_a˘ive
)

743 
out
;

745 
õ
 = 
	`cfg80211_föd_õ_m©ch
(
WLAN_EID_VENDOR_SPECIFIC
,

746 
mgmt
->
u
.
¥obe_ª•
.
v¨übÀ
,

747 
skb
->
Àn
 - 
ba£_Àn
,

748 
m©ch
, 4, 2);

749 i‡(!
õ
) {

750 
	`IWL_DEBUG_TX
(
mvm
, "probeÑesp doesn't have P2P IE\n");

751 
out
;

754 i‡(
	`skb_èûroom
(
skb
Ë< 
ª•_d©a
->
nﬂ_Àn
) {

755 i‡(
	`pskb_ex∑nd_hód
(
skb
, 0, 
ª•_d©a
->
nﬂ_Àn
, 
GFP_ATOMIC
)) {

756 
	`IWL_ERR
(
mvm
,

758 
out
;

762 
pos
 = 
	`skb_put
(
skb
, 
ª•_d©a
->
nﬂ_Àn
);

764 *
pos
++ = 
WLAN_EID_VENDOR_SPECIFIC
;

766 *
pos
++ = 
ª•_d©a
->
nﬂ_Àn
 - 2;

767 *
pos
++ = (
WLAN_OUI_WFA
 >> 16) & 0xff;

768 *
pos
++ = (
WLAN_OUI_WFA
 >> 8) & 0xff;

769 *
pos
++ = 
WLAN_OUI_WFA
 & 0xff;

770 *
pos
++ = 
WLAN_OUI_TYPE_WFA_P2P
;

772 
	`mem˝y
(
pos
, &
ª•_d©a
->
nŸif
.
nﬂ_©å
,

773 
ª•_d©a
->
nﬂ_Àn
 - (
õì80211_víd‹_õ
));

775 
out
:

776 
	`rcu_ªad_u∆ock
();

777 
	}
}

779 
	$iwl_mvm_tx_skb_n⁄_°a
(
iwl_mvm
 *
mvm
, 
sk_buff
 *
skb
)

781 
õì80211_hdr
 *
hdr
 = (õì80211_hd∏*)
skb
->
d©a
;

782 
õì80211_tx_öfo
 
öfo
;

783 
iwl_devi˚_tx_cmd
 *
dev_cmd
;

784 
u8
 
°a_id
;

785 
hdæí
 = 
	`õì80211_hdæí
(
hdr
->
‰ame_c⁄åﬁ
);

786 
__À16
 
fc
 = 
hdr
->
‰ame_c⁄åﬁ
;

787 
boﬁ
 
offch™√l
 = 
	`IEEE80211_SKB_CB
(
skb
)->
Êags
 &

788 
IEEE80211_TX_CTL_TX_OFFCHAN
;

789 
queue
 = -1;

791 i‡(
IWL_MVM_NON_TRANSMITTING_AP
 && 
	`õì80211_is_¥obe_ª•
(
fc
))

794 
	`mem˝y
(&
öfo
, 
skb
->
cb
, (info));

796 i‡(
	`WARN_ON_ONCE
(
skb
->
Àn
 > 
IEEE80211_MAX_DATA_LEN
 + 
hdæí
))

799 i‡(
	`WARN_ON_ONCE
(
öfo
.
Êags
 & 
IEEE80211_TX_CTL_AMPDU
))

802 i‡(
öfo
.
c⁄åﬁ
.
vif
) {

803 
iwl_mvm_vif
 *
mvmvif
 =

804 
	`iwl_mvm_vif_‰om_mac80211
(
öfo
.
c⁄åﬁ
.
vif
);

806 i‡(
öfo
.
c⁄åﬁ
.
vif
->
ty≥
 =
NL80211_IFTYPE_P2P_DEVICE
 ||

807 
öfo
.
c⁄åﬁ
.
vif
->
ty≥
 =
NL80211_IFTYPE_AP
 ||

808 
öfo
.
c⁄åﬁ
.
vif
->
ty≥
 =
NL80211_IFTYPE_ADHOC
) {

809 
u32
 
lök_id
 = 
	`u32_gë_bôs
(
öfo
.
c⁄åﬁ
.
Êags
,

810 
IEEE80211_TX_CTRL_MLO_LINK
);

811 
iwl_mvm_vif_lök_öfo
 *
lök
;

813 i‡(
lök_id
 =
IEEE80211_LINK_UNSPECIFIED
) {

814 i‡(
öfo
.
c⁄åﬁ
.
vif
->
a˘ive_löks
)

815 
lök_id
 = 
	`ffs
(
öfo
.
c⁄åﬁ
.
vif
->
a˘ive_löks
) - 1;

817 
lök_id
 = 0;

820 
lök
 = 
mvmvif
->lök[
lök_id
];

821 i‡(
	`WARN_ON
(!
lök
))

824 i‡(!
	`õì80211_is_d©a
(
hdr
->
‰ame_c⁄åﬁ
))

825 
°a_id
 = 
lök
->
bˇ°_°a
.sta_id;

827 
°a_id
 = 
lök
->
mˇ°_°a
.sta_id;

829 
queue
 = 
	`iwl_mvm_gë_˘æ_vif_queue
(
mvm
, 
lök
, &
öfo
,

830 
skb
);

831 } i‡(
öfo
.
c⁄åﬁ
.
vif
->
ty≥
 =
NL80211_IFTYPE_MONITOR
) {

832 
queue
 = 
mvm
->
¢if_queue
;

833 
°a_id
 = 
mvm
->
¢if_°a
.sta_id;

834 } i‡(
öfo
.
c⁄åﬁ
.
vif
->
ty≥
 =
NL80211_IFTYPE_STATION
 &&

835 
offch™√l
) {

844 
°a_id
 = 
mvm
->
aux_°a
.sta_id;

845 
queue
 = 
mvm
->
aux_queue
;

849 i‡(
queue
 < 0) {

850 
	`IWL_ERR
(
mvm
, "No queue was found. Dropping TX\n");

854 i‡(
	`u∆ikñy
(
	`õì80211_is_¥obe_ª•
(
fc
)))

855 
	`iwl_mvm_¥obe_ª•_£t_nﬂ
(
mvm
, 
skb
);

857 
	`IWL_DEBUG_TX
(
mvm
, "°©i⁄ Id %d, queue=%d\n", 
°a_id
, 
queue
);

859 
dev_cmd
 = 
	`iwl_mvm_£t_tx_∑øms
(
mvm
, 
skb
, &
öfo
, 
hdæí
, 
NULL
, 
°a_id
,

860 
NULL
);

861 i‡(!
dev_cmd
)

865 
	`iwl_mvm_skb_¥ï¨e_°©us
(
skb
, 
dev_cmd
);

867 i‡(
	`iwl_å™s_tx
(
mvm
->
å™s
, 
skb
, 
dev_cmd
, 
queue
)) {

868 
	`iwl_å™s_‰ì_tx_cmd
(
mvm
->
å™s
, 
dev_cmd
);

873 
	}
}

875 
	$iwl_mvm_max_amsdu_size
(
iwl_mvm
 *
mvm
,

876 
õì80211_°a
 *
°a
, 
tid
)

878 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

879 
u8
 
ac
 = 
tid_to_mac80211_ac
[
tid
];

880 
∆80211_b™d
 
b™d
;

881 
txf
;

882 
vÆ
;

883 
lmac
;

886 i‡(
°a
->
deÊök
.
he_ˇp
.
has_he
 && !
	`WARN_ON
(!
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)))

887 
ac
 += 4;

889 
txf
 = 
	`iwl_mvm_mac_ac_to_tx_fifo
(
mvm
, 
ac
);

897 
vÆ
 = 
mvm°a
->
max_amsdu_Àn
;

899 i‡(
	`hweight16
(
°a
->
vÆid_löks
) <= 1) {

900 i‡(
°a
->
vÆid_löks
) {

901 
õì80211_bss_c⁄f
 *
lök_c⁄f
;

902 
lök
 = 
	`ffs
(
°a
->
vÆid_löks
) - 1;

904 
	`rcu_ªad_lock
();

905 
lök_c⁄f
 = 
	`rcu_dîe„ªn˚
(
mvm°a
->
vif
->lök_c⁄f[
lök
]);

906 i‡(
	`WARN_ON
(!
lök_c⁄f
))

907 
b™d
 = 
NL80211_BAND_2GHZ
;

909 
b™d
 = 
lök_c⁄f
->
ch™ªq
.
›î
.
ch™
->band;

910 
	`rcu_ªad_u∆ock
();

912 
b™d
 = 
mvm°a
->
vif
->
bss_c⁄f
.
ch™ªq
.
›î
.
ch™
->band;

915 
lmac
 = 
	`iwl_mvm_gë_lmac_id
(
mvm
, 
b™d
);

916 } i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

917 
IWL_UCODE_TLV_CAPA_CDB_SUPPORT
)) {

919 
lmac
 = 
IWL_LMAC_5G_INDEX
;

920 
vÆ
 = 
	`mö_t
(, val,

921 
mvm
->
fwπ
.
smem_cfg
.
lmac
[lmac].
txfifo_size
[
txf
] - 256);

922 
lmac
 = 
IWL_LMAC_24G_INDEX
;

924 
lmac
 = 
IWL_LMAC_24G_INDEX
;

927  
	`mö_t
(, 
vÆ
,

928 
mvm
->
fwπ
.
smem_cfg
.
lmac
[lmac].
txfifo_size
[
txf
] - 256);

929 
	}
}

931 #ifde‡
CONFIG_INET


934 
	$iwl_mvm_tx_tso_£gmít
(
sk_buff
 *
skb
, 
num_sub‰ames
,

935 
√tdev_„©uªs_t
 
√tdev_Êags
,

936 
sk_buff_hód
 *
mpdus_skb
)

938 
sk_buff
 *
tmp
, *
√xt
;

939 
õì80211_hdr
 *
hdr
 = (*)
skb
->
d©a
;

940 
cb
[(
skb
->cb)];

941 
u16
 
i
 = 0;

942 
t˝_∑ylﬂd_Àn
;

943 
mss
 = 
	`skb_shöfo
(
skb
)->
gso_size
;

944 
boﬁ
 
ùv4
 = (
skb
->
¥Ÿocﬁ
 =
	`ht⁄s
(
ETH_P_IP
));

945 
boﬁ
 
qos
 = 
	`õì80211_is_d©a_qos
(
hdr
->
‰ame_c⁄åﬁ
);

946 
u16
 
ù_ba£_id
 = 
ùv4
 ? 
	`¡ohs
(
	`ù_hdr
(
skb
)->
id
) : 0;

948 
	`skb_shöfo
(
skb
)->
gso_size
 = 
num_sub‰ames
 * 
mss
;

949 
	`mem˝y
(
cb
, 
skb
->cb, (cb));

951 
√xt
 = 
	`skb_gso_£gmít
(
skb
, 
√tdev_Êags
);

952 
	`skb_shöfo
(
skb
)->
gso_size
 = 
mss
;

953 
	`skb_shöfo
(
skb
)->
gso_ty≥
 = 
ùv4
 ? 
SKB_GSO_TCPV4
 : 
SKB_GSO_TCPV6
;

955 i‡(
	`IS_ERR
(
√xt
Ë&& 
	`PTR_ERR
“extË=-
ENOMEM
)

956  -
ENOMEM
;

958 i‡(
	`WARN_ONCE
(
	`IS_ERR
(
√xt
),

959 "skb_gso_£gmíàîr‹: %d\n", ()
	`PTR_ERR
(
√xt
)))

960  
	`PTR_ERR
(
√xt
);

962 i‡(
√xt
)

963 
	`c⁄sume_skb
(
skb
);

965 
	`skb_li°_wÆk_ß„
(
√xt
, 
tmp
,Çext) {

966 
	`mem˝y
(
tmp
->
cb
, cb, (tmp->cb));

973 
t˝_∑ylﬂd_Àn
 = 
	`skb_èû_poöãr
(
tmp
) -

974 
	`skb_å™•‹t_hódî
(
tmp
) -

975 
	`t˝_hdæí
(
tmp
Ë+Åmp->
d©a_Àn
;

977 i‡(
ùv4
)

978 
	`ù_hdr
(
tmp
)->
id
 = 
	`ht⁄s
(
ù_ba£_id
 + 
i
 * 
num_sub‰ames
);

980 i‡(
t˝_∑ylﬂd_Àn
 > 
mss
) {

981 
	`skb_shöfo
(
tmp
)->
gso_size
 = 
mss
;

982 
	`skb_shöfo
(
tmp
)->
gso_ty≥
 = 
ùv4
 ? 
SKB_GSO_TCPV4
 :

983 
SKB_GSO_TCPV6
;

985 i‡(
qos
) {

986 
u8
 *
qc
;

988 i‡(
ùv4
)

989 
	`ù_£nd_check
(
	`ù_hdr
(
tmp
));

991 
qc
 = 
	`õì80211_gë_qos_˘l
((*)
tmp
->
d©a
);

992 *
qc
 &~
IEEE80211_QOS_CTL_A_MSDU_PRESENT
;

994 
	`skb_shöfo
(
tmp
)->
gso_size
 = 0;

997 
	`skb_m¨k_nŸ_⁄_li°
(
tmp
);

998 
	`__skb_queue_èû
(
mpdus_skb
, 
tmp
);

999 
i
++;

1003 
	}
}

1005 
	$iwl_mvm_tx_tso
(
iwl_mvm
 *
mvm
, 
sk_buff
 *
skb
,

1006 
õì80211_tx_öfo
 *
öfo
,

1007 
õì80211_°a
 *
°a
,

1008 
sk_buff_hód
 *
mpdus_skb
)

1010 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

1011 
õì80211_hdr
 *
hdr
 = (*)
skb
->
d©a
;

1012 
mss
 = 
	`skb_shöfo
(
skb
)->
gso_size
;

1013 
num_sub‰ames
, 
t˝_∑ylﬂd_Àn
, 
subf_Àn
, 
max_amsdu_Àn
;

1014 
u16
 
¢≠_ù_t˝
, 
∑d
;

1015 
√tdev_„©uªs_t
 
√tdev_Êags
 = 
NETIF_F_CSUM_MASK
 | 
NETIF_F_SG
;

1016 
u8
 
tid
;

1018 
¢≠_ù_t˝
 = 8 + 
	`skb_√tw‹k_hódî_Àn
(
skb
Ë+ 
	`t˝_hdæí
(skb);

1020 i‡(!
mvm°a
->
max_amsdu_Àn
 ||

1021 !
	`õì80211_is_d©a_qos
(
hdr
->
‰ame_c⁄åﬁ
) ||

1022 !
mvm°a
->
amsdu_íabÀd
)

1023  
	`iwl_mvm_tx_tso_£gmít
(
skb
, 1, 
√tdev_Êags
, 
mpdus_skb
);

1029 i‡(
skb
->
¥Ÿocﬁ
 =
	`ht⁄s
(
ETH_P_IPV6
) &&

1030 ((
ùv6hdr
 *)
	`skb_√tw‹k_hódî
(
skb
))->
√xthdr
 !=

1031 
IPPROTO_TCP
) {

1032 
√tdev_Êags
 &~
NETIF_F_CSUM_MASK
;

1033  
	`iwl_mvm_tx_tso_£gmít
(
skb
, 1, 
√tdev_Êags
, 
mpdus_skb
);

1036 
tid
 = 
	`õì80211_gë_tid
(
hdr
);

1037 i‡(
	`WARN_ON_ONCE
(
tid
 >
IWL_MAX_TID_COUNT
))

1038  -
EINVAL
;

1044 i‡((
öfo
->
Êags
 & 
IEEE80211_TX_CTL_AMPDU
 &&

1045 !
mvm°a
->
tid_d©a
[
tid
].
amsdu_ö_ampdu_Ælowed
) ||

1046 !(
mvm°a
->
amsdu_íabÀd
 & 
	`BIT
(
tid
)))

1047  
	`iwl_mvm_tx_tso_£gmít
(
skb
, 1, 
√tdev_Êags
, 
mpdus_skb
);

1052 
max_amsdu_Àn
 =

1053 
	`mö_t
(, 
°a
->
cur
->
max_amsdu_Àn
,

1054 
	`iwl_mvm_max_amsdu_size
(
mvm
, 
°a
, 
tid
));

1061 i‡(
öfo
->
Êags
 & 
IEEE80211_TX_CTL_AMPDU
 &&

1062 !
°a
->
deÊök
.
vht_ˇp
.
vht_suµ‹ãd
)

1063 
max_amsdu_Àn
 = 
	`mö_t
(, max_amsdu_len, 4095);

1066 
subf_Àn
 = (
ëhhdr
Ë+ 
¢≠_ù_t˝
 + 
mss
;

1067 
∑d
 = (4 - 
subf_Àn
) & 0x3;

1073 
num_sub‰ames
 = (
max_amsdu_Àn
 + 
∑d
Ë/ (
subf_Àn
 +Öad);

1075 i‡(
°a
->
max_amsdu_sub‰ames
 &&

1076 
num_sub‰ames
 > 
°a
->
max_amsdu_sub‰ames
)

1077 
num_sub‰ames
 = 
°a
->
max_amsdu_sub‰ames
;

1079 
t˝_∑ylﬂd_Àn
 = 
	`skb_èû_poöãr
(
skb
Ë- 
	`skb_å™•‹t_hódî
(skb) -

1080 
	`t˝_hdæí
(
skb
Ë+ skb->
d©a_Àn
;

1088 i‡((
num_sub‰ames
 * 2 + 
	`skb_shöfo
(
skb
)->
ƒ_‰ags
 + 1) >

1089 
mvm
->
å™s
->
max_skb_‰ags
)

1090 
num_sub‰ames
 = 1;

1092 i‡(
num_sub‰ames
 > 1)

1093 *
	`õì80211_gë_qos_˘l
(
hdr
Ë|
IEEE80211_QOS_CTL_A_MSDU_PRESENT
;

1096 i‡(
num_sub‰ames
 * 
mss
 >
t˝_∑ylﬂd_Àn
) {

1097 
	`__skb_queue_èû
(
mpdus_skb
, 
skb
);

1105  
	`iwl_mvm_tx_tso_£gmít
(
skb
, 
num_sub‰ames
, 
√tdev_Êags
,

1106 
mpdus_skb
);

1107 
	}
}

1109 
	$iwl_mvm_tx_tso
(
iwl_mvm
 *
mvm
, 
sk_buff
 *
skb
,

1110 
õì80211_tx_öfo
 *
öfo
,

1111 
õì80211_°a
 *
°a
,

1112 
sk_buff_hód
 *
mpdus_skb
)

1115 
	`WARN_ON
(1);

1118 
	}
}

1122 
boﬁ
 
	$iwl_mvm_txq_should_upd©e
(
iwl_mvm
 *
mvm
, 
txq_id
)

1124 
queue_tid_bôm≠
 = 
mvm
->
queue_öfo
[
txq_id
].
tid_bôm≠
;

1125 
now
 = 
jiffõs
;

1126 
tid
;

1128 i‡(
	`WARN_ON
(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)))

1129  
Ál£
;

1131 
	`f‹_óch_£t_bô
(
tid
, &
queue_tid_bôm≠
, 
IWL_MAX_TID_COUNT
 + 1) {

1132 i‡(
	`time_bef‹e
(
mvm
->
queue_öfo
[
txq_id
].
œ°_‰ame_time
[
tid
] +

1133 
IWL_MVM_DQA_QUEUE_TIMEOUT
, 
now
))

1134  
åue
;

1137  
Ál£
;

1138 
	}
}

1140 
	$iwl_mvm_tx_aútime
(
iwl_mvm
 *
mvm
,

1141 
iwl_mvm_°a
 *
mvm°a
,

1142 
aútime
)

1144 
mac
 = 
mvm°a
->
mac_id_n_cﬁ‹
 & 
FW_CTXT_ID_MSK
;

1145 
iwl_mvm_tcm_mac
 *
md©a
;

1147 i‡(
mac
 >
NUM_MAC_INDEX_DRIVER
)

1150 
md©a
 = &
mvm
->
tcm
.
d©a
[
mac
];

1152 i‡(
mvm
->
tcm
.
∑u£d
)

1155 i‡(
	`time_a·î
(
jiffõs
, 
mvm
->
tcm
.
ts
 + 
MVM_TCM_PERIOD
))

1156 
	`scheduÀ_dñayed_w‹k
(&
mvm
->
tcm
.
w‹k
, 0);

1158 
md©a
->
tx
.
aútime
 +=áirtime;

1159 
	}
}

1161 
	$iwl_mvm_tx_pkt_queued
(
iwl_mvm
 *
mvm
,

1162 
iwl_mvm_°a
 *
mvm°a
, 
tid
)

1164 
u32
 
ac
 = 
tid_to_mac80211_ac
[
tid
];

1165 
mac
 = 
mvm°a
->
mac_id_n_cﬁ‹
 & 
FW_CTXT_ID_MSK
;

1166 
iwl_mvm_tcm_mac
 *
md©a
;

1168 i‡(
mac
 >
NUM_MAC_INDEX_DRIVER
)

1169  -
EINVAL
;

1171 
md©a
 = &
mvm
->
tcm
.
d©a
[
mac
];

1173 
md©a
->
tx
.
pkts
[
ac
]++;

1176 
	}
}

1183 
	$iwl_mvm_tx_mpdu
(
iwl_mvm
 *
mvm
, 
sk_buff
 *
skb
,

1184 
õì80211_tx_öfo
 *
öfo
,

1185 
õì80211_°a
 *
°a
,

1186 c⁄° 
u8
 *
addr3_ovîride
)

1188 
õì80211_hdr
 *
hdr
 = (õì80211_hd∏*)
skb
->
d©a
;

1189 
iwl_mvm_°a
 *
mvm°a
;

1190 
iwl_devi˚_tx_cmd
 *
dev_cmd
;

1191 
__À16
 
fc
;

1192 
u16
 
£q_numbî
 = 0;

1193 
u8
 
tid
 = 
IWL_MAX_TID_COUNT
;

1194 
u16
 
txq_id
;

1195 
boﬁ
 
is_ampdu
 = 
Ál£
;

1196 
hdæí
;

1198 
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

1199 
fc
 = 
hdr
->
‰ame_c⁄åﬁ
;

1200 
hdæí
 = 
	`õì80211_hdæí
(
fc
);

1202 i‡(
IWL_MVM_NON_TRANSMITTING_AP
 && 
	`õì80211_is_¥obe_ª•
(
fc
))

1205 i‡(
	`WARN_ON_ONCE
(!
mvm°a
))

1208 i‡(
	`WARN_ON_ONCE
(
mvm°a
->
deÊök
.
°a_id
 =
IWL_MVM_INVALID_STA
))

1211 i‡(
	`u∆ikñy
(
	`õì80211_is_™y_nuŒfunc
(
fc
)Ë&& 
°a
->
deÊök
.
he_ˇp
.
has_he
)

1214 i‡(
	`u∆ikñy
(
	`õì80211_is_¥obe_ª•
(
fc
)))

1215 
	`iwl_mvm_¥obe_ª•_£t_nﬂ
(
mvm
, 
skb
);

1217 
dev_cmd
 = 
	`iwl_mvm_£t_tx_∑øms
(
mvm
, 
skb
, 
öfo
, 
hdæí
,

1218 
°a
, 
mvm°a
->
deÊök
.
°a_id
,

1219 
addr3_ovîride
);

1220 i‡(!
dev_cmd
)

1221 
dr›
;

1228 
öfo
->
Êags
 &~
IEEE80211_TX_STATUS_EOSP
;

1230 
	`•ö_lock
(&
mvm°a
->
lock
);

1236 i‡(
	`õì80211_is_d©a_qos
(
fc
Ë&& !
	`õì80211_is_qos_nuŒfunc
(fc)) {

1237 
tid
 = 
	`õì80211_gë_tid
(
hdr
);

1238 i‡(
	`WARN_ONCE
(
tid
 >
IWL_MAX_TID_COUNT
, "Invalid TID %d",Åid))

1239 
dr›_u∆ock_°a
;

1241 
is_ampdu
 = 
öfo
->
Êags
 & 
IEEE80211_TX_CTL_AMPDU
;

1242 i‡(
	`WARN_ONCE
(
is_ampdu
 &&

1243 
mvm°a
->
tid_d©a
[
tid
].
°©e
 !
IWL_AGG_ON
,

1245 
mvm°a
->
tid_d©a
[
tid
].
°©e
,Åid))

1246 
dr›_u∆ock_°a
;

1248 
£q_numbî
 = 
mvm°a
->
tid_d©a
[
tid
].seq_number;

1249 
£q_numbî
 &
IEEE80211_SCTL_SEQ
;

1251 i‡(!
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)) {

1252 
iwl_tx_cmd
 *
tx_cmd
 = (*)
dev_cmd
->
∑ylﬂd
;

1254 
hdr
->
£q_˘æ
 &
	`˝u_to_À16
(
IEEE80211_SCTL_FRAG
);

1255 
hdr
->
£q_˘æ
 |
	`˝u_to_À16
(
£q_numbî
);

1257 
tx_cmd
->
hdr
->
£q_˘æ
 = hdr->seq_ctrl;

1259 } i‡(
	`õì80211_is_d©a
(
fc
Ë&& !
	`õì80211_is_d©a_qos
(fc) &&

1260 !
	`õì80211_is_nuŒfunc
(
fc
)) {

1261 
tid
 = 
IWL_TID_NON_QOS
;

1264 
txq_id
 = 
mvm°a
->
tid_d©a
[
tid
].txq_id;

1266 
	`WARN_ON_ONCE
(
öfo
->
Êags
 & 
IEEE80211_TX_CTL_SEND_AFTER_DTIM
);

1268 i‡(
	`WARN_ONCE
(
txq_id
 =
IWL_MVM_INVALID_QUEUE
, "Invalid TXQ id")) {

1269 
	`iwl_å™s_‰ì_tx_cmd
(
mvm
->
å™s
, 
dev_cmd
);

1270 
	`•ö_u∆ock
(&
mvm°a
->
lock
);

1274 i‡(!
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)) {

1276 
mvm
->
queue_öfo
[
txq_id
].
œ°_‰ame_time
[
tid
] = 
jiffõs
;

1288 i‡(
	`u∆ikñy
(
mvm
->
queue_öfo
[
txq_id
].
°©us
 ==

1289 
IWL_MVM_QUEUE_SHARED
 &&

1290 
	`iwl_mvm_txq_should_upd©e
(
mvm
, 
txq_id
)))

1291 
	`scheduÀ_w‹k
(&
mvm
->
add_°ªam_wk
);

1294 
	`IWL_DEBUG_TX
(
mvm
, "TXÅo [%d|%d] Q:%d - seq: 0x%xÜen %d\n",

1295 
mvm°a
->
deÊök
.
°a_id
, 
tid
, 
txq_id
,

1296 
	`IEEE80211_SEQ_TO_SN
(
£q_numbî
), 
skb
->
Àn
);

1299 
	`iwl_mvm_skb_¥ï¨e_°©us
(
skb
, 
dev_cmd
);

1306 i‡(
	`õì80211_is_d©a
(
fc
))

1307 
	`iwl_mvm_mei_tx_c›y_to_csme
(
mvm
, 
skb
,

1308 
öfo
->
c⁄åﬁ
.
hw_key
 &&

1309 !
	`iwl_mvm_has_√w_tx_≠i
(
mvm
) ?

1310 
öfo
->
c⁄åﬁ
.
hw_key
->
iv_Àn
 : 0);

1312 i‡(
	`iwl_å™s_tx
(
mvm
->
å™s
, 
skb
, 
dev_cmd
, 
txq_id
))

1313 
dr›_u∆ock_°a
;

1315 i‡(
tid
 < 
IWL_MAX_TID_COUNT
 && !
	`õì80211_has_m‹e‰ags
(
fc
))

1316 
mvm°a
->
tid_d©a
[
tid
].
£q_numbî
 = seq_number + 0x10;

1318 
	`•ö_u∆ock
(&
mvm°a
->
lock
);

1320 i‡(
	`iwl_mvm_tx_pkt_queued
(
mvm
, 
mvm°a
,

1321 
tid
 =
IWL_MAX_TID_COUNT
 ? 0 :Åid))

1322 
dr›
;

1326 
dr›_u∆ock_°a
:

1327 
	`iwl_å™s_‰ì_tx_cmd
(
mvm
->
å™s
, 
dev_cmd
);

1328 
	`•ö_u∆ock
(&
mvm°a
->
lock
);

1329 
dr›
:

1330 
	`IWL_DEBUG_TX
(
mvm
, "TXÅÿ[%d|%d] dr›≥d\n", 
mvm°a
->
deÊök
.
°a_id
,

1331 
tid
);

1333 
	}
}

1335 
	$iwl_mvm_tx_skb_°a
(
iwl_mvm
 *
mvm
, 
sk_buff
 *
skb
,

1336 
õì80211_°a
 *
°a
)

1338 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

1339 
õì80211_tx_öfo
 
öfo
;

1340 
sk_buff_hód
 
mpdus_skbs
;

1341 
õì80211_vif
 *
vif
;

1342 
∑ylﬂd_Àn
;

1343 
ªt
;

1344 
sk_buff
 *
‹ig_skb
 = 
skb
;

1345 c⁄° 
u8
 *
addr3
;

1347 i‡(
	`WARN_ON_ONCE
(!
mvm°a
))

1350 i‡(
	`WARN_ON_ONCE
(
mvm°a
->
deÊök
.
°a_id
 =
IWL_MVM_INVALID_STA
))

1353 
	`mem˝y
(&
öfo
, 
skb
->
cb
, (info));

1355 i‡(!
	`skb_is_gso
(
skb
))

1356  
	`iwl_mvm_tx_mpdu
(
mvm
, 
skb
, &
öfo
, 
°a
, 
NULL
);

1358 
∑ylﬂd_Àn
 = 
	`skb_èû_poöãr
(
skb
Ë- 
	`skb_å™•‹t_hódî
(skb) -

1359 
	`t˝_hdæí
(
skb
Ë+ skb->
d©a_Àn
;

1361 i‡(
∑ylﬂd_Àn
 <
	`skb_shöfo
(
skb
)->
gso_size
)

1362  
	`iwl_mvm_tx_mpdu
(
mvm
, 
skb
, &
öfo
, 
°a
, 
NULL
);

1364 
	`__skb_queue_hód_öô
(&
mpdus_skbs
);

1366 
vif
 = 
öfo
.
c⁄åﬁ
.vif;

1367 i‡(!
vif
)

1370 
ªt
 = 
	`iwl_mvm_tx_tso
(
mvm
, 
skb
, &
öfo
, 
°a
, &
mpdus_skbs
);

1371 i‡(
ªt
)

1372  
ªt
;

1374 
	`WARN_ON
(
	`skb_queue_em±y
(&
mpdus_skbs
));

1385 
vif
->
ty≥
) {

1386 
NL80211_IFTYPE_STATION
:

1387 
addr3
 = 
vif
->
cfg
.
≠_addr
;

1389 
NL80211_IFTYPE_AP
:

1390 
addr3
 = 
vif
->
addr
;

1393 
addr3
 = 
NULL
;

1397 !
	`skb_queue_em±y
(&
mpdus_skbs
)) {

1398 
õì80211_hdr
 *
hdr
;

1399 
boﬁ
 
amsdu
;

1401 
skb
 = 
	`__skb_dequeue
(&
mpdus_skbs
);

1402 
hdr
 = (*)
skb
->
d©a
;

1403 
amsdu
 = 
	`õì80211_is_d©a_qos
(
hdr
->
‰ame_c⁄åﬁ
) &&

1404 (*
	`õì80211_gë_qos_˘l
(
hdr
) &

1405 
IEEE80211_QOS_CTL_A_MSDU_PRESENT
);

1407 
ªt
 = 
	`iwl_mvm_tx_mpdu
(
mvm
, 
skb
, &
öfo
, 
°a
,

1408 
amsdu
 ? 
addr3
 : 
NULL
);

1409 i‡(
ªt
) {

1411 
	`__skb_queue_purge
(&
mpdus_skbs
);

1415 i‡(
skb
 =
‹ig_skb
)

1416 
	`õì80211_‰ì_txskb
(
mvm
->
hw
, 
skb
);

1418 
	`k‰ì_skb
(
skb
);

1425 
	}
}

1427 
	$iwl_mvm_check_øtid_em±y
(
iwl_mvm
 *
mvm
,

1428 
õì80211_°a
 *
°a
, 
u8
 
tid
)

1430 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

1431 
iwl_mvm_tid_d©a
 *
tid_d©a
 = &
mvm°a
->tid_d©a[
tid
];

1432 
õì80211_vif
 *
vif
 = 
mvm°a
->vif;

1433 
u16
 
n‹mÆized_s¢
;

1435 
	`lockdï_as£π_hñd
(&
mvm°a
->
lock
);

1437 i‡((
tid_d©a
->
°©e
 =
IWL_AGG_ON
 ||

1438 
tid_d©a
->
°©e
 =
IWL_EMPTYING_HW_QUEUE_DELBA
) &&

1439 
	`iwl_mvm_tid_queued
(
mvm
, 
tid_d©a
) == 0) {

1445 
	`õì80211_°a_£t_buf„ªd
(
°a
, 
tid
, 
Ál£
);

1452 
n‹mÆized_s¢
 = 
tid_d©a
->
s¢
;

1453 i‡(
mvm
->
å™s
->
å™s_cfg
->
gí2
)

1454 
n‹mÆized_s¢
 &= 0xff;

1456 i‡(
n‹mÆized_s¢
 !
tid_d©a
->
√xt_ª˛aimed
)

1459 
tid_d©a
->
°©e
) {

1460 
IWL_EMPTYING_HW_QUEUE_ADDBA
:

1461 
	`IWL_DEBUG_TX_QUEUES
(
mvm
,

1463 
tid_d©a
->
√xt_ª˛aimed
);

1464 
tid_d©a
->
°©e
 = 
IWL_AGG_STARTING
;

1465 
	`õì80211_°¨t_tx_ba_cb_úqß„
(
vif
, 
°a
->
addr
, 
tid
);

1468 
IWL_EMPTYING_HW_QUEUE_DELBA
:

1469 
	`IWL_DEBUG_TX_QUEUES
(
mvm
,

1471 
tid_d©a
->
√xt_ª˛aimed
);

1472 
tid_d©a
->
°©e
 = 
IWL_AGG_OFF
;

1473 
	`õì80211_°›_tx_ba_cb_úqß„
(
vif
, 
°a
->
addr
, 
tid
);

1479 
	}
}

1481 #ifde‡
CONFIG_IWLWIFI_DEBUG


1482 c⁄° *
	$iwl_mvm_gë_tx_Áû_ªas⁄
(
u32
 
°©us
)

1484 
	#TX_STATUS_FAIL
(
x
Ë
TX_STATUS_FAIL_
 ## x:  #x

	)

1485 
	#TX_STATUS_POSTPONE
(
x
Ë
TX_STATUS_POSTPONE_
 ## x:  #x

	)

1487 
°©us
 & 
TX_STATUS_MSK
) {

1488 
TX_STATUS_SUCCESS
:

1490 
	`TX_STATUS_POSTPONE
(
DELAY
);

1491 
	`TX_STATUS_POSTPONE
(
FEW_BYTES
);

1492 
	`TX_STATUS_POSTPONE
(
BT_PRIO
);

1493 
	`TX_STATUS_POSTPONE
(
QUIET_PERIOD
);

1494 
	`TX_STATUS_POSTPONE
(
CALC_TTAK
);

1495 
	`TX_STATUS_FAIL
(
INTERNAL_CROSSED_RETRY
);

1496 
	`TX_STATUS_FAIL
(
SHORT_LIMIT
);

1497 
	`TX_STATUS_FAIL
(
LONG_LIMIT
);

1498 
	`TX_STATUS_FAIL
(
UNDERRUN
);

1499 
	`TX_STATUS_FAIL
(
DRAIN_FLOW
);

1500 
	`TX_STATUS_FAIL
(
RFKILL_FLUSH
);

1501 
	`TX_STATUS_FAIL
(
LIFE_EXPIRE
);

1502 
	`TX_STATUS_FAIL
(
DEST_PS
);

1503 
	`TX_STATUS_FAIL
(
HOST_ABORTED
);

1504 
	`TX_STATUS_FAIL
(
BT_RETRY
);

1505 
	`TX_STATUS_FAIL
(
STA_INVALID
);

1506 
	`TX_STATUS_FAIL
(
FRAG_DROPPED
);

1507 
	`TX_STATUS_FAIL
(
TID_DISABLE
);

1508 
	`TX_STATUS_FAIL
(
FIFO_FLUSHED
);

1509 
	`TX_STATUS_FAIL
(
SMALL_CF_POLL
);

1510 
	`TX_STATUS_FAIL
(
FW_DROP
);

1511 
	`TX_STATUS_FAIL
(
STA_COLOR_MISMATCH
);

1516 #unde‡
TX_STATUS_FAIL


1517 #unde‡
TX_STATUS_POSTPONE


1518 
	}
}

1521 
	$iwl_mvm_gë_hwøã_ch™_width
(
u32
 
ch™_width
)

1523 
ch™_width
) {

1524 
RATE_MCS_CHAN_WIDTH_20
:

1526 
RATE_MCS_CHAN_WIDTH_40
:

1527  
IEEE80211_TX_RC_40_MHZ_WIDTH
;

1528 
RATE_MCS_CHAN_WIDTH_80
:

1529  
IEEE80211_TX_RC_80_MHZ_WIDTH
;

1530 
RATE_MCS_CHAN_WIDTH_160
:

1531  
IEEE80211_TX_RC_160_MHZ_WIDTH
;

1535 
	}
}

1537 
	$iwl_mvm_hwøã_to_tx_øã
(
u32
 
øã_n_Êags
,

1538 
∆80211_b™d
 
b™d
,

1539 
õì80211_tx_øã
 *
r
)

1541 
u32
 
f‹m©
 = 
øã_n_Êags
 & 
RATE_MCS_MOD_TYPE_MSK
;

1542 
u32
 
øã
 = 
f‹m©
 =
RATE_MCS_HT_MSK
 ?

1543 
	`RATE_HT_MCS_INDEX
(
øã_n_Êags
) :

1544 
øã_n_Êags
 & 
RATE_MCS_CODE_MSK
;

1546 
r
->
Êags
 |=

1547 
	`iwl_mvm_gë_hwøã_ch™_width
(
øã_n_Êags
 &

1548 
RATE_MCS_CHAN_WIDTH_MSK
);

1550 i‡(
øã_n_Êags
 & 
RATE_MCS_SGI_MSK
)

1551 
r
->
Êags
 |
IEEE80211_TX_RC_SHORT_GI
;

1552 i‡(
f‹m©
 =
RATE_MCS_HT_MSK
) {

1553 
r
->
Êags
 |
IEEE80211_TX_RC_MCS
;

1554 
r
->
idx
 = 
øã
;

1555 } i‡(
f‹m©
 =
RATE_MCS_VHT_MSK
) {

1556 
	`õì80211_øã_£t_vht
(
r
, 
øã
,

1557 
	`FIELD_GET
(
RATE_MCS_NSS_MSK
,

1558 
øã_n_Êags
) + 1);

1559 
r
->
Êags
 |
IEEE80211_TX_RC_VHT_MCS
;

1560 } i‡(
f‹m©
 =
RATE_MCS_HE_MSK
) {

1563 
r
->
idx
 = 0;

1565 
r
->
idx
 = 
	`iwl_mvm_Àgacy_hw_idx_to_mac80211_idx
(
øã_n_Êags
,

1566 
b™d
);

1568 
	}
}

1570 
	$iwl_mvm_hwøã_to_tx_øã_v1
(
u32
 
øã_n_Êags
,

1571 
∆80211_b™d
 
b™d
,

1572 
õì80211_tx_øã
 *
r
)

1574 i‡(
øã_n_Êags
 & 
RATE_HT_MCS_GF_MSK
)

1575 
r
->
Êags
 |
IEEE80211_TX_RC_GREEN_FIELD
;

1577 
r
->
Êags
 |=

1578 
	`iwl_mvm_gë_hwøã_ch™_width
(
øã_n_Êags
 &

1579 
RATE_MCS_CHAN_WIDTH_MSK_V1
);

1581 i‡(
øã_n_Êags
 & 
RATE_MCS_SGI_MSK_V1
)

1582 
r
->
Êags
 |
IEEE80211_TX_RC_SHORT_GI
;

1583 i‡(
øã_n_Êags
 & 
RATE_MCS_HT_MSK_V1
) {

1584 
r
->
Êags
 |
IEEE80211_TX_RC_MCS
;

1585 
r
->
idx
 = 
øã_n_Êags
 & 
RATE_HT_MCS_INDEX_MSK_V1
;

1586 } i‡(
øã_n_Êags
 & 
RATE_MCS_VHT_MSK_V1
) {

1587 
	`õì80211_øã_£t_vht
(

1588 
r
, 
øã_n_Êags
 & 
RATE_VHT_MCS_RATE_CODE_MSK
,

1589 
	`FIELD_GET
(
RATE_MCS_NSS_MSK
, 
øã_n_Êags
) + 1);

1590 
r
->
Êags
 |
IEEE80211_TX_RC_VHT_MCS
;

1592 
r
->
idx
 = 
	`iwl_mvm_Àgacy_øã_to_mac80211_idx
(
øã_n_Êags
,

1593 
b™d
);

1595 
	}
}

1600 
	$iwl_mvm_hwøã_to_tx_°©us
(c⁄° 
iwl_fw
 *
fw
,

1601 
u32
 
øã_n_Êags
,

1602 
õì80211_tx_öfo
 *
öfo
)

1604 
õì80211_tx_øã
 *
r
 = &
öfo
->
°©us
.
øãs
[0];

1606 i‡(
	`iwl_fw_lookup_nŸif_vî
(
fw
, 
LONG_GROUP
,

1607 
TX_CMD
, 0) <= 6)

1608 
øã_n_Êags
 = 
	`iwl_√w_øã_‰om_v1
(rate_n_flags);

1610 
öfo
->
°©us
.
™ã¬a
 =

1611 ((
øã_n_Êags
 & 
RATE_MCS_ANT_AB_MSK
Ë>> 
RATE_MCS_ANT_POS
);

1612 
	`iwl_mvm_hwøã_to_tx_øã
(
øã_n_Êags
,

1613 
öfo
->
b™d
, 
r
);

1614 
	}
}

1616 
	$iwl_mvm_tx_°©us_check_åiggî
(
iwl_mvm
 *
mvm
,

1617 
u32
 
°©us
, 
__À16
 
‰ame_c⁄åﬁ
)

1619 
iwl_fw_dbg_åiggî_év
 *
åig
;

1620 
iwl_fw_dbg_åiggî_tx_°©us
 *
°©us_åig
;

1621 
i
;

1623 i‡((
°©us
 & 
TX_STATUS_MSK
Ë!
TX_STATUS_SUCCESS
) {

1624 
iwl_fw_öi_time_poöt
 
ç
 =

1625 
IWL_FW_INI_TIME_POINT_TX_FAILED
;

1627 i‡(
	`õì80211_is_a˘i⁄
(
‰ame_c⁄åﬁ
))

1628 
ç
 = 
IWL_FW_INI_TIME_POINT_TX_WFD_ACTION_FRAME_FAILED
;

1630 
	`iwl_dbg_év_time_poöt
(&
mvm
->
fwπ
,

1631 
ç
, 
NULL
);

1635 
åig
 = 
	`iwl_fw_dbg_åiggî_⁄
(&
mvm
->
fwπ
, 
NULL
,

1636 
FW_DBG_TRIGGER_TX_STATUS
);

1637 i‡(!
åig
)

1640 
°©us_åig
 = (*)
åig
->
d©a
;

1642 
i
 = 0; i < 
	`ARRAY_SIZE
(
°©us_åig
->
°©u£s
); i++) {

1644 i‡(!
°©us_åig
->
°©u£s
[
i
].
°©us
)

1647 i‡(
°©us_åig
->
°©u£s
[
i
].
°©us
 !(°©u†& 
TX_STATUS_MSK
))

1650 
	`iwl_fw_dbg_cﬁÀ˘_åig
(&
mvm
->
fwπ
, 
åig
,

1652 
°©us
 & 
TX_STATUS_MSK
);

1655 
	}
}

1672 
ölöe
 
u32
 
	$iwl_mvm_gë_scd_s¢
(
iwl_mvm
 *
mvm
,

1673 
iwl_mvm_tx_ª•
 *
tx_ª•
)

1675 
u32
 
vÆ
 = 
	`À32_to_˝up
((
__À32
 *)
	`iwl_mvm_gë_agg_°©us
(
mvm
, 
tx_ª•
) +

1676 
tx_ª•
->
‰ame_cou¡
);

1678 i‡(
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 >
IWL_DEVICE_FAMILY_AX210
)

1679  
vÆ
 & 0xFFFF;

1680  
vÆ
 & 0xFFF;

1681 
	}
}

1683 
	$iwl_mvm_rx_tx_cmd_sögÀ
(
iwl_mvm
 *
mvm
,

1684 
iwl_rx_∑ckë
 *
pkt
)

1686 
õì80211_°a
 *
°a
;

1687 
u16
 
£quí˚
 = 
	`À16_to_˝u
(
pkt
->
hdr
.sequence);

1688 
txq_id
 = 
	`SEQ_TO_QUEUE
(
£quí˚
);

1690 
iwl_mvm_tx_ª•
 *
tx_ª•
 = (*)
pkt
->
d©a
;

1691 
°a_id
 = 
	`IWL_MVM_TX_RES_GET_RA
(
tx_ª•
->
ø_tid
);

1692 
tid
 = 
	`IWL_MVM_TX_RES_GET_TID
(
tx_ª•
->
ø_tid
);

1693 
agg_tx_°©us
 *
agg_°©us
 =

1694 
	`iwl_mvm_gë_agg_°©us
(
mvm
, 
tx_ª•
);

1695 
u32
 
°©us
 = 
	`À16_to_˝u
(
agg_°©us
->status);

1696 
u16
 
s¢
 = 
	`iwl_mvm_gë_scd_s¢
(
mvm
, 
tx_ª•
);

1697 
sk_buff_hód
 
skbs
;

1698 
u8
 
skb_‰ìd
 = 0;

1699 
u8
 
lq_cﬁ‹
;

1700 
u16
 
√xt_ª˛aimed
, 
£q_˘l
;

1701 
boﬁ
 
is_ndp
 = 
Ál£
;

1703 
	`__skb_queue_hód_öô
(&
skbs
);

1705 i‡(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
))

1706 
txq_id
 = 
	`À16_to_˝u
(
tx_ª•
->
tx_queue
);

1708 
£q_˘l
 = 
	`À16_to_˝u
(
tx_ª•
->seq_ctl);

1711 
	`iwl_å™s_ª˛aim
(
mvm
->
å™s
, 
txq_id
, 
s¢
, &
skbs
, 
Ál£
);

1713 !
	`skb_queue_em±y
(&
skbs
)) {

1714 
sk_buff
 *
skb
 = 
	`__skb_dequeue
(&
skbs
);

1715 
õì80211_tx_öfo
 *
öfo
 = 
	`IEEE80211_SKB_CB
(
skb
);

1716 
õì80211_hdr
 *
hdr
 = (*)
skb
->
d©a
;

1717 
boﬁ
 
Êushed
 = 
Ál£
;

1719 
skb_‰ìd
++;

1721 
	`iwl_å™s_‰ì_tx_cmd
(
mvm
->
å™s
, 
öfo
->
drivî_d©a
[1]);

1723 
	`mem£t
(&
öfo
->
°©us
, 0, (info->status));

1724 
öfo
->
Êags
 &~(
IEEE80211_TX_STAT_ACK
 | 
IEEE80211_TX_STAT_TX_FILTERED
);

1727 
°©us
 & 
TX_STATUS_MSK
) {

1728 
TX_STATUS_SUCCESS
:

1729 
TX_STATUS_DIRECT_DONE
:

1730 
öfo
->
Êags
 |
IEEE80211_TX_STAT_ACK
;

1732 
TX_STATUS_FAIL_FIFO_FLUSHED
:

1733 
TX_STATUS_FAIL_DRAIN_FLOW
:

1734 
Êushed
 = 
åue
;

1736 
TX_STATUS_FAIL_DEST_PS
:

1740 
	`IWL_ERR_LIMIT
(
mvm
,

1742 
°©us
, 
	`À16_to_˝u
(
hdr
->
‰ame_c⁄åﬁ
));

1743 
öfo
->
Êags
 |
IEEE80211_TX_STAT_TX_FILTERED
;

1749 i‡((
°©us
 & 
TX_STATUS_MSK
Ë!
TX_STATUS_SUCCESS
 &&

1750 
	`õì80211_is_mgmt
(
hdr
->
‰ame_c⁄åﬁ
))

1751 
	`iwl_mvm_toggÀ_tx_™t
(
mvm
, &mvm->
mgmt_œ°_™ã¬a_idx
);

1758 i‡(
skb_‰ìd
 > 1)

1759 
öfo
->
Êags
 |
IEEE80211_TX_STAT_ACK
;

1761 
	`iwl_mvm_tx_°©us_check_åiggî
(
mvm
, 
°©us
, 
hdr
->
‰ame_c⁄åﬁ
);

1763 
öfo
->
°©us
.
øãs
[0].
cou¡
 = 
tx_ª•
->
Áûuª_‰ame
 + 1;

1765 
	`iwl_mvm_hwøã_to_tx_°©us
(
mvm
->
fw
,

1766 
	`À32_to_˝u
(
tx_ª•
->
öôül_øã
),

1767 
öfo
);

1772 
öfo
->
°©us
.
°©us_drivî_d©a
[1] =

1773 (*)(
uöçå_t
)
	`À32_to_˝u
(
tx_ª•
->
öôül_øã
);

1776 i‡(
öfo
->
Êags
 & 
IEEE80211_TX_CTL_AMPDU
 &&

1777 !(
öfo
->
Êags
 & 
IEEE80211_TX_STAT_ACK
) &&

1778 !(
öfo
->
Êags
 & 
IEEE80211_TX_STAT_TX_FILTERED
Ë&& !
Êushed
)

1779 
öfo
->
Êags
 |
IEEE80211_TX_STAT_AMPDU_NO_BACK
;

1780 
öfo
->
Êags
 &~
IEEE80211_TX_CTL_AMPDU
;

1783 i‡(
	`õì80211_is_back_ªq
(
hdr
->
‰ame_c⁄åﬁ
))

1784 
£q_˘l
 = 0;

1785 i‡(
°©us
 !
TX_STATUS_SUCCESS
)

1786 
£q_˘l
 = 
	`À16_to_˝u
(
hdr
->
£q_˘æ
);

1788 i‡(
	`u∆ikñy
(!
£q_˘l
)) {

1796 i‡(
	`õì80211_is_qos_nuŒfunc
(
hdr
->
‰ame_c⁄åﬁ
))

1797 
is_ndp
 = 
åue
;

1804 
öfo
->
°©us
.
tx_time
 =

1805 
	`À16_to_˝u
(
tx_ª•
->
wúñess_medü_time
);

1806 
	`BUILD_BUG_ON
(
	`ARRAY_SIZE
(
öfo
->
°©us
.
°©us_drivî_d©a
) < 1);

1807 
lq_cﬁ‹
 = 
	`TX_RES_RATE_TABLE_COL_GET
(
tx_ª•
->
éc_öfo
);

1808 
öfo
->
°©us
.
°©us_drivî_d©a
[0] =

1809 
	`RS_DRV_DATA_PACK
(
lq_cﬁ‹
, 
tx_ª•
->
ªdu˚d_çc
);

1811 i‡(
	`likñy
(!
	`iwl_mvm_time_sync_‰ame
(
mvm
, 
skb
, 
hdr
->
addr1
)))

1812 
	`õì80211_tx_°©us_skb
(
mvm
->
hw
, 
skb
);

1829 
√xt_ª˛aimed
 = 
s¢
;

1831 
	`IWL_DEBUG_TX_REPLY
(
mvm
,

1833 
txq_id
, 
	`iwl_mvm_gë_tx_Áû_ªas⁄
(
°©us
), status);

1835 
	`IWL_DEBUG_TX_REPLY
(
mvm
,

1837 
	`À32_to_˝u
(
tx_ª•
->
öôül_øã
),

1838 
tx_ª•
->
Áûuª_‰ame
, 
	`SEQ_TO_INDEX
(
£quí˚
),

1839 
s¢
, 
√xt_ª˛aimed
, 
£q_˘l
);

1841 
	`rcu_ªad_lock
();

1843 
°a
 = 
	`rcu_dîe„ªn˚
(
mvm
->
fw_id_to_mac_id
[
°a_id
]);

1848 i‡(
	`WARN_ON_ONCE
(!
°a
))

1849 
out
;

1851 i‡(!
	`IS_ERR
(
°a
)) {

1852 
iwl_mvm_°a
 *
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

1854 
	`iwl_mvm_tx_aútime
(
mvm
, 
mvm°a
,

1855 
	`À16_to_˝u
(
tx_ª•
->
wúñess_medü_time
));

1857 i‡((
°©us
 & 
TX_STATUS_MSK
Ë!
TX_STATUS_SUCCESS
 &&

1858 
mvm°a
->
°a_°©e
 < 
IEEE80211_STA_AUTHORIZED
)

1859 
	`iwl_mvm_toggÀ_tx_™t
(
mvm
, &
mvm°a
->
tx_™t
);

1861 i‡(
°a
->
wme
 && 
tid
 !
IWL_MGMT_TID
) {

1862 
iwl_mvm_tid_d©a
 *
tid_d©a
 =

1863 &
mvm°a
->
tid_d©a
[
tid
];

1864 
boﬁ
 
£nd_eo•_ndp
 = 
Ál£
;

1866 
	`•ö_lock_bh
(&
mvm°a
->
lock
);

1868 i‡(!
is_ndp
) {

1869 
tid_d©a
->
√xt_ª˛aimed
 =Çext_reclaimed;

1870 
	`IWL_DEBUG_TX_REPLY
(
mvm
,

1872 
√xt_ª˛aimed
);

1874 
	`IWL_DEBUG_TX_REPLY
(
mvm
,

1878 
	`iwl_mvm_check_øtid_em±y
(
mvm
, 
°a
, 
tid
);

1880 i‡(
mvm°a
->
¶ìp_tx_cou¡
) {

1881 
mvm°a
->
¶ìp_tx_cou¡
--;

1882 i‡(
mvm°a
->
¶ìp_tx_cou¡
 &&

1883 !
	`iwl_mvm_tid_queued
(
mvm
, 
tid_d©a
)) {

1897 
£nd_eo•_ndp
 = 
åue
;

1901 
	`•ö_u∆ock_bh
(&
mvm°a
->
lock
);

1902 i‡(
£nd_eo•_ndp
) {

1903 
	`iwl_mvm_°a_modify_¶ìp_tx_cou¡
(
mvm
, 
°a
,

1904 
IEEE80211_FRAME_RELEASE_UAPSD
,

1905 1, 
tid
, 
Ál£
, false);

1906 
mvm°a
->
¶ìp_tx_cou¡
 = 0;

1907 
	`õì80211_£nd_eo•_nuŒfunc
(
°a
, 
tid
);

1911 i‡(
mvm°a
->
√xt_°©us_eo•
) {

1912 
mvm°a
->
√xt_°©us_eo•
 = 
Ál£
;

1913 
	`õì80211_°a_eo•
(
°a
);

1916 
out
:

1917 
	`rcu_ªad_u∆ock
();

1918 
	}
}

1920 #ifde‡
CONFIG_IWLWIFI_DEBUG


1921 
	#AGG_TX_STATE_
(
x
Ë
AGG_TX_STATE_
 ## x:  #x

	)

1922 c⁄° *
	$iwl_gë_agg_tx_°©us
(
u16
 
°©us
)

1924 
°©us
 & 
AGG_TX_STATE_STATUS_MSK
) {

1925 
	`AGG_TX_STATE_
(
TRANSMITTED
);

1926 
	`AGG_TX_STATE_
(
UNDERRUN
);

1927 
	`AGG_TX_STATE_
(
BT_PRIO
);

1928 
	`AGG_TX_STATE_
(
FEW_BYTES
);

1929 
	`AGG_TX_STATE_
(
ABORT
);

1930 
	`AGG_TX_STATE_
(
TX_ON_AIR_DROP
);

1931 
	`AGG_TX_STATE_
(
LAST_SENT_TRY_CNT
);

1932 
	`AGG_TX_STATE_
(
LAST_SENT_BT_KILL
);

1933 
	`AGG_TX_STATE_
(
SCD_QUERY
);

1934 
	`AGG_TX_STATE_
(
TEST_BAD_CRC32
);

1935 
	`AGG_TX_STATE_
(
RESPONSE
);

1936 
	`AGG_TX_STATE_
(
DUMP_TX
);

1937 
	`AGG_TX_STATE_
(
DELAY_TX
);

1941 
	}
}

1943 
	$iwl_mvm_rx_tx_cmd_agg_dbg
(
iwl_mvm
 *
mvm
,

1944 
iwl_rx_∑ckë
 *
pkt
)

1946 
iwl_mvm_tx_ª•
 *
tx_ª•
 = (*)
pkt
->
d©a
;

1947 
agg_tx_°©us
 *
‰ame_°©us
 =

1948 
	`iwl_mvm_gë_agg_°©us
(
mvm
, 
tx_ª•
);

1949 
i
;

1950 
boﬁ
 
túggî_timïoöt
 = 
Ál£
;

1952 
i
 = 0; i < 
tx_ª•
->
‰ame_cou¡
; i++) {

1953 
u16
 
f°©us
 = 
	`À16_to_˝u
(
‰ame_°©us
[
i
].
°©us
);

1955 
túggî_timïoöt
 |((
f°©us
 & 
AGG_TX_STATE_STATUS_MSK
) !=

1956 
AGG_TX_STATE_TRANSMITTED
);

1957 
	`IWL_DEBUG_TX_REPLY
(
mvm
,

1959 
	`iwl_gë_agg_tx_°©us
(
f°©us
),

1960 
f°©us
 & 
AGG_TX_STATE_STATUS_MSK
,

1961 (
f°©us
 & 
AGG_TX_STATE_TRY_CNT_MSK
) >>

1962 
AGG_TX_STATE_TRY_CNT_POS
,

1963 
	`À16_to_˝u
(
‰ame_°©us
[
i
].
£quí˚
));

1966 i‡(
túggî_timïoöt
)

1967 
	`iwl_dbg_év_time_poöt
(&
mvm
->
fwπ
,

1968 
IWL_FW_INI_TIME_POINT_TX_FAILED
, 
NULL
);

1970 
	}
}

1972 
	$iwl_mvm_rx_tx_cmd_agg_dbg
(
iwl_mvm
 *
mvm
,

1973 
iwl_rx_∑ckë
 *
pkt
)

1974 {
	}
}

1977 
	$iwl_mvm_rx_tx_cmd_agg
(
iwl_mvm
 *
mvm
,

1978 
iwl_rx_∑ckë
 *
pkt
)

1980 
iwl_mvm_tx_ª•
 *
tx_ª•
 = (*)
pkt
->
d©a
;

1981 
°a_id
 = 
	`IWL_MVM_TX_RES_GET_RA
(
tx_ª•
->
ø_tid
);

1982 
tid
 = 
	`IWL_MVM_TX_RES_GET_TID
(
tx_ª•
->
ø_tid
);

1983 
u16
 
£quí˚
 = 
	`À16_to_˝u
(
pkt
->
hdr
.sequence);

1984 
iwl_mvm_°a
 *
mvm°a
;

1985 
queue
 = 
	`SEQ_TO_QUEUE
(
£quí˚
);

1986 
õì80211_°a
 *
°a
;

1988 i‡(
	`WARN_ON_ONCE
(
queue
 < 
IWL_MVM_DQA_MIN_DATA_QUEUE
 &&

1989 (
queue
 !
IWL_MVM_DQA_BSS_CLIENT_QUEUE
)))

1992 
	`iwl_mvm_rx_tx_cmd_agg_dbg
(
mvm
, 
pkt
);

1994 
	`rcu_ªad_lock
();

1996 
mvm°a
 = 
	`iwl_mvm_°a_‰om_°aid_rcu
(
mvm
, 
°a_id
);

1998 
°a
 = 
	`rcu_dîe„ªn˚
(
mvm
->
fw_id_to_mac_id
[
°a_id
]);

1999 i‡(
	`WARN_ON_ONCE
(
	`IS_ERR_OR_NULL
(
°a
Ë|| !°a->
wme
)) {

2000 
	`rcu_ªad_u∆ock
();

2004 i‡(!
	`WARN_ON_ONCE
(!
mvm°a
)) {

2005 
mvm°a
->
tid_d©a
[
tid
].
øã_n_Êags
 =

2006 
	`À32_to_˝u
(
tx_ª•
->
öôül_øã
);

2007 
mvm°a
->
tid_d©a
[
tid
].
tx_time
 =

2008 
	`À16_to_˝u
(
tx_ª•
->
wúñess_medü_time
);

2009 
mvm°a
->
tid_d©a
[
tid
].
lq_cﬁ‹
 =

2010 
	`TX_RES_RATE_TABLE_COL_GET
(
tx_ª•
->
éc_öfo
);

2011 
	`iwl_mvm_tx_aútime
(
mvm
, 
mvm°a
,

2012 
	`À16_to_˝u
(
tx_ª•
->
wúñess_medü_time
));

2015 
	`rcu_ªad_u∆ock
();

2016 
	}
}

2018 
	$iwl_mvm_rx_tx_cmd
(
iwl_mvm
 *
mvm
, 
iwl_rx_cmd_buf„r
 *
rxb
)

2020 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

2021 
iwl_mvm_tx_ª•
 *
tx_ª•
 = (*)
pkt
->
d©a
;

2023 i‡(
tx_ª•
->
‰ame_cou¡
 == 1)

2024 
	`iwl_mvm_rx_tx_cmd_sögÀ
(
mvm
, 
pkt
);

2026 
	`iwl_mvm_rx_tx_cmd_agg
(
mvm
, 
pkt
);

2027 
	}
}

2029 
	$iwl_mvm_tx_ª˛aim
(
iwl_mvm
 *
mvm
, 
°a_id
, 
tid
,

2030 
txq
, 
ödex
,

2031 
õì80211_tx_öfo
 *
tx_öfo
, 
u32
 
øã
,

2032 
boﬁ
 
is_Êush
)

2034 
sk_buff_hód
 
ª˛aimed_skbs
;

2035 
iwl_mvm_tid_d©a
 *
tid_d©a
 = 
NULL
;

2036 
õì80211_°a
 *
°a
;

2037 
iwl_mvm_°a
 *
mvm°a
 = 
NULL
;

2038 
sk_buff
 *
skb
;

2039 
‰ìd
;

2041 i‡(
	`WARN_ONCE
(
°a_id
 >
mvm
->
fw
->
ucode_ˇ∑
.
num_°©i⁄s
 ||

2042 
tid
 > 
IWL_MAX_TID_COUNT
,

2043 "°a_id %dÅid %d", 
°a_id
, 
tid
))

2046 
	`rcu_ªad_lock
();

2048 
°a
 = 
	`rcu_dîe„ªn˚
(
mvm
->
fw_id_to_mac_id
[
°a_id
]);

2051 i‡(
	`WARN_ON_ONCE
(!
°a
)) {

2052 
	`rcu_ªad_u∆ock
();

2056 
	`__skb_queue_hód_öô
(&
ª˛aimed_skbs
);

2063 
	`iwl_å™s_ª˛aim
(
mvm
->
å™s
, 
txq
, 
ödex
, &
ª˛aimed_skbs
, 
is_Êush
);

2065 
	`skb_queue_wÆk
(&
ª˛aimed_skbs
, 
skb
) {

2066 
õì80211_tx_öfo
 *
öfo
 = 
	`IEEE80211_SKB_CB
(
skb
);

2068 
	`iwl_å™s_‰ì_tx_cmd
(
mvm
->
å™s
, 
öfo
->
drivî_d©a
[1]);

2070 
	`mem£t
(&
öfo
->
°©us
, 0, (info->status));

2075 i‡(!
is_Êush
)

2076 
öfo
->
Êags
 |
IEEE80211_TX_STAT_ACK
;

2078 
öfo
->
Êags
 &~
IEEE80211_TX_STAT_ACK
;

2089 i‡(
	`IS_ERR
(
°a
))

2090 
out
;

2092 
mvm°a
 = 
	`iwl_mvm_°a_‰om_mac80211
(
°a
);

2093 
tid_d©a
 = &
mvm°a
->tid_d©a[
tid
];

2095 i‡(
tid_d©a
->
txq_id
 !
txq
) {

2096 
	`IWL_ERR
(
mvm
,

2098 
tid_d©a
->
txq_id
, 
tid
);

2099 
	`rcu_ªad_u∆ock
();

2103 
	`•ö_lock_bh
(&
mvm°a
->
lock
);

2105 
tid_d©a
->
√xt_ª˛aimed
 = 
ödex
;

2107 
	`iwl_mvm_check_øtid_em±y
(
mvm
, 
°a
, 
tid
);

2109 
‰ìd
 = 0;

2112 
tx_öfo
->
°©us
.
°©us_drivî_d©a
[0] =

2113 
	`RS_DRV_DATA_PACK
(
tid_d©a
->
lq_cﬁ‹
,

2114 
tx_öfo
->
°©us
.
°©us_drivî_d©a
[0]);

2115 
tx_öfo
->
°©us
.
°©us_drivî_d©a
[1] = (*)(
uöçå_t
)
øã
;

2117 
	`skb_queue_wÆk
(&
ª˛aimed_skbs
, 
skb
) {

2118 
õì80211_hdr
 *
hdr
 = (*)
skb
->
d©a
;

2119 
õì80211_tx_öfo
 *
öfo
 = 
	`IEEE80211_SKB_CB
(
skb
);

2121 i‡(!
is_Êush
) {

2122 i‡(
	`õì80211_is_d©a_qos
(
hdr
->
‰ame_c⁄åﬁ
))

2123 
‰ìd
++;

2125 
	`WARN_ON_ONCE
(
tid
 !
IWL_MAX_TID_COUNT
);

2130 i‡(
‰ìd
 == 1) {

2131 
öfo
->
Êags
 |
IEEE80211_TX_STAT_AMPDU
;

2132 
	`mem˝y
(&
öfo
->
°©us
, &
tx_öfo
->status,

2133 (
tx_öfo
->
°©us
));

2134 
	`iwl_mvm_hwøã_to_tx_°©us
(
mvm
->
fw
, 
øã
, 
öfo
);

2138 
	`•ö_u∆ock_bh
(&
mvm°a
->
lock
);

2144 i‡(!
is_Êush
 && 
	`skb_queue_em±y
(&
ª˛aimed_skbs
) &&

2145 !
	`iwl_mvm_has_éc_ofÊﬂd
(
mvm
)) {

2146 
õì80211_ch™˘x_c⁄f
 *
ch™˘x_c⁄f
 = 
NULL
;

2149 i‡(
mvm°a
->
vif
)

2150 
ch™˘x_c⁄f
 =

2151 
	`rcu_dîe„ªn˚
(
mvm°a
->
vif
->
bss_c⁄f
.
ch™˘x_c⁄f
);

2153 i‡(
	`WARN_ON_ONCE
(!
ch™˘x_c⁄f
))

2154 
out
;

2156 
tx_öfo
->
b™d
 = 
ch™˘x_c⁄f
->
def
.
ch™
->band;

2157 
	`iwl_mvm_hwøã_to_tx_°©us
(
mvm
->
fw
, 
øã
, 
tx_öfo
);

2159 
	`IWL_DEBUG_TX_REPLY
(
mvm
, "NoÑeclaim. UpdateÑs directly\n");

2160 
	`iwl_mvm_rs_tx_°©us
(
mvm
, 
°a
, 
tid
, 
tx_öfo
, 
Ál£
);

2163 
out
:

2164 
	`rcu_ªad_u∆ock
();

2166 !
	`skb_queue_em±y
(&
ª˛aimed_skbs
)) {

2167 
skb
 = 
	`__skb_dequeue
(&
ª˛aimed_skbs
);

2168 
	`õì80211_tx_°©us_skb
(
mvm
->
hw
, 
skb
);

2170 
	}
}

2172 
	$iwl_mvm_rx_ba_nŸif
(
iwl_mvm
 *
mvm
, 
iwl_rx_cmd_buf„r
 *
rxb
)

2174 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

2175 
pkt_Àn
 = 
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
);

2176 
°a_id
, 
tid
, 
txq
, 
ödex
;

2177 
õì80211_tx_öfo
 
ba_öfo
 = {};

2178 
iwl_mvm_ba_nŸif
 *
ba_nŸif
;

2179 
iwl_mvm_tid_d©a
 *
tid_d©a
;

2180 
iwl_mvm_°a
 *
mvm°a
;

2182 
ba_öfo
.
Êags
 = 
IEEE80211_TX_STAT_AMPDU
;

2184 i‡(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
)) {

2185 
iwl_mvm_com¥es£d_ba_nŸif
 *
ba_ªs
 =

2186 (*)
pkt
->
d©a
;

2187 
u8
 
lq_cﬁ‹
 = 
	`TX_RES_RATE_TABLE_COL_GET
(
ba_ªs
->
éc_øã_öfo
);

2188 
u16
 
tfd_˙t
;

2189 
i
;

2191 i‡(
	`IWL_FW_CHECK
(
mvm
, (*
ba_ªs
Ë> 
pkt_Àn
,

2192 "sh‹àBAÇŸifiˇti⁄ (%d)\n", 
pkt_Àn
))

2195 
°a_id
 = 
ba_ªs
->sta_id;

2196 
ba_öfo
.
°©us
.
ampdu_ack_Àn
 = (
u8
)
	`À16_to_˝u
(
ba_ªs
->
d⁄e
);

2197 
ba_öfo
.
°©us
.
ampdu_Àn
 = (
u8
)
	`À16_to_˝u
(
ba_ªs
->
txed
);

2198 
ba_öfo
.
°©us
.
tx_time
 =

2199 (
u16
)
	`À32_to_˝u
(
ba_ªs
->
wúñess_time
);

2200 
ba_öfo
.
°©us
.
°©us_drivî_d©a
[0] =

2201 (*)(
uöçå_t
)
ba_ªs
->
ªdu˚d_txp
;

2203 
tfd_˙t
 = 
	`À16_to_˝u
(
ba_ªs
->tfd_cnt);

2204 i‡(!
tfd_˙t
)

2207 i‡(
	`IWL_FW_CHECK
(
mvm
,

2208 
	`°ru˘_size
(
ba_ªs
, 
tfd
, 
tfd_˙t
Ë> 
pkt_Àn
,

2210 
tfd_˙t
, 
pkt_Àn
))

2213 
	`IWL_DEBUG_TX_REPLY
(
mvm
,

2215 
°a_id
, 
	`À32_to_˝u
(
ba_ªs
->
Êags
),

2216 
	`À16_to_˝u
(
ba_ªs
->
txed
),

2217 
	`À16_to_˝u
(
ba_ªs
->
d⁄e
));

2219 
	`rcu_ªad_lock
();

2221 
mvm°a
 = 
	`iwl_mvm_°a_‰om_°aid_rcu
(
mvm
, 
°a_id
);

2232 
i
 = 0; i < 
tfd_˙t
; i++) {

2233 
iwl_mvm_com¥es£d_ba_tfd
 *
ba_tfd
 =

2234 &
ba_ªs
->
tfd
[
i
];

2236 
tid
 = 
ba_tfd
->tid;

2237 i‡(
tid
 =
IWL_MGMT_TID
)

2238 
tid
 = 
IWL_MAX_TID_COUNT
;

2240 i‡(
mvm°a
)

2241 
mvm°a
->
tid_d©a
[
i
].
lq_cﬁ‹
 =Üq_color;

2243 
	`iwl_mvm_tx_ª˛aim
(
mvm
, 
°a_id
, 
tid
,

2244 ()(
	`À16_to_˝u
(
ba_tfd
->
q_num
)),

2245 
	`À16_to_˝u
(
ba_tfd
->
tfd_ödex
),

2246 &
ba_öfo
,

2247 
	`À32_to_˝u
(
ba_ªs
->
tx_øã
), 
Ál£
);

2250 i‡(
mvm°a
)

2251 
	`iwl_mvm_tx_aútime
(
mvm
, 
mvm°a
,

2252 
	`À32_to_˝u
(
ba_ªs
->
wúñess_time
));

2253 
	`rcu_ªad_u∆ock
();

2257 
ba_nŸif
 = (*)
pkt
->
d©a
;

2258 
°a_id
 = 
ba_nŸif
->sta_id;

2259 
tid
 = 
ba_nŸif
->tid;

2261 
txq
 = 
	`À16_to_˝u
(
ba_nŸif
->
scd_Êow
);

2264 
ödex
 = 
	`À16_to_˝u
(
ba_nŸif
->
scd_s¢
);

2266 
	`rcu_ªad_lock
();

2267 
mvm°a
 = 
	`iwl_mvm_°a_‰om_°aid_rcu
(
mvm
, 
°a_id
);

2268 i‡(
	`IWL_FW_CHECK
(
mvm
, !
mvm°a
,

2270 
°a_id
)) {

2271 
	`rcu_ªad_u∆ock
();

2275 
tid_d©a
 = &
mvm°a
->tid_d©a[
tid
];

2277 
ba_öfo
.
°©us
.
ampdu_ack_Àn
 = 
ba_nŸif
->
txed_2_d⁄e
;

2278 
ba_öfo
.
°©us
.
ampdu_Àn
 = 
ba_nŸif
->
txed
;

2279 
ba_öfo
.
°©us
.
tx_time
 = 
tid_d©a
->tx_time;

2280 
ba_öfo
.
°©us
.
°©us_drivî_d©a
[0] =

2281 (*)(
uöçå_t
)
ba_nŸif
->
ªdu˚d_txp
;

2283 
	`rcu_ªad_u∆ock
();

2285 
	`IWL_DEBUG_TX_REPLY
(
mvm
,

2287 
ba_nŸif
->
°a_addr
, ba_nŸif->
°a_id
);

2289 
	`IWL_DEBUG_TX_REPLY
(
mvm
,

2291 
ba_nŸif
->
tid
, 
	`À16_to_˝u
(ba_nŸif->
£q_˘l
),

2292 
	`À64_to_˝u
(
ba_nŸif
->
bôm≠
), 
txq
, 
ödex
,

2293 
ba_nŸif
->
txed
, ba_nŸif->
txed_2_d⁄e
);

2295 
	`IWL_DEBUG_TX_REPLY
(
mvm
, "reducedÅxp from baÇotif %d\n",

2296 
ba_nŸif
->
ªdu˚d_txp
);

2298 
	`iwl_mvm_tx_ª˛aim
(
mvm
, 
°a_id
, 
tid
, 
txq
, 
ödex
, &
ba_öfo
,

2299 
tid_d©a
->
øã_n_Êags
, 
Ál£
);

2300 
	}
}

2310 
	$iwl_mvm_Êush_tx_∑th
(
iwl_mvm
 *
mvm
, 
u32
 
tfd_msk
)

2312 
ªt
;

2313 
iwl_tx_∑th_Êush_cmd_v1
 
Êush_cmd
 = {

2314 .
queues_˘l
 = 
	`˝u_to_À32
(
tfd_msk
),

2315 .
Êush_˘l
 = 
	`˝u_to_À16
(
DUMP_TX_FIFO_FLUSH
),

2318 
	`WARN_ON
(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
));

2319 
ªt
 = 
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
TXPATH_FLUSH
, 0,

2320 (
Êush_cmd
), &flush_cmd);

2321 i‡(
ªt
)

2322 
	`IWL_ERR
(
mvm
, "FaûedÅÿ£nd flush comm™d (%d)\n", 
ªt
);

2323  
ªt
;

2324 
	}
}

2326 
	$iwl_mvm_Êush_°a_tids
(
iwl_mvm
 *
mvm
, 
u32
 
°a_id
, 
u16
 
tids
)

2328 
ªt
;

2329 
iwl_tx_∑th_Êush_cmd_r•
 *
r•
;

2330 
iwl_tx_∑th_Êush_cmd
 
Êush_cmd
 = {

2331 .
°a_id
 = 
	`˝u_to_À32
(sta_id),

2332 .
tid_mask
 = 
	`˝u_to_À16
(
tids
),

2335 
iwl_ho°_cmd
 
cmd
 = {

2336 .
id
 = 
TXPATH_FLUSH
,

2337 .
Àn
 = { (
Êush_cmd
), },

2338 .
d©a
 = { &
Êush_cmd
, },

2341 
	`WARN_ON
(!
	`iwl_mvm_has_√w_tx_≠i
(
mvm
));

2343 i‡(
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
LONG_GROUP
, 
TXPATH_FLUSH
, 0) > 0)

2344 
cmd
.
Êags
 |
CMD_WANT_SKB
 | 
CMD_SEND_IN_RFKILL
;

2346 
	`IWL_DEBUG_TX_QUEUES
(
mvm
, "flush for sta id %dÅid mask 0x%x\n",

2347 
°a_id
, 
tids
);

2349 
ªt
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
cmd
);

2351 i‡(
ªt
) {

2352 
	`IWL_ERR
(
mvm
, "FaûedÅÿ£nd flush comm™d (%d)\n", 
ªt
);

2353  
ªt
;

2356 i‡(
cmd
.
Êags
 & 
CMD_WANT_SKB
) {

2357 
i
;

2358 
num_Êushed_queues
;

2360 i‡(
	`WARN_ON_ONCE
(
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
cmd
.
ª•_pkt
Ë!(*
r•
))) {

2361 
ªt
 = -
EIO
;

2362 
‰ì_r•
;

2365 
r•
 = (*)
cmd
.
ª•_pkt
->
d©a
;

2367 i‡(
	`WARN_ONCE
(
	`À16_to_˝u
(
r•
->
°a_id
) != sta_id,

2369 
°a_id
, 
	`À16_to_˝u
(
r•
->sta_id))) {

2370 
ªt
 = -
EIO
;

2371 
‰ì_r•
;

2374 
num_Êushed_queues
 = 
	`À16_to_˝u
(
r•
->num_flushed_queues);

2375 i‡(
	`WARN_ONCE
(
num_Êushed_queues
 > 
IWL_TX_FLUSH_QUEUE_RSP
,

2376 "num_Êushed_queue†%d", 
num_Êushed_queues
)) {

2377 
ªt
 = -
EIO
;

2378 
‰ì_r•
;

2381 
i
 = 0; i < 
num_Êushed_queues
; i++) {

2382 
õì80211_tx_öfo
 
tx_öfo
 = {};

2383 
iwl_Êush_queue_öfo
 *
queue_öfo
 = &
r•
->
queues
[
i
];

2384 
tid
 = 
	`À16_to_˝u
(
queue_öfo
->tid);

2385 
ªad_bef‹e
 = 
	`À16_to_˝u
(
queue_öfo
->
ªad_bef‹e_Êush
);

2386 
ªad_a·î
 = 
	`À16_to_˝u
(
queue_öfo
->
ªad_a·î_Êush
);

2387 
queue_num
 = 
	`À16_to_˝u
(
queue_öfo
->queue_num);

2389 i‡(
tid
 =
IWL_MGMT_TID
)

2390 
tid
 = 
IWL_MAX_TID_COUNT
;

2392 
	`IWL_DEBUG_TX_QUEUES
(
mvm
,

2394 
tid
, 
queue_num
, 
ªad_bef‹e
, 
ªad_a·î
);

2396 
	`iwl_mvm_tx_ª˛aim
(
mvm
, 
°a_id
, 
tid
, 
queue_num
, 
ªad_a·î
,

2397 &
tx_öfo
, 0, 
åue
);

2399 
‰ì_r•
:

2400 
	`iwl_‰ì_ª•
(&
cmd
);

2402  
ªt
;

2403 
	}
}

2405 
	$iwl_mvm_Êush_°a
(
iwl_mvm
 *
mvm
, 
u32
 
°a_id
, u32 
tfd_queue_mask
)

2407 i‡(
	`iwl_mvm_has_√w_tx_≠i
(
mvm
))

2408  
	`iwl_mvm_Êush_°a_tids
(
mvm
, 
°a_id
, 0xffff);

2410  
	`iwl_mvm_Êush_tx_∑th
(
mvm
, 
tfd_queue_mask
);

2411 
	}
}

	@utils.c

7 
	~<√t/mac80211.h
>

9 
	~"iwl-debug.h
"

10 
	~"iwl-io.h
"

11 
	~"iwl-¥ph.h
"

12 
	~"iwl-c§.h
"

13 
	~"mvm.h
"

14 
	~"fw/≠i/rs.h
"

15 
	~"fw/img.h
"

21 
	$iwl_mvm_£nd_cmd
(
iwl_mvm
 *
mvm
, 
iwl_ho°_cmd
 *
cmd
)

23 
ªt
;

25 #i‡
	`deföed
(
CONFIG_IWLWIFI_DEBUGFS
Ë&& deföed(
CONFIG_PM_SLEEP
)

26 i‡(
	`WARN_ON
(
mvm
->
d3_ã°_a˘ive
))

27  -
EIO
;

35 i‡(!(
cmd
->
Êags
 & 
CMD_ASYNC
))

36 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

38 
ªt
 = 
	`iwl_å™s_£nd_cmd
(
mvm
->
å™s
, 
cmd
);

45 i‡(
cmd
->
Êags
 & 
CMD_WANT_SKB
)

46  
ªt
;

52 i‡(!
ªt
 ||Ñë =-
ERFKILL
 ||Ñë =-
EHOSTDOWN
)

54  
ªt
;

55 
	}
}

57 
	$iwl_mvm_£nd_cmd_pdu
(
iwl_mvm
 *
mvm
, 
u32
 
id
,

58 
u32
 
Êags
, 
u16
 
Àn
, c⁄° *
d©a
)

60 
iwl_ho°_cmd
 
cmd
 = {

61 .
id
 = id,

62 .
Àn
 = {Üen, },

63 .
d©a
 = { data, },

64 .
Êags
 = flags,

67  
	`iwl_mvm_£nd_cmd
(
mvm
, &
cmd
);

68 
	}
}

73 
	$iwl_mvm_£nd_cmd_°©us
(
iwl_mvm
 *
mvm
, 
iwl_ho°_cmd
 *
cmd
,

74 
u32
 *
°©us
)

76 
iwl_rx_∑ckë
 *
pkt
;

77 
iwl_cmd_ª•⁄£
 *
ª•
;

78 
ªt
, 
ª•_Àn
;

80 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

82 #i‡
	`deföed
(
CONFIG_IWLWIFI_DEBUGFS
Ë&& deföed(
CONFIG_PM_SLEEP
)

83 i‡(
	`WARN_ON
(
mvm
->
d3_ã°_a˘ive
))

84  -
EIO
;

91 i‡(
	`WARN_ONCE
(
cmd
->
Êags
 & (
CMD_ASYNC
 | 
CMD_WANT_SKB
),

92 "cmd fœg†%x", 
cmd
->
Êags
))

93  -
EINVAL
;

95 
cmd
->
Êags
 |
CMD_WANT_SKB
;

97 
ªt
 = 
	`iwl_å™s_£nd_cmd
(
mvm
->
å™s
, 
cmd
);

98 i‡(
ªt
 =-
ERFKILL
) {

104 } i‡(
ªt
) {

105  
ªt
;

108 
pkt
 = 
cmd
->
ª•_pkt
;

110 
ª•_Àn
 = 
	`iwl_rx_∑ckë_∑ylﬂd_Àn
(
pkt
);

111 i‡(
	`WARN_ON_ONCE
(
ª•_Àn
 !(*
ª•
))) {

112 
ªt
 = -
EIO
;

113 
out_‰ì_ª•
;

116 
ª•
 = (*)
pkt
->
d©a
;

117 *
°©us
 = 
	`À32_to_˝u
(
ª•
->status);

118 
out_‰ì_ª•
:

119 
	`iwl_‰ì_ª•
(
cmd
);

120  
ªt
;

121 
	}
}

126 
	$iwl_mvm_£nd_cmd_pdu_°©us
(
iwl_mvm
 *
mvm
, 
u32
 
id
, 
u16
 
Àn
,

127 c⁄° *
d©a
, 
u32
 *
°©us
)

129 
iwl_ho°_cmd
 
cmd
 = {

130 .
id
 = id,

131 .
Àn
 = {Üen, },

132 .
d©a
 = { data, },

135  
	`iwl_mvm_£nd_cmd_°©us
(
mvm
, &
cmd
, 
°©us
);

136 
	}
}

138 
	$iwl_mvm_Àgacy_hw_idx_to_mac80211_idx
(
u32
 
øã_n_Êags
,

139 
∆80211_b™d
 
b™d
)

141 
f‹m©
 = 
øã_n_Êags
 & 
RATE_MCS_MOD_TYPE_MSK
;

142 
øã
 = 
øã_n_Êags
 & 
RATE_LEGACY_RATE_MSK
;

143 
boﬁ
 
is_LB
 = 
b™d
 =
NL80211_BAND_2GHZ
;

145 i‡(
f‹m©
 =
RATE_MCS_LEGACY_OFDM_MSK
)

146  
is_LB
 ? 
øã
 + 
IWL_FIRST_OFDM_RATE
 :

147 
øã
;

150  
is_LB
 ? 
øã
 : -1;

151 
	}
}

153 
	$iwl_mvm_Àgacy_øã_to_mac80211_idx
(
u32
 
øã_n_Êags
,

154 
∆80211_b™d
 
b™d
)

156 
øã
 = 
øã_n_Êags
 & 
RATE_LEGACY_RATE_MSK_V1
;

157 
idx
;

158 
b™d_off£t
 = 0;

161 i‡(
b™d
 !
NL80211_BAND_2GHZ
)

162 
b™d_off£t
 = 
IWL_FIRST_OFDM_RATE
;

163 
idx
 = 
b™d_off£t
; idx < 
IWL_RATE_COUNT_LEGACY
; idx++)

164 i‡(
	`iwl_fw_øã_idx_to_∂˝
(
idx
Ë=
øã
)

165  
idx
 - 
b™d_off£t
;

168 
	}
}

170 
u8
 
	$iwl_mvm_mac80211_idx_to_hwøã
(c⁄° 
iwl_fw
 *
fw
, 
øã_idx
)

172 i‡(
	`iwl_fw_lookup_cmd_vî
(
fw
, 
TX_CMD
, 0) > 8)

176  (
øã_idx
 >
IWL_FIRST_OFDM_RATE
 ?

177 
øã_idx
 - 
IWL_FIRST_OFDM_RATE
 :

178 
øã_idx
);

180  
	`iwl_fw_øã_idx_to_∂˝
(
øã_idx
);

181 
	}
}

183 
u8
 
	$iwl_mvm_mac80211_ac_to_ucode_ac
(
õì80211_ac_numbîs
 
ac
)

185 c⁄° 
u8
 
mac80211_ac_to_ucode_ac
[] = {

186 
AC_VO
,

187 
AC_VI
,

188 
AC_BE
,

189 
AC_BK


192  
mac80211_ac_to_ucode_ac
[
ac
];

193 
	}
}

195 
	$iwl_mvm_rx_fw_îr‹
(
iwl_mvm
 *
mvm
, 
iwl_rx_cmd_buf„r
 *
rxb
)

197 
iwl_rx_∑ckë
 *
pkt
 = 
	`rxb_addr
(
rxb
);

198 
iwl_îr‹_ª•
 *
îr_ª•
 = (*)
pkt
->
d©a
;

200 
	`IWL_ERR
(
mvm
, "FW ErrorÇotification:Åype 0x%08X cmd_id 0x%02X\n",

201 
	`À32_to_˝u
(
îr_ª•
->
îr‹_ty≥
),Éº_ª•->
cmd_id
);

202 
	`IWL_ERR
(
mvm
, "FW ErrorÇotification: seq 0x%04X service 0x%08X\n",

203 
	`À16_to_˝u
(
îr_ª•
->
bad_cmd_£q_num
),

204 
	`À32_to_˝u
(
îr_ª•
->
îr‹_£rvi˚
));

205 
	`IWL_ERR
(
mvm
, "FW ErrorÇotification:Åimestamp 0x%016llX\n",

206 
	`À64_to_˝u
(
îr_ª•
->
time°amp
));

207 
	}
}

213 
u8
 
	$fú°_™ã¬a
(
u8
 
mask
)

215 
	`BUILD_BUG_ON
(
ANT_A
 !
	`BIT
(0));

216 i‡(
	`WARN_ON_ONCE
(!
mask
))

217  
	`BIT
(0);

218  
	`BIT
(
	`ffs
(
mask
) - 1);

219 
	}
}

221 
	#MAX_ANT_NUM
 2

	)

228 
u8
 
	$iwl_mvm_√xt_™ã¬a
(
iwl_mvm
 *
mvm
, 
u8
 
vÆid
, u8 
œ°_idx
)

230 
u8
 
öd
 = 
œ°_idx
;

231 
i
;

233 
i
 = 0; i < 
MAX_ANT_NUM
; i++) {

234 
öd
 = (öd + 1Ë% 
MAX_ANT_NUM
;

235 i‡(
vÆid
 & 
	`BIT
(
öd
))

236  
öd
;

239 
	`WARN_ONCE
(1, "FaûedÅÿtoggÀ bëwì¿™ã¬a†0x%x", 
vÆid
);

240  
œ°_idx
;

241 
	}
}

255 
	$iwl_mvm_£nd_lq_cmd
(
iwl_mvm
 *
mvm
, 
iwl_lq_cmd
 *
lq
)

257 
iwl_ho°_cmd
 
cmd
 = {

258 .
id
 = 
LQ_CMD
,

259 .
Àn
 = { (
iwl_lq_cmd
), },

260 .
Êags
 = 
CMD_ASYNC
,

261 .
d©a
 = { 
lq
, },

264 i‡(
	`WARN_ON
(
lq
->
°a_id
 =
IWL_MVM_INVALID_STA
 ||

265 
	`iwl_mvm_has_éc_ofÊﬂd
(
mvm
)))

266  -
EINVAL
;

268  
	`iwl_mvm_£nd_cmd
(
mvm
, &
cmd
);

269 
	}
}

282 
	$iwl_mvm_upd©e_smps
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

283 
iwl_mvm_smps_ty≥_ªque°
 
ªq_ty≥
,

284 
õì80211_smps_mode
 
smps_ªque°
,

285 
lök_id
)

287 
iwl_mvm_vif
 *
mvmvif
;

288 
õì80211_smps_mode
 
smps_mode
 = 
IEEE80211_SMPS_AUTOMATIC
;

289 
i
;

291 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

294 i‡(
	`num_of_™t
(
	`iwl_mvm_gë_vÆid_rx_™t
(
mvm
)) == 1)

297 i‡(
vif
->
ty≥
 !
NL80211_IFTYPE_STATION
)

300 
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

302 i‡(
	`WARN_ON_ONCE
(!
mvmvif
->
lök
[
lök_id
]))

305 
mvmvif
->
lök
[
lök_id
]->
smps_ªque°s
[
ªq_ty≥
] = 
smps_ªque°
;

306 
i
 = 0; i < 
NUM_IWL_MVM_SMPS_REQ
; i++) {

307 i‡(
mvmvif
->
lök
[
lök_id
]->
smps_ªque°s
[
i
] ==

308 
IEEE80211_SMPS_STATIC
) {

309 
smps_mode
 = 
IEEE80211_SMPS_STATIC
;

312 i‡(
mvmvif
->
lök
[
lök_id
]->
smps_ªque°s
[
i
] ==

313 
IEEE80211_SMPS_DYNAMIC
)

314 
smps_mode
 = 
IEEE80211_SMPS_DYNAMIC
;

318 i‡(
mvmvif
->
e§_a˘ive
)

319 
smps_mode
 = 
IEEE80211_SMPS_OFF
;

321 
	`õì80211_ªque°_smps
(
vif
, 
lök_id
, 
smps_mode
);

322 
	}
}

324 
	$iwl_mvm_upd©e_smps_⁄_a˘ive_löks
(
iwl_mvm
 *
mvm
,

325 
õì80211_vif
 *
vif
,

326 
iwl_mvm_smps_ty≥_ªque°
 
ªq_ty≥
,

327 
õì80211_smps_mode
 
smps_ªque°
)

329 
õì80211_bss_c⁄f
 *
lök_c⁄f
;

330 
lök_id
;

332 
	`rcu_ªad_lock
();

333 
	`f‹_óch_vif_a˘ive_lök
(
vif
, 
lök_c⁄f
, 
lök_id
)

334 
	`iwl_mvm_upd©e_smps
(
mvm
, 
vif
, 
ªq_ty≥
, 
smps_ªque°
,

335 
lök_id
);

336 
	`rcu_ªad_u∆ock
();

337 
	}
}

339 
boﬁ
 
	$iwl_waô_°©s_com∂ëe
(
iwl_nŸif_waô_d©a
 *
nŸif_waô
,

340 
iwl_rx_∑ckë
 *
pkt
, *
d©a
)

342 
	`WARN_ON
(
pkt
->
hdr
.
cmd
 !
STATISTICS_NOTIFICATION
);

344  
åue
;

345 
	}
}

347 
	$iwl_mvm_ªque°_sy°em_°©i°ics
(
iwl_mvm
 *
mvm
, 
boﬁ
 
˛ór
,

348 
u8
 
cmd_vî
)

350 
iwl_sy°em_°©i°ics_cmd
 
sy°em_cmd
 = {

351 .
cfg_mask
 = 
˛ór
 ?

352 
	`˝u_to_À32
(
IWL_STATS_CFG_FLG_ON_DEMAND_NTFY_MSK
) :

353 
	`˝u_to_À32
(
IWL_STATS_CFG_FLG_RESET_MSK
 |

354 
IWL_STATS_CFG_FLG_ON_DEMAND_NTFY_MSK
),

355 .
ty≥_id_mask
 = 
	`˝u_to_À32
(
IWL_STATS_NTFY_TYPE_ID_OPER
 |

356 
IWL_STATS_NTFY_TYPE_ID_OPER_PART1
),

358 
iwl_ho°_cmd
 
cmd
 = {

359 .
id
 = 
	`WIDE_ID
(
SYSTEM_GROUP
, 
SYSTEM_STATISTICS_CMD
),

360 .
Àn
[0] = (
sy°em_cmd
),

361 .
d©a
[0] = &
sy°em_cmd
,

363 
iwl_nŸifiˇti⁄_waô
 
°©s_waô
;

364 c⁄° 
u16
 
°©s_com∂ëe
[] = {

365 
	`WIDE_ID
(
SYSTEM_GROUP
, 
SYSTEM_STATISTICS_END_NOTIF
),

367 
ªt
;

369 i‡(
cmd_vî
 != 1) {

370 
	`IWL_FW_CHECK_FAILED
(
mvm
,

372 
cmd_vî
);

373  -
EOPNOTSUPP
;

376 
	`iwl_öô_nŸifiˇti⁄_waô
(&
mvm
->
nŸif_waô
, &
°©s_waô
,

377 
°©s_com∂ëe
, 
	`ARRAY_SIZE
(stats_complete),

378 
NULL
, NULL);

380 
mvm
->
°©i°ics_˛ór
 = 
˛ór
;

381 
ªt
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
cmd
);

382 i‡(
ªt
) {

383 
	`iwl_ªmove_nŸifiˇti⁄
(&
mvm
->
nŸif_waô
, &
°©s_waô
);

384  
ªt
;

391 
ªt
 = 
	`iwl_waô_nŸifiˇti⁄
(&
mvm
->
nŸif_waô
, &
°©s_waô
, 
HZ
 / 2);

392 i‡(
ªt
)

393  
ªt
;

395 i‡(
˛ór
)

396 
	`iwl_mvm_accu_ødio_°©s
(
mvm
);

398  
ªt
;

399 
	}
}

401 
	$iwl_mvm_ªque°_°©i°ics
(
iwl_mvm
 *
mvm
, 
boﬁ
 
˛ór
)

403 
iwl_°©i°ics_cmd
 
scmd
 = {

404 .
Êags
 = 
˛ór
 ? 
	`˝u_to_À32
(
IWL_STATISTICS_FLG_CLEAR
) : 0,

407 
iwl_ho°_cmd
 
cmd
 = {

408 .
id
 = 
STATISTICS_CMD
,

409 .
Àn
[0] = (
scmd
),

410 .
d©a
[0] = &
scmd
,

412 
u8
 
cmd_vî
 = 
	`iwl_fw_lookup_cmd_vî
(
mvm
->
fw
,

413 
	`WIDE_ID
(
SYSTEM_GROUP
,

414 
SYSTEM_STATISTICS_CMD
),

415 
IWL_FW_CMD_VER_UNKNOWN
);

416 
ªt
;

418 i‡(
cmd_vî
 !
IWL_FW_CMD_VER_UNKNOWN
)

419  
	`iwl_mvm_ªque°_sy°em_°©i°ics
(
mvm
, 
˛ór
, 
cmd_vî
);

425 i‡(
	`iwl_fw_lookup_nŸif_vî
(
mvm
->
fw
, 
LEGACY_GROUP
,

426 
STATISTICS_NOTIFICATION
, 0) < 15) {

427 
cmd
.
Êags
 = 
CMD_WANT_SKB
;

429 
ªt
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
cmd
);

430 i‡(
ªt
)

431  
ªt
;

433 
	`iwl_mvm_h™dÀ_rx_°©i°ics
(
mvm
, 
cmd
.
ª•_pkt
);

434 
	`iwl_‰ì_ª•
(&
cmd
);

436 
iwl_nŸifiˇti⁄_waô
 
°©s_waô
;

437 c⁄° 
u16
 
°©s_com∂ëe
[] = {

438 
STATISTICS_NOTIFICATION
,

441 
	`iwl_öô_nŸifiˇti⁄_waô
(&
mvm
->
nŸif_waô
, &
°©s_waô
,

442 
°©s_com∂ëe
, 
	`ARRAY_SIZE
(stats_complete),

443 
iwl_waô_°©s_com∂ëe
, 
NULL
);

445 
ªt
 = 
	`iwl_mvm_£nd_cmd
(
mvm
, &
cmd
);

446 i‡(
ªt
) {

447 
	`iwl_ªmove_nŸifiˇti⁄
(&
mvm
->
nŸif_waô
, &
°©s_waô
);

448  
ªt
;

454 
ªt
 = 
	`iwl_waô_nŸifiˇti⁄
(&
mvm
->
nŸif_waô
, &
°©s_waô
, 
HZ
 / 5);

455 i‡(
ªt
)

456  
ªt
;

459 i‡(
˛ór
)

460 
	`iwl_mvm_accu_ødio_°©s
(
mvm
);

463 
	}
}

465 
	$iwl_mvm_accu_ødio_°©s
(
iwl_mvm
 *
mvm
)

467 
mvm
->
accu_ødio_°©s
.
rx_time
 +mvm->
ødio_°©s
.rx_time;

468 
mvm
->
accu_ødio_°©s
.
tx_time
 +mvm->
ødio_°©s
.tx_time;

469 
mvm
->
accu_ødio_°©s
.
⁄_time_rf
 +mvm->
ødio_°©s
.on_time_rf;

470 
mvm
->
accu_ødio_°©s
.
⁄_time_sˇn
 +mvm->
ødio_°©s
.on_time_scan;

471 
	}
}

473 
	siwl_mvm_divîsôy_ôî_d©a
 {

474 
iwl_mvm_phy_˘xt
 *
	m˘xt
;

475 
boﬁ
 
	mªsu…
;

478 
	$iwl_mvm_divîsôy_ôî
(*
_d©a
, 
u8
 *
mac
,

479 
õì80211_vif
 *
vif
)

481 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

482 
iwl_mvm_divîsôy_ôî_d©a
 *
d©a
 = 
_d©a
;

483 
i
, 
lök_id
;

485 
	`f‹_óch_mvm_vif_vÆid_lök
(
mvmvif
, 
lök_id
) {

486 
iwl_mvm_vif_lök_öfo
 *
lök_öfo
 = 
mvmvif
->
lök
[
lök_id
];

488 i‡(
lök_öfo
->
phy_˘xt
 !
d©a
->
˘xt
)

491 
i
 = 0; i < 
NUM_IWL_MVM_SMPS_REQ
; i++) {

492 i‡(
lök_öfo
->
smps_ªque°s
[
i
] =
IEEE80211_SMPS_STATIC
 ||

493 
lök_öfo
->
smps_ªque°s
[
i
] =
IEEE80211_SMPS_DYNAMIC
) {

494 
d©a
->
ªsu…
 = 
Ál£
;

499 
	}
}

501 
boﬁ
 
	$iwl_mvm_rx_divîsôy_Ælowed
(
iwl_mvm
 *
mvm
,

502 
iwl_mvm_phy_˘xt
 *
˘xt
)

504 
iwl_mvm_divîsôy_ôî_d©a
 
d©a
 = {

505 .
˘xt
 = ctxt,

506 .
ªsu…
 = 
åue
,

509 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

511 i‡(
iwlmvm_mod_∑øms
.
powî_scheme
 !
IWL_POWER_SCHEME_CAM
)

512  
Ál£
;

514 i‡(
	`num_of_™t
(
	`iwl_mvm_gë_vÆid_rx_™t
(
mvm
)) == 1)

515  
Ál£
;

517 i‡(
mvm
->
cfg
->
rx_wôh_siso_divîsôy
)

518  
Ál£
;

520 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s_©omic
(

521 
mvm
->
hw
, 
IEEE80211_IFACE_ITER_NORMAL
,

522 
iwl_mvm_divîsôy_ôî
, &
d©a
);

524  
d©a
.
ªsu…
;

525 
	}
}

527 
	$iwl_mvm_£nd_low_œãncy_cmd
(
iwl_mvm
 *
mvm
,

528 
boﬁ
 
low_œãncy
, 
u16
 
mac_id
)

530 
iwl_mac_low_œãncy_cmd
 
cmd
 = {

531 .
mac_id
 = 
	`˝u_to_À32
(mac_id)

534 i‡(!
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

535 
IWL_UCODE_TLV_CAPA_DYNAMIC_QUOTA
))

538 i‡(
low_œãncy
) {

540 
cmd
.
low_œãncy_rx
 = 1;

541 
cmd
.
low_œãncy_tx
 = 1;

544 i‡(
	`iwl_mvm_£nd_cmd_pdu
(
mvm
, 
	`WIDE_ID
(
MAC_CONF_GROUP
, 
LOW_LATENCY_CMD
),

545 0, (
cmd
), &cmd))

546 
	`IWL_ERR
(
mvm
, "FailedÅo sendÜowÜatency command\n");

547 
	}
}

549 
	$iwl_mvm_upd©e_low_œãncy
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

550 
boﬁ
 
low_œãncy
,

551 
iwl_mvm_low_œãncy_ˇu£
 
ˇu£
)

553 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

554 
ªs
;

555 
boﬁ
 
¥ev
;

557 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

559 
¥ev
 = 
	`iwl_mvm_vif_low_œãncy
(
mvmvif
);

560 
	`iwl_mvm_vif_£t_low_œãncy
(
mvmvif
, 
low_œãncy
, 
ˇu£
);

562 
low_œãncy
 = 
	`iwl_mvm_vif_low_œãncy
(
mvmvif
);

564 i‡(
low_œãncy
 =
¥ev
)

567 
	`iwl_mvm_£nd_low_œãncy_cmd
(
mvm
, 
low_œãncy
, 
mvmvif
->
id
);

569 
ªs
 = 
	`iwl_mvm_upd©e_quŸas
(
mvm
, 
Ál£
, 
NULL
);

570 i‡(
ªs
)

571  
ªs
;

573 
	`iwl_mvm_bt_c€x_vif_ch™ge
(
mvm
);

575  
	`iwl_mvm_powî_upd©e_mac
(
mvm
);

576 
	}
}

578 
	siwl_mvm_low_œãncy_ôî
 {

579 
boﬁ
 
	mªsu…
;

580 
boﬁ
 
	mªsu…_≥r_b™d
[
NUM_NL80211_BANDS
];

583 
	$iwl_mvm_Œ_ôî
(*
_d©a
, 
u8
 *
mac
, 
õì80211_vif
 *
vif
)

585 
iwl_mvm_low_œãncy_ôî
 *
ªsu…
 = 
_d©a
;

586 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

587 
∆80211_b™d
 
b™d
;

589 i‡(
	`iwl_mvm_vif_low_œãncy
(
mvmvif
)) {

590 
ªsu…
->ªsu… = 
åue
;

592 i‡(!
mvmvif
->
deÊök
.
phy_˘xt
)

595 
b™d
 = 
mvmvif
->
deÊök
.
phy_˘xt
->
ch™√l
->band;

596 
ªsu…
->
ªsu…_≥r_b™d
[
b™d
] = 
åue
;

598 
	}
}

600 
boﬁ
 
	$iwl_mvm_low_œãncy
(
iwl_mvm
 *
mvm
)

602 
iwl_mvm_low_œãncy_ôî
 
d©a
 = {};

604 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s_©omic
(

605 
mvm
->
hw
, 
IEEE80211_IFACE_ITER_NORMAL
,

606 
iwl_mvm_Œ_ôî
, &
d©a
);

608  
d©a
.
ªsu…
;

609 
	}
}

611 
boﬁ
 
	$iwl_mvm_low_œãncy_b™d
(
iwl_mvm
 *
mvm
, 
∆80211_b™d
 
b™d
)

613 
iwl_mvm_low_œãncy_ôî
 
d©a
 = {};

615 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s_©omic
(

616 
mvm
->
hw
, 
IEEE80211_IFACE_ITER_NORMAL
,

617 
iwl_mvm_Œ_ôî
, &
d©a
);

619  
d©a
.
ªsu…_≥r_b™d
[
b™d
];

620 
	}
}

622 
	siwl_bss_ôî_d©a
 {

623 
õì80211_vif
 *
	mvif
;

624 
boﬁ
 
	mîr‹
;

627 
	$iwl_mvm_bss_iÁ˚_ôî©‹
(*
_d©a
, 
u8
 *
mac
,

628 
õì80211_vif
 *
vif
)

630 
iwl_bss_ôî_d©a
 *
d©a
 = 
_d©a
;

632 i‡(
vif
->
ty≥
 !
NL80211_IFTYPE_STATION
 || vif->
p2p
)

635 i‡(
d©a
->
vif
) {

636 
d©a
->
îr‹
 = 
åue
;

640 
d©a
->
vif
 = vif;

641 
	}
}

643 
õì80211_vif
 *
	$iwl_mvm_gë_bss_vif
(
iwl_mvm
 *
mvm
)

645 
iwl_bss_ôî_d©a
 
bss_ôî_d©a
 = {};

647 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s_©omic
(

648 
mvm
->
hw
, 
IEEE80211_IFACE_ITER_NORMAL
,

649 
iwl_mvm_bss_iÁ˚_ôî©‹
, &
bss_ôî_d©a
);

651 i‡(
bss_ôî_d©a
.
îr‹
) {

652 
	`IWL_ERR
(
mvm
, "MoreÅhan one managed interfaceáctive!\n");

653  
	`ERR_PTR
(-
EINVAL
);

656  
bss_ôî_d©a
.
vif
;

657 
	}
}

659 
	siwl_bss_föd_ôî_d©a
 {

660 
õì80211_vif
 *
	mvif
;

661 
u32
 
	mmacid
;

664 
	$iwl_mvm_bss_föd_iÁ˚_ôî©‹
(*
_d©a
, 
u8
 *
mac
,

665 
õì80211_vif
 *
vif
)

667 
iwl_bss_föd_ôî_d©a
 *
d©a
 = 
_d©a
;

668 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

670 i‡(
mvmvif
->
id
 =
d©a
->
macid
)

671 
d©a
->
vif
 = vif;

672 
	}
}

674 
õì80211_vif
 *
	$iwl_mvm_gë_vif_by_macid
(
iwl_mvm
 *
mvm
, 
u32
 
macid
)

676 
iwl_bss_föd_ôî_d©a
 
d©a
 = {

677 .
macid
 = macid,

680 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

682 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s_©omic
(

683 
mvm
->
hw
, 
IEEE80211_IFACE_ITER_NORMAL
,

684 
iwl_mvm_bss_föd_iÁ˚_ôî©‹
, &
d©a
);

686  
d©a
.
vif
;

687 
	}
}

689 
	siwl_°a_ôî_d©a
 {

690 
boﬁ
 
	massoc
;

693 
	$iwl_mvm_°a_iÁ˚_ôî©‹
(*
_d©a
, 
u8
 *
mac
,

694 
õì80211_vif
 *
vif
)

696 
iwl_°a_ôî_d©a
 *
d©a
 = 
_d©a
;

698 i‡(
vif
->
ty≥
 !
NL80211_IFTYPE_STATION
)

701 i‡(
vif
->
cfg
.
assoc
)

702 
d©a
->
assoc
 = 
åue
;

703 
	}
}

705 
boﬁ
 
	$iwl_mvm_is_vif_assoc
(
iwl_mvm
 *
mvm
)

707 
iwl_°a_ôî_d©a
 
d©a
 = {

708 .
assoc
 = 
Ál£
,

711 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s_©omic
(
mvm
->
hw
,

712 
IEEE80211_IFACE_ITER_NORMAL
,

713 
iwl_mvm_°a_iÁ˚_ôî©‹
,

714 &
d©a
);

715  
d©a
.
assoc
;

716 
	}
}

718 
	$iwl_mvm_gë_wd_timeout
(
iwl_mvm
 *
mvm
,

719 
õì80211_vif
 *
vif
,

720 
boﬁ
 
tdls
, boﬁ 
cmd_q
)

722 
iwl_fw_dbg_åiggî_év
 *
åiggî
;

723 
iwl_fw_dbg_åiggî_txq_timî
 *
txq_timî
;

724 
deÁu…_timeout
 = 
cmd_q
 ?

725 
IWL_DEF_WD_TIMEOUT
 :

726 
mvm
->
å™s
->
å™s_cfg
->
ba£_∑øms
->
wd_timeout
;

728 i‡(!
	`iwl_fw_dbg_åiggî_íabÀd
(
mvm
->
fw
, 
FW_DBG_TRIGGER_TXQ_TIMERS
)) {

733 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
,

734 
IWL_UCODE_TLV_CAPA_STA_PM_NOTIF
) &&

735 
vif
 && vif->
ty≥
 =
NL80211_IFTYPE_AP
)

736  
IWL_WATCHDOG_DISABLED
;

737  
deÁu…_timeout
;

740 
åiggî
 = 
	`iwl_fw_dbg_gë_åiggî
(
mvm
->
fw
, 
FW_DBG_TRIGGER_TXQ_TIMERS
);

741 
txq_timî
 = (*)
åiggî
->
d©a
;

743 i‡(
tdls
)

744  
	`À32_to_˝u
(
txq_timî
->
tdls
);

746 i‡(
cmd_q
)

747  
	`À32_to_˝u
(
txq_timî
->
comm™d_queue
);

749 i‡(
	`WARN_ON
(!
vif
))

750  
deÁu…_timeout
;

752 
	`õì80211_vif_ty≥_p2p
(
vif
)) {

753 
NL80211_IFTYPE_ADHOC
:

754  
	`À32_to_˝u
(
txq_timî
->
ibss
);

755 
NL80211_IFTYPE_STATION
:

756  
	`À32_to_˝u
(
txq_timî
->
bss
);

757 
NL80211_IFTYPE_AP
:

758  
	`À32_to_˝u
(
txq_timî
->
so·≠
);

759 
NL80211_IFTYPE_P2P_CLIENT
:

760  
	`À32_to_˝u
(
txq_timî
->
p2p_˛õ¡
);

761 
NL80211_IFTYPE_P2P_GO
:

762  
	`À32_to_˝u
(
txq_timî
->
p2p_go
);

763 
NL80211_IFTYPE_P2P_DEVICE
:

764  
	`À32_to_˝u
(
txq_timî
->
p2p_devi˚
);

765 
NL80211_IFTYPE_MONITOR
:

766  
deÁu…_timeout
;

768 
	`WARN_ON
(1);

769  
mvm
->
å™s
->
å™s_cfg
->
ba£_∑øms
->
wd_timeout
;

771 
	}
}

773 
	$iwl_mvm_c⁄√˘i⁄_loss
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
,

774 c⁄° *
îrmsg
)

776 
iwl_fw_dbg_åiggî_év
 *
åig
;

777 
iwl_fw_dbg_åiggî_mlme
 *
åig_mlme
;

779 
åig
 = 
	`iwl_fw_dbg_åiggî_⁄
(&
mvm
->
fwπ
, 
	`õì80211_vif_to_wdev
(
vif
),

780 
FW_DBG_TRIGGER_MLME
);

781 i‡(!
åig
)

782 
out
;

784 
åig_mlme
 = (*)
åig
->
d©a
;

786 i‡(
åig_mlme
->
°›_c⁄√˘i⁄_loss
 &&

787 --
åig_mlme
->
°›_c⁄√˘i⁄_loss
)

788 
out
;

790 
	`iwl_fw_dbg_cﬁÀ˘_åig
(&
mvm
->
fwπ
, 
åig
, "%s", 
îrmsg
);

792 
out
:

793 
	`õì80211_c⁄√˘i⁄_loss
(
vif
);

794 
	}
}

796 
	$iwl_mvm_evít_‰ame_timeout_ˇŒback
(
iwl_mvm
 *
mvm
,

797 
õì80211_vif
 *
vif
,

798 c⁄° 
õì80211_°a
 *
°a
,

799 
u16
 
tid
)

801 
iwl_fw_dbg_åiggî_év
 *
åig
;

802 
iwl_fw_dbg_åiggî_ba
 *
ba_åig
;

804 
åig
 = 
	`iwl_fw_dbg_åiggî_⁄
(&
mvm
->
fwπ
, 
	`õì80211_vif_to_wdev
(
vif
),

805 
FW_DBG_TRIGGER_BA
);

806 i‡(!
åig
)

809 
ba_åig
 = (*)
åig
->
d©a
;

811 i‡(!(
	`À16_to_˝u
(
ba_åig
->
‰ame_timeout
Ë& 
	`BIT
(
tid
)))

814 
	`iwl_fw_dbg_cﬁÀ˘_åig
(&
mvm
->
fwπ
, 
åig
,

816 
°a
->
addr
, 
tid
);

817 
	}
}

819 
u8
 
	$iwl_mvm_tcm_lﬂd_≥r˚¡age
(
u32
 
aútime
, u32 
ñ≠£d
)

821 i‡(!
ñ≠£d
)

824  (100 * 
aútime
 / 
ñ≠£d
Ë/ 
USEC_PER_MSEC
;

825 
	}
}

827 
iwl_mvm_åaffic_lﬂd


828 
	$iwl_mvm_tcm_lﬂd
(
iwl_mvm
 *
mvm
, 
u32
 
aútime
, 
ñ≠£d
)

830 
u8
 
lﬂd
 = 
	`iwl_mvm_tcm_lﬂd_≥r˚¡age
(
aútime
, 
ñ≠£d
);

832 i‡(
lﬂd
 > 
IWL_MVM_TCM_LOAD_HIGH_THRESH
)

833  
IWL_MVM_TRAFFIC_HIGH
;

834 i‡(
lﬂd
 > 
IWL_MVM_TCM_LOAD_MEDIUM_THRESH
)

835  
IWL_MVM_TRAFFIC_MEDIUM
;

837  
IWL_MVM_TRAFFIC_LOW
;

838 
	}
}

840 
	$iwl_mvm_tcm_ôî
(*
_d©a
, 
u8
 *
mac
, 
õì80211_vif
 *
vif
)

842 
iwl_mvm
 *
mvm
 = 
_d©a
;

843 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

844 
boﬁ
 
low_œãncy
, 
¥ev
 = 
mvmvif
->low_œãncy & 
LOW_LATENCY_TRAFFIC
;

846 i‡(
mvmvif
->
id
 >
NUM_MAC_INDEX_DRIVER
)

849 
low_œãncy
 = 
mvm
->
tcm
.
ªsu…
.low_œãncy[
mvmvif
->
id
];

851 i‡(!
mvm
->
tcm
.
ªsu…
.
ch™ge
[
mvmvif
->
id
] &&

852 
¥ev
 =
low_œãncy
) {

853 
	`iwl_mvm_upd©e_quŸas
(
mvm
, 
Ál£
, 
NULL
);

857 i‡(
¥ev
 !
low_œãncy
) {

859 
	`iwl_mvm_upd©e_low_œãncy
(
mvm
, 
vif
, 
low_œãncy
,

860 
LOW_LATENCY_TRAFFIC
);

862 
	`iwl_mvm_upd©e_quŸas
(
mvm
, 
Ál£
, 
NULL
);

864 
	}
}

866 
	$iwl_mvm_tcm_ªsu…s
(
iwl_mvm
 *
mvm
)

868 
	`muãx_lock
(&
mvm
->
muãx
);

870 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s
(

871 
mvm
->
hw
, 
IEEE80211_IFACE_ITER_NORMAL
,

872 
iwl_mvm_tcm_ôî
, 
mvm
);

874 i‡(
	`fw_has_ˇ∑
(&
mvm
->
fw
->
ucode_ˇ∑
, 
IWL_UCODE_TLV_CAPA_UMAC_SCAN
))

875 
	`iwl_mvm_c⁄fig_sˇn
(
mvm
);

877 
	`muãx_u∆ock
(&
mvm
->
muãx
);

878 
	}
}

880 
	$iwl_mvm_tcm_u≠sd_n⁄agg_dëe˘ed_wk
(
w‹k_°ru˘
 *
wk
)

882 
iwl_mvm
 *
mvm
;

883 
iwl_mvm_vif
 *
mvmvif
;

884 
õì80211_vif
 *
vif
;

886 
mvmvif
 = 
	`c⁄èöî_of
(
wk
, 
iwl_mvm_vif
,

887 
u≠sd_n⁄agg_dëe˘ed_wk
.
w‹k
);

888 
vif
 = 
	`c⁄èöî_of
((*)
mvmvif
, 
õì80211_vif
, 
drv_¥iv
);

889 
mvm
 = 
mvmvif
->mvm;

891 i‡(
mvm
->
tcm
.
d©a
[
mvmvif
->
id
].
›íed_rx_ba_£ssi⁄s
)

895 
	`mem˝y
(
mvm
->
u≠sd_nﬂgg_bssids
[mvm->
u≠sd_nﬂgg_bssid_wrôe_idx
].
addr
,

896 
vif
->
bss_c⁄f
.
bssid
, 
ETH_ALEN
);

897 
mvm
->
u≠sd_nﬂgg_bssid_wrôe_idx
++;

898 i‡(
mvm
->
u≠sd_nﬂgg_bssid_wrôe_idx
 >
IWL_MVM_UAPSD_NOAGG_LIST_LEN
)

899 
mvm
->
u≠sd_nﬂgg_bssid_wrôe_idx
 = 0;

901 
	`iwl_mvm_c⁄√˘i⁄_loss
(
mvm
, 
vif
,

903 
	}
}

905 
	$iwl_mvm_u≠sd_agg_disc⁄√˘
(
iwl_mvm
 *
mvm
,

906 
õì80211_vif
 *
vif
)

908 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

910 i‡(
vif
->
ty≥
 !
NL80211_IFTYPE_STATION
)

913 i‡(!
vif
->
cfg
.
assoc
)

916 i‡(!
mvmvif
->
deÊök
.
queue_∑øms
[
IEEE80211_AC_VO
].
u≠sd
 &&

917 !
mvmvif
->
deÊök
.
queue_∑øms
[
IEEE80211_AC_VI
].
u≠sd
 &&

918 !
mvmvif
->
deÊök
.
queue_∑øms
[
IEEE80211_AC_BE
].
u≠sd
 &&

919 !
mvmvif
->
deÊök
.
queue_∑øms
[
IEEE80211_AC_BK
].
u≠sd
)

922 i‡(
mvm
->
tcm
.
d©a
[
mvmvif
->
id
].
u≠sd_n⁄agg_dëe˘
.
dëe˘ed
)

925 
mvm
->
tcm
.
d©a
[
mvmvif
->
id
].
u≠sd_n⁄agg_dëe˘
.
dëe˘ed
 = 
åue
;

926 
	`IWL_INFO
(
mvm
,

928 
	`scheduÀ_dñayed_w‹k
(&
mvmvif
->
u≠sd_n⁄agg_dëe˘ed_wk
,

929 15 * 
HZ
);

930 
	}
}

932 
	$iwl_mvm_check_u≠sd_agg_ex≥˘ed_çt
(
iwl_mvm
 *
mvm
,

933 
ñ≠£d
,

934 
mac
)

936 
u64
 
byãs
 = 
mvm
->
tcm
.
d©a
[
mac
].
u≠sd_n⁄agg_dëe˘
.
rx_byãs
;

937 
u64
 
çt
;

938 
øã
;

939 
õì80211_vif
 *
vif
;

941 
øã
 = 
	`ewma_øã_ªad
(&
mvm
->
tcm
.
d©a
[
mac
].
u≠sd_n⁄agg_dëe˘
.rate);

943 i‡(!
øã
 || 
mvm
->
tcm
.
d©a
[
mac
].
›íed_rx_ba_£ssi⁄s
 ||

944 
mvm
->
tcm
.
d©a
[
mac
].
u≠sd_n⁄agg_dëe˘
.
dëe˘ed
)

947 i‡(
	`iwl_mvm_has_√w_rx_≠i
(
mvm
)) {

948 
çt
 = 8 * 
byãs
;

949 
	`do_div
(
çt
, 
ñ≠£d
);

950 
øã
 *= 1000;

951 i‡(
çt
 < 22 * 
øã
 / 100)

962 
çt
 = (8 * 
byãs
);

963 
	`do_div
(
çt
, 
ñ≠£d
 * 100);

964 i‡(
çt
 < 
øã
)

968 
	`rcu_ªad_lock
();

969 
vif
 = 
	`rcu_dîe„ªn˚
(
mvm
->
vif_id_to_mac
[
mac
]);

970 i‡(
vif
)

971 
	`iwl_mvm_u≠sd_agg_disc⁄√˘
(
mvm
, 
vif
);

972 
	`rcu_ªad_u∆ock
();

973 
	}
}

975 
	$iwl_mvm_tcm_ôî©‹
(*
_d©a
, 
u8
 *
mac
,

976 
õì80211_vif
 *
vif
)

978 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

979 
u32
 *
b™d
 = 
_d©a
;

981 i‡(!
mvmvif
->
deÊök
.
phy_˘xt
)

984 
b™d
[
mvmvif
->
id
] = mvmvif->
deÊök
.
phy_˘xt
->
ch™√l
->band;

985 
	}
}

987 
	$iwl_mvm_ˇlc_tcm_°©s
(
iwl_mvm
 *
mvm
,

988 
ts
,

989 
boﬁ
 
h™dÀ_u≠sd
)

991 
ñ≠£d
 = 
	`jiffõs_to_m£cs
(
ts
 - 
mvm
->
tcm
.ts);

992 
u≠sd_ñ≠£d
 =

993 
	`jiffõs_to_m£cs
(
ts
 - 
mvm
->
tcm
.
u≠sd_n⁄agg_ts
);

994 
u32
 
tŸÆ_aútime
 = 0;

995 
u32
 
b™d_aútime
[
NUM_NL80211_BANDS
] = {0};

996 
u32
 
b™d
[
NUM_MAC_INDEX_DRIVER
] = {0};

997 
ac
, 
mac
, 
i
;

998 
boﬁ
 
low_œãncy
 = 
Ál£
;

999 
iwl_mvm_åaffic_lﬂd
 
lﬂd
, 
b™d_lﬂd
;

1000 
boﬁ
 
h™dÀ_Œ
 = 
	`time_a·î
(
ts
, 
mvm
->
tcm
.
Œ_ts
 + 
MVM_LL_PERIOD
);

1002 i‡(
h™dÀ_Œ
)

1003 
mvm
->
tcm
.
Œ_ts
 = 
ts
;

1004 i‡(
h™dÀ_u≠sd
)

1005 
mvm
->
tcm
.
u≠sd_n⁄agg_ts
 = 
ts
;

1007 
mvm
->
tcm
.
ªsu…
.
ñ≠£d
 =Élapsed;

1009 
	`õì80211_ôî©e_a˘ive_öãrÁ˚s_©omic
(
mvm
->
hw
,

1010 
IEEE80211_IFACE_ITER_NORMAL
,

1011 
iwl_mvm_tcm_ôî©‹
,

1012 &
b™d
);

1014 
mac
 = 0; ma¯< 
NUM_MAC_INDEX_DRIVER
; mac++) {

1015 
iwl_mvm_tcm_mac
 *
md©a
 = &
mvm
->
tcm
.
d©a
[
mac
];

1016 
u32
 
vo_vi_pkts
 = 0;

1017 
u32
 
aútime
 = 
md©a
->
rx
.aútimê+ md©a->
tx
.airtime;

1019 
tŸÆ_aútime
 +
aútime
;

1020 
b™d_aútime
[
b™d
[
mac
]] +
aútime
;

1022 
lﬂd
 = 
	`iwl_mvm_tcm_lﬂd
(
mvm
, 
aútime
, 
ñ≠£d
);

1023 
mvm
->
tcm
.
ªsu…
.
ch™ge
[
mac
] = 
lﬂd
 != mvm->tcm.result.load[mac];

1024 
mvm
->
tcm
.
ªsu…
.
lﬂd
[
mac
] =Üoad;

1025 
mvm
->
tcm
.
ªsu…
.
aútime
[
mac
] =áirtime;

1027 
ac
 = 
IEEE80211_AC_VO
;á¯<
IEEE80211_AC_VI
;ác++)

1028 
vo_vi_pkts
 +
md©a
->
rx
.
pkts
[
ac
] +

1029 
md©a
->
tx
.
pkts
[
ac
];

1032 i‡(
vo_vi_pkts
 > 
IWL_MVM_TCM_LOWLAT_ENABLE_THRESH
)

1033 
mvm
->
tcm
.
ªsu…
.
low_œãncy
[
mac
] = 
åue
;

1034 i‡(
h™dÀ_Œ
)

1035 
mvm
->
tcm
.
ªsu…
.
low_œãncy
[
mac
] = 
Ál£
;

1037 i‡(
h™dÀ_Œ
) {

1039 
	`mem£t
(&
md©a
->
rx
.
pkts
, 0, (mdata->rx.pkts));

1040 
	`mem£t
(&
md©a
->
tx
.
pkts
, 0, (mdata->tx.pkts));

1042 
low_œãncy
 |
mvm
->
tcm
.
ªsu…
.low_œãncy[
mac
];

1044 i‡(!
mvm
->
tcm
.
ªsu…
.
low_œãncy
[
mac
] && 
h™dÀ_u≠sd
)

1045 
	`iwl_mvm_check_u≠sd_agg_ex≥˘ed_çt
(
mvm
, 
u≠sd_ñ≠£d
,

1046 
mac
);

1048 i‡(
h™dÀ_u≠sd
)

1049 
md©a
->
u≠sd_n⁄agg_dëe˘
.
rx_byãs
 = 0;

1050 
	`mem£t
(&
md©a
->
rx
.
aútime
, 0, (mdata->rx.airtime));

1051 
	`mem£t
(&
md©a
->
tx
.
aútime
, 0, (mdata->tx.airtime));

1054 
lﬂd
 = 
	`iwl_mvm_tcm_lﬂd
(
mvm
, 
tŸÆ_aútime
, 
ñ≠£d
);

1055 
mvm
->
tcm
.
ªsu…
.
globÆ_lﬂd
 = 
lﬂd
;

1057 
i
 = 0; i < 
NUM_NL80211_BANDS
; i++) {

1058 
b™d_lﬂd
 = 
	`iwl_mvm_tcm_lﬂd
(
mvm
, 
b™d_aútime
[
i
], 
ñ≠£d
);

1059 
mvm
->
tcm
.
ªsu…
.
b™d_lﬂd
[
i
] = band_load;

1068 i‡(
lﬂd
 !
IWL_MVM_TRAFFIC_LOW
)

1069  
MVM_TCM_PERIOD
;

1075 i‡(
low_œãncy
)

1076  
MVM_LL_PERIOD
;

1089 
	}
}

1091 
	$iwl_mvm_ªˇlc_tcm
(
iwl_mvm
 *
mvm
)

1093 
ts
 = 
jiffõs
;

1094 
boﬁ
 
h™dÀ_u≠sd
 =

1095 
	`time_a·î
(
ts
, 
mvm
->
tcm
.
u≠sd_n⁄agg_ts
 +

1096 
	`m£cs_to_jiffõs
(
IWL_MVM_UAPSD_NONAGG_PERIOD
));

1098 
	`•ö_lock
(&
mvm
->
tcm
.
lock
);

1099 i‡(
mvm
->
tcm
.
∑u£d
 || !
	`time_a·î
(
ts
, mvm->tcm.t†+ 
MVM_TCM_PERIOD
)) {

1100 
	`•ö_u∆ock
(&
mvm
->
tcm
.
lock
);

1103 
	`•ö_u∆ock
(&
mvm
->
tcm
.
lock
);

1105 i‡(
h™dÀ_u≠sd
 && 
	`iwl_mvm_has_√w_rx_≠i
(
mvm
)) {

1106 
	`muãx_lock
(&
mvm
->
muãx
);

1107 i‡(
	`iwl_mvm_ªque°_°©i°ics
(
mvm
, 
åue
))

1108 
h™dÀ_u≠sd
 = 
Ál£
;

1109 
	`muãx_u∆ock
(&
mvm
->
muãx
);

1112 
	`•ö_lock
(&
mvm
->
tcm
.
lock
);

1114 i‡(!
mvm
->
tcm
.
∑u£d
 && 
	`time_a·î
(
ts
, mvm->tcm.t†+ 
MVM_TCM_PERIOD
)) {

1116 
w‹k_dñay
 = 
	`iwl_mvm_ˇlc_tcm_°©s
(
mvm
, 
ts
,

1117 
h™dÀ_u≠sd
);

1120 
	`smp_mb
();

1121 
mvm
->
tcm
.
ts
 =Ås;

1122 i‡(
w‹k_dñay
)

1123 
	`scheduÀ_dñayed_w‹k
(&
mvm
->
tcm
.
w‹k
, 
w‹k_dñay
);

1125 
	`•ö_u∆ock
(&
mvm
->
tcm
.
lock
);

1127 
	`iwl_mvm_tcm_ªsu…s
(
mvm
);

1128 
	}
}

1130 
	$iwl_mvm_tcm_w‹k
(
w‹k_°ru˘
 *
w‹k
)

1132 
dñayed_w‹k
 *dñayed_w‹k = 
	`to_dñayed_w‹k
(
w‹k
);

1133 
iwl_mvm
 *
mvm
 = 
	`c⁄èöî_of
(
dñayed_w‹k
, iwl_mvm,

1134 
tcm
.
w‹k
);

1136 
	`iwl_mvm_ªˇlc_tcm
(
mvm
);

1137 
	}
}

1139 
	$iwl_mvm_∑u£_tcm
(
iwl_mvm
 *
mvm
, 
boﬁ
 
wôh_ˇn˚l
)

1141 
	`•ö_lock_bh
(&
mvm
->
tcm
.
lock
);

1142 
mvm
->
tcm
.
∑u£d
 = 
åue
;

1143 
	`•ö_u∆ock_bh
(&
mvm
->
tcm
.
lock
);

1144 i‡(
wôh_ˇn˚l
)

1145 
	`ˇn˚l_dñayed_w‹k_sync
(&
mvm
->
tcm
.
w‹k
);

1146 
	}
}

1148 
	$iwl_mvm_ªsume_tcm
(
iwl_mvm
 *
mvm
)

1150 
mac
;

1151 
boﬁ
 
low_œãncy
 = 
Ál£
;

1153 
	`•ö_lock_bh
(&
mvm
->
tcm
.
lock
);

1154 
mvm
->
tcm
.
ts
 = 
jiffõs
;

1155 
mvm
->
tcm
.
Œ_ts
 = 
jiffõs
;

1156 
mac
 = 0; ma¯< 
NUM_MAC_INDEX_DRIVER
; mac++) {

1157 
iwl_mvm_tcm_mac
 *
md©a
 = &
mvm
->
tcm
.
d©a
[
mac
];

1159 
	`mem£t
(&
md©a
->
rx
.
pkts
, 0, (mdata->rx.pkts));

1160 
	`mem£t
(&
md©a
->
tx
.
pkts
, 0, (mdata->tx.pkts));

1161 
	`mem£t
(&
md©a
->
rx
.
aútime
, 0, (mdata->rx.airtime));

1162 
	`mem£t
(&
md©a
->
tx
.
aútime
, 0, (mdata->tx.airtime));

1164 i‡(
mvm
->
tcm
.
ªsu…
.
low_œãncy
[
mac
])

1165 
low_œãncy
 = 
åue
;

1168 
	`smp_mb
();

1169 
mvm
->
tcm
.
∑u£d
 = 
Ál£
;

1175 i‡(
mvm
->
tcm
.
ªsu…
.
globÆ_lﬂd
 > 
IWL_MVM_TRAFFIC_LOW
)

1176 
	`scheduÀ_dñayed_w‹k
(&
mvm
->
tcm
.
w‹k
, 
MVM_TCM_PERIOD
);

1177 i‡(
low_œãncy
)

1178 
	`scheduÀ_dñayed_w‹k
(&
mvm
->
tcm
.
w‹k
, 
MVM_LL_PERIOD
);

1180 
	`•ö_u∆ock_bh
(&
mvm
->
tcm
.
lock
);

1181 
	}
}

1183 
	$iwl_mvm_tcm_add_vif
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

1185 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1187 
	`INIT_DELAYED_WORK
(&
mvmvif
->
u≠sd_n⁄agg_dëe˘ed_wk
,

1188 
iwl_mvm_tcm_u≠sd_n⁄agg_dëe˘ed_wk
);

1189 
	}
}

1191 
	$iwl_mvm_tcm_rm_vif
(
iwl_mvm
 *
mvm
, 
õì80211_vif
 *
vif
)

1193 
iwl_mvm_vif
 *
mvmvif
 = 
	`iwl_mvm_vif_‰om_mac80211
(
vif
);

1195 
	`ˇn˚l_dñayed_w‹k_sync
(&
mvmvif
->
u≠sd_n⁄agg_dëe˘ed_wk
);

1196 
	}
}

1198 
u32
 
	$iwl_mvm_gë_sy°ime
(
iwl_mvm
 *
mvm
)

1200 
u32
 
ªg_addr
 = 
DEVICE_SYSTEM_TIME_REG
;

1202 i‡(
mvm
->
å™s
->
å™s_cfg
->
devi˚_Ámûy
 >
IWL_DEVICE_FAMILY_22000
 &&

1203 
mvm
->
å™s
->
cfg
->
gp2_ªg_addr
)

1204 
ªg_addr
 = 
mvm
->
å™s
->
cfg
->
gp2_ªg_addr
;

1206  
	`iwl_ªad_¥ph
(
mvm
->
å™s
, 
ªg_addr
);

1207 
	}
}

1209 
	$iwl_mvm_gë_sync_time
(
iwl_mvm
 *
mvm
, 
˛ock_ty≥
,

1210 
u32
 *
gp2
, 
u64
 *
boŸtime
, 
ktime_t
 *
ªÆtime
)

1212 
boﬁ
 
ps_dißbÀd
;

1214 
	`lockdï_as£π_hñd
(&
mvm
->
muãx
);

1217 
ps_dißbÀd
 = 
mvm
->ps_disabled;

1218 i‡(!
ps_dißbÀd
) {

1219 
mvm
->
ps_dißbÀd
 = 
åue
;

1220 
	`iwl_mvm_powî_upd©e_devi˚
(
mvm
);

1223 *
gp2
 = 
	`iwl_mvm_gë_sy°ime
(
mvm
);

1225 i‡(
˛ock_ty≥
 =
CLOCK_BOOTTIME
 && 
boŸtime
)

1226 *
boŸtime
 = 
	`ktime_gë_boŸtime_ns
();

1227 i‡(
˛ock_ty≥
 =
CLOCK_REALTIME
 && 
ªÆtime
)

1228 *
ªÆtime
 = 
	`ktime_gë_ªÆ
();

1230 i‡(!
ps_dißbÀd
) {

1231 
mvm
->
ps_dißbÀd
 =Ös_disabled;

1232 
	`iwl_mvm_powî_upd©e_devi˚
(
mvm
);

1234 
	}
}

1240 
boﬁ
 
	$iwl_mvm_have_löks_ßme_ch™√l
(
iwl_mvm_vif
 *
vif1
,

1241 
iwl_mvm_vif
 *
vif2
)

1243 
i
, 
j
;

1245 
	`f‹_óch_mvm_vif_vÆid_lök
(
vif1
, 
i
) {

1246 
	`f‹_óch_mvm_vif_vÆid_lök
(
vif2
, 
j
) {

1247 i‡(
vif1
->
lök
[
i
]->
phy_˘xt
 =
vif2
->lök[
j
]->phy_ctxt)

1248  
åue
;

1252  
Ál£
;

1253 
	}
}

1255 
boﬁ
 
	$iwl_mvm_vif_is_a˘ive
(
iwl_mvm_vif
 *
mvmvif
)

1257 
i
;

1260 
	`f‹_óch_mvm_vif_vÆid_lök
(
mvmvif
, 
i
) {

1261 i‡(
mvmvif
->
lök
[
i
]->
phy_˘xt
 &&

1262 
mvmvif
->
lök
[
i
]->
phy_˘xt
->
id
 < 
NUM_PHY_CTX
)

1263  
åue
;

1266  
Ál£
;

1267 
	}
}

	@vendor-cmd.c

5 
	~"mvm.h
"

6 
	~<löux/∆80211-vnd-öãl.h
>

7 
	~<√t/√éök.h
>

9 c⁄° 
∆a_pﬁicy


10 
	giwl_mvm_víd‹_©å_pﬁicy
[
NUM_IWL_MVM_VENDOR_ATTR
] = {

11 [
IWL_MVM_VENDOR_ATTR_ROAMING_FORBIDDEN
] = { .
ty≥
 = 
NLA_U8
 },

12 [
IWL_MVM_VENDOR_ATTR_AUTH_MODE
] = { .
ty≥
 = 
NLA_U32
 },

13 [
IWL_MVM_VENDOR_ATTR_CHANNEL_NUM
] = { .
ty≥
 = 
NLA_U8
 },

14 [
IWL_MVM_VENDOR_ATTR_SSID
] = { .
ty≥
 = 
NLA_BINARY
,

15 .
	gÀn
 = 
IEEE80211_MAX_SSID_LEN
 },

16 [
IWL_MVM_VENDOR_ATTR_BAND
] = { .
ty≥
 = 
NLA_U8
 },

17 [
IWL_MVM_VENDOR_ATTR_COLLOC_CHANNEL
] = { .
ty≥
 = 
NLA_U8
 },

18 [
IWL_MVM_VENDOR_ATTR_COLLOC_ADDR
] = { .
ty≥
 = 
NLA_BINARY
, .
	gÀn
 = 
ETH_ALEN
 },

21 
	$iwl_mvm_víd‹_gë_csme_c⁄n_öfo
(
wùhy
 *wiphy,

22 
wúñess_dev
 *
wdev
,

23 c⁄° *
d©a
, 
d©a_Àn
)

25 
õì80211_hw
 *
hw
 = 
	`wùhy_to_õì80211_hw
(
wùhy
);

26 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

27 
iwl_mvm_csme_c⁄n_öfo
 *
csme_c⁄n_öfo
;

28 
sk_buff
 *
skb
;

29 
îr
 = 0;

31 
	`muãx_lock
(&
mvm
->
muãx
);

32 
csme_c⁄n_öfo
 = 
	`iwl_mvm_gë_csme_c⁄n_öfo
(
mvm
);

34 i‡(!
csme_c⁄n_öfo
) {

35 
îr
 = -
EINVAL
;

36 
out_u∆ock
;

39 
skb
 = 
	`cfg80211_víd‹_cmd_Æloc_ª∂y_skb
(
wùhy
, 200);

40 i‡(!
skb
) {

41 
îr
 = -
ENOMEM
;

42 
out_u∆ock
;

45 i‡(
	`∆a_put_u32
(
skb
, 
IWL_MVM_VENDOR_ATTR_AUTH_MODE
,

46 
csme_c⁄n_öfo
->
c⁄n_öfo
.
auth_mode
) ||

47 
	`∆a_put
(
skb
, 
IWL_MVM_VENDOR_ATTR_SSID
,

48 
csme_c⁄n_öfo
->
c⁄n_öfo
.
ssid_Àn
,

49 
csme_c⁄n_öfo
->
c⁄n_öfo
.
ssid
) ||

50 
	`∆a_put_u32
(
skb
, 
IWL_MVM_VENDOR_ATTR_STA_CIPHER
,

51 
csme_c⁄n_öfo
->
c⁄n_öfo
.
∑úwi£_cùhî
) ||

52 
	`∆a_put_u8
(
skb
, 
IWL_MVM_VENDOR_ATTR_CHANNEL_NUM
,

53 
csme_c⁄n_öfo
->
c⁄n_öfo
.
ch™√l
) ||

54 
	`∆a_put
(
skb
, 
IWL_MVM_VENDOR_ATTR_ADDR
, 
ETH_ALEN
,

55 
csme_c⁄n_öfo
->
c⁄n_öfo
.
bssid
)) {

56 
	`k‰ì_skb
(
skb
);

57 
îr
 = -
ENOBUFS
;

60 
out_u∆ock
:

61 
	`muãx_u∆ock
(&
mvm
->
muãx
);

62 i‡(
îr
)

63  
îr
;

65  
	`cfg80211_víd‹_cmd_ª∂y
(
skb
);

66 
	}
}

68 
	$iwl_mvm_víd‹_ho°_gë_ow√rshù
(
wùhy
 *wiphy,

69 
wúñess_dev
 *
wdev
,

70 c⁄° *
d©a
, 
d©a_Àn
)

72 
õì80211_hw
 *
hw
 = 
	`wùhy_to_õì80211_hw
(
wùhy
);

73 
iwl_mvm
 *
mvm
 = 
	`IWL_MAC80211_GET_MVM
(
hw
);

74 
ªt
;

76 
	`muãx_lock
(&
mvm
->
muãx
);

77 
ªt
 = 
	`iwl_mvm_mei_gë_ow√rshù
(
mvm
);

78 
	`muãx_u∆ock
(&
mvm
->
muãx
);

80  
ªt
;

81 
	}
}

83 c⁄° 
wùhy_víd‹_comm™d
 
	giwl_mvm_víd‹_comm™ds
[] = {

85 .
öfo
 = {

86 .
víd‹_id
 = 
INTEL_OUI
,

87 .
	gsubcmd
 = 
IWL_MVM_VENDOR_CMD_GET_CSME_CONN_INFO
,

89 .
	gdoô
 = 
iwl_mvm_víd‹_gë_csme_c⁄n_öfo
,

90 .
	gÊags
 = 
WIPHY_VENDOR_CMD_NEED_WDEV
,

91 .
	gpﬁicy
 = 
iwl_mvm_víd‹_©å_pﬁicy
,

92 .
	gmax©å
 = 
MAX_IWL_MVM_VENDOR_ATTR
,

95 .
	göfo
 = {

96 .
víd‹_id
 = 
INTEL_OUI
,

97 .
	gsubcmd
 = 
IWL_MVM_VENDOR_CMD_HOST_GET_OWNERSHIP
,

99 .
	gdoô
 = 
iwl_mvm_víd‹_ho°_gë_ow√rshù
,

100 .
	gÊags
 = 
WIPHY_VENDOR_CMD_NEED_WDEV
,

101 .
	gpﬁicy
 = 
iwl_mvm_víd‹_©å_pﬁicy
,

102 .
	gmax©å
 = 
MAX_IWL_MVM_VENDOR_ATTR
,

106 
	eiwl_mvm_víd‹_evíts_idx
 {

108 
	mIWL_MVM_VENDOR_EVENT_IDX_ROAMING_FORBIDDEN
 = 4,

109 
	mNUM_IWL_MVM_VENDOR_EVENT_IDX


112 c⁄° 
∆80211_víd‹_cmd_öfo


113 
	giwl_mvm_víd‹_evíts
[
NUM_IWL_MVM_VENDOR_EVENT_IDX
] = {

114 [
IWL_MVM_VENDOR_EVENT_IDX_ROAMING_FORBIDDEN
] = {

115 .
víd‹_id
 = 
INTEL_OUI
,

116 .
	gsubcmd
 = 
IWL_MVM_VENDOR_CMD_ROAMING_FORBIDDEN_EVENT
,

120 
	$iwl_mvm_víd‹_cmds_ªgi°î
(
iwl_mvm
 *
mvm
)

122 
mvm
->
hw
->
wùhy
->
víd‹_comm™ds
 = 
iwl_mvm_víd‹_comm™ds
;

123 
mvm
->
hw
->
wùhy
->
n_víd‹_comm™ds
 = 
	`ARRAY_SIZE
(
iwl_mvm_víd‹_comm™ds
);

124 
mvm
->
hw
->
wùhy
->
víd‹_evíts
 = 
iwl_mvm_víd‹_evíts
;

125 
mvm
->
hw
->
wùhy
->
n_víd‹_evíts
 = 
	`ARRAY_SIZE
(
iwl_mvm_víd‹_evíts
);

126 
	}
}

128 
	$iwl_mvm_£nd_rﬂmög_f‹biddí_evít
(
iwl_mvm
 *
mvm
,

129 
õì80211_vif
 *
vif
,

130 
boﬁ
 
f‹biddí
)

132 
sk_buff
 *
msg
 =

133 
	`cfg80211_víd‹_evít_Æloc
(
mvm
->
hw
->
wùhy
,

134 
	`õì80211_vif_to_wdev
(
vif
),

135 200, 
IWL_MVM_VENDOR_EVENT_IDX_ROAMING_FORBIDDEN
,

136 
GFP_ATOMIC
);

137 i‡(!
msg
)

140 i‡(
	`WARN_ON
(!
vif
))

143 i‡(
	`∆a_put
(
msg
, 
IWL_MVM_VENDOR_ATTR_VIF_ADDR
,

144 
ETH_ALEN
, 
vif
->
addr
) ||

145 
	`∆a_put_u8
(
msg
, 
IWL_MVM_VENDOR_ATTR_ROAMING_FORBIDDEN
, 
f‹biddí
))

146 
∆a_put_Áûuª
;

148 
	`cfg80211_víd‹_evít
(
msg
, 
GFP_ATOMIC
);

151 
∆a_put_Áûuª
:

152 
	`k‰ì_skb
(
msg
);

153 
	}
}

	@/usr/include/linux/fs.h

2 #i‚de‡
_LINUX_FS_H


3 
	#_LINUX_FS_H


	)

13 
	~<löux/limôs.h
>

14 
	~<löux/io˘l.h
>

15 
	~<löux/ty≥s.h
>

16 
	~<löux/fs¸y±.h
>

19 
	~<löux/mou¡.h
>

32 #unde‡
NR_OPEN


33 
	#INR_OPEN_CUR
 1024

	)

34 
	#INR_OPEN_MAX
 4096

	)

36 
	#BLOCK_SIZE_BITS
 10

	)

37 
	#BLOCK_SIZE
 (1<<
BLOCK_SIZE_BITS
)

	)

39 
	#SEEK_SET
 0

	)

40 
	#SEEK_CUR
 1

	)

41 
	#SEEK_END
 2

	)

42 
	#SEEK_DATA
 3

	)

43 
	#SEEK_HOLE
 4

	)

44 
	#SEEK_MAX
 
SEEK_HOLE


	)

46 
	#RENAME_NOREPLACE
 (1 << 0Ë

	)

47 
	#RENAME_EXCHANGE
 (1 << 1Ë

	)

48 
	#RENAME_WHITEOUT
 (1 << 2Ë

	)

50 
	sfûe_˛⁄e_ønge
 {

51 
__s64
 
	m§c_fd
;

52 
__u64
 
	m§c_off£t
;

53 
__u64
 
	m§c_Àngth
;

54 
__u64
 
	mde°_off£t
;

57 
	sf°rim_ønge
 {

58 
__u64
 
	m°¨t
;

59 
__u64
 
	mÀn
;

60 
__u64
 
	mmöÀn
;

64 
	#FILE_DEDUPE_RANGE_SAME
 0

	)

65 
	#FILE_DEDUPE_RANGE_DIFFERS
 1

	)

68 
	sfûe_dedu≥_ønge_öfo
 {

69 
__s64
 
	mde°_fd
;

70 
__u64
 
	mde°_off£t
;

71 
__u64
 
	mbyãs_dedu≥d
;

78 
__s32
 
	m°©us
;

79 
__u32
 
	mª£rved
;

83 
	sfûe_dedu≥_ønge
 {

84 
__u64
 
	m§c_off£t
;

85 
__u64
 
	m§c_Àngth
;

86 
__u16
 
	mde°_cou¡
;

87 
__u16
 
	mª£rved1
;

88 
__u32
 
	mª£rved2
;

89 
fûe_dedu≥_ønge_öfo
 
	möfo
[0];

93 
	sfûes_°©_°ru˘
 {

94 
	mƒ_fûes
;

95 
	mƒ_‰ì_fûes
;

96 
	mmax_fûes
;

99 
	söodes_°©_t
 {

100 
	mƒ_öodes
;

101 
	mƒ_unu£d
;

102 
	mdummy
[5];

106 
	#NR_FILE
 8192

	)

111 
	sfsx©å
 {

112 
__u32
 
	mfsx_xÊags
;

113 
__u32
 
	mfsx_extsize
;

114 
__u32
 
	mfsx_√xã¡s
;

115 
__u32
 
	mfsx_¥ojid
;

116 
__u32
 
	mfsx_cowextsize
;

117 
	mfsx_∑d
[8];

123 
	#FS_XFLAG_REALTIME
 0x00000001

	)

124 
	#FS_XFLAG_PREALLOC
 0x00000002

	)

125 
	#FS_XFLAG_IMMUTABLE
 0x00000008

	)

126 
	#FS_XFLAG_APPEND
 0x00000010

	)

127 
	#FS_XFLAG_SYNC
 0x00000020

	)

128 
	#FS_XFLAG_NOATIME
 0x00000040

	)

129 
	#FS_XFLAG_NODUMP
 0x00000080

	)

130 
	#FS_XFLAG_RTINHERIT
 0x00000100

	)

131 
	#FS_XFLAG_PROJINHERIT
 0x00000200

	)

132 
	#FS_XFLAG_NOSYMLINKS
 0x00000400

	)

133 
	#FS_XFLAG_EXTSIZE
 0x00000800

	)

134 
	#FS_XFLAG_EXTSZINHERIT
 0x00001000

	)

135 
	#FS_XFLAG_NODEFRAG
 0x00002000

	)

136 
	#FS_XFLAG_FILESTREAM
 0x00004000

	)

137 
	#FS_XFLAG_DAX
 0x00008000

	)

138 
	#FS_XFLAG_COWEXTSIZE
 0x00010000

	)

139 
	#FS_XFLAG_HASATTR
 0x80000000

	)

144 
	#BLKROSET
 
	`_IO
(0x12,93Ë

	)

145 
	#BLKROGET
 
	`_IO
(0x12,94Ë

	)

146 
	#BLKRRPART
 
	`_IO
(0x12,95Ë

	)

147 
	#BLKGETSIZE
 
	`_IO
(0x12,96Ë

	)

148 
	#BLKFLSBUF
 
	`_IO
(0x12,97Ë

	)

149 
	#BLKRASET
 
	`_IO
(0x12,98Ë

	)

150 
	#BLKRAGET
 
	`_IO
(0x12,99Ë

	)

151 
	#BLKFRASET
 
	`_IO
(0x12,100)

	)

152 
	#BLKFRAGET
 
	`_IO
(0x12,101)

	)

153 
	#BLKSECTSET
 
	`_IO
(0x12,102)

	)

154 
	#BLKSECTGET
 
	`_IO
(0x12,103)

	)

155 
	#BLKSSZGET
 
	`_IO
(0x12,104)

	)

157 
	#BLKPG
 
	`_IO
(0x12,105)

	)

161 
	#BLKELVGET
 
	`_IOR
(0x12,106,
size_t
)

	)

162 
	#BLKELVSET
 
	`_IOW
(0x12,107,
size_t
)

	)

167 
	#BLKBSZGET
 
	`_IOR
(0x12,112,
size_t
)

	)

168 
	#BLKBSZSET
 
	`_IOW
(0x12,113,
size_t
)

	)

169 
	#BLKGETSIZE64
 
	`_IOR
(0x12,114,
size_t
Ë

	)

170 
	#BLKTRACESETUP
 
	`_IOWR
(0x12,115,
blk_u£r_åa˚_£tup
)

	)

171 
	#BLKTRACESTART
 
	`_IO
(0x12,116)

	)

172 
	#BLKTRACESTOP
 
	`_IO
(0x12,117)

	)

173 
	#BLKTRACETEARDOWN
 
	`_IO
(0x12,118)

	)

174 
	#BLKDISCARD
 
	`_IO
(0x12,119)

	)

175 
	#BLKIOMIN
 
	`_IO
(0x12,120)

	)

176 
	#BLKIOOPT
 
	`_IO
(0x12,121)

	)

177 
	#BLKALIGNOFF
 
	`_IO
(0x12,122)

	)

178 
	#BLKPBSZGET
 
	`_IO
(0x12,123)

	)

179 
	#BLKDISCARDZEROES
 
	`_IO
(0x12,124)

	)

180 
	#BLKSECDISCARD
 
	`_IO
(0x12,125)

	)

181 
	#BLKROTATIONAL
 
	`_IO
(0x12,126)

	)

182 
	#BLKZEROOUT
 
	`_IO
(0x12,127)

	)

183 
	#BLKGETDISKSEQ
 
	`_IOR
(0x12,128,
__u64
)

	)

189 
	#BMAP_IOCTL
 1

	)

190 
	#FIBMAP
 
	`_IO
(0x00,1Ë

	)

191 
	#FIGETBSZ
 
	`_IO
(0x00,2Ë

	)

192 
	#FIFREEZE
 
	`_IOWR
('X', 119, Ë

	)

193 
	#FITHAW
 
	`_IOWR
('X', 120, Ë

	)

194 
	#FITRIM
 
	`_IOWR
('X', 121, 
f°rim_ønge
Ë

	)

195 
	#FICLONE
 
	`_IOW
(0x94, 9, )

	)

196 
	#FICLONERANGE
 
	`_IOW
(0x94, 13, 
fûe_˛⁄e_ønge
)

	)

197 
	#FIDEDUPERANGE
 
	`_IOWR
(0x94, 54, 
fûe_dedu≥_ønge
)

	)

199 
	#FSLABEL_MAX
 256

	)

201 
	#FS_IOC_GETFLAGS
 
	`_IOR
('f', 1, )

	)

202 
	#FS_IOC_SETFLAGS
 
	`_IOW
('f', 2, )

	)

203 
	#FS_IOC_GETVERSION
 
	`_IOR
('v', 1, )

	)

204 
	#FS_IOC_SETVERSION
 
	`_IOW
('v', 2, )

	)

205 
	#FS_IOC_FIEMAP
 
	`_IOWR
('f', 11, 
fõm≠
)

	)

206 
	#FS_IOC32_GETFLAGS
 
	`_IOR
('f', 1, )

	)

207 
	#FS_IOC32_SETFLAGS
 
	`_IOW
('f', 2, )

	)

208 
	#FS_IOC32_GETVERSION
 
	`_IOR
('v', 1, )

	)

209 
	#FS_IOC32_SETVERSION
 
	`_IOW
('v', 2, )

	)

210 
	#FS_IOC_FSGETXATTR
 
	`_IOR
('X', 31, 
fsx©å
)

	)

211 
	#FS_IOC_FSSETXATTR
 
	`_IOW
('X', 32, 
fsx©å
)

	)

212 
	#FS_IOC_GETFSLABEL
 
	`_IOR
(0x94, 49, [
FSLABEL_MAX
])

	)

213 
	#FS_IOC_SETFSLABEL
 
	`_IOW
(0x94, 50, [
FSLABEL_MAX
])

	)

235 
	#FS_SECRM_FL
 0x00000001

	)

236 
	#FS_UNRM_FL
 0x00000002

	)

237 
	#FS_COMPR_FL
 0x00000004

	)

238 
	#FS_SYNC_FL
 0x00000008

	)

239 
	#FS_IMMUTABLE_FL
 0x00000010

	)

240 
	#FS_APPEND_FL
 0x00000020

	)

241 
	#FS_NODUMP_FL
 0x00000040

	)

242 
	#FS_NOATIME_FL
 0x00000080

	)

244 
	#FS_DIRTY_FL
 0x00000100

	)

245 
	#FS_COMPRBLK_FL
 0x00000200

	)

246 
	#FS_NOCOMP_FL
 0x00000400

	)

248 
	#FS_ENCRYPT_FL
 0x00000800

	)

249 
	#FS_BTREE_FL
 0x00001000

	)

250 
	#FS_INDEX_FL
 0x00001000

	)

251 
	#FS_IMAGIC_FL
 0x00002000

	)

252 
	#FS_JOURNAL_DATA_FL
 0x00004000

	)

253 
	#FS_NOTAIL_FL
 0x00008000

	)

254 
	#FS_DIRSYNC_FL
 0x00010000

	)

255 
	#FS_TOPDIR_FL
 0x00020000

	)

256 
	#FS_HUGE_FILE_FL
 0x00040000

	)

257 
	#FS_EXTENT_FL
 0x00080000

	)

258 
	#FS_VERITY_FL
 0x00100000

	)

259 
	#FS_EA_INODE_FL
 0x00200000

	)

260 
	#FS_EOFBLOCKS_FL
 0x00400000

	)

261 
	#FS_NOCOW_FL
 0x00800000

	)

262 
	#FS_DAX_FL
 0x02000000

	)

263 
	#FS_INLINE_DATA_FL
 0x10000000

	)

264 
	#FS_PROJINHERIT_FL
 0x20000000

	)

265 
	#FS_CASEFOLD_FL
 0x40000000

	)

266 
	#FS_RESERVED_FL
 0x80000000

	)

268 
	#FS_FL_USER_VISIBLE
 0x0003DFFF

	)

269 
	#FS_FL_USER_MODIFIABLE
 0x000380FF

	)

272 
	#SYNC_FILE_RANGE_WAIT_BEFORE
 1

	)

273 
	#SYNC_FILE_RANGE_WRITE
 2

	)

274 
	#SYNC_FILE_RANGE_WAIT_AFTER
 4

	)

275 
	#SYNC_FILE_RANGE_WRITE_AND_WAIT
 (
SYNC_FILE_RANGE_WRITE
 | \

276 
SYNC_FILE_RANGE_WAIT_BEFORE
 | \

277 
SYNC_FILE_RANGE_WAIT_AFTER
)

	)

283 
	t__bôwi£
 
	t__kî√l_rwf_t
;

286 
	#RWF_HIPRI
 ((
__kî√l_rwf_t
)0x00000001)

	)

289 
	#RWF_DSYNC
 ((
__kî√l_rwf_t
)0x00000002)

	)

292 
	#RWF_SYNC
 ((
__kî√l_rwf_t
)0x00000004)

	)

295 
	#RWF_NOWAIT
 ((
__kî√l_rwf_t
)0x00000008)

	)

298 
	#RWF_APPEND
 ((
__kî√l_rwf_t
)0x00000010)

	)

301 
	#RWF_SUPPORTED
 (
RWF_HIPRI
 | 
RWF_DSYNC
 | 
RWF_SYNC
 | 
RWF_NOWAIT
 |\

302 
RWF_APPEND
)

	)

	@/usr/include/linux/if_arp.h

24 #i‚de‡
_LINUX_IF_ARP_H


25 
	#_LINUX_IF_ARP_H


	)

27 
	~<löux/√tdevi˚.h
>

30 
	#ARPHRD_NETROM
 0

	)

31 
	#ARPHRD_ETHER
 1

	)

32 
	#ARPHRD_EETHER
 2

	)

33 
	#ARPHRD_AX25
 3

	)

34 
	#ARPHRD_PRONET
 4

	)

35 
	#ARPHRD_CHAOS
 5

	)

36 
	#ARPHRD_IEEE802
 6

	)

37 
	#ARPHRD_ARCNET
 7

	)

38 
	#ARPHRD_APPLETLK
 8

	)

39 
	#ARPHRD_DLCI
 15

	)

40 
	#ARPHRD_ATM
 19

	)

41 
	#ARPHRD_METRICOM
 23

	)

42 
	#ARPHRD_IEEE1394
 24

	)

43 
	#ARPHRD_EUI64
 27

	)

44 
	#ARPHRD_INFINIBAND
 32

	)

47 
	#ARPHRD_SLIP
 256

	)

48 
	#ARPHRD_CSLIP
 257

	)

49 
	#ARPHRD_SLIP6
 258

	)

50 
	#ARPHRD_CSLIP6
 259

	)

51 
	#ARPHRD_RSRVD
 260

	)

52 
	#ARPHRD_ADAPT
 264

	)

53 
	#ARPHRD_ROSE
 270

	)

54 
	#ARPHRD_X25
 271

	)

55 
	#ARPHRD_HWX25
 272

	)

56 
	#ARPHRD_CAN
 280

	)

57 
	#ARPHRD_MCTP
 290

	)

58 
	#ARPHRD_PPP
 512

	)

59 
	#ARPHRD_CISCO
 513

	)

60 
	#ARPHRD_HDLC
 
ARPHRD_CISCO


	)

61 
	#ARPHRD_LAPB
 516

	)

62 
	#ARPHRD_DDCMP
 517

	)

63 
	#ARPHRD_RAWHDLC
 518

	)

64 
	#ARPHRD_RAWIP
 519

	)

66 
	#ARPHRD_TUNNEL
 768

	)

67 
	#ARPHRD_TUNNEL6
 769

	)

68 
	#ARPHRD_FRAD
 770

	)

69 
	#ARPHRD_SKIP
 771

	)

70 
	#ARPHRD_LOOPBACK
 772

	)

71 
	#ARPHRD_LOCALTLK
 773

	)

72 
	#ARPHRD_FDDI
 774

	)

73 
	#ARPHRD_BIF
 775

	)

74 
	#ARPHRD_SIT
 776

	)

75 
	#ARPHRD_IPDDP
 777

	)

76 
	#ARPHRD_IPGRE
 778

	)

77 
	#ARPHRD_PIMREG
 779

	)

78 
	#ARPHRD_HIPPI
 780

	)

79 
	#ARPHRD_ASH
 781

	)

80 
	#ARPHRD_ECONET
 782

	)

81 
	#ARPHRD_IRDA
 783

	)

83 
	#ARPHRD_FCPP
 784

	)

84 
	#ARPHRD_FCAL
 785

	)

85 
	#ARPHRD_FCPL
 786

	)

86 
	#ARPHRD_FCFABRIC
 787

	)

88 
	#ARPHRD_IEEE802_TR
 800

	)

89 
	#ARPHRD_IEEE80211
 801

	)

90 
	#ARPHRD_IEEE80211_PRISM
 802

	)

91 
	#ARPHRD_IEEE80211_RADIOTAP
 803

	)

92 
	#ARPHRD_IEEE802154
 804

	)

93 
	#ARPHRD_IEEE802154_MONITOR
 805

	)

95 
	#ARPHRD_PHONET
 820

	)

96 
	#ARPHRD_PHONET_PIPE
 821

	)

97 
	#ARPHRD_CAIF
 822

	)

98 
	#ARPHRD_IP6GRE
 823

	)

99 
	#ARPHRD_NETLINK
 824

	)

100 
	#ARPHRD_6LOWPAN
 825

	)

101 
	#ARPHRD_VSOCKMON
 826

	)

103 
	#ARPHRD_VOID
 0xFFFF

	)

104 
	#ARPHRD_NONE
 0xFFFE

	)

107 
	#ARPOP_REQUEST
 1

	)

108 
	#ARPOP_REPLY
 2

	)

109 
	#ARPOP_RREQUEST
 3

	)

110 
	#ARPOP_RREPLY
 4

	)

111 
	#ARPOP_InREQUEST
 8

	)

112 
	#ARPOP_InREPLY
 9

	)

113 
	#ARPOP_NAK
 10

	)

117 
	s¨¥eq
 {

118 
sockaddr
 
	m¨p_∑
;

119 
sockaddr
 
	m¨p_ha
;

120 
	m¨p_Êags
;

121 
sockaddr
 
	m¨p_√tmask
;

122 
	m¨p_dev
[
IFNAMSIZ
];

125 
	s¨¥eq_ﬁd
 {

126 
sockaddr
 
	m¨p_∑
;

127 
sockaddr
 
	m¨p_ha
;

128 
	m¨p_Êags
;

129 
sockaddr
 
	m¨p_√tmask
;

133 
	#ATF_COM
 0x02

	)

134 
	#ATF_PERM
 0x04

	)

135 
	#ATF_PUBL
 0x08

	)

136 
	#ATF_USETRAILERS
 0x10

	)

137 
	#ATF_NETMASK
 0x20

	)

139 
	#ATF_DONTPUB
 0x40

	)

145 
	s¨phdr
 {

146 
__be16
 
	m¨_hrd
;

147 
__be16
 
	m¨_¥o
;

148 
	m¨_h 
;

149 
	m¨_∂n
;

150 
__be16
 
	m¨_›
;

156 
	m¨_sha
[
ETH_ALEN
];

157 
	m¨_sù
[4];

158 
	m¨_tha
[
ETH_ALEN
];

159 
	m¨_tù
[4];

	@/usr/include/linux/in6.h

22 #i‚de‡
_LINUX_IN6_H


23 
	#_LINUX_IN6_H


	)

25 
	~<löux/ty≥s.h
>

26 
	~<löux/libc-com∑t.h
>

32 #i‡
__UAPI_DEF_IN6_ADDR


33 
	sö6_addr
 {

35 
__u8
 
	mu6_addr8
[16];

36 #i‡
__UAPI_DEF_IN6_ADDR_ALT


37 
__be16
 
	mu6_addr16
[8];

38 
__be32
 
	mu6_addr32
[4];

40 } 
	mö6_u
;

41 
	#s6_addr
 
ö6_u
.
u6_addr8


	)

42 #i‡
__UAPI_DEF_IN6_ADDR_ALT


43 
	#s6_addr16
 
ö6_u
.
u6_addr16


	)

44 
	#s6_addr32
 
ö6_u
.
u6_addr32


	)

49 #i‡
__UAPI_DEF_SOCKADDR_IN6


50 
	ssockaddr_ö6
 {

51 
	msö6_Ámûy
;

52 
__be16
 
	msö6_p‹t
;

53 
__be32
 
	msö6_Êowöfo
;

54 
ö6_addr
 
	msö6_addr
;

55 
__u32
 
	msö6_sc›e_id
;

59 #i‡
__UAPI_DEF_IPV6_MREQ


60 
	sùv6_mªq
 {

62 
ö6_addr
 
	mùv6mr_mu…üddr
;

65 
	mùv6mr_ifödex
;

69 
	#ùv6mr_aˇddr
 
ùv6mr_mu…üddr


	)

71 
	sö6_Êowœbñ_ªq
 {

72 
ö6_addr
 
	mÊr_d°
;

73 
__be32
 
	mÊr_œbñ
;

74 
__u8
 
	mÊr_a˘i⁄
;

75 
__u8
 
	mÊr_sh¨e
;

76 
__u16
 
	mÊr_Êags
;

77 
__u16
 
	mÊr_expúes
;

78 
__u16
 
	mÊr_lögî
;

79 
__u32
 
	m__Êr_∑d
;

83 
	#IPV6_FL_A_GET
 0

	)

84 
	#IPV6_FL_A_PUT
 1

	)

85 
	#IPV6_FL_A_RENEW
 2

	)

87 
	#IPV6_FL_F_CREATE
 1

	)

88 
	#IPV6_FL_F_EXCL
 2

	)

89 
	#IPV6_FL_F_REFLECT
 4

	)

90 
	#IPV6_FL_F_REMOTE
 8

	)

92 
	#IPV6_FL_S_NONE
 0

	)

93 
	#IPV6_FL_S_EXCL
 1

	)

94 
	#IPV6_FL_S_PROCESS
 2

	)

95 
	#IPV6_FL_S_USER
 3

	)

96 
	#IPV6_FL_S_ANY
 255

	)

107 
	#IPV6_FLOWINFO_FLOWLABEL
 0x000fffff

	)

108 
	#IPV6_FLOWINFO_PRIORITY
 0x0ff00000

	)

111 
	#IPV6_PRIORITY_UNCHARACTERIZED
 0x0000

	)

112 
	#IPV6_PRIORITY_FILLER
 0x0100

	)

113 
	#IPV6_PRIORITY_UNATTENDED
 0x0200

	)

114 
	#IPV6_PRIORITY_RESERVED1
 0x0300

	)

115 
	#IPV6_PRIORITY_BULK
 0x0400

	)

116 
	#IPV6_PRIORITY_RESERVED2
 0x0500

	)

117 
	#IPV6_PRIORITY_INTERACTIVE
 0x0600

	)

118 
	#IPV6_PRIORITY_CONTROL
 0x0700

	)

119 
	#IPV6_PRIORITY_8
 0x0800

	)

120 
	#IPV6_PRIORITY_9
 0x0900

	)

121 
	#IPV6_PRIORITY_10
 0x0a00

	)

122 
	#IPV6_PRIORITY_11
 0x0b00

	)

123 
	#IPV6_PRIORITY_12
 0x0c00

	)

124 
	#IPV6_PRIORITY_13
 0x0d00

	)

125 
	#IPV6_PRIORITY_14
 0x0e00

	)

126 
	#IPV6_PRIORITY_15
 0x0f00

	)

131 #i‡
__UAPI_DEF_IPPROTO_V6


132 
	#IPPROTO_HOPOPTS
 0

	)

133 
	#IPPROTO_ROUTING
 43

	)

134 
	#IPPROTO_FRAGMENT
 44

	)

135 
	#IPPROTO_ICMPV6
 58

	)

136 
	#IPPROTO_NONE
 59

	)

137 
	#IPPROTO_DSTOPTS
 60

	)

138 
	#IPPROTO_MH
 135

	)

144 
	#IPV6_TLV_PAD1
 0

	)

145 
	#IPV6_TLV_PADN
 1

	)

146 
	#IPV6_TLV_ROUTERALERT
 5

	)

147 
	#IPV6_TLV_CALIPSO
 7

	)

148 
	#IPV6_TLV_IOAM
 49

	)

149 
	#IPV6_TLV_JUMBO
 194

	)

150 
	#IPV6_TLV_HAO
 201

	)

155 #i‡
__UAPI_DEF_IPV6_OPTIONS


156 
	#IPV6_ADDRFORM
 1

	)

157 
	#IPV6_2292PKTINFO
 2

	)

158 
	#IPV6_2292HOPOPTS
 3

	)

159 
	#IPV6_2292DSTOPTS
 4

	)

160 
	#IPV6_2292RTHDR
 5

	)

161 
	#IPV6_2292PKTOPTIONS
 6

	)

162 
	#IPV6_CHECKSUM
 7

	)

163 
	#IPV6_2292HOPLIMIT
 8

	)

164 
	#IPV6_NEXTHOP
 9

	)

165 
	#IPV6_AUTHHDR
 10

	)

166 
	#IPV6_FLOWINFO
 11

	)

168 
	#IPV6_UNICAST_HOPS
 16

	)

169 
	#IPV6_MULTICAST_IF
 17

	)

170 
	#IPV6_MULTICAST_HOPS
 18

	)

171 
	#IPV6_MULTICAST_LOOP
 19

	)

172 
	#IPV6_ADD_MEMBERSHIP
 20

	)

173 
	#IPV6_DROP_MEMBERSHIP
 21

	)

174 
	#IPV6_ROUTER_ALERT
 22

	)

175 
	#IPV6_MTU_DISCOVER
 23

	)

176 
	#IPV6_MTU
 24

	)

177 
	#IPV6_RECVERR
 25

	)

178 
	#IPV6_V6ONLY
 26

	)

179 
	#IPV6_JOIN_ANYCAST
 27

	)

180 
	#IPV6_LEAVE_ANYCAST
 28

	)

181 
	#IPV6_MULTICAST_ALL
 29

	)

182 
	#IPV6_ROUTER_ALERT_ISOLATE
 30

	)

183 
	#IPV6_RECVERR_RFC4884
 31

	)

186 
	#IPV6_PMTUDISC_DONT
 0

	)

187 
	#IPV6_PMTUDISC_WANT
 1

	)

188 
	#IPV6_PMTUDISC_DO
 2

	)

189 
	#IPV6_PMTUDISC_PROBE
 3

	)

193 
	#IPV6_PMTUDISC_INTERFACE
 4

	)

197 
	#IPV6_PMTUDISC_OMIT
 5

	)

200 
	#IPV6_FLOWLABEL_MGR
 32

	)

201 
	#IPV6_FLOWINFO_SEND
 33

	)

203 
	#IPV6_IPSEC_POLICY
 34

	)

204 
	#IPV6_XFRM_POLICY
 35

	)

205 
	#IPV6_HDRINCL
 36

	)

227 
	#IPV6_RECVPKTINFO
 49

	)

228 
	#IPV6_PKTINFO
 50

	)

229 
	#IPV6_RECVHOPLIMIT
 51

	)

230 
	#IPV6_HOPLIMIT
 52

	)

231 
	#IPV6_RECVHOPOPTS
 53

	)

232 
	#IPV6_HOPOPTS
 54

	)

233 
	#IPV6_RTHDRDSTOPTS
 55

	)

234 
	#IPV6_RECVRTHDR
 56

	)

235 
	#IPV6_RTHDR
 57

	)

236 
	#IPV6_RECVDSTOPTS
 58

	)

237 
	#IPV6_DSTOPTS
 59

	)

238 
	#IPV6_RECVPATHMTU
 60

	)

239 
	#IPV6_PATHMTU
 61

	)

240 
	#IPV6_DONTFRAG
 62

	)

242 
	#IPV6_USE_MIN_MTU
 63

	)

258 
	#IPV6_RECVTCLASS
 66

	)

259 
	#IPV6_TCLASS
 67

	)

272 
	#IPV6_AUTOFLOWLABEL
 70

	)

274 
	#IPV6_ADDR_PREFERENCES
 72

	)

276 
	#IPV6_PREFER_SRC_TMP
 0x0001

	)

277 
	#IPV6_PREFER_SRC_PUBLIC
 0x0002

	)

278 
	#IPV6_PREFER_SRC_PUBTMP_DEFAULT
 0x0100

	)

279 
	#IPV6_PREFER_SRC_COA
 0x0004

	)

280 
	#IPV6_PREFER_SRC_HOME
 0x0400

	)

281 
	#IPV6_PREFER_SRC_CGA
 0x0008

	)

282 
	#IPV6_PREFER_SRC_NONCGA
 0x0800

	)

285 
	#IPV6_MINHOPCOUNT
 73

	)

287 
	#IPV6_ORIGDSTADDR
 74

	)

288 
	#IPV6_RECVORIGDSTADDR
 
IPV6_ORIGDSTADDR


	)

289 
	#IPV6_TRANSPARENT
 75

	)

290 
	#IPV6_UNICAST_IF
 76

	)

291 
	#IPV6_RECVFRAGSIZE
 77

	)

292 
	#IPV6_FREEBIND
 78

	)

	@/usr/include/linux/ip.h

18 #i‚de‡
_LINUX_IP_H


19 
	#_LINUX_IP_H


	)

20 
	~<löux/ty≥s.h
>

21 
	~<löux/°ddef.h
>

22 
	~<asm/byã‹dî.h
>

24 
	#IPTOS_TOS_MASK
 0x1E

	)

25 
	#IPTOS_TOS
(
tos
Ë(—os)&
IPTOS_TOS_MASK
)

	)

26 
	#IPTOS_LOWDELAY
 0x10

	)

27 
	#IPTOS_THROUGHPUT
 0x08

	)

28 
	#IPTOS_RELIABILITY
 0x04

	)

29 
	#IPTOS_MINCOST
 0x02

	)

31 
	#IPTOS_PREC_MASK
 0xE0

	)

32 
	#IPTOS_PREC
(
tos
Ë(—os)&
IPTOS_PREC_MASK
)

	)

33 
	#IPTOS_PREC_NETCONTROL
 0xe0

	)

34 
	#IPTOS_PREC_INTERNETCONTROL
 0xc0

	)

35 
	#IPTOS_PREC_CRITIC_ECP
 0xa0

	)

36 
	#IPTOS_PREC_FLASHOVERRIDE
 0x80

	)

37 
	#IPTOS_PREC_FLASH
 0x60

	)

38 
	#IPTOS_PREC_IMMEDIATE
 0x40

	)

39 
	#IPTOS_PREC_PRIORITY
 0x20

	)

40 
	#IPTOS_PREC_ROUTINE
 0x00

	)

44 
	#IPOPT_COPY
 0x80

	)

45 
	#IPOPT_CLASS_MASK
 0x60

	)

46 
	#IPOPT_NUMBER_MASK
 0x1f

	)

48 
	#IPOPT_COPIED
(
o
Ë((o)&
IPOPT_COPY
)

	)

49 
	#IPOPT_CLASS
(
o
Ë((o)&
IPOPT_CLASS_MASK
)

	)

50 
	#IPOPT_NUMBER
(
o
Ë((o)&
IPOPT_NUMBER_MASK
)

	)

52 
	#IPOPT_CONTROL
 0x00

	)

53 
	#IPOPT_RESERVED1
 0x20

	)

54 
	#IPOPT_MEASUREMENT
 0x40

	)

55 
	#IPOPT_RESERVED2
 0x60

	)

57 
	#IPOPT_END
 (0 |
IPOPT_CONTROL
)

	)

58 
	#IPOPT_NOOP
 (1 |
IPOPT_CONTROL
)

	)

59 
	#IPOPT_SEC
 (2 |
IPOPT_CONTROL
|
IPOPT_COPY
)

	)

60 
	#IPOPT_LSRR
 (3 |
IPOPT_CONTROL
|
IPOPT_COPY
)

	)

61 
	#IPOPT_TIMESTAMP
 (4 |
IPOPT_MEASUREMENT
)

	)

62 
	#IPOPT_CIPSO
 (6 |
IPOPT_CONTROL
|
IPOPT_COPY
)

	)

63 
	#IPOPT_RR
 (7 |
IPOPT_CONTROL
)

	)

64 
	#IPOPT_SID
 (8 |
IPOPT_CONTROL
|
IPOPT_COPY
)

	)

65 
	#IPOPT_SSRR
 (9 |
IPOPT_CONTROL
|
IPOPT_COPY
)

	)

66 
	#IPOPT_RA
 (20|
IPOPT_CONTROL
|
IPOPT_COPY
)

	)

68 
	#IPVERSION
 4

	)

69 
	#MAXTTL
 255

	)

70 
	#IPDEFTTL
 64

	)

72 
	#IPOPT_OPTVAL
 0

	)

73 
	#IPOPT_OLEN
 1

	)

74 
	#IPOPT_OFFSET
 2

	)

75 
	#IPOPT_MINOFF
 4

	)

76 
	#MAX_IPOPTLEN
 40

	)

77 
	#IPOPT_NOP
 
IPOPT_NOOP


	)

78 
	#IPOPT_EOL
 
IPOPT_END


	)

79 
	#IPOPT_TS
 
IPOPT_TIMESTAMP


	)

81 
	#IPOPT_TS_TSONLY
 0

	)

82 
	#IPOPT_TS_TSANDADDR
 1

	)

83 
	#IPOPT_TS_PRESPEC
 3

	)

85 
	#IPV4_BEET_PHMAXLEN
 8

	)

87 
	sùhdr
 {

88 #i‡
deföed
(
__LITTLE_ENDIAN_BITFIELD
)

89 
__u8
 
	mihl
:4,

90 
	mvîsi⁄
:4;

91 #ñi‡
deföed
 (
__BIG_ENDIAN_BITFIELD
)

92 
__u8
 
	mvîsi⁄
:4,

93 
	mihl
:4;

97 
__u8
 
	mtos
;

98 
__be16
 
	mtŸ_Àn
;

99 
__be16
 
	mid
;

100 
__be16
 
	m‰ag_off
;

101 
__u8
 
	mâl
;

102 
__u8
 
	m¥Ÿocﬁ
;

103 
__sum16
 
	mcheck
;

104 
__°ru˘_group
–, 
addrs
, ,

105 
__be32
 
ßddr
;

106 
__be32
 
daddr
;

112 
	sù_auth_hdr
 {

113 
__u8
 
	m√xthdr
;

114 
__u8
 
	mhdæí
;

115 
__be16
 
	mª£rved
;

116 
__be32
 
	m•i
;

117 
__be32
 
	m£q_no
;

118 
__u8
 
	mauth_d©a
[0];

121 
	sù_e•_hdr
 {

122 
__be32
 
	m•i
;

123 
__be32
 
	m£q_no
;

124 
__u8
 
	míc_d©a
[0];

127 
	sù_comp_hdr
 {

128 
__u8
 
	m√xthdr
;

129 
__u8
 
	mÊags
;

130 
__be16
 
	m˝i
;

133 
	sù_bìt_phdr
 {

134 
__u8
 
	m√xthdr
;

135 
__u8
 
	mhdæí
;

136 
__u8
 
	m∑dÀn
;

137 
__u8
 
	mª£rved
;

143 
	mIPV4_DEVCONF_FORWARDING
=1,

144 
	mIPV4_DEVCONF_MC_FORWARDING
,

145 
	mIPV4_DEVCONF_PROXY_ARP
,

146 
	mIPV4_DEVCONF_ACCEPT_REDIRECTS
,

147 
	mIPV4_DEVCONF_SECURE_REDIRECTS
,

148 
	mIPV4_DEVCONF_SEND_REDIRECTS
,

149 
	mIPV4_DEVCONF_SHARED_MEDIA
,

150 
	mIPV4_DEVCONF_RP_FILTER
,

151 
	mIPV4_DEVCONF_ACCEPT_SOURCE_ROUTE
,

152 
	mIPV4_DEVCONF_BOOTP_RELAY
,

153 
	mIPV4_DEVCONF_LOG_MARTIANS
,

154 
	mIPV4_DEVCONF_TAG
,

155 
	mIPV4_DEVCONF_ARPFILTER
,

156 
	mIPV4_DEVCONF_MEDIUM_ID
,

157 
	mIPV4_DEVCONF_NOXFRM
,

158 
	mIPV4_DEVCONF_NOPOLICY
,

159 
	mIPV4_DEVCONF_FORCE_IGMP_VERSION
,

160 
	mIPV4_DEVCONF_ARP_ANNOUNCE
,

161 
	mIPV4_DEVCONF_ARP_IGNORE
,

162 
	mIPV4_DEVCONF_PROMOTE_SECONDARIES
,

163 
	mIPV4_DEVCONF_ARP_ACCEPT
,

164 
	mIPV4_DEVCONF_ARP_NOTIFY
,

165 
	mIPV4_DEVCONF_ACCEPT_LOCAL
,

166 
	mIPV4_DEVCONF_SRC_VMARK
,

167 
	mIPV4_DEVCONF_PROXY_ARP_PVLAN
,

168 
	mIPV4_DEVCONF_ROUTE_LOCALNET
,

169 
	mIPV4_DEVCONF_IGMPV2_UNSOLICITED_REPORT_INTERVAL
,

170 
	mIPV4_DEVCONF_IGMPV3_UNSOLICITED_REPORT_INTERVAL
,

171 
	mIPV4_DEVCONF_IGNORE_ROUTES_WITH_LINKDOWN
,

172 
	mIPV4_DEVCONF_DROP_UNICAST_IN_L2_MULTICAST
,

173 
	mIPV4_DEVCONF_DROP_GRATUITOUS_ARP
,

174 
	mIPV4_DEVCONF_BC_FORWARDING
,

175 
	m__IPV4_DEVCONF_MAX


178 
	#IPV4_DEVCONF_MAX
 (
__IPV4_DEVCONF_MAX
 - 1)

	)

	@/usr/include/linux/kernel.h

2 #i‚de‡
_LINUX_KERNEL_H


3 
	#_LINUX_KERNEL_H


	)

5 
	~<löux/sysöfo.h
>

6 
	~<löux/c⁄°.h
>

	@/usr/include/linux/module.h

2 #i‚de‡
_LINUX_MODULE_H


3 
	#_LINUX_MODULE_H


	)

6 
	#MODULE_INIT_IGNORE_MODVERSIONS
 1

	)

7 
	#MODULE_INIT_IGNORE_VERMAGIC
 2

	)

	@/usr/include/linux/netdevice.h

26 #i‚de‡
_LINUX_NETDEVICE_H


27 
	#_LINUX_NETDEVICE_H


	)

29 
	~<löux/if.h
>

30 
	~<löux/if_ëhî.h
>

31 
	~<löux/if_∑ckë.h
>

32 
	~<löux/if_lök.h
>

35 
	#MAX_ADDR_LEN
 32

	)

38 
	#INIT_NETDEV_GROUP
 0

	)

42 
	#NET_NAME_UNKNOWN
 0

	)

43 
	#NET_NAME_ENUM
 1

	)

44 
	#NET_NAME_PREDICTABLE
 2

	)

45 
	#NET_NAME_USER
 3

	)

46 
	#NET_NAME_RENAMED
 4

	)

50 
	mIF_PORT_UNKNOWN
 = 0,

51 
	mIF_PORT_10BASE2
,

52 
	mIF_PORT_10BASET
,

53 
	mIF_PORT_AUI
,

54 
	mIF_PORT_100BASET
,

55 
	mIF_PORT_100BASETX
,

56 
	mIF_PORT_100BASEFX


60 
	#NET_ADDR_PERM
 0

	)

61 
	#NET_ADDR_RANDOM
 1

	)

62 
	#NET_ADDR_STOLEN
 2

	)

63 
	#NET_ADDR_SET
 3

	)

	@/usr/include/linux/nl80211-vnd-intel.h

7 #i‚de‡
__VENDOR_CMD_INTEL_H__


8 
	#__VENDOR_CMD_INTEL_H__


	)

10 
	#INTEL_OUI
 0x001735

	)

21 
	eiwl_mvm_víd‹_cmd
 {

22 
	mIWL_MVM_VENDOR_CMD_GET_CSME_CONN_INFO
 = 0x2d,

23 
	mIWL_MVM_VENDOR_CMD_HOST_GET_OWNERSHIP
 = 0x30,

24 
	mIWL_MVM_VENDOR_CMD_ROAMING_FORBIDDEN_EVENT
 = 0x32,

27 
	eiwl_víd‹_auth_akm_mode
 {

28 
	mIWL_VENDOR_AUTH_OPEN
,

29 
	mIWL_VENDOR_AUTH_RSNA
 = 0x6,

30 
	mIWL_VENDOR_AUTH_RSNA_PSK
,

31 
	mIWL_VENDOR_AUTH_SAE
 = 0x9,

32 
	mIWL_VENDOR_AUTH_MAX
,

60 
	eiwl_mvm_víd‹_©å
 {

61 
	m__IWL_MVM_VENDOR_ATTR_INVALID
 = 0x00,

62 
	mIWL_MVM_VENDOR_ATTR_VIF_ADDR
 = 0x02,

63 
	mIWL_MVM_VENDOR_ATTR_ADDR
 = 0x0a,

64 
	mIWL_MVM_VENDOR_ATTR_SSID
 = 0x3d,

65 
	mIWL_MVM_VENDOR_ATTR_STA_CIPHER
 = 0x51,

66 
	mIWL_MVM_VENDOR_ATTR_ROAMING_FORBIDDEN
 = 0x64,

67 
	mIWL_MVM_VENDOR_ATTR_AUTH_MODE
 = 0x65,

68 
	mIWL_MVM_VENDOR_ATTR_CHANNEL_NUM
 = 0x66,

69 
	mIWL_MVM_VENDOR_ATTR_BAND
 = 0x69,

70 
	mIWL_MVM_VENDOR_ATTR_COLLOC_CHANNEL
 = 0x70,

71 
	mIWL_MVM_VENDOR_ATTR_COLLOC_ADDR
 = 0x71,

73 
	mNUM_IWL_MVM_VENDOR_ATTR
,

74 
	mMAX_IWL_MVM_VENDOR_ATTR
 = 
NUM_IWL_MVM_VENDOR_ATTR
 - 1,

	@/usr/include/linux/rtnetlink.h

2 #i‚de‡
__LINUX_RTNETLINK_H


3 
	#__LINUX_RTNETLINK_H


	)

5 
	~<löux/ty≥s.h
>

6 
	~<löux/√éök.h
>

7 
	~<löux/if_lök.h
>

8 
	~<löux/if_addr.h
>

9 
	~<löux/√ighbour.h
>

14 
	#RTNL_FAMILY_IPMR
 128

	)

15 
	#RTNL_FAMILY_IP6MR
 129

	)

16 
	#RTNL_FAMILY_MAX
 129

	)

25 
	mRTM_BASE
 = 16,

26 
	#RTM_BASE
 
RTM_BASE


	)

28 
	mRTM_NEWLINK
 = 16,

29 
	#RTM_NEWLINK
 
RTM_NEWLINK


	)

30 
	mRTM_DELLINK
,

31 
	#RTM_DELLINK
 
RTM_DELLINK


	)

32 
	mRTM_GETLINK
,

33 
	#RTM_GETLINK
 
RTM_GETLINK


	)

34 
	mRTM_SETLINK
,

35 
	#RTM_SETLINK
 
RTM_SETLINK


	)

37 
	mRTM_NEWADDR
 = 20,

38 
	#RTM_NEWADDR
 
RTM_NEWADDR


	)

39 
	mRTM_DELADDR
,

40 
	#RTM_DELADDR
 
RTM_DELADDR


	)

41 
	mRTM_GETADDR
,

42 
	#RTM_GETADDR
 
RTM_GETADDR


	)

44 
	mRTM_NEWROUTE
 = 24,

45 
	#RTM_NEWROUTE
 
RTM_NEWROUTE


	)

46 
	mRTM_DELROUTE
,

47 
	#RTM_DELROUTE
 
RTM_DELROUTE


	)

48 
	mRTM_GETROUTE
,

49 
	#RTM_GETROUTE
 
RTM_GETROUTE


	)

51 
	mRTM_NEWNEIGH
 = 28,

52 
	#RTM_NEWNEIGH
 
RTM_NEWNEIGH


	)

53 
	mRTM_DELNEIGH
,

54 
	#RTM_DELNEIGH
 
RTM_DELNEIGH


	)

55 
	mRTM_GETNEIGH
,

56 
	#RTM_GETNEIGH
 
RTM_GETNEIGH


	)

58 
	mRTM_NEWRULE
 = 32,

59 
	#RTM_NEWRULE
 
RTM_NEWRULE


	)

60 
	mRTM_DELRULE
,

61 
	#RTM_DELRULE
 
RTM_DELRULE


	)

62 
	mRTM_GETRULE
,

63 
	#RTM_GETRULE
 
RTM_GETRULE


	)

65 
	mRTM_NEWQDISC
 = 36,

66 
	#RTM_NEWQDISC
 
RTM_NEWQDISC


	)

67 
	mRTM_DELQDISC
,

68 
	#RTM_DELQDISC
 
RTM_DELQDISC


	)

69 
	mRTM_GETQDISC
,

70 
	#RTM_GETQDISC
 
RTM_GETQDISC


	)

72 
	mRTM_NEWTCLASS
 = 40,

73 
	#RTM_NEWTCLASS
 
RTM_NEWTCLASS


	)

74 
	mRTM_DELTCLASS
,

75 
	#RTM_DELTCLASS
 
RTM_DELTCLASS


	)

76 
	mRTM_GETTCLASS
,

77 
	#RTM_GETTCLASS
 
RTM_GETTCLASS


	)

79 
	mRTM_NEWTFILTER
 = 44,

80 
	#RTM_NEWTFILTER
 
RTM_NEWTFILTER


	)

81 
	mRTM_DELTFILTER
,

82 
	#RTM_DELTFILTER
 
RTM_DELTFILTER


	)

83 
	mRTM_GETTFILTER
,

84 
	#RTM_GETTFILTER
 
RTM_GETTFILTER


	)

86 
	mRTM_NEWACTION
 = 48,

87 
	#RTM_NEWACTION
 
RTM_NEWACTION


	)

88 
	mRTM_DELACTION
,

89 
	#RTM_DELACTION
 
RTM_DELACTION


	)

90 
	mRTM_GETACTION
,

91 
	#RTM_GETACTION
 
RTM_GETACTION


	)

93 
	mRTM_NEWPREFIX
 = 52,

94 
	#RTM_NEWPREFIX
 
RTM_NEWPREFIX


	)

96 
	mRTM_GETMULTICAST
 = 58,

97 
	#RTM_GETMULTICAST
 
RTM_GETMULTICAST


	)

99 
	mRTM_GETANYCAST
 = 62,

100 
	#RTM_GETANYCAST
 
RTM_GETANYCAST


	)

102 
	mRTM_NEWNEIGHTBL
 = 64,

103 
	#RTM_NEWNEIGHTBL
 
RTM_NEWNEIGHTBL


	)

104 
	mRTM_GETNEIGHTBL
 = 66,

105 
	#RTM_GETNEIGHTBL
 
RTM_GETNEIGHTBL


	)

106 
	mRTM_SETNEIGHTBL
,

107 
	#RTM_SETNEIGHTBL
 
RTM_SETNEIGHTBL


	)

109 
	mRTM_NEWNDUSEROPT
 = 68,

110 
	#RTM_NEWNDUSEROPT
 
RTM_NEWNDUSEROPT


	)

112 
	mRTM_NEWADDRLABEL
 = 72,

113 
	#RTM_NEWADDRLABEL
 
RTM_NEWADDRLABEL


	)

114 
	mRTM_DELADDRLABEL
,

115 
	#RTM_DELADDRLABEL
 
RTM_DELADDRLABEL


	)

116 
	mRTM_GETADDRLABEL
,

117 
	#RTM_GETADDRLABEL
 
RTM_GETADDRLABEL


	)

119 
	mRTM_GETDCB
 = 78,

120 
	#RTM_GETDCB
 
RTM_GETDCB


	)

121 
	mRTM_SETDCB
,

122 
	#RTM_SETDCB
 
RTM_SETDCB


	)

124 
	mRTM_NEWNETCONF
 = 80,

125 
	#RTM_NEWNETCONF
 
RTM_NEWNETCONF


	)

126 
	mRTM_DELNETCONF
,

127 
	#RTM_DELNETCONF
 
RTM_DELNETCONF


	)

128 
	mRTM_GETNETCONF
 = 82,

129 
	#RTM_GETNETCONF
 
RTM_GETNETCONF


	)

131 
	mRTM_NEWMDB
 = 84,

132 
	#RTM_NEWMDB
 
RTM_NEWMDB


	)

133 
	mRTM_DELMDB
 = 85,

134 
	#RTM_DELMDB
 
RTM_DELMDB


	)

135 
	mRTM_GETMDB
 = 86,

136 
	#RTM_GETMDB
 
RTM_GETMDB


	)

138 
	mRTM_NEWNSID
 = 88,

139 
	#RTM_NEWNSID
 
RTM_NEWNSID


	)

140 
	mRTM_DELNSID
 = 89,

141 
	#RTM_DELNSID
 
RTM_DELNSID


	)

142 
	mRTM_GETNSID
 = 90,

143 
	#RTM_GETNSID
 
RTM_GETNSID


	)

145 
	mRTM_NEWSTATS
 = 92,

146 
	#RTM_NEWSTATS
 
RTM_NEWSTATS


	)

147 
	mRTM_GETSTATS
 = 94,

148 
	#RTM_GETSTATS
 
RTM_GETSTATS


	)

150 
	mRTM_NEWCACHEREPORT
 = 96,

151 
	#RTM_NEWCACHEREPORT
 
RTM_NEWCACHEREPORT


	)

153 
	mRTM_NEWCHAIN
 = 100,

154 
	#RTM_NEWCHAIN
 
RTM_NEWCHAIN


	)

155 
	mRTM_DELCHAIN
,

156 
	#RTM_DELCHAIN
 
RTM_DELCHAIN


	)

157 
	mRTM_GETCHAIN
,

158 
	#RTM_GETCHAIN
 
RTM_GETCHAIN


	)

160 
	mRTM_NEWNEXTHOP
 = 104,

161 
	#RTM_NEWNEXTHOP
 
RTM_NEWNEXTHOP


	)

162 
	mRTM_DELNEXTHOP
,

163 
	#RTM_DELNEXTHOP
 
RTM_DELNEXTHOP


	)

164 
	mRTM_GETNEXTHOP
,

165 
	#RTM_GETNEXTHOP
 
RTM_GETNEXTHOP


	)

167 
	mRTM_NEWLINKPROP
 = 108,

168 
	#RTM_NEWLINKPROP
 
RTM_NEWLINKPROP


	)

169 
	mRTM_DELLINKPROP
,

170 
	#RTM_DELLINKPROP
 
RTM_DELLINKPROP


	)

171 
	mRTM_GETLINKPROP
,

172 
	#RTM_GETLINKPROP
 
RTM_GETLINKPROP


	)

174 
	mRTM_NEWVLAN
 = 112,

175 
	#RTM_NEWNVLAN
 
RTM_NEWVLAN


	)

176 
	mRTM_DELVLAN
,

177 
	#RTM_DELVLAN
 
RTM_DELVLAN


	)

178 
	mRTM_GETVLAN
,

179 
	#RTM_GETVLAN
 
RTM_GETVLAN


	)

181 
	mRTM_NEWNEXTHOPBUCKET
 = 116,

182 
	#RTM_NEWNEXTHOPBUCKET
 
RTM_NEWNEXTHOPBUCKET


	)

183 
	mRTM_DELNEXTHOPBUCKET
,

184 
	#RTM_DELNEXTHOPBUCKET
 
RTM_DELNEXTHOPBUCKET


	)

185 
	mRTM_GETNEXTHOPBUCKET
,

186 
	#RTM_GETNEXTHOPBUCKET
 
RTM_GETNEXTHOPBUCKET


	)

188 
	m__RTM_MAX
,

189 
	#RTM_MAX
 (((
__RTM_MAX
 + 3Ë& ~3Ë- 1)

	)

192 
	#RTM_NR_MSGTYPES
 (
RTM_MAX
 + 1 - 
RTM_BASE
)

	)

193 
	#RTM_NR_FAMILIES
 (
RTM_NR_MSGTYPES
 >> 2)

	)

194 
	#RTM_FAM
(
cmd
Ë(((cmdË- 
RTM_BASE
Ë>> 2)

	)

202 
	sπ©å
 {

203 
	mπa_Àn
;

204 
	mπa_ty≥
;

209 
	#RTA_ALIGNTO
 4U

	)

210 
	#RTA_ALIGN
(
Àn
Ë–(÷í)+
RTA_ALIGNTO
-1Ë& ~(RTA_ALIGNTO-1Ë)

	)

211 
	#RTA_OK
(
πa
,
Àn
Ë(÷íË>()(
π©å
) && \

212 (
πa
)->
πa_Àn
 >(
π©å
) && \

213 (
πa
)->
πa_Àn
 <(
Àn
))

	)

214 
	#RTA_NEXT
(
πa
,
©åÀn
Ë(◊âæíË-
	`RTA_ALIGN
(‘è)->
πa_Àn
), \

215 (
π©å
*)(((*)(
πa
)Ë+ 
	`RTA_ALIGN
(‘è)->
πa_Àn
)))

	)

216 
	#RTA_LENGTH
(
Àn
Ë(
	`RTA_ALIGN
((
π©å
)Ë+ (Àn))

	)

217 
	#RTA_SPACE
(
Àn
Ë
	`RTA_ALIGN
(
	`RTA_LENGTH
÷í))

	)

218 
	#RTA_DATA
(
πa
Ë((*)(((*)‘è)Ë+ 
	`RTA_LENGTH
(0)))

	)

219 
	#RTA_PAYLOAD
(
πa
Ë(()(‘è)->
πa_Àn
Ë- 
	`RTA_LENGTH
(0))

	)

228 
	sπmsg
 {

229 
	mπm_Ámûy
;

230 
	mπm_d°_Àn
;

231 
	mπm_§c_Àn
;

232 
	mπm_tos
;

234 
	mπm_èbÀ
;

235 
	mπm_¥Ÿocﬁ
;

236 
	mπm_sc›e
;

237 
	mπm_ty≥
;

239 
	mπm_Êags
;

245 
	mRTN_UNSPEC
,

246 
	mRTN_UNICAST
,

247 
	mRTN_LOCAL
,

248 
	mRTN_BROADCAST
,

250 
	mRTN_ANYCAST
,

252 
	mRTN_MULTICAST
,

253 
	mRTN_BLACKHOLE
,

254 
	mRTN_UNREACHABLE
,

255 
	mRTN_PROHIBIT
,

256 
	mRTN_THROW
,

257 
	mRTN_NAT
,

258 
	mRTN_XRESOLVE
,

259 
	m__RTN_MAX


262 
	#RTN_MAX
 (
__RTN_MAX
 - 1)

	)

267 
	#RTPROT_UNSPEC
 0

	)

268 
	#RTPROT_REDIRECT
 1

	)

270 
	#RTPROT_KERNEL
 2

	)

271 
	#RTPROT_BOOT
 3

	)

272 
	#RTPROT_STATIC
 4

	)

281 
	#RTPROT_GATED
 8

	)

282 
	#RTPROT_RA
 9

	)

283 
	#RTPROT_MRT
 10

	)

284 
	#RTPROT_ZEBRA
 11

	)

285 
	#RTPROT_BIRD
 12

	)

286 
	#RTPROT_DNROUTED
 13

	)

287 
	#RTPROT_XORP
 14

	)

288 
	#RTPROT_NTK
 15

	)

289 
	#RTPROT_DHCP
 16

	)

290 
	#RTPROT_MROUTED
 17

	)

291 
	#RTPROT_KEEPALIVED
 18

	)

292 
	#RTPROT_BABEL
 42

	)

293 
	#RTPROT_OPENR
 99

	)

294 
	#RTPROT_BGP
 186

	)

295 
	#RTPROT_ISIS
 187

	)

296 
	#RTPROT_OSPF
 188

	)

297 
	#RTPROT_RIP
 189

	)

298 
	#RTPROT_EIGRP
 192

	)

311 
	eπ_sc›e_t
 {

312 
	mRT_SCOPE_UNIVERSE
=0,

314 
	mRT_SCOPE_SITE
=200,

315 
	mRT_SCOPE_LINK
=253,

316 
	mRT_SCOPE_HOST
=254,

317 
	mRT_SCOPE_NOWHERE
=255

322 
	#RTM_F_NOTIFY
 0x100

	)

323 
	#RTM_F_CLONED
 0x200

	)

324 
	#RTM_F_EQUALIZE
 0x400

	)

325 
	#RTM_F_PREFIX
 0x800

	)

326 
	#RTM_F_LOOKUP_TABLE
 0x1000

	)

327 
	#RTM_F_FIB_MATCH
 0x2000

	)

328 
	#RTM_F_OFFLOAD
 0x4000

	)

329 
	#RTM_F_TRAP
 0x8000

	)

330 
	#RTM_F_OFFLOAD_FAILED
 0x20000000

	)

338 
	eπ_˛ass_t
 {

339 
	mRT_TABLE_UNSPEC
=0,

341 
	mRT_TABLE_COMPAT
=252,

342 
	mRT_TABLE_DEFAULT
=253,

343 
	mRT_TABLE_MAIN
=254,

344 
	mRT_TABLE_LOCAL
=255,

345 
	mRT_TABLE_MAX
=0xFFFFFFFF

351 
	eπ©å_ty≥_t
 {

352 
	mRTA_UNSPEC
,

353 
	mRTA_DST
,

354 
	mRTA_SRC
,

355 
	mRTA_IIF
,

356 
	mRTA_OIF
,

357 
	mRTA_GATEWAY
,

358 
	mRTA_PRIORITY
,

359 
	mRTA_PREFSRC
,

360 
	mRTA_METRICS
,

361 
	mRTA_MULTIPATH
,

362 
	mRTA_PROTOINFO
,

363 
	mRTA_FLOW
,

364 
	mRTA_CACHEINFO
,

365 
	mRTA_SESSION
,

366 
	mRTA_MP_ALGO
,

367 
	mRTA_TABLE
,

368 
	mRTA_MARK
,

369 
	mRTA_MFC_STATS
,

370 
	mRTA_VIA
,

371 
	mRTA_NEWDST
,

372 
	mRTA_PREF
,

373 
	mRTA_ENCAP_TYPE
,

374 
	mRTA_ENCAP
,

375 
	mRTA_EXPIRES
,

376 
	mRTA_PAD
,

377 
	mRTA_UID
,

378 
	mRTA_TTL_PROPAGATE
,

379 
	mRTA_IP_PROTO
,

380 
	mRTA_SPORT
,

381 
	mRTA_DPORT
,

382 
	mRTA_NH_ID
,

383 
	m__RTA_MAX


386 
	#RTA_MAX
 (
__RTA_MAX
 - 1)

	)

388 
	#RTM_RTA
(
r
Ë((
π©å
*)(((*)‘)Ë+ 
	`NLMSG_ALIGN
((
πmsg
))))

	)

389 
	#RTM_PAYLOAD
(
n
Ë
	`NLMSG_PAYLOAD
“,(
πmsg
))

	)

400 
	sπ√xth›
 {

401 
	mπnh_Àn
;

402 
	mπnh_Êags
;

403 
	mπnh_h›s
;

404 
	mπnh_ifödex
;

409 
	#RTNH_F_DEAD
 1

	)

410 
	#RTNH_F_PERVASIVE
 2

	)

411 
	#RTNH_F_ONLINK
 4

	)

412 
	#RTNH_F_OFFLOAD
 8

	)

413 
	#RTNH_F_LINKDOWN
 16

	)

414 
	#RTNH_F_UNRESOLVED
 32

	)

415 
	#RTNH_F_TRAP
 64

	)

417 
	#RTNH_COMPARE_MASK
 (
RTNH_F_DEAD
 | 
RTNH_F_LINKDOWN
 | \

418 
RTNH_F_OFFLOAD
 | 
RTNH_F_TRAP
)

	)

422 
	#RTNH_ALIGNTO
 4

	)

423 
	#RTNH_ALIGN
(
Àn
Ë–(÷í)+
RTNH_ALIGNTO
-1Ë& ~(RTNH_ALIGNTO-1Ë)

	)

424 
	#RTNH_OK
(
πnh
,
Àn
Ë(‘äh)->
πnh_Àn
 >(
π√xth›
) && \

425 (()(
πnh
)->
πnh_Àn
Ë<(
Àn
))

	)

426 
	#RTNH_NEXT
(
πnh
Ë((
π√xth›
*)(((*)‘äh)Ë+ 
	`RTNH_ALIGN
(‘äh)->
πnh_Àn
)))

	)

427 
	#RTNH_LENGTH
(
Àn
Ë(
	`RTNH_ALIGN
((
π√xth›
)Ë+ (Àn))

	)

428 
	#RTNH_SPACE
(
Àn
Ë
	`RTNH_ALIGN
(
	`RTNH_LENGTH
÷í))

	)

429 
	#RTNH_DATA
(
πnh
Ë((
π©å
*)(((*)‘äh)Ë+ 
	`RTNH_LENGTH
(0)))

	)

432 
	sπvü
 {

433 
__kî√l_ß_Ámûy_t
 
	mπvü_Ámûy
;

434 
__u8
 
	mπvü_addr
[0];

439 
	sπa_ˇcheöfo
 {

440 
__u32
 
	mπa_˛¡ªf
;

441 
__u32
 
	mπa_œ°u£
;

442 
__s32
 
	mπa_expúes
;

443 
__u32
 
	mπa_îr‹
;

444 
__u32
 
	mπa_u£d
;

446 
	#RTNETLINK_HAVE_PEERINFO
 1

	)

447 
__u32
 
	mπa_id
;

448 
__u32
 
	mπa_ts
;

449 
__u32
 
	mπa_tßge
;

455 
	mRTAX_UNSPEC
,

456 
	#RTAX_UNSPEC
 
RTAX_UNSPEC


	)

457 
	mRTAX_LOCK
,

458 
	#RTAX_LOCK
 
RTAX_LOCK


	)

459 
	mRTAX_MTU
,

460 
	#RTAX_MTU
 
RTAX_MTU


	)

461 
	mRTAX_WINDOW
,

462 
	#RTAX_WINDOW
 
RTAX_WINDOW


	)

463 
	mRTAX_RTT
,

464 
	#RTAX_RTT
 
RTAX_RTT


	)

465 
	mRTAX_RTTVAR
,

466 
	#RTAX_RTTVAR
 
RTAX_RTTVAR


	)

467 
	mRTAX_SSTHRESH
,

468 
	#RTAX_SSTHRESH
 
RTAX_SSTHRESH


	)

469 
	mRTAX_CWND
,

470 
	#RTAX_CWND
 
RTAX_CWND


	)

471 
	mRTAX_ADVMSS
,

472 
	#RTAX_ADVMSS
 
RTAX_ADVMSS


	)

473 
	mRTAX_REORDERING
,

474 
	#RTAX_REORDERING
 
RTAX_REORDERING


	)

475 
	mRTAX_HOPLIMIT
,

476 
	#RTAX_HOPLIMIT
 
RTAX_HOPLIMIT


	)

477 
	mRTAX_INITCWND
,

478 
	#RTAX_INITCWND
 
RTAX_INITCWND


	)

479 
	mRTAX_FEATURES
,

480 
	#RTAX_FEATURES
 
RTAX_FEATURES


	)

481 
	mRTAX_RTO_MIN
,

482 
	#RTAX_RTO_MIN
 
RTAX_RTO_MIN


	)

483 
	mRTAX_INITRWND
,

484 
	#RTAX_INITRWND
 
RTAX_INITRWND


	)

485 
	mRTAX_QUICKACK
,

486 
	#RTAX_QUICKACK
 
RTAX_QUICKACK


	)

487 
	mRTAX_CC_ALGO
,

488 
	#RTAX_CC_ALGO
 
RTAX_CC_ALGO


	)

489 
	mRTAX_FASTOPEN_NO_COOKIE
,

490 
	#RTAX_FASTOPEN_NO_COOKIE
 
RTAX_FASTOPEN_NO_COOKIE


	)

491 
	m__RTAX_MAX


494 
	#RTAX_MAX
 (
__RTAX_MAX
 - 1)

	)

496 
	#RTAX_FEATURE_ECN
 (1 << 0)

	)

497 
	#RTAX_FEATURE_SACK
 (1 << 1)

	)

498 
	#RTAX_FEATURE_TIMESTAMP
 (1 << 2)

	)

499 
	#RTAX_FEATURE_ALLFRAG
 (1 << 3)

	)

501 
	#RTAX_FEATURE_MASK
 (
RTAX_FEATURE_ECN
 | 
RTAX_FEATURE_SACK
 | \

502 
RTAX_FEATURE_TIMESTAMP
 | 
RTAX_FEATURE_ALLFRAG
)

	)

504 
	sπa_£ssi⁄
 {

505 
__u8
 
	m¥Ÿo
;

506 
__u8
 
	m∑d1
;

507 
__u16
 
	m∑d2
;

511 
__u16
 
	m•‹t
;

512 
__u16
 
	mdp‹t
;

513 } 
	mp‹ts
;

516 
__u8
 
	mty≥
;

517 
__u8
 
	mcode
;

518 
__u16
 
	midít
;

519 } 
	micm±
;

521 
__u32
 
	m•i
;

522 } 
	mu
;

525 
	sπa_mfc_°©s
 {

526 
__u64
 
	mmfcs_∑ckës
;

527 
__u64
 
	mmfcs_byãs
;

528 
__u64
 
	mmfcs_wr⁄g_if
;

535 
	sπgímsg
 {

536 
	mπgí_Ámûy
;

548 
	siföfomsg
 {

549 
	mifi_Ámûy
;

550 
	m__ifi_∑d
;

551 
	mifi_ty≥
;

552 
	mifi_ödex
;

553 
	mifi_Êags
;

554 
	mifi_ch™ge
;

561 
	s¥efixmsg
 {

562 
	m¥efix_Ámûy
;

563 
	m¥efix_∑d1
;

564 
	m¥efix_∑d2
;

565 
	m¥efix_ifödex
;

566 
	m¥efix_ty≥
;

567 
	m¥efix_Àn
;

568 
	m¥efix_Êags
;

569 
	m¥efix_∑d3
;

574 
	mPREFIX_UNSPEC
,

575 
	mPREFIX_ADDRESS
,

576 
	mPREFIX_CACHEINFO
,

577 
	m__PREFIX_MAX


580 
	#PREFIX_MAX
 (
__PREFIX_MAX
 - 1)

	)

582 
	s¥efix_ˇcheöfo
 {

583 
__u32
 
	m¥e„ºed_time
;

584 
__u32
 
	mvÆid_time
;

592 
	stcmsg
 {

593 
	mtcm_Ámûy
;

594 
	mtcm__∑d1
;

595 
	mtcm__∑d2
;

596 
	mtcm_ifödex
;

597 
__u32
 
	mtcm_h™dÀ
;

598 
__u32
 
	mtcm_∑ª¡
;

602 
	#tcm_block_ödex
 
tcm_∑ª¡


	)

603 
__u32
 
	mtcm_öfo
;

610 
	#TCM_IFINDEX_MAGIC_BLOCK
 (0xFFFFFFFFU)

	)

613 
	mTCA_UNSPEC
,

614 
	mTCA_KIND
,

615 
	mTCA_OPTIONS
,

616 
	mTCA_STATS
,

617 
	mTCA_XSTATS
,

618 
	mTCA_RATE
,

619 
	mTCA_FCNT
,

620 
	mTCA_STATS2
,

621 
	mTCA_STAB
,

622 
	mTCA_PAD
,

623 
	mTCA_DUMP_INVISIBLE
,

624 
	mTCA_CHAIN
,

625 
	mTCA_HW_OFFLOAD
,

626 
	mTCA_INGRESS_BLOCK
,

627 
	mTCA_EGRESS_BLOCK
,

628 
	mTCA_DUMP_FLAGS
,

629 
	m__TCA_MAX


632 
	#TCA_MAX
 (
__TCA_MAX
 - 1)

	)

634 
	#TCA_DUMP_FLAGS_TERSE
 (1 << 0Ë

	)

639 
	#TCA_RTA
(
r
Ë((
π©å
*)(((*)‘)Ë+ 
	`NLMSG_ALIGN
((
tcmsg
))))

	)

640 
	#TCA_PAYLOAD
(
n
Ë
	`NLMSG_PAYLOAD
“,(
tcmsg
))

	)

646 
	sndu£r›tmsg
 {

647 
	mndu£r›t_Ámûy
;

648 
	mndu£r›t_∑d1
;

649 
	mndu£r›t_›ts_Àn
;

650 
	mndu£r›t_ifödex
;

651 
__u8
 
	mndu£r›t_icmp_ty≥
;

652 
__u8
 
	mndu£r›t_icmp_code
;

653 
	mndu£r›t_∑d2
;

654 
	mndu£r›t_∑d3
;

659 
	mNDUSEROPT_UNSPEC
,

660 
	mNDUSEROPT_SRCADDR
,

661 
	m__NDUSEROPT_MAX


664 
	#NDUSEROPT_MAX
 (
__NDUSEROPT_MAX
 - 1)

	)

667 
	#RTMGRP_LINK
 1

	)

668 
	#RTMGRP_NOTIFY
 2

	)

669 
	#RTMGRP_NEIGH
 4

	)

670 
	#RTMGRP_TC
 8

	)

672 
	#RTMGRP_IPV4_IFADDR
 0x10

	)

673 
	#RTMGRP_IPV4_MROUTE
 0x20

	)

674 
	#RTMGRP_IPV4_ROUTE
 0x40

	)

675 
	#RTMGRP_IPV4_RULE
 0x80

	)

677 
	#RTMGRP_IPV6_IFADDR
 0x100

	)

678 
	#RTMGRP_IPV6_MROUTE
 0x200

	)

679 
	#RTMGRP_IPV6_ROUTE
 0x400

	)

680 
	#RTMGRP_IPV6_IFINFO
 0x800

	)

682 
	#RTMGRP_DEC√t_IFADDR
 0x1000

	)

683 
	#RTMGRP_DEC√t_ROUTE
 0x4000

	)

685 
	#RTMGRP_IPV6_PREFIX
 0x20000

	)

688 
	eπ√éök_groups
 {

689 
	mRTNLGRP_NONE
,

690 
	#RTNLGRP_NONE
 
RTNLGRP_NONE


	)

691 
	mRTNLGRP_LINK
,

692 
	#RTNLGRP_LINK
 
RTNLGRP_LINK


	)

693 
	mRTNLGRP_NOTIFY
,

694 
	#RTNLGRP_NOTIFY
 
RTNLGRP_NOTIFY


	)

695 
	mRTNLGRP_NEIGH
,

696 
	#RTNLGRP_NEIGH
 
RTNLGRP_NEIGH


	)

697 
	mRTNLGRP_TC
,

698 
	#RTNLGRP_TC
 
RTNLGRP_TC


	)

699 
	mRTNLGRP_IPV4_IFADDR
,

700 
	#RTNLGRP_IPV4_IFADDR
 
RTNLGRP_IPV4_IFADDR


	)

701 
	mRTNLGRP_IPV4_MROUTE
,

702 
	#RTNLGRP_IPV4_MROUTE
 
RTNLGRP_IPV4_MROUTE


	)

703 
	mRTNLGRP_IPV4_ROUTE
,

704 
	#RTNLGRP_IPV4_ROUTE
 
RTNLGRP_IPV4_ROUTE


	)

705 
	mRTNLGRP_IPV4_RULE
,

706 
	#RTNLGRP_IPV4_RULE
 
RTNLGRP_IPV4_RULE


	)

707 
	mRTNLGRP_IPV6_IFADDR
,

708 
	#RTNLGRP_IPV6_IFADDR
 
RTNLGRP_IPV6_IFADDR


	)

709 
	mRTNLGRP_IPV6_MROUTE
,

710 
	#RTNLGRP_IPV6_MROUTE
 
RTNLGRP_IPV6_MROUTE


	)

711 
	mRTNLGRP_IPV6_ROUTE
,

712 
	#RTNLGRP_IPV6_ROUTE
 
RTNLGRP_IPV6_ROUTE


	)

713 
	mRTNLGRP_IPV6_IFINFO
,

714 
	#RTNLGRP_IPV6_IFINFO
 
RTNLGRP_IPV6_IFINFO


	)

715 
	mRTNLGRP_DEC√t_IFADDR
,

716 
	#RTNLGRP_DEC√t_IFADDR
 
RTNLGRP_DEC√t_IFADDR


	)

717 
	mRTNLGRP_NOP2
,

718 
	mRTNLGRP_DEC√t_ROUTE
,

719 
	#RTNLGRP_DEC√t_ROUTE
 
RTNLGRP_DEC√t_ROUTE


	)

720 
	mRTNLGRP_DEC√t_RULE
,

721 
	#RTNLGRP_DEC√t_RULE
 
RTNLGRP_DEC√t_RULE


	)

722 
	mRTNLGRP_NOP4
,

723 
	mRTNLGRP_IPV6_PREFIX
,

724 
	#RTNLGRP_IPV6_PREFIX
 
RTNLGRP_IPV6_PREFIX


	)

725 
	mRTNLGRP_IPV6_RULE
,

726 
	#RTNLGRP_IPV6_RULE
 
RTNLGRP_IPV6_RULE


	)

727 
	mRTNLGRP_ND_USEROPT
,

728 
	#RTNLGRP_ND_USEROPT
 
RTNLGRP_ND_USEROPT


	)

729 
	mRTNLGRP_PHONET_IFADDR
,

730 
	#RTNLGRP_PHONET_IFADDR
 
RTNLGRP_PHONET_IFADDR


	)

731 
	mRTNLGRP_PHONET_ROUTE
,

732 
	#RTNLGRP_PHONET_ROUTE
 
RTNLGRP_PHONET_ROUTE


	)

733 
	mRTNLGRP_DCB
,

734 
	#RTNLGRP_DCB
 
RTNLGRP_DCB


	)

735 
	mRTNLGRP_IPV4_NETCONF
,

736 
	#RTNLGRP_IPV4_NETCONF
 
RTNLGRP_IPV4_NETCONF


	)

737 
	mRTNLGRP_IPV6_NETCONF
,

738 
	#RTNLGRP_IPV6_NETCONF
 
RTNLGRP_IPV6_NETCONF


	)

739 
	mRTNLGRP_MDB
,

740 
	#RTNLGRP_MDB
 
RTNLGRP_MDB


	)

741 
	mRTNLGRP_MPLS_ROUTE
,

742 
	#RTNLGRP_MPLS_ROUTE
 
RTNLGRP_MPLS_ROUTE


	)

743 
	mRTNLGRP_NSID
,

744 
	#RTNLGRP_NSID
 
RTNLGRP_NSID


	)

745 
	mRTNLGRP_MPLS_NETCONF
,

746 
	#RTNLGRP_MPLS_NETCONF
 
RTNLGRP_MPLS_NETCONF


	)

747 
	mRTNLGRP_IPV4_MROUTE_R
,

748 
	#RTNLGRP_IPV4_MROUTE_R
 
RTNLGRP_IPV4_MROUTE_R


	)

749 
	mRTNLGRP_IPV6_MROUTE_R
,

750 
	#RTNLGRP_IPV6_MROUTE_R
 
RTNLGRP_IPV6_MROUTE_R


	)

751 
	mRTNLGRP_NEXTHOP
,

752 
	#RTNLGRP_NEXTHOP
 
RTNLGRP_NEXTHOP


	)

753 
	mRTNLGRP_BRVLAN
,

754 
	#RTNLGRP_BRVLAN
 
RTNLGRP_BRVLAN


	)

755 
	m__RTNLGRP_MAX


757 
	#RTNLGRP_MAX
 (
__RTNLGRP_MAX
 - 1)

	)

760 
	stˇmsg
 {

761 
	mtˇ_Ámûy
;

762 
	mtˇ__∑d1
;

763 
	mtˇ__∑d2
;

767 
	mTCA_ROOT_UNSPEC
,

768 
	mTCA_ROOT_TAB
,

769 
	#TCA_ACT_TAB
 
TCA_ROOT_TAB


	)

770 
	#TCAA_MAX
 
TCA_ROOT_TAB


	)

771 
	mTCA_ROOT_FLAGS
,

772 
	mTCA_ROOT_COUNT
,

773 
	mTCA_ROOT_TIME_DELTA
,

774 
	m__TCA_ROOT_MAX
,

775 
	#TCA_ROOT_MAX
 (
__TCA_ROOT_MAX
 - 1)

	)

778 
	#TA_RTA
(
r
Ë((
π©å
*)(((*)‘)Ë+ 
	`NLMSG_ALIGN
((
tˇmsg
))))

	)

779 
	#TA_PAYLOAD
(
n
Ë
	`NLMSG_PAYLOAD
“,(
tˇmsg
))

	)

791 
	#TCA_FLAG_LARGE_DUMP_ON
 (1 << 0)

	)

792 
	#TCA_ACT_FLAG_LARGE_DUMP_ON
 
TCA_FLAG_LARGE_DUMP_ON


	)

793 
	#TCA_ACT_FLAG_TERSE_DUMP
 (1 << 1)

	)

796 
	#RTEXT_FILTER_VF
 (1 << 0)

	)

797 
	#RTEXT_FILTER_BRVLAN
 (1 << 1)

	)

798 
	#RTEXT_FILTER_BRVLAN_COMPRESSED
 (1 << 2)

	)

799 
	#RTEXT_FILTER_SKIP_STATS
 (1 << 3)

	)

800 
	#RTEXT_FILTER_MRP
 (1 << 4)

	)

801 
	#RTEXT_FILTER_CFM_CONFIG
 (1 << 5)

	)

802 
	#RTEXT_FILTER_CFM_STATUS
 (1 << 6)

	)

	@/usr/include/linux/tcp.h

18 #i‚de‡
_LINUX_TCP_H


19 
	#_LINUX_TCP_H


	)

21 
	~<löux/ty≥s.h
>

22 
	~<asm/byã‹dî.h
>

23 
	~<löux/sockë.h
>

25 
	st˝hdr
 {

26 
__be16
 
	msour˚
;

27 
__be16
 
	mde°
;

28 
__be32
 
	m£q
;

29 
__be32
 
	mack_£q
;

30 #i‡
deföed
(
__LITTLE_ENDIAN_BITFIELD
)

31 
__u16
 
	mªs1
:4,

32 
	mdoff
:4,

33 
	mfö
:1,

34 
	msyn
:1,

35 
	mr°
:1,

36 
	mpsh
:1,

37 
	mack
:1,

38 
	murg
:1,

39 
	me˚
:1,

40 
	mcwr
:1;

41 #ñi‡
deföed
(
__BIG_ENDIAN_BITFIELD
)

42 
__u16
 
	mdoff
:4,

43 
	mªs1
:4,

44 
	mcwr
:1,

45 
	me˚
:1,

46 
	murg
:1,

47 
	mack
:1,

48 
	mpsh
:1,

49 
	mr°
:1,

50 
	msyn
:1,

51 
	mfö
:1;

55 
__be16
 
	mwödow
;

56 
__sum16
 
	mcheck
;

57 
__be16
 
	murg_±r
;

65 
	ut˝_w‹d_hdr
 {

66 
t˝hdr
 
	mhdr
;

67 
__be32
 
	mw‹ds
[5];

70 
	#t˝_Êag_w‹d
(
ç
Ë(((
t˝_w‹d_hdr
 *)—p))->
w‹ds
[3])

	)

73 
	mTCP_FLAG_CWR
 = 
__c⁄°™t_˝u_to_be32
(0x00800000),

74 
	mTCP_FLAG_ECE
 = 
__c⁄°™t_˝u_to_be32
(0x00400000),

75 
	mTCP_FLAG_URG
 = 
__c⁄°™t_˝u_to_be32
(0x00200000),

76 
	mTCP_FLAG_ACK
 = 
__c⁄°™t_˝u_to_be32
(0x00100000),

77 
	mTCP_FLAG_PSH
 = 
__c⁄°™t_˝u_to_be32
(0x00080000),

78 
	mTCP_FLAG_RST
 = 
__c⁄°™t_˝u_to_be32
(0x00040000),

79 
	mTCP_FLAG_SYN
 = 
__c⁄°™t_˝u_to_be32
(0x00020000),

80 
	mTCP_FLAG_FIN
 = 
__c⁄°™t_˝u_to_be32
(0x00010000),

81 
	mTCP_RESERVED_BITS
 = 
__c⁄°™t_˝u_to_be32
(0x0F000000),

82 
	mTCP_DATA_OFFSET
 = 
__c⁄°™t_˝u_to_be32
(0xF0000000)

88 
	#TCP_MSS_DEFAULT
 536U

	)

89 
	#TCP_MSS_DESIRED
 1220U

	)

92 
	#TCP_NODELAY
 1

	)

93 
	#TCP_MAXSEG
 2

	)

94 
	#TCP_CORK
 3

	)

95 
	#TCP_KEEPIDLE
 4

	)

96 
	#TCP_KEEPINTVL
 5

	)

97 
	#TCP_KEEPCNT
 6

	)

98 
	#TCP_SYNCNT
 7

	)

99 
	#TCP_LINGER2
 8

	)

100 
	#TCP_DEFER_ACCEPT
 9

	)

101 
	#TCP_WINDOW_CLAMP
 10

	)

102 
	#TCP_INFO
 11

	)

103 
	#TCP_QUICKACK
 12

	)

104 
	#TCP_CONGESTION
 13

	)

105 
	#TCP_MD5SIG
 14

	)

106 
	#TCP_THIN_LINEAR_TIMEOUTS
 16

	)

107 
	#TCP_THIN_DUPACK
 17

	)

108 
	#TCP_USER_TIMEOUT
 18

	)

109 
	#TCP_REPAIR
 19

	)

110 
	#TCP_REPAIR_QUEUE
 20

	)

111 
	#TCP_QUEUE_SEQ
 21

	)

112 
	#TCP_REPAIR_OPTIONS
 22

	)

113 
	#TCP_FASTOPEN
 23

	)

114 
	#TCP_TIMESTAMP
 24

	)

115 
	#TCP_NOTSENT_LOWAT
 25

	)

116 
	#TCP_CC_INFO
 26

	)

117 
	#TCP_SAVE_SYN
 27

	)

118 
	#TCP_SAVED_SYN
 28

	)

119 
	#TCP_REPAIR_WINDOW
 29

	)

120 
	#TCP_FASTOPEN_CONNECT
 30

	)

121 
	#TCP_ULP
 31

	)

122 
	#TCP_MD5SIG_EXT
 32

	)

123 
	#TCP_FASTOPEN_KEY
 33

	)

124 
	#TCP_FASTOPEN_NO_COOKIE
 34

	)

125 
	#TCP_ZEROCOPY_RECEIVE
 35

	)

126 
	#TCP_INQ
 36

	)

128 
	#TCP_CM_INQ
 
TCP_INQ


	)

130 
	#TCP_TX_DELAY
 37

	)

133 
	#TCP_REPAIR_ON
 1

	)

134 
	#TCP_REPAIR_OFF
 0

	)

135 
	#TCP_REPAIR_OFF_NO_WP
 -1

	)

137 
	st˝_ª∑ú_›t
 {

138 
__u32
 
	m›t_code
;

139 
__u32
 
	m›t_vÆ
;

142 
	st˝_ª∑ú_wödow
 {

143 
__u32
 
	m¢d_wl1
;

144 
__u32
 
	m¢d_wnd
;

145 
__u32
 
	mmax_wödow
;

147 
__u32
 
	mrcv_wnd
;

148 
__u32
 
	mrcv_wup
;

152 
	mTCP_NO_QUEUE
,

153 
	mTCP_RECV_QUEUE
,

154 
	mTCP_SEND_QUEUE
,

155 
	mTCP_QUEUES_NR
,

159 
	et˝_Á°›í_˛õ¡_Áû
 {

160 
	mTFO_STATUS_UNSPEC
,

161 
	mTFO_COOKIE_UNAVAILABLE
,

162 
	mTFO_DATA_NOT_ACKED
,

163 
	mTFO_SYN_RETRANSMITTED
,

167 
	#TCPI_OPT_TIMESTAMPS
 1

	)

168 
	#TCPI_OPT_SACK
 2

	)

169 
	#TCPI_OPT_WSCALE
 4

	)

170 
	#TCPI_OPT_ECN
 8

	)

171 
	#TCPI_OPT_ECN_SEEN
 16

	)

172 
	#TCPI_OPT_SYN_DATA
 32

	)

179 
	et˝_ˇ_°©e
 {

184 
	mTCP_CA_O≥n
 = 0,

185 
	#TCPF_CA_O≥n
 (1<<
TCP_CA_O≥n
)

	)

192 
	mTCP_CA_Dis‹dî
 = 1,

193 
	#TCPF_CA_Dis‹dî
 (1<<
TCP_CA_Dis‹dî
)

	)

199 
	mTCP_CA_CWR
 = 2,

200 
	#TCPF_CA_CWR
 (1<<
TCP_CA_CWR
)

	)

205 
	mTCP_CA_Recovîy
 = 3,

206 
	#TCPF_CA_Recovîy
 (1<<
TCP_CA_Recovîy
)

	)

210 
	mTCP_CA_Loss
 = 4

211 
	#TCPF_CA_Loss
 (1<<
TCP_CA_Loss
)

	)

214 
	st˝_öfo
 {

215 
__u8
 
	mt˝i_°©e
;

216 
__u8
 
	mt˝i_ˇ_°©e
;

217 
__u8
 
	mt˝i_ªå™smôs
;

218 
__u8
 
	mt˝i_¥obes
;

219 
__u8
 
	mt˝i_backoff
;

220 
__u8
 
	mt˝i_›ti⁄s
;

221 
__u8
 
	mt˝i_¢d_wsˇÀ
 : 4, 
	mt˝i_rcv_wsˇÀ
 : 4;

222 
__u8
 
	mt˝i_dñivîy_øã_≠p_limôed
:1, 
	mt˝i_Á°›í_˛õ¡_Áû
:2;

224 
__u32
 
	mt˝i_πo
;

225 
__u32
 
	mt˝i_©o
;

226 
__u32
 
	mt˝i_¢d_mss
;

227 
__u32
 
	mt˝i_rcv_mss
;

229 
__u32
 
	mt˝i_u«cked
;

230 
__u32
 
	mt˝i_ßcked
;

231 
__u32
 
	mt˝i_lo°
;

232 
__u32
 
	mt˝i_ªå™s
;

233 
__u32
 
	mt˝i_Áckës
;

236 
__u32
 
	mt˝i_œ°_d©a_£¡
;

237 
__u32
 
	mt˝i_œ°_ack_£¡
;

238 
__u32
 
	mt˝i_œ°_d©a_ªcv
;

239 
__u32
 
	mt˝i_œ°_ack_ªcv
;

242 
__u32
 
	mt˝i_pmtu
;

243 
__u32
 
	mt˝i_rcv_s°hªsh
;

244 
__u32
 
	mt˝i_πt
;

245 
__u32
 
	mt˝i_πtv¨
;

246 
__u32
 
	mt˝i_¢d_s°hªsh
;

247 
__u32
 
	mt˝i_¢d_cwnd
;

248 
__u32
 
	mt˝i_advmss
;

249 
__u32
 
	mt˝i_ª‹dîög
;

251 
__u32
 
	mt˝i_rcv_πt
;

252 
__u32
 
	mt˝i_rcv_•a˚
;

254 
__u32
 
	mt˝i_tŸÆ_ªå™s
;

256 
__u64
 
	mt˝i_∑cög_øã
;

257 
__u64
 
	mt˝i_max_∑cög_øã
;

258 
__u64
 
	mt˝i_byãs_acked
;

259 
__u64
 
	mt˝i_byãs_ª˚ived
;

260 
__u32
 
	mt˝i_£gs_out
;

261 
__u32
 
	mt˝i_£gs_ö
;

263 
__u32
 
	mt˝i_nŸ£¡_byãs
;

264 
__u32
 
	mt˝i_mö_πt
;

265 
__u32
 
	mt˝i_d©a_£gs_ö
;

266 
__u32
 
	mt˝i_d©a_£gs_out
;

268 
__u64
 
	mt˝i_dñivîy_øã
;

270 
__u64
 
	mt˝i_busy_time
;

271 
__u64
 
	mt˝i_rwnd_limôed
;

272 
__u64
 
	mt˝i_¢dbuf_limôed
;

274 
__u32
 
	mt˝i_dñivîed
;

275 
__u32
 
	mt˝i_dñivîed_˚
;

277 
__u64
 
	mt˝i_byãs_£¡
;

278 
__u64
 
	mt˝i_byãs_ªå™s
;

279 
__u32
 
	mt˝i_dßck_dups
;

280 
__u32
 
	mt˝i_ª‹d_£í
;

282 
__u32
 
	mt˝i_rcv_oo›ack
;

284 
__u32
 
	mt˝i_¢d_wnd
;

291 
	mTCP_NLA_PAD
,

292 
	mTCP_NLA_BUSY
,

293 
	mTCP_NLA_RWND_LIMITED
,

294 
	mTCP_NLA_SNDBUF_LIMITED
,

295 
	mTCP_NLA_DATA_SEGS_OUT
,

296 
	mTCP_NLA_TOTAL_RETRANS
,

297 
	mTCP_NLA_PACING_RATE
,

298 
	mTCP_NLA_DELIVERY_RATE
,

299 
	mTCP_NLA_SND_CWND
,

300 
	mTCP_NLA_REORDERING
,

301 
	mTCP_NLA_MIN_RTT
,

302 
	mTCP_NLA_RECUR_RETRANS
,

303 
	mTCP_NLA_DELIVERY_RATE_APP_LMT
,

304 
	mTCP_NLA_SNDQ_SIZE
,

305 
	mTCP_NLA_CA_STATE
,

306 
	mTCP_NLA_SND_SSTHRESH
,

307 
	mTCP_NLA_DELIVERED
,

308 
	mTCP_NLA_DELIVERED_CE
,

309 
	mTCP_NLA_BYTES_SENT
,

310 
	mTCP_NLA_BYTES_RETRANS
,

311 
	mTCP_NLA_DSACK_DUPS
,

312 
	mTCP_NLA_REORD_SEEN
,

313 
	mTCP_NLA_SRTT
,

314 
	mTCP_NLA_TIMEOUT_REHASH
,

315 
	mTCP_NLA_BYTES_NOTSENT
,

316 
	mTCP_NLA_EDT
,

317 
	mTCP_NLA_TTL
,

321 
	#TCP_MD5SIG_MAXKEYLEN
 80

	)

324 
	#TCP_MD5SIG_FLAG_PREFIX
 0x1

	)

325 
	#TCP_MD5SIG_FLAG_IFINDEX
 0x2

	)

327 
	st˝_md5sig
 {

328 
__kî√l_sockaddr_°‹age
 
	mt˝m_addr
;

329 
__u8
 
	mt˝m_Êags
;

330 
__u8
 
	mt˝m_¥efixÀn
;

331 
__u16
 
	mt˝m_keyÀn
;

332 
	mt˝m_ifödex
;

333 
__u8
 
	mt˝m_key
[
TCP_MD5SIG_MAXKEYLEN
];

337 
	st˝_düg_md5sig
 {

338 
__u8
 
	mt˝m_Ámûy
;

339 
__u8
 
	mt˝m_¥efixÀn
;

340 
__u16
 
	mt˝m_keyÀn
;

341 
__be32
 
	mt˝m_addr
[4];

342 
__u8
 
	mt˝m_key
[
TCP_MD5SIG_MAXKEYLEN
];

347 
	#TCP_RECEIVE_ZEROCOPY_FLAG_TLB_CLEAN_HINT
 0x1

	)

348 
	st˝_zîoc›y_ª˚ive
 {

349 
__u64
 
	maddªss
;

350 
__u32
 
	mÀngth
;

351 
__u32
 
	mªcv_skù_höt
;

352 
__u32
 
	möq
;

353 
__s32
 
	mîr
;

354 
__u64
 
	mc›ybuf_addªss
;

355 
__s32
 
	mc›ybuf_Àn
;

356 
__u32
 
	mÊags
;

357 
__u64
 
	mmsg_c⁄åﬁ
;

358 
__u64
 
	mmsg_c⁄åﬁÀn
;

359 
__u32
 
	mmsg_Êags
;

360 
__u32
 
	mª£rved
;

	@/usr/include/linux/thermal.h

2 #i‚de‡
_LINUX_THERMAL_H


3 
	#_LINUX_THERMAL_H


	)

5 
	#THERMAL_NAME_LENGTH
 20

	)

7 
	ethîmÆ_devi˚_mode
 {

8 
	mTHERMAL_DEVICE_DISABLED
 = 0,

9 
	mTHERMAL_DEVICE_ENABLED
,

12 
	ethîmÆ_åù_ty≥
 {

13 
	mTHERMAL_TRIP_ACTIVE
 = 0,

14 
	mTHERMAL_TRIP_PASSIVE
,

15 
	mTHERMAL_TRIP_HOT
,

16 
	mTHERMAL_TRIP_CRITICAL
,

20 
	#THERMAL_GENL_FAMILY_NAME
 "thîmÆ"

	)

21 
	#THERMAL_GENL_VERSION
 0x01

	)

22 
	#THERMAL_GENL_SAMPLING_GROUP_NAME
 "ßm∂ög"

	)

23 
	#THERMAL_GENL_EVENT_GROUP_NAME
 "evít"

	)

26 
	ethîmÆ_gíl_©å
 {

27 
	mTHERMAL_GENL_ATTR_UNSPEC
,

28 
	mTHERMAL_GENL_ATTR_TZ
,

29 
	mTHERMAL_GENL_ATTR_TZ_ID
,

30 
	mTHERMAL_GENL_ATTR_TZ_TEMP
,

31 
	mTHERMAL_GENL_ATTR_TZ_TRIP
,

32 
	mTHERMAL_GENL_ATTR_TZ_TRIP_ID
,

33 
	mTHERMAL_GENL_ATTR_TZ_TRIP_TYPE
,

34 
	mTHERMAL_GENL_ATTR_TZ_TRIP_TEMP
,

35 
	mTHERMAL_GENL_ATTR_TZ_TRIP_HYST
,

36 
	mTHERMAL_GENL_ATTR_TZ_MODE
,

37 
	mTHERMAL_GENL_ATTR_TZ_NAME
,

38 
	mTHERMAL_GENL_ATTR_TZ_CDEV_WEIGHT
,

39 
	mTHERMAL_GENL_ATTR_TZ_GOV
,

40 
	mTHERMAL_GENL_ATTR_TZ_GOV_NAME
,

41 
	mTHERMAL_GENL_ATTR_CDEV
,

42 
	mTHERMAL_GENL_ATTR_CDEV_ID
,

43 
	mTHERMAL_GENL_ATTR_CDEV_CUR_STATE
,

44 
	mTHERMAL_GENL_ATTR_CDEV_MAX_STATE
,

45 
	mTHERMAL_GENL_ATTR_CDEV_NAME
,

46 
	mTHERMAL_GENL_ATTR_GOV_NAME
,

48 
	m__THERMAL_GENL_ATTR_MAX
,

50 
	#THERMAL_GENL_ATTR_MAX
 (
__THERMAL_GENL_ATTR_MAX
 - 1)

	)

52 
	ethîmÆ_gíl_ßm∂ög
 {

53 
	mTHERMAL_GENL_SAMPLING_TEMP
,

54 
	m__THERMAL_GENL_SAMPLING_MAX
,

56 
	#THERMAL_GENL_SAMPLING_MAX
 (
__THERMAL_GENL_SAMPLING_MAX
 - 1)

	)

59 
	ethîmÆ_gíl_evít
 {

60 
	mTHERMAL_GENL_EVENT_UNSPEC
,

61 
	mTHERMAL_GENL_EVENT_TZ_CREATE
,

62 
	mTHERMAL_GENL_EVENT_TZ_DELETE
,

63 
	mTHERMAL_GENL_EVENT_TZ_DISABLE
,

64 
	mTHERMAL_GENL_EVENT_TZ_ENABLE
,

65 
	mTHERMAL_GENL_EVENT_TZ_TRIP_UP
,

66 
	mTHERMAL_GENL_EVENT_TZ_TRIP_DOWN
,

67 
	mTHERMAL_GENL_EVENT_TZ_TRIP_CHANGE
,

68 
	mTHERMAL_GENL_EVENT_TZ_TRIP_ADD
,

69 
	mTHERMAL_GENL_EVENT_TZ_TRIP_DELETE
,

70 
	mTHERMAL_GENL_EVENT_CDEV_ADD
,

71 
	mTHERMAL_GENL_EVENT_CDEV_DELETE
,

72 
	mTHERMAL_GENL_EVENT_CDEV_STATE_UPDATE
,

73 
	mTHERMAL_GENL_EVENT_TZ_GOV_CHANGE
,

74 
	m__THERMAL_GENL_EVENT_MAX
,

76 
	#THERMAL_GENL_EVENT_MAX
 (
__THERMAL_GENL_EVENT_MAX
 - 1)

	)

79 
	ethîmÆ_gíl_cmd
 {

80 
	mTHERMAL_GENL_CMD_UNSPEC
,

81 
	mTHERMAL_GENL_CMD_TZ_GET_ID
,

82 
	mTHERMAL_GENL_CMD_TZ_GET_TRIP
,

83 
	mTHERMAL_GENL_CMD_TZ_GET_TEMP
,

84 
	mTHERMAL_GENL_CMD_TZ_GET_GOV
,

85 
	mTHERMAL_GENL_CMD_TZ_GET_MODE
,

86 
	mTHERMAL_GENL_CMD_CDEV_GET
,

87 
	m__THERMAL_GENL_CMD_MAX
,

89 
	#THERMAL_GENL_CMD_MAX
 (
__THERMAL_GENL_CMD_MAX
 - 1)

	)

	@/usr/include/linux/time.h

2 #i‚de‡
_LINUX_TIME_H


3 
	#_LINUX_TIME_H


	)

5 
	~<löux/ty≥s.h
>

6 
	~<löux/time_ty≥s.h
>

8 #i‚de‡
_STRUCT_TIMESPEC


9 
	#_STRUCT_TIMESPEC


	)

10 
	stime•ec
 {

11 
__kî√l_ﬁd_time_t
 
	mtv_£c
;

12 
	mtv_n£c
;

16 
	stimevÆ
 {

17 
__kî√l_ﬁd_time_t
 
	mtv_£c
;

18 
__kî√l_su£c⁄ds_t
 
	mtv_u£c
;

21 
	sôimî•ec
 {

22 
time•ec
 
	mô_öãrvÆ
;

23 
time•ec
 
	mô_vÆue
;

26 
	sôimîvÆ
 {

27 
timevÆ
 
	mô_öãrvÆ
;

28 
timevÆ
 
	mô_vÆue
;

31 
	stimez⁄e
 {

32 
	mtz_möuãswe°
;

33 
	mtz_d°time
;

40 
	#ITIMER_REAL
 0

	)

41 
	#ITIMER_VIRTUAL
 1

	)

42 
	#ITIMER_PROF
 2

	)

47 
	#CLOCK_REALTIME
 0

	)

48 
	#CLOCK_MONOTONIC
 1

	)

49 
	#CLOCK_PROCESS_CPUTIME_ID
 2

	)

50 
	#CLOCK_THREAD_CPUTIME_ID
 3

	)

51 
	#CLOCK_MONOTONIC_RAW
 4

	)

52 
	#CLOCK_REALTIME_COARSE
 5

	)

53 
	#CLOCK_MONOTONIC_COARSE
 6

	)

54 
	#CLOCK_BOOTTIME
 7

	)

55 
	#CLOCK_REALTIME_ALARM
 8

	)

56 
	#CLOCK_BOOTTIME_ALARM
 9

	)

61 
	#CLOCK_SGI_CYCLE
 10

	)

62 
	#CLOCK_TAI
 11

	)

64 
	#MAX_CLOCKS
 16

	)

65 
	#CLOCKS_MASK
 (
CLOCK_REALTIME
 | 
CLOCK_MONOTONIC
)

	)

66 
	#CLOCKS_MONO
 
CLOCK_MONOTONIC


	)

71 
	#TIMER_ABSTIME
 0x01

	)

	@/usr/include/linux/wait.h

2 #i‚de‡
_LINUX_WAIT_H


3 
	#_LINUX_WAIT_H


	)

5 
	#WNOHANG
 0x00000001

	)

6 
	#WUNTRACED
 0x00000002

	)

7 
	#WSTOPPED
 
WUNTRACED


	)

8 
	#WEXITED
 0x00000004

	)

9 
	#WCONTINUED
 0x00000008

	)

10 
	#WNOWAIT
 0x01000000

	)

12 
	#__WNOTHREAD
 0x20000000

	)

13 
	#__WALL
 0x40000000

	)

14 
	#__WCLONE
 0x80000000

	)

17 
	#P_ALL
 0

	)

18 
	#P_PID
 1

	)

19 
	#P_PGID
 2

	)

20 
	#P_PIDFD
 3

	)

	@/usr/include/linux/const.h

4 #i‚de‡
_LINUX_CONST_H


5 
	#_LINUX_CONST_H


	)

16 #ifde‡
__ASSEMBLY__


17 
	#_AC
(
X
,
Y
Ë
	)
X

18 
	#_AT
(
T
,
X
Ë
	)
X

20 
	#__AC
(
X
,
Y
Ë(X##Y)

	)

21 
	#_AC
(
X
,
Y
Ë
	`__AC
(X,Y)

	)

22 
	#_AT
(
T
,
X
Ë((T)(X))

	)

25 
	#_UL
(
x
Ë(
	`_AC
(x, 
UL
))

	)

26 
	#_ULL
(
x
Ë(
	`_AC
(x, 
ULL
))

	)

28 
	#_BITUL
(
x
Ë(
	`_UL
(1Ë<< (x))

	)

29 
	#_BITULL
(
x
Ë(
	`_ULL
(1Ë<< (x))

	)

31 
	#__ALIGN_KERNEL
(
x
, 
a
Ë
	`__ALIGN_KERNEL_MASK
(x, (
	`__ty≥of__
(x))◊Ë- 1)

	)

32 
	#__ALIGN_KERNEL_MASK
(
x
, 
mask
Ë(((xË+ (mask)Ë& ~(mask))

	)

34 
	#__KERNEL_DIV_ROUND_UP
(
n
, 
d
Ë((“Ë+ (dË- 1Ë/ (d))

	)

	@/usr/include/linux/fscrypt.h

8 #i‚de‡
_LINUX_FSCRYPT_H


9 
	#_LINUX_FSCRYPT_H


	)

11 
	~<löux/io˘l.h
>

12 
	~<löux/ty≥s.h
>

15 
	#FSCRYPT_POLICY_FLAGS_PAD_4
 0x00

	)

16 
	#FSCRYPT_POLICY_FLAGS_PAD_8
 0x01

	)

17 
	#FSCRYPT_POLICY_FLAGS_PAD_16
 0x02

	)

18 
	#FSCRYPT_POLICY_FLAGS_PAD_32
 0x03

	)

19 
	#FSCRYPT_POLICY_FLAGS_PAD_MASK
 0x03

	)

20 
	#FSCRYPT_POLICY_FLAG_DIRECT_KEY
 0x04

	)

21 
	#FSCRYPT_POLICY_FLAG_IV_INO_LBLK_64
 0x08

	)

22 
	#FSCRYPT_POLICY_FLAG_IV_INO_LBLK_32
 0x10

	)

25 
	#FSCRYPT_MODE_AES_256_XTS
 1

	)

26 
	#FSCRYPT_MODE_AES_256_CTS
 4

	)

27 
	#FSCRYPT_MODE_AES_128_CBC
 5

	)

28 
	#FSCRYPT_MODE_AES_128_CTS
 6

	)

29 
	#FSCRYPT_MODE_ADIANTUM
 9

	)

38 
	#FSCRYPT_POLICY_V1
 0

	)

39 
	#FSCRYPT_KEY_DESCRIPTOR_SIZE
 8

	)

40 
	sfs¸y±_pﬁicy_v1
 {

41 
__u8
 
	mvîsi⁄
;

42 
__u8
 
	mc⁄ã¡s_í¸y±i⁄_mode
;

43 
__u8
 
	mfûíames_í¸y±i⁄_mode
;

44 
__u8
 
	mÊags
;

45 
__u8
 
	mma°î_key_des¸ùt‹
[
FSCRYPT_KEY_DESCRIPTOR_SIZE
];

52 
	#FSCRYPT_KEY_DESC_PREFIX
 "fs¸y±:"

	)

53 
	#FSCRYPT_KEY_DESC_PREFIX_SIZE
 8

	)

54 
	#FSCRYPT_MAX_KEY_SIZE
 64

	)

55 
	sfs¸y±_key
 {

56 
__u32
 
	mmode
;

57 
__u8
 
	møw
[
FSCRYPT_MAX_KEY_SIZE
];

58 
__u32
 
	msize
;

64 
	#FSCRYPT_POLICY_V2
 2

	)

65 
	#FSCRYPT_KEY_IDENTIFIER_SIZE
 16

	)

66 
	sfs¸y±_pﬁicy_v2
 {

67 
__u8
 
	mvîsi⁄
;

68 
__u8
 
	mc⁄ã¡s_í¸y±i⁄_mode
;

69 
__u8
 
	mfûíames_í¸y±i⁄_mode
;

70 
__u8
 
	mÊags
;

71 
__u8
 
	m__ª£rved
[4];

72 
__u8
 
	mma°î_key_idítifõr
[
FSCRYPT_KEY_IDENTIFIER_SIZE
];

76 
	sfs¸y±_gë_pﬁicy_ex_¨g
 {

77 
__u64
 
	mpﬁicy_size
;

79 
__u8
 
	mvîsi⁄
;

80 
fs¸y±_pﬁicy_v1
 
	mv1
;

81 
fs¸y±_pﬁicy_v2
 
	mv2
;

82 } 
	mpﬁicy
;

89 
	#FSCRYPT_KEY_SPEC_TYPE_DESCRIPTOR
 1

	)

96 
	#FSCRYPT_KEY_SPEC_TYPE_IDENTIFIER
 2

	)

102 
	sfs¸y±_key_•ecifõr
 {

103 
__u32
 
	mty≥
;

104 
__u32
 
	m__ª£rved
;

106 
__u8
 
	m__ª£rved
[32];

107 
__u8
 
	mdes¸ùt‹
[
FSCRYPT_KEY_DESCRIPTOR_SIZE
];

108 
__u8
 
	midítifõr
[
FSCRYPT_KEY_IDENTIFIER_SIZE
];

109 } 
	mu
;

116 
	sfs¸y±_¥ovisi⁄ög_key_∑ylﬂd
 {

117 
__u32
 
	mty≥
;

118 
__u32
 
	m__ª£rved
;

119 
__u8
 
	møw
[];

123 
	sfs¸y±_add_key_¨g
 {

124 
fs¸y±_key_•ecifõr
 
	mkey_•ec
;

125 
__u32
 
	møw_size
;

126 
__u32
 
	mkey_id
;

127 
__u32
 
	m__ª£rved
[8];

128 
__u8
 
	møw
[];

132 
	sfs¸y±_ªmove_key_¨g
 {

133 
fs¸y±_key_•ecifõr
 
	mkey_•ec
;

134 
	#FSCRYPT_KEY_REMOVAL_STATUS_FLAG_FILES_BUSY
 0x00000001

	)

135 
	#FSCRYPT_KEY_REMOVAL_STATUS_FLAG_OTHER_USERS
 0x00000002

	)

136 
__u32
 
	mªmovÆ_°©us_Êags
;

137 
__u32
 
	m__ª£rved
[5];

141 
	sfs¸y±_gë_key_°©us_¨g
 {

143 
fs¸y±_key_•ecifõr
 
	mkey_•ec
;

144 
__u32
 
	m__ª£rved
[6];

147 
	#FSCRYPT_KEY_STATUS_ABSENT
 1

	)

148 
	#FSCRYPT_KEY_STATUS_PRESENT
 2

	)

149 
	#FSCRYPT_KEY_STATUS_INCOMPLETELY_REMOVED
 3

	)

150 
__u32
 
	m°©us
;

151 
	#FSCRYPT_KEY_STATUS_FLAG_ADDED_BY_SELF
 0x00000001

	)

152 
__u32
 
	m°©us_Êags
;

153 
__u32
 
	mu£r_cou¡
;

154 
__u32
 
	m__out_ª£rved
[13];

157 
	#FS_IOC_SET_ENCRYPTION_POLICY
 
	`_IOR
('f', 19, 
fs¸y±_pﬁicy_v1
)

	)

158 
	#FS_IOC_GET_ENCRYPTION_PWSALT
 
	`_IOW
('f', 20, 
__u8
[16])

	)

159 
	#FS_IOC_GET_ENCRYPTION_POLICY
 
	`_IOW
('f', 21, 
fs¸y±_pﬁicy_v1
)

	)

160 
	#FS_IOC_GET_ENCRYPTION_POLICY_EX
 
	`_IOWR
('f', 22, 
__u8
[9]Ë

	)

161 
	#FS_IOC_ADD_ENCRYPTION_KEY
 
	`_IOWR
('f', 23, 
fs¸y±_add_key_¨g
)

	)

162 
	#FS_IOC_REMOVE_ENCRYPTION_KEY
 
	`_IOWR
('f', 24, 
fs¸y±_ªmove_key_¨g
)

	)

163 
	#FS_IOC_REMOVE_ENCRYPTION_KEY_ALL_USERS
 
	`_IOWR
('f', 25, 
fs¸y±_ªmove_key_¨g
)

	)

164 
	#FS_IOC_GET_ENCRYPTION_KEY_STATUS
 
	`_IOWR
('f', 26, 
fs¸y±_gë_key_°©us_¨g
)

	)

165 
	#FS_IOC_GET_ENCRYPTION_NONCE
 
	`_IOR
('f', 27, 
__u8
[16])

	)

170 
	#fs¸y±_pﬁicy
 
fs¸y±_pﬁicy_v1


	)

171 
	#FS_KEY_DESCRIPTOR_SIZE
 
FSCRYPT_KEY_DESCRIPTOR_SIZE


	)

172 
	#FS_POLICY_FLAGS_PAD_4
 
FSCRYPT_POLICY_FLAGS_PAD_4


	)

173 
	#FS_POLICY_FLAGS_PAD_8
 
FSCRYPT_POLICY_FLAGS_PAD_8


	)

174 
	#FS_POLICY_FLAGS_PAD_16
 
FSCRYPT_POLICY_FLAGS_PAD_16


	)

175 
	#FS_POLICY_FLAGS_PAD_32
 
FSCRYPT_POLICY_FLAGS_PAD_32


	)

176 
	#FS_POLICY_FLAGS_PAD_MASK
 
FSCRYPT_POLICY_FLAGS_PAD_MASK


	)

177 
	#FS_POLICY_FLAG_DIRECT_KEY
 
FSCRYPT_POLICY_FLAG_DIRECT_KEY


	)

178 
	#FS_POLICY_FLAGS_VALID
 0x07

	)

179 
	#FS_ENCRYPTION_MODE_INVALID
 0

	)

180 
	#FS_ENCRYPTION_MODE_AES_256_XTS
 
FSCRYPT_MODE_AES_256_XTS


	)

181 
	#FS_ENCRYPTION_MODE_AES_256_GCM
 2

	)

182 
	#FS_ENCRYPTION_MODE_AES_256_CBC
 3

	)

183 
	#FS_ENCRYPTION_MODE_AES_256_CTS
 
FSCRYPT_MODE_AES_256_CTS


	)

184 
	#FS_ENCRYPTION_MODE_AES_128_CBC
 
FSCRYPT_MODE_AES_128_CBC


	)

185 
	#FS_ENCRYPTION_MODE_AES_128_CTS
 
FSCRYPT_MODE_AES_128_CTS


	)

186 
	#FS_ENCRYPTION_MODE_SPECK128_256_XTS
 7

	)

187 
	#FS_ENCRYPTION_MODE_SPECK128_256_CTS
 8

	)

188 
	#FS_ENCRYPTION_MODE_ADIANTUM
 
FSCRYPT_MODE_ADIANTUM


	)

189 
	#FS_KEY_DESC_PREFIX
 
FSCRYPT_KEY_DESC_PREFIX


	)

190 
	#FS_KEY_DESC_PREFIX_SIZE
 
FSCRYPT_KEY_DESC_PREFIX_SIZE


	)

191 
	#FS_MAX_KEY_SIZE
 
FSCRYPT_MAX_KEY_SIZE


	)

	@/usr/include/linux/if.h

20 #i‚de‡
_LINUX_IF_H


21 
	#_LINUX_IF_H


	)

23 
	~<löux/libc-com∑t.h
>

24 
	~<löux/ty≥s.h
>

25 
	~<löux/sockë.h
>

28 
	~<sys/sockë.h
>

30 #i‡
__UAPI_DEF_IF_IFNAMSIZ


31 
	#IFNAMSIZ
 16

	)

33 
	#IFALIASZ
 256

	)

34 
	#ALTIFNAMSIZ
 128

	)

35 
	~<löux/hdlc/io˘l.h
>

38 #i‡
__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 != 0 || \

39 
	g__UAPI_DEF_IF_NET_DEVICE_FLAGS
 != 0

80 
	e√t_devi˚_Êags
 {

82 #i‡
__UAPI_DEF_IF_NET_DEVICE_FLAGS


83 
IFF_UP
 = 1<<0,

84 
	mIFF_BROADCAST
 = 1<<1,

85 
	mIFF_DEBUG
 = 1<<2,

86 
	mIFF_LOOPBACK
 = 1<<3,

87 
	mIFF_POINTOPOINT
 = 1<<4,

88 
	mIFF_NOTRAILERS
 = 1<<5,

89 
	mIFF_RUNNING
 = 1<<6,

90 
	mIFF_NOARP
 = 1<<7,

91 
	mIFF_PROMISC
 = 1<<8,

92 
	mIFF_ALLMULTI
 = 1<<9,

93 
	mIFF_MASTER
 = 1<<10,

94 
	mIFF_SLAVE
 = 1<<11,

95 
	mIFF_MULTICAST
 = 1<<12,

96 
	mIFF_PORTSEL
 = 1<<13,

97 
	mIFF_AUTOMEDIA
 = 1<<14,

98 
	mIFF_DYNAMIC
 = 1<<15,

100 #i‡
__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO


101 
	mIFF_LOWER_UP
 = 1<<16,

102 
	mIFF_DORMANT
 = 1<<17,

103 
	mIFF_ECHO
 = 1<<18,

109 #i‡
__UAPI_DEF_IF_NET_DEVICE_FLAGS


110 
	#IFF_UP
 
IFF_UP


	)

111 
	#IFF_BROADCAST
 
IFF_BROADCAST


	)

112 
	#IFF_DEBUG
 
IFF_DEBUG


	)

113 
	#IFF_LOOPBACK
 
IFF_LOOPBACK


	)

114 
	#IFF_POINTOPOINT
 
IFF_POINTOPOINT


	)

115 
	#IFF_NOTRAILERS
 
IFF_NOTRAILERS


	)

116 
	#IFF_RUNNING
 
IFF_RUNNING


	)

117 
	#IFF_NOARP
 
IFF_NOARP


	)

118 
	#IFF_PROMISC
 
IFF_PROMISC


	)

119 
	#IFF_ALLMULTI
 
IFF_ALLMULTI


	)

120 
	#IFF_MASTER
 
IFF_MASTER


	)

121 
	#IFF_SLAVE
 
IFF_SLAVE


	)

122 
	#IFF_MULTICAST
 
IFF_MULTICAST


	)

123 
	#IFF_PORTSEL
 
IFF_PORTSEL


	)

124 
	#IFF_AUTOMEDIA
 
IFF_AUTOMEDIA


	)

125 
	#IFF_DYNAMIC
 
IFF_DYNAMIC


	)

128 #i‡
__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO


129 
	#IFF_LOWER_UP
 
IFF_LOWER_UP


	)

130 
	#IFF_DORMANT
 
IFF_DORMANT


	)

131 
	#IFF_ECHO
 
IFF_ECHO


	)

134 
	#IFF_VOLATILE
 (
IFF_LOOPBACK
|
IFF_POINTOPOINT
|
IFF_BROADCAST
|
IFF_ECHO
|\

135 
IFF_MASTER
|
IFF_SLAVE
|
IFF_RUNNING
|
IFF_LOWER_UP
|
IFF_DORMANT
)

	)

137 
	#IF_GET_IFACE
 0x0001

	)

138 
	#IF_GET_PROTO
 0x0002

	)

141 
	#IF_IFACE_V35
 0x1000

	)

142 
	#IF_IFACE_V24
 0x1001

	)

143 
	#IF_IFACE_X21
 0x1002

	)

144 
	#IF_IFACE_T1
 0x1003

	)

145 
	#IF_IFACE_E1
 0x1004

	)

146 
	#IF_IFACE_SYNC_SERIAL
 0x1005

	)

147 
	#IF_IFACE_X21D
 0x1006

	)

150 
	#IF_PROTO_HDLC
 0x2000

	)

151 
	#IF_PROTO_PPP
 0x2001

	)

152 
	#IF_PROTO_CISCO
 0x2002

	)

153 
	#IF_PROTO_FR
 0x2003

	)

154 
	#IF_PROTO_FR_ADD_PVC
 0x2004

	)

155 
	#IF_PROTO_FR_DEL_PVC
 0x2005

	)

156 
	#IF_PROTO_X25
 0x2006

	)

157 
	#IF_PROTO_HDLC_ETH
 0x2007

	)

158 
	#IF_PROTO_FR_ADD_ETH_PVC
 0x2008

	)

159 
	#IF_PROTO_FR_DEL_ETH_PVC
 0x2009

	)

160 
	#IF_PROTO_FR_PVC
 0x200A

	)

161 
	#IF_PROTO_FR_ETH_PVC
 0x200B

	)

162 
	#IF_PROTO_RAW
 0x200C

	)

166 
	mIF_OPER_UNKNOWN
,

167 
	mIF_OPER_NOTPRESENT
,

168 
	mIF_OPER_DOWN
,

169 
	mIF_OPER_LOWERLAYERDOWN
,

170 
	mIF_OPER_TESTING
,

171 
	mIF_OPER_DORMANT
,

172 
	mIF_OPER_UP
,

177 
	mIF_LINK_MODE_DEFAULT
,

178 
	mIF_LINK_MODE_DORMANT
,

179 
	mIF_LINK_MODE_TESTING
,

193 #i‡
__UAPI_DEF_IF_IFMAP


194 
	sifm≠
 {

195 
	mmem_°¨t
;

196 
	mmem_íd
;

197 
	mba£_addr
;

198 
	múq
;

199 
	mdma
;

200 
	mp‹t
;

205 
	sif_£âögs
 {

206 
	mty≥
;

207 
	msize
;

210 
øw_hdlc_¥Ÿo
 *
	møw_hdlc
;

211 
cisco_¥Ÿo
 *
	mcisco
;

212 
‰_¥Ÿo
 *
	m‰
;

213 
‰_¥Ÿo_pvc
 *
	m‰_pvc
;

214 
‰_¥Ÿo_pvc_öfo
 *
	m‰_pvc_öfo
;

215 
x25_hdlc_¥Ÿo
 *
	mx25
;

218 
sync_£rül_£âögs
 *
	msync
;

219 
ã1_£âögs
 *
	mã1
;

220 } 
	mifs_ifsu
;

231 #i‡
__UAPI_DEF_IF_IFREQ


232 
	si‰eq
 {

233 
	#IFHWADDRLEN
 6

	)

236 
	mi‰n_«me
[
IFNAMSIZ
];

237 } 
	mi‰_i‰n
;

240 
sockaddr
 
	mi‰u_addr
;

241 
sockaddr
 
	mi‰u_d°addr
;

242 
sockaddr
 
	mi‰u_brﬂdaddr
;

243 
sockaddr
 
	mi‰u_√tmask
;

244 
sockaddr
 
	mi‰u_hwaddr
;

245 
	mi‰u_Êags
;

246 
	mi‰u_ivÆue
;

247 
	mi‰u_mtu
;

248 
ifm≠
 
	mi‰u_m≠
;

249 
	mi‰u_¶ave
[
IFNAMSIZ
];

250 
	mi‰u_√w«me
[
IFNAMSIZ
];

251 * 
	mi‰u_d©a
;

252 
if_£âögs
 
	mi‰u_£âögs
;

253 } 
	mi‰_i‰u
;

257 
	#i‰_«me
 
i‰_i‰n
.
i‰n_«me


	)

258 
	#i‰_hwaddr
 
i‰_i‰u
.
i‰u_hwaddr


	)

259 
	#i‰_addr
 
i‰_i‰u
.
i‰u_addr


	)

260 
	#i‰_d°addr
 
i‰_i‰u
.
i‰u_d°addr


	)

261 
	#i‰_brﬂdaddr
 
i‰_i‰u
.
i‰u_brﬂdaddr


	)

262 
	#i‰_√tmask
 
i‰_i‰u
.
i‰u_√tmask


	)

263 
	#i‰_Êags
 
i‰_i‰u
.
i‰u_Êags


	)

264 
	#i‰_mëric
 
i‰_i‰u
.
i‰u_ivÆue


	)

265 
	#i‰_mtu
 
i‰_i‰u
.
i‰u_mtu


	)

266 
	#i‰_m≠
 
i‰_i‰u
.
i‰u_m≠


	)

267 
	#i‰_¶ave
 
i‰_i‰u
.
i‰u_¶ave


	)

268 
	#i‰_d©a
 
i‰_i‰u
.
i‰u_d©a


	)

269 
	#i‰_ifödex
 
i‰_i‰u
.
i‰u_ivÆue


	)

270 
	#i‰_b™dwidth
 
i‰_i‰u
.
i‰u_ivÆue


	)

271 
	#i‰_qÀn
 
i‰_i‰u
.
i‰u_ivÆue


	)

272 
	#i‰_√w«me
 
i‰_i‰u
.
i‰u_√w«me


	)

273 
	#i‰_£âögs
 
i‰_i‰u
.
i‰u_£âögs


	)

283 #i‡
__UAPI_DEF_IF_IFCONF


284 
	sifc⁄f
 {

285 
	mifc_Àn
;

287 *
	mifcu_buf
;

288 
i‰eq
 *
	mifcu_ªq
;

289 } 
	mifc_ifcu
;

293 
	#ifc_buf
 
ifc_ifcu
.
ifcu_buf


	)

294 
	#ifc_ªq
 
ifc_ifcu
.
ifcu_ªq


	)

	@/usr/include/linux/if_addr.h

2 #i‚de‡
__LINUX_IF_ADDR_H


3 
	#__LINUX_IF_ADDR_H


	)

5 
	~<löux/ty≥s.h
>

6 
	~<löux/√éök.h
>

8 
	siÁddrmsg
 {

9 
__u8
 
	miÁ_Ámûy
;

10 
__u8
 
	miÁ_¥efixÀn
;

11 
__u8
 
	miÁ_Êags
;

12 
__u8
 
	miÁ_sc›e
;

13 
__u32
 
	miÁ_ödex
;

27 
	mIFA_UNSPEC
,

28 
	mIFA_ADDRESS
,

29 
	mIFA_LOCAL
,

30 
	mIFA_LABEL
,

31 
	mIFA_BROADCAST
,

32 
	mIFA_ANYCAST
,

33 
	mIFA_CACHEINFO
,

34 
	mIFA_MULTICAST
,

35 
	mIFA_FLAGS
,

36 
	mIFA_RT_PRIORITY
,

37 
	mIFA_TARGET_NETNSID
,

38 
	m__IFA_MAX
,

41 
	#IFA_MAX
 (
__IFA_MAX
 - 1)

	)

44 
	#IFA_F_SECONDARY
 0x01

	)

45 
	#IFA_F_TEMPORARY
 
IFA_F_SECONDARY


	)

47 
	#IFA_F_NODAD
 0x02

	)

48 
	#IFA_F_OPTIMISTIC
 0x04

	)

49 
	#IFA_F_DADFAILED
 0x08

	)

50 
	#IFA_F_HOMEADDRESS
 0x10

	)

51 
	#IFA_F_DEPRECATED
 0x20

	)

52 
	#IFA_F_TENTATIVE
 0x40

	)

53 
	#IFA_F_PERMANENT
 0x80

	)

54 
	#IFA_F_MANAGETEMPADDR
 0x100

	)

55 
	#IFA_F_NOPREFIXROUTE
 0x200

	)

56 
	#IFA_F_MCAUTOJOIN
 0x400

	)

57 
	#IFA_F_STABLE_PRIVACY
 0x800

	)

59 
	siÁ_ˇcheöfo
 {

60 
__u32
 
	miÁ_¥e„ªd
;

61 
__u32
 
	miÁ_vÆid
;

62 
__u32
 
	mc°amp
;

63 
__u32
 
	mt°amp
;

67 
	#IFA_RTA
(
r
Ë((
π©å
*)(((*)‘)Ë+ 
	`NLMSG_ALIGN
((
iÁddrmsg
))))

	)

68 
	#IFA_PAYLOAD
(
n
Ë
	`NLMSG_PAYLOAD
“,(
iÁddrmsg
))

	)

	@/usr/include/linux/if_ether.h

22 #i‚de‡
_LINUX_IF_ETHER_H


23 
	#_LINUX_IF_ETHER_H


	)

25 
	~<löux/ty≥s.h
>

32 
	#ETH_ALEN
 6

	)

33 
	#ETH_TLEN
 2

	)

34 
	#ETH_HLEN
 14

	)

35 
	#ETH_ZLEN
 60

	)

36 
	#ETH_DATA_LEN
 1500

	)

37 
	#ETH_FRAME_LEN
 1514

	)

38 
	#ETH_FCS_LEN
 4

	)

40 
	#ETH_MIN_MTU
 68

	)

41 
	#ETH_MAX_MTU
 0xFFFFU

	)

47 
	#ETH_P_LOOP
 0x0060

	)

48 
	#ETH_P_PUP
 0x0200

	)

49 
	#ETH_P_PUPAT
 0x0201

	)

50 
	#ETH_P_TSN
 0x22F0

	)

51 
	#ETH_P_ERSPAN2
 0x22EB

	)

52 
	#ETH_P_IP
 0x0800

	)

53 
	#ETH_P_X25
 0x0805

	)

54 
	#ETH_P_ARP
 0x0806

	)

55 
	#ETH_P_BPQ
 0x08FF

	)

56 
	#ETH_P_IEEEPUP
 0x0a00

	)

57 
	#ETH_P_IEEEPUPAT
 0x0a01

	)

58 
	#ETH_P_BATMAN
 0x4305

	)

59 
	#ETH_P_DEC
 0x6000

	)

60 
	#ETH_P_DNA_DL
 0x6001

	)

61 
	#ETH_P_DNA_RC
 0x6002

	)

62 
	#ETH_P_DNA_RT
 0x6003

	)

63 
	#ETH_P_LAT
 0x6004

	)

64 
	#ETH_P_DIAG
 0x6005

	)

65 
	#ETH_P_CUST
 0x6006

	)

66 
	#ETH_P_SCA
 0x6007

	)

67 
	#ETH_P_TEB
 0x6558

	)

68 
	#ETH_P_RARP
 0x8035

	)

69 
	#ETH_P_ATALK
 0x809B

	)

70 
	#ETH_P_AARP
 0x80F3

	)

71 
	#ETH_P_8021Q
 0x8100

	)

72 
	#ETH_P_ERSPAN
 0x88BE

	)

73 
	#ETH_P_IPX
 0x8137

	)

74 
	#ETH_P_IPV6
 0x86DD

	)

75 
	#ETH_P_PAUSE
 0x8808

	)

76 
	#ETH_P_SLOW
 0x8809

	)

77 
	#ETH_P_WCCP
 0x883E

	)

79 
	#ETH_P_MPLS_UC
 0x8847

	)

80 
	#ETH_P_MPLS_MC
 0x8848

	)

81 
	#ETH_P_ATMMPOA
 0x884¯

	)

82 
	#ETH_P_PPP_DISC
 0x8863

	)

83 
	#ETH_P_PPP_SES
 0x8864

	)

84 
	#ETH_P_LINK_CTL
 0x886¯

	)

85 
	#ETH_P_ATMFATE
 0x8884

	)

88 
	#ETH_P_PAE
 0x888E

	)

89 
	#ETH_P_AOE
 0x88A2

	)

90 
	#ETH_P_8021AD
 0x88A8

	)

91 
	#ETH_P_802_EX1
 0x88B5

	)

92 
	#ETH_P_PREAUTH
 0x88C7

	)

93 
	#ETH_P_TIPC
 0x88CA

	)

94 
	#ETH_P_LLDP
 0x88CC

	)

95 
	#ETH_P_MRP
 0x88E3

	)

96 
	#ETH_P_MACSEC
 0x88E5

	)

97 
	#ETH_P_8021AH
 0x88E7

	)

98 
	#ETH_P_MVRP
 0x88F5

	)

99 
	#ETH_P_1588
 0x88F7

	)

100 
	#ETH_P_NCSI
 0x88F8

	)

101 
	#ETH_P_PRP
 0x88FB

	)

102 
	#ETH_P_CFM
 0x8902

	)

103 
	#ETH_P_FCOE
 0x8906

	)

104 
	#ETH_P_IBOE
 0x8915

	)

105 
	#ETH_P_TDLS
 0x890D

	)

106 
	#ETH_P_FIP
 0x8914

	)

107 
	#ETH_P_80221
 0x8917

	)

108 
	#ETH_P_HSR
 0x892F

	)

109 
	#ETH_P_NSH
 0x894F

	)

110 
	#ETH_P_LOOPBACK
 0x9000

	)

111 
	#ETH_P_QINQ1
 0x9100

	)

112 
	#ETH_P_QINQ2
 0x9200

	)

113 
	#ETH_P_QINQ3
 0x9300

	)

114 
	#ETH_P_EDSA
 0xDADA

	)

115 
	#ETH_P_DSA_8021Q
 0xDADB

	)

116 
	#ETH_P_IFE
 0xED3E

	)

117 
	#ETH_P_AF_IUCV
 0xFBFB

	)

119 
	#ETH_P_802_3_MIN
 0x0600

	)

126 
	#ETH_P_802_3
 0x0001

	)

127 
	#ETH_P_AX25
 0x0002

	)

128 
	#ETH_P_ALL
 0x0003

	)

129 
	#ETH_P_802_2
 0x0004

	)

130 
	#ETH_P_SNAP
 0x0005

	)

131 
	#ETH_P_DDCMP
 0x0006

	)

132 
	#ETH_P_WAN_PPP
 0x0007

	)

133 
	#ETH_P_PPP_MP
 0x0008

	)

134 
	#ETH_P_LOCALTALK
 0x0009

	)

135 
	#ETH_P_CAN
 0x000C

	)

136 
	#ETH_P_CANFD
 0x000D

	)

137 
	#ETH_P_PPPTALK
 0x0010

	)

138 
	#ETH_P_TR_802_2
 0x0011

	)

139 
	#ETH_P_MOBITEX
 0x0015

	)

140 
	#ETH_P_CONTROL
 0x0016

	)

141 
	#ETH_P_IRDA
 0x0017

	)

142 
	#ETH_P_ECONET
 0x0018

	)

143 
	#ETH_P_HDLC
 0x0019

	)

144 
	#ETH_P_ARCNET
 0x001A

	)

145 
	#ETH_P_DSA
 0x001B

	)

146 
	#ETH_P_TRAILER
 0x001C

	)

147 
	#ETH_P_PHONET
 0x00F5

	)

148 
	#ETH_P_IEEE802154
 0x00F6

	)

149 
	#ETH_P_CAIF
 0x00F7

	)

150 
	#ETH_P_XDSA
 0x00F8

	)

151 
	#ETH_P_MAP
 0x00F9

	)

154 
	#ETH_P_MCTP
 0x00FA

	)

163 #i‚de‡
__UAPI_DEF_ETHHDR


164 
	#__UAPI_DEF_ETHHDR
 1

	)

167 #i‡
__UAPI_DEF_ETHHDR


168 
	sëhhdr
 {

169 
	mh_de°
[
ETH_ALEN
];

170 
	mh_sour˚
[
ETH_ALEN
];

171 
__be16
 
	mh_¥Ÿo
;

172 } 
__©åibuã__
((
∑cked
));

	@/usr/include/linux/if_link.h

2 #i‚de‡
_LINUX_IF_LINK_H


3 
	#_LINUX_IF_LINK_H


	)

5 
	~<löux/ty≥s.h
>

6 
	~<löux/√éök.h
>

9 
	sπ∆_lök_°©s
 {

10 
__u32
 
	mrx_∑ckës
;

11 
__u32
 
	mtx_∑ckës
;

12 
__u32
 
	mrx_byãs
;

13 
__u32
 
	mtx_byãs
;

14 
__u32
 
	mrx_îr‹s
;

15 
__u32
 
	mtx_îr‹s
;

16 
__u32
 
	mrx_dr›≥d
;

17 
__u32
 
	mtx_dr›≥d
;

18 
__u32
 
	mmu…iˇ°
;

19 
__u32
 
	mcﬁlisi⁄s
;

21 
__u32
 
	mrx_Àngth_îr‹s
;

22 
__u32
 
	mrx_ovî_îr‹s
;

23 
__u32
 
	mrx_¸c_îr‹s
;

24 
__u32
 
	mrx_‰ame_îr‹s
;

25 
__u32
 
	mrx_fifo_îr‹s
;

26 
__u32
 
	mrx_mis£d_îr‹s
;

29 
__u32
 
	mtx_ab‹ãd_îr‹s
;

30 
__u32
 
	mtx_ˇºõr_îr‹s
;

31 
__u32
 
	mtx_fifo_îr‹s
;

32 
__u32
 
	mtx_hóπbót_îr‹s
;

33 
__u32
 
	mtx_wödow_îr‹s
;

36 
__u32
 
	mrx_com¥es£d
;

37 
__u32
 
	mtx_com¥es£d
;

39 
__u32
 
	mrx_noh™dÀr
;

215 
	sπ∆_lök_°©s64
 {

216 
__u64
 
	mrx_∑ckës
;

217 
__u64
 
	mtx_∑ckës
;

218 
__u64
 
	mrx_byãs
;

219 
__u64
 
	mtx_byãs
;

220 
__u64
 
	mrx_îr‹s
;

221 
__u64
 
	mtx_îr‹s
;

222 
__u64
 
	mrx_dr›≥d
;

223 
__u64
 
	mtx_dr›≥d
;

224 
__u64
 
	mmu…iˇ°
;

225 
__u64
 
	mcﬁlisi⁄s
;

228 
__u64
 
	mrx_Àngth_îr‹s
;

229 
__u64
 
	mrx_ovî_îr‹s
;

230 
__u64
 
	mrx_¸c_îr‹s
;

231 
__u64
 
	mrx_‰ame_îr‹s
;

232 
__u64
 
	mrx_fifo_îr‹s
;

233 
__u64
 
	mrx_mis£d_îr‹s
;

236 
__u64
 
	mtx_ab‹ãd_îr‹s
;

237 
__u64
 
	mtx_ˇºõr_îr‹s
;

238 
__u64
 
	mtx_fifo_îr‹s
;

239 
__u64
 
	mtx_hóπbót_îr‹s
;

240 
__u64
 
	mtx_wödow_îr‹s
;

243 
__u64
 
	mrx_com¥es£d
;

244 
__u64
 
	mtx_com¥es£d
;

245 
__u64
 
	mrx_noh™dÀr
;

249 
	sπ∆_lök_ifm≠
 {

250 
__u64
 
	mmem_°¨t
;

251 
__u64
 
	mmem_íd
;

252 
__u64
 
	mba£_addr
;

253 
__u16
 
	múq
;

254 
__u8
 
	mdma
;

255 
__u8
 
	mp‹t
;

277 
	mIFLA_UNSPEC
,

278 
	mIFLA_ADDRESS
,

279 
	mIFLA_BROADCAST
,

280 
	mIFLA_IFNAME
,

281 
	mIFLA_MTU
,

282 
	mIFLA_LINK
,

283 
	mIFLA_QDISC
,

284 
	mIFLA_STATS
,

285 
	mIFLA_COST
,

286 
	#IFLA_COST
 
IFLA_COST


	)

287 
	mIFLA_PRIORITY
,

288 
	#IFLA_PRIORITY
 
IFLA_PRIORITY


	)

289 
	mIFLA_MASTER
,

290 
	#IFLA_MASTER
 
IFLA_MASTER


	)

291 
	mIFLA_WIRELESS
,

292 
	#IFLA_WIRELESS
 
IFLA_WIRELESS


	)

293 
	mIFLA_PROTINFO
,

294 
	#IFLA_PROTINFO
 
IFLA_PROTINFO


	)

295 
	mIFLA_TXQLEN
,

296 
	#IFLA_TXQLEN
 
IFLA_TXQLEN


	)

297 
	mIFLA_MAP
,

298 
	#IFLA_MAP
 
IFLA_MAP


	)

299 
	mIFLA_WEIGHT
,

300 
	#IFLA_WEIGHT
 
IFLA_WEIGHT


	)

301 
	mIFLA_OPERSTATE
,

302 
	mIFLA_LINKMODE
,

303 
	mIFLA_LINKINFO
,

304 
	#IFLA_LINKINFO
 
IFLA_LINKINFO


	)

305 
	mIFLA_NET_NS_PID
,

306 
	mIFLA_IFALIAS
,

307 
	mIFLA_NUM_VF
,

308 
	mIFLA_VFINFO_LIST
,

309 
	mIFLA_STATS64
,

310 
	mIFLA_VF_PORTS
,

311 
	mIFLA_PORT_SELF
,

312 
	mIFLA_AF_SPEC
,

313 
	mIFLA_GROUP
,

314 
	mIFLA_NET_NS_FD
,

315 
	mIFLA_EXT_MASK
,

316 
	mIFLA_PROMISCUITY
,

317 
	#IFLA_PROMISCUITY
 
IFLA_PROMISCUITY


	)

318 
	mIFLA_NUM_TX_QUEUES
,

319 
	mIFLA_NUM_RX_QUEUES
,

320 
	mIFLA_CARRIER
,

321 
	mIFLA_PHYS_PORT_ID
,

322 
	mIFLA_CARRIER_CHANGES
,

323 
	mIFLA_PHYS_SWITCH_ID
,

324 
	mIFLA_LINK_NETNSID
,

325 
	mIFLA_PHYS_PORT_NAME
,

326 
	mIFLA_PROTO_DOWN
,

327 
	mIFLA_GSO_MAX_SEGS
,

328 
	mIFLA_GSO_MAX_SIZE
,

329 
	mIFLA_PAD
,

330 
	mIFLA_XDP
,

331 
	mIFLA_EVENT
,

332 
	mIFLA_NEW_NETNSID
,

333 
	mIFLA_IF_NETNSID
,

334 
	mIFLA_TARGET_NETNSID
 = 
IFLA_IF_NETNSID
,

335 
	mIFLA_CARRIER_UP_COUNT
,

336 
	mIFLA_CARRIER_DOWN_COUNT
,

337 
	mIFLA_NEW_IFINDEX
,

338 
	mIFLA_MIN_MTU
,

339 
	mIFLA_MAX_MTU
,

340 
	mIFLA_PROP_LIST
,

341 
	mIFLA_ALT_IFNAME
,

342 
	mIFLA_PERM_ADDRESS
,

343 
	mIFLA_PROTO_DOWN_REASON
,

348 
	mIFLA_PARENT_DEV_NAME
,

349 
	mIFLA_PARENT_DEV_BUS_NAME
,

351 
	m__IFLA_MAX


355 
	#IFLA_MAX
 (
__IFLA_MAX
 - 1)

	)

358 
	mIFLA_PROTO_DOWN_REASON_UNSPEC
,

359 
	mIFLA_PROTO_DOWN_REASON_MASK
,

360 
	mIFLA_PROTO_DOWN_REASON_VALUE
,

362 
	m__IFLA_PROTO_DOWN_REASON_CNT
,

363 
	mIFLA_PROTO_DOWN_REASON_MAX
 = 
__IFLA_PROTO_DOWN_REASON_CNT
 - 1

367 
	#IFLA_RTA
(
r
Ë((
π©å
*)(((*)‘)Ë+ 
	`NLMSG_ALIGN
((
iföfomsg
))))

	)

368 
	#IFLA_PAYLOAD
(
n
Ë
	`NLMSG_PAYLOAD
“,(
iföfomsg
))

	)

371 
	mIFLA_INET_UNSPEC
,

372 
	mIFLA_INET_CONF
,

373 
	m__IFLA_INET_MAX
,

376 
	#IFLA_INET_MAX
 (
__IFLA_INET_MAX
 - 1)

	)

409 
	mIFLA_INET6_UNSPEC
,

410 
	mIFLA_INET6_FLAGS
,

411 
	mIFLA_INET6_CONF
,

412 
	mIFLA_INET6_STATS
,

413 
	mIFLA_INET6_MCAST
,

414 
	mIFLA_INET6_CACHEINFO
,

415 
	mIFLA_INET6_ICMP6STATS
,

416 
	mIFLA_INET6_TOKEN
,

417 
	mIFLA_INET6_ADDR_GEN_MODE
,

418 
	mIFLA_INET6_RA_MTU
,

419 
	m__IFLA_INET6_MAX


422 
	#IFLA_INET6_MAX
 (
__IFLA_INET6_MAX
 - 1)

	)

424 
	eö6_addr_gí_mode
 {

425 
	mIN6_ADDR_GEN_MODE_EUI64
,

426 
	mIN6_ADDR_GEN_MODE_NONE
,

427 
	mIN6_ADDR_GEN_MODE_STABLE_PRIVACY
,

428 
	mIN6_ADDR_GEN_MODE_RANDOM
,

434 
	mIFLA_BR_UNSPEC
,

435 
	mIFLA_BR_FORWARD_DELAY
,

436 
	mIFLA_BR_HELLO_TIME
,

437 
	mIFLA_BR_MAX_AGE
,

438 
	mIFLA_BR_AGEING_TIME
,

439 
	mIFLA_BR_STP_STATE
,

440 
	mIFLA_BR_PRIORITY
,

441 
	mIFLA_BR_VLAN_FILTERING
,

442 
	mIFLA_BR_VLAN_PROTOCOL
,

443 
	mIFLA_BR_GROUP_FWD_MASK
,

444 
	mIFLA_BR_ROOT_ID
,

445 
	mIFLA_BR_BRIDGE_ID
,

446 
	mIFLA_BR_ROOT_PORT
,

447 
	mIFLA_BR_ROOT_PATH_COST
,

448 
	mIFLA_BR_TOPOLOGY_CHANGE
,

449 
	mIFLA_BR_TOPOLOGY_CHANGE_DETECTED
,

450 
	mIFLA_BR_HELLO_TIMER
,

451 
	mIFLA_BR_TCN_TIMER
,

452 
	mIFLA_BR_TOPOLOGY_CHANGE_TIMER
,

453 
	mIFLA_BR_GC_TIMER
,

454 
	mIFLA_BR_GROUP_ADDR
,

455 
	mIFLA_BR_FDB_FLUSH
,

456 
	mIFLA_BR_MCAST_ROUTER
,

457 
	mIFLA_BR_MCAST_SNOOPING
,

458 
	mIFLA_BR_MCAST_QUERY_USE_IFADDR
,

459 
	mIFLA_BR_MCAST_QUERIER
,

460 
	mIFLA_BR_MCAST_HASH_ELASTICITY
,

461 
	mIFLA_BR_MCAST_HASH_MAX
,

462 
	mIFLA_BR_MCAST_LAST_MEMBER_CNT
,

463 
	mIFLA_BR_MCAST_STARTUP_QUERY_CNT
,

464 
	mIFLA_BR_MCAST_LAST_MEMBER_INTVL
,

465 
	mIFLA_BR_MCAST_MEMBERSHIP_INTVL
,

466 
	mIFLA_BR_MCAST_QUERIER_INTVL
,

467 
	mIFLA_BR_MCAST_QUERY_INTVL
,

468 
	mIFLA_BR_MCAST_QUERY_RESPONSE_INTVL
,

469 
	mIFLA_BR_MCAST_STARTUP_QUERY_INTVL
,

470 
	mIFLA_BR_NF_CALL_IPTABLES
,

471 
	mIFLA_BR_NF_CALL_IP6TABLES
,

472 
	mIFLA_BR_NF_CALL_ARPTABLES
,

473 
	mIFLA_BR_VLAN_DEFAULT_PVID
,

474 
	mIFLA_BR_PAD
,

475 
	mIFLA_BR_VLAN_STATS_ENABLED
,

476 
	mIFLA_BR_MCAST_STATS_ENABLED
,

477 
	mIFLA_BR_MCAST_IGMP_VERSION
,

478 
	mIFLA_BR_MCAST_MLD_VERSION
,

479 
	mIFLA_BR_VLAN_STATS_PER_PORT
,

480 
	mIFLA_BR_MULTI_BOOLOPT
,

481 
	mIFLA_BR_MCAST_QUERIER_STATE
,

482 
	m__IFLA_BR_MAX
,

485 
	#IFLA_BR_MAX
 (
__IFLA_BR_MAX
 - 1)

	)

487 
	siÊa_bridge_id
 {

488 
__u8
 
	m¥io
[2];

489 
__u8
 
	maddr
[6];

493 
	mBRIDGE_MODE_UNSPEC
,

494 
	mBRIDGE_MODE_HAIRPIN
,

498 
	mIFLA_BRPORT_UNSPEC
,

499 
	mIFLA_BRPORT_STATE
,

500 
	mIFLA_BRPORT_PRIORITY
,

501 
	mIFLA_BRPORT_COST
,

502 
	mIFLA_BRPORT_MODE
,

503 
	mIFLA_BRPORT_GUARD
,

504 
	mIFLA_BRPORT_PROTECT
,

505 
	mIFLA_BRPORT_FAST_LEAVE
,

506 
	mIFLA_BRPORT_LEARNING
,

507 
	mIFLA_BRPORT_UNICAST_FLOOD
,

508 
	mIFLA_BRPORT_PROXYARP
,

509 
	mIFLA_BRPORT_LEARNING_SYNC
,

510 
	mIFLA_BRPORT_PROXYARP_WIFI
,

511 
	mIFLA_BRPORT_ROOT_ID
,

512 
	mIFLA_BRPORT_BRIDGE_ID
,

513 
	mIFLA_BRPORT_DESIGNATED_PORT
,

514 
	mIFLA_BRPORT_DESIGNATED_COST
,

515 
	mIFLA_BRPORT_ID
,

516 
	mIFLA_BRPORT_NO
,

517 
	mIFLA_BRPORT_TOPOLOGY_CHANGE_ACK
,

518 
	mIFLA_BRPORT_CONFIG_PENDING
,

519 
	mIFLA_BRPORT_MESSAGE_AGE_TIMER
,

520 
	mIFLA_BRPORT_FORWARD_DELAY_TIMER
,

521 
	mIFLA_BRPORT_HOLD_TIMER
,

522 
	mIFLA_BRPORT_FLUSH
,

523 
	mIFLA_BRPORT_MULTICAST_ROUTER
,

524 
	mIFLA_BRPORT_PAD
,

525 
	mIFLA_BRPORT_MCAST_FLOOD
,

526 
	mIFLA_BRPORT_MCAST_TO_UCAST
,

527 
	mIFLA_BRPORT_VLAN_TUNNEL
,

528 
	mIFLA_BRPORT_BCAST_FLOOD
,

529 
	mIFLA_BRPORT_GROUP_FWD_MASK
,

530 
	mIFLA_BRPORT_NEIGH_SUPPRESS
,

531 
	mIFLA_BRPORT_ISOLATED
,

532 
	mIFLA_BRPORT_BACKUP_PORT
,

533 
	mIFLA_BRPORT_MRP_RING_OPEN
,

534 
	mIFLA_BRPORT_MRP_IN_OPEN
,

535 
	mIFLA_BRPORT_MCAST_EHT_HOSTS_LIMIT
,

536 
	mIFLA_BRPORT_MCAST_EHT_HOSTS_CNT
,

537 
	m__IFLA_BRPORT_MAX


539 
	#IFLA_BRPORT_MAX
 (
__IFLA_BRPORT_MAX
 - 1)

	)

541 
	siÊa_ˇcheöfo
 {

542 
__u32
 
	mmax_ªasm_Àn
;

543 
__u32
 
	mt°amp
;

544 
__u32
 
	mªachabÀ_time
;

545 
__u32
 
	mªå™s_time
;

549 
	mIFLA_INFO_UNSPEC
,

550 
	mIFLA_INFO_KIND
,

551 
	mIFLA_INFO_DATA
,

552 
	mIFLA_INFO_XSTATS
,

553 
	mIFLA_INFO_SLAVE_KIND
,

554 
	mIFLA_INFO_SLAVE_DATA
,

555 
	m__IFLA_INFO_MAX
,

558 
	#IFLA_INFO_MAX
 (
__IFLA_INFO_MAX
 - 1)

	)

563 
	mIFLA_VLAN_UNSPEC
,

564 
	mIFLA_VLAN_ID
,

565 
	mIFLA_VLAN_FLAGS
,

566 
	mIFLA_VLAN_EGRESS_QOS
,

567 
	mIFLA_VLAN_INGRESS_QOS
,

568 
	mIFLA_VLAN_PROTOCOL
,

569 
	m__IFLA_VLAN_MAX
,

572 
	#IFLA_VLAN_MAX
 (
__IFLA_VLAN_MAX
 - 1)

	)

574 
	siÊa_vœn_Êags
 {

575 
__u32
 
	mÊags
;

576 
__u32
 
	mmask
;

580 
	mIFLA_VLAN_QOS_UNSPEC
,

581 
	mIFLA_VLAN_QOS_MAPPING
,

582 
	m__IFLA_VLAN_QOS_MAX


585 
	#IFLA_VLAN_QOS_MAX
 (
__IFLA_VLAN_QOS_MAX
 - 1)

	)

587 
	siÊa_vœn_qos_m≠pög
 {

588 
__u32
 
	m‰om
;

589 
__u32
 
	mto
;

594 
	mIFLA_MACVLAN_UNSPEC
,

595 
	mIFLA_MACVLAN_MODE
,

596 
	mIFLA_MACVLAN_FLAGS
,

597 
	mIFLA_MACVLAN_MACADDR_MODE
,

598 
	mIFLA_MACVLAN_MACADDR
,

599 
	mIFLA_MACVLAN_MACADDR_DATA
,

600 
	mIFLA_MACVLAN_MACADDR_COUNT
,

601 
	mIFLA_MACVLAN_BC_QUEUE_LEN
,

602 
	mIFLA_MACVLAN_BC_QUEUE_LEN_USED
,

603 
	m__IFLA_MACVLAN_MAX
,

606 
	#IFLA_MACVLAN_MAX
 (
__IFLA_MACVLAN_MAX
 - 1)

	)

608 
	emacvœn_mode
 {

609 
	mMACVLAN_MODE_PRIVATE
 = 1,

610 
	mMACVLAN_MODE_VEPA
 = 2,

611 
	mMACVLAN_MODE_BRIDGE
 = 4,

612 
	mMACVLAN_MODE_PASSTHRU
 = 8,

613 
	mMACVLAN_MODE_SOURCE
 = 16,

616 
	emacvœn_maˇddr_mode
 {

617 
	mMACVLAN_MACADDR_ADD
,

618 
	mMACVLAN_MACADDR_DEL
,

619 
	mMACVLAN_MACADDR_FLUSH
,

620 
	mMACVLAN_MACADDR_SET
,

623 
	#MACVLAN_FLAG_NOPROMISC
 1

	)

624 
	#MACVLAN_FLAG_NODST
 2

	)

628 
	mIFLA_VRF_UNSPEC
,

629 
	mIFLA_VRF_TABLE
,

630 
	m__IFLA_VRF_MAX


633 
	#IFLA_VRF_MAX
 (
__IFLA_VRF_MAX
 - 1)

	)

636 
	mIFLA_VRF_PORT_UNSPEC
,

637 
	mIFLA_VRF_PORT_TABLE
,

638 
	m__IFLA_VRF_PORT_MAX


641 
	#IFLA_VRF_PORT_MAX
 (
__IFLA_VRF_PORT_MAX
 - 1)

	)

645 
	mIFLA_MACSEC_UNSPEC
,

646 
	mIFLA_MACSEC_SCI
,

647 
	mIFLA_MACSEC_PORT
,

648 
	mIFLA_MACSEC_ICV_LEN
,

649 
	mIFLA_MACSEC_CIPHER_SUITE
,

650 
	mIFLA_MACSEC_WINDOW
,

651 
	mIFLA_MACSEC_ENCODING_SA
,

652 
	mIFLA_MACSEC_ENCRYPT
,

653 
	mIFLA_MACSEC_PROTECT
,

654 
	mIFLA_MACSEC_INC_SCI
,

655 
	mIFLA_MACSEC_ES
,

656 
	mIFLA_MACSEC_SCB
,

657 
	mIFLA_MACSEC_REPLAY_PROTECT
,

658 
	mIFLA_MACSEC_VALIDATION
,

659 
	mIFLA_MACSEC_PAD
,

660 
	mIFLA_MACSEC_OFFLOAD
,

661 
	m__IFLA_MACSEC_MAX
,

664 
	#IFLA_MACSEC_MAX
 (
__IFLA_MACSEC_MAX
 - 1)

	)

668 
	mIFLA_XFRM_UNSPEC
,

669 
	mIFLA_XFRM_LINK
,

670 
	mIFLA_XFRM_IF_ID
,

671 
	m__IFLA_XFRM_MAX


674 
	#IFLA_XFRM_MAX
 (
__IFLA_XFRM_MAX
 - 1)

	)

676 
	emac£c_vÆid©i⁄_ty≥
 {

677 
	mMACSEC_VALIDATE_DISABLED
 = 0,

678 
	mMACSEC_VALIDATE_CHECK
 = 1,

679 
	mMACSEC_VALIDATE_STRICT
 = 2,

680 
	m__MACSEC_VALIDATE_END
,

681 
	mMACSEC_VALIDATE_MAX
 = 
__MACSEC_VALIDATE_END
 - 1,

684 
	emac£c_ofÊﬂd
 {

685 
	mMACSEC_OFFLOAD_OFF
 = 0,

686 
	mMACSEC_OFFLOAD_PHY
 = 1,

687 
	mMACSEC_OFFLOAD_MAC
 = 2,

688 
	m__MACSEC_OFFLOAD_END
,

689 
	mMACSEC_OFFLOAD_MAX
 = 
__MACSEC_OFFLOAD_END
 - 1,

694 
	mIFLA_IPVLAN_UNSPEC
,

695 
	mIFLA_IPVLAN_MODE
,

696 
	mIFLA_IPVLAN_FLAGS
,

697 
	m__IFLA_IPVLAN_MAX


700 
	#IFLA_IPVLAN_MAX
 (
__IFLA_IPVLAN_MAX
 - 1)

	)

702 
	eùvœn_mode
 {

703 
	mIPVLAN_MODE_L2
 = 0,

704 
	mIPVLAN_MODE_L3
,

705 
	mIPVLAN_MODE_L3S
,

706 
	mIPVLAN_MODE_MAX


709 
	#IPVLAN_F_PRIVATE
 0x01

	)

710 
	#IPVLAN_F_VEPA
 0x02

	)

714 
	mIFLA_VXLAN_UNSPEC
,

715 
	mIFLA_VXLAN_ID
,

716 
	mIFLA_VXLAN_GROUP
,

717 
	mIFLA_VXLAN_LINK
,

718 
	mIFLA_VXLAN_LOCAL
,

719 
	mIFLA_VXLAN_TTL
,

720 
	mIFLA_VXLAN_TOS
,

721 
	mIFLA_VXLAN_LEARNING
,

722 
	mIFLA_VXLAN_AGEING
,

723 
	mIFLA_VXLAN_LIMIT
,

724 
	mIFLA_VXLAN_PORT_RANGE
,

725 
	mIFLA_VXLAN_PROXY
,

726 
	mIFLA_VXLAN_RSC
,

727 
	mIFLA_VXLAN_L2MISS
,

728 
	mIFLA_VXLAN_L3MISS
,

729 
	mIFLA_VXLAN_PORT
,

730 
	mIFLA_VXLAN_GROUP6
,

731 
	mIFLA_VXLAN_LOCAL6
,

732 
	mIFLA_VXLAN_UDP_CSUM
,

733 
	mIFLA_VXLAN_UDP_ZERO_CSUM6_TX
,

734 
	mIFLA_VXLAN_UDP_ZERO_CSUM6_RX
,

735 
	mIFLA_VXLAN_REMCSUM_TX
,

736 
	mIFLA_VXLAN_REMCSUM_RX
,

737 
	mIFLA_VXLAN_GBP
,

738 
	mIFLA_VXLAN_REMCSUM_NOPARTIAL
,

739 
	mIFLA_VXLAN_COLLECT_METADATA
,

740 
	mIFLA_VXLAN_LABEL
,

741 
	mIFLA_VXLAN_GPE
,

742 
	mIFLA_VXLAN_TTL_INHERIT
,

743 
	mIFLA_VXLAN_DF
,

744 
	mIFLA_VXLAN_FAN_MAP
 = 33,

745 
	m__IFLA_VXLAN_MAX


747 
	#IFLA_VXLAN_MAX
 (
__IFLA_VXLAN_MAX
 - 1)

	)

749 
	siÊa_vxœn_p‹t_ønge
 {

750 
__be16
 
	mlow
;

751 
__be16
 
	mhigh
;

754 
	eiÊa_vxœn_df
 {

755 
	mVXLAN_DF_UNSET
 = 0,

756 
	mVXLAN_DF_SET
,

757 
	mVXLAN_DF_INHERIT
,

758 
	m__VXLAN_DF_END
,

759 
	mVXLAN_DF_MAX
 = 
__VXLAN_DF_END
 - 1,

764 
	mIFLA_GENEVE_UNSPEC
,

765 
	mIFLA_GENEVE_ID
,

766 
	mIFLA_GENEVE_REMOTE
,

767 
	mIFLA_GENEVE_TTL
,

768 
	mIFLA_GENEVE_TOS
,

769 
	mIFLA_GENEVE_PORT
,

770 
	mIFLA_GENEVE_COLLECT_METADATA
,

771 
	mIFLA_GENEVE_REMOTE6
,

772 
	mIFLA_GENEVE_UDP_CSUM
,

773 
	mIFLA_GENEVE_UDP_ZERO_CSUM6_TX
,

774 
	mIFLA_GENEVE_UDP_ZERO_CSUM6_RX
,

775 
	mIFLA_GENEVE_LABEL
,

776 
	mIFLA_GENEVE_TTL_INHERIT
,

777 
	mIFLA_GENEVE_DF
,

778 
	m__IFLA_GENEVE_MAX


780 
	#IFLA_GENEVE_MAX
 (
__IFLA_GENEVE_MAX
 - 1)

	)

782 
	eiÊa_gíeve_df
 {

783 
	mGENEVE_DF_UNSET
 = 0,

784 
	mGENEVE_DF_SET
,

785 
	mGENEVE_DF_INHERIT
,

786 
	m__GENEVE_DF_END
,

787 
	mGENEVE_DF_MAX
 = 
__GENEVE_DF_END
 - 1,

792 
	mIFLA_BAREUDP_UNSPEC
,

793 
	mIFLA_BAREUDP_PORT
,

794 
	mIFLA_BAREUDP_ETHERTYPE
,

795 
	mIFLA_BAREUDP_SRCPORT_MIN
,

796 
	mIFLA_BAREUDP_MULTIPROTO_MODE
,

797 
	m__IFLA_BAREUDP_MAX


800 
	#IFLA_BAREUDP_MAX
 (
__IFLA_BAREUDP_MAX
 - 1)

	)

804 
	mIFLA_PPP_UNSPEC
,

805 
	mIFLA_PPP_DEV_FD
,

806 
	m__IFLA_PPP_MAX


808 
	#IFLA_PPP_MAX
 (
__IFLA_PPP_MAX
 - 1)

	)

812 
	eiÊa_gç_rﬁe
 {

813 
	mGTP_ROLE_GGSN
 = 0,

814 
	mGTP_ROLE_SGSN
,

818 
	mIFLA_GTP_UNSPEC
,

819 
	mIFLA_GTP_FD0
,

820 
	mIFLA_GTP_FD1
,

821 
	mIFLA_GTP_PDP_HASHSIZE
,

822 
	mIFLA_GTP_ROLE
,

823 
	m__IFLA_GTP_MAX
,

825 
	#IFLA_GTP_MAX
 (
__IFLA_GTP_MAX
 - 1)

	)

830 
	mIFLA_BOND_UNSPEC
,

831 
	mIFLA_BOND_MODE
,

832 
	mIFLA_BOND_ACTIVE_SLAVE
,

833 
	mIFLA_BOND_MIIMON
,

834 
	mIFLA_BOND_UPDELAY
,

835 
	mIFLA_BOND_DOWNDELAY
,

836 
	mIFLA_BOND_USE_CARRIER
,

837 
	mIFLA_BOND_ARP_INTERVAL
,

838 
	mIFLA_BOND_ARP_IP_TARGET
,

839 
	mIFLA_BOND_ARP_VALIDATE
,

840 
	mIFLA_BOND_ARP_ALL_TARGETS
,

841 
	mIFLA_BOND_PRIMARY
,

842 
	mIFLA_BOND_PRIMARY_RESELECT
,

843 
	mIFLA_BOND_FAIL_OVER_MAC
,

844 
	mIFLA_BOND_XMIT_HASH_POLICY
,

845 
	mIFLA_BOND_RESEND_IGMP
,

846 
	mIFLA_BOND_NUM_PEER_NOTIF
,

847 
	mIFLA_BOND_ALL_SLAVES_ACTIVE
,

848 
	mIFLA_BOND_MIN_LINKS
,

849 
	mIFLA_BOND_LP_INTERVAL
,

850 
	mIFLA_BOND_PACKETS_PER_SLAVE
,

851 
	mIFLA_BOND_AD_LACP_RATE
,

852 
	mIFLA_BOND_AD_SELECT
,

853 
	mIFLA_BOND_AD_INFO
,

854 
	mIFLA_BOND_AD_ACTOR_SYS_PRIO
,

855 
	mIFLA_BOND_AD_USER_PORT_KEY
,

856 
	mIFLA_BOND_AD_ACTOR_SYSTEM
,

857 
	mIFLA_BOND_TLB_DYNAMIC_LB
,

858 
	mIFLA_BOND_PEER_NOTIF_DELAY
,

859 
	mIFLA_BOND_AD_LACP_ACTIVE
,

860 
	mIFLA_BOND_MISSED_MAX
,

861 
	m__IFLA_BOND_MAX
,

864 
	#IFLA_BOND_MAX
 (
__IFLA_BOND_MAX
 - 1)

	)

867 
	mIFLA_BOND_AD_INFO_UNSPEC
,

868 
	mIFLA_BOND_AD_INFO_AGGREGATOR
,

869 
	mIFLA_BOND_AD_INFO_NUM_PORTS
,

870 
	mIFLA_BOND_AD_INFO_ACTOR_KEY
,

871 
	mIFLA_BOND_AD_INFO_PARTNER_KEY
,

872 
	mIFLA_BOND_AD_INFO_PARTNER_MAC
,

873 
	m__IFLA_BOND_AD_INFO_MAX
,

876 
	#IFLA_BOND_AD_INFO_MAX
 (
__IFLA_BOND_AD_INFO_MAX
 - 1)

	)

879 
	mIFLA_BOND_SLAVE_UNSPEC
,

880 
	mIFLA_BOND_SLAVE_STATE
,

881 
	mIFLA_BOND_SLAVE_MII_STATUS
,

882 
	mIFLA_BOND_SLAVE_LINK_FAILURE_COUNT
,

883 
	mIFLA_BOND_SLAVE_PERM_HWADDR
,

884 
	mIFLA_BOND_SLAVE_QUEUE_ID
,

885 
	mIFLA_BOND_SLAVE_AD_AGGREGATOR_ID
,

886 
	mIFLA_BOND_SLAVE_AD_ACTOR_OPER_PORT_STATE
,

887 
	mIFLA_BOND_SLAVE_AD_PARTNER_OPER_PORT_STATE
,

888 
	m__IFLA_BOND_SLAVE_MAX
,

891 
	#IFLA_BOND_SLAVE_MAX
 (
__IFLA_BOND_SLAVE_MAX
 - 1)

	)

896 
	mIFLA_VF_INFO_UNSPEC
,

897 
	mIFLA_VF_INFO
,

898 
	m__IFLA_VF_INFO_MAX
,

901 
	#IFLA_VF_INFO_MAX
 (
__IFLA_VF_INFO_MAX
 - 1)

	)

904 
	mIFLA_VF_UNSPEC
,

905 
	mIFLA_VF_MAC
,

906 
	mIFLA_VF_VLAN
,

907 
	mIFLA_VF_TX_RATE
,

908 
	mIFLA_VF_SPOOFCHK
,

909 
	mIFLA_VF_LINK_STATE
,

910 
	mIFLA_VF_RATE
,

911 
	mIFLA_VF_RSS_QUERY_EN
,

914 
	mIFLA_VF_STATS
,

915 
	mIFLA_VF_TRUST
,

916 
	mIFLA_VF_IB_NODE_GUID
,

917 
	mIFLA_VF_IB_PORT_GUID
,

918 
	mIFLA_VF_VLAN_LIST
,

919 
	mIFLA_VF_BROADCAST
,

920 
	m__IFLA_VF_MAX
,

923 
	#IFLA_VF_MAX
 (
__IFLA_VF_MAX
 - 1)

	)

925 
	siÊa_vf_mac
 {

926 
__u32
 
	mvf
;

927 
__u8
 
	mmac
[32];

930 
	siÊa_vf_brﬂdˇ°
 {

931 
__u8
 
	mbrﬂdˇ°
[32];

934 
	siÊa_vf_vœn
 {

935 
__u32
 
	mvf
;

936 
__u32
 
	mvœn
;

937 
__u32
 
	mqos
;

941 
	mIFLA_VF_VLAN_INFO_UNSPEC
,

942 
	mIFLA_VF_VLAN_INFO
,

943 
	m__IFLA_VF_VLAN_INFO_MAX
,

946 
	#IFLA_VF_VLAN_INFO_MAX
 (
__IFLA_VF_VLAN_INFO_MAX
 - 1)

	)

947 
	#MAX_VLAN_LIST_LEN
 1

	)

949 
	siÊa_vf_vœn_öfo
 {

950 
__u32
 
	mvf
;

951 
__u32
 
	mvœn
;

952 
__u32
 
	mqos
;

953 
__be16
 
	mvœn_¥Ÿo
;

956 
	siÊa_vf_tx_øã
 {

957 
__u32
 
	mvf
;

958 
__u32
 
	møã
;

961 
	siÊa_vf_øã
 {

962 
__u32
 
	mvf
;

963 
__u32
 
	mmö_tx_øã
;

964 
__u32
 
	mmax_tx_øã
;

967 
	siÊa_vf_•oofchk
 {

968 
__u32
 
	mvf
;

969 
__u32
 
	m£âög
;

972 
	siÊa_vf_guid
 {

973 
__u32
 
	mvf
;

974 
__u64
 
	mguid
;

978 
	mIFLA_VF_LINK_STATE_AUTO
,

979 
	mIFLA_VF_LINK_STATE_ENABLE
,

980 
	mIFLA_VF_LINK_STATE_DISABLE
,

981 
	m__IFLA_VF_LINK_STATE_MAX
,

984 
	siÊa_vf_lök_°©e
 {

985 
__u32
 
	mvf
;

986 
__u32
 
	mlök_°©e
;

989 
	siÊa_vf_rss_quîy_í
 {

990 
__u32
 
	mvf
;

991 
__u32
 
	m£âög
;

995 
	mIFLA_VF_STATS_RX_PACKETS
,

996 
	mIFLA_VF_STATS_TX_PACKETS
,

997 
	mIFLA_VF_STATS_RX_BYTES
,

998 
	mIFLA_VF_STATS_TX_BYTES
,

999 
	mIFLA_VF_STATS_BROADCAST
,

1000 
	mIFLA_VF_STATS_MULTICAST
,

1001 
	mIFLA_VF_STATS_PAD
,

1002 
	mIFLA_VF_STATS_RX_DROPPED
,

1003 
	mIFLA_VF_STATS_TX_DROPPED
,

1004 
	m__IFLA_VF_STATS_MAX
,

1007 
	#IFLA_VF_STATS_MAX
 (
__IFLA_VF_STATS_MAX
 - 1)

	)

1009 
	siÊa_vf_åu°
 {

1010 
__u32
 
	mvf
;

1011 
__u32
 
	m£âög
;

1030 
	mIFLA_VF_PORT_UNSPEC
,

1031 
	mIFLA_VF_PORT
,

1032 
	m__IFLA_VF_PORT_MAX
,

1035 
	#IFLA_VF_PORT_MAX
 (
__IFLA_VF_PORT_MAX
 - 1)

	)

1038 
	mIFLA_PORT_UNSPEC
,

1039 
	mIFLA_PORT_VF
,

1040 
	mIFLA_PORT_PROFILE
,

1041 
	mIFLA_PORT_VSI_TYPE
,

1042 
	mIFLA_PORT_INSTANCE_UUID
,

1043 
	mIFLA_PORT_HOST_UUID
,

1044 
	mIFLA_PORT_REQUEST
,

1045 
	mIFLA_PORT_RESPONSE
,

1046 
	m__IFLA_PORT_MAX
,

1049 
	#IFLA_PORT_MAX
 (
__IFLA_PORT_MAX
 - 1)

	)

1051 
	#PORT_PROFILE_MAX
 40

	)

1052 
	#PORT_UUID_MAX
 16

	)

1053 
	#PORT_SELF_VF
 -1

	)

1056 
	mPORT_REQUEST_PREASSOCIATE
 = 0,

1057 
	mPORT_REQUEST_PREASSOCIATE_RR
,

1058 
	mPORT_REQUEST_ASSOCIATE
,

1059 
	mPORT_REQUEST_DISASSOCIATE
,

1063 
	mPORT_VDP_RESPONSE_SUCCESS
 = 0,

1064 
	mPORT_VDP_RESPONSE_INVALID_FORMAT
,

1065 
	mPORT_VDP_RESPONSE_INSUFFICIENT_RESOURCES
,

1066 
	mPORT_VDP_RESPONSE_UNUSED_VTID
,

1067 
	mPORT_VDP_RESPONSE_VTID_VIOLATION
,

1068 
	mPORT_VDP_RESPONSE_VTID_VERSION_VIOALTION
,

1069 
	mPORT_VDP_RESPONSE_OUT_OF_SYNC
,

1071 
	mPORT_PROFILE_RESPONSE_SUCCESS
 = 0x100,

1072 
	mPORT_PROFILE_RESPONSE_INPROGRESS
,

1073 
	mPORT_PROFILE_RESPONSE_INVALID
,

1074 
	mPORT_PROFILE_RESPONSE_BADSTATE
,

1075 
	mPORT_PROFILE_RESPONSE_INSUFFICIENT_RESOURCES
,

1076 
	mPORT_PROFILE_RESPONSE_ERROR
,

1079 
	siÊa_p‹t_vsi
 {

1080 
__u8
 
	mvsi_mgr_id
;

1081 
__u8
 
	mvsi_ty≥_id
[3];

1082 
__u8
 
	mvsi_ty≥_vîsi⁄
;

1083 
__u8
 
	m∑d
[3];

1090 
	mIFLA_IPOIB_UNSPEC
,

1091 
	mIFLA_IPOIB_PKEY
,

1092 
	mIFLA_IPOIB_MODE
,

1093 
	mIFLA_IPOIB_UMCAST
,

1094 
	m__IFLA_IPOIB_MAX


1098 
	mIPOIB_MODE_DATAGRAM
 = 0,

1099 
	mIPOIB_MODE_CONNECTED
 = 1,

1102 
	#IFLA_IPOIB_MAX
 (
__IFLA_IPOIB_MAX
 - 1)

	)

1109 
	mHSR_PROTOCOL_HSR
,

1110 
	mHSR_PROTOCOL_PRP
,

1111 
	mHSR_PROTOCOL_MAX
,

1115 
	mIFLA_HSR_UNSPEC
,

1116 
	mIFLA_HSR_SLAVE1
,

1117 
	mIFLA_HSR_SLAVE2
,

1118 
	mIFLA_HSR_MULTICAST_SPEC
,

1119 
	mIFLA_HSR_SUPERVISION_ADDR
,

1120 
	mIFLA_HSR_SEQ_NR
,

1121 
	mIFLA_HSR_VERSION
,

1122 
	mIFLA_HSR_PROTOCOL
,

1125 
	m__IFLA_HSR_MAX
,

1128 
	#IFLA_HSR_MAX
 (
__IFLA_HSR_MAX
 - 1)

	)

1132 
	sif_°©s_msg
 {

1133 
__u8
 
	mÁmûy
;

1134 
__u8
 
	m∑d1
;

1135 
__u16
 
	m∑d2
;

1136 
__u32
 
	mifödex
;

1137 
__u32
 
	mfûãr_mask
;

1144 
	mIFLA_STATS_UNSPEC
,

1145 
	mIFLA_STATS_LINK_64
,

1146 
	mIFLA_STATS_LINK_XSTATS
,

1147 
	mIFLA_STATS_LINK_XSTATS_SLAVE
,

1148 
	mIFLA_STATS_LINK_OFFLOAD_XSTATS
,

1149 
	mIFLA_STATS_AF_SPEC
,

1150 
	m__IFLA_STATS_MAX
,

1153 
	#IFLA_STATS_MAX
 (
__IFLA_STATS_MAX
 - 1)

	)

1155 
	#IFLA_STATS_FILTER_BIT
(
ATTR
Ë(1 << (ATTR - 1))

	)

1163 
	mLINK_XSTATS_TYPE_UNSPEC
,

1164 
	mLINK_XSTATS_TYPE_BRIDGE
,

1165 
	mLINK_XSTATS_TYPE_BOND
,

1166 
	m__LINK_XSTATS_TYPE_MAX


1168 
	#LINK_XSTATS_TYPE_MAX
 (
__LINK_XSTATS_TYPE_MAX
 - 1)

	)

1172 
	mIFLA_OFFLOAD_XSTATS_UNSPEC
,

1173 
	mIFLA_OFFLOAD_XSTATS_CPU_HIT
,

1174 
	m__IFLA_OFFLOAD_XSTATS_MAX


1176 
	#IFLA_OFFLOAD_XSTATS_MAX
 (
__IFLA_OFFLOAD_XSTATS_MAX
 - 1)

	)

1180 
	#XDP_FLAGS_UPDATE_IF_NOEXIST
 (1U << 0)

	)

1181 
	#XDP_FLAGS_SKB_MODE
 (1U << 1)

	)

1182 
	#XDP_FLAGS_DRV_MODE
 (1U << 2)

	)

1183 
	#XDP_FLAGS_HW_MODE
 (1U << 3)

	)

1184 
	#XDP_FLAGS_REPLACE
 (1U << 4)

	)

1185 
	#XDP_FLAGS_MODES
 (
XDP_FLAGS_SKB_MODE
 | \

1186 
XDP_FLAGS_DRV_MODE
 | \

1187 
XDP_FLAGS_HW_MODE
)

	)

1188 
	#XDP_FLAGS_MASK
 (
XDP_FLAGS_UPDATE_IF_NOEXIST
 | \

1189 
XDP_FLAGS_MODES
 | 
XDP_FLAGS_REPLACE
)

	)

1193 
	mXDP_ATTACHED_NONE
 = 0,

1194 
	mXDP_ATTACHED_DRV
,

1195 
	mXDP_ATTACHED_SKB
,

1196 
	mXDP_ATTACHED_HW
,

1197 
	mXDP_ATTACHED_MULTI
,

1201 
	mIFLA_XDP_UNSPEC
,

1202 
	mIFLA_XDP_FD
,

1203 
	mIFLA_XDP_ATTACHED
,

1204 
	mIFLA_XDP_FLAGS
,

1205 
	mIFLA_XDP_PROG_ID
,

1206 
	mIFLA_XDP_DRV_PROG_ID
,

1207 
	mIFLA_XDP_SKB_PROG_ID
,

1208 
	mIFLA_XDP_HW_PROG_ID
,

1209 
	mIFLA_XDP_EXPECTED_FD
,

1210 
	m__IFLA_XDP_MAX
,

1213 
	#IFLA_XDP_MAX
 (
__IFLA_XDP_MAX
 - 1)

	)

1216 
	mIFLA_EVENT_NONE
,

1217 
	mIFLA_EVENT_REBOOT
,

1218 
	mIFLA_EVENT_FEATURES
,

1219 
	mIFLA_EVENT_BONDING_FAILOVER
,

1220 
	mIFLA_EVENT_NOTIFY_PEERS
,

1221 
	mIFLA_EVENT_IGMP_RESEND
,

1222 
	mIFLA_EVENT_BONDING_OPTIONS
,

1228 
	mIFLA_TUN_UNSPEC
,

1229 
	mIFLA_TUN_OWNER
,

1230 
	mIFLA_TUN_GROUP
,

1231 
	mIFLA_TUN_TYPE
,

1232 
	mIFLA_TUN_PI
,

1233 
	mIFLA_TUN_VNET_HDR
,

1234 
	mIFLA_TUN_PERSIST
,

1235 
	mIFLA_TUN_MULTI_QUEUE
,

1236 
	mIFLA_TUN_NUM_QUEUES
,

1237 
	mIFLA_TUN_NUM_DISABLED_QUEUES
,

1238 
	m__IFLA_TUN_MAX
,

1241 
	#IFLA_TUN_MAX
 (
__IFLA_TUN_MAX
 - 1)

	)

1245 
	#RMNET_FLAGS_INGRESS_DEAGGREGATION
 (1U << 0)

	)

1246 
	#RMNET_FLAGS_INGRESS_MAP_COMMANDS
 (1U << 1)

	)

1247 
	#RMNET_FLAGS_INGRESS_MAP_CKSUMV4
 (1U << 2)

	)

1248 
	#RMNET_FLAGS_EGRESS_MAP_CKSUMV4
 (1U << 3)

	)

1249 
	#RMNET_FLAGS_INGRESS_MAP_CKSUMV5
 (1U << 4)

	)

1250 
	#RMNET_FLAGS_EGRESS_MAP_CKSUMV5
 (1U << 5)

	)

1253 
	mIFLA_RMNET_UNSPEC
,

1254 
	mIFLA_RMNET_MUX_ID
,

1255 
	mIFLA_RMNET_FLAGS
,

1256 
	m__IFLA_RMNET_MAX
,

1259 
	#IFLA_RMNET_MAX
 (
__IFLA_RMNET_MAX
 - 1)

	)

1261 
	siÊa_rm√t_Êags
 {

1262 
__u32
 
	mÊags
;

1263 
__u32
 
	mmask
;

1269 
	mIFLA_MCTP_UNSPEC
,

1270 
	mIFLA_MCTP_NET
,

1271 
	m__IFLA_MCTP_MAX
,

1274 
	#IFLA_MCTP_MAX
 (
__IFLA_MCTP_MAX
 - 1)

	)

	@/usr/include/linux/if_packet.h

2 #i‚de‡
__LINUX_IF_PACKET_H


3 
	#__LINUX_IF_PACKET_H


	)

5 
	~<asm/byã‹dî.h
>

6 
	~<löux/ty≥s.h
>

8 
	ssockaddr_pkt
 {

9 
	m•kt_Ámûy
;

10 
	m•kt_devi˚
[14];

11 
__be16
 
	m•kt_¥Ÿocﬁ
;

14 
	ssockaddr_Œ
 {

15 
	m¶l_Ámûy
;

16 
__be16
 
	m¶l_¥Ÿocﬁ
;

17 
	m¶l_ifödex
;

18 
	m¶l_h©y≥
;

19 
	m¶l_pkây≥
;

20 
	m¶l_hÆí
;

21 
	m¶l_addr
[8];

26 
	#PACKET_HOST
 0

	)

27 
	#PACKET_BROADCAST
 1

	)

28 
	#PACKET_MULTICAST
 2

	)

29 
	#PACKET_OTHERHOST
 3

	)

30 
	#PACKET_OUTGOING
 4

	)

31 
	#PACKET_LOOPBACK
 5

	)

32 
	#PACKET_USER
 6

	)

33 
	#PACKET_KERNEL
 7

	)

35 
	#PACKET_FASTROUTE
 6

	)

39 
	#PACKET_ADD_MEMBERSHIP
 1

	)

40 
	#PACKET_DROP_MEMBERSHIP
 2

	)

41 
	#PACKET_RECV_OUTPUT
 3

	)

43 
	#PACKET_RX_RING
 5

	)

44 
	#PACKET_STATISTICS
 6

	)

45 
	#PACKET_COPY_THRESH
 7

	)

46 
	#PACKET_AUXDATA
 8

	)

47 
	#PACKET_ORIGDEV
 9

	)

48 
	#PACKET_VERSION
 10

	)

49 
	#PACKET_HDRLEN
 11

	)

50 
	#PACKET_RESERVE
 12

	)

51 
	#PACKET_TX_RING
 13

	)

52 
	#PACKET_LOSS
 14

	)

53 
	#PACKET_VNET_HDR
 15

	)

54 
	#PACKET_TX_TIMESTAMP
 16

	)

55 
	#PACKET_TIMESTAMP
 17

	)

56 
	#PACKET_FANOUT
 18

	)

57 
	#PACKET_TX_HAS_OFF
 19

	)

58 
	#PACKET_QDISC_BYPASS
 20

	)

59 
	#PACKET_ROLLOVER_STATS
 21

	)

60 
	#PACKET_FANOUT_DATA
 22

	)

61 
	#PACKET_IGNORE_OUTGOING
 23

	)

63 
	#PACKET_FANOUT_HASH
 0

	)

64 
	#PACKET_FANOUT_LB
 1

	)

65 
	#PACKET_FANOUT_CPU
 2

	)

66 
	#PACKET_FANOUT_ROLLOVER
 3

	)

67 
	#PACKET_FANOUT_RND
 4

	)

68 
	#PACKET_FANOUT_QM
 5

	)

69 
	#PACKET_FANOUT_CBPF
 6

	)

70 
	#PACKET_FANOUT_EBPF
 7

	)

71 
	#PACKET_FANOUT_FLAG_ROLLOVER
 0x1000

	)

72 
	#PACKET_FANOUT_FLAG_UNIQUEID
 0x2000

	)

73 
	#PACKET_FANOUT_FLAG_DEFRAG
 0x8000

	)

75 
	sçackë_°©s
 {

76 
	mç_∑ckës
;

77 
	mç_dr›s
;

80 
	sçackë_°©s_v3
 {

81 
	mç_∑ckës
;

82 
	mç_dr›s
;

83 
	mç_‰ìze_q_˙t
;

86 
	sçackë_rﬁlovî_°©s
 {

87 
__Æig√d_u64
 
	mç_Æl
;

88 
__Æig√d_u64
 
	mç_huge
;

89 
__Æig√d_u64
 
	mç_Áûed
;

92 
	uçackë_°©s_u
 {

93 
çackë_°©s
 
	m°©s1
;

94 
çackë_°©s_v3
 
	m°©s3
;

97 
	sçackë_auxd©a
 {

98 
__u32
 
	mç_°©us
;

99 
__u32
 
	mç_Àn
;

100 
__u32
 
	mç_¢≠Àn
;

101 
__u16
 
	mç_mac
;

102 
__u16
 
	mç_√t
;

103 
__u16
 
	mç_vœn_tci
;

104 
__u16
 
	mç_vœn_çid
;

108 
	#TP_STATUS_KERNEL
 0

	)

109 
	#TP_STATUS_USER
 (1 << 0)

	)

110 
	#TP_STATUS_COPY
 (1 << 1)

	)

111 
	#TP_STATUS_LOSING
 (1 << 2)

	)

112 
	#TP_STATUS_CSUMNOTREADY
 (1 << 3)

	)

113 
	#TP_STATUS_VLAN_VALID
 (1 << 4Ë

	)

114 
	#TP_STATUS_BLK_TMO
 (1 << 5)

	)

115 
	#TP_STATUS_VLAN_TPID_VALID
 (1 << 6Ë

	)

116 
	#TP_STATUS_CSUM_VALID
 (1 << 7)

	)

119 
	#TP_STATUS_AVAILABLE
 0

	)

120 
	#TP_STATUS_SEND_REQUEST
 (1 << 0)

	)

121 
	#TP_STATUS_SENDING
 (1 << 1)

	)

122 
	#TP_STATUS_WRONG_FORMAT
 (1 << 2)

	)

125 
	#TP_STATUS_TS_SOFTWARE
 (1 << 29)

	)

126 
	#TP_STATUS_TS_SYS_HARDWARE
 (1 << 30Ë

	)

127 
	#TP_STATUS_TS_RAW_HARDWARE
 (1U << 31)

	)

130 
	#TP_FT_REQ_FILL_RXHASH
 0x1

	)

132 
	sçackë_hdr
 {

133 
	mç_°©us
;

134 
	mç_Àn
;

135 
	mç_¢≠Àn
;

136 
	mç_mac
;

137 
	mç_√t
;

138 
	mç_£c
;

139 
	mç_u£c
;

142 
	#TPACKET_ALIGNMENT
 16

	)

143 
	#TPACKET_ALIGN
(
x
Ë(((x)+
TPACKET_ALIGNMENT
-1)&~(TPACKET_ALIGNMENT-1))

	)

144 
	#TPACKET_HDRLEN
 (
	`TPACKET_ALIGN
((
çackë_hdr
)Ë+ (
sockaddr_Œ
))

	)

146 
	sçackë2_hdr
 {

147 
__u32
 
	mç_°©us
;

148 
__u32
 
	mç_Àn
;

149 
__u32
 
	mç_¢≠Àn
;

150 
__u16
 
	mç_mac
;

151 
__u16
 
	mç_√t
;

152 
__u32
 
	mç_£c
;

153 
__u32
 
	mç_n£c
;

154 
__u16
 
	mç_vœn_tci
;

155 
__u16
 
	mç_vœn_çid
;

156 
__u8
 
	mç_∑ddög
[4];

159 
	sçackë_hdr_v¨ü¡1
 {

160 
__u32
 
	mç_rxhash
;

161 
__u32
 
	mç_vœn_tci
;

162 
__u16
 
	mç_vœn_çid
;

163 
__u16
 
	mç_∑ddög
;

166 
	sçackë3_hdr
 {

167 
__u32
 
	mç_√xt_off£t
;

168 
__u32
 
	mç_£c
;

169 
__u32
 
	mç_n£c
;

170 
__u32
 
	mç_¢≠Àn
;

171 
__u32
 
	mç_Àn
;

172 
__u32
 
	mç_°©us
;

173 
__u16
 
	mç_mac
;

174 
__u16
 
	mç_√t
;

177 
çackë_hdr_v¨ü¡1
 
	mhv1
;

179 
__u8
 
	mç_∑ddög
[8];

182 
	sçackë_bd_ts
 {

183 
	mts_£c
;

185 
	mts_u£c
;

186 
	mts_n£c
;

190 
	sçackë_hdr_v1
 {

191 
__u32
 
	mblock_°©us
;

192 
__u32
 
	mnum_pkts
;

193 
__u32
 
	moff£t_to_fú°_pkt
;

198 
__u32
 
	mblk_Àn
;

209 
__Æig√d_u64
 
	m£q_num
;

236 
çackë_bd_ts
 
	mts_fú°_pkt
, 
	mts_œ°_pkt
;

239 
	uçackë_bd_hódî_u
 {

240 
çackë_hdr_v1
 
	mbh1
;

243 
	sçackë_block_desc
 {

244 
__u32
 
	mvîsi⁄
;

245 
__u32
 
	moff£t_to_¥iv
;

246 
çackë_bd_hódî_u
 
	mhdr
;

249 
	#TPACKET2_HDRLEN
 (
	`TPACKET_ALIGN
((
çackë2_hdr
)Ë+ (
sockaddr_Œ
))

	)

250 
	#TPACKET3_HDRLEN
 (
	`TPACKET_ALIGN
((
çackë3_hdr
)Ë+ (
sockaddr_Œ
))

	)

252 
	eçackë_vîsi⁄s
 {

253 
	mTPACKET_V1
,

254 
	mTPACKET_V2
,

255 
	mTPACKET_V3


271 
	sçackë_ªq
 {

272 
	mç_block_size
;

273 
	mç_block_ƒ
;

274 
	mç_‰ame_size
;

275 
	mç_‰ame_ƒ
;

278 
	sçackë_ªq3
 {

279 
	mç_block_size
;

280 
	mç_block_ƒ
;

281 
	mç_‰ame_size
;

282 
	mç_‰ame_ƒ
;

283 
	mç_ªtúe_blk_tov
;

284 
	mç_sizeof_¥iv
;

285 
	mç_„©uª_ªq_w‹d
;

288 
	uçackë_ªq_u
 {

289 
çackë_ªq
 
	mªq
;

290 
çackë_ªq3
 
	mªq3
;

293 
	s∑ckë_mªq
 {

294 
	mmr_ifödex
;

295 
	mmr_ty≥
;

296 
	mmr_Æí
;

297 
	mmr_addªss
[8];

300 
	sÁnout_¨gs
 {

301 #i‡
deföed
(
__LITTLE_ENDIAN_BITFIELD
)

302 
__u16
 
	mid
;

303 
__u16
 
	mty≥_Êags
;

305 
__u16
 
	mty≥_Êags
;

306 
__u16
 
	mid
;

308 
__u32
 
	mmax_num_membîs
;

311 
	#PACKET_MR_MULTICAST
 0

	)

312 
	#PACKET_MR_PROMISC
 1

	)

313 
	#PACKET_MR_ALLMULTI
 2

	)

314 
	#PACKET_MR_UNICAST
 3

	)

	@/usr/include/linux/ioctl.h

2 #i‚de‡
_LINUX_IOCTL_H


3 
	#_LINUX_IOCTL_H


	)

5 
	~<asm/io˘l.h
>

	@/usr/include/linux/libc-compat.h

49 #i‚de‡
_LIBC_COMPAT_H


50 
	#_LIBC_COMPAT_H


	)

53 #i‡
deföed
(
__GLIBC__
)

56 #i‡
deföed
(
_NET_IF_H
Ë&& deföed(
__USE_MISC
)

61 
	#__UAPI_DEF_IF_IFCONF
 0

	)

62 
	#__UAPI_DEF_IF_IFMAP
 0

	)

63 
	#__UAPI_DEF_IF_IFNAMSIZ
 0

	)

64 
	#__UAPI_DEF_IF_IFREQ
 0

	)

66 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 0

	)

68 #i‚de‡
__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO


69 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

78 
	#__UAPI_DEF_IF_IFCONF
 1

	)

79 
	#__UAPI_DEF_IF_IFMAP
 1

	)

80 
	#__UAPI_DEF_IF_IFNAMSIZ
 1

	)

81 
	#__UAPI_DEF_IF_IFREQ
 1

	)

83 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 1

	)

85 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

90 #i‡
deföed
(
_NETINET_IN_H
)

94 
	#__UAPI_DEF_IN_ADDR
 0

	)

95 
	#__UAPI_DEF_IN_IPPROTO
 0

	)

96 
	#__UAPI_DEF_IN_PKTINFO
 0

	)

97 
	#__UAPI_DEF_IP_MREQ
 0

	)

98 
	#__UAPI_DEF_SOCKADDR_IN
 0

	)

99 
	#__UAPI_DEF_IN_CLASS
 0

	)

101 
	#__UAPI_DEF_IN6_ADDR
 0

	)

106 #i‡
deföed
(
__USE_MISC
Ë|| deföed (
__USE_GNU
)

107 
	#__UAPI_DEF_IN6_ADDR_ALT
 0

	)

109 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

111 
	#__UAPI_DEF_SOCKADDR_IN6
 0

	)

112 
	#__UAPI_DEF_IPV6_MREQ
 0

	)

113 
	#__UAPI_DEF_IPPROTO_V6
 0

	)

114 
	#__UAPI_DEF_IPV6_OPTIONS
 0

	)

115 
	#__UAPI_DEF_IN6_PKTINFO
 0

	)

116 
	#__UAPI_DEF_IP6_MTUINFO
 0

	)

123 
	#__UAPI_DEF_IN_ADDR
 1

	)

124 
	#__UAPI_DEF_IN_IPPROTO
 1

	)

125 
	#__UAPI_DEF_IN_PKTINFO
 1

	)

126 
	#__UAPI_DEF_IP_MREQ
 1

	)

127 
	#__UAPI_DEF_SOCKADDR_IN
 1

	)

128 
	#__UAPI_DEF_IN_CLASS
 1

	)

130 
	#__UAPI_DEF_IN6_ADDR
 1

	)

133 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

134 
	#__UAPI_DEF_SOCKADDR_IN6
 1

	)

135 
	#__UAPI_DEF_IPV6_MREQ
 1

	)

136 
	#__UAPI_DEF_IPPROTO_V6
 1

	)

137 
	#__UAPI_DEF_IPV6_OPTIONS
 1

	)

138 
	#__UAPI_DEF_IN6_PKTINFO
 1

	)

139 
	#__UAPI_DEF_IP6_MTUINFO
 1

	)

144 #i‡
deföed
(
__NETIPX_IPX_H
)

146 
	#__UAPI_DEF_SOCKADDR_IPX
 0

	)

147 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 0

	)

148 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 0

	)

149 
	#__UAPI_DEF_IPX_CONFIG_DATA
 0

	)

150 
	#__UAPI_DEF_IPX_ROUTE_DEF
 0

	)

154 
	#__UAPI_DEF_SOCKADDR_IPX
 1

	)

155 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 1

	)

156 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 1

	)

157 
	#__UAPI_DEF_IPX_CONFIG_DATA
 1

	)

158 
	#__UAPI_DEF_IPX_ROUTE_DEF
 1

	)

163 #i‡
deföed
(
_SYS_XATTR_H
)

164 
	#__UAPI_DEF_XATTR
 0

	)

166 
	#__UAPI_DEF_XATTR
 1

	)

176 #i‚de‡
__UAPI_DEF_IF_IFCONF


177 
	#__UAPI_DEF_IF_IFCONF
 1

	)

179 #i‚de‡
__UAPI_DEF_IF_IFMAP


180 
	#__UAPI_DEF_IF_IFMAP
 1

	)

182 #i‚de‡
__UAPI_DEF_IF_IFNAMSIZ


183 
	#__UAPI_DEF_IF_IFNAMSIZ
 1

	)

185 #i‚de‡
__UAPI_DEF_IF_IFREQ


186 
	#__UAPI_DEF_IF_IFREQ
 1

	)

189 #i‚de‡
__UAPI_DEF_IF_NET_DEVICE_FLAGS


190 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 1

	)

193 #i‚de‡
__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO


194 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

198 #i‚de‡
__UAPI_DEF_IN_ADDR


199 
	#__UAPI_DEF_IN_ADDR
 1

	)

201 #i‚de‡
__UAPI_DEF_IN_IPPROTO


202 
	#__UAPI_DEF_IN_IPPROTO
 1

	)

204 #i‚de‡
__UAPI_DEF_IN_PKTINFO


205 
	#__UAPI_DEF_IN_PKTINFO
 1

	)

207 #i‚de‡
__UAPI_DEF_IP_MREQ


208 
	#__UAPI_DEF_IP_MREQ
 1

	)

210 #i‚de‡
__UAPI_DEF_SOCKADDR_IN


211 
	#__UAPI_DEF_SOCKADDR_IN
 1

	)

213 #i‚de‡
__UAPI_DEF_IN_CLASS


214 
	#__UAPI_DEF_IN_CLASS
 1

	)

218 #i‚de‡
__UAPI_DEF_IN6_ADDR


219 
	#__UAPI_DEF_IN6_ADDR
 1

	)

221 #i‚de‡
__UAPI_DEF_IN6_ADDR_ALT


222 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

224 #i‚de‡
__UAPI_DEF_SOCKADDR_IN6


225 
	#__UAPI_DEF_SOCKADDR_IN6
 1

	)

227 #i‚de‡
__UAPI_DEF_IPV6_MREQ


228 
	#__UAPI_DEF_IPV6_MREQ
 1

	)

230 #i‚de‡
__UAPI_DEF_IPPROTO_V6


231 
	#__UAPI_DEF_IPPROTO_V6
 1

	)

233 #i‚de‡
__UAPI_DEF_IPV6_OPTIONS


234 
	#__UAPI_DEF_IPV6_OPTIONS
 1

	)

236 #i‚de‡
__UAPI_DEF_IN6_PKTINFO


237 
	#__UAPI_DEF_IN6_PKTINFO
 1

	)

239 #i‚de‡
__UAPI_DEF_IP6_MTUINFO


240 
	#__UAPI_DEF_IP6_MTUINFO
 1

	)

244 #i‚de‡
__UAPI_DEF_SOCKADDR_IPX


245 
	#__UAPI_DEF_SOCKADDR_IPX
 1

	)

247 #i‚de‡
__UAPI_DEF_IPX_ROUTE_DEFINITION


248 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 1

	)

250 #i‚de‡
__UAPI_DEF_IPX_INTERFACE_DEFINITION


251 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 1

	)

253 #i‚de‡
__UAPI_DEF_IPX_CONFIG_DATA


254 
	#__UAPI_DEF_IPX_CONFIG_DATA
 1

	)

256 #i‚de‡
__UAPI_DEF_IPX_ROUTE_DEF


257 
	#__UAPI_DEF_IPX_ROUTE_DEF
 1

	)

261 #i‚de‡
__UAPI_DEF_XATTR


262 
	#__UAPI_DEF_XATTR
 1

	)

	@/usr/include/linux/limits.h

2 #i‚de‡
_LINUX_LIMITS_H


3 
	#_LINUX_LIMITS_H


	)

5 
	#NR_OPEN
 1024

	)

7 
	#NGROUPS_MAX
 65536

	)

8 
	#ARG_MAX
 131072

	)

9 
	#LINK_MAX
 127

	)

10 
	#MAX_CANON
 255

	)

11 
	#MAX_INPUT
 255

	)

12 
	#NAME_MAX
 255

	)

13 
	#PATH_MAX
 4096

	)

14 
	#PIPE_BUF
 4096

	)

15 
	#XATTR_NAME_MAX
 255

	)

16 
	#XATTR_SIZE_MAX
 65536

	)

17 
	#XATTR_LIST_MAX
 65536

	)

19 
	#RTSIG_MAX
 32

	)

	@/usr/include/linux/mount.h

1 #i‚de‡
_LINUX_MOUNT_H


2 
	#_LINUX_MOUNT_H


	)

4 
	~<löux/ty≥s.h
>

13 
	#MS_RDONLY
 1

	)

14 
	#MS_NOSUID
 2

	)

15 
	#MS_NODEV
 4

	)

16 
	#MS_NOEXEC
 8

	)

17 
	#MS_SYNCHRONOUS
 16

	)

18 
	#MS_REMOUNT
 32

	)

19 
	#MS_MANDLOCK
 64

	)

20 
	#MS_DIRSYNC
 128

	)

21 
	#MS_NOSYMFOLLOW
 256

	)

22 
	#MS_NOATIME
 1024

	)

23 
	#MS_NODIRATIME
 2048

	)

24 
	#MS_BIND
 4096

	)

25 
	#MS_MOVE
 8192

	)

26 
	#MS_REC
 16384

	)

27 
	#MS_VERBOSE
 32768

	)

29 
	#MS_SILENT
 32768

	)

30 
	#MS_POSIXACL
 (1<<16Ë

	)

31 
	#MS_UNBINDABLE
 (1<<17Ë

	)

32 
	#MS_PRIVATE
 (1<<18Ë

	)

33 
	#MS_SLAVE
 (1<<19Ë

	)

34 
	#MS_SHARED
 (1<<20Ë

	)

35 
	#MS_RELATIME
 (1<<21Ë

	)

36 
	#MS_KERNMOUNT
 (1<<22Ë

	)

37 
	#MS_I_VERSION
 (1<<23Ë

	)

38 
	#MS_STRICTATIME
 (1<<24Ë

	)

39 
	#MS_LAZYTIME
 (1<<25Ë

	)

42 
	#MS_SUBMOUNT
 (1<<26)

	)

43 
	#MS_NOREMOTELOCK
 (1<<27)

	)

44 
	#MS_NOSEC
 (1<<28)

	)

45 
	#MS_BORN
 (1<<29)

	)

46 
	#MS_ACTIVE
 (1<<30)

	)

47 
	#MS_NOUSER
 (1<<31)

	)

52 
	#MS_RMT_MASK
 (
MS_RDONLY
|
MS_SYNCHRONOUS
|
MS_MANDLOCK
|
MS_I_VERSION
|\

53 
MS_LAZYTIME
)

	)

58 
	#MS_MGC_VAL
 0xC0ED0000

	)

59 
	#MS_MGC_MSK
 0xffff0000

	)

64 
	#OPEN_TREE_CLONE
 1

	)

65 
	#OPEN_TREE_CLOEXEC
 
O_CLOEXEC


	)

70 
	#MOVE_MOUNT_F_SYMLINKS
 0x00000001

	)

71 
	#MOVE_MOUNT_F_AUTOMOUNTS
 0x00000002

	)

72 
	#MOVE_MOUNT_F_EMPTY_PATH
 0x00000004

	)

73 
	#MOVE_MOUNT_T_SYMLINKS
 0x00000010

	)

74 
	#MOVE_MOUNT_T_AUTOMOUNTS
 0x00000020

	)

75 
	#MOVE_MOUNT_T_EMPTY_PATH
 0x00000040

	)

76 
	#MOVE_MOUNT_SET_GROUP
 0x00000100

	)

77 
	#MOVE_MOUNT__MASK
 0x00000177

	)

82 
	#FSOPEN_CLOEXEC
 0x00000001

	)

87 
	#FSPICK_CLOEXEC
 0x00000001

	)

88 
	#FSPICK_SYMLINK_NOFOLLOW
 0x00000002

	)

89 
	#FSPICK_NO_AUTOMOUNT
 0x00000004

	)

90 
	#FSPICK_EMPTY_PATH
 0x00000008

	)

95 
	efsc⁄fig_comm™d
 {

96 
	mFSCONFIG_SET_FLAG
 = 0,

97 
	mFSCONFIG_SET_STRING
 = 1,

98 
	mFSCONFIG_SET_BINARY
 = 2,

99 
	mFSCONFIG_SET_PATH
 = 3,

100 
	mFSCONFIG_SET_PATH_EMPTY
 = 4,

101 
	mFSCONFIG_SET_FD
 = 5,

102 
	mFSCONFIG_CMD_CREATE
 = 6,

103 
	mFSCONFIG_CMD_RECONFIGURE
 = 7,

109 
	#FSMOUNT_CLOEXEC
 0x00000001

	)

114 
	#MOUNT_ATTR_RDONLY
 0x00000001

	)

115 
	#MOUNT_ATTR_NOSUID
 0x00000002

	)

116 
	#MOUNT_ATTR_NODEV
 0x00000004

	)

117 
	#MOUNT_ATTR_NOEXEC
 0x00000008

	)

118 
	#MOUNT_ATTR__ATIME
 0x00000070

	)

119 
	#MOUNT_ATTR_RELATIME
 0x00000000

	)

120 
	#MOUNT_ATTR_NOATIME
 0x00000010

	)

121 
	#MOUNT_ATTR_STRICTATIME
 0x00000020

	)

122 
	#MOUNT_ATTR_NODIRATIME
 0x00000080

	)

123 
	#MOUNT_ATTR_IDMAP
 0x00100000

	)

124 
	#MOUNT_ATTR_NOSYMFOLLOW
 0x00200000

	)

129 
	smou¡_©å
 {

130 
__u64
 
	m©å_£t
;

131 
__u64
 
	m©å_˛r
;

132 
__u64
 
	m¥›ag©i⁄
;

133 
__u64
 
	mu£∫s_fd
;

137 
	#MOUNT_ATTR_SIZE_VER0
 32

	)

	@/usr/include/linux/neighbour.h

2 #i‚de‡
__LINUX_NEIGHBOUR_H


3 
	#__LINUX_NEIGHBOUR_H


	)

5 
	~<löux/ty≥s.h
>

6 
	~<löux/√éök.h
>

8 
	sndmsg
 {

9 
__u8
 
	mndm_Ámûy
;

10 
__u8
 
	mndm_∑d1
;

11 
__u16
 
	mndm_∑d2
;

12 
__s32
 
	mndm_ifödex
;

13 
__u16
 
	mndm_°©e
;

14 
__u8
 
	mndm_Êags
;

15 
__u8
 
	mndm_ty≥
;

19 
	mNDA_UNSPEC
,

20 
	mNDA_DST
,

21 
	mNDA_LLADDR
,

22 
	mNDA_CACHEINFO
,

23 
	mNDA_PROBES
,

24 
	mNDA_VLAN
,

25 
	mNDA_PORT
,

26 
	mNDA_VNI
,

27 
	mNDA_IFINDEX
,

28 
	mNDA_MASTER
,

29 
	mNDA_LINK_NETNSID
,

30 
	mNDA_SRC_VNI
,

31 
	mNDA_PROTOCOL
,

32 
	mNDA_NH_ID
,

33 
	mNDA_FDB_EXT_ATTRS
,

34 
	m__NDA_MAX


37 
	#NDA_MAX
 (
__NDA_MAX
 - 1)

	)

43 
	#NTF_USE
 0x01

	)

44 
	#NTF_SELF
 0x02

	)

45 
	#NTF_MASTER
 0x04

	)

46 
	#NTF_PROXY
 0x08

	)

47 
	#NTF_EXT_LEARNED
 0x10

	)

48 
	#NTF_OFFLOADED
 0x20

	)

49 
	#NTF_STICKY
 0x40

	)

50 
	#NTF_ROUTER
 0x80

	)

56 
	#NUD_INCOMPLETE
 0x01

	)

57 
	#NUD_REACHABLE
 0x02

	)

58 
	#NUD_STALE
 0x04

	)

59 
	#NUD_DELAY
 0x08

	)

60 
	#NUD_PROBE
 0x10

	)

61 
	#NUD_FAILED
 0x20

	)

64 
	#NUD_NOARP
 0x40

	)

65 
	#NUD_PERMANENT
 0x80

	)

66 
	#NUD_NONE
 0x00

	)

76 
	snda_ˇcheöfo
 {

77 
__u32
 
	mndm_c⁄fúmed
;

78 
__u32
 
	mndm_u£d
;

79 
__u32
 
	mndm_upd©ed
;

80 
__u32
 
	mndm_ªf˙t
;

108 
	sndt_°©s
 {

109 
__u64
 
	mndts_Ælocs
;

110 
__u64
 
	mndts_de°roys
;

111 
__u64
 
	mndts_hash_grows
;

112 
__u64
 
	mndts_ªs_Áûed
;

113 
__u64
 
	mndts_lookups
;

114 
__u64
 
	mndts_hôs
;

115 
__u64
 
	mndts_rcv_¥obes_mˇ°
;

116 
__u64
 
	mndts_rcv_¥obes_uˇ°
;

117 
__u64
 
	mndts_≥riodic_gc_runs
;

118 
__u64
 
	mndts_f‹˚d_gc_runs
;

119 
__u64
 
	mndts_èbÀ_fuŒs
;

123 
	mNDTPA_UNSPEC
,

124 
	mNDTPA_IFINDEX
,

125 
	mNDTPA_REFCNT
,

126 
	mNDTPA_REACHABLE_TIME
,

127 
	mNDTPA_BASE_REACHABLE_TIME
,

128 
	mNDTPA_RETRANS_TIME
,

129 
	mNDTPA_GC_STALETIME
,

130 
	mNDTPA_DELAY_PROBE_TIME
,

131 
	mNDTPA_QUEUE_LEN
,

132 
	mNDTPA_APP_PROBES
,

133 
	mNDTPA_UCAST_PROBES
,

134 
	mNDTPA_MCAST_PROBES
,

135 
	mNDTPA_ANYCAST_DELAY
,

136 
	mNDTPA_PROXY_DELAY
,

137 
	mNDTPA_PROXY_QLEN
,

138 
	mNDTPA_LOCKTIME
,

139 
	mNDTPA_QUEUE_LENBYTES
,

140 
	mNDTPA_MCAST_REPROBES
,

141 
	mNDTPA_PAD
,

142 
	m__NDTPA_MAX


144 
	#NDTPA_MAX
 (
__NDTPA_MAX
 - 1)

	)

146 
	sndtmsg
 {

147 
__u8
 
	mndtm_Ámûy
;

148 
__u8
 
	mndtm_∑d1
;

149 
__u16
 
	mndtm_∑d2
;

152 
	sndt_c⁄fig
 {

153 
__u16
 
	mndtc_key_Àn
;

154 
__u16
 
	mndtc_íåy_size
;

155 
__u32
 
	mndtc_íåõs
;

156 
__u32
 
	mndtc_œ°_Êush
;

157 
__u32
 
	mndtc_œ°_ønd
;

158 
__u32
 
	mndtc_hash_∫d
;

159 
__u32
 
	mndtc_hash_mask
;

160 
__u32
 
	mndtc_hash_chaö_gc
;

161 
__u32
 
	mndtc_¥oxy_qÀn
;

165 
	mNDTA_UNSPEC
,

166 
	mNDTA_NAME
,

167 
	mNDTA_THRESH1
,

168 
	mNDTA_THRESH2
,

169 
	mNDTA_THRESH3
,

170 
	mNDTA_CONFIG
,

171 
	mNDTA_PARMS
,

172 
	mNDTA_STATS
,

173 
	mNDTA_GC_INTERVAL
,

174 
	mNDTA_PAD
,

175 
	m__NDTA_MAX


177 
	#NDTA_MAX
 (
__NDTA_MAX
 - 1)

	)

184 
	mFDB_NOTIFY_BIT
 = (1 << 0),

185 
	mFDB_NOTIFY_INACTIVE_BIT
 = (1 << 1)

195 
	mNFEA_UNSPEC
,

196 
	mNFEA_ACTIVITY_NOTIFY
,

197 
	mNFEA_DONT_REFRESH
,

198 
	m__NFEA_MAX


200 
	#NFEA_MAX
 (
__NFEA_MAX
 - 1)

	)

	@/usr/include/linux/netlink.h

2 #i‚de‡
__LINUX_NETLINK_H


3 
	#__LINUX_NETLINK_H


	)

5 
	~<löux/c⁄°.h
>

6 
	~<löux/sockë.h
>

7 
	~<löux/ty≥s.h
>

9 
	#NETLINK_ROUTE
 0

	)

10 
	#NETLINK_UNUSED
 1

	)

11 
	#NETLINK_USERSOCK
 2

	)

12 
	#NETLINK_FIREWALL
 3

	)

13 
	#NETLINK_SOCK_DIAG
 4

	)

14 
	#NETLINK_NFLOG
 5

	)

15 
	#NETLINK_XFRM
 6

	)

16 
	#NETLINK_SELINUX
 7

	)

17 
	#NETLINK_ISCSI
 8

	)

18 
	#NETLINK_AUDIT
 9

	)

19 
	#NETLINK_FIB_LOOKUP
 10

	)

20 
	#NETLINK_CONNECTOR
 11

	)

21 
	#NETLINK_NETFILTER
 12

	)

22 
	#NETLINK_IP6_FW
 13

	)

23 
	#NETLINK_DNRTMSG
 14

	)

24 
	#NETLINK_KOBJECT_UEVENT
 15

	)

25 
	#NETLINK_GENERIC
 16

	)

27 
	#NETLINK_SCSITRANSPORT
 18

	)

28 
	#NETLINK_ECRYPTFS
 19

	)

29 
	#NETLINK_RDMA
 20

	)

30 
	#NETLINK_CRYPTO
 21

	)

31 
	#NETLINK_SMC
 22

	)

33 
	#NETLINK_INET_DIAG
 
NETLINK_SOCK_DIAG


	)

35 
	#MAX_LINKS
 32

	)

37 
	ssockaddr_∆
 {

38 
__kî√l_ß_Ámûy_t
 
	m∆_Ámûy
;

39 
	m∆_∑d
;

40 
__u32
 
	m∆_pid
;

41 
__u32
 
	m∆_groups
;

44 
	s∆msghdr
 {

45 
__u32
 
	m∆msg_Àn
;

46 
__u16
 
	m∆msg_ty≥
;

47 
__u16
 
	m∆msg_Êags
;

48 
__u32
 
	m∆msg_£q
;

49 
__u32
 
	m∆msg_pid
;

54 
	#NLM_F_REQUEST
 0x01

	)

55 
	#NLM_F_MULTI
 0x02

	)

56 
	#NLM_F_ACK
 0x04

	)

57 
	#NLM_F_ECHO
 0x08

	)

58 
	#NLM_F_DUMP_INTR
 0x10

	)

59 
	#NLM_F_DUMP_FILTERED
 0x20

	)

62 
	#NLM_F_ROOT
 0x100

	)

63 
	#NLM_F_MATCH
 0x200

	)

64 
	#NLM_F_ATOMIC
 0x400

	)

65 
	#NLM_F_DUMP
 (
NLM_F_ROOT
|
NLM_F_MATCH
)

	)

68 
	#NLM_F_REPLACE
 0x100

	)

69 
	#NLM_F_EXCL
 0x200

	)

70 
	#NLM_F_CREATE
 0x400

	)

71 
	#NLM_F_APPEND
 0x800

	)

74 
	#NLM_F_NONREC
 0x100

	)

77 
	#NLM_F_CAPPED
 0x100

	)

78 
	#NLM_F_ACK_TLVS
 0x200

	)

89 
	#NLMSG_ALIGNTO
 4U

	)

90 
	#NLMSG_ALIGN
(
Àn
Ë–(÷í)+
NLMSG_ALIGNTO
-1Ë& ~(NLMSG_ALIGNTO-1Ë)

	)

91 
	#NLMSG_HDRLEN
 ((Ë
	`NLMSG_ALIGN
((
∆msghdr
)))

	)

92 
	#NLMSG_LENGTH
(
Àn
Ë(÷íË+ 
NLMSG_HDRLEN
)

	)

93 
	#NLMSG_SPACE
(
Àn
Ë
	`NLMSG_ALIGN
(
	`NLMSG_LENGTH
÷í))

	)

94 
	#NLMSG_DATA
(
∆h
Ë((*)(((*ÍlhË+ 
NLMSG_HDRLEN
))

	)

95 
	#NLMSG_NEXT
(
∆h
,
Àn
Ë(÷íË-
	`NLMSG_ALIGN
(“lh)->
∆msg_Àn
), \

96 (
∆msghdr
 *)(((*)(
∆h
)) + \

97 
	`NLMSG_ALIGN
((
∆h
)->
∆msg_Àn
)))

	)

98 
	#NLMSG_OK
(
∆h
,
Àn
Ë(÷íË>()(
∆msghdr
) && \

99 (
∆h
)->
∆msg_Àn
 >(
∆msghdr
) && \

100 (
∆h
)->
∆msg_Àn
 <(
Àn
))

	)

101 
	#NLMSG_PAYLOAD
(
∆h
,
Àn
Ë(“lh)->
∆msg_Àn
 - 
	`NLMSG_SPACE
(÷í)))

	)

103 
	#NLMSG_NOOP
 0x1

	)

104 
	#NLMSG_ERROR
 0x2

	)

105 
	#NLMSG_DONE
 0x3

	)

106 
	#NLMSG_OVERRUN
 0x4

	)

108 
	#NLMSG_MIN_TYPE
 0x10

	)

110 
	s∆msgîr
 {

111 
	mîr‹
;

112 
∆msghdr
 
	mmsg
;

137 
	e∆msgîr_©ås
 {

138 
	mNLMSGERR_ATTR_UNUSED
,

139 
	mNLMSGERR_ATTR_MSG
,

140 
	mNLMSGERR_ATTR_OFFS
,

141 
	mNLMSGERR_ATTR_COOKIE
,

142 
	mNLMSGERR_ATTR_POLICY
,

144 
	m__NLMSGERR_ATTR_MAX
,

145 
	mNLMSGERR_ATTR_MAX
 = 
__NLMSGERR_ATTR_MAX
 - 1

148 
	#NETLINK_ADD_MEMBERSHIP
 1

	)

149 
	#NETLINK_DROP_MEMBERSHIP
 2

	)

150 
	#NETLINK_PKTINFO
 3

	)

151 
	#NETLINK_BROADCAST_ERROR
 4

	)

152 
	#NETLINK_NO_ENOBUFS
 5

	)

153 
	#NETLINK_RX_RING
 6

	)

154 
	#NETLINK_TX_RING
 7

	)

155 
	#NETLINK_LISTEN_ALL_NSID
 8

	)

156 
	#NETLINK_LIST_MEMBERSHIPS
 9

	)

157 
	#NETLINK_CAP_ACK
 10

	)

158 
	#NETLINK_EXT_ACK
 11

	)

159 
	#NETLINK_GET_STRICT_CHK
 12

	)

161 
	s∆_pktöfo
 {

162 
__u32
 
	mgroup
;

165 
	s∆_mm≠_ªq
 {

166 
	mnm_block_size
;

167 
	mnm_block_ƒ
;

168 
	mnm_‰ame_size
;

169 
	mnm_‰ame_ƒ
;

172 
	s∆_mm≠_hdr
 {

173 
	mnm_°©us
;

174 
	mnm_Àn
;

175 
__u32
 
	mnm_group
;

177 
__u32
 
	mnm_pid
;

178 
__u32
 
	mnm_uid
;

179 
__u32
 
	mnm_gid
;

182 
	e∆_mm≠_°©us
 {

183 
	mNL_MMAP_STATUS_UNUSED
,

184 
	mNL_MMAP_STATUS_RESERVED
,

185 
	mNL_MMAP_STATUS_VALID
,

186 
	mNL_MMAP_STATUS_COPY
,

187 
	mNL_MMAP_STATUS_SKIP
,

190 
	#NL_MMAP_MSG_ALIGNMENT
 
NLMSG_ALIGNTO


	)

191 
	#NL_MMAP_MSG_ALIGN
(
sz
Ë
	`__ALIGN_KERNEL
(sz, 
NL_MMAP_MSG_ALIGNMENT
)

	)

192 
	#NL_MMAP_HDRLEN
 
	`NL_MMAP_MSG_ALIGN
((
∆_mm≠_hdr
))

	)

194 
	#NET_MAJOR
 36

	)

197 
	mNETLINK_UNCONNECTED
 = 0,

198 
	mNETLINK_CONNECTED
,

210 
	s∆©å
 {

211 
__u16
 
	m∆a_Àn
;

212 
__u16
 
	m∆a_ty≥
;

225 
	#NLA_F_NESTED
 (1 << 15)

	)

226 
	#NLA_F_NET_BYTEORDER
 (1 << 14)

	)

227 
	#NLA_TYPE_MASK
 ~(
NLA_F_NESTED
 | 
NLA_F_NET_BYTEORDER
)

	)

229 
	#NLA_ALIGNTO
 4

	)

230 
	#NLA_ALIGN
(
Àn
Ë((÷íË+ 
NLA_ALIGNTO
 - 1Ë& ~(NLA_ALIGNTO - 1))

	)

231 
	#NLA_HDRLEN
 ((Ë
	`NLA_ALIGN
((
∆©å
)))

	)

246 
	s∆a_bôfõld32
 {

247 
__u32
 
	mvÆue
;

248 
__u32
 
	m£À˘‹
;

283 
	e√éök_©åibuã_ty≥
 {

284 
	mNL_ATTR_TYPE_INVALID
,

286 
	mNL_ATTR_TYPE_FLAG
,

288 
	mNL_ATTR_TYPE_U8
,

289 
	mNL_ATTR_TYPE_U16
,

290 
	mNL_ATTR_TYPE_U32
,

291 
	mNL_ATTR_TYPE_U64
,

293 
	mNL_ATTR_TYPE_S8
,

294 
	mNL_ATTR_TYPE_S16
,

295 
	mNL_ATTR_TYPE_S32
,

296 
	mNL_ATTR_TYPE_S64
,

298 
	mNL_ATTR_TYPE_BINARY
,

299 
	mNL_ATTR_TYPE_STRING
,

300 
	mNL_ATTR_TYPE_NUL_STRING
,

302 
	mNL_ATTR_TYPE_NESTED
,

303 
	mNL_ATTR_TYPE_NESTED_ARRAY
,

305 
	mNL_ATTR_TYPE_BITFIELD32
,

336 
	e√éök_pﬁicy_ty≥_©å
 {

337 
	mNL_POLICY_TYPE_ATTR_UNSPEC
,

338 
	mNL_POLICY_TYPE_ATTR_TYPE
,

339 
	mNL_POLICY_TYPE_ATTR_MIN_VALUE_S
,

340 
	mNL_POLICY_TYPE_ATTR_MAX_VALUE_S
,

341 
	mNL_POLICY_TYPE_ATTR_MIN_VALUE_U
,

342 
	mNL_POLICY_TYPE_ATTR_MAX_VALUE_U
,

343 
	mNL_POLICY_TYPE_ATTR_MIN_LENGTH
,

344 
	mNL_POLICY_TYPE_ATTR_MAX_LENGTH
,

345 
	mNL_POLICY_TYPE_ATTR_POLICY_IDX
,

346 
	mNL_POLICY_TYPE_ATTR_POLICY_MAXTYPE
,

347 
	mNL_POLICY_TYPE_ATTR_BITFIELD32_MASK
,

348 
	mNL_POLICY_TYPE_ATTR_PAD
,

349 
	mNL_POLICY_TYPE_ATTR_MASK
,

352 
	m__NL_POLICY_TYPE_ATTR_MAX
,

353 
	mNL_POLICY_TYPE_ATTR_MAX
 = 
__NL_POLICY_TYPE_ATTR_MAX
 - 1

	@/usr/include/linux/socket.h

2 #i‚de‡
_LINUX_SOCKET_H


3 
	#_LINUX_SOCKET_H


	)

8 
	#_K_SS_MAXSIZE
 128

	)

10 
	t__kî√l_ß_Ámûy_t
;

16 
	s__kî√l_sockaddr_°‹age
 {

19 
__kî√l_ß_Ámûy_t
 
	mss_Ámûy
;

21 
	m__d©a
[
_K_SS_MAXSIZE
 - ()];

25 *
	m__Æign
;

29 
	#SOCK_SNDBUF_LOCK
 1

	)

30 
	#SOCK_RCVBUF_LOCK
 2

	)

32 
	#SOCK_BUF_LOCK_MASK
 (
SOCK_SNDBUF_LOCK
 | 
SOCK_RCVBUF_LOCK
)

	)

	@/usr/include/linux/stddef.h

2 #i‚de‡
_LINUX_STDDEF_H


3 
	#_LINUX_STDDEF_H


	)

7 #i‚de‡
__Æways_ölöe


8 
	#__Æways_ölöe
 
__ölöe__


	)

26 
	#__°ru˘_group
(
TAG
, 
NAME
, 
ATTRS
, 
MEMBERS
...) \

28 °ru˘ { 
MEMBERS
 } 
ATTRS
; \

29 
	sTAG
 { 
MEMBERS
 } 
ATTRS
 
NAME
; \

30 } 
ATTRS


	)

42 
	#__DECLARE_FLEX_ARRAY
(
TYPE
, 
NAME
) \

44 °ru˘ { } 
__em±y_
 ## 
NAME
; \

45 
TYPE
 
NAME
[]; \

46 }

	)

	@/usr/include/linux/sysinfo.h

2 #i‚de‡
_LINUX_SYSINFO_H


3 
	#_LINUX_SYSINFO_H


	)

5 
	~<löux/ty≥s.h
>

7 
	#SI_LOAD_SHIFT
 16

	)

8 
	ssysöfo
 {

9 
__kî√l_l⁄g_t
 
	mu±ime
;

10 
__kî√l_ul⁄g_t
 
	mlﬂds
[3];

11 
__kî√l_ul⁄g_t
 
	mtŸÆøm
;

12 
__kî√l_ul⁄g_t
 
	m‰ìøm
;

13 
__kî√l_ul⁄g_t
 
	msh¨edøm
;

14 
__kî√l_ul⁄g_t
 
	mbuf„ºam
;

15 
__kî√l_ul⁄g_t
 
	mtŸÆsw≠
;

16 
__kî√l_ul⁄g_t
 
	m‰ìsw≠
;

17 
__u16
 
	m¥ocs
;

18 
__u16
 
	m∑d
;

19 
__kî√l_ul⁄g_t
 
	mtŸÆhigh
;

20 
__kî√l_ul⁄g_t
 
	m‰ìhigh
;

21 
__u32
 
	mmem_unô
;

22 
	m_f
[20-2*(
__kî√l_ul⁄g_t
)-(
__u32
)];

	@/usr/include/linux/time_types.h

2 #i‚de‡
_LINUX_TIME_TYPES_H


3 
	#_LINUX_TIME_TYPES_H


	)

5 
	~<löux/ty≥s.h
>

7 
	s__kî√l_time•ec
 {

8 
__kî√l_time64_t
 
	mtv_£c
;

9 
	mtv_n£c
;

12 
	s__kî√l_ôimî•ec
 {

13 
__kî√l_time•ec
 
	mô_öãrvÆ
;

14 
__kî√l_time•ec
 
	mô_vÆue
;

24 #i‚de‡
__kî√l_ﬁd_timevÆ


25 
	s__kî√l_ﬁd_timevÆ
 {

26 
__kî√l_l⁄g_t
 
	mtv_£c
;

27 
__kî√l_l⁄g_t
 
	mtv_u£c
;

31 
	s__kî√l_ﬁd_time•ec
 {

32 
__kî√l_ﬁd_time_t
 
	mtv_£c
;

33 
	mtv_n£c
;

36 
	s__kî√l_ﬁd_ôimîvÆ
 {

37 
__kî√l_ﬁd_timevÆ
 
	mô_öãrvÆ
;

38 
__kî√l_ﬁd_timevÆ
 
	mô_vÆue
;

41 
	s__kî√l_sock_timevÆ
 {

42 
__s64
 
	mtv_£c
;

43 
__s64
 
	mtv_u£c
;

	@/usr/include/linux/types.h

2 #i‚de‡
_LINUX_TYPES_H


3 
	#_LINUX_TYPES_H


	)

5 
	~<asm/ty≥s.h
>

7 #i‚de‡
__ASSEMBLY__


9 
	~<löux/posix_ty≥s.h
>

17 #ifde‡
__CHECKER__


18 
	#__bôwi£__
 
	`__©åibuã__
((
bôwi£
))

	)

20 
	#__bôwi£__


	)

22 
	#__bôwi£
 
__bôwi£__


	)

24 
__u16
 
	t__bôwi£
 
	t__À16
;

25 
__u16
 
	t__bôwi£
 
	t__be16
;

26 
__u32
 
	t__bôwi£
 
	t__À32
;

27 
__u32
 
	t__bôwi£
 
	t__be32
;

28 
__u64
 
	t__bôwi£
 
	t__À64
;

29 
__u64
 
	t__bôwi£
 
	t__be64
;

31 
__u16
 
	t__bôwi£
 
	t__sum16
;

32 
__u32
 
	t__bôwi£
 
	t__wsum
;

43 
	#__Æig√d_u64
 
__u64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

44 
	#__Æig√d_be64
 
__be64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

45 
	#__Æig√d_À64
 
__À64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

47 
	t__bôwi£
 
	t__pﬁl_t
;

	@/usr/include/linux/hdlc/ioctl.h

2 #i‚de‡
__HDLC_IOCTL_H__


3 
	#__HDLC_IOCTL_H__


	)

6 
	#GENERIC_HDLC_VERSION
 4

	)

8 
	#CLOCK_DEFAULT
 0

	)

9 
	#CLOCK_EXT
 1

	)

10 
	#CLOCK_INT
 2

	)

11 
	#CLOCK_TXINT
 3

	)

12 
	#CLOCK_TXFROMRX
 4

	)

15 
	#ENCODING_DEFAULT
 0

	)

16 
	#ENCODING_NRZ
 1

	)

17 
	#ENCODING_NRZI
 2

	)

18 
	#ENCODING_FM_MARK
 3

	)

19 
	#ENCODING_FM_SPACE
 4

	)

20 
	#ENCODING_MANCHESTER
 5

	)

23 
	#PARITY_DEFAULT
 0

	)

24 
	#PARITY_NONE
 1

	)

25 
	#PARITY_CRC16_PR0
 2

	)

26 
	#PARITY_CRC16_PR1
 3

	)

27 
	#PARITY_CRC16_PR0_CCITT
 4

	)

28 
	#PARITY_CRC16_PR1_CCITT
 5

	)

29 
	#PARITY_CRC32_PR0_CCITT
 6

	)

30 
	#PARITY_CRC32_PR1_CCITT
 7

	)

32 
	#LMI_DEFAULT
 0

	)

33 
	#LMI_NONE
 1

	)

34 
	#LMI_ANSI
 2

	)

35 
	#LMI_CCITT
 3

	)

36 
	#LMI_CISCO
 4

	)

38 #i‚de‡
__ASSEMBLY__


41 
	m˛ock_øã
;

42 
	m˛ock_ty≥
;

43 
	mlo›back
;

44 } 
	tsync_£rül_£âögs
;

47 
	m˛ock_øã
;

48 
	m˛ock_ty≥
;

49 
	mlo›back
;

50 
	m¶Ÿ_m≠
;

51 } 
	tã1_£âögs
;

54 
	mícodög
;

55 
	m∑rôy
;

56 } 
	tøw_hdlc_¥Ÿo
;

59 
	mt391
;

60 
	mt392
;

61 
	mn391
;

62 
	mn392
;

63 
	mn393
;

64 
	mlmi
;

65 
	md˚
;

66 } 
	t‰_¥Ÿo
;

69 
	mdlci
;

70 } 
	t‰_¥Ÿo_pvc
;

73 
	mdlci
;

74 
	mma°î
[
IFNAMSIZ
];

75 }
	t‰_¥Ÿo_pvc_öfo
;

78 
	möãrvÆ
;

79 
	mtimeout
;

80 } 
	tcisco_¥Ÿo
;

83 
	md˚
;

84 
	mmodulo
;

85 
	mwödow
;

86 
	mt1
;

87 
	mt2
;

88 
	mn2
;

89 } 
	tx25_hdlc_¥Ÿo
;

	@/usr/include/linux/posix_types.h

2 #i‚de‡
_LINUX_POSIX_TYPES_H


3 
	#_LINUX_POSIX_TYPES_H


	)

5 
	~<löux/°ddef.h
>

22 #unde‡
__FD_SETSIZE


23 
	#__FD_SETSIZE
 1024

	)

26 
	mfds_bôs
[
__FD_SETSIZE
 / (8 * ())];

27 } 
	t__kî√l_fd_£t
;

30 (*
	t__kî√l_sigh™dÀr_t
)();

33 
	t__kî√l_key_t
;

34 
	t__kî√l_mqd_t
;

36 
	~<asm/posix_ty≥s.h
>

	@
1
.
1
/usr/include
81
1377
binding.c
coex.c
constants.h
d3.c
debugfs-vif.c
debugfs.c
debugfs.h
ftm-initiator.c
ftm-responder.c
fw-api.h
fw.c
iwlmvm.mod.c
led.c
link.c
mac-ctxt.c
mac80211.c
mld-key.c
mld-mac.c
mld-mac80211.c
mld-sta.c
mvm.h
nvm.c
offloading.c
ops.c
phy-ctxt.c
power.c
ptp.c
quota.c
rfi.c
rs-fw.c
rs.c
rs.h
rx.c
rxmq.c
scan.c
sf.c
sta.c
sta.h
tdls.c
testmode.h
time-event.c
time-event.h
time-sync.c
time-sync.h
tt.c
tx.c
utils.c
vendor-cmd.c
/usr/include/linux/fs.h
/usr/include/linux/if_arp.h
/usr/include/linux/in6.h
/usr/include/linux/ip.h
/usr/include/linux/kernel.h
/usr/include/linux/module.h
/usr/include/linux/netdevice.h
/usr/include/linux/nl80211-vnd-intel.h
/usr/include/linux/rtnetlink.h
/usr/include/linux/tcp.h
/usr/include/linux/thermal.h
/usr/include/linux/time.h
/usr/include/linux/wait.h
/usr/include/linux/const.h
/usr/include/linux/fscrypt.h
/usr/include/linux/if.h
/usr/include/linux/if_addr.h
/usr/include/linux/if_ether.h
/usr/include/linux/if_link.h
/usr/include/linux/if_packet.h
/usr/include/linux/ioctl.h
/usr/include/linux/libc-compat.h
/usr/include/linux/limits.h
/usr/include/linux/mount.h
/usr/include/linux/neighbour.h
/usr/include/linux/netlink.h
/usr/include/linux/socket.h
/usr/include/linux/stddef.h
/usr/include/linux/sysinfo.h
/usr/include/linux/time_types.h
/usr/include/linux/types.h
/usr/include/linux/hdlc/ioctl.h
/usr/include/linux/posix_types.h
